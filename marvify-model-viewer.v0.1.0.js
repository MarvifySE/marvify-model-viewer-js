var Sie=Object.defineProperty;var Tie=(o=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(o,{get:(e,t)=>(typeof require<"u"?require:e)[t]}):o)(function(o){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+o+'" is not supported')});var m=(o,e)=>()=>(o&&(e=o(o=0)),e);var Eie=(o,e)=>{for(var t in e)Sie(o,t,{get:e[t],enumerable:!0})};var UO,BO,VO,kO,GO,zO,HO,XO,WO,YO,KO,qO,jO,$O,ZO,QO,JO,e1,t1,s1,i1,yE,XC=m(()=>{UO="RenderFrame",BO="RenderFrameTime",VO="RenderPass",kO="RenderPassDetail",GO="RenderAction",zO="RenderTargetAlloc",HO="TextureAlloc",XO="ShaderAlloc",WO="ShaderCompile",YO="VRAM.Texture",KO="VRAM.Vb",qO="VRAM.Ib",jO="VRAM.Sb",$O="BindGroupAlloc",ZO="BindGroupFormatAlloc",QO="RenderPipelineAlloc",JO="ComputePipelineAlloc",e1="PipelineLayoutAlloc",t1="Element",s1="Textures",i1="RenderQueue",yE="GpuTimings"});function Hl(o,e){for(let t in e){let s=e[t];Array.isArray(s)?o[t]=Hl([],s):s&&typeof s=="object"?o[t]=Hl({},s):o[t]=s}return o}var tu,AE,su=m(()=>{tu="2.10.3",AE="2dc84cf"});var PE,WC=m(()=>{PE={create(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,o=>{let e=Math.random()*16|0;return(o==="x"?e:e&3|8).toString(16)})}}});var ve,Fs=m(()=>{ve={delimiter:"/",join(...o){let e=o[0];for(let t=0;t<o.length-1;t++){let s=o[t],i=o[t+1];if(i[0]===ve.delimiter){e=i;continue}s&&i&&s[s.length-1]!==ve.delimiter&&i[0]!==ve.delimiter?e+=ve.delimiter+i:e+=i}return e},normalize(o){let e=o.startsWith(ve.delimiter),t=o.endsWith(ve.delimiter),s=o.split("/"),i="",r=[];for(let a=0;a<s.length;a++)if(s[a]!==""&&s[a]!=="."){if(s[a]===".."&&r.length>0){r=r.slice(0,r.length-2);continue}a>0&&r.push(ve.delimiter),r.push(s[a])}return i=r.join(""),!e&&i[0]===ve.delimiter&&(i=i.slice(1)),t&&i[i.length-1]!==ve.delimiter&&(i+=ve.delimiter),i},split(o){let e=o.lastIndexOf(ve.delimiter);return e!==-1?[o.substring(0,e),o.substring(e+1)]:["",o]},getBasename(o){return ve.split(o)[1]},getDirectory(o){return ve.split(o)[0]},getExtension(o){let e=o.split("?")[0].split(".").pop();return e!==o?`.${e}`:""},isRelativePath(o){return o.charAt(0)!=="/"&&o.match(/:\/\//)===null},extractPath(o){let e="",t=o.split("/"),s=0;if(t.length>1)if(ve.isRelativePath(o))if(t[0]===".")for(s=0;s<t.length-1;++s)e+=s===0?t[s]:`/${t[s]}`;else if(t[0]==="..")for(s=0;s<t.length-1;++s)e+=s===0?t[s]:`/${t[s]}`;else for(e=".",s=0;s<t.length-1;++s)e+=`/${t[s]}`;else for(s=0;s<t.length-1;++s)e+=s===0?t[s]:`/${t[s]}`;return e}}});var vie,xn,Do,Yg,xie,yie,Aie,Pie,Rie,Cie,ue,bt=m(()=>{vie=()=>{let o=!1;try{let e=Object.defineProperty({},"passive",{get:function(){return o=!0,!1}});window.addEventListener("testpassive",null,e),window.removeEventListener("testpassive",null,e)}catch{}return o},xn=typeof navigator<"u"?navigator.userAgent:"",Do=typeof window<"u"?"browser":typeof global<"u"?"node":"worker",Yg=/android/i.test(xn)?"android":/ip(?:[ao]d|hone)/i.test(xn)?"ios":/windows/i.test(xn)?"windows":/mac os/i.test(xn)?"osx":/linux/i.test(xn)?"linux":/cros/i.test(xn)?"cros":null,xie=Do!=="browser"?null:/Chrome\/|Chromium\/|Edg.*\//.test(xn)?"chrome":/Safari\//.test(xn)?"safari":/Firefox\//.test(xn)?"firefox":"other",yie=/xbox/i.test(xn),Aie=Do==="browser"&&("ontouchstart"in window||"maxTouchPoints"in navigator&&navigator.maxTouchPoints>0),Pie=Do==="browser"&&(!!navigator.getGamepads||!!navigator.webkitGetGamepads),Rie=typeof Worker<"u",Cie=vie(),ue={name:Yg,environment:Do,global:(typeof globalThis<"u"&&globalThis)??(Do==="browser"&&window)??(Do==="node"&&global)??(Do==="worker"&&self),browser:Do==="browser",worker:Do==="worker",desktop:["windows","osx","linux","cros"].includes(Yg),mobile:["android","ios"].includes(Yg),ios:Yg==="ios",android:Yg==="android",xbox:yie,gamepads:Pie,touch:Aie,workers:Rie,passiveEvents:Cie,browserName:xie}});function jC(o,e=0){let t=o.length;if(e<0||e>=t)return null;let s=o.charCodeAt(e);if(t>1&&s>=YC&&s<=h1){let i=o.charCodeAt(e+1);if(i>=r1&&i<=wie)return{code:(s-YC)*1024+i-r1+65536,long:!0}}return{code:s,long:!1}}function Xl(o,e,t){if(!o)return!1;let s=jC(o);if(s){let i=s.code;return i>=e&&i<=t}return!1}function Nie(o,e){if(e===o.length-1)return 1;if(Xl(o[e],YC,h1)){let t=o.substring(e,e+2),s=o.substring(e+2,e+4);return Xl(s,bie,Mie)||Xl(t,a1,n1)&&Xl(s,a1,n1)?4:Xl(s,KC,qC)?3:2}return Xl(o[e+1],KC,qC)?2:1}var o1,l1,Iie,YC,h1,r1,wie,Lie,a1,n1,bie,Mie,Die,Oie,KC,qC,zr,Kg=m(()=>{o1="abcdefghijklmnopqrstuvwxyz",l1="ABCDEFGHIJKLMNOPQRSTUVWXYZ",Iie=o1+l1,YC=55296,h1=56319,r1=56320,wie=57343,Lie=8205,a1=127462,n1=127487,bie=127995,Mie=127999,Die=8400,Oie=8447,KC=65024,qC=65039;zr={ASCII_LOWERCASE:o1,ASCII_UPPERCASE:l1,ASCII_LETTERS:Iie,format(o,...e){for(let t=0;t<e.length;t++)o=o.replace(`{${t}}`,e[t]);return o},getCodePoint(o,e){let t=jC(o,e);return t&&t.code},getCodePoints(o){if(typeof o!="string")throw new TypeError("Not a string");let e=0,t=[],s;for(;s=jC(o,e);)t.push(s.code),e+=s.long?2:1;return t},getSymbols(o){if(typeof o!="string")throw new TypeError("Not a string");let e=0,t=o.length,s=[],i=0,r;for(;e<t;){if(i+=Nie(o,e+i),r=o[e+i],Xl(r,Die,Oie)&&(r=o[e+i++]),Xl(r,KC,qC)&&(r=o[e+i++]),r&&r.charCodeAt(0)===Lie){r=o[e+i++];continue}let a=o.substring(e,e+i);s.push(a),e+=i,i=0}return s},fromCodePoint(...o){return o.map(e=>e>65535?(e-=65536,String.fromCharCode((e>>10)+55296,e%1024+56320)):String.fromCharCode(e)).join("")}}});var iu,$C=m(()=>{iu=class{constructor(e,t,s,i,r=!1){this._removed=!1,this.handler=e,this.name=t,this.callback=s,this.scope=i,this._once=r}off(){this._removed||this.handler.offByHandle(this)}on(e,t,s=this){return this.handler._addCallback(e,t,s,!1)}once(e,t,s=this){return this.handler._addCallback(e,t,s,!0)}set removed(e){e&&(this._removed=!0)}get removed(){return this._removed}toJSON(e){}}});var K,Pe=m(()=>{$C();K=class{initEventHandler(){this._callbacks=new Map,this._callbackActive=new Map}_addCallback(e,t,s,i){if(this._callbacks.has(e)||this._callbacks.set(e,[]),this._callbackActive.has(e)){let a=this._callbackActive.get(e);a&&a===this._callbacks.get(e)&&this._callbackActive.set(e,a.slice())}let r=new iu(this,e,t,s,i);return this._callbacks.get(e).push(r),r}on(e,t,s=this){return this._addCallback(e,t,s,!1)}once(e,t,s=this){return this._addCallback(e,t,s,!0)}off(e,t,s){if(e)this._callbackActive.has(e)&&this._callbackActive.get(e)===this._callbacks.get(e)&&this._callbackActive.set(e,this._callbackActive.get(e).slice());else for(let[i,r]of this._callbackActive)this._callbacks.has(i)&&this._callbacks.get(i)===r&&this._callbackActive.set(i,r.slice());if(e)if(t){let i=this._callbacks.get(e);if(!i)return this;for(let r=0;r<i.length;r++)i[r].callback===t&&(s&&i[r].scope!==s||(i[r].removed=!0,i.splice(r,1),r--));i.length===0&&this._callbacks.delete(e)}else{let i=this._callbacks.get(e);if(i){for(let r=0;r<i.length;r++)i[r].removed=!0;this._callbacks.delete(e)}}else{for(let i of this._callbacks.values())for(let r=0;r<i.length;r++)i[r].removed=!0;this._callbacks.clear()}return this}offByHandle(e){let t=e.name;e.removed=!0,this._callbackActive.has(t)&&this._callbackActive.get(t)===this._callbacks.get(t)&&this._callbackActive.set(t,this._callbackActive.get(t).slice());let s=this._callbacks.get(t);if(!s)return this;let i=s.indexOf(e);return i!==-1&&(s.splice(i,1),s.length===0&&this._callbacks.delete(t)),this}fire(e,t,s,i,r,a,n,l,h){if(!e)return this;let c=this._callbacks.get(e);if(!c)return this;let f;this._callbackActive.has(e)?this._callbackActive.get(e)!==c&&(f=c.slice()):this._callbackActive.set(e,c);for(let d=0;(f||this._callbackActive.get(e))&&d<(f||this._callbackActive.get(e)).length;d++){let u=(f||this._callbackActive.get(e))[d];if(u.callback&&(u.callback.call(u.scope,t,s,i,r,a,n,l,h),u._once)){let p=this._callbacks.get(e),_=p?p.indexOf(u):-1;if(_!==-1){this._callbackActive.get(e)===p&&this._callbackActive.set(e,this._callbackActive.get(e).slice());let S=this._callbacks.get(e);if(!S)continue;S[_].removed=!0,S.splice(_,1),S.length===0&&this._callbacks.delete(e)}}}return f||this._callbackActive.delete(e),this}hasEvent(e){return!!this._callbacks.get(e)?.length}constructor(){this._callbacks=new Map,this._callbackActive=new Map}}});var ru,ZC=m(()=>{ru=class{push(e,t){if(this._index[e])throw Error(`Key already in index ${e}`);let s=this._list.push(t)-1;this._index[e]=s}has(e){return this._index[e]!==void 0}get(e){let t=this._index[e];return t!==void 0?this._list[t]:null}remove(e){let t=this._index[e];if(t!==void 0){this._list.splice(t,1),delete this._index[e];for(e in this._index){let s=this._index[e];s>t&&(this._index[e]=s-1)}return!0}return!1}list(){return this._list}clear(){this._list.length=0;for(let e in this._index)delete this._index[e]}constructor(){this._list=[],this._index={}}}});var Fie,qc,Wl,RE=m(()=>{Fie=o=>{let e={},t=e;return()=>(t===e&&(t=o()),t)},qc=class o{static{this.modules={}}static{this.wasmSupported=Fie(()=>{try{if(typeof WebAssembly=="object"&&typeof WebAssembly.instantiate=="function"){let e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch{}return!1})}static loadScript(e,t){let s=document.createElement("script");s.setAttribute("src",e),s.onload=()=>{t(null)},s.onerror=()=>{t(`Failed to load script='${e}'`)},document.body.appendChild(s)}static loadWasm(e,t,s){let i=o.wasmSupported()&&t.glueUrl&&t.wasmUrl?t.glueUrl:t.fallbackUrl;i?o.loadScript(i,r=>{if(r)s(r,null);else{let a=window[e];window[e]=void 0,a({locateFile:()=>t.wasmUrl,onAbort:()=>{s("wasm module aborted.")}}).then(n=>{s(null,n)})}}):s("No supported wasm modules found.",null)}static getModule(e){return o.modules.hasOwnProperty(e)||(o.modules[e]={config:null,initializing:!1,instance:null,callbacks:[]}),o.modules[e]}static initialize(e,t){if(t.initializing)return;let s=t.config;(s.glueUrl||s.wasmUrl||s.fallbackUrl)&&(t.initializing=!0,o.loadWasm(e,s,(i,r)=>{i?s.errorHandler?s.errorHandler(i):console.error(`failed to initialize module=${e} error=${i}`):(t.instance=r,t.callbacks.forEach(a=>{a(r)}))}))}},Wl=class{static setConfig(e,t){let s=qc.getModule(e);s.config=t,s.callbacks.length>0&&qc.initialize(e,s)}static getConfig(e){return qc.modules?.[e]?.config}static getInstance(e,t){let s=qc.getModule(e);s.instance?t(s.instance):(s.callbacks.push(t),s.config&&qc.initialize(e,s))}}});var Yl,CE=m(()=>{Yl=class{constructor(e){this.offset=0,this.arraybuffer=e,this.dataView=new DataView(e)}get remainingBytes(){return this.dataView.byteLength-this.offset}reset(e=0){this.offset=e}skip(e){this.offset+=e}align(e){this.offset=this.offset+e-1&~(e-1)}_inc(e){return this.offset+=e,this.offset-e}readChar(){return String.fromCharCode(this.dataView.getUint8(this.offset++))}readChars(e){let t="";for(let s=0;s<e;++s)t+=this.readChar();return t}readU8(){return this.dataView.getUint8(this.offset++)}readU16(){return this.dataView.getUint16(this._inc(2),!0)}readU32(){return this.dataView.getUint32(this._inc(4),!0)}readU64(){return this.readU32()+2**32*this.readU32()}readU32be(){return this.dataView.getUint32(this._inc(4),!1)}readArray(e){for(let t=0;t<e.length;++t)e[t]=this.readU8()}readLine(){let e=this.dataView,t="";for(;!(this.offset>=e.byteLength);){let s=String.fromCharCode(this.readU8());if(s===`
`)break;t+=s}return t}}});var yn,IE=m(()=>{yn=class{constructor(e){this.items=[],this.length=0,this.loopIndex=-1,this._sortBy=e.sortBy,this._sortHandler=this._doSort.bind(this)}_binarySearch(e){let t=0,s=this.items.length-1,i=e[this._sortBy],r,a;for(;t<=s;)r=Math.floor((t+s)/2),a=this.items[r][this._sortBy],a<=i?t=r+1:a>i&&(s=r-1);return t}_doSort(e,t){let s=this._sortBy;return e[s]-t[s]}insert(e){let t=this._binarySearch(e);this.items.splice(t,0,e),this.length++,this.loopIndex>=t&&this.loopIndex++}append(e){this.items.push(e),this.length++}remove(e){let t=this.items.indexOf(e);t<0||(this.items.splice(t,1),this.length--,this.loopIndex>=t&&this.loopIndex--)}sort(){let e=this.loopIndex>=0?this.items[this.loopIndex]:null;this.items.sort(this._sortHandler),e!==null&&(this.loopIndex=this.items.indexOf(e))}}});var Kl,wE=m(()=>{Pe();Kl=class extends K{static{this.EVENT_ADD="add"}static{this.EVENT_REMOVE="remove"}static{this.EVENT_CHANGE="change"}constructor(e){super(),this._index={},this._list=[],this._parent=e}add(...e){let t=!1,s=this._processArguments(e,!0);if(!s.length)return t;for(let i=0;i<s.length;i++)this._index[s[i]]||(t=!0,this._index[s[i]]=!0,this._list.push(s[i]),this.fire("add",s[i],this._parent));return t&&this.fire("change",this._parent),t}remove(...e){let t=!1;if(!this._list.length)return t;let s=this._processArguments(e,!0);if(!s.length)return t;for(let i=0;i<s.length;i++)this._index[s[i]]&&(t=!0,delete this._index[s[i]],this._list.splice(this._list.indexOf(s[i]),1),this.fire("remove",s[i],this._parent));return t&&this.fire("change",this._parent),t}clear(){if(!this._list.length)return;let e=this._list.slice(0);this._list=[],this._index={};for(let t=0;t<e.length;t++)this.fire("remove",e[t],this._parent);this.fire("change",this._parent)}has(...e){return this._list.length?this._has(this._processArguments(e)):!1}_has(e){if(!this._list.length||!e.length)return!1;for(let t=0;t<e.length;t++)if(e[t].length===1){if(this._index[e[t][0]])return!0}else{let s=!0;for(let i=0;i<e[t].length;i++)if(!this._index[e[t][i]]){s=!1;break}if(s)return!0}return!1}list(){return this._list.slice(0)}_processArguments(e,t){let s=[],i=[];if(!e||!e.length)return s;for(let r=0;r<e.length;r++)if(e[r]instanceof Array){t||(i=[]);for(let a=0;a<e[r].length;a++)typeof e[r][a]=="string"&&(t?s.push(e[r][a]):i.push(e[r][a]));!t&&i.length&&s.push(i)}else typeof e[r]=="string"&&(t?s.push(e[r]):s.push([e[r]]));return s}get size(){return this._list.length}}});var Us,ql=m(()=>{Us=typeof window<"u"&&window.performance&&window.performance.now?performance.now.bind(performance):Date.now});function c1(o){let e="";if((o.authority||o.scheme)&&(o.host||o.hostpath))throw new Error("Can't have 'scheme' or 'authority' and 'host' or 'hostpath' option");if(o.host&&o.hostpath)throw new Error("Can't have 'host' and 'hostpath' option");if(o.path&&o.hostpath)throw new Error("Can't have 'path' and 'hostpath' option");return o.scheme&&(e+=`${o.scheme}:`),o.authority&&(e+=`//${o.authority}`),o.host&&(e+=o.host),o.path&&(e+=o.path),o.hostpath&&(e+=o.hostpath),o.query&&(e+=`?${o.query}`),o.fragment&&(e+=`#${o.fragment}`),e}var Uie,jl,QC=m(()=>{Uie=/^(([^:/?#]+):)?(\/\/([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/,jl=class{constructor(e){let t=e.match(Uie);this.scheme=t[2],this.authority=t[4],this.path=t[5],this.query=t[7],this.fragment=t[9]}toString(){let e="";return this.scheme&&(e+=`${this.scheme}:`),this.authority&&(e+=`//${this.authority}`),e+=this.path,this.query&&(e+=`?${this.query}`),this.fragment&&(e+=`#${this.fragment}`),e}getQuery(){let e={};if(this.query){let t=decodeURIComponent(this.query).split("&");for(let s of t){let i=s.split("=");e[i[0]]=i[1]}}return e}setQuery(e){let t="";for(let s in e)e.hasOwnProperty(s)&&(t!==""&&(t+="&"),t+=`${encodeURIComponent(s)}=${encodeURIComponent(e[s])}`);this.query=t}}});var au,JC=m(()=>{au=class o{static{this._traceChannels=new Set}static{this.stack=!1}static set(e,t=!0){}static get(e){return o._traceChannels.has(e)}}});var eI,qg,LE,tI,f1=m(()=>{eI=0,qg=1,LE=4,tI=5});var w,me=m(()=>{w={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp(o,e,t){return o>=t?t:o<=e?e:o},intToBytes24(o){let e=o>>16&255,t=o>>8&255,s=o&255;return[e,t,s]},intToBytes32(o){let e=o>>24&255,t=o>>16&255,s=o>>8&255,i=o&255;return[e,t,s,i]},bytesToInt24(o,e,t){return o.length&&(t=o[2],e=o[1],o=o[0]),o<<16|e<<8|t},bytesToInt32(o,e,t,s){return o.length&&(s=o[3],t=o[2],e=o[1],o=o[0]),(o<<24|e<<16|t<<8|s)>>>0},lerp(o,e,t){return o+(e-o)*w.clamp(t,0,1)},lerpAngle(o,e,t){return e-o>180&&(e-=360),e-o<-180&&(e+=360),w.lerp(o,e,w.clamp(t,0,1))},powerOfTwo(o){return o!==0&&!(o&o-1)},nextPowerOfTwo(o){return o--,o|=o>>1,o|=o>>2,o|=o>>4,o|=o>>8,o|=o>>16,o++,o},nearestPowerOfTwo(o){return Math.pow(2,Math.round(Math.log2(o)))},random(o,e){let t=e-o;return Math.random()*t+o},smoothstep(o,e,t){return t<=o?0:t>=e?1:(t=(t-o)/(e-o),t*t*(3-2*t))},smootherstep(o,e,t){return t<=o?0:t>=e?1:(t=(t-o)/(e-o),t*t*t*(t*(t*6-15)+10))},roundUp(o,e){return e===0?o:Math.ceil(o/e)*e},between(o,e,t,s){let i=Math.min(e,t),r=Math.max(e,t);return s?o>=i&&o<=r:o>i&&o<r}}});var N,De=m(()=>{me();N=class o{constructor(e=0,t=0,s=0,i=1){let r=e.length;r===3||r===4?(this.r=e[0],this.g=e[1],this.b=e[2],this.a=e[3]??1):(this.r=e,this.g=t,this.b=s,this.a=i)}clone(){let e=this.constructor;return new e(this.r,this.g,this.b,this.a)}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this}equals(e){return this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}set(e,t,s,i=1){return this.r=e,this.g=t,this.b=s,this.a=i,this}lerp(e,t,s){return this.r=e.r+s*(t.r-e.r),this.g=e.g+s*(t.g-e.g),this.b=e.b+s*(t.b-e.b),this.a=e.a+s*(t.a-e.a),this}linear(e=this){return this.r=Math.pow(e.r,2.2),this.g=Math.pow(e.g,2.2),this.b=Math.pow(e.b,2.2),this.a=e.a,this}gamma(e=this){return this.r=Math.pow(e.r,1/2.2),this.g=Math.pow(e.g,1/2.2),this.b=Math.pow(e.b,1/2.2),this.a=e.a,this}mulScalar(e){return this.r*=e,this.g*=e,this.b*=e,this}fromString(e){let t=parseInt(e.replace("#","0x"),16),s;return e.length>7?s=w.intToBytes32(t):(s=w.intToBytes24(t),s[3]=255),this.set(s[0]/255,s[1]/255,s[2]/255,s[3]/255),this}fromArray(e,t=0){return this.r=e[t]??this.r,this.g=e[t+1]??this.g,this.b=e[t+2]??this.b,this.a=e[t+3]??this.a,this}toString(e,t){let{r:s,g:i,b:r,a}=this;if(t||s>1||i>1||r>1)return`${s.toFixed(3)}, ${i.toFixed(3)}, ${r.toFixed(3)}, ${a.toFixed(3)}`;let n=`#${((1<<24)+(Math.round(s*255)<<16)+(Math.round(i*255)<<8)+Math.round(r*255)).toString(16).slice(1)}`;if(e===!0){let l=Math.round(a*255).toString(16);this.a<16/255?n+=`0${l}`:n+=l}return n}toArray(e=[],t=0,s=!0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,s&&(e[t+3]=this.a),e}static{this.BLACK=Object.freeze(new o(0,0,0,1))}static{this.BLUE=Object.freeze(new o(0,0,1,1))}static{this.CYAN=Object.freeze(new o(0,1,1,1))}static{this.GRAY=Object.freeze(new o(.5,.5,.5,1))}static{this.GREEN=Object.freeze(new o(0,1,0,1))}static{this.MAGENTA=Object.freeze(new o(1,0,1,1))}static{this.RED=Object.freeze(new o(1,0,0,1))}static{this.WHITE=Object.freeze(new o(1,1,1,1))}static{this.YELLOW=Object.freeze(new o(1,1,0,1))}}});var nu,sI=m(()=>{me();nu=class{constructor(e,t=0){this._left=-1/0,this._right=1/0,this._recip=0,this._p0=0,this._p1=0,this._m0=0,this._m1=0,this._curve=e,this._reset(t)}evaluate(e,t=!1){(t||e<this._left||e>=this._right)&&this._reset(e);let s,i=this._curve.type;if(i===5)s=this._p0;else{let r=this._recip===0?0:(e-this._left)*this._recip;i===0?s=w.lerp(this._p0,this._p1,r):i===1?s=w.lerp(this._p0,this._p1,r*r*(3-2*r)):s=this._evaluateHermite(this._p0,this._p1,this._m0,this._m1,r)}return s}_reset(e){let t=this._curve.keys,s=t.length;if(!s)this._left=-1/0,this._right=1/0,this._recip=0,this._p0=this._p1=this._m0=this._m1=0;else if(e<t[0][0])this._left=-1/0,this._right=t[0][0],this._recip=0,this._p0=this._p1=t[0][1],this._m0=this._m1=0;else if(e>=t[s-1][0])this._left=t[s-1][0],this._right=1/0,this._recip=0,this._p0=this._p1=t[s-1][1],this._m0=this._m1=0;else{let i=0;for(;e>=t[i+1][0];)i++;this._left=t[i][0],this._right=t[i+1][0];let r=1/(this._right-this._left);this._recip=isFinite(r)?r:0,this._p0=t[i][1],this._p1=t[i+1][1],this._curve.type===4&&this._calcTangents(t,i)}}_calcTangents(e,t){let s,i=e[t],r=e[t+1],a;if(t===0?s=[e[0][0]+(e[0][0]-e[1][0]),e[0][1]+(e[0][1]-e[1][1])]:s=e[t-1],t===e.length-2?a=[e[t+1][0]+(e[t+1][0]-e[t][0]),e[t+1][1]+(e[t+1][1]-e[t][1])]:a=e[t+2],this._curve.type===4){let n=2*(r[0]-i[0])/(r[0]-s[0]),l=2*(r[0]-i[0])/(a[0]-i[0]);this._m0=this._curve.tension*(isFinite(n)?n:0)*(r[1]-s[1]),this._m1=this._curve.tension*(isFinite(l)?l:0)*(a[1]-i[1])}else{let n=(r[0]-i[0])/(i[0]-s[0]),l=(r[0]-i[0])/(a[0]-r[0]),h=i[1]+(s[1]-i[1])*(isFinite(n)?n:0),c=r[1]+(a[1]-r[1])*(isFinite(l)?l:0),f=this._curve.tension;this._m0=f*(r[1]-h),this._m1=f*(c-i[1])}}_evaluateHermite(e,t,s,i,r){let a=r*r,n=r+r,l=1-r,h=l*l;return e*((1+n)*h)+s*(r*h)+t*(a*(3-n))+i*(a*(r-1))}}});var Ts,ou=m(()=>{sI();Ts=class{constructor(e){if(this.keys=[],this.type=1,this.tension=.5,this._eval=new nu(this),e)for(let t=0;t<e.length-1;t+=2)this.keys.push([e[t],e[t+1]]);this.sort()}get length(){return this.keys.length}add(e,t){let s=this.keys,i=s.length,r=0;for(;r<i&&!(s[r][0]>e);r++);let a=[e,t];return this.keys.splice(r,0,a),a}get(e){return this.keys[e]}sort(){this.keys.sort((e,t)=>e[0]-t[0])}value(e){return this._eval.evaluate(e,!0)}closest(e){let t=this.keys,s=t.length,i=2,r=null;for(let a=0;a<s;a++){let n=Math.abs(e-t[a][0]);if(i>=n)i=n,r=t[a];else break}return r}clone(){let e=new this.constructor;return e.keys=this.keys.map(t=>[...t]),e.type=this.type,e.tension=this.tension,e}quantize(e){e=Math.max(e,2);let t=new Float32Array(e),s=1/(e-1);t[0]=this._eval.evaluate(0,!0);for(let i=1;i<e;i++)t[i]=this._eval.evaluate(s*i);return t}quantizeClamped(e,t,s){let i=this.quantize(e);for(let r=0;r<i.length;++r)i[r]=Math.min(s,Math.max(t,i[r]));return i}}});var Bi,jg=m(()=>{ou();sI();Bi=class{constructor(...e){if(this.curves=[],this._type=1,e.length>1)for(let t=0;t<e.length;t++)this.curves.push(new Ts(e[t]));else if(e.length===0)this.curves.push(new Ts);else{let t=e[0];if(typeof t=="number")for(let s=0;s<t;s++)this.curves.push(new Ts);else for(let s=0;s<t.length;s++)this.curves.push(new Ts(t[s]))}}get length(){return this.curves.length}set type(e){this._type=e;for(let t=0;t<this.curves.length;t++)this.curves[t].type=e}get type(){return this._type}get(e){return this.curves[e]}value(e,t=[]){let s=this.curves.length;t.length=s;for(let i=0;i<s;i++)t[i]=this.curves[i].value(e);return t}clone(){let e=new this.constructor;e.curves=[];for(let t=0;t<this.curves.length;t++)e.curves.push(this.curves[t].clone());return e._type=this._type,e}quantize(e){e=Math.max(e,2);let t=this.curves.length,s=new Float32Array(e*t),i=1/(e-1);for(let r=0;r<t;r++){let a=new nu(this.curves[r]);for(let n=0;n<e;n++)s[n*t+r]=a.evaluate(i*n)}return s}quantizeClamped(e,t,s){let i=this.quantize(e);for(let r=0;r<i.length;++r)i[r]=Math.min(s,Math.max(t,i[r]));return i}}});var iI,d1,Bs,$l=m(()=>{iI=new Float32Array(1),d1=new Int32Array(iI.buffer),Bs=class{static float2Half(e){iI[0]=e;let t=d1[0],s=t>>16&32768,i=t>>12&2047,r=t>>23&255;return r<103?s:r>142?(s|=31744,s|=(r===255?0:1)&&t&8388607,s):r<113?(i|=2048,s|=(i>>114-r)+(i>>113-r&1),s):(s|=r-112<<10|i>>1,s+=i&1,s)}static float2RGBA8(e,t){iI[0]=e;let s=d1[0];t.r=(s>>24&255)/255,t.g=(s>>16&255)/255,t.b=(s>>8&255)/255,t.a=(s&255)/255}}});var lu,rI=m(()=>{lu=class{static concentric(e,t){let s=[];s.push(0,0);let i=2*Math.PI/e/t;for(let r=1;r<=e;r++){let a=r/e,n=2*Math.PI*a,l=Math.max(1,Math.floor(n/i)),h=2*Math.PI/l;for(let c=0;c<l;c++){let f=c*h,d=a*Math.cos(f),u=a*Math.sin(f);s.push(d,u)}}return s}}});var g,Q=m(()=>{g=class o{constructor(e=0,t=0,s=0){e.length===3?(this.x=e[0],this.y=e[1],this.z=e[2]):(this.x=e,this.y=t,this.z=s)}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}add2(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addScaled(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}clone(){let e=this.constructor;return new e(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}cross(e,t){let s=e.x,i=e.y,r=e.z,a=t.x,n=t.y,l=t.z;return this.x=i*l-n*r,this.y=r*a-l*s,this.z=s*n-a*i,this}distance(e){let t=this.x-e.x,s=this.y-e.y,i=this.z-e.z;return Math.sqrt(t*t+s*s+i*i)}div(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}div2(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this.z=e.z/t.z,this}divScalar(e){return this.x/=e,this.y/=e,this.z/=e,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}equals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z}equalsApprox(e,t=1e-6){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}lerp(e,t,s){return this.x=e.x+s*(t.x-e.x),this.y=e.y+s*(t.y-e.y),this.z=e.z+s*(t.z-e.z),this}mul(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}mul2(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}mulScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}normalize(e=this){let t=e.x*e.x+e.y*e.y+e.z*e.z;if(t>0){let s=1/Math.sqrt(t);this.x=e.x*s,this.y=e.y*s,this.z=e.z*s}return this}floor(e=this){return this.x=Math.floor(e.x),this.y=Math.floor(e.y),this.z=Math.floor(e.z),this}ceil(e=this){return this.x=Math.ceil(e.x),this.y=Math.ceil(e.y),this.z=Math.ceil(e.z),this}round(e=this){return this.x=Math.round(e.x),this.y=Math.round(e.y),this.z=Math.round(e.z),this}min(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),this}max(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),this}project(e){let t=this.x*e.x+this.y*e.y+this.z*e.z,s=e.x*e.x+e.y*e.y+e.z*e.z,i=t/s;return this.x=e.x*i,this.y=e.y*i,this.z=e.z*i,this}set(e,t,s){return this.x=e,this.y=t,this.z=s,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}sub2(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}fromArray(e,t=0){return this.x=e[t]??this.x,this.y=e[t+1]??this.y,this.z=e[t+2]??this.z,this}toString(){return`[${this.x}, ${this.y}, ${this.z}]`}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e}static{this.ZERO=Object.freeze(new o(0,0,0))}static{this.HALF=Object.freeze(new o(.5,.5,.5))}static{this.ONE=Object.freeze(new o(1,1,1))}static{this.UP=Object.freeze(new o(0,1,0))}static{this.DOWN=Object.freeze(new o(0,-1,0))}static{this.RIGHT=Object.freeze(new o(1,0,0))}static{this.LEFT=Object.freeze(new o(-1,0,0))}static{this.FORWARD=Object.freeze(new o(0,0,-1))}static{this.BACK=Object.freeze(new o(0,0,1))}}});var Vs,Zl=m(()=>{Q();Vs=class o{constructor(){this.data=new Float32Array(9),this.data[0]=this.data[4]=this.data[8]=1}clone(){let e=this.constructor;return new e().copy(this)}copy(e){let t=e.data,s=this.data;return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[4]=t[4],s[5]=t[5],s[6]=t[6],s[7]=t[7],s[8]=t[8],this}set(e){let t=this.data;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],this}getX(e=new g){return e.set(this.data[0],this.data[1],this.data[2])}getY(e=new g){return e.set(this.data[3],this.data[4],this.data[5])}getZ(e=new g){return e.set(this.data[6],this.data[7],this.data[8])}equals(e){let t=this.data,s=e.data;return t[0]===s[0]&&t[1]===s[1]&&t[2]===s[2]&&t[3]===s[3]&&t[4]===s[4]&&t[5]===s[5]&&t[6]===s[6]&&t[7]===s[7]&&t[8]===s[8]}isIdentity(){let e=this.data;return e[0]===1&&e[1]===0&&e[2]===0&&e[3]===0&&e[4]===1&&e[5]===0&&e[6]===0&&e[7]===0&&e[8]===1}setIdentity(){let e=this.data;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,this}toString(){return`[${this.data.join(", ")}]`}transpose(e=this){let t=e.data,s=this.data;if(t===s){let i;i=t[1],s[1]=t[3],s[3]=i,i=t[2],s[2]=t[6],s[6]=i,i=t[5],s[5]=t[7],s[7]=i}else s[0]=t[0],s[1]=t[3],s[2]=t[6],s[3]=t[1],s[4]=t[4],s[5]=t[7],s[6]=t[2],s[7]=t[5],s[8]=t[8];return this}setFromMat4(e){let t=e.data,s=this.data;return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[4],s[4]=t[5],s[5]=t[6],s[6]=t[8],s[7]=t[9],s[8]=t[10],this}setFromQuat(e){let t=e.x,s=e.y,i=e.z,r=e.w,a=t+t,n=s+s,l=i+i,h=t*a,c=t*n,f=t*l,d=s*n,u=s*l,p=i*l,_=r*a,S=r*n,T=r*l,x=this.data;return x[0]=1-(d+p),x[1]=c+T,x[2]=f-S,x[3]=c-T,x[4]=1-(h+p),x[5]=u+_,x[6]=f+S,x[7]=u-_,x[8]=1-(h+d),this}invertMat4(e){let t=e.data,s=t[0],i=t[1],r=t[2],a=t[4],n=t[5],l=t[6],h=t[8],c=t[9],f=t[10],d=f*n-l*c,u=-f*i+r*c,p=l*i-r*n,_=-f*a+l*h,S=f*s-r*h,T=-l*s+r*a,x=c*a-n*h,A=-c*s+i*h,E=n*s-i*a,v=s*d+i*_+r*x;if(v===0)this.setIdentity();else{let R=1/v,P=this.data;P[0]=d*R,P[1]=u*R,P[2]=p*R,P[3]=_*R,P[4]=S*R,P[5]=T*R,P[6]=x*R,P[7]=A*R,P[8]=E*R}return this}transformVector(e,t=new g){let s=this.data,{x:i,y:r,z:a}=e;return t.x=i*s[0]+r*s[3]+a*s[6],t.y=i*s[1]+r*s[4]+a*s[7],t.z=i*s[2]+r*s[5]+a*s[8],t}static{this.IDENTITY=Object.freeze(new o)}static{this.ZERO=Object.freeze(new o().set([0,0,0,0,0,0,0,0,0]))}}});var D,Ne=m(()=>{me();D=class o{constructor(e=0,t=0){e.length===2?(this.x=e[0],this.y=e[1]):(this.x=e,this.y=t)}add(e){return this.x+=e.x,this.y+=e.y,this}add2(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}addScalar(e){return this.x+=e,this.y+=e,this}addScaled(e,t){return this.x+=e.x*t,this.y+=e.y*t,this}clone(){let e=this.constructor;return new e(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}cross(e){return this.x*e.y-this.y*e.x}distance(e){let t=this.x-e.x,s=this.y-e.y;return Math.sqrt(t*t+s*s)}div(e){return this.x/=e.x,this.y/=e.y,this}div2(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this}divScalar(e){return this.x/=e,this.y/=e,this}dot(e){return this.x*e.x+this.y*e.y}equals(e){return this.x===e.x&&this.y===e.y}equalsApprox(e,t=1e-6){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSq(){return this.x*this.x+this.y*this.y}lerp(e,t,s){return this.x=e.x+s*(t.x-e.x),this.y=e.y+s*(t.y-e.y),this}mul(e){return this.x*=e.x,this.y*=e.y,this}mul2(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this}mulScalar(e){return this.x*=e,this.y*=e,this}normalize(e=this){let t=e.x*e.x+e.y*e.y;if(t>0){let s=1/Math.sqrt(t);this.x=e.x*s,this.y=e.y*s}return this}rotate(e){let t=Math.atan2(this.x,this.y)+e*w.DEG_TO_RAD,s=Math.sqrt(this.x*this.x+this.y*this.y);return this.x=Math.sin(t)*s,this.y=Math.cos(t)*s,this}angle(){return Math.atan2(this.x,this.y)*w.RAD_TO_DEG}angleTo(e){return Math.atan2(this.x*e.y+this.y*e.x,this.x*e.x+this.y*e.y)*w.RAD_TO_DEG}floor(e=this){return this.x=Math.floor(e.x),this.y=Math.floor(e.y),this}ceil(e=this){return this.x=Math.ceil(e.x),this.y=Math.ceil(e.y),this}round(e=this){return this.x=Math.round(e.x),this.y=Math.round(e.y),this}min(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),this}max(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),this}set(e,t){return this.x=e,this.y=t,this}sub(e){return this.x-=e.x,this.y-=e.y,this}sub2(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}subScalar(e){return this.x-=e,this.y-=e,this}fromArray(e,t=0){return this.x=e[t]??this.x,this.y=e[t+1]??this.y,this}toString(){return`[${this.x}, ${this.y}]`}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e}static angleRad(e,t){return Math.atan2(e.x*t.y-e.y*t.x,e.x*t.x+e.y*t.y)}static{this.ZERO=Object.freeze(new o(0,0))}static{this.HALF=Object.freeze(new o(.5,.5))}static{this.ONE=Object.freeze(new o(1,1))}static{this.UP=Object.freeze(new o(0,1))}static{this.DOWN=Object.freeze(new o(0,-1))}static{this.RIGHT=Object.freeze(new o(1,0))}static{this.LEFT=Object.freeze(new o(-1,0))}}});var W,Ze=m(()=>{W=class o{constructor(e=0,t=0,s=0,i=0){e.length===4?(this.x=e[0],this.y=e[1],this.z=e[2],this.w=e[3]):(this.x=e,this.y=t,this.z=s,this.w=i)}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}add2(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addScaled(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this}clone(){let e=this.constructor;return new e(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}div(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this}div2(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this.z=e.z/t.z,this.w=e.w/t.w,this}divScalar(e){return this.x/=e,this.y/=e,this.z/=e,this.w/=e,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}equals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}equalsApprox(e,t=1e-6){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t&&Math.abs(this.w-e.w)<t}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}lerp(e,t,s){return this.x=e.x+s*(t.x-e.x),this.y=e.y+s*(t.y-e.y),this.z=e.z+s*(t.z-e.z),this.w=e.w+s*(t.w-e.w),this}mul(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}mul2(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this.w=e.w*t.w,this}mulScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}normalize(e=this){let t=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w;if(t>0){let s=1/Math.sqrt(t);this.x=e.x*s,this.y=e.y*s,this.z=e.z*s,this.w=e.w*s}return this}floor(e=this){return this.x=Math.floor(e.x),this.y=Math.floor(e.y),this.z=Math.floor(e.z),this.w=Math.floor(e.w),this}ceil(e=this){return this.x=Math.ceil(e.x),this.y=Math.ceil(e.y),this.z=Math.ceil(e.z),this.w=Math.ceil(e.w),this}round(e=this){return this.x=Math.round(e.x),this.y=Math.round(e.y),this.z=Math.round(e.z),this.w=Math.round(e.w),this}min(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),e.w<this.w&&(this.w=e.w),this}max(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),e.w>this.w&&(this.w=e.w),this}set(e,t,s,i){return this.x=e,this.y=t,this.z=s,this.w=i,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}sub2(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}fromArray(e,t=0){return this.x=e[t]??this.x,this.y=e[t+1]??this.y,this.z=e[t+2]??this.z,this.w=e[t+3]??this.w,this}toString(){return`[${this.x}, ${this.y}, ${this.z}, ${this.w}]`}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e}static{this.ZERO=Object.freeze(new o(0,0,0,0))}static{this.HALF=Object.freeze(new o(.5,.5,.5,.5))}static{this.ONE=Object.freeze(new o(1,1,1,1))}}});var $g,ka,An,Pn,bE,k,Ke=m(()=>{me();Ne();Q();Ze();$g=new D,ka=new g,An=new g,Pn=new g,bE=new g,k=class o{constructor(){this.data=new Float32Array(16),this.data[0]=this.data[5]=this.data[10]=this.data[15]=1}static _getPerspectiveHalfSize(e,t,s,i,r){r?(e.x=i*Math.tan(t*Math.PI/360),e.y=e.x/s):(e.y=i*Math.tan(t*Math.PI/360),e.x=e.y*s)}add2(e,t){let s=e.data,i=t.data,r=this.data;return r[0]=s[0]+i[0],r[1]=s[1]+i[1],r[2]=s[2]+i[2],r[3]=s[3]+i[3],r[4]=s[4]+i[4],r[5]=s[5]+i[5],r[6]=s[6]+i[6],r[7]=s[7]+i[7],r[8]=s[8]+i[8],r[9]=s[9]+i[9],r[10]=s[10]+i[10],r[11]=s[11]+i[11],r[12]=s[12]+i[12],r[13]=s[13]+i[13],r[14]=s[14]+i[14],r[15]=s[15]+i[15],this}add(e){return this.add2(this,e)}clone(){let e=this.constructor;return new e().copy(this)}copy(e){let t=e.data,s=this.data;return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[4]=t[4],s[5]=t[5],s[6]=t[6],s[7]=t[7],s[8]=t[8],s[9]=t[9],s[10]=t[10],s[11]=t[11],s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15],this}equals(e){let t=this.data,s=e.data;return t[0]===s[0]&&t[1]===s[1]&&t[2]===s[2]&&t[3]===s[3]&&t[4]===s[4]&&t[5]===s[5]&&t[6]===s[6]&&t[7]===s[7]&&t[8]===s[8]&&t[9]===s[9]&&t[10]===s[10]&&t[11]===s[11]&&t[12]===s[12]&&t[13]===s[13]&&t[14]===s[14]&&t[15]===s[15]}isIdentity(){let e=this.data;return e[0]===1&&e[1]===0&&e[2]===0&&e[3]===0&&e[4]===0&&e[5]===1&&e[6]===0&&e[7]===0&&e[8]===0&&e[9]===0&&e[10]===1&&e[11]===0&&e[12]===0&&e[13]===0&&e[14]===0&&e[15]===1}mul2(e,t){let s=e.data,i=t.data,r=this.data,a=s[0],n=s[1],l=s[2],h=s[3],c=s[4],f=s[5],d=s[6],u=s[7],p=s[8],_=s[9],S=s[10],T=s[11],x=s[12],A=s[13],E=s[14],v=s[15],R,P,y,C;return R=i[0],P=i[1],y=i[2],C=i[3],r[0]=a*R+c*P+p*y+x*C,r[1]=n*R+f*P+_*y+A*C,r[2]=l*R+d*P+S*y+E*C,r[3]=h*R+u*P+T*y+v*C,R=i[4],P=i[5],y=i[6],C=i[7],r[4]=a*R+c*P+p*y+x*C,r[5]=n*R+f*P+_*y+A*C,r[6]=l*R+d*P+S*y+E*C,r[7]=h*R+u*P+T*y+v*C,R=i[8],P=i[9],y=i[10],C=i[11],r[8]=a*R+c*P+p*y+x*C,r[9]=n*R+f*P+_*y+A*C,r[10]=l*R+d*P+S*y+E*C,r[11]=h*R+u*P+T*y+v*C,R=i[12],P=i[13],y=i[14],C=i[15],r[12]=a*R+c*P+p*y+x*C,r[13]=n*R+f*P+_*y+A*C,r[14]=l*R+d*P+S*y+E*C,r[15]=h*R+u*P+T*y+v*C,this}mulAffine2(e,t){let s=e.data,i=t.data,r=this.data,a=s[0],n=s[1],l=s[2],h=s[4],c=s[5],f=s[6],d=s[8],u=s[9],p=s[10],_=s[12],S=s[13],T=s[14],x,A,E;return x=i[0],A=i[1],E=i[2],r[0]=a*x+h*A+d*E,r[1]=n*x+c*A+u*E,r[2]=l*x+f*A+p*E,r[3]=0,x=i[4],A=i[5],E=i[6],r[4]=a*x+h*A+d*E,r[5]=n*x+c*A+u*E,r[6]=l*x+f*A+p*E,r[7]=0,x=i[8],A=i[9],E=i[10],r[8]=a*x+h*A+d*E,r[9]=n*x+c*A+u*E,r[10]=l*x+f*A+p*E,r[11]=0,x=i[12],A=i[13],E=i[14],r[12]=a*x+h*A+d*E+_,r[13]=n*x+c*A+u*E+S,r[14]=l*x+f*A+p*E+T,r[15]=1,this}mul(e){return this.mul2(this,e)}transformPoint(e,t=new g){let s=this.data,{x:i,y:r,z:a}=e;return t.x=i*s[0]+r*s[4]+a*s[8]+s[12],t.y=i*s[1]+r*s[5]+a*s[9]+s[13],t.z=i*s[2]+r*s[6]+a*s[10]+s[14],t}transformVector(e,t=new g){let s=this.data,{x:i,y:r,z:a}=e;return t.x=i*s[0]+r*s[4]+a*s[8],t.y=i*s[1]+r*s[5]+a*s[9],t.z=i*s[2]+r*s[6]+a*s[10],t}transformVec4(e,t=new W){let s=this.data,{x:i,y:r,z:a,w:n}=e;return t.x=i*s[0]+r*s[4]+a*s[8]+n*s[12],t.y=i*s[1]+r*s[5]+a*s[9]+n*s[13],t.z=i*s[2]+r*s[6]+a*s[10]+n*s[14],t.w=i*s[3]+r*s[7]+a*s[11]+n*s[15],t}setLookAt(e,t,s){Pn.sub2(e,t).normalize(),An.copy(s).normalize(),ka.cross(An,Pn).normalize(),An.cross(Pn,ka);let i=this.data;return i[0]=ka.x,i[1]=ka.y,i[2]=ka.z,i[3]=0,i[4]=An.x,i[5]=An.y,i[6]=An.z,i[7]=0,i[8]=Pn.x,i[9]=Pn.y,i[10]=Pn.z,i[11]=0,i[12]=e.x,i[13]=e.y,i[14]=e.z,i[15]=1,this}setFrustum(e,t,s,i,r,a){let n=2*r,l=t-e,h=i-s,c=a-r,f=this.data;return f[0]=n/l,f[1]=0,f[2]=0,f[3]=0,f[4]=0,f[5]=n/h,f[6]=0,f[7]=0,f[8]=(t+e)/l,f[9]=(i+s)/h,f[10]=(-a-r)/c,f[11]=-1,f[12]=0,f[13]=0,f[14]=-n*a/c,f[15]=0,this}setPerspective(e,t,s,i,r){return o._getPerspectiveHalfSize($g,e,t,s,r),this.setFrustum(-$g.x,$g.x,-$g.y,$g.y,s,i)}setOrtho(e,t,s,i,r,a){let n=this.data;return n[0]=2/(t-e),n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=2/(i-s),n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=-2/(a-r),n[11]=0,n[12]=-(t+e)/(t-e),n[13]=-(i+s)/(i-s),n[14]=-(a+r)/(a-r),n[15]=1,this}setFromAxisAngle(e,t){t*=w.DEG_TO_RAD;let{x:s,y:i,z:r}=e,a=Math.cos(t),n=Math.sin(t),l=1-a,h=l*s,c=l*i,f=this.data;return f[0]=h*s+a,f[1]=h*i+n*r,f[2]=h*r-n*i,f[3]=0,f[4]=h*i-n*r,f[5]=c*i+a,f[6]=c*r+n*s,f[7]=0,f[8]=h*r+n*i,f[9]=c*r-s*n,f[10]=l*r*r+a,f[11]=0,f[12]=0,f[13]=0,f[14]=0,f[15]=1,this}setTranslate(e,t,s){let i=this.data;return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=e,i[13]=t,i[14]=s,i[15]=1,this}setScale(e,t,s){let i=this.data;return i[0]=e,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=t,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=s,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,this}setViewport(e,t,s,i){let r=this.data;return r[0]=s*.5,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=i*.5,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=.5,r[11]=0,r[12]=e+s*.5,r[13]=t+i*.5,r[14]=.5,r[15]=1,this}setReflection(e,t){let s=e.x,i=e.y,r=e.z,a=this.data;return a[0]=1-2*s*s,a[1]=-2*s*i,a[2]=-2*s*r,a[3]=0,a[4]=-2*s*i,a[5]=1-2*i*i,a[6]=-2*i*r,a[7]=0,a[8]=-2*s*r,a[9]=-2*i*r,a[10]=1-2*r*r,a[11]=0,a[12]=-2*s*t,a[13]=-2*i*t,a[14]=-2*r*t,a[15]=1,this}invert(e=this){let t=e.data,s=t[0],i=t[1],r=t[2],a=t[3],n=t[4],l=t[5],h=t[6],c=t[7],f=t[8],d=t[9],u=t[10],p=t[11],_=t[12],S=t[13],T=t[14],x=t[15],A=s*l-i*n,E=s*h-r*n,v=s*c-a*n,R=i*h-r*l,P=i*c-a*l,y=r*c-a*h,C=f*S-d*_,L=f*T-u*_,O=f*x-p*_,M=d*T-u*S,U=d*x-p*S,G=u*x-p*T,$=A*G-E*U+v*M+R*O-P*L+y*C;if($===0)this.setIdentity();else{let X=1/$,I=this.data;I[0]=(l*G-h*U+c*M)*X,I[1]=(-i*G+r*U-a*M)*X,I[2]=(S*y-T*P+x*R)*X,I[3]=(-d*y+u*P-p*R)*X,I[4]=(-n*G+h*O-c*L)*X,I[5]=(s*G-r*O+a*L)*X,I[6]=(-_*y+T*v-x*E)*X,I[7]=(f*y-u*v+p*E)*X,I[8]=(n*U-l*O+c*C)*X,I[9]=(-s*U+i*O-a*C)*X,I[10]=(_*P-S*v+x*A)*X,I[11]=(-f*P+d*v-p*A)*X,I[12]=(-n*M+l*L-h*C)*X,I[13]=(s*M-i*L+r*C)*X,I[14]=(-_*R+S*E-T*A)*X,I[15]=(f*R-d*E+u*A)*X}return this}set(e){let t=this.data;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],this}setIdentity(){let e=this.data;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}setTRS(e,t,s){let i=t.x,r=t.y,a=t.z,n=t.w,l=s.x,h=s.y,c=s.z,f=i+i,d=r+r,u=a+a,p=i*f,_=i*d,S=i*u,T=r*d,x=r*u,A=a*u,E=n*f,v=n*d,R=n*u,P=this.data;return P[0]=(1-(T+A))*l,P[1]=(_+R)*l,P[2]=(S-v)*l,P[3]=0,P[4]=(_-R)*h,P[5]=(1-(p+A))*h,P[6]=(x+E)*h,P[7]=0,P[8]=(S+v)*c,P[9]=(x-E)*c,P[10]=(1-(p+T))*c,P[11]=0,P[12]=e.x,P[13]=e.y,P[14]=e.z,P[15]=1,this}transpose(e=this){let t=e.data,s=this.data;if(t===s){let i;i=t[1],s[1]=t[4],s[4]=i,i=t[2],s[2]=t[8],s[8]=i,i=t[3],s[3]=t[12],s[12]=i,i=t[6],s[6]=t[9],s[9]=i,i=t[7],s[7]=t[13],s[13]=i,i=t[11],s[11]=t[14],s[14]=i}else s[0]=t[0],s[1]=t[4],s[2]=t[8],s[3]=t[12],s[4]=t[1],s[5]=t[5],s[6]=t[9],s[7]=t[13],s[8]=t[2],s[9]=t[6],s[10]=t[10],s[11]=t[14],s[12]=t[3],s[13]=t[7],s[14]=t[11],s[15]=t[15];return this}getTranslation(e=new g){return e.set(this.data[12],this.data[13],this.data[14])}getX(e=new g){return e.set(this.data[0],this.data[1],this.data[2])}getY(e=new g){return e.set(this.data[4],this.data[5],this.data[6])}getZ(e=new g){return e.set(this.data[8],this.data[9],this.data[10])}getScale(e=new g){return this.getX(ka),this.getY(An),this.getZ(Pn),e.set(ka.length(),An.length(),Pn.length()),e}get scaleSign(){return this.getX(ka),this.getY(An),this.getZ(Pn),ka.cross(ka,An),ka.dot(Pn)<0?-1:1}setFromEulerAngles(e,t,s){e*=w.DEG_TO_RAD,t*=w.DEG_TO_RAD,s*=w.DEG_TO_RAD;let i=Math.sin(-e),r=Math.cos(-e),a=Math.sin(-t),n=Math.cos(-t),l=Math.sin(-s),h=Math.cos(-s),c=this.data;return c[0]=n*h,c[1]=-n*l,c[2]=a,c[3]=0,c[4]=r*l+h*i*a,c[5]=r*h-i*a*l,c[6]=-n*i,c[7]=0,c[8]=i*l-r*h*a,c[9]=h*i+r*a*l,c[10]=r*n,c[11]=0,c[12]=0,c[13]=0,c[14]=0,c[15]=1,this}getEulerAngles(e=new g){this.getScale(bE);let t=bE.x,s=bE.y,i=bE.z;if(t===0||s===0||i===0)return e.set(0,0,0);let r=this.data,a=Math.asin(-r[2]/t),n=Math.PI*.5,l,h;return a<n?a>-n?(l=Math.atan2(r[6]/s,r[10]/i),h=Math.atan2(r[1]/t,r[0]/t)):(h=0,l=-Math.atan2(r[4]/s,r[5]/s)):(h=0,l=Math.atan2(r[4]/s,r[5]/s)),e.set(l,a,h).mulScalar(w.RAD_TO_DEG)}toString(){return`[${this.data.join(", ")}]`}static{this.IDENTITY=Object.freeze(new o)}static{this.ZERO=Object.freeze(new o().set([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]))}}});var H,Ve=m(()=>{me();Q();H=class o{constructor(e=0,t=0,s=0,i=1){e.length===4?(this.x=e[0],this.y=e[1],this.z=e[2],this.w=e[3]):(this.x=e,this.y=t,this.z=s,this.w=i)}clone(){let e=this.constructor;return new e(this.x,this.y,this.z,this.w)}conjugate(e=this){return this.x=e.x*-1,this.y=e.y*-1,this.z=e.z*-1,this.w=e.w,this}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}equals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}equalsApprox(e,t=1e-6){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t&&Math.abs(this.w-e.w)<t}getAxisAngle(e){let t=Math.acos(this.w)*2,s=Math.sin(t/2);return s!==0?(e.x=this.x/s,e.y=this.y/s,e.z=this.z/s,(e.x<0||e.y<0||e.z<0)&&(e.x*=-1,e.y*=-1,e.z*=-1,t*=-1)):(e.x=1,e.y=0,e.z=0),t*w.RAD_TO_DEG}getEulerAngles(e=new g){let t,s,i,r=this.x,a=this.y,n=this.z,l=this.w,h=2*(l*a-r*n);return h<=-.99999?(t=2*Math.atan2(r,l),s=-Math.PI/2,i=0):h>=.99999?(t=2*Math.atan2(r,l),s=Math.PI/2,i=0):(t=Math.atan2(2*(l*r+a*n),1-2*(r*r+a*a)),s=Math.asin(h),i=Math.atan2(2*(l*n+r*a),1-2*(a*a+n*n))),e.set(t,s,i).mulScalar(w.RAD_TO_DEG)}invert(e=this){return this.conjugate(e).normalize()}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}lerp(e,t,s){let i=(1-s)*(e.dot(t)<0?-1:1);return this.x=e.x*i+t.x*s,this.y=e.y*i+t.y*s,this.z=e.z*i+t.z*s,this.w=e.w*i+t.w*s,this.normalize()}mul(e){let t=this.x,s=this.y,i=this.z,r=this.w,a=e.x,n=e.y,l=e.z,h=e.w;return this.x=r*a+t*h+s*l-i*n,this.y=r*n+s*h+i*a-t*l,this.z=r*l+i*h+t*n-s*a,this.w=r*h-t*a-s*n-i*l,this}mulScalar(e,t=this){return this.x=t.x*e,this.y=t.y*e,this.z=t.z*e,this.w=t.w*e,this}mul2(e,t){let s=e.x,i=e.y,r=e.z,a=e.w,n=t.x,l=t.y,h=t.z,c=t.w;return this.x=a*n+s*c+i*h-r*l,this.y=a*l+i*c+r*n-s*h,this.z=a*h+r*c+s*l-i*n,this.w=a*c-s*n-i*l-r*h,this}normalize(e=this){let t=e.length();return t===0?(this.x=this.y=this.z=0,this.w=1):(t=1/t,this.x=e.x*t,this.y=e.y*t,this.z=e.z*t,this.w=e.w*t),this}set(e,t,s,i){return this.x=e,this.y=t,this.z=s,this.w=i,this}setFromAxisAngle(e,t){t*=.5*w.DEG_TO_RAD;let s=Math.sin(t),i=Math.cos(t);return this.x=s*e.x,this.y=s*e.y,this.z=s*e.z,this.w=i,this}setFromEulerAngles(e,t,s){if(e instanceof g){let f=e;e=f.x,t=f.y,s=f.z}let i=.5*w.DEG_TO_RAD;e*=i,t*=i,s*=i;let r=Math.sin(e),a=Math.cos(e),n=Math.sin(t),l=Math.cos(t),h=Math.sin(s),c=Math.cos(s);return this.x=r*l*c-a*n*h,this.y=a*n*c+r*l*h,this.z=a*l*h-r*n*c,this.w=a*l*c+r*n*h,this}setFromMat4(e){let t=e.data,s=t[0],i=t[1],r=t[2],a=t[4],n=t[5],l=t[6],h=t[8],c=t[9],f=t[10],d;return d=s*s+i*i+r*r,d===0?this.set(0,0,0,1):(d=1/Math.sqrt(d),s*=d,i*=d,r*=d,d=a*a+n*n+l*l,d===0?this.set(0,0,0,1):(d=1/Math.sqrt(d),a*=d,n*=d,l*=d,d=h*h+c*c+f*f,d===0?this.set(0,0,0,1):(d=1/Math.sqrt(d),h*=d,c*=d,f*=d,f<0?s>n?this.set(1+s-n-f,i+a,h+r,l-c):this.set(i+a,1-s+n-f,l+c,h-r):s<-n?this.set(h+r,l+c,1-s-n+f,i-a):this.set(l-c,h-r,i-a,1+s+n+f),this.mulScalar(1/this.length()))))}setFromDirections(e,t){let s=1+e.dot(t);return s<Number.EPSILON?Math.abs(e.x)>Math.abs(e.y)?(this.x=-e.z,this.y=0,this.z=e.x,this.w=0):(this.x=0,this.y=-e.z,this.z=e.y,this.w=0):(this.x=e.y*t.z-e.z*t.y,this.y=e.z*t.x-e.x*t.z,this.z=e.x*t.y-e.y*t.x,this.w=s),this.normalize()}slerp(e,t,s){let i=e.x,r=e.y,a=e.z,n=e.w,l=t.x,h=t.y,c=t.z,f=t.w,d=n*f+i*l+r*h+a*c;if(d<0&&(f=-f,l=-l,h=-h,c=-c,d=-d),Math.abs(d)>=1)return this.w=n,this.x=i,this.y=r,this.z=a,this;let u=Math.acos(d),p=Math.sqrt(1-d*d);if(Math.abs(p)<.001)return this.w=n*.5+f*.5,this.x=i*.5+l*.5,this.y=r*.5+h*.5,this.z=a*.5+c*.5,this;let _=Math.sin((1-s)*u)/p,S=Math.sin(s*u)/p;return this.w=n*_+f*S,this.x=i*_+l*S,this.y=r*_+h*S,this.z=a*_+c*S,this}transformVector(e,t=new g){let s=e.x,i=e.y,r=e.z,a=this.x,n=this.y,l=this.z,h=this.w,c=h*s+n*r-l*i,f=h*i+l*s-a*r,d=h*r+a*i-n*s,u=-a*s-n*i-l*r;return t.x=c*h+u*-a+f*-l-d*-n,t.y=f*h+u*-n+d*-a-c*-l,t.z=d*h+u*-l+c*-n-f*-a,t}fromArray(e,t=0){return this.x=e[t]??this.x,this.y=e[t+1]??this.y,this.z=e[t+2]??this.z,this.w=e[t+3]??this.w,this}toString(){return`[${this.x}, ${this.y}, ${this.z}, ${this.w}]`}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e}static{this.IDENTITY=Object.freeze(new o(0,0,0,1))}static{this.ZERO=Object.freeze(new o(0,0,0,0))}}});var hu,cu,u1,m1,Bie,_e,Vt=m(()=>{Q();hu=new g,cu=new g,u1=new g,m1=new g,Bie=new g,_e=class o{constructor(e,t){this.center=new g,this.halfExtents=new g(.5,.5,.5),this._min=new g,this._max=new g,e&&this.center.copy(e),t&&this.halfExtents.copy(t)}add(e){let t=this.center,s=t.x,i=t.y,r=t.z,a=this.halfExtents,n=a.x,l=a.y,h=a.z,c=s-n,f=s+n,d=i-l,u=i+l,p=r-h,_=r+h,S=e.center,T=S.x,x=S.y,A=S.z,E=e.halfExtents,v=E.x,R=E.y,P=E.z,y=T-v,C=T+v,L=x-R,O=x+R,M=A-P,U=A+P;y<c&&(c=y),C>f&&(f=C),L<d&&(d=L),O>u&&(u=O),M<p&&(p=M),U>_&&(_=U),t.x=(c+f)*.5,t.y=(d+u)*.5,t.z=(p+_)*.5,a.x=(f-c)*.5,a.y=(u-d)*.5,a.z=(_-p)*.5}copy(e){this.center.copy(e.center),this.halfExtents.copy(e.halfExtents)}clone(){return new o(this.center,this.halfExtents)}intersects(e){let t=this.getMax(),s=this.getMin(),i=e.getMax(),r=e.getMin();return s.x<=i.x&&t.x>=r.x&&s.y<=i.y&&t.y>=r.y&&s.z<=i.z&&t.z>=r.z}_intersectsRay(e,t){let s=hu.copy(this.getMin()).sub(e.origin),i=cu.copy(this.getMax()).sub(e.origin),r=e.direction;r.x===0?(s.x=s.x<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.x=i.x<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.x/=r.x,i.x/=r.x),r.y===0?(s.y=s.y<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.y=i.y<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.y/=r.y,i.y/=r.y),r.z===0?(s.z=s.z<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.z=i.z<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.z/=r.z,i.z/=r.z);let a=u1.set(Math.min(s.x,i.x),Math.min(s.y,i.y),Math.min(s.z,i.z)),n=m1.set(Math.max(s.x,i.x),Math.max(s.y,i.y),Math.max(s.z,i.z)),l=Math.min(Math.min(n.x,n.y),n.z),h=Math.max(Math.max(a.x,a.y),a.z),c=l>=h&&h>=0;return c&&t.copy(e.direction).mulScalar(h).add(e.origin),c}_fastIntersectsRay(e){let t=hu,s=cu,i=u1,r=m1,a=Bie,n=e.direction;return t.sub2(e.origin,this.center),r.set(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z)),i.mul2(t,n),!(r.x>this.halfExtents.x&&i.x>=0||r.y>this.halfExtents.y&&i.y>=0||r.z>this.halfExtents.z&&i.z>=0||(a.set(Math.abs(n.x),Math.abs(n.y),Math.abs(n.z)),s.cross(n,t),s.set(Math.abs(s.x),Math.abs(s.y),Math.abs(s.z)),s.x>this.halfExtents.y*a.z+this.halfExtents.z*a.y)||s.y>this.halfExtents.x*a.z+this.halfExtents.z*a.x||s.z>this.halfExtents.x*a.y+this.halfExtents.y*a.x)}intersectsRay(e,t){return t?this._intersectsRay(e,t):this._fastIntersectsRay(e)}setMinMax(e,t){this.center.add2(t,e).mulScalar(.5),this.halfExtents.sub2(t,e).mulScalar(.5)}getMin(){return this._min.copy(this.center).sub(this.halfExtents)}getMax(){return this._max.copy(this.center).add(this.halfExtents)}containsPoint(e){let t=this.getMin(),s=this.getMax();return!(e.x<t.x||e.x>s.x||e.y<t.y||e.y>s.y||e.z<t.z||e.z>s.z)}setFromTransformedAabb(e,t,s=!1){let i=e.center,r=e.halfExtents,a=t.data,n=a[0],l=a[4],h=a[8],c=a[1],f=a[5],d=a[9],u=a[2],p=a[6],_=a[10];if(s){let S=n*n+l*l+h*h;if(S>0){let T=1/Math.sqrt(S);n*=T,l*=T,h*=T}if(S=c*c+f*f+d*d,S>0){let T=1/Math.sqrt(S);c*=T,f*=T,d*=T}if(S=u*u+p*p+_*_,S>0){let T=1/Math.sqrt(S);u*=T,p*=T,_*=T}}this.center.set(a[12]+n*i.x+l*i.y+h*i.z,a[13]+c*i.x+f*i.y+d*i.z,a[14]+u*i.x+p*i.y+_*i.z),this.halfExtents.set(Math.abs(n)*r.x+Math.abs(l)*r.y+Math.abs(h)*r.z,Math.abs(c)*r.x+Math.abs(f)*r.y+Math.abs(d)*r.z,Math.abs(u)*r.x+Math.abs(p)*r.y+Math.abs(_)*r.z)}static computeMinMax(e,t,s,i=e.length/3){if(i>0){let r=e[0],a=e[1],n=e[2],l=r,h=a,c=n,f=i*3;for(let d=3;d<f;d+=3){let u=e[d],p=e[d+1],_=e[d+2];u<r&&(r=u),p<a&&(a=p),_<n&&(n=_),u>l&&(l=u),p>h&&(h=p),_>c&&(c=_)}t.set(r,a,n),s.set(l,h,c)}}compute(e,t){o.computeMinMax(e,hu,cu,t),this.setMinMax(hu,cu)}intersectsBoundingSphere(e){return this._distanceToBoundingSphereSq(e)<=e.radius*e.radius}_distanceToBoundingSphereSq(e){let t=this.getMin(),s=this.getMax(),i=0,r=["x","y","z"];for(let a=0;a<3;++a){let n=0,l=e.center[r[a]],h=t[r[a]],c=s[r[a]],f=0;l<h&&(f=h-l,n+=f*f),l>c&&(f=l-c,n+=f*f),i+=n}return i}_expand(e,t){hu.add2(this.getMin(),e),cu.add2(this.getMax(),t),this.setMinMax(hu,cu)}}});var ME,Vie,Hr,fu=m(()=>{Q();ME=new g,Vie=new g,Hr=class{constructor(e=new g,t=.5){this.center=e,this.radius=t}containsPoint(e){let t=ME.sub2(e,this.center).lengthSq(),s=this.radius;return t<s*s}intersectsRay(e,t){let s=ME.copy(e.origin).sub(this.center),i=s.dot(Vie.copy(e.direction).normalize()),r=s.dot(s)-this.radius*this.radius;if(r>0&&i>0)return!1;let a=i*i-r;if(a<0)return!1;let n=Math.abs(-i-Math.sqrt(a));return t&&t.copy(e.direction).mulScalar(n).add(e.origin),!0}intersectsBoundingSphere(e){ME.sub2(e.center,this.center);let t=e.radius+this.radius;return ME.lengthSq()<=t*t}}});var Rn,Zg=m(()=>{Q();Rn=class{constructor(e=g.UP,t=0){this.normal=new g,this.normal.copy(e),this.distance=t}clone(){let e=this.constructor;return new e().copy(this)}copy(e){return this.normal.copy(e.normal),this.distance=e.distance,this}intersectsLine(e,t,s){let i=this.distance,r=this.normal.dot(e)+i,a=this.normal.dot(t)+i,n=r/(r-a),l=n>=0&&n<=1;return l&&s&&s.lerp(e,t,n),l}intersectsRay(e,t){let s=this.normal.dot(e.direction);if(s===0)return!1;let i=-(this.normal.dot(e.origin)+this.distance)/s;return i>=0&&t&&t.copy(e.direction).mulScalar(i).add(e.origin),i>=0}normalize(){let e=1/this.normal.length();return this.normal.mulScalar(e),this.distance*=e,this}set(e,t,s,i){return this.normal.set(e,t,s),this.distance=i,this}setFromPointNormal(e,t){return this.normal.copy(t),this.distance=-this.normal.dot(e),this}}});var du,aI=m(()=>{Zg();du=class{constructor(){this.planes=[];for(let e=0;e<6;e++)this.planes[e]=new Rn}clone(){let e=this.constructor;return new e().copy(this)}copy(e){for(let t=0;t<6;t++)this.planes[t].copy(e.planes[t]);return this}setFromMat4(e){let[t,s,i,r,a,n,l,h,c,f,d,u,p,_,S,T]=e.data,x=this.planes;x[0].set(r-t,h-a,u-c,T-p).normalize(),x[1].set(r+t,h+a,u+c,T+p).normalize(),x[2].set(r+s,h+n,u+f,T+_).normalize(),x[3].set(r-s,h-n,u-f,T-_).normalize(),x[4].set(r-i,h-l,u-d,T-S).normalize(),x[5].set(r+i,h+l,u+d,T+S).normalize()}containsPoint(e){for(let t=0;t<6;t++){let{normal:s,distance:i}=this.planes[t];if(s.dot(e)+i<=0)return!1}return!0}containsSphere(e){let{center:t,radius:s}=e,i=0;for(let r=0;r<6;r++){let{normal:a,distance:n}=this.planes[r],l=a.dot(t)+n;if(l<=-s)return 0;l>s&&i++}return i===6?2:1}}});var Es,Ql=m(()=>{Q();Es=class{constructor(e,t){this.origin=new g,this.direction=g.FORWARD.clone(),e&&this.origin.copy(e),t&&this.direction.copy(t)}set(e,t){return this.origin.copy(e),this.direction.copy(t),this}copy(e){return this.set(e.origin,e.direction)}clone(){return new this.constructor(this.origin,this.direction)}}});var DE,p1,nI,kie,OE,_1=m(()=>{Ke();Q();Vt();fu();Ql();DE=new Es,p1=new g,nI=new Hr,kie=new k,OE=class{constructor(e=new k,t){this.halfExtents=new g(.5,.5,.5),t&&this.halfExtents.copy(t),this._modelTransform=e.clone().invert(),this._worldTransform=e.clone(),this._aabb=new _e(new g,this.halfExtents)}set worldTransform(e){this._worldTransform.copy(e),this._modelTransform.copy(e).invert()}get worldTransform(){return this._worldTransform}intersectsRay(e,t){if(this._modelTransform.transformPoint(e.origin,DE.origin),this._modelTransform.transformVector(e.direction,DE.direction),t){let s=this._aabb._intersectsRay(DE,t);return kie.copy(this._modelTransform).invert().transformPoint(t,t),s}return this._aabb._fastIntersectsRay(DE)}containsPoint(e){return this._modelTransform.transformPoint(e,p1),this._aabb.containsPoint(p1)}intersectsBoundingSphere(e){return this._modelTransform.transformPoint(e.center,nI.center),nI.radius=e.radius,!!this._aabb.intersectsBoundingSphere(nI)}}});var oI,lI,hI,cI,fI,g1,uu,dI=m(()=>{Q();oI=new g,lI=new g,hI=new g,cI=new g,fI=new g,g1=1e-6,uu=class{constructor(e=g.ZERO,t=g.ZERO,s=g.ZERO){this.v0=new g,this.v1=new g,this.v2=new g,this.set(e,t,s)}set(e,t,s){return this.v0.copy(e),this.v1.copy(t),this.v2.copy(s),this}intersectsRay(e,t){oI.sub2(this.v1,this.v0),lI.sub2(this.v2,this.v0),hI.cross(e.direction,lI);let s=oI.dot(hI);if(s>-1e-6&&s<g1)return!1;let i=1/s;cI.sub2(e.origin,this.v0);let r=i*cI.dot(hI);if(r<0||r>1)return!1;fI.cross(cI,oI);let a=i*e.direction.dot(fI);if(a<0||r+a>1)return!1;let n=i*lI.dot(fI);return n>g1?(t instanceof g&&t.copy(e.direction).mulScalar(n).add(e.origin),!0):!1}toString(){return`[${this.v0.toString()}, ${this.v1.toString()}, ${this.v2.toString()}]`}}});var je,Z,Xr,mu,Jt,NE,S1,Qg,FE,Cn,T1,In,E1,v1,Jg,eS,vs,x1,UE,BE,VE,pu,y1,A1,jc,uI,mI,pI,tS,kE,xs,Jl,sS,_u,Wr,Yr,wn,P1,R1,C1,I1,w1,L1,He,Ci,Oo,_I,fe,we,Vi,ki,Gi,is,gI,eh,th,iS,SI,TI,EI,zi,sh,ys,Js,GE,zE,$c,Zc,gu,Qc,ui,Re,Jc,Su,No,Tu,tt,HE,St,Hi,Kr,Ln,Ga,ih,kt,ef,Eu,vu,Fo,Uo,tf,sf,XE,WE,YE,xu,KE,qE,jE,$E,ZE,rf,QE,JE,ev,tv,sv,iv,rv,av,nv,yu,ov,Ii,Au,lv,rh,rS,hv,cv,fv,dv,uv,mv,Pu,pv,_v,gv,Sv,Bo,ei,Vo,ah,Xi,bn,Tv,Ev,Ru,qr,Mn,Cu,nh,As,rs,Wi,te,Pt,as,hs,Gt,nt,aS,ot,ks,jr,$r,Zr,Qr,Jr,ea,Iu,oh,af,nf,of,vI,xI,yI,ko,Go,AI,lf,hf,cf,ff,ta,wu,Dn,b1,vv,xv,M1,yv,D1,O1,Lu,bu,nS,zt,ti,zo,On,Nn,N1,F1,U1,B1,oS,Gs,Sr,Tr,df,Fn,cs,Er,si,vr,xr,Av,uf,lS,Pv,oe,le,Ps,zs,Rs,mi,ke,gt,pe,Ho,za,Yi,Ht,Ki,fs,qi,yr,Ar,Pr,Un,Bn,Vn,Xo,sa,pi,Rv,Cv,kn,Iv,wv,Lv,Gn,zn,lh,Mu,bv,ia,ra,aa,na,oa,Hn,Xn,la,Wn,Yn,ha,Kn,qn,Wo,hh,ch,Mv,Dv,Ov,Nv,Fv,Uv,Bv,Vv,hS,cS,fS,V1,fh,Du,dh,wi,Li,Ou,kv,mf,Gv,Nu,Fu,Uu,Bu,Vu,ku,Gu,zu,zv,Ha,ca,Rr,Hu,jn,uh,Xa,$n,k1,G1,Yo,Hv,Xu,Be,j=m(()=>{je=0,Z=1,Xr=2,mu=0,Jt=1,NE=2,S1=3,Qg=4,FE=5,Cn=6,T1=7,In=8,E1=9,v1=10,Jg=11,eS=12,vs=0,x1=1,UE=2,BE=3,VE=4,pu=1,y1=2,A1=4,jc=8,uI=16,mI=32,pI=64,tS=128,kE=256,xs=0,Jl=1,sS=2,_u=3,Wr=1,Yr=2,wn=4,P1=0,R1=1,C1=2,I1=3,w1=4,L1=5,He=0,Ci=1,Oo=2,_I=3,fe=0,we=1,Vi=2,ki=3,Gi=4,is=5,gI=0,eh=1,th=2,iS=3,SI=4,TI=5,EI=6,zi=7,sh=0,ys=1,Js=2,GE=0,zE=1,$c=2,Zc=3,gu=4,Qc=5,ui=6,Re=7,Jc=8,Su=9,No=10,Tu=11,tt=12,HE=13,St=14,Hi=15,Kr=16,Ln=17,Ga=18,ih=19,kt=20,ef=21,Eu=22,vu=23,Fo=24,Uo=25,tf=26,sf=27,XE=28,WE=29,YE=30,xu=31,KE=32,qE=33,jE=34,$E=35,ZE=36,rf=37,QE=38,JE=39,ev=40,tv=41,sv=42,iv=43,rv=44,av=45,nv=46,yu=47,ov=48,Ii=49,Au=50,lv=51,rh=52,rS=53,hv=54,cv=55,fv=56,dv=61,uv=62,mv=63,Pu=64,pv=65,_v=66,gv=67,Sv=68,Bo=69,ei=new Map([[0,{name:"A8",size:1,ldr:!0}],[52,{name:"R8",size:1,ldr:!0}],[1,{name:"L8",size:1,ldr:!0}],[2,{name:"LA8",size:2,ldr:!0}],[53,{name:"RG8",size:2,ldr:!0}],[3,{name:"RGB565",size:2,ldr:!0}],[4,{name:"RGBA5551",size:2,ldr:!0}],[5,{name:"RGBA4",size:2,ldr:!0}],[6,{name:"RGB8",size:4,ldr:!0}],[7,{name:"RGBA8",size:4,ldr:!0,srgbFormat:20}],[50,{name:"R16F",size:2}],[51,{name:"RG16F",size:4}],[11,{name:"RGB16F",size:8}],[12,{name:"RGBA16F",size:8}],[13,{name:"RGB32F",size:16}],[14,{name:"RGBA32F",size:16}],[15,{name:"R32F",size:4}],[16,{name:"DEPTH",size:4}],[69,{name:"DEPTH16",size:2}],[17,{name:"DEPTHSTENCIL",size:4}],[18,{name:"111110F",size:4}],[19,{name:"SRGB8",size:4,ldr:!0,srgb:!0}],[20,{name:"SRGBA8",size:4,ldr:!0,srgb:!0}],[31,{name:"BGRA8",size:4,ldr:!0}],[64,{name:"SBGRA8",size:4,ldr:!0,srgb:!0}],[8,{name:"DXT1",blockSize:8,ldr:!0,srgbFormat:54}],[9,{name:"DXT3",blockSize:16,ldr:!0,srgbFormat:55}],[10,{name:"DXT5",blockSize:16,ldr:!0,srgbFormat:56}],[21,{name:"ETC1",blockSize:8,ldr:!0}],[22,{name:"ETC2_RGB",blockSize:8,ldr:!0,srgbFormat:61}],[23,{name:"ETC2_RGBA",blockSize:16,ldr:!0,srgbFormat:62}],[24,{name:"PVRTC_2BPP_RGB_1",ldr:!0,blockSize:8}],[25,{name:"PVRTC_2BPP_RGBA_1",ldr:!0,blockSize:8}],[26,{name:"PVRTC_4BPP_RGB_1",ldr:!0,blockSize:8}],[27,{name:"PVRTC_4BPP_RGBA_1",ldr:!0,blockSize:8}],[28,{name:"ASTC_4x4",blockSize:16,ldr:!0,srgbFormat:63}],[29,{name:"ATC_RGB",blockSize:8,ldr:!0}],[30,{name:"ATC_RGBA",blockSize:16,ldr:!0}],[65,{name:"BC6H_RGBF",blockSize:16}],[66,{name:"BC6H_RGBUF",blockSize:16}],[67,{name:"BC7_RGBA",blockSize:16,ldr:!0,srgbFormat:68}],[54,{name:"DXT1_SRGB",blockSize:8,ldr:!0,srgb:!0}],[55,{name:"DXT3_SRGBA",blockSize:16,ldr:!0,srgb:!0}],[56,{name:"DXT5_SRGBA",blockSize:16,ldr:!0,srgb:!0}],[61,{name:"ETC2_SRGB",blockSize:8,ldr:!0,srgb:!0}],[62,{name:"ETC2_SRGBA",blockSize:16,ldr:!0,srgb:!0}],[63,{name:"ASTC_4x4_SRGB",blockSize:16,ldr:!0,srgb:!0}],[68,{name:"BC7_SRGBA",blockSize:16,ldr:!0,srgb:!0}],[32,{name:"R8I",size:1,isInt:!0}],[33,{name:"R8U",size:1,isInt:!0}],[34,{name:"R16I",size:2,isInt:!0}],[35,{name:"R16U",size:2,isInt:!0}],[36,{name:"R32I",size:4,isInt:!0}],[37,{name:"R32U",size:4,isInt:!0}],[38,{name:"RG8I",size:2,isInt:!0}],[39,{name:"RG8U",size:2,isInt:!0}],[40,{name:"RG16I",size:4,isInt:!0}],[41,{name:"RG16U",size:4,isInt:!0}],[42,{name:"RG32I",size:8,isInt:!0}],[43,{name:"RG32U",size:8,isInt:!0}],[44,{name:"RGBA8I",size:4,isInt:!0}],[45,{name:"RGBA8U",size:4,isInt:!0}],[46,{name:"RGBA16I",size:8,isInt:!0}],[47,{name:"RGBA16U",size:8,isInt:!0}],[48,{name:"RGBA32I",size:16,isInt:!0}],[49,{name:"RGBA32U",size:16,isInt:!0}]]),Vo=o=>ei.get(o)?.blockSize!==void 0,ah=o=>ei.get(o)?.srgb===!0,Xi=o=>ei.get(o)?.isInt===!0,bn=o=>ei.get(o)?.srgbFormat||o,Tv=o=>{for(let[e,t]of ei)if(t.srgbFormat===o)return e;return o},Ev=o=>{let e=ei.get(o);return!!(e?.ldr&&!e?.srgb)},Ru=o=>{switch(o){case 15:case 13:case 14:return Float32Array;case 36:case 42:case 48:return Int32Array;case 37:case 43:case 49:return Uint32Array;case 34:case 40:case 46:return Int16Array;case 53:case 35:case 41:case 47:case 3:case 4:case 5:case 50:case 51:case 11:case 12:return Uint16Array;case 32:case 38:case 44:return Int8Array;default:return Uint8Array}},qr=0,Mn=1,Cu=2,nh=3,As=4,rs=5,Wi=6,te="POSITION",Pt="NORMAL",as="TANGENT",hs="BLENDWEIGHT",Gt="BLENDINDICES",nt="COLOR",aS="TEXCOORD",ot="TEXCOORD0",ks="TEXCOORD1",jr="TEXCOORD2",$r="TEXCOORD3",Zr="TEXCOORD4",Qr="TEXCOORD5",Jr="TEXCOORD6",ea="TEXCOORD7",Iu="ATTR0",oh="ATTR1",af="ATTR2",nf="ATTR3",of="ATTR4",vI="ATTR5",xI="ATTR6",yI="ATTR7",ko="ATTR8",Go="ATTR9",AI="ATTR10",lf="ATTR11",hf="ATTR12",cf="ATTR13",ff="ATTR14",ta="ATTR15",wu=1,Dn=0,b1=1,vv=2,xv=3,M1=4,yv=5,D1=6,O1=7,Lu=0,bu=1,nS=2,zt="default",ti="rgbm",zo="rgbe",On="rgbp",Nn="swizzleGGGR",N1=0,F1=1,U1=2,B1=3,oS="1d",Gs="2d",Sr="2d-array",Tr="cube",df="cube-array",Fn="3d",cs=0,Er=1,si=2,vr=3,xr=4,Av="none",uf="cube",lS="equirect",Pv="octahedral",oe="glsl",le="wgsl",Ps=0,zs=1,Rs=2,mi=3,ke=4,gt=5,pe=6,Ho=7,za=0,Yi=1,Ht=2,Ki=3,fs=4,qi=5,yr=6,Ar=7,Pr=8,Un=9,Bn=10,Vn=11,Xo=12,sa=13,pi=14,Rv=15,Cv=16,kn=17,Iv=18,wv=19,Lv=20,Gn=21,zn=22,lh=23,Mu=24,bv=25,ia=26,ra=27,aa=28,na=29,oa=30,Hn=31,Xn=32,la=33,Wn=34,Yn=35,ha=36,Kn=37,qn=38,Wo=39,hh=40,ch=41,Mv=42,Dv=43,Ov=44,Nv=45,Fv=46,Uv=47,Bv=48,Vv=49,hS=["bool","int","float","vec2","vec3","vec4","ivec2","ivec3","ivec4","bvec2","bvec3","bvec4","mat2","mat3","mat4","sampler2D","samplerCube","","sampler2DShadow","samplerCubeShadow","sampler3D","","","","","sampler2DArray","uint","uvec2","uvec3","uvec4","","","","","","","","","","","","","isampler2D","usampler2D","isamplerCube","usamplerCube","isampler3D","usampler3D","isampler2DArray","usampler2DArray"],cS=[["bool"],["i32"],["f32"],["vec2f","vec2<f32>"],["vec3f","vec3<f32>"],["vec4f","vec4<f32>"],["vec2i","vec2<i32>"],["vec3i","vec3<i32>"],["vec4i","vec4<i32>"],["vec2<bool>"],["vec3<bool>"],["vec4<bool>"],["mat2x2f","mat2x2<f32>"],["mat3x3f","mat3x3<f32>"],["mat4x4f","mat4x4<f32>"],["texture_2d<f32>"],["texture_cube<f32>"],["array<f32>"],["texture_depth_2d"],["texture_depth_cube"],["texture_3d<f32>"],["array<vec2<f32>>"],["array<vec3<f32>>"],["array<vec4<f32>>"],["array<mat4x4<f32>>"],["texture_2d_array<f32>"],["u32"],["vec2u","vec2<u32>"],["vec3u","vec3<u32>"],["vec4u","vec4<u32>"],["array<i32>"],["array<u32>"],["array<bool>"],["array<vec2i>","array<vec2<i32>>"],["array<vec2u>","array<vec2<u32>>"],["array<vec2b>","array<vec2<bool>>"],["array<vec3i>","array<vec3<i32>>"],["array<vec3u>","array<vec3<u32>>"],["array<vec3b>","array<vec3<bool>>"],["array<vec4i>","array<vec4<i32>>"],["array<vec4u>","array<vec4<u32>>"],["array<vec4b>","array<vec4<bool>>"],["texture_2d<i32>"],["texture_2d<u32>"],["texture_cube<i32>"],["texture_cube<u32>"],["texture_3d<i32>"],["texture_3d<u32>"],["texture_2d_array<i32>"],["texture_2d_array<u32>"]],fS=new Map;cS.forEach((o,e)=>{o.forEach(t=>fS.set(t,e))});V1=new Uint8Array([ke,ke,pe,pe,pe,pe,ke,ke,ke,ke,ke,ke,pe,pe,pe,ke,ke,pe,ke,ke,ke,pe,pe,pe,pe,ke,gt,gt,gt,gt,ke,gt,ke,ke,gt,ke,ke,gt,ke,ke,gt,ke,ke,gt,ke,gt,ke,gt,ke,gt]),fh="webgl2",Du="webgpu",dh="null",wi=1,Li=2,Ou=4,kv="ldr",mf="ldr_srgb",Gv="hdr",Nu=1,Fu=2,Uu=4,Bu=8,Vu=16,ku=32,Gu=64,zu=128,zv=255,Ha=0,ca=1,Rr=2,Hu=["view","mesh","mesh_ub"],jn="default",uh="_unused_float_uniform",Xa=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Uint16Array],$n=[1,1,2,2,4,4,4,2],k1=["INT8","UINT8","INT16","UINT16","INT32","UINT32","FLOAT32","FLOAT16"],G1={Int8Array:Ps,Uint8Array:zs,Int16Array:Rs,Uint16Array:mi,Int32Array:ke,Uint32Array:gt,Float32Array:pe},Yo=[Uint8Array,Uint16Array,Uint32Array],Hv=[1,2,4],Xu=new Map([["float","f32"],["vec2","vec2f"],["vec3","vec3f"],["vec4","vec4f"],["int","i32"],["ivec2","vec2i"],["ivec3","vec3i"],["ivec4","vec4i"],["uint","u32"],["uvec2","vec2u"],["uvec3","vec3u"],["uvec4","vec4u"]]),Be={};Be[te]=0;Be[Pt]=1;Be[hs]=2;Be[Gt]=3;Be[nt]=4;Be[ot]=5;Be[ks]=6;Be[jr]=7;Be[$r]=8;Be[Zr]=9;Be[Qr]=10;Be[Jr]=11;Be[ea]=12;Be[as]=13;Be[Iu]=0;Be[oh]=1;Be[af]=2;Be[nf]=3;Be[of]=4;Be[vI]=5;Be[xI]=6;Be[yI]=7;Be[ko]=8;Be[Go]=9;Be[AI]=10;Be[lf]=11;Be[hf]=12;Be[cf]=13;Be[ff]=14;Be[ta]=15});var Gie,Wu,Wa,pf,Zn,dS,_i,mh=m(()=>{j();Gie=0,Wu=class{constructor(e,t){this.slot=-1,this.scopeId=null,this.name=e,this.visibility=t}},Wa=class extends Wu{},pf=class extends Wu{constructor(e,t,s=!1){super(e,t),this.format="",this.readOnly=s}},Zn=class extends Wu{constructor(e,t,s=Gs,i=cs,r=!0,a=null){super(e,t),this.textureDimension=s,this.sampleType=i,this.hasSampler=r,this.samplerName=a??`${e}_sampler`}},dS=class extends Wu{constructor(e,t=7,s=Gs,i=!0,r=!1){super(e,Ou),this.format=t,this.textureDimension=s,this.write=i,this.read=r}},_i=class{constructor(e,t){this.uniformBufferFormats=[],this.textureFormats=[],this.storageTextureFormats=[],this.storageBufferFormats=[],this.id=Gie++;let s=0;t.forEach(r=>{r.slot=s++,r instanceof Zn&&r.hasSampler&&s++,r instanceof Wa?this.uniformBufferFormats.push(r):r instanceof Zn?this.textureFormats.push(r):r instanceof dS?this.storageTextureFormats.push(r):r instanceof pf&&this.storageBufferFormats.push(r)}),this.device=e;let i=e.scope;this.bufferFormatsMap=new Map,this.uniformBufferFormats.forEach((r,a)=>this.bufferFormatsMap.set(r.name,a)),this.textureFormatsMap=new Map,this.textureFormats.forEach((r,a)=>{this.textureFormatsMap.set(r.name,a),r.scopeId=i.resolve(r.name)}),this.storageTextureFormatsMap=new Map,this.storageTextureFormats.forEach((r,a)=>{this.storageTextureFormatsMap.set(r.name,a),r.scopeId=i.resolve(r.name)}),this.storageBufferFormatsMap=new Map,this.storageBufferFormats.forEach((r,a)=>{this.storageBufferFormatsMap.set(r.name,a),r.scopeId=i.resolve(r.name)}),this.impl=e.createBindGroupFormatImpl(this)}destroy(){this.impl.destroy()}getTexture(e){let t=this.textureFormatsMap.get(e);return t!==void 0?this.textureFormats[t]:null}getStorageTexture(e){let t=this.storageTextureFormatsMap.get(e);return t!==void 0?this.storageTextureFormats[t]:null}loseContext(){}}});var st,bi=m(()=>{st=class{get(e,t){return this._cache.has(e)||(this._cache.set(e,t()),e.on("destroy",()=>{this.remove(e)}),e.on("devicelost",()=>{this._cache.get(e)?.loseContext?.(e)})),this._cache.get(e)}remove(e){this._cache.get(e)?.destroy?.(e),this._cache.delete(e)}constructor(){this._cache=new Map}}});var Cs,_f=m(()=>{j();Cs=class o{static calcLevelDimension(e,t){return Math.max(e>>t,1)}static calcMipLevelsCount(e,t,s=1){return 1+Math.floor(Math.log2(Math.max(e,t,s)))}static calcLevelGpuSize(e,t,s,i){let r=ei.get(i),a=ei.get(i)?.size??0;if(a>0)return e*t*s*a;let n=r.blockSize??0,l=Math.floor((e+3)/4),h=Math.floor((t+3)/4),c=Math.floor((s+3)/4);return(i===24||i===25)&&(l=Math.max(Math.floor(l/2),1)),l*h*c*n}static calcGpuSize(e,t,s,i,r,a){let n=0;for(;n+=o.calcLevelGpuSize(e,t,s,i),!(!r||e===1&&t===1&&s===1);)e=Math.max(e>>1,1),t=Math.max(t>>1,1),s=Math.max(s>>1,1);return n*(a?6:1)}}});var zie,q,Fe=m(()=>{me();j();_f();zie=0,q=class{constructor(e,t={}){this._gpuSize=0,this.id=zie++,this._invalid=!1,this._lockedLevel=-1,this._lockedMode=Lu,this.renderVersionDirty=0,this._storage=!1,this._numLevels=0,this.device=e,this.name=t.name??"",this._width=Math.floor(t.width??4),this._height=Math.floor(t.height??4),this._format=t.format??7,this._compressed=Vo(this._format),this._integerFormat=Xi(this._format),this._integerFormat&&(t.minFilter=0,t.magFilter=0),this._volume=t.volume??!1,this._depth=Math.floor(t.depth??1),this._arrayLength=Math.floor(t.arrayLength??0),this._storage=t.storage??!1,this._cubemap=t.cubemap??!1,this._flipY=t.flipY??!1,this._premultiplyAlpha=t.premultiplyAlpha??!1,this._mipmaps=t.mipmaps??!0,this._numLevelsRequested=t.numLevels,t.numLevels!==void 0&&(this._numLevels=t.numLevels),this._updateNumLevel(),this._minFilter=t.minFilter??5,this._magFilter=t.magFilter??1,this._anisotropy=t.anisotropy??1,this._addressU=t.addressU??0,this._addressV=t.addressV??0,this._addressW=t.addressW??0,this._compareOnRead=t.compareOnRead??!1,this._compareFunc=t.compareFunc??1,this._type=t.type??zt,this.projection=Av,this._cubemap?this.projection=uf:t.projection&&t.projection!==uf&&(this.projection=t.projection),this._levels=t.levels;let s=!!t.levels;this._levels||this._clearLevels(),this.recreateImpl(s),e.textures.push(this)}destroy(){let e=this.device;if(e){let t=e.textures.indexOf(this);t!==-1&&e.textures.splice(t,1),e.scope.removeValue(this),this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this._gpuSize),this._levels=null,this.device=null}}recreateImpl(e=!0){let{device:t}=this;this.impl?.destroy(t),this.impl=null,this.impl=t.createTextureImpl(this),this.dirtyAll(),e&&this.upload()}_clearLevels(){this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null]}resize(e,t,s=1){let i=this.device;this.adjustVramSizeTracking(i._vram,-this._gpuSize),this.impl.destroy(i),this._clearLevels(),this._width=Math.floor(e),this._height=Math.floor(t),this._depth=Math.floor(s),this._updateNumLevel(),this.impl=i.createTextureImpl(this),this.dirtyAll()}loseContext(){this.impl.loseContext(),this.dirtyAll()}adjustVramSizeTracking(e,t){e.tex+=t}propertyChanged(e){this.impl.propertyChanged(e),this.renderVersionDirty=this.device.renderVersion}_updateNumLevel(){let e=this.mipmaps?Cs.calcMipLevelsCount(this.width,this.height):1,t=this._numLevelsRequested;this._numLevels=Math.min(t??e,e),this._mipmaps=this._numLevels>1}get lockedMode(){return this._lockedMode}set minFilter(e){this._minFilter!==e&&(Xi(this._format)||(this._minFilter=e,this.propertyChanged(Nu)))}get minFilter(){return this._minFilter}set magFilter(e){this._magFilter!==e&&(Xi(this._format)||(this._magFilter=e,this.propertyChanged(Fu)))}get magFilter(){return this._magFilter}set addressU(e){this._addressU!==e&&(this._addressU=e,this.propertyChanged(Uu))}get addressU(){return this._addressU}set addressV(e){this._addressV!==e&&(this._addressV=e,this.propertyChanged(Bu))}get addressV(){return this._addressV}set addressW(e){this._volume&&e!==this._addressW&&(this._addressW=e,this.propertyChanged(Vu))}get addressW(){return this._addressW}set compareOnRead(e){this._compareOnRead!==e&&(this._compareOnRead=e,this.propertyChanged(ku))}get compareOnRead(){return this._compareOnRead}set compareFunc(e){this._compareFunc!==e&&(this._compareFunc=e,this.propertyChanged(Gu))}get compareFunc(){return this._compareFunc}set anisotropy(e){this._anisotropy!==e&&(this._anisotropy=e,this.propertyChanged(zu))}get anisotropy(){return this._anisotropy}set mipmaps(e){this._mipmaps!==e&&(this.device.isWebGPU||Xi(this._format)||(this._mipmaps=e),e&&(this._needsMipmapsUpload=!0))}get mipmaps(){return this._mipmaps}get numLevels(){return this._numLevels}get storage(){return this._storage}get width(){return this._width}get height(){return this._height}get depth(){return this._depth}get format(){return this._format}get cubemap(){return this._cubemap}get gpuSize(){let e=this.pot&&this._mipmaps&&!(this._compressed&&this._levels.length===1);return Cs.calcGpuSize(this._width,this._height,this._depth,this._format,e,this._cubemap)}get array(){return this._arrayLength>0}get arrayLength(){return this._arrayLength}get volume(){return this._volume}set type(e){this._type!==e&&(this._type=e,this.device._shadersDirty=!0)}get type(){return this._type}set srgb(e){let t=ah(this.format);if(e!==t)if(e){let s=bn(this.format);this._format!==s&&(this._format=s,this.recreateImpl(),this.device._shadersDirty=!0)}else{let s=Tv(this.format);this._format!==s&&(this._format=s,this.recreateImpl(),this.device._shadersDirty=!0)}}get srgb(){return ah(this.format)}set flipY(e){this._flipY!==e&&(this._flipY=e,this._needsUpload=!0)}get flipY(){return this._flipY}set premultiplyAlpha(e){this._premultiplyAlpha!==e&&(this._premultiplyAlpha=e,this._needsUpload=!0)}get premultiplyAlpha(){return this._premultiplyAlpha}get pot(){return w.powerOfTwo(this._width)&&w.powerOfTwo(this._height)}get encoding(){switch(this.type){case ti:return"rgbm";case zo:return"rgbe";case On:return"rgbp"}return Ev(this.format)?"srgb":"linear"}dirtyAll(){this._levelsUpdated=this._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0],this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,this._mipmapsUploaded=!1,this.propertyChanged(zv)}lock(e={}){e.level??=0,e.face??=0,e.mode??=nS,this._lockedMode=e.mode,this._lockedLevel=e.level;let t=this.cubemap?this._levels[e.face]:this._levels;if(t[e.level]===null){let s=Math.max(1,this._width>>e.level),i=Math.max(1,this._height>>e.level),r=Math.max(1,this._depth>>e.level),a=new ArrayBuffer(Cs.calcLevelGpuSize(s,i,r,this._format));t[e.level]=new(Ru(this._format))(a)}return t[e.level]}setSource(e,t=0){let s=!1,i,r;if(this._cubemap){if(e[0]){i=e[0].width||0,r=e[0].height||0;for(let a=0;a<6;a++){let n=e[a];if(!n||n.width!==i||n.height!==r||!this.device._isBrowserInterface(n)){s=!0;break}}}else s=!0;if(!s)for(let a=0;a<6;a++)this._levels[t][a]!==e[a]&&(this._levelsUpdated[t][a]=!0)}else this.device._isBrowserInterface(e)||(s=!0),s||(e!==this._levels[t]&&(this._levelsUpdated[t]=!0),e instanceof HTMLVideoElement?(i=e.videoWidth,r=e.videoHeight):(i=e.width,r=e.height));if(s)if(this._width=4,this._height=4,this._cubemap)for(let a=0;a<6;a++)this._levels[t][a]=null,this._levelsUpdated[t][a]=!0;else this._levels[t]=null,this._levelsUpdated[t]=!0;else t===0&&(this._width=i,this._height=r),this._levels[t]=e;(this._invalid!==s||!s)&&(this._invalid=s,this.upload())}getSource(e=0){return this._levels[e]}unlock(){this._lockedMode,Lu,this._lockedMode===nS&&this.upload(),this._lockedLevel=-1,this._lockedMode=Lu}upload(){this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,this.impl.uploadImmediate?.(this.device,this)}read(e,t,s,i,r={}){return this.impl.read?.(e,t,s,i,r)}write(e,t,s,i,r){return this.impl.write?.(e,t,s,i,r)}}});var Hie,PI,Xie,Qn,Xv=m(()=>{bi();Fe();Hie={white:[255,255,255,255],gray:[128,128,128,255],black:[0,0,0,255],normal:[128,128,255,255],pink:[255,128,255,255]},PI=class{destroy(){this.map.forEach(e=>{e.destroy()})}constructor(){this.map=new Map}},Xie=new st,Qn=(o,e)=>{let t=Xie.get(o,()=>new PI);if(!t.map.has(e)){let s=new q(o,{name:`built-in-texture-${e}`,width:1,height:1,format:7}),i=s.lock(),r=Hie[e];i.set(r),s.unlock(),t.map.set(e,s)}return t.map.get(e)}});var Wie,ph,ji,_h=m(()=>{j();Xv();Wie=0,ph=class{constructor(){this.offsets=[]}},ji=class{constructor(e,t,s){this.renderVersionUpdated=-1,this.uniformBufferOffsets=[],this.id=Wie++,this.device=e,this.format=t,this.dirty=!0,this.impl=e.createBindGroupImpl(this),this.textures=[],this.storageTextures=[],this.storageBuffers=[],this.uniformBuffers=[],this.defaultUniformBuffer=s,s&&this.setUniformBuffer(jn,s)}destroy(){this.impl.destroy(),this.impl=null,this.format=null,this.defaultUniformBuffer=null}setUniformBuffer(e,t){let s=this.format.bufferFormatsMap.get(e);this.uniformBuffers[s]!==t&&(this.uniformBuffers[s]=t,this.dirty=!0)}setStorageBuffer(e,t){let s=this.format.storageBufferFormatsMap.get(e);this.storageBuffers[s]!==t&&(this.storageBuffers[s]=t,this.dirty=!0)}setTexture(e,t){let s=this.format.textureFormatsMap.get(e);this.textures[s]!==t?(this.textures[s]=t,this.dirty=!0):this.renderVersionUpdated<t.renderVersionDirty&&(this.dirty=!0)}setStorageTexture(e,t){let s=this.format.storageTextureFormatsMap.get(e);this.storageTextures[s]!==t?(this.storageTextures[s]=t,this.dirty=!0):this.renderVersionUpdated<t.renderVersionDirty&&(this.dirty=!0)}updateUniformBuffers(){for(let e=0;e<this.uniformBuffers.length;e++)this.uniformBuffers[e].update()}update(){let{textureFormats:e,storageTextureFormats:t,storageBufferFormats:s}=this.format;for(let i=0;i<e.length;i++){let r=e[i],a=r.scopeId.value;a||(r.name==="uSceneDepthMap"&&(a=Qn(this.device,"white")),r.name==="uSceneColorMap"&&(a=Qn(this.device,"pink")),a||(a=Qn(this.device,"pink"))),this.setTexture(r.name,a)}for(let i=0;i<t.length;i++){let r=t[i],a=r.scopeId.value;this.setStorageTexture(r.name,a)}for(let i=0;i<s.length;i++){let r=s[i],a=r.scopeId.value;this.setStorageBuffer(r.name,a)}this.uniformBufferOffsets.length=this.uniformBuffers.length;for(let i=0;i<this.uniformBuffers.length;i++){let r=this.uniformBuffers[i];this.uniformBufferOffsets[i]=r.offset,this.renderVersionUpdated<r.renderVersionDirty&&(this.dirty=!0)}this.dirty&&(this.dirty=!1,this.renderVersionUpdated=this.device.renderVersion,this.impl.update(this))}}});var ut,RI=m(()=>{ut={set(o,e,t,s=1){return o&~(s<<t)|e<<t},get(o,e,t=1){return o>>e&t},all(o,e,t=1){let s=t<<e;return(o&s)===s},any(o,e,t=1){return(o&t<<e)!==0}}});var Wv,gh,z1,H1,X1,W1,Y1,K1,CI,q1,j1,$1,Z1,Yie,Kie,Ie,qt=m(()=>{RI();Wv=7,gh=15,z1=0,H1=3,X1=7,W1=11,Y1=14,K1=18,CI=22,q1=23,j1=24,$1=25,Z1=26,Yie=15,Kie=CI,Ie=class o{constructor(e=!1,t=0,s=1,i=0,r,a,n,l=!0,h=!0,c=!0,f=!0){this.target0=0,this.setColorBlend(t,s,i),this.setAlphaBlend(r??t,a??s,n??i),this.setColorWrite(l,h,c,f),this.blend=e}set blend(e){this.target0=ut.set(this.target0,e?1:0,Z1)}get blend(){return ut.all(this.target0,Z1)}setColorBlend(e,t,s){this.target0=ut.set(this.target0,e,z1,Wv),this.target0=ut.set(this.target0,t,H1,gh),this.target0=ut.set(this.target0,s,X1,gh)}setAlphaBlend(e,t,s){this.target0=ut.set(this.target0,e,W1,Wv),this.target0=ut.set(this.target0,t,Y1,gh),this.target0=ut.set(this.target0,s,K1,gh)}setColorWrite(e,t,s,i){this.redWrite=e,this.greenWrite=t,this.blueWrite=s,this.alphaWrite=i}get colorOp(){return ut.get(this.target0,z1,Wv)}get colorSrcFactor(){return ut.get(this.target0,H1,gh)}get colorDstFactor(){return ut.get(this.target0,X1,gh)}get alphaOp(){return ut.get(this.target0,W1,Wv)}get alphaSrcFactor(){return ut.get(this.target0,Y1,gh)}get alphaDstFactor(){return ut.get(this.target0,K1,gh)}set redWrite(e){this.target0=ut.set(this.target0,e?1:0,CI)}get redWrite(){return ut.all(this.target0,CI)}set greenWrite(e){this.target0=ut.set(this.target0,e?1:0,q1)}get greenWrite(){return ut.all(this.target0,q1)}set blueWrite(e){this.target0=ut.set(this.target0,e?1:0,j1)}get blueWrite(){return ut.all(this.target0,j1)}set alphaWrite(e){this.target0=ut.set(this.target0,e?1:0,$1)}get alphaWrite(){return ut.all(this.target0,$1)}get allWrite(){return ut.get(this.target0,Kie,Yie)}copy(e){return this.target0=e.target0,this}clone(){return new this.constructor().copy(this)}get key(){return this.target0}equals(e){return this.target0===e.target0}static{this.NOBLEND=Object.freeze(new o)}static{this.NOWRITE=Object.freeze(new o(void 0,void 0,void 0,void 0,void 0,void 0,void 0,!1,!1,!1,!1))}static{this.ALPHABLEND=Object.freeze(new o(!0,0,6,8))}static{this.ADDBLEND=Object.freeze(new o(!0,0,1,1))}}});var fa,Yu=m(()=>{fa=class{get(e){let t=this.map.get(e);return t===void 0&&(t=this.id++,this.map.set(e,t)),t}constructor(){this.map=new Map,this.id=0}}});var qie,Q1,J1,eN,$e,ii=m(()=>{RI();Yu();qie=new fa,Q1=7,J1=0,eN=3,$e=class o{constructor(e=3,t=!0){this.data=0,this._depthBias=0,this._depthBiasSlope=0,this.key=0,this.func=e,this.write=t}set test(e){this.func=e?3:7,this.updateKey()}get test(){return this.func!==7}set write(e){this.data=ut.set(this.data,e?1:0,eN),this.updateKey()}get write(){return ut.all(this.data,eN)}set func(e){this.data=ut.set(this.data,e,J1,Q1),this.updateKey()}get func(){return ut.get(this.data,J1,Q1)}set depthBias(e){this._depthBias=e,this.updateKey()}get depthBias(){return this._depthBias}set depthBiasSlope(e){this._depthBiasSlope=e,this.updateKey()}get depthBiasSlope(){return this._depthBiasSlope}copy(e){return this.data=e.data,this._depthBias=e._depthBias,this._depthBiasSlope=e._depthBiasSlope,this.key=e.key,this}clone(){return new this.constructor().copy(this)}updateKey(){let{data:e,_depthBias:t,_depthBiasSlope:s}=this,i=`${e}-${t}-${s}`;this.key=qie.get(i)}equals(e){return this.key===e.key}static{this.DEFAULT=Object.freeze(new o)}static{this.NODEPTH=Object.freeze(new o(7,!1))}static{this.WRITEDEPTH=Object.freeze(new o(7,!0))}}});var Ku,II=m(()=>{Ku=class{equals(e){return this.globalId===e.globalId&&this.revision===e.revision}copy(e){this.globalId=e.globalId,this.revision=e.revision}reset(){this.globalId=0,this.revision=0}constructor(){this.globalId=0,this.revision=0}}});var tN,Yv,sN=m(()=>{II();tN=0,Yv=class{constructor(){tN++,this.version=new Ku,this.version.globalId=tN}increment(){this.version.revision++}}});var qu,wI=m(()=>{sN();qu=class{constructor(e){this.name=e,this.value=null,this.versionObject=new Yv}toJSON(e){}setValue(e){this.value=e,this.versionObject.increment()}getValue(){return this.value}}});var ju,LI=m(()=>{wI();ju=class{constructor(e){this.name=e,this.variables=new Map}resolve(e){return this.variables.has(e)||this.variables.set(e,new qu(e)),this.variables.get(e)}removeValue(e){for(let t in this.variables){let s=this.variables[t];s.value===e&&(s.value=null)}}}});var jie,mt,$i=m(()=>{jie=0,mt=class{constructor(e,t,s,i){this.usage=0,this.usage=i?.usage??0,this.device=e,this.format=t,this.numVertices=s,this.id=jie++,this.impl=e.createVertexBufferImpl(this,t,i),this.numBytes=t.verticesByteSize?t.verticesByteSize:t.size*s,this.adjustVramSizeTracking(e._vram,this.numBytes);let r=i?.data;r?this.setData(r):this.storage=new ArrayBuffer(this.numBytes),this.device.buffers.push(this)}destroy(){let e=this.device,t=e.buffers.indexOf(this);t!==-1&&e.buffers.splice(t,1),this.impl.initialized&&(this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this.storage.byteLength))}adjustVramSizeTracking(e,t){e.vb+=t}loseContext(){this.impl.loseContext()}getFormat(){return this.format}getUsage(){return this.usage}getNumVertices(){return this.numVertices}lock(){return this.storage}unlock(){this.impl.unlock(this)}setData(e){return e.byteLength!==this.numBytes?!1:(this.storage=e,this.unlock(),!0)}}});function Is(o){if(o==null)return 0;let e=0;for(let t=0,s=o.length;t<s;t++)e=(e<<5)-e+o.charCodeAt(t),e|=0;return e}function $u(o){let t=2166136261;for(let s=0;s<o.length;s++)t^=o[s],t*=16777619;return t>>>0}var Ya=m(()=>{});var $ie,Zie,Qie,Tt,Cr=m(()=>{Ya();me();Yu();j();bi();$ie=new fa,Zie=[2,4,8,12,16],Qie=new st,Tt=class o{constructor(e,t,s){this.device=e,this._elements=[],this.hasUv0=!1,this.hasUv1=!1,this.hasColor=!1,this.hasTangents=!1,this.verticesByteSize=0,this.vertexCount=s,this.interleaved=s===void 0,this.instancing=!1,this.size=t.reduce((a,n)=>a+Math.ceil(n.components*$n[n.type]/4)*4,0);let i=0,r;for(let a=0,n=t.length;a<n;a++){let l=t[a];r=l.components*$n[l.type],s&&(i=w.roundUp(i,r));let h=l.asInt??!1,c=h?!1:l.normalize??!1,f={name:l.semantic,offset:s?i:l.hasOwnProperty("offset")?l.offset:i,stride:s?r:l.hasOwnProperty("stride")?l.stride:this.size,dataType:l.type,numComponents:l.components,normalize:c,size:r,asInt:h};this._elements.push(f),s?i+=r*s:i+=Math.ceil(r/4)*4,l.semantic===ot?this.hasUv0=!0:l.semantic===ks?this.hasUv1=!0:l.semantic===nt?this.hasColor=!0:l.semantic===as&&(this.hasTangents=!0)}s&&(this.verticesByteSize=i),this._evaluateHash()}get elements(){return this._elements}static getDefaultInstancingFormat(e){return Qie.get(e,()=>new o(e,[{semantic:lf,components:4,type:pe},{semantic:hf,components:4,type:pe},{semantic:ff,components:4,type:pe},{semantic:ta,components:4,type:pe}]))}static isElementValid(e,t){let s=t.components*$n[t.type];return!(e.isWebGPU&&!Zie.includes(s))}update(){this._evaluateHash()}_evaluateHash(){let e=[],t=[],s=this._elements.length;for(let r=0;r<s;r++){let{name:a,dataType:n,numComponents:l,normalize:h,offset:c,stride:f,size:d,asInt:u}=this._elements[r],p=a+n+l+h+u;e.push(p);let _=p+c+f+d;t.push(_)}e.sort();let i=e.join();this.batchingHash=Is(i),this.shaderProcessingHashString=i,this.renderingHashString=t.join("_"),this.renderingHash=$ie.get(this.renderingHashString)}}});var Jie,ws,gf=m(()=>{j();Yu();Jie=new fa,ws=class o{set func(e){this._func=e,this._dirty=!0}get func(){return this._func}set ref(e){this._ref=e,this._dirty=!0}get ref(){return this._ref}set fail(e){this._fail=e,this._dirty=!0}get fail(){return this._fail}set zfail(e){this._zfail=e,this._dirty=!0}get zfail(){return this._zfail}set zpass(e){this._zpass=e,this._dirty=!0}get zpass(){return this._zpass}set readMask(e){this._readMask=e,this._dirty=!0}get readMask(){return this._readMask}set writeMask(e){this._writeMask=e,this._dirty=!0}get writeMask(){return this._writeMask}constructor(e={}){this._dirty=!0,this._func=e.func??7,this._ref=e.ref??0,this._readMask=e.readMask??255,this._writeMask=e.writeMask??255,this._fail=e.fail??Dn,this._zfail=e.zfail??Dn,this._zpass=e.zpass??Dn,this._evalKey()}_evalKey(){let{_func:e,_ref:t,_fail:s,_zfail:i,_zpass:r,_readMask:a,_writeMask:n}=this,l=`${e},${t},${s},${i},${r},${a},${n}`;this._key=Jie.get(l),this._dirty=!1}get key(){return this._dirty&&this._evalKey(),this._key}copy(e){return this._func=e._func,this._ref=e._ref,this._readMask=e._readMask,this._writeMask=e._writeMask,this._fail=e._fail,this._zfail=e._zfail,this._zpass=e._zpass,this._dirty=e._dirty,this._key=e._key,this}clone(){return new this.constructor().copy(this)}static{this.DEFAULT=Object.freeze(new o)}}});var Qe,Zu=m(()=>{su();Pe();bt();Ne();De();j();qt();ii();LI();$i();Cr();gf();Qe=class o extends K{static{this.EVENT_RESIZE="resizecanvas"}constructor(e,t){super(),this.backBuffer=null,this.backBufferSize=new D,this.backBufferAntialias=!1,this.isWebGPU=!1,this.isWebGL2=!1,this.isHdr=!1,this.maxIndirectDrawCount=1024,this.maxColorAttachments=1,this.maxSamples=1,this.supportsCompute=!1,this.supportsStorageTextureRead=!1,this.renderTarget=null,this.shaders=[],this.textures=[],this.targets=new Set,this.renderVersion=0,this.insideRenderPass=!1,this.supportsUniformBuffers=!1,this.supportsClipDistances=!1,this.textureRG11B10Renderable=!1,this.textureFloatFilterable=!1,this.blendState=new Ie,this.depthState=new $e,this.stencilEnabled=!1,this.stencilFront=new ws,this.stencilBack=new ws,this.defaultClearOptions={color:[0,0,0,1],depth:1,stencil:0,flags:3},this.clientRect={width:0,height:0},this._shadersDirty=!1,this.capsDefines=new Map,this.mapsToClear=new Set,this.canvas=e,"setAttribute"in e&&e.setAttribute("data-engine",`PlayCanvas ${tu}`),this.initOptions={...t},this.initOptions.alpha??=!0,this.initOptions.depth??=!0,this.initOptions.stencil??=!0,this.initOptions.antialias??=!0,this.initOptions.powerPreference??="high-performance",this.initOptions.displayFormat??=kv,this._maxPixelRatio=ue.browser?Math.min(1,window.devicePixelRatio):1,this.buffers=[],this._vram={tex:0,vb:0,ib:0,ub:0,sb:0},this._shaderStats={vsCompiled:0,fsCompiled:0,linked:0,materialShaders:0,compileTime:0},this.initializeContextCaches(),this._drawCallsPerFrame=0,this._shaderSwitchesPerFrame=0,this._primsPerFrame=[];for(let s=qr;s<=Wi;s++)this._primsPerFrame[s]=0;this._renderTargetCreationTime=0,this.scope=new ju("Device"),this.textureBias=this.scope.resolve("textureBias"),this.textureBias.setValue(0)}postInit(){let e=new Tt(this,[{semantic:te,components:2,type:pe}]),t=new Float32Array([-1,-1,1,-1,-1,1,1,1]);this.quadVertexBuffer=new mt(this,e,4,{data:t})}initCapsDefines(){let{capsDefines:e}=this;e.clear(),this.textureFloatFilterable&&e.set("CAPS_TEXTURE_FLOAT_FILTERABLE",""),this.textureFloatRenderable&&e.set("CAPS_TEXTURE_FLOAT_RENDERABLE","")}destroy(){this.fire("destroy"),this.quadVertexBuffer?.destroy(),this.quadVertexBuffer=null,this.dynamicBuffers?.destroy(),this.dynamicBuffers=null,this.gpuProfiler?.destroy(),this.gpuProfiler=null}onDestroyShader(e){this.fire("destroy:shader",e);let t=this.shaders.indexOf(e);t!==-1&&this.shaders.splice(t,1)}postDestroy(){this.scope=null,this.canvas=null}loseContext(){this.contextLost=!0,this.backBufferSize.set(-1,-1);for(let e of this.textures)e.loseContext();for(let e of this.buffers)e.loseContext();for(let e of this.targets)e.loseContext();this.gpuProfiler?.loseContext()}restoreContext(){this.contextLost=!1,this.initializeRenderState(),this.initializeContextCaches();for(let e of this.buffers)e.unlock();this.gpuProfiler?.restoreContext?.()}toJSON(e){}initializeContextCaches(){this.vertexBuffers=[],this.shader=null,this.shaderValid=void 0,this.shaderAsyncCompile=!1,this.renderTarget=null}initializeRenderState(){this.blendState=new Ie,this.depthState=new $e,this.cullMode=1,this.vx=this.vy=this.vw=this.vh=0,this.sx=this.sy=this.sw=this.sh=0,this.blendColor=new N(0,0,0,0)}setStencilState(e,t){}setBlendState(e){}setBlendColor(e,t,s,i){}setDepthState(e){}setCullMode(e){}setRenderTarget(e){this.renderTarget=e}setVertexBuffer(e){e&&this.vertexBuffers.push(e)}clearVertexBuffer(){this.vertexBuffers.length=0}getIndirectDrawSlot(){return 0}get indirectDrawBuffer(){return null}getRenderTarget(){return this.renderTarget}initRenderTarget(e){e.initialized||(e.init(),this.targets.add(e))}draw(e,t,s,i,r=!0,a=!0){}_isBrowserInterface(e){return this._isImageBrowserInterface(e)||this._isImageCanvasInterface(e)||this._isImageVideoInterface(e)}_isImageBrowserInterface(e){return typeof ImageBitmap<"u"&&e instanceof ImageBitmap||typeof HTMLImageElement<"u"&&e instanceof HTMLImageElement}_isImageCanvasInterface(e){return typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement}_isImageVideoInterface(e){return typeof HTMLVideoElement<"u"&&e instanceof HTMLVideoElement}resizeCanvas(e,t){let s=Math.min(this._maxPixelRatio,ue.browser?window.devicePixelRatio:1),i=Math.floor(e*s),r=Math.floor(t*s);(i!==this.canvas.width||r!==this.canvas.height)&&this.setResolution(i,r)}setResolution(e,t){this.canvas.width=e,this.canvas.height=t,this.fire(o.EVENT_RESIZE,e,t)}update(){this.updateClientRect()}updateClientRect(){if(ue.worker)this.clientRect.width=this.canvas.width,this.clientRect.height=this.canvas.height;else{let e=this.canvas.getBoundingClientRect();this.clientRect.width=e.width,this.clientRect.height=e.height}}get width(){return this.canvas.width}get height(){return this.canvas.height}set fullscreen(e){}get fullscreen(){return!1}set maxPixelRatio(e){this._maxPixelRatio=e}get maxPixelRatio(){return this._maxPixelRatio}get deviceType(){return this._deviceType}startRenderPass(e){}endRenderPass(e){}startComputePass(e){}endComputePass(){}frameStart(){this.renderPassIndex=0,this.renderVersion++}frameEnd(){this.mapsToClear.forEach(e=>e.clear()),this.mapsToClear.clear()}computeDispatch(e,t="Unnamed"){}getRenderableHdrFormat(e=[18,12,14],t=!0,s=1){for(let i=0;i<e.length;i++){let r=e[i];switch(r){case 18:{if(this.textureRG11B10Renderable)return r;break}case 12:if(this.textureHalfFloatRenderable)return r;break;case 14:if(this.isWebGPU&&s>1)continue;if(this.textureFloatRenderable&&(!t||this.textureFloatFilterable))return r;break}}}validateAttributes(e,t,s){}}});var ere,xe,Rt=m(()=>{j();_f();ere=0,xe=class{constructor(e={}){this.id=ere++;let t=e.colorBuffer?.device??e.colorBuffers?.[0].device??e.depthBuffer?.device??e.graphicsDevice;this._device=t;let{maxSamples:s}=this._device;if(this._samples=Math.min(e.samples??1,s),t.isWebGPU&&(this._samples=this._samples>1?s:1),this._colorBuffer=e.colorBuffer,e.colorBuffer&&(this._colorBuffers=[e.colorBuffer]),this._depthBuffer=e.depthBuffer,this._face=e.face??0,this._depthBuffer){let i=this._depthBuffer._format;i===16||i===69?(this._depth=!0,this._stencil=!1):i===17?(this._depth=!0,this._stencil=!0):i===15&&this._depthBuffer.device.isWebGPU&&this._samples>1?(this._depth=!0,this._stencil=!1):(this._depth=!1,this._stencil=!1)}else this._depth=e.depth??!0,this._stencil=e.stencil??!1;e.colorBuffers&&(this._colorBuffers||(this._colorBuffers=[...e.colorBuffers],this._colorBuffer=e.colorBuffers[0])),this.autoResolve=e.autoResolve??!0,this.name=e.name,this.name||(this.name=this._colorBuffer?.name),this.name||(this.name=this._depthBuffer?.name),this.name||(this.name="Untitled"),this.flipY=e.flipY??!1,this._mipLevel=e.mipLevel??0,this._mipLevel>0&&this._depth&&(this._mipLevel=0),this._mipmaps=e.mipLevel===void 0,this.validateMrt(),this.impl=t.createRenderTargetImpl(this)}destroy(){let e=this._device;e&&(e.targets.delete(this),e.renderTarget===this&&e.setRenderTarget(null),this.destroyFrameBuffers())}destroyFrameBuffers(){let e=this._device;e&&this.impl.destroy(e)}destroyTextureBuffers(){this._depthBuffer?.destroy(),this._depthBuffer=null,this._colorBuffers?.forEach(e=>{e.destroy()}),this._colorBuffers=null,this._colorBuffer=null}resize(e,t){if(this.width!==e||this.height!==t){if(this.mipLevel>0)return;let s=this._device;this.destroyFrameBuffers(),s.renderTarget===this&&s.setRenderTarget(null),this._depthBuffer?.resize(e,t),this._colorBuffers?.forEach(i=>{i.resize(e,t)}),this.validateMrt(),this.impl=s.createRenderTargetImpl(this)}}validateMrt(){}init(){this.impl.init(this._device,this)}get initialized(){return this.impl.initialized}get device(){return this._device}loseContext(){this.impl.loseContext()}resolve(e=!0,t=!!this._depthBuffer){this._device&&this._samples>1&&this.impl.resolve(this._device,this,e,t)}copy(e,t,s){if(!this._device)if(e._device)this._device=e._device;else return!1;return this._device.copyRenderTarget(e,this,t,s)}get samples(){return this._samples}get depth(){return this._depth}get stencil(){return this._stencil}get colorBuffer(){return this._colorBuffer}getColorBuffer(e){return this._colorBuffers?.[e]}get depthBuffer(){return this._depthBuffer}get face(){return this._face}get mipLevel(){return this._mipLevel}get mipmaps(){return this._mipmaps}get width(){let e=this._colorBuffer?.width||this._depthBuffer?.width||this._device.width;return this._mipLevel>0&&(e=Cs.calcLevelDimension(e,this._mipLevel)),e}get height(){let e=this._colorBuffer?.height||this._depthBuffer?.height||this._device.height;return this._mipLevel>0&&(e=Cs.calcLevelDimension(e,this._mipLevel)),e}isColorBufferSrgb(e=0){if(this.device.backBuffer===this)return ah(this.device.backBufferFormat);let t=this.getColorBuffer(e);return t?ah(t.format):!1}}});var Kv,iN=m(()=>{Kv=class{update(e){this.destroy();let t=e.device,s=this.createDescriptor(t,e);this.bindGroup=t.wgpu.createBindGroup(s)}destroy(){this.bindGroup=null}createDescriptor(e,t){let s=[],i=t.format,r=t.format.uniformBufferFormats;t.uniformBuffers.forEach((c,f)=>{let d=r[f].slot,u=c.persistent?c.impl.buffer:c.allocation.gpuBuffer.buffer;s.push({binding:d,resource:{buffer:u,offset:0,size:c.format.byteSize}})});let a=t.format.textureFormats;t.textures.forEach((c,f)=>{let d=c.impl,u=i.textureFormats[f],p=a[f].slot,_=d.getView(e);if(s.push({binding:p,resource:_}),u.hasSampler){let S=d.getSampler(e,u.sampleType);s.push({binding:p+1,resource:S})}});let n=t.format.storageTextureFormats;t.storageTextures.forEach((c,f)=>{let d=c.impl,u=n[f].slot,p=d.getView(e);s.push({binding:u,resource:p})});let l=t.format.storageBufferFormats;return t.storageBuffers.forEach((c,f)=>{let d=c.impl.buffer,u=l[f].slot;s.push({binding:u,resource:{buffer:d}})}),{layout:t.format.impl.bindGroupLayout,entries:s}}}});var Qu,rN=m(()=>{j();Qu=class{static shaderStage(e){let t=0;return e&wi&&(t|=GPUShaderStage.VERTEX),e&Li&&(t|=GPUShaderStage.FRAGMENT),e&Ou&&(t|=GPUShaderStage.COMPUTE),t}}});var he,bI=m(()=>{he=[];he[0]="";he[1]="";he[2]="";he[52]="r8unorm";he[53]="rg8unorm";he[3]="";he[4]="";he[5]="";he[6]="rgba8unorm";he[7]="rgba8unorm";he[8]="bc1-rgba-unorm";he[9]="bc2-rgba-unorm";he[10]="bc3-rgba-unorm";he[11]="";he[12]="rgba16float";he[50]="r16float";he[51]="rg16float";he[13]="";he[14]="rgba32float";he[15]="r32float";he[16]="depth32float";he[69]="depth16unorm";he[17]="depth24plus-stencil8";he[18]="rg11b10ufloat";he[19]="";he[20]="rgba8unorm-srgb";he[21]="";he[22]="etc2-rgb8unorm";he[23]="etc2-rgba8unorm";he[24]="";he[25]="";he[26]="";he[27]="";he[28]="astc-4x4-unorm";he[29]="";he[30]="";he[31]="bgra8unorm";he[64]="bgra8unorm-srgb";he[32]="r8sint";he[33]="r8uint";he[34]="r16sint";he[35]="r16uint";he[36]="r32sint";he[37]="r32uint";he[38]="rg8sint";he[39]="rg8uint";he[40]="rg16sint";he[41]="rg16uint";he[42]="rg32sint";he[43]="rg32uint";he[44]="rgba8sint";he[45]="rgba8uint";he[46]="rgba16sint";he[47]="rgba16uint";he[48]="rgba32sint";he[49]="rgba32uint";he[65]="bc6h-rgb-float";he[66]="bc6h-rgb-ufloat";he[67]="bc7-rgba-unorm";he[54]="bc1-rgba-unorm-srgb";he[55]="bc2-rgba-unorm-srgb";he[56]="bc3-rgba-unorm-srgb";he[61]="etc2-rgb8unorm-srgb";he[62]="etc2-rgba8unorm-srgb";he[68]="bc7-rgba-unorm-srgb";he[63]="astc-4x4-unorm-srgb"});var Ju,em,tre,qv,aN=m(()=>{Yu();j();rN();bI();Ju=[];Ju[cs]="filtering";Ju[Er]="non-filtering";Ju[si]="comparison";Ju[vr]="comparison";Ju[xr]="comparison";em=[];em[cs]="float";em[Er]="unfilterable-float";em[si]="depth";em[vr]="sint";em[xr]="uint";tre=new fa,qv=class{constructor(e){let t=e.device,{key:s,desc:i}=this.createDescriptor(e);this.key=tre.get(s),this.bindGroupLayout=t.wgpu.createBindGroupLayout(i)}destroy(){this.bindGroupLayout=null}loseContext(){}createDescriptor(e){let t=[],s="";return e.uniformBufferFormats.forEach(r=>{let a=Qu.shaderStage(r.visibility);s+=`#${r.slot}U:${a}`,t.push({binding:r.slot,visibility:a,buffer:{type:"uniform",hasDynamicOffset:!0}})}),e.textureFormats.forEach(r=>{let a=Qu.shaderStage(r.visibility),n=r.sampleType,l=r.textureDimension,h=!1,c=em[n];if(s+=`#${r.slot}T:${a}-${c}-${l}-${h}`,t.push({binding:r.slot,visibility:a,texture:{sampleType:c,viewDimension:l,multisampled:h}}),r.hasSampler){let f=Ju[n];s+=`#${r.slot+1}S:${a}-${f}`,t.push({binding:r.slot+1,visibility:a,sampler:{type:f}})}}),e.storageTextureFormats.forEach(r=>{let{format:a,textureDimension:n}=r,{read:l,write:h}=r;s+=`#${r.slot}ST:${a}-${n}-${l?"r1":"r0"}-${h?"w1":"w0"}`,t.push({binding:r.slot,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:l?h?"read-write":"read-only":"write-only",format:he[a],viewDimension:n}})}),e.storageBufferFormats.forEach(r=>{let a=r.readOnly,n=Qu.shaderStage(r.visibility);s+=`#${r.slot}SB:${n}-${a?"ro":"rw"}`,t.push({binding:r.slot,visibility:n,buffer:{type:a?"read-only-storage":"storage"}})}),{key:s,desc:{entries:t}}}}});var Jn,uS=m(()=>{Jn=class{constructor(e=0){this.buffer=null,this.usageFlags=0,this.usageFlags=e}destroy(e){this.buffer&&(this.buffer.destroy(),this.buffer=null)}get initialized(){return!!this.buffer}loseContext(){}allocate(e,t){this.buffer=e.wgpu.createBuffer({size:t,usage:this.usageFlags})}unlock(e,t){let s=e.wgpu;if(!this.buffer){let n=t.byteLength+3&-4;this.usageFlags|=GPUBufferUsage.COPY_DST,this.allocate(e,n)}let i=t.byteOffset??0,r=new Uint8Array(t.buffer??t,i,t.byteLength),a=new Uint8Array(this.buffer.size);a.set(r),s.queue.writeBuffer(this.buffer,0,a,0,a.length)}read(e,t,s,i,r){return e.readStorageBuffer(this,t,s,i,r)}write(e,t,s,i,r){e.writeStorageBuffer(this,t,s,i,r)}clear(e,t,s){e.clearStorageBuffer(this,t,s)}}});var jv,nN=m(()=>{uS();jv=class extends Jn{constructor(e,t){super(16|(t?.storage?128:0)),this.format=null,this.format=e.format===1?"uint16":"uint32"}unlock(e){let t=e.device;super.unlock(t,e.storage)}}});var oN,lN=m(()=>{oN={equals(o,e){if(o.length!==e.length)return!1;for(let t=0;t<o.length;t++)if(o[t]!==e[t])return!1;return!0}}});var Ko,qo,$v,hN=m(()=>{j();Ko=[];Ko[Ps]="sint8";Ko[zs]="uint8";Ko[Rs]="sint16";Ko[mi]="uint16";Ko[ke]="sint32";Ko[gt]="uint32";Ko[pe]="float32";Ko[Ho]="float16";qo=[];qo[Ps]="snorm8";qo[zs]="unorm8";qo[Rs]="snorm16";qo[mi]="unorm16";qo[ke]="sint32";qo[gt]="uint32";qo[pe]="float32";qo[Ho]="float16";$v=class{get(e,t=null){let s=this.getKey(e,t),i=this.cache.get(s);return i||(i=this.create(e,t),this.cache.set(s,i)),i}getKey(e,t=null){return`${e?.renderingHashString}-${t?.renderingHashString}`}create(e,t){let s=[],i=r=>{let a=r.interleaved,n=r.instancing?"instance":"vertex",l=[],h=r.elements.length;for(let c=0;c<h;c++){let f=r.elements[c],d=Be[f.name],u=f.normalize?qo:Ko;l.push({shaderLocation:d,offset:a?f.offset:0,format:`${u[f.dataType]}${f.numComponents>1?`x${f.numComponents}`:""}`}),(!a||c===h-1)&&(s.push({attributes:l,arrayStride:f.stride,stepMode:n}),l=[])}};return e&&i(e),t&&i(t),s}constructor(){this.cache=new Map}}});var tm,MI=m(()=>{tm=class{constructor(e){this.device=e}getPipelineLayout(e){let t=[];e.forEach(r=>{t.push(r.bindGroupLayout)});let s={bindGroupLayouts:t};return this.device.wgpu.createPipelineLayout(s)}}});var sre,cN,Zv,DI,ire,sm,rre,OI,Qv,fN=m(()=>{Ya();lN();hN();MI();j();sre=["point-list","line-list",void 0,"line-strip","triangle-list","triangle-strip",void 0],cN=["add","subtract","reverse-subtract","min","max"],Zv=["zero","one","src","one-minus-src","dst","one-minus-dst","src-alpha","src-alpha-saturated","one-minus-src-alpha","dst-alpha","one-minus-dst-alpha","constant","one-minus-constant"],DI=["never","less","equal","less-equal","greater","not-equal","greater-equal","always"],ire=["none","back","front"],sm=["keep","zero","replace","increment-clamp","increment-wrap","decrement-clamp","decrement-wrap","invert"],rre=["","uint16","uint32"],OI=class{},Qv=class extends tm{constructor(e){super(e),this.lookupHashes=new Uint32Array(14),this.vertexBufferLayout=new $v,this.cache=new Map}get(e,t,s,i,r,a,n,l,h,c,f,d,u){let p=e.type;i&&p!==nh&&p!==rs&&(i=void 0);let _=this.lookupHashes;_[0]=p,_[1]=r.id,_[2]=c,_[3]=h.key,_[4]=l.key,_[5]=t?.renderingHash??0,_[6]=s?.renderingHash??0,_[7]=a.impl.key,_[8]=n[0]?.key??0,_[9]=n[1]?.key??0,_[10]=n[2]?.key??0,_[11]=f?d.key:0,_[12]=f?u.key:0,_[13]=i??0;let S=$u(_),T=this.cache.get(S);if(T)for(let R=0;R<T.length;R++){let P=T[R];if(oN.equals(P.hashes,_))return P.pipeline}let x=sre[p],A=this.getPipelineLayout(n),E=this.vertexBufferLayout.get(t,s),v=new OI;return v.hashes=new Uint32Array(_),v.pipeline=this.create(x,i,r,a,A,l,h,E,c,f,d,u),T?T.push(v):T=[v],this.cache.set(S,T),v.pipeline}getBlend(e){let t;return e.blend&&(t={color:{operation:cN[e.colorOp],srcFactor:Zv[e.colorSrcFactor],dstFactor:Zv[e.colorDstFactor]},alpha:{operation:cN[e.alphaOp],srcFactor:Zv[e.alphaSrcFactor],dstFactor:Zv[e.alphaDstFactor]}}),t}getDepthStencil(e,t,s,i,r,a){let n,{depth:l,stencil:h}=t;if(l||h){if(n={format:t.impl.depthAttachment.format},l){n.depthWriteEnabled=e.write,n.depthCompare=DI[e.func];let c=a==="triangle-list"||a==="triangle-strip";n.depthBias=c?e.depthBias:0,n.depthBiasSlopeScale=c?e.depthBiasSlope:0}else n.depthWriteEnabled=!1,n.depthCompare="always";h&&s&&(n.stencilReadMas=i.readMask,n.stencilWriteMask=i.writeMask,n.stencilFront={compare:DI[i.func],failOp:sm[i.fail],passOp:sm[i.zpass],depthFailOp:sm[i.zfail]},n.stencilBack={compare:DI[r.func],failOp:sm[r.fail],passOp:sm[r.zpass],depthFailOp:sm[r.zfail]})}return n}create(e,t,s,i,r,a,n,l,h,c,f,d){let u=this.device.wgpu,p=s.impl,_={vertex:{module:p.getVertexShaderModule(),entryPoint:p.vertexEntryPoint,buffers:l},primitive:{topology:e,frontFace:"ccw",cullMode:ire[h]},depthStencil:this.getDepthStencil(n,i,c,f,d,e),multisample:{count:i.samples},layout:r};t&&(_.primitive.stripIndexFormat=rre[t]),_.fragment={module:p.getFragmentShaderModule(),entryPoint:p.fragmentEntryPoint,targets:[]};let S=i.impl.colorAttachments;if(S.length>0){let x=0;a.redWrite&&(x|=GPUColorWrite.RED),a.greenWrite&&(x|=GPUColorWrite.GREEN),a.blueWrite&&(x|=GPUColorWrite.BLUE),a.alphaWrite&&(x|=GPUColorWrite.ALPHA);let A=this.getBlend(a);S.forEach(E=>{_.fragment.targets.push({format:E.format,writeMask:x,blend:A})})}return u.createRenderPipeline(_)}}});var Jv,dN=m(()=>{MI();Jv=class extends tm{get(e,t){let s=this.getPipelineLayout([t.impl]);return this.create(e,s)}create(e,t){let s=this.device.wgpu,i=e.impl,r={compute:{module:i.getComputeShaderModule(),entryPoint:i.computeEntryPoint},layout:t};return s.createComputePipeline(r)}}});var eo,mS=m(()=>{eo=class{incRefCount(){this._refCount++}decRefCount(){this._refCount--}get refCount(){return this._refCount}constructor(){this._refCount=0}}});var NI,ex,uN=m(()=>{mS();NI=class extends eo{constructor(e){super(),this.object=e,this.incRefCount()}},ex=class{destroy(){this.cache.forEach(e=>{e.object?.destroy()}),this.cache.clear()}clear(){this.cache.clear()}get(e){let t=this.cache.get(e);return t?(t.incRefCount(),t.object):null}set(e,t){this.cache.set(e,new NI(t))}release(e){let t=this.cache.get(e);t&&(t.decRefCount(),t.refCount===0&&(this.cache.delete(e),t.object?.destroy()))}constructor(){this.cache=new Map}}});var FI,are,Sf,UI=m(()=>{uN();bi();FI=class extends ex{loseContext(e){this.clear()}},are=new st,Sf=o=>are.get(o,()=>new FI)});var nre,BI,tx,sx,mN=m(()=>{Yu();UI();nre=new fa,BI=class{destroy(){this.multisampledBuffer?.destroy(),this.multisampledBuffer=null}},tx=class{constructor(e){this.depthTexture=null,this.depthTextureInternal=!1,this.multisampledDepthBuffer=null,this.format=e,this.hasStencil=e==="depth24plus-stencil8"}destroy(e){this.depthTextureInternal&&(this.depthTexture?.destroy(),this.depthTexture=null),this.multisampledDepthBuffer&&(this.multisampledDepthBuffer=null,Sf(e).release(this.multisampledDepthBufferKey))}},sx=class{constructor(e){this.initialized=!1,this.colorAttachments=[],this.depthAttachment=null,this.assignedColorTexture=null,this.renderPassDescriptor={},this.isBackbuffer=!1,this.renderTarget=e}destroy(e){this.initialized=!1,this.assignedColorTexture=null,this.colorAttachments.forEach(t=>{t.destroy()}),this.colorAttachments.length=0,this.depthAttachment?.destroy(e),this.depthAttachment=null}updateKey(){let t=`${this.renderTarget.samples}:${this.depthAttachment?this.depthAttachment.format:"nodepth"}`;this.colorAttachments.forEach(s=>{t+=`:${s.format}`}),this.key=nre.get(t)}assignColorTexture(e,t){this.assignedColorTexture=t;let s=t.createView({format:e.backBufferViewFormat}),i=this.renderPassDescriptor.colorAttachments[0];this.renderTarget.samples>1?i.resolveTarget=s:i.view=s,this.setColorAttachment(0,void 0,e.backBufferViewFormat),this.updateKey()}setColorAttachment(e,t,s){this.colorAttachments[e]||(this.colorAttachments[e]=new BI),t&&(this.colorAttachments[e].multisampledBuffer=t),s&&(this.colorAttachments[e].format=s)}init(e,t){let s=e.wgpu;this.initDepthStencil(e,s,t),t._colorBuffers&&t._colorBuffers.forEach((r,a)=>{this.setColorAttachment(a,void 0,r.impl.format)}),this.renderPassDescriptor.colorAttachments=[];let i=this.isBackbuffer?1:t._colorBuffers?.length??0;for(let r=0;r<i;++r){let a=this.initColor(e,s,t,r),n=r===0&&this.colorAttachments[0]?.format;(a.view||n)&&this.renderPassDescriptor.colorAttachments.push(a)}this.updateKey(),this.initialized=!0}initDepthStencil(e,t,s){let{samples:i,width:r,height:a,depth:n,depthBuffer:l}=s;if(n||l){let h;if(l)if(this.depthAttachment=new tx(l.impl.format),i>1){let c="depth24plus-stencil8";this.depthAttachment.format=c,this.depthAttachment.hasStencil=c==="depth24plus-stencil8";let f=`${l.id}:${r}:${a}:${i}:${c}`,d=Sf(e),u=d.get(f);if(!u){let p={size:[r,a,1],dimension:"2d",sampleCount:i,format:c,usage:GPUTextureUsage.RENDER_ATTACHMENT|(c!==l.impl.format?GPUTextureUsage.TEXTURE_BINDING:0)};u=t.createTexture(p),d.set(f,u)}this.depthAttachment.multisampledDepthBuffer=u,this.depthAttachment.multisampledDepthBufferKey=f,h=u.createView()}else{let c=l.impl.gpuTexture;this.depthAttachment.depthTexture=c,h=c.createView()}else{this.depthAttachment=new tx("depth24plus-stencil8");let c={size:[r,a,1],dimension:"2d",sampleCount:i,format:this.depthAttachment.format,usage:GPUTextureUsage.RENDER_ATTACHMENT};i>1?c.usage|=GPUTextureUsage.TEXTURE_BINDING:c.usage|=GPUTextureUsage.COPY_SRC;let f=t.createTexture(c);this.depthAttachment.depthTexture=f,this.depthAttachment.depthTextureInternal=!0,h=f.createView()}this.renderPassDescriptor.depthStencilAttachment={view:h}}}initColor(e,t,s,i){let r={},{samples:a,width:n,height:l,mipLevel:h}=s,c=s.getColorBuffer(i),f=null;if(c&&(c.cubemap?f=c.impl.createView({dimension:"2d",baseArrayLayer:s.face,arrayLayerCount:1,mipLevelCount:1,baseMipLevel:h}):f=c.impl.createView({mipLevelCount:1,baseMipLevel:h})),a>1){let d=this.isBackbuffer?e.backBufferViewFormat:c.impl.format,u={size:[n,l,1],dimension:"2d",sampleCount:a,format:d,usage:GPUTextureUsage.RENDER_ATTACHMENT},p=t.createTexture(u);this.setColorAttachment(i,p,u.format),r.view=p.createView(),r.resolveTarget=f}else r.view=f;return r}setupForRenderPass(e,t){let s=this.renderPassDescriptor.colorAttachments?.length??0;for(let r=0;r<s;++r){let a=this.renderPassDescriptor.colorAttachments[r],n=e.colorArrayOps[r],l=t.isColorBufferSrgb(r);a.clearValue=l?n.clearValueLinear:n.clearValue,a.loadOp=n.clear?"clear":"load",a.storeOp=n.store?"store":"discard"}let i=this.renderPassDescriptor.depthStencilAttachment;i&&(i.depthClearValue=e.depthStencilOps.clearDepthValue,i.depthLoadOp=e.depthStencilOps.clearDepth?"clear":"load",i.depthStoreOp=e.depthStencilOps.storeDepth?"store":"discard",i.depthReadOnly=!1,this.depthAttachment.hasStencil&&(i.stencilClearValue=e.depthStencilOps.clearStencilValue,i.stencilLoadOp=e.depthStencilOps.clearStencil?"clear":"load",i.stencilStoreOp=e.depthStencilOps.storeStencil?"store":"discard",i.stencilReadOnly=!1))}loseContext(){this.initialized=!1}resolve(e,t,s,i){}}});var ds,qe,Zi,Tf=m(()=>{me();j();ds=[];ds[Ht]=1;ds[Ki]=2;ds[fs]=3;ds[qi]=4;ds[Yi]=1;ds[yr]=2;ds[Ar]=3;ds[Pr]=4;ds[za]=1;ds[Un]=2;ds[Bn]=3;ds[Vn]=4;ds[Xo]=8;ds[sa]=12;ds[pi]=16;ds[ia]=1;ds[ra]=2;ds[aa]=3;ds[na]=4;qe=class{get isArrayType(){return this.count>0}constructor(e,t,s=0){if(this.shortName=e,this.name=s?`${e}[0]`:e,this.type=t,this.numComponents=ds[t],this.updateType=t,s>0)switch(t){case Ht:this.updateType=kn;break;case Yi:this.updateType=oa;break;case ia:this.updateType=Hn;break;case za:this.updateType=Xn;break;case Ki:this.updateType=Gn;break;case yr:this.updateType=la;break;case ra:this.updateType=Wn;break;case Un:this.updateType=Yn;break;case fs:this.updateType=zn;break;case Ar:this.updateType=ha;break;case aa:this.updateType=Kn;break;case Bn:this.updateType=qn;break;case qi:this.updateType=lh;break;case Pr:this.updateType=Wo;break;case na:this.updateType=hh;break;case Vn:this.updateType=ch;break;case pi:this.updateType=Mu;break}this.count=s;let i=this.numComponents;s&&(i=w.roundUp(i,4)),this.byteSize=i*4,s&&(this.byteSize*=s)}calculateOffset(e){let t=this.byteSize<=8?this.byteSize:16;this.count&&(t=16),e=w.roundUp(e,t),this.offset=e/4}},Zi=class{constructor(e,t){this.byteSize=0,this.map=new Map,this.scope=e.scope,this.uniforms=t;let s=0;for(let i=0;i<t.length;i++){let r=t[i];r.calculateOffset(s),s=r.offset*4+r.byteSize,r.scopeId=this.scope.resolve(r.name),this.map.set(r.name,r)}this.byteSize=w.roundUp(s,16)}get(e){return this.map.get(e)}}});var pN,VI,kI,ore,lre,hre,cre,fre,GI,ix,_N=m(()=>{j();Tf();mh();pN=/[ \t]*(\battribute\b|\bvarying\b|\buniform\b)/g,VI=/(\battribute\b|\bvarying\b|\bout\b|\buniform\b)[ \t]*([^;]+)(;+)/g,kI="@@@",ore=/([\w-]+)\[(.*?)\]/,lre=new Set(["highp","mediump","lowp"]),hre=new Set(["sampler2DShadow","samplerCubeShadow","sampler2DArrayShadow"]),cre={sampler2D:Gs,sampler3D:Fn,samplerCube:Tr,samplerCubeShadow:Tr,sampler2DShadow:Gs,sampler2DArray:Sr,sampler2DArrayShadow:Sr,isampler2D:Gs,usampler2D:Gs,isampler3D:Fn,usampler3D:Fn,isamplerCube:Tr,usamplerCube:Tr,isampler2DArray:Sr,usampler2DArray:Sr},fre={[Gs]:"texture2D",[Tr]:"textureCube",[Fn]:"texture3D",[Sr]:"texture2DArray"},GI=class{constructor(e,t){this.line=e;let s=e.trim().split(/\s+/);if(lre.has(s[0])&&(this.precision=s.shift()),this.type=s.shift(),e.includes(","),e.includes("[")){let i=s.join(" "),r=ore.exec(i);this.name=r[1],this.arraySize=Number(r[2]),isNaN(this.arraySize)&&(t.failed=!0)}else this.name=s.shift(),this.arraySize=0;this.isSampler=this.type.indexOf("sampler")!==-1,this.isSignedInt=this.type.indexOf("isampler")!==-1,this.isUnsignedInt=this.type.indexOf("usampler")!==-1}},ix=class o{static run(e,t,s){let i=new Map,r=o.extract(t.vshader),a=o.extract(t.fshader),n=new Map,l=o.processAttributes(r.attributes,t.attributes,n,t.processingOptions),h=o.processVaryings(r.varyings,i,!0),c=o.processVaryings(a.varyings,i,!1),f=o.processOuts(a.outs),d=r.uniforms.concat(a.uniforms),p=Array.from(new Set(d)).map(E=>new GI(E,s)),_=o.processUniforms(e,p,t.processingOptions,s),S=`${l}
${h}
${_.code}`,T=r.src.replace(kI,S),x=`${c}
${f}
${_.code}`,A=a.src.replace(kI,x);return{vshader:T,fshader:A,attributes:n,meshUniformBufferFormat:_.meshUniformBufferFormat,meshBindGroupFormat:_.meshBindGroupFormat}}static extract(e){let t=[],s=[],i=[],r=[],a=`${kI}
`,n;for(;(n=pN.exec(e))!==null;){let l=n[1];switch(l){case"attribute":case"varying":case"uniform":case"out":{VI.lastIndex=n.index;let h=VI.exec(e);l==="attribute"?t.push(h[2]):l==="varying"?s.push(h[2]):l==="out"?i.push(h[2]):l==="uniform"&&r.push(h[2]),e=o.cutOut(e,n.index,VI.lastIndex,a),pN.lastIndex=n.index+a.length,a="";break}}}return{src:e,attributes:t,varyings:s,outs:i,uniforms:r}}static processUniforms(e,t,s,i){let r=[],a=[];t.forEach(d=>{d.isSampler?r.push(d):a.push(d)});let n=[];a.forEach(d=>{if(!s.hasUniform(d.name)){let u=hS.indexOf(d.type),p=new qe(d.name,u,d.arraySize);n.push(p)}}),n.length===0&&n.push(new qe(uh,Ht));let l=n.length?new Zi(e,n):null,h=[];r.forEach(d=>{if(!s.hasTexture(d.name)){let u=cs;d.isSignedInt?u=vr:d.isUnsignedInt?u=xr:(d.precision==="highp"&&(u=Er),hre.has(d.type)&&(u=si));let p=cre[d.type];h.push(new Zn(d.name,wi|Li,p,u))}});let c=new _i(e,h),f="";return s.uniformFormats.forEach((d,u)=>{d&&(f+=o.getUniformShaderDeclaration(d,u,0))}),l&&(f+=o.getUniformShaderDeclaration(l,Rr,0)),s.bindGroupFormats.forEach((d,u)=>{d&&(f+=o.getTexturesShaderDeclaration(d,u))}),f+=o.getTexturesShaderDeclaration(c,ca),{code:f,meshUniformBufferFormat:l,meshBindGroupFormat:c}}static processVaryings(e,t,s){let i="",r=s?"out":"in";return e.forEach((a,n)=>{let l=o.splitToWords(a),h=l.slice(0,-1).join(" "),c=l[l.length-1];s?t.set(c,n):n=t.get(c),i+=`layout(location = ${n}) ${r} ${h} ${c};
`}),i}static processOuts(e){let t="";return e.forEach((s,i)=>{t+=`layout(location = ${i}) out ${s};
`}),t}static getTypeCount(e){let t=e.substring(e.length-1),s=parseInt(t,10);return isNaN(s)?1:s}static processAttributes(e,t,s,i){let r="";return e.forEach(a=>{let n=o.splitToWords(a),l=n[0],h=n[1];if(t.hasOwnProperty(h)){let c=t[h],f=Be[c];s.set(f,h);let d,u=i.getVertexElement(c);if(u){let p=u.dataType;if(p!==pe&&p!==Ho&&!u.normalize&&!u.asInt){let _=o.getTypeCount(l),S=`_private_${h}`;d=`vec${_} ${h} = vec${_}(${S});
`,h=S;let T=p===Ps||p===Rs||p===ke;_===1?l=T?"int":"uint":l=T?`ivec${_}`:`uvec${_}`}}r+=`layout(location = ${f}) in ${l} ${h};
`,d&&(r+=d)}}),r}static splitToWords(e){return e=e.replace(/\s+/g," ").trim(),e.split(" ")}static cutOut(e,t,s,i){return e.substring(0,t)+i+e.substring(s)}static getUniformShaderDeclaration(e,t,s){let i=Hu[t],r=`layout(set = ${t}, binding = ${s}, std140) uniform ub_${i} {
`;return e.uniforms.forEach(a=>{let n=hS[a.type];r+=`    ${n} ${a.shortName}${a.count?`[${a.count}]`:""};
`}),`${r}};
`}static getTexturesShaderDeclaration(e,t){let s="";return e.textureFormats.forEach(i=>{let r=fre[i.textureDimension],a=r==="texture2DArray",n=i.sampleType===xr?"u":i.sampleType===vr?"i":"";r=`${n}${r}`;let l="",h="";a&&(l="_texture",h=`#define ${i.name} ${n}sampler2DArray(${i.name}${l}, ${i.name}_sampler)
`),s+=`layout(set = ${t}, binding = ${i.slot}) uniform ${r} ${i.name}${l};
`,i.hasSampler&&(s+=`layout(set = ${t}, binding = ${i.slot+1}) uniform sampler ${i.name}_sampler;
`),s+=h}),s}}});var gN,zI,HI,dre,XI,ure,mre,pre,_re,SN,TN,gre,WI,Sre,Tre,Ere,vre,xre,rx,ax,EN=m(()=>{j();Tf();mh();gN=/^[ \t]*(attribute|varying|uniform)[\t ]+/gm,zI=/^[ \t]*(attribute|varying|uniform)[ \t]*([^;]+)(;+)/gm,HI=/^[ \t]*var\s*(?:(<storage,[^>]*>)\s*([\w\d_]+)\s*:\s*(.*?)\s*;|(<(?!storage,)[^>]*>)?\s*([\w\d_]+)\s*:\s*(texture_.*|storage_texture_.*|storage\w.*|external_texture|sampler(?:_comparison)?)\s*;)\s*$/gm,dre=/(?:@interpolate\([^)]*\)\s*)?([\w]+)\s*:/,XI="@@@",ure=/(@vertex|@fragment)\s*fn\s+\w+\s*\(\s*(\w+)\s*:[\s\S]*?\{/,mre={texture_1d:{viewDimension:oS,baseSampleType:cs},texture_2d:{viewDimension:Gs,baseSampleType:cs},texture_2d_array:{viewDimension:Sr,baseSampleType:cs},texture_3d:{viewDimension:Fn,baseSampleType:cs},texture_cube:{viewDimension:Tr,baseSampleType:cs},texture_cube_array:{viewDimension:df,baseSampleType:cs},texture_multisampled_2d:{viewDimension:Gs,baseSampleType:cs},texture_depth_2d:{viewDimension:Gs,baseSampleType:si},texture_depth_2d_array:{viewDimension:Sr,baseSampleType:si},texture_depth_cube:{viewDimension:Tr,baseSampleType:si},texture_depth_cube_array:{viewDimension:df,baseSampleType:si},texture_external:{viewDimension:Gs,baseSampleType:Er}},pre=(o,e)=>{let t=mre[o],s=t.baseSampleType;if(t.baseSampleType===cs&&o!=="texture_multisampled_2d")switch(e){case"u32":s=xr;break;case"i32":s=vr;break;case"f32":s=cs;break;case"uff":s=Er;break}return{viewDimension:t.viewDimension,sampleType:s}},_re=(o,e)=>{if(e===si)switch(o){case Gs:return"texture_depth_2d";case Sr:return"texture_depth_2d_array";case Tr:return"texture_depth_cube";case df:return"texture_depth_cube_array"}let t;switch(o){case oS:t="texture_1d";break;case Gs:t="texture_2d";break;case Sr:t="texture_2d_array";break;case Fn:t="texture_3d";break;case Tr:t="texture_cube";break;case df:t="texture_cube_array";break}let s;switch(e){case cs:case Er:s="f32";break;case xr:s="u32";break;case vr:s="i32";break}return`${t}<${s}>`},SN={f32:"WrappedF32",i32:"WrappedI32",u32:"WrappedU32",vec2f:"WrappedVec2F",vec2i:"WrappedVec2I",vec2u:"WrappedVec2U"},TN=o=>(o=o.replace(/\s+/g," ").trim(),o.split(/[\s:]+/)),gre=/array<([^,]+),\s*([^>]+)>/,WI=class{constructor(e,t){this.ubName=null,this.arraySize=0,this.line=e;let s=TN(e);if(s.length<2){t.failed=!0;return}if(this.name=s[0],this.type=s.slice(1).join(" "),this.type.includes("array<")){let i=gre.exec(this.type);this.type=i[1].trim(),this.arraySize=Number(i[2]),isNaN(this.arraySize)&&(t.failed=!0)}}},Sre=/^\s*var\s+(\w+)\s*:\s*(texture_\w+)(?:<(\w+)>)?;\s*$/,Tre=/^\s*var\s+([\w\d_]+)\s*:\s*(texture_storage_2d|texture_storage_2d_array)<([\w\d_]+),\s*(\w+)>\s*;\s*$/,Ere=/^\s*var\s*<storage,\s*(read|write)?>\s*([\w\d_]+)\s*:\s*(.*)\s*;\s*$/,vre=/^\s*var\s+([\w\d_]+)\s*:\s*texture_external;\s*$/,xre=/^\s*var\s+([\w\d_]+)\s*:\s*(sampler|sampler_comparison)\s*;\s*$/,rx=class{constructor(e,t){this.originalLine=e,this.line=e,this.isTexture=!1,this.isSampler=!1,this.isStorageTexture=!1,this.isStorageBuffer=!1,this.isExternalTexture=!1,this.type="",this.matchedElements=[];let s=this.line.match(Sre);if(s){this.name=s[1],this.type=s[2],this.textureFormat=s[3],this.isTexture=!0,this.matchedElements.push(...s);let l=pre(this.type,this.textureFormat);this.textureDimension=l.viewDimension,this.sampleType=l.sampleType}let i=this.line.match(Tre);i&&(this.isStorageTexture=!0,this.name=i[1],this.textureType=i[2],this.format=i[3],this.access=i[4],this.matchedElements.push(...i));let r=this.line.match(Ere);r&&(this.isStorageBuffer=!0,this.accessMode=r[1]||"none",this.name=r[2],this.type=r[3],this.matchedElements.push(...r));let a=this.line.match(vre);a&&(this.name=a[1],this.isExternalTexture=!0,this.matchedElements.push(...r));let n=this.line.match(xre);n&&(this.name=n[1],this.samplerType=n[2],this.isSampler=!0,this.matchedElements.push(...n)),this.matchedElements.length===0&&(t.failed=!0)}equals(e){return!(this.name!==e.name||this.type!==e.type||this.isTexture!==e.isTexture||this.isSampler!==e.isSampler||this.isStorageTexture!==e.isStorageTexture||this.isStorageBuffer!==e.isStorageBuffer||this.isExternalTexture!==e.isExternalTexture||this.textureFormat!==e.textureFormat||this.textureDimension!==e.textureDimension||this.sampleType!==e.sampleType||this.textureType!==e.textureType||this.format!==e.format||this.access!==e.access||this.accessMode!==e.accessMode||this.samplerType!==e.samplerType)}},ax=class o{static run(e,t,s){let i=new Map,r=o.extract(t.vshader),a=o.extract(t.fshader),n=new Map,l=o.processAttributes(r.attributes,t.attributes,n,t.processingOptions,s),h=o.processVaryings(r.varyings,i,!0),c=o.processVaryings(a.varyings,i,!1),f=r.uniforms.concat(a.uniforms),u=Array.from(new Set(f)).map(R=>new WI(R,s)),p=o.processUniforms(e,u,t.processingOptions,s);r.src=o.renameUniformAccess(r.src,u),a.src=o.renameUniformAccess(a.src,u);let _=o.mergeResources(r.resources,a.resources,s),S=o.processResources(e,_,t.processingOptions,s),T=o.generateFragmentOutputStruct(a.src,e.maxColorAttachments);r.src=o.copyInputs(r.src,s),a.src=o.copyInputs(a.src,s);let x=`${l}
${h}
${p.code}
${S.code}
`,A=r.src.replace(XI,x),E=`${c}
${T}
${p.code}
${S.code}
`,v=a.src.replace(XI,E);return{vshader:A,fshader:v,attributes:n,meshUniformBufferFormat:p.meshUniformBufferFormat,meshBindGroupFormat:S.meshBindGroupFormat}}static extract(e){let t=[],s=[],i=[],r=[],a=`${XI}
`,n;for(;(n=gN.exec(e))!==null;){let l=n[1];zI.lastIndex=n.index;let h=zI.exec(e);l==="attribute"?t.push(h[2]):l==="varying"?s.push(h[2]):l==="uniform"&&i.push(h[2]),e=o.cutOut(e,n.index,zI.lastIndex,a),gN.lastIndex=n.index+a.length,a=""}for(;(n=HI.exec(e))!==null;)r.push(n[0]),e=o.cutOut(e,n.index,HI.lastIndex,a),HI.lastIndex=n.index+a.length,a="";return{src:e,attributes:t,varyings:s,uniforms:i,resources:r}}static processUniforms(e,t,s,i){let r=[];t.forEach(l=>{if(s.hasUniform(l.name))l.ubName="ub_view";else{l.ubName="ub_mesh_ub";let h=fS.get(l.type),c=new qe(l.name,h,l.arraySize);r.push(c)}}),r.length===0&&r.push(new qe(uh,Ht));let a=new Zi(e,r),n="";return s.uniformFormats.forEach((l,h)=>{l&&(n+=o.getUniformShaderDeclaration(l,h,0))}),a&&(n+=o.getUniformShaderDeclaration(a,Rr,0)),{code:n,meshUniformBufferFormat:a}}static renameUniformAccess(e,t){return t.forEach(s=>{let i=`uniform.${s.name}`,r=`${s.ubName}.${s.name}`,a=new RegExp(`\\b${i}\\b`,"g");e=e.replace(a,r)}),e}static mergeResources(e,t,s){let i=e.map(a=>new rx(a,s));return t.map(a=>new rx(a,s)).forEach(a=>{let n=i.find(l=>l.name===a.name);n?n.equals(a)||(s.failed=!0):i.push(a)}),i}static processResources(e,t,s,i){let r=[];for(let l=0;l<t.length;l++){let h=t[l];if(h.isTexture){let c=t[l+1],f=c?.isSampler,d=h.sampleType,u=h.textureDimension;r.push(new Zn(h.name,wi|Li,u,d,f,f?c.name:null)),f&&l++}if(h.isStorageBuffer){let c=h.accessMode!=="read_write",f=new pf(h.name,wi|Li,c);f.format=h.type,r.push(f)}}let a=new _i(e,r),n="";return s.bindGroupFormats.forEach((l,h)=>{l&&(n+=o.getTextureShaderDeclaration(l,h,1))}),n+=o.getTextureShaderDeclaration(a,ca,0),{code:n,meshBindGroupFormat:a}}static getUniformShaderDeclaration(e,t,s){let i=Hu[t],r=`struct_ub_${i}`,a=`struct ${r} {
`;return e.uniforms.forEach(n=>{let l=cS[n.type][0];n.count>0?(SN.hasOwnProperty(l)&&(l=SN[l]),a+=`    ${n.shortName}: array<${l}, ${n.count}>,
`):a+=`    ${n.shortName}: ${l},
`}),a+=`};
`,a+=`@group(${t}) @binding(${s}) var<uniform> ub_${i} : ${r};

`,a}static getTextureShaderDeclaration(e,t,s){let i="",r=s;return e.textureFormats.forEach(a=>{let n=_re(a.textureDimension,a.sampleType);if(i+=`@group(${t}) @binding(${r}) var ${a.name}: ${n};
`,r++,a.hasSampler){let l=a.sampleType===si?"sampler_comparison":"sampler";i+=`@group(${t}) @binding(${r}) var ${a.samplerName}: ${l};
`,r++}}),e.storageBufferFormats.forEach(a=>{let n=a.readOnly?"read":"read_write";i+=`@group(${t}) @binding(${r}) var<storage, ${n}> ${a.name} : ${a.format};
`,r++}),i}static processVaryings(e,t,s){let i="",r="",a="";e.forEach((h,c)=>{let f=h.match(dre);if(f){let d=f[1];s?t.set(d,c):c=t.get(d),i+=`    @location(${c}) ${h},
`,s||(r+=`    var<private> ${h};
`,a+=`    ${d} = input.${d};
`)}}),s?i+=`    @builtin(position) position : vec4f,
`:(i+=`    @builtin(position) position : vec4f,
`,i+=`    @builtin(front_facing) frontFacing : bool,
`,i+=`    @builtin(sample_index) sampleIndex : u32
`);let n=s?"":`
						var<private> pcPosition: vec4f;
						var<private> pcFrontFacing: bool;
						var<private> pcSampleIndex: u32;
						${r}
						
						// function to copy inputs (varyings) to private global variables
						fn _pcCopyInputs(input: FragmentInput) {
								${a}
								pcPosition = input.position;
								pcFrontFacing = input.frontFacing;
								pcSampleIndex = input.sampleIndex;
						}
				`;return`
						struct ${s?"VertexOutput":"FragmentInput"} {
								${i}
						};
						${n}
				`}static generateFragmentOutputStruct(e,t){let s=`struct FragmentOutput {
`;for(let r=0;r<t;r++)s+=`    @location(${r}) color${r>0?r:""} : pcOutType${r},
`;return e.search(/\.fragDepth\s*=/)!==-1&&(s+=`    @builtin(frag_depth) fragDepth : f32
`),`${s}};
`}static floatAttributeToInt(e,t){let i={f32:"f32","vec2<f32>":"vec2f","vec3<f32>":"vec3f","vec4<f32>":"vec4f"}[e]||e;return{f32:t?"i32":"u32",vec2f:t?"vec2i":"vec2u",vec3f:t?"vec3i":"vec3u",vec4f:t?"vec4i":"vec4u"}[i]||null}static processAttributes(e,t={},s,i,r){let a="",n="",l="";return e.forEach(h=>{let c=TN(h),f=c[0],d=c[1],u=d;if(t.hasOwnProperty(f)){let p=t[f],_=Be[p];s.set(_,f);let S=i.getVertexElement(p);if(S){let T=S.dataType;if(T!==pe&&T!==Ho&&!S.normalize&&!S.asInt){let x=T===Ps||T===Rs||T===ke;d=o.floatAttributeToInt(d,x)}}a+=`    @location(${_}) ${f}: ${d},
`,n+=`    var<private> ${h};
`,l+=`    ${f} = ${u}(input.${f});
`}}),`
						struct VertexInput {
								${a}
								@builtin(vertex_index) vertexIndex : u32,       // built-in vertex index
								@builtin(instance_index) instanceIndex : u32    // built-in instance index
						};

						${n}
						var<private> pcVertexIndex: u32;
						var<private> pcInstanceIndex: u32;

						fn _pcCopyInputs(input: VertexInput) {
								${l}
								pcVertexIndex = input.vertexIndex;
								pcInstanceIndex = input.instanceIndex;
						}
				`}static copyInputs(e,t){let s=e.match(ure);if(!s||!s[2])return e;let i=s[2],r=s.index+s[0].length-1,a=e.slice(0,r+1),n=e.slice(r+1),l=`
    _pcCopyInputs(${i});`;return a+l+n}static cutOut(e,t,s,i){return e.substring(0,t)+i+e.substring(s)}}});var nx,vN=m(()=>{j();_N();EN();nx=class{constructor(e){this._vertexCode=null,this._fragmentCode=null,this._computeCode=null,this.vertexEntryPoint="main",this.fragmentEntryPoint="main",this.computeEntryPoint="main",this.shader=e;let t=e.definition;t.shaderLanguage===le?(t.cshader?(this._computeCode=t.cshader??null,this.computeUniformBufferFormats=t.computeUniformBufferFormats,this.computeBindGroupFormat=t.computeBindGroupFormat):(this.vertexEntryPoint="vertexMain",this.fragmentEntryPoint="fragmentMain",t.processingOptions?this.processWGSL():(this._vertexCode=t.vshader??null,this._fragmentCode=t.fshader??null,e.meshUniformBufferFormat=t.meshUniformBufferFormat,e.meshBindGroupFormat=t.meshBindGroupFormat)),e.ready=!0):t.processingOptions&&this.processGLSL()}destroy(e){this._vertexCode=null,this._fragmentCode=null}createShaderModule(e,t){return this.shader.device.wgpu.createShaderModule({code:e})}getVertexShaderModule(){return this.createShaderModule(this._vertexCode,"Vertex")}getFragmentShaderModule(){return this.createShaderModule(this._fragmentCode,"Fragment")}getComputeShaderModule(){return this.createShaderModule(this._computeCode,"Compute")}processGLSL(){let e=this.shader,t=ix.run(e.device,e.definition,e);this._vertexCode=this.transpile(t.vshader,"vertex",e.definition.vshader),this._fragmentCode=this.transpile(t.fshader,"fragment",e.definition.fshader),this._vertexCode&&this._fragmentCode?e.ready=!0:e.failed=!0,e.meshUniformBufferFormat=t.meshUniformBufferFormat,e.meshBindGroupFormat=t.meshBindGroupFormat,e.attributes=t.attributes}processWGSL(){let e=this.shader,t=ax.run(e.device,e.definition,e);this._vertexCode=t.vshader,this._fragmentCode=t.fshader,e.meshUniformBufferFormat=t.meshUniformBufferFormat,e.meshBindGroupFormat=t.meshBindGroupFormat,e.attributes=t.attributes}transpile(e,t,s){let i=this.shader.device;if(!i.glslang||!i.twgsl)return console.error(`Cannot transpile shader [${this.shader.label}] - shader transpilers (glslang/twgsl) are not available. Make sure to provide glslangUrl and twgslUrl when creating the device.`,{shader:this.shader}),null;try{let r=i.glslang.compileGLSL(e,t);return i.twgsl.convertSpirV2WGSL(r)}catch(r){console.error(`Failed to transpile webgl ${t} shader [${this.shader.label}] to WebGPU while rendering undefined, error:
 [${r.stack}]`,{processed:e,original:s,shader:this.shader,error:r,stack:r.stack})}}get vertexCode(){return this._vertexCode}get fragmentCode(){return this._fragmentCode}loseContext(){}restoreContext(e,t){}}});var im,jo,yre,ox,xN=m(()=>{me();j();_f();bI();im=[];im[0]="repeat";im[1]="clamp-to-edge";im[2]="mirror-repeat";jo=[];jo[0]={level:"nearest",mip:"nearest"};jo[1]={level:"linear",mip:"nearest"};jo[2]={level:"nearest",mip:"nearest"};jo[3]={level:"nearest",mip:"linear"};jo[4]={level:"linear",mip:"nearest"};jo[5]={level:"linear",mip:"linear"};yre=o=>{},ox=class{constructor(e){this.samplers=[],this.texture=e,this.format=he[e.format],this.create(e.device)}create(e){let t=this.texture,s=e.wgpu,i=t.numLevels;this.desc={size:{width:t.width,height:t.height,depthOrArrayLayers:t.cubemap?6:t.array?t.arrayLength:1},format:this.format,mipLevelCount:i,sampleCount:1,dimension:t.volume?"3d":"2d",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC|(Vo(t.format)?0:GPUTextureUsage.RENDER_ATTACHMENT)|(t.storage?GPUTextureUsage.STORAGE_BINDING:0)},this.gpuTexture=s.createTexture(this.desc);let r;this.texture.format===17&&(r={format:"depth24plus",aspect:"depth-only"}),this.view=this.createView(r)}destroy(e){}propertyChanged(e){this.samplers.length=0}getView(e){return this.uploadImmediate(e,this.texture),this.view}createView(e){let t=e??{},s=this.desc,i=this.texture,r=()=>i.cubemap?"cube":i.volume?"3d":i.array?"2d-array":"2d",a={format:t.format??s.format,dimension:t.dimension??r(),aspect:t.aspect??"all",baseMipLevel:t.baseMipLevel??0,mipLevelCount:t.mipLevelCount??s.mipLevelCount,baseArrayLayer:t.baseArrayLayer??0,arrayLayerCount:t.arrayLayerCount??s.depthOrArrayLayers};return this.gpuTexture.createView(a)}getSampler(e,t){let s=this.samplers[t];if(!s){let i=this.texture,r={addressModeU:im[i.addressU],addressModeV:im[i.addressV],addressModeW:im[i.addressW]};!t&&i.compareOnRead&&(t=si),t===si||t===vr||t===xr?(r.compare="less",r.magFilter="linear",r.minFilter="linear"):t===Er||!e.textureFloatFilterable&&(i.format===14||i.format===12)||this.texture.format===17||Xi(this.texture.format)?(r.magFilter="nearest",r.minFilter="nearest",r.mipmapFilter="nearest"):(r.magFilter=jo[i.magFilter].level,r.minFilter=jo[i.minFilter].level,r.mipmapFilter=jo[i.minFilter].mip);let a=r.minFilter==="linear"&&r.magFilter==="linear"&&r.mipmapFilter==="linear";r.maxAnisotropy=a?w.clamp(Math.round(i._anisotropy),1,e.maxTextureAnisotropy):1,s=e.wgpu.createSampler(r),this.samplers[t]=s}return s}loseContext(){}uploadImmediate(e,t){(t._needsUpload||t._needsMipmapsUpload)&&(this.uploadData(e),t._needsUpload=!1,t._needsMipmapsUpload=!1)}uploadData(e){let t=this.texture;if(t._levels){let s=!1,i=!1,r=t.numLevels;for(let a=0;a<r;a++){let n=t._levels[a];if(n){if(t.cubemap)for(let l=0;l<6;l++){let h=n[l];h?this.isExternalImage(h)?(this.uploadExternalImage(e,h,a,l),s=!0):ArrayBuffer.isView(h)&&(this.uploadTypedArrayData(e,h,a,l),s=!0):i=!0}else if(!t._volume)if(t.array)if(t.arrayLength===n.length)for(let l=0;l<t._arrayLength;l++){let h=n[l];this.isExternalImage(h)?(this.uploadExternalImage(e,h,a,l),s=!0):ArrayBuffer.isView(h)&&(this.uploadTypedArrayData(e,h,a,l),s=!0)}else i=!0;else this.isExternalImage(n)?(this.uploadExternalImage(e,n,a,0),s=!0):ArrayBuffer.isView(n)&&(this.uploadTypedArrayData(e,n,a,0),s=!0)}else i=!0}s&&i&&t.mipmaps&&!Vo(t.format)&&!Xi(t.format)&&e.mipmapRenderer.generate(this),t._gpuSize&&t.adjustVramSizeTracking(e._vram,-t._gpuSize),t._gpuSize=t.gpuSize,t.adjustVramSizeTracking(e._vram,t._gpuSize)}}isExternalImage(e){return typeof ImageBitmap<"u"&&e instanceof ImageBitmap||typeof HTMLVideoElement<"u"&&e instanceof HTMLVideoElement||typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&e instanceof OffscreenCanvas}uploadExternalImage(e,t,s,i){let r={source:t,origin:[0,0],flipY:!1},a={texture:this.gpuTexture,mipLevel:s,origin:[0,0,i],aspect:"all"},n={width:this.desc.size.width,height:this.desc.size.height,depthOrArrayLayers:1};e.submit(),yre(t instanceof HTMLCanvasElement&&t.getContext("2d")),e.wgpu.queue.copyExternalImageToTexture(r,a,n)}uploadTypedArrayData(e,t,s,i){let r=this.texture,a=e.wgpu,n={texture:this.gpuTexture,origin:[0,0,i],mipLevel:s},l=Cs.calcLevelDimension(r.width,s),h=Cs.calcLevelDimension(r.height,s);Cs.calcLevelGpuSize(l,h,1,r.format);let c=ei.get(r.format),f,d;if(c.size)f={offset:0,bytesPerRow:c.size*l,rowsPerImage:h},d={width:l,height:h};else if(c.blockSize){let u=p=>Math.floor((p+3)/4);f={offset:0,bytesPerRow:c.blockSize*u(l),rowsPerImage:u(h)},d={width:Math.max(4,l),height:Math.max(4,h)}}e.submit(),a.queue.writeTexture(n,t,f,d)}read(e,t,s,i,r){let a=r.mipLevel??0,n=r.face??0,l=r.data??null,h=r.immediate??!1,c=this.texture,f=ei.get(c.format),d=s*f.size,u=w.roundUp(d,256),p=u*i,_=c.device,S=_.createBufferImpl(9);S.allocate(_,p);let T={texture:this.gpuTexture,mipLevel:a,origin:[e,t,n]},x={buffer:S.buffer,offset:0,bytesPerRow:u},A={width:s,height:i,depthOrArrayLayers:1};return _.getCommandEncoder().copyTextureToBuffer(T,x,A),_.readBuffer(S,p,null,h).then(v=>{let R=l?.constructor===Uint8Array?l:new Uint8Array(l?.buffer??i*d);for(let P=0;P<i;P++){let y=P*u,C=P*d,L=v.subarray(y,y+d);R.set(L,C)}return l??R})}}});var lx,yN=m(()=>{uS();lx=class extends Jn{constructor(e){super(64)}unlock(e){let t=e.device;super.unlock(t,e.storageInt32.buffer)}}});var hx,AN=m(()=>{uS();hx=class extends Jn{constructor(e,t,s){super(32|(s?.storage?128:0))}unlock(e){let t=e.device;super.unlock(t,e.storage)}}});var Ka,YI,PN,KI,qI,jI,RN,Are,Pre,Rre,Cre,Ire,$I,wre,CN,rm,IN=m(()=>{Ka=/[ \t]*#(ifn?def|if|endif|else|elif|define|undef|extension|include)/g,YI=/define[ \t]+([^\n]+)\r?(?:\n|$)/g,PN=/extension[ \t]+([\w-]+)[ \t]*:[ \t]*(enable|require)/g,KI=/undef[ \t]+([^\n]+)\r?(?:\n|$)/g,qI=/(ifdef|ifndef|if)[ \t]*([^\r\n]+)\r?\n/g,jI=/(endif|else|elif)(?:[ \t]+([^\r\n]*))?\r?\n?/g,RN=/\{?[\w-]+\}?/,Are=/(!|\s)?defined\(([\w-]+)\)/,Pre=/!?defined\s*\([^)]*\)/g,Rre=/!?defined\s*$/,Cre=/([a-z_]\w*)\s*(==|!=|<|<=|>|>=)\s*([\w"']+)/i,Ire=/[+\-]/g,$I=/include[ \t]+"([\w-]+)(?:\s*,\s*([\w-]+))?"/g,wre=/\{i\}/g,CN=/(pcFragColor[1-8])\b/g,rm=class o{static run(e,t=new Map,s={}){o.sourceName=s.sourceName,e=this.stripComments(e),e=e.split(/\r?\n/).map(n=>n.trimEnd()).join(`
`);let i=new Map,r=new Map;if(e=this._preprocess(e,i,r,t,s.stripDefines),e===null)return null;let a=new Map;return i.forEach((n,l)=>{Number.isInteger(parseFloat(n))&&!n.includes(".")&&a.set(l,n)}),e=this.stripComments(e),e=this.stripUnusedColorAttachments(e,s),e=this.RemoveEmptyLines(e),e=this.processArraySize(e,a),e=this.injectDefines(e,r),e}static stripUnusedColorAttachments(e,t){if(t.stripUnusedColorAttachments){let s=new Map;if(e.match(CN)?.forEach(a=>{let n=parseInt(a.charAt(a.length-1),10);s.set(n,(s.get(n)??0)+1)}),Array.from(s.values()).some(a=>a===1)){let a=e.split(`
`),n=[];for(let l=0;l<a.length;l++){let h=a[l].match(CN);if(h){let c=parseInt(h[0].charAt(h[0].length-1),10);if(c>0&&s.get(c)===1)continue}n.push(a[l])}e=n.join(`
`)}}return e}static stripComments(e){return e.replace(/\/\*[\s\S]*?\*\/|([^\\:]|^)\/\/.*$/gm,"$1")}static processArraySize(e,t){return e!==null&&t.forEach((s,i)=>{e=e.replace(new RegExp(`\\[${i}\\]`,"g"),`[${s}]`)}),e}static injectDefines(e,t){if(e!==null&&t.size>0){let s=e.split(`
`);t.forEach((i,r)=>{let a=new RegExp(r,"g");for(let n=0;n<s.length;n++)s[n].includes("#")||(s[n]=s[n].replace(a,i))}),e=s.join(`
`)}return e}static RemoveEmptyLines(e){return e!==null&&(e=e.split(/\r?\n/).map(t=>t.trim()===""?"":t).join(`
`),e=e.replace(/(\n\n){3,}/g,`

`)),e}static _preprocess(e,t=new Map,s,i,r){let a=e,n=[],l=!1,h;for(;(h=Ka.exec(e))!==null&&!l;){let c=h[1];switch(c){case"define":{YI.lastIndex=h.index;let f=YI.exec(e);l||=f===null;let d=f[1];RN.lastIndex=f.index;let p=RN.exec(d)[0],_=d.substring(p.length).trim();_===""&&(_="true");let S=o._keep(n),T=r;if(S){let x=p.startsWith("{")&&p.endsWith("}");x&&(T=!0),x?s.set(p,_):t.set(p,_),T&&(e=e.substring(0,f.index-1)+e.substring(YI.lastIndex),Ka.lastIndex=f.index-1)}T||(Ka.lastIndex=f.index+f[0].length);break}case"undef":{KI.lastIndex=h.index;let f=KI.exec(e),d=f[1].trim();o._keep(n)&&(t.delete(d),r&&(e=e.substring(0,f.index-1)+e.substring(KI.lastIndex),Ka.lastIndex=f.index-1)),r||(Ka.lastIndex=f.index+f[0].length);break}case"extension":{PN.lastIndex=h.index;let f=PN.exec(e);if(l||=f===null,f){let d=f[1];o._keep(n)&&t.set(d,"true")}Ka.lastIndex=f.index+f[0].length;break}case"ifdef":case"ifndef":case"if":{qI.lastIndex=h.index;let f=qI.exec(e),d=f[2],u=o.evaluate(d,t);l||=u.error;let p=u.result;c==="ifndef"&&(p=!p),n.push({anyKeep:p,keep:p,start:h.index,end:qI.lastIndex}),Ka.lastIndex=f.index+f[0].length;break}case"endif":case"else":case"elif":{jI.lastIndex=h.index;let f=jI.exec(e),d=n.pop();if(!d){console.error(`Shader preprocessing encountered "#${f[1]}" without a preceding #if #ifdef #ifndef while preprocessing ${o.sourceName} on line:
 ${e.substring(h.index,h.index+100)}...`,{source:a}),l=!0;continue}let u=d.keep?e.substring(d.end,h.index):"";e=e.substring(0,d.start)+u+e.substring(jI.lastIndex),Ka.lastIndex=d.start+u.length;let p=f[1];if(p==="else"||p==="elif"){let _=!1;if(!d.anyKeep)if(p==="else")_=!d.keep;else{let S=o.evaluate(f[2],t);_=S.result,l||=S.error}n.push({anyKeep:d.anyKeep||_,keep:_,start:Ka.lastIndex,end:Ka.lastIndex})}break}case"include":{$I.lastIndex=h.index;let f=$I.exec(e);if(l||=f===null,!f){l=!0;continue}let d=f[1].trim(),u=f[2]?.trim();if(o._keep(n)){let _=i?.get(d);if(_!==void 0){if(_=this.stripComments(_),u){let S=t.get(u),T=parseFloat(S);if(Number.isInteger(T)){let x="";for(let A=0;A<T;A++)x+=_.replace(wre,String(A));_=x}else console.error(`Include Count identifier "${u}" not resolved while preprocessing ${o.sourceName} on line:
 ${e.substring(h.index,h.index+100)}...`,{originalSource:a,source:e}),l=!0}e=e.substring(0,f.index-1)+_+e.substring($I.lastIndex),Ka.lastIndex=f.index-1}else{console.error(`Include "${d}" not resolved while preprocessing ${o.sourceName}`,{originalSource:a,source:e}),l=!0;continue}}break}}}return n.length>0&&(console.error(`Shader preprocessing reached the end of the file without encountering the necessary #endif to close a preceding #if, #ifdef, or #ifndef block. ${o.sourceName}`),l=!0),l?(console.error("Failed to preprocess shader: ",{source:a}),null):e}static _keep(e){for(let t=0;t<e.length;t++)if(!e[t].keep)return!1;return!0}static evaluateAtomicExpression(e,t){let s=!1;e=e.trim();let i=!1;if(e==="true")return{result:!0,error:s};if(e==="false")return{result:!1,error:s};let r=Are.exec(e);if(r){i=r[1]==="!",e=r[2].trim();let l=t.has(e);return{result:i?!l:l,error:s}}let a=Cre.exec(e);if(a){let l=t.get(a[1].trim())??a[1].trim(),h=t.get(a[3].trim())??a[3].trim(),c=a[2].trim(),f=!1;switch(c){case"==":f=l===h;break;case"!=":f=l!==h;break;case"<":f=l<h;break;case"<=":f=l<=h;break;case">":f=l>h;break;case">=":f=l>=h;break;default:s=!0}return{result:f,error:s}}return{result:t.has(e),error:s}}static processParentheses(e,t){let s=!1,i=e.trim();for(;i.startsWith("(")&&i.endsWith(")");){let r=0,a=!0;for(let n=0;n<i.length-1;n++)if(i[n]==="(")r++;else if(i[n]===")"&&(r--,r===0)){a=!1;break}if(a)i=i.slice(1,-1).trim();else break}for(;;){let r=!1,a=0,n=0,l=-1,h=-1,c=0;for(let p=0;p<i.length;p++)if(i[p]==="("){let _=i.substring(0,p);Rre.test(_)?c++:c===0&&(a++,a>n&&(n=a,l=p),r=!0)}else i[p]===")"&&(c>0?c--:a>0&&(a===n&&l!==-1&&(h=p),a--));if(!r||l===-1||h===-1)break;let f=i.substring(l+1,h),{result:d,error:u}=o.evaluate(f,t);s=s||u,i=i.substring(0,l)+(d?"true":"false")+i.substring(h+1)}return{expression:i,error:s}}static evaluate(e,t){let s=Ire.exec(e)===null,i=e,r=!1;if(e.replace(Pre,"").indexOf("(")!==-1){let l=o.processParentheses(e,t);i=l.expression,r=l.error}if(r)return{result:!1,error:!0};let n=i.split("||");for(let l of n){let h=l.split("&&"),c=!0;for(let f of h){let{result:d,error:u}=o.evaluateAtomicExpression(f.trim(),t);if(!d||u){c=!1;break}}if(c)return{result:!0,error:!s}}return{result:!1,error:!s}}}});var cx,ZI=m(()=>{cx=`
#ifndef outType_0
#define outType_0 vec4
#endif
layout(location = 0) out highp outType_0 pcFragColor0;
#if COLOR_ATTACHMENT_1
layout(location = 1) out highp outType_1 pcFragColor1;
#endif
#if COLOR_ATTACHMENT_2
layout(location = 2) out highp outType_2 pcFragColor2;
#endif
#if COLOR_ATTACHMENT_3
layout(location = 3) out highp outType_3 pcFragColor3;
#endif
#if COLOR_ATTACHMENT_4
layout(location = 4) out highp outType_4 pcFragColor4;
#endif
#if COLOR_ATTACHMENT_5
layout(location = 5) out highp outType_5 pcFragColor5;
#endif
#if COLOR_ATTACHMENT_6
layout(location = 6) out highp outType_6 pcFragColor6;
#endif
#if COLOR_ATTACHMENT_7
layout(location = 7) out highp outType_7 pcFragColor7;
#endif
#define gl_FragColor pcFragColor0
#define varying in
#define texture2D texture
#define texture2DBias texture
#define textureCube texture
#define texture2DProj textureProj
#define texture2DLod textureLod
#define texture2DProjLod textureProjLod
#define textureCubeLod textureLod
#define texture2DGrad textureGrad
#define texture2DProjGrad textureProjGrad
#define textureCubeGrad textureGrad
#define utexture2D texture
#define itexture2D texture
#define texture2DLodEXT texture2DLodEXT_is_no_longer_supported_use_texture2DLod_instead
#define texture2DProjLodEXT texture2DProjLodEXT_is_no_longer_supported_use_texture2DProjLod
#define textureCubeLodEXT textureCubeLodEXT_is_no_longer_supported_use_textureCubeLod_instead
#define texture2DGradEXT texture2DGradEXT_is_no_longer_supported_use_texture2DGrad_instead
#define texture2DProjGradEXT texture2DProjGradEXT_is_no_longer_supported_use_texture2DProjGrad_instead
#define textureCubeGradEXT textureCubeGradEXT_is_no_longer_supported_use_textureCubeGrad_instead
#define textureShadow(res, uv) textureGrad(res, uv, vec2(1, 1), vec2(1, 1))
#define SHADOWMAP_PASS(name) name
#define SHADOWMAP_ACCEPT(name) sampler2DShadow name
#define TEXTURE_PASS(name) name
#define TEXTURE_ACCEPT(name) sampler2D name
#define TEXTURE_ACCEPT_HIGHP(name) highp sampler2D name
#define GL2
`});var fx,QI=m(()=>{fx=`
#define attribute in
#define varying out
#define texture2D texture
#define utexture2D texture
#define itexture2D texture
#define GL2
#define VERTEXSHADER
#define TEXTURE_PASS(name) name
#define TEXTURE_ACCEPT(name) sampler2D name
#define TEXTURE_ACCEPT_HIGHP(name) highp sampler2D name
`});var dx,JI=m(()=>{dx=`
#extension GL_EXT_samplerless_texture_functions : require
#ifndef outType_0
#define outType_0 vec4
#endif
#ifndef outType_1
#define outType_1 vec4
#endif
#ifndef outType_2
#define outType_2 vec4
#endif
#ifndef outType_3
#define outType_3 vec4
#endif
#ifndef outType_4
#define outType_4 vec4
#endif
#ifndef outType_5
#define outType_5 vec4
#endif
#ifndef outType_6
#define outType_6 vec4
#endif
#ifndef outType_7
#define outType_7 vec4
#endif
layout(location = 0) out highp outType_0 pcFragColor0;
layout(location = 1) out highp outType_1 pcFragColor1;
layout(location = 2) out highp outType_2 pcFragColor2;
layout(location = 3) out highp outType_3 pcFragColor3;
layout(location = 4) out highp outType_4 pcFragColor4;
layout(location = 5) out highp outType_5 pcFragColor5;
layout(location = 6) out highp outType_6 pcFragColor6;
layout(location = 7) out highp outType_7 pcFragColor7;
#define gl_FragColor pcFragColor0
#define texture2D(res, uv) texture(sampler2D(res, res ## _sampler), uv)
#define texture2DBias(res, uv, bias) texture(sampler2D(res, res ## _sampler), uv, bias)
#define texture2DLod(res, uv, lod) textureLod(sampler2D(res, res ## _sampler), uv, lod)
#define textureCube(res, uv) texture(samplerCube(res, res ## _sampler), uv)
#define textureCubeLod(res, uv, lod) textureLod(samplerCube(res, res ## _sampler), uv, lod)
#define textureShadow(res, uv) textureLod(sampler2DShadow(res, res ## _sampler), uv, 0.0)
#define itexture2D(res, uv) texture(isampler2D(res, res ## _sampler), uv)
#define utexture2D(res, uv) texture(usampler2D(res, res ## _sampler), uv)
#define texture2DLodEXT texture2DLodEXT_is_no_longer_supported_use_texture2DLod_instead
#define texture2DProjLodEXT texture2DProjLodEXT_is_no_longer_supported_use_texture2DProjLod
#define textureCubeLodEXT textureCubeLodEXT_is_no_longer_supported_use_textureCubeLod_instead
#define texture2DGradEXT texture2DGradEXT_is_no_longer_supported_use_texture2DGrad_instead
#define texture2DProjGradEXT texture2DProjGradEXT_is_no_longer_supported_use_texture2DProjGrad_instead
#define textureCubeGradEXT textureCubeGradEXT_is_no_longer_supported_use_textureCubeGrad_instead
#define SHADOWMAP_PASS(name) name, name ## _sampler
#define SHADOWMAP_ACCEPT(name) texture2D name, sampler name ## _sampler
#define TEXTURE_PASS(name) name, name ## _sampler
#define TEXTURE_ACCEPT(name) texture2D name, sampler name ## _sampler
#define TEXTURE_ACCEPT_HIGHP TEXTURE_ACCEPT
#define GL2
#define WEBGPU
`});var ux,ew=m(()=>{ux=`
#extension GL_EXT_samplerless_texture_functions : require
#define texture2D(res, uv) texture(sampler2D(res, res ## _sampler), uv)
#define itexture2D(res, uv) texture(isampler2D(res, res ## _sampler), uv)
#define utexture2D(res, uv) texture(usampler2D(res, res ## _sampler), uv)
#define TEXTURE_PASS(name) name, name ## _sampler
#define TEXTURE_ACCEPT(name) texture2D name, sampler name ## _sampler
#define TEXTURE_ACCEPT_HIGHP TEXTURE_ACCEPT
#define GL2
#define WEBGPU
#define VERTEXSHADER
#define gl_VertexID gl_VertexIndex
#define gl_InstanceID gl_InstanceIndex
`});var mx,tw=m(()=>{mx=`
`});var px,sw=m(()=>{px=`
#define VERTEXSHADER
`});var iw,wN=m(()=>{iw=`
vec2 getGrabScreenPos(vec4 clipPos) {
	vec2 uv = (clipPos.xy / clipPos.w) * 0.5 + 0.5;
	#ifdef WEBGPU
		uv.y = 1.0 - uv.y;
	#endif
	return uv;
}
vec2 getImageEffectUV(vec2 uv) {
	#ifdef WEBGPU
		uv.y = 1.0 - uv.y;
	#endif
	return uv;
}
`});var rw,LN=m(()=>{rw=`
fn getGrabScreenPos(clipPos: vec4<f32>) -> vec2<f32> {
	var uv: vec2<f32> = (clipPos.xy / clipPos.w) * 0.5 + vec2<f32>(0.5);
	uv.y = 1.0 - uv.y;
	return uv;
}
fn getImageEffectUV(uv: vec2<f32>) -> vec2<f32> {
	var modifiedUV: vec2<f32> = uv;
	modifiedUV.y = 1.0 - modifiedUV.y;
	return modifiedUV;
}
struct WrappedF32 { @size(16) element: f32 }
struct WrappedI32 { @size(16) element: i32 }
struct WrappedU32 { @size(16) element: u32 }
struct WrappedVec2F { @size(16) element: vec2f }
struct WrappedVec2I { @size(16) element: vec2i }
struct WrappedVec2U { @size(16) element: vec2u }
`});var Lre,ri,Sh=m(()=>{j();ZI();QI();JI();ew();tw();sw();wN();LN();Lre={vertex_position:te,vertex_normal:Pt,vertex_tangent:as,vertex_texCoord0:ot,vertex_texCoord1:ks,vertex_texCoord2:jr,vertex_texCoord3:$r,vertex_texCoord4:Zr,vertex_texCoord5:Qr,vertex_texCoord6:Jr,vertex_texCoord7:ea,vertex_color:nt,vertex_boneIndices:Gt,vertex_boneWeights:hs},ri=class o{static createDefinition(e,t){let s=d=>{let u=d.fragmentOutputTypes??"vec4";return Array.isArray(u)||(u=[u]),u},i=(d,u,p,_)=>{let S=e.isWebGPU?d:u,T="";if(!p){let x=s(_);for(let A=0;A<e.maxColorAttachments;A++){T+=`#define COLOR_ATTACHMENT_${A}
`;let E=x[A]??"vec4";T+=`#define outType_${A} ${E}
`}}return T+S},r=(d,u)=>{let p="";if(!d){let _=s(u);for(let S=0;S<e.maxColorAttachments;S++){let T=_[S]??"vec4",x=Xu.get(T);p+=`alias pcOutType${S} = ${x};
`}}return p},a=t.name??"Untitled",n,l,h=o.getDefinesCode(e,t.vertexDefines),c=o.getDefinesCode(e,t.fragmentDefines);return t.shaderLanguage===le?(n=`
								${r(!0,t)}
								${px}
								${rw}
								${h}
								${t.vertexCode}
						`,l=`
								${r(!1,t)}
								${mx}
								${rw}
								${c}
								${t.fragmentCode}
						`):(n=`${o.versionCode(e)+i(ux,fx,!0,t)+h+o.precisionCode(e)}
								${iw}
								${o.getShaderNameCode(a)}
								${t.vertexCode}`,l=`${(t.fragmentPreamble||"")+o.versionCode(e)+i(dx,cx,!1,t)+c+o.precisionCode(e)}
								${iw}
								${o.getShaderNameCode(a)}
								${t.fragmentCode}`),{name:a,shaderLanguage:t.shaderLanguage??oe,attributes:t.attributes,vshader:n,vincludes:t.vertexIncludes,fincludes:t.fragmentIncludes,fshader:l,useTransformFeedback:t.useTransformFeedback,meshUniformBufferFormat:t.meshUniformBufferFormat,meshBindGroupFormat:t.meshBindGroupFormat}}static getDefinesCode(e,t){let s="";return e.capsDefines.forEach((i,r)=>{s+=`#define ${r} ${i}
`}),s+=`
`,t?.forEach((i,r)=>{s+=`#define ${r} ${i}
`}),s+=`
`,s}static getShaderNameCode(e){return`#define SHADER_NAME ${e}
`}static versionCode(e){return e.isWebGPU?`#version 450
`:`#version 300 es
`}static precisionCode(e,t){t&&t!=="highp"&&t!=="mediump"&&t!=="lowp"&&(t=null),t&&(t==="highp"&&e.maxPrecision!=="highp"&&(t="mediump"),t==="mediump"&&e.maxPrecision==="lowp"&&(t="lowp"));let s=t||e.precision;return`
						precision ${s} float;
						precision ${s} int;
						precision ${s} usampler2D;
						precision ${s} isampler2D;
						precision ${s} sampler2DShadow;
						precision ${s} samplerCubeShadow;
						precision ${s} sampler2DArray;
				`}static collectAttributes(e){let t={},s=0,i=e.indexOf("attribute");for(;i>=0&&!(i>0&&e[i-1]==="/");){let r=!1;if(i>0){let a=e.lastIndexOf(`
`,i);a=a!==-1?a+1:0,e.substring(a,i).includes("#")&&(r=!0)}if(!r){let a=e.indexOf(";",i),n=e.lastIndexOf(" ",a),l=e.substring(n+1,a);if(!t[l]){let h=Lre[l];h!==void 0?t[l]=h:(t[l]=`ATTR${s}`,s++)}}i=e.indexOf("attribute",i+1)}return t}}});var bre,ai,Th=m(()=>{bt();IN();j();Sh();bre=0,ai=class{constructor(e,t){if(this.attributes=new Map,this.id=bre++,this.device=e,this.definition=t,this.name=t.name||"Untitled",this.init(),t.cshader)t.cshader=rm.run(t.cshader,t.cincludes,{sourceName:`compute shader for ${this.label}`,stripDefines:!0});else{let s=t.shaderLanguage===le;t.vshader=rm.run(t.vshader,t.vincludes,{sourceName:`vertex shader for ${this.label}`,stripDefines:s}),t.shaderLanguage===oe&&(t.attributes??=ri.collectAttributes(t.vshader));let i=e.isWebGL2&&(ue.name==="osx"||ue.name==="ios");if(t.fshader=rm.run(t.fshader,t.fincludes,{stripUnusedColorAttachments:i,stripDefines:s,sourceName:`fragment shader for ${this.label}`}),!t.vshader||!t.fshader){this.failed=!0;return}}this.impl=e.createShaderImpl(this)}init(){this.ready=!1,this.failed=!1}get label(){return`Shader Id ${this.id} (${this.definition.shaderLanguage===le?"WGSL":"GLSL"}) ${this.name}`}destroy(){this.device.onDestroyShader(this),this.impl.destroy(this)}loseContext(){this.init(),this.impl.loseContext()}restoreContext(){this.impl.restoreContext(this.device,this)}}});var aw,_x,gx,nw=m(()=>{me();aw=class{},_x=class{},gx=class{constructor(e,t,s){this.gpuBuffers=[],this.stagingBuffers=[],this.usedBuffers=[],this.activeBuffer=null,this.device=e,this.bufferSize=t,this.bufferAlignment=s}destroy(){this.gpuBuffers.forEach(e=>{e.destroy(this.device)}),this.gpuBuffers=null,this.stagingBuffers.forEach(e=>{e.destroy(this.device)}),this.stagingBuffers=null,this.usedBuffers=null,this.activeBuffer=null}alloc(e,t){if(this.activeBuffer){let r=w.roundUp(this.activeBuffer.size,this.bufferAlignment);this.bufferSize-r<t&&this.scheduleSubmit()}if(!this.activeBuffer){let r=this.gpuBuffers.pop();r||(r=this.createBuffer(this.device,this.bufferSize,!1));let a=this.stagingBuffers.pop();a||(a=this.createBuffer(this.device,this.bufferSize,!0)),this.activeBuffer=new aw,this.activeBuffer.stagingBuffer=a,this.activeBuffer.gpuBuffer=r,this.activeBuffer.offset=0,this.activeBuffer.size=0}let s=this.activeBuffer,i=w.roundUp(s.size,this.bufferAlignment);e.gpuBuffer=s.gpuBuffer,e.offset=i,e.storage=s.stagingBuffer.alloc(i,t),s.size=i+t}scheduleSubmit(){this.activeBuffer&&(this.usedBuffers.push(this.activeBuffer),this.activeBuffer=null)}submit(){this.scheduleSubmit()}}});var lt,da,am=m(()=>{j();nw();lt=[];lt[Ht]=function(o,e,t){let s=o.storageFloat32;s[t]=e};lt[Ki]=(o,e,t)=>{let s=o.storageFloat32;s[t]=e[0],s[t+1]=e[1]};lt[fs]=(o,e,t)=>{let s=o.storageFloat32;s[t]=e[0],s[t+1]=e[1],s[t+2]=e[2]};lt[qi]=(o,e,t)=>{let s=o.storageFloat32;s[t]=e[0],s[t+1]=e[1],s[t+2]=e[2],s[t+3]=e[3]};lt[Yi]=function(o,e,t){let s=o.storageInt32;s[t]=e};lt[yr]=function(o,e,t){let s=o.storageInt32;s[t]=e[0],s[t+1]=e[1]};lt[Ar]=function(o,e,t){let s=o.storageInt32;s[t]=e[0],s[t+1]=e[1],s[t+2]=e[2]};lt[Pr]=function(o,e,t){let s=o.storageInt32;s[t]=e[0],s[t+1]=e[1],s[t+2]=e[2],s[t+3]=e[3]};lt[Xo]=(o,e,t)=>{let s=o.storageFloat32;s[t]=e[0],s[t+1]=e[1],s[t+4]=e[2],s[t+5]=e[3],s[t+8]=e[4],s[t+9]=e[5]};lt[sa]=(o,e,t)=>{let s=o.storageFloat32;s[t]=e[0],s[t+1]=e[1],s[t+2]=e[2],s[t+4]=e[3],s[t+5]=e[4],s[t+6]=e[5],s[t+8]=e[6],s[t+9]=e[7],s[t+10]=e[8]};lt[kn]=function(o,e,t,s){let i=o.storageFloat32;for(let r=0;r<s;r++)i[t+r*4]=e[r]};lt[Gn]=(o,e,t,s)=>{let i=o.storageFloat32;for(let r=0;r<s;r++)i[t+r*4]=e[r*2],i[t+r*4+1]=e[r*2+1]};lt[zn]=(o,e,t,s)=>{let i=o.storageFloat32;for(let r=0;r<s;r++)i[t+r*4]=e[r*3],i[t+r*4+1]=e[r*3+1],i[t+r*4+2]=e[r*3+2]};lt[ia]=(o,e,t,s)=>{let i=o.storageUint32;i[t]=e};lt[ra]=(o,e,t,s)=>{let i=o.storageUint32;i[t]=e[0],i[t+1]=e[1]};lt[aa]=(o,e,t,s)=>{let i=o.storageUint32;i[t]=e[0],i[t+1]=e[1],i[t+2]=e[2]};lt[na]=(o,e,t,s)=>{let i=o.storageUint32;i[t]=e[0],i[t+1]=e[1],i[t+2]=e[2],i[t+3]=e[3]};lt[oa]=function(o,e,t,s){let i=o.storageInt32;for(let r=0;r<s;r++)i[t+r*4]=e[r]};lt[Xn]=lt[oa];lt[Hn]=function(o,e,t,s){let i=o.storageUint32;for(let r=0;r<s;r++)i[t+r*4]=e[r]};lt[la]=(o,e,t,s)=>{let i=o.storageInt32;for(let r=0;r<s;r++)i[t+r*4]=e[r*2],i[t+r*4+1]=e[r*2+1]};lt[Yn]=lt[la];lt[Wn]=(o,e,t,s)=>{let i=o.storageUint32;for(let r=0;r<s;r++)i[t+r*4]=e[r*2],i[t+r*4+1]=e[r*2+1]};lt[ha]=(o,e,t,s)=>{let i=o.storageInt32;for(let r=0;r<s;r++)i[t+r*4]=e[r*3],i[t+r*4+1]=e[r*3+1],i[t+r*4+2]=e[r*3+2]};lt[qn]=lt[ha];lt[Kn]=(o,e,t,s)=>{let i=o.storageUint32;for(let r=0;r<s;r++)i[t+r*4]=e[r*3],i[t+r*4+1]=e[r*3+1],i[t+r*4+2]=e[r*3+2]};da=class{constructor(e,t,s=!0){if(this.renderVersionDirty=0,this.device=e,this.format=t,this.persistent=s,s){this.impl=e.createUniformBufferImpl(this);let i=new ArrayBuffer(t.byteSize);this.assignStorage(new Int32Array(i)),e._vram.ub+=this.format.byteSize}else this.allocation=new _x}destroy(){if(this.persistent){let e=this.device;this.impl.destroy(e),e._vram.ub-=this.format.byteSize}}get offset(){return this.persistent?0:this.allocation.offset}assignStorage(e){this.storageInt32=e,this.storageUint32=new Uint32Array(e.buffer,e.byteOffset,e.byteLength/4),this.storageFloat32=new Float32Array(e.buffer,e.byteOffset,e.byteLength/4)}loseContext(){this.impl?.loseContext()}setUniform(e,t){let s=e.offset;if(t!=null){let i=lt[e.updateType];i?i(this,t,s,e.count):this.storageFloat32.set(t,s)}}set(e,t){let s=this.format.map.get(e);s&&this.setUniform(s,t)}startUpdate(e){if(!this.persistent){let t=this.allocation,s=t.gpuBuffer;this.device.dynamicBuffers.alloc(t,this.format.byteSize),this.assignStorage(t.storage),e&&(e.bindGroup=t.gpuBuffer.getBindGroup(this),e.offsets[0]=t.offset),s!==t.gpuBuffer&&(this.renderVersionDirty=this.device.renderVersion)}}endUpdate(){this.persistent?this.impl.unlock(this):(this.storageFloat32=null,this.storageInt32=null)}update(e){this.startUpdate(e);let t=this.format.uniforms;for(let s=0;s<t.length;s++){let i=t[s].scopeId.value;this.setUniform(t[s],i)}this.endUpdate()}}});var Mre,Sx,bN=m(()=>{Tf();qt();j();Th();_h();am();ii();Mre={type:rs,base:0,baseVertex:0,count:4,indexed:!1},Sx=class{constructor(e){let t=`

						struct ub_mesh {
								color : vec4f,
								depth: f32
						}

						@group(2) @binding(0) var<uniform> ubMesh : ub_mesh;

						var<private> pos : array<vec2f, 4> = array<vec2f, 4>(
								vec2(-1.0, 1.0), vec2(1.0, 1.0),
								vec2(-1.0, -1.0), vec2(1.0, -1.0)
						);

						struct VertexOutput {
								@builtin(position) position : vec4f
						}

						@vertex
						fn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {
								var output : VertexOutput;
								output.position = vec4(pos[vertexIndex], ubMesh.depth, 1.0);
								return output;
						}

						@fragment
						fn fragmentMain() -> @location(0) vec4f {
								return ubMesh.color;
						}
				`;this.shader=new ai(e,{name:"WebGPUClearRendererShader",shaderLanguage:le,vshader:t,fshader:t}),this.uniformBuffer=new da(e,new Zi(e,[new qe("color",qi),new qe("depth",Ht)]),!1),this.dynamicBindGroup=new ph,this.colorData=new Float32Array(4)}destroy(){this.shader.destroy(),this.shader=null,this.uniformBuffer.destroy(),this.uniformBuffer=null}clear(e,t,s,i){s=s||i;let r=s.flags??i.flags;if(r!==0){let{uniformBuffer:a,dynamicBindGroup:n}=this;if(a.startUpdate(n),e.setBindGroup(Rr,n.bindGroup,n.offsets),e.setBindGroup(ca,e.emptyBindGroup),r&1&&(t.colorBuffer||t.impl.assignedColorTexture)){let l=s.color??i.color;this.colorData.set(l),e.setBlendState(Ie.NOBLEND)}else e.setBlendState(Ie.NOWRITE);if(a.set("color",this.colorData),r&2&&t.depth){let l=s.depth??i.depth;a.set("depth",l),e.setDepthState($e.WRITEDEPTH)}else a.set("depth",1),e.setDepthState($e.NODEPTH);r&4&&t.stencil,a.endUpdate(),e.setCullMode(0),e.setShader(this.shader),e.draw(Mre)}}}});var Tx,MN=m(()=>{Th();j();Tx=class{constructor(e){this.device=e;let t=`
 
						var<private> pos : array<vec2f, 4> = array<vec2f, 4>(
								vec2(-1.0, 1.0), vec2(1.0, 1.0),
								vec2(-1.0, -1.0), vec2(1.0, -1.0)
						);

						struct VertexOutput {
								@builtin(position) position : vec4f,
								@location(0) texCoord : vec2f
						};

						@vertex
						fn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {
							var output : VertexOutput;
							output.texCoord = pos[vertexIndex] * vec2f(0.5, -0.5) + vec2f(0.5);
							output.position = vec4f(pos[vertexIndex], 0, 1);
							return output;
						}

						@group(0) @binding(0) var imgSampler : sampler;
						@group(0) @binding(1) var img : texture_2d<f32>;

						@fragment
						fn fragmentMain(@location(0) texCoord : vec2f) -> @location(0) vec4f {
							return textureSample(img, imgSampler, texCoord);
						}
				`;this.shader=new ai(e,{name:"WebGPUMipmapRendererShader",shaderLanguage:le,vshader:t,fshader:t}),this.minSampler=e.wgpu.createSampler({minFilter:"linear"})}destroy(){this.shader.destroy(),this.shader=null}generate(e){let t=e.desc;if(t.mipLevelCount<=1||e.texture.volume)return;let s=this.device,i=s.wgpu,r=this.shader.impl,a=i.createRenderPipeline({layout:"auto",vertex:{module:r.getVertexShaderModule(),entryPoint:r.vertexEntryPoint},fragment:{module:r.getFragmentShaderModule(),entryPoint:r.fragmentEntryPoint,targets:[{format:t.format}]},primitive:{topology:"triangle-strip"}}),n=e.texture,l=n.cubemap?6:n.array?n.arrayLength:1,h=[];for(let f=0;f<l;f++)h.push(e.createView({dimension:"2d",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:f}));let c=s.getCommandEncoder();for(let f=1;f<t.mipLevelCount;f++)for(let d=0;d<l;d++){let u=e.createView({dimension:"2d",baseMipLevel:f,mipLevelCount:1,baseArrayLayer:d}),p=c.beginRenderPass({colorAttachments:[{view:u,loadOp:"clear",storeOp:"store"}]}),_=i.createBindGroup({layout:a.getBindGroupLayout(0),entries:[{binding:0,resource:this.minSampler},{binding:1,resource:h[d]}]});p.setPipeline(a),p.setBindGroup(0,_),p.draw(4),p.end(),h[d]=u}s.pipeline=null}}});var Ex,DN=m(()=>{mh();_h();j();Ex=class{constructor(e){this.bindGroupCache=new Map,this.device=e,this.bindGroupFormat=new _i(this.device,[new Wa(jn,wi|Li)])}getBindGroup(e){let t=e.format.byteSize,s=this.bindGroupCache.get(t);return s||(s=new ji(this.device,this.bindGroupFormat,e),s.update(),this.bindGroupCache.set(t,s)),s}}});var vx,ON=m(()=>{DN();vx=class extends Ex{constructor(e,t,s){super(e),this.buffer=null,this.mappedRange=null,this.buffer=e.wgpu.createBuffer({size:t,usage:s?GPUBufferUsage.MAP_WRITE|GPUBufferUsage.COPY_SRC:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:s}),s&&this.onAvailable(),e._vram.ub+=t}destroy(e){e._vram.ub-=this.buffer.size,this.buffer.destroy(),this.buffer=null}onAvailable(){this.mappedRange=this.buffer.getMappedRange()}alloc(e,t){return new Int32Array(this.mappedRange,e,t/4)}}});var xx,NN=m(()=>{nw();ON();xx=class extends gx{createBuffer(e,t,s){return new vx(e,t,s)}submit(){super.submit();let e=this.usedBuffers.length;if(e){let t=this.device,s=this.gpuBuffers,i=t.wgpu.createCommandEncoder();for(let a=e-1;a>=0;a--){let n=this.usedBuffers[a],{stagingBuffer:l,gpuBuffer:h,offset:c,size:f}=n,d=l.buffer;d.unmap(),i.copyBufferToBuffer(d,c,h.buffer,c,f),s.push(h)}let r=i.finish();t.addCommandBuffer(r,!0);for(let a=0;a<e;a++){let n=this.usedBuffers[a].stagingBuffer;this.pendingStagingBuffers.push(n)}this.usedBuffers.length=0}}onCommandBuffersSubmitted(){let e=this.pendingStagingBuffers.length;if(e){for(let t=0;t<e;t++){let s=this.pendingStagingBuffers[t];s.buffer.mapAsync(GPUMapMode.WRITE).then(()=>{this.stagingBuffers&&(s.onAvailable(),this.stagingBuffers.push(s))})}this.pendingStagingBuffers.length=0}}constructor(...e){super(...e),this.pendingStagingBuffers=[]}}});var nm,ow=m(()=>{XC();JC();nm=class{loseContext(){this.pastFrameAllocations.clear()}set enabled(e){this._enableRequest=e}get enabled(){return this._enableRequest}processEnableRequest(){this._enableRequest!==this._enabled&&(this._enabled=this._enableRequest,this._enabled||(this._frameTime=0))}request(e){this.pastFrameAllocations.set(e,this.frameAllocations),this.frameAllocations=[]}report(e,t){if(t){let s=this.pastFrameAllocations.get(e);if(t.length>0&&(this._frameTime=t.reduce((i,r)=>i+r,0)),au.get(yE)){let i=0;for(let r=0;r<s.length;++r)s[r],i+=t[r]}}this.pastFrameAllocations.delete(e)}getSlot(e){let t=this.frameAllocations.length;return this.frameAllocations.push(e),t}get slotCount(){return this.frameAllocations.length}constructor(){this.frameAllocations=[],this.pastFrameAllocations=new Map,this._enabled=!1,this._enableRequest=!1,this._frameTime=0}}});var yx,FN=m(()=>{yx=class{constructor(e,t,s){this.stagingBuffers=[],this.activeStagingBuffer=null,this.device=e,this.capacity=s,this.bytesPerSlot=t?8:4;let i=e.wgpu;this.querySet=i.createQuerySet({type:t?"timestamp":"occlusion",count:s}),this.queryBuffer=i.createBuffer({size:this.bytesPerSlot*s,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST})}destroy(){this.querySet?.destroy(),this.querySet=null,this.queryBuffer?.destroy(),this.queryBuffer=null,this.activeStagingBuffer=null,this.stagingBuffers.forEach(e=>{e.destroy()}),this.stagingBuffers=null}getStagingBuffer(){let e=this.stagingBuffers.pop();return e||(e=this.device.wgpu.createBuffer({size:this.queryBuffer.size,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ})),e}resolve(e){let s=this.device.getCommandEncoder();s.resolveQuerySet(this.querySet,0,e,this.queryBuffer,0);let i=this.getStagingBuffer();this.activeStagingBuffer=i,s.copyBufferToBuffer(this.queryBuffer,0,i,0,this.bytesPerSlot*e)}request(e,t){let s=this.activeStagingBuffer;return this.activeStagingBuffer=null,s.mapAsync(GPUMapMode.READ).then(()=>{let i=new BigInt64Array(s.getMappedRange()),r=[];for(let a=0;a<e;a++)r.push(Number(i[a*2+1]-i[a*2])*1e-6);return s.unmap(),this.stagingBuffers?.push(s),{renderVersion:t,timings:r}})}}});var Ax,UN=m(()=>{ow();FN();Ax=class extends nm{constructor(e){super(),this.device=e,this.timestampQueriesSet=e.supportsTimestampQuery?new yx(e,!0,512):null}destroy(){this.timestampQueriesSet?.destroy(),this.timestampQueriesSet=null}frameStart(){this.processEnableRequest()}frameEnd(){this._enabled&&this.timestampQueriesSet?.resolve(this.slotCount*2)}request(){if(this._enabled){let e=this.device.renderVersion;this.timestampQueriesSet?.request(this.slotCount,e).then(t=>{this.report(t.renderVersion,t.timings)}),super.request(e)}}}});var Px,BN=m(()=>{Th();j();Px=class{constructor(e){this.pipelineCache=new Map,this.device=e;let t=`
 
						var<private> pos : array<vec2f, 4> = array<vec2f, 4>(
								vec2(-1.0, 1.0), vec2(1.0, 1.0), vec2(-1.0, -1.0), vec2(1.0, -1.0)
						);

						struct VertexOutput {
								@builtin(position) position : vec4f,
						};

						@vertex
						fn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {
							var output : VertexOutput;
							output.position = vec4f(pos[vertexIndex], 0, 1);
							return output;
						}

						@group(0) @binding(0) var img : texture_depth_multisampled_2d;

						@fragment
						fn fragmentMain(@builtin(position) fragColor: vec4f) -> @location(0) vec4f {
								// load th depth value from sample index 0
								var depth = textureLoad(img, vec2i(fragColor.xy), 0u);
								return vec4f(depth, 0.0, 0.0, 0.0);
						}
				`;this.shader=new ai(e,{name:"WebGPUResolverDepthShader",shaderLanguage:le,vshader:t,fshader:t})}destroy(){this.shader.destroy(),this.shader=null,this.pipelineCache=null}getPipeline(e){let t=this.pipelineCache.get(e);return t||(t=this.createPipeline(e),this.pipelineCache.set(e,t)),t}createPipeline(e){let t=this.shader.impl;return this.device.wgpu.createRenderPipeline({layout:"auto",vertex:{module:t.getVertexShaderModule(),entryPoint:t.vertexEntryPoint},fragment:{module:t.getFragmentShaderModule(),entryPoint:t.fragmentEntryPoint,targets:[{format:e}]},primitive:{topology:"triangle-strip"}})}resolveDepth(e,t,s){let i=this.device,r=i.wgpu,a=this.getPipeline(s.format),n=t.depthOrArrayLayers;for(let l=0;l<n;l++){let h=t.createView({dimension:"2d",aspect:"depth-only",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:l}),c=s.createView({dimension:"2d",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:l}),f=e.beginRenderPass({colorAttachments:[{view:c,loadOp:"clear",storeOp:"store"}]}),d=r.createBindGroup({layout:a.getBindGroupLayout(0),entries:[{binding:0,resource:h}]});f.setPipeline(a),f.setBindGroup(0,d),f.draw(4),f.end()}i.pipeline=null}}});var Rx,VN=m(()=>{_h();am();Rx=class{constructor(e){this.uniformBuffers=[],this.bindGroup=null,this.compute=e;let{device:t,shader:s}=e,{computeBindGroupFormat:i,computeUniformBufferFormats:r}=s.impl;if(this.bindGroup=new ji(t,i),r){for(let a in r)if(r.hasOwnProperty(a)){let n=new da(t,r[a],!0);this.uniformBuffers.push(n),this.bindGroup.setUniformBuffer(a,n)}}this.pipeline=t.computePipeline.get(s,i)}destroy(){this.uniformBuffers.forEach(e=>e.destroy()),this.uniformBuffers.length=0,this.bindGroup.destroy(),this.bindGroup=null}updateBindGroup(){let{bindGroup:e}=this;e.updateUniformBuffers(),e.update()}dispatch(e,t,s){let i=this.compute.device;i.setBindGroup(0,this.bindGroup);let r=i.passEncoder;r.setPipeline(this.pipeline),r.dispatchWorkgroups(e,t,s)}}});var Dre,om,lw=m(()=>{Dre=0,om=class{constructor(e,t,s=0){this.id=Dre++,this.device=e,this.byteSize=t,this.bufferUsage=s,this.impl=e.createBufferImpl(128|s),this.impl.allocate(e,t),this.device.buffers.push(this),this.adjustVramSizeTracking(e._vram,this.byteSize)}destroy(){let e=this.device,t=e.buffers.indexOf(this);t!==-1&&e.buffers.splice(t,1),this.adjustVramSizeTracking(e._vram,-this.byteSize),this.impl.destroy(e)}adjustVramSizeTracking(e,t){e.sb+=t}read(e=0,t=this.byteSize,s=null,i=!1){return this.impl.read(this.device,e,t,s,i)}write(e=0,t,s=0,i){this.impl.write(this.device,e,t,s,i)}clear(e=0,t=this.byteSize){this.impl.clear(this.device,e,t)}}});var hw,Ore,lm,cw=m(()=>{j();mh();_h();Zu();Rt();gf();iN();aN();nN();fN();dN();mN();vN();xN();yN();AN();bN();MN();NN();UN();BN();VN();uS();lw();hw=new Map,Ore=20,lm=class extends Qe{constructor(e,t={}){super(e,t),this.renderPipeline=new Qv(this),this.computePipeline=new Jv(this),this._indirectDrawBuffer=null,this._indirectDrawBufferCount=0,this._indirectDrawNextIndex=0,this.pipeline=null,this.bindGroupFormats=[],this.commandEncoder=null,this.commandBuffers=[],this.glslang=null,this.twgsl=null,t=this.initOptions,t.alpha=t.alpha??!0,this.backBufferAntialias=t.antialias??!1,this.isWebGPU=!0,this._deviceType=Du,this.scope.resolve(uh).setValue(0)}destroy(){this.clearRenderer.destroy(),this.clearRenderer=null,this.mipmapRenderer.destroy(),this.mipmapRenderer=null,this.resolver.destroy(),this.resolver=null,super.destroy()}initDeviceCaps(){let e=this.wgpu?.limits;this.limits=e,this.precision="highp",this.maxPrecision="highp",this.maxSamples=4,this.maxTextures=16,this.maxTextureSize=e.maxTextureDimension2D,this.maxCubeMapSize=e.maxTextureDimension2D,this.maxVolumeSize=e.maxTextureDimension3D,this.maxColorAttachments=e.maxColorAttachments,this.maxPixelRatio=1,this.maxAnisotropy=16,this.fragmentUniformsCount=e.maxUniformBufferBindingSize/16,this.vertexUniformsCount=e.maxUniformBufferBindingSize/16,this.supportsUniformBuffers=!0,this.supportsAreaLights=!0,this.supportsGpuParticles=!0,this.supportsCompute=!0,this.textureFloatRenderable=!0,this.textureHalfFloatRenderable=!0,this.supportsImageBitmap=!0,this.samples=this.backBufferAntialias?4:1;let t=window.navigator.gpu.wgslLanguageFeatures;this.supportsStorageTextureRead=t?.has("readonly_and_readwrite_storage_textures"),this.initCapsDefines()}async initWebGpu(e,t){if(!window.navigator.gpu)throw new Error("Unable to retrieve GPU. Ensure you are using a browser that supports WebGPU rendering.");if(e&&t){let s=r=>new URL(r,window.location.href).toString(),i=await Promise.all([import(`${s(t)}`).then(r=>twgsl(t.replace(".js",".wasm"))),import(`${s(e)}`).then(r=>r.default())]);this.twgsl=i[0],this.glslang=i[1]}return this.createDevice()}async createDevice(){let e={powerPreference:this.initOptions.powerPreference!=="default"?this.initOptions.powerPreference:void 0,xrCompatible:this.initOptions.xrCompatible};this.gpuAdapter=await window.navigator.gpu.requestAdapter(e);let t=[],s=c=>{let f=this.gpuAdapter.features.has(c);return f&&t.push(c),f};this.textureFloatFilterable=s("float32-filterable"),this.textureFloatBlendable=s("float32-blendable"),this.extCompressedTextureS3TC=s("texture-compression-bc"),this.extCompressedTextureETC=s("texture-compression-etc2"),this.extCompressedTextureASTC=s("texture-compression-astc"),this.supportsTimestampQuery=s("timestamp-query"),this.supportsDepthClip=s("depth-clip-control"),this.supportsDepth32Stencil=s("depth32float-stencil8"),this.supportsIndirectFirstInstance=s("indirect-first-instance"),this.supportsShaderF16=s("shader-f16"),this.supportsStorageRGBA8=s("bgra8unorm-storage"),this.textureRG11B10Renderable=s("rg11b10ufloat-renderable"),this.supportsClipDistances=s("clip-distances");let i=this.gpuAdapter?.limits,r={};if(i)for(let c in i)c==="minSubgroupSize"||c==="maxSubgroupSize"||(r[c]=i[c]);let a={requiredFeatures:t,requiredLimits:r,defaultQueue:{label:"Default Queue"}};this.wgpu=await this.gpuAdapter.requestDevice(a),this.wgpu.lost?.then(this.handleDeviceLost.bind(this)),this.initDeviceCaps(),this.gpuContext=this.canvas.getContext("webgpu");let n="standard",l=window.navigator.gpu.getPreferredCanvasFormat(),h=this.initOptions.displayFormat;return this.backBufferFormat=l==="rgba8unorm"?h===mf?20:7:h===mf?64:31,this.backBufferViewFormat=h===mf?`${l}-srgb`:l,h===Gv&&this.textureFloatFilterable&&window.matchMedia("(dynamic-range: high)")?.matches&&(this.backBufferFormat=12,this.backBufferViewFormat="rgba16float",l="rgba16float",this.isHdr=!0,n="extended"),this.canvasConfig={device:this.wgpu,colorSpace:"srgb",alphaMode:this.initOptions.alpha?"premultiplied":"opaque",format:l,toneMapping:{mode:n},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC|GPUTextureUsage.COPY_DST,viewFormats:h===mf?[this.backBufferViewFormat]:[]},this.gpuContext?.configure(this.canvasConfig),this.createBackbuffer(),this.clearRenderer=new Sx(this),this.mipmapRenderer=new Tx(this),this.resolver=new Px(this),this.postInit(),this}async handleDeviceLost(e){e.reason!=="destroyed"&&(super.loseContext(),await this.createDevice(),super.restoreContext())}postInit(){super.postInit(),this.initializeRenderState(),this.setupPassEncoderDefaults(),this.gpuProfiler=new Ax(this),this.dynamicBuffers=new xx(this,100*1024,this.limits.minUniformBufferOffsetAlignment),this.emptyBindGroup=new ji(this,new _i(this,[])),this.emptyBindGroup.update()}createBackbuffer(){this.supportsStencil=this.initOptions.stencil,this.backBuffer=new xe({name:"WebgpuFramebuffer",graphicsDevice:this,depth:this.initOptions.depth,stencil:this.supportsStencil,samples:this.samples}),this.backBuffer.impl.isBackbuffer=!0}frameStart(){super.frameStart(),this.gpuProfiler.frameStart(),this.submit();let e=this.gpuContext?.getCurrentTexture?.()??this.externalBackbuffer?.impl.gpuTexture;(this.backBufferSize.x!==e.width||this.backBufferSize.y!==e.height)&&(this.backBufferSize.set(e.width,e.height),this.backBuffer.destroy(),this.backBuffer=null,this.createBackbuffer());let t=this.backBuffer,s=t.impl;s.setColorAttachment(0,void 0,this.backBufferViewFormat),this.initRenderTarget(t),s.assignColorTexture(this,e)}frameEnd(){super.frameEnd(),this.gpuProfiler.frameEnd(),this.submit(),this.contextLost||this.gpuProfiler.request(),this._indirectDrawNextIndex=0}createBufferImpl(e){return new Jn(e)}createUniformBufferImpl(e){return new lx(e)}createVertexBufferImpl(e,t,s){return new hx(e,t,s)}createIndexBufferImpl(e,t){return new jv(e,t)}createShaderImpl(e){return new nx(e)}createTextureImpl(e){return new ox(e)}createRenderTargetImpl(e){return new sx(e)}createBindGroupFormatImpl(e){return new qv(e)}createBindGroupImpl(e){return new Kv}createComputeImpl(e){return new Rx(e)}get indirectDrawBuffer(){return this.allocateIndirectDrawBuffer(),this._indirectDrawBuffer}allocateIndirectDrawBuffer(){this._indirectDrawNextIndex===0&&this._indirectDrawBufferCount<this.maxIndirectDrawCount&&(this._indirectDrawBuffer?.destroy(),this._indirectDrawBuffer=null),this._indirectDrawBuffer===null&&(this._indirectDrawBuffer=new om(this,this.maxIndirectDrawCount*4,264),this._indirectDrawBufferCount=this.maxIndirectDrawCount)}getIndirectDrawSlot(){this.allocateIndirectDrawBuffer();let e=this._indirectDrawNextIndex;return this._indirectDrawNextIndex++,e}setBindGroup(e,t,s){this.passEncoder&&(this.passEncoder.setBindGroup(e,t.impl.bindGroup,s??t.uniformBufferOffsets),this.bindGroupFormats[e]=t.format.impl)}submitVertexBuffer(e,t){let s=e.format,{interleaved:i,elements:r}=s,a=r.length,n=e.impl.buffer;if(i)return this.passEncoder.setVertexBuffer(t,n),1;for(let l=0;l<a;l++)this.passEncoder.setVertexBuffer(t+l,n,r[l].offset);return a}validateVBLocations(e,t){let s=i=>{let{elements:r}=i.format;for(let a=0;a<r.length;a++){let n=r[a].name,l=Be[n];hw.has(l),hw.set(l,n)}};s(e),s(t),hw.clear()}draw(e,t,s=1,i,r=!0,a=!0){if(this.shader.ready&&!this.shader.failed){let n=this.passEncoder,l=this.pipeline,h=this.vertexBuffers[0],c=this.vertexBuffers[1];if(r){if(h){let f=this.submitVertexBuffer(h,0);c&&this.submitVertexBuffer(c,f)}l=this.renderPipeline.get(e,h?.format,c?.format,t?.format,this.shader,this.renderTarget,this.bindGroupFormats,this.blendState,this.depthState,this.cullMode,this.stencilEnabled,this.stencilFront,this.stencilBack),this.pipeline!==l&&(this.pipeline=l,n.setPipeline(l))}if(t&&n.setIndexBuffer(t.impl.buffer,t.impl.format),i!==void 0){let f=i*Ore,d=this.indirectDrawBuffer.impl.buffer;t?n.drawIndexedIndirect(d,f):n.drawIndirect(d,f)}else t?n.drawIndexed(e.count,s,e.base,e.baseVertex??0,0):n.draw(e.count,s,e.base,0)}a&&(this.clearVertexBuffer(),this.pipeline=null)}setShader(e,t=!1){e!==this.shader&&(this.shader=e)}setBlendState(e){this.blendState.copy(e)}setDepthState(e){this.depthState.copy(e)}setStencilState(e,t){if(e||t){this.stencilEnabled=!0,this.stencilFront.copy(e??ws.DEFAULT),this.stencilBack.copy(t??ws.DEFAULT);let s=this.stencilFront.ref;this.stencilRef!==s&&(this.stencilRef=s,this.passEncoder.setStencilReference(s))}else this.stencilEnabled=!1}setBlendColor(e,t,s,i){let r=this.blendColor;(e!==r.r||t!==r.g||s!==r.b||i!==r.a)&&(r.set(e,t,s,i),this.passEncoder.setBlendConstant(r))}setCullMode(e){this.cullMode=e}setAlphaToCoverage(e){}initializeContextCaches(){super.initializeContextCaches()}setupPassEncoderDefaults(){this.pipeline=null,this.stencilRef=0,this.blendColor.set(0,0,0,0)}_uploadDirtyTextures(){this.textures.forEach(e=>{(e._needsUpload||e._needsMipmaps)&&e.upload()})}setupTimeStampWrites(e,t){if(this.gpuProfiler._enabled&&this.gpuProfiler.timestampQueriesSet){let s=this.gpuProfiler.getSlot(t);e=e??{},e.timestampWrites={querySet:this.gpuProfiler.timestampQueriesSet.querySet,beginningOfPassWriteIndex:s*2,endOfPassWriteIndex:s*2+1}}return e}startRenderPass(e){this._uploadDirtyTextures();let t=e.renderTarget||this.backBuffer;this.renderTarget=t;let s=t.impl;t!==this.backBuffer&&this.initRenderTarget(t),s.setupForRenderPass(e,t);let i=s.renderPassDescriptor;this.setupTimeStampWrites(i,e.name);let r=this.getCommandEncoder();this.passEncoder=r.beginRenderPass(i),this.passEncoder.label=`${e.name}-PassEncoder RT:${t.name}`,this.setupPassEncoderDefaults();let{width:a,height:n}=t;this.setViewport(0,0,a,n),this.setScissor(0,0,a,n),this.insideRenderPass=!0}endRenderPass(e){this.passEncoder.end(),this.passEncoder=null,this.insideRenderPass=!1,this.bindGroupFormats.length=0;let t=this.renderTarget;if(t&&t.depthBuffer&&e.depthStencilOps.resolveDepth&&e.samples>1&&t.autoResolve){let s=t.impl.depthAttachment,i=t.depthBuffer.impl.gpuTexture;s&&i&&this.resolver.resolveDepth(this.commandEncoder,s.multisampledDepthBuffer,i)}for(let s=0;s<e.colorArrayOps.length;s++)e.colorArrayOps[s].genMipmaps&&this.mipmapRenderer.generate(e.renderTarget._colorBuffers[s].impl)}startComputePass(e){this.pipeline=null;let t=this.setupTimeStampWrites(void 0,e),s=this.getCommandEncoder();this.passEncoder=s.beginComputePass(t),this.insideRenderPass=!0}endComputePass(){this.passEncoder.end(),this.passEncoder=null,this.insideRenderPass=!1,this.bindGroupFormats.length=0}computeDispatch(e,t="Unnamed"){this.startComputePass(t);for(let s=0;s<e.length;s++){let i=e[s];i.applyParameters(),i.impl.updateBindGroup()}for(let s=0;s<e.length;s++){let i=e[s];i.impl.dispatch(i.countX,i.countY,i.countZ)}this.endComputePass()}getCommandEncoder(){let e=this.commandEncoder;return e||(e=this.wgpu.createCommandEncoder(),this.commandEncoder=e),e}endCommandEncoder(){let{commandEncoder:e}=this;if(e){let t=e.finish();this.addCommandBuffer(t),this.commandEncoder=null}}addCommandBuffer(e,t=!1){t?this.commandBuffers.unshift(e):this.commandBuffers.push(e)}submit(){this.endCommandEncoder(),this.commandBuffers.length>0&&(this.dynamicBuffers.submit(),this.wgpu.queue.submit(this.commandBuffers),this.commandBuffers.length=0,this.dynamicBuffers.onCommandBuffersSubmitted())}clear(e){e.flags&&this.clearRenderer.clear(this,this.renderTarget,e,this.defaultClearOptions)}setViewport(e,t,s,i){this.passEncoder&&(this.renderTarget.flipY||(t=this.renderTarget.height-t-i),this.vx=e,this.vy=t,this.vw=s,this.vh=i,this.passEncoder.setViewport(e,t,s,i,0,1))}setScissor(e,t,s,i){this.passEncoder&&(this.renderTarget.flipY||(t=this.renderTarget.height-t-i),this.sx=e,this.sy=t,this.sw=s,this.sh=i,this.passEncoder.setScissorRect(e,t,s,i))}clearStorageBuffer(e,t=0,s=e.byteSize){this.getCommandEncoder().clearBuffer(e.buffer,t,s)}readStorageBuffer(e,t=0,s=e.byteSize-t,i=null,r=!1){let a=this.createBufferImpl(9);a.allocate(this,s);let n=a.buffer;return this.getCommandEncoder().copyBufferToBuffer(e.buffer,t,n,0,s),this.readBuffer(a,s,i,r)}readBuffer(e,t,s=null,i=!1){let r=e.buffer;return new Promise((a,n)=>{let l=()=>{r?.mapAsync(GPUMapMode.READ).then(()=>{s??=new Uint8Array(t);let h=r.getMappedRange(0,t),c=s.constructor;s.set(new c(h)),r.unmap(),e.destroy(this),a(s)})};i?(this.submit(),l()):setTimeout(()=>{l()})})}writeStorageBuffer(e,t=0,s,i=0,r){this.wgpu.queue.writeBuffer(e.buffer,t,s,i,r)}copyRenderTarget(e,t,s,i){let r={width:e?e.width:t.width,height:e?e.height:t.height,depthOrArrayLayers:1},a=this.getCommandEncoder();if(s){let n={texture:e?e.colorBuffer.impl.gpuTexture:this.backBuffer.impl.assignedColorTexture,mipLevel:0},l={texture:t?t.colorBuffer.impl.gpuTexture:this.backBuffer.impl.assignedColorTexture,mipLevel:0};a.copyTextureToTexture(n,l,r)}if(i){let l=(e||this.renderTarget).impl.depthAttachment.depthTexture;if(e.samples>1){let h=t.colorBuffer.impl.gpuTexture;this.resolver.resolveDepth(a,l,h)}else{let h=t?t.depthBuffer.impl.gpuTexture:this.renderTarget.impl.depthAttachment.depthTexture,c={texture:l,mipLevel:0},f={texture:h,mipLevel:0};a.copyTextureToTexture(c,f,r)}}return!0}}});var hm,fw=m(()=>{hm=class{destroy(e){this.bufferId&&(e.gl.deleteBuffer(this.bufferId),this.bufferId=null)}get initialized(){return!!this.bufferId}loseContext(){this.bufferId=null}unlock(e,t,s,i){let r=e.gl;if(this.bufferId)r.bindBuffer(s,this.bufferId),r.bufferSubData(s,0,i);else{let a;switch(t){case 0:a=r.STATIC_DRAW;break;case 1:a=r.DYNAMIC_DRAW;break;case 2:a=r.STREAM_DRAW;break;case 3:a=r.DYNAMIC_COPY;break}this.bufferId=r.createBuffer(),r.bindBuffer(s,this.bufferId),r.bufferData(s,i,a)}}constructor(){this.bufferId=null}}});var Cx,kN=m(()=>{fw();Cx=class extends hm{destroy(e){super.destroy(e),e.unbindVertexArray()}loseContext(){super.loseContext(),this.vao=null}unlock(e){let t=e.device;super.unlock(t,e.usage,t.gl.ARRAY_BUFFER,e.storage)}constructor(...e){super(...e),this.vao=null}}});var Ix,GN=m(()=>{fw();Ix=class extends hm{constructor(e){super();let t=e.device.gl,s=e.format;s===0?this.glFormat=t.UNSIGNED_BYTE:s===1?this.glFormat=t.UNSIGNED_SHORT:s===2&&(this.glFormat=t.UNSIGNED_INT)}unlock(e){let t=e.device;super.unlock(t,e.usage,t.gl.ELEMENT_ARRAY_BUFFER,e.storage)}}});var wx,zN=m(()=>{II();j();wx=class{constructor(e,t,s,i){if(this.locationId=i,this.scopeId=e.scope.resolve(t),this.version=new Ku,t.substring(t.length-3)==="[0]")switch(s){case Ht:s=kn;break;case Yi:s=oa;break;case ia:s=Hn;break;case za:s=Xn;break;case Ki:s=Gn;break;case yr:s=la;break;case ra:s=Wn;break;case Un:s=Yn;break;case fs:s=zn;break;case Ar:s=ha;break;case aa:s=Kn;break;case Bn:s=qn;break;case qi:s=lh;break;case Pr:s=Wo;break;case na:s=hh;break;case Vn:s=ch;break}this.dataType=s,this.value=[null,null,null,null],this.array=[]}}});var Nre,dw,Fre,Ure,Lx,HN=m(()=>{zN();j();bi();Nre=new Set(["gl_VertexID","gl_InstanceID","gl_DrawID","gl_BaseVertex","gl_BaseInstance"]),dw=class{destroy(e){this.map.forEach(t=>{e.gl.deleteShader(t)})}loseContext(e){this.map.clear()}constructor(){this.map=new Map}},Fre=new st,Ure=new st,Lx=class{constructor(e){this.compileDuration=0,this.init(),this.compile(e.device,e),this.link(e.device,e),e.device.shaders.push(e)}destroy(e){this.glProgram&&(e.device.gl.deleteProgram(this.glProgram),this.glProgram=null)}init(){this.uniforms=[],this.samplers=[],this.attributes=[],this.glProgram=null,this.glVertexShader=null,this.glFragmentShader=null}loseContext(){this.init()}restoreContext(e,t){this.compile(e,t),this.link(e,t)}compile(e,t){let s=t.definition;this.glVertexShader=this._compileShaderSource(e,s.vshader,!0),this.glFragmentShader=this._compileShaderSource(e,s.fshader,!1)}link(e,t){if(this.glProgram)return;let s=e.gl;if(s.isContextLost())return;let i=s.createProgram();this.glProgram=i,s.attachShader(i,this.glVertexShader),s.attachShader(i,this.glFragmentShader);let r=t.definition,a=r.attributes;if(r.useTransformFeedback){let n=[];for(let l in a)a.hasOwnProperty(l)&&n.push(`out_${l}`);s.transformFeedbackVaryings(i,n,s.INTERLEAVED_ATTRIBS)}for(let n in a)if(a.hasOwnProperty(n)){let l=a[n],h=Be[l];s.bindAttribLocation(i,h,n)}s.linkProgram(i)}_compileShaderSource(e,t,s){let i=e.gl;if(i.isContextLost())return null;let a=(s?Fre:Ure).get(e,()=>new dw),n=a.map.get(t);return n||(n=i.createShader(s?i.VERTEX_SHADER:i.FRAGMENT_SHADER),i.shaderSource(n,t),i.compileShader(n),a.map.set(t,n)),n}finalize(e,t){let s=e.gl;if(s.isContextLost())return!0;let i=this.glProgram,r=t.definition;if(!s.getProgramParameter(i,s.LINK_STATUS)){if(!this._isCompiled(e,t,this.glVertexShader,r.vshader,"vertex")||!this._isCompiled(e,t,this.glFragmentShader,r.fshader,"fragment"))return!1;let c=`Failed to link shader program. Error: ${s.getProgramInfoLog(i)}`;return console.error(c),!1}let n=s.getProgramParameter(i,s.ACTIVE_ATTRIBUTES);t.attributes.clear();for(let c=0;c<n;c++){let f=s.getActiveAttrib(i,c),d=s.getAttribLocation(i,f.name);Nre.has(f.name)||(r.attributes[f.name]===void 0?(console.error(`Vertex shader attribute "${f.name}" is not mapped to a semantic in shader definition, shader [${t.label}]`,t),t.failed=!0):t.attributes.set(d,f.name))}let l=e._samplerTypes,h=s.getProgramParameter(i,s.ACTIVE_UNIFORMS);for(let c=0;c<h;c++){let f=s.getActiveUniform(i,c),d=s.getUniformLocation(i,f.name),u=new wx(e,f.name,e.pcUniformType[f.type],d);l.has(f.type)?this.samplers.push(u):this.uniforms.push(u)}return t.ready=!0,!0}_isCompiled(e,t,s,i,r){let a=e.gl;if(!a.getShaderParameter(s,a.COMPILE_STATUS)){let n=a.getShaderInfoLog(s),[l,h]=this._processError(i,n),c=`Failed to compile ${r} shader:

${n}
${l} while rendering undefined`;return console.error(c),!1}return!0}isLinked(e){let{extParallelShaderCompile:t}=e;return t?e.gl.getProgramParameter(this.glProgram,t.COMPLETION_STATUS_KHR):!0}_processError(e,t){let s={},i="";if(e){let r=e.split(`
`),a=0,n=r.length;if(t&&t.startsWith("ERROR:")){let l=t.match(/^ERROR:\s(\d+):(\d+):\s*(.+)/);l&&(s.message=l[3],s.line=parseInt(l[2],10),a=Math.max(0,s.line-6),n=Math.min(r.length,s.line+5))}for(let l=a;l<n;l++){let h=l+1===s.line?"> ":"  ";i+=`${h}${l+1}:	${r[l]}
`}s.source=e}return[i,s]}}});function XN(o,e){let t=o.width,s=o.height;if(t>e||s>e){let i=e/Math.max(t,s),r=Math.floor(t*i),a=Math.floor(s*i),n=document.createElement("canvas");return n.width=r,n.height=a,n.getContext("2d").drawImage(o,0,0,t,s,0,0,r,a),n}return o}var bx,WN=m(()=>{bx=class{constructor(e){this._glTexture=null,this.dirtyParameterFlags=0,this.texture=e}destroy(e){if(this._glTexture){for(let t=0;t<e.textureUnits.length;t++){let s=e.textureUnits[t];for(let i=0;i<s.length;i++)s[i]===this._glTexture&&(s[i]=null)}e.gl.deleteTexture(this._glTexture),this._glTexture=null}}loseContext(){this._glTexture=null}propertyChanged(e){this.dirtyParameterFlags|=e}initialize(e,t){let s=e.gl;switch(this._glTexture=s.createTexture(),this._glTarget=t._cubemap?s.TEXTURE_CUBE_MAP:t._volume?s.TEXTURE_3D:t.array?s.TEXTURE_2D_ARRAY:s.TEXTURE_2D,t._format){case 0:this._glFormat=s.ALPHA,this._glInternalFormat=s.ALPHA,this._glPixelType=s.UNSIGNED_BYTE;break;case 1:this._glFormat=s.LUMINANCE,this._glInternalFormat=s.LUMINANCE,this._glPixelType=s.UNSIGNED_BYTE;break;case 2:this._glFormat=s.LUMINANCE_ALPHA,this._glInternalFormat=s.LUMINANCE_ALPHA,this._glPixelType=s.UNSIGNED_BYTE;break;case 52:this._glFormat=s.RED,this._glInternalFormat=s.R8,this._glPixelType=s.UNSIGNED_BYTE;break;case 53:this._glFormat=s.RG,this._glInternalFormat=s.RG8,this._glPixelType=s.UNSIGNED_BYTE;break;case 3:this._glFormat=s.RGB,this._glInternalFormat=s.RGB565,this._glPixelType=s.UNSIGNED_SHORT_5_6_5;break;case 4:this._glFormat=s.RGBA,this._glInternalFormat=s.RGB5_A1,this._glPixelType=s.UNSIGNED_SHORT_5_5_5_1;break;case 5:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA4,this._glPixelType=s.UNSIGNED_SHORT_4_4_4_4;break;case 6:this._glFormat=s.RGB,this._glInternalFormat=s.RGB8,this._glPixelType=s.UNSIGNED_BYTE;break;case 7:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA8,this._glPixelType=s.UNSIGNED_BYTE;break;case 31:case 64:break;case 8:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTextureS3TC.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case 9:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case 10:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case 21:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTextureETC1.COMPRESSED_RGB_ETC1_WEBGL;break;case 24:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;break;case 25:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;break;case 26:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;break;case 27:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;break;case 22:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_RGB8_ETC2;break;case 23:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_RGBA8_ETC2_EAC;break;case 28:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureASTC.COMPRESSED_RGBA_ASTC_4x4_KHR;break;case 29:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTextureATC.COMPRESSED_RGB_ATC_WEBGL;break;case 30:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureATC.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL;break;case 65:this._glFormat=s.RGB,this._glInternalFormat=e.extTextureCompressionBPTC.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT;break;case 66:this._glFormat=s.RGB,this._glInternalFormat=e.extTextureCompressionBPTC.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT;break;case 67:this._glFormat=s.RGBA,this._glInternalFormat=e.extTextureCompressionBPTC.COMPRESSED_RGBA_BPTC_UNORM_EXT;break;case 54:this._glFormat=s.SRGB,this._glInternalFormat=e.extCompressedTextureS3TC_SRGB.COMPRESSED_SRGB_S3TC_DXT1_EXT;break;case 55:this._glFormat=s.SRGB_ALPHA,this._glInternalFormat=e.extCompressedTextureS3TC_SRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;break;case 56:this._glFormat=s.SRGB_ALPHA,this._glInternalFormat=e.extCompressedTextureS3TC_SRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;break;case 61:this._glFormat=s.SRGB,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_SRGB8_ETC2;break;case 62:this._glFormat=s.SRGB_ALPHA,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;break;case 63:this._glFormat=s.SRGB_ALPHA,this._glInternalFormat=e.extCompressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 68:this._glFormat=s.RGBA,this._glInternalFormat=e.extTextureCompressionBPTC.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 50:this._glFormat=s.RED,this._glInternalFormat=s.R16F,this._glPixelType=s.HALF_FLOAT;break;case 51:this._glFormat=s.RG,this._glInternalFormat=s.RG16F,this._glPixelType=s.HALF_FLOAT;break;case 11:this._glFormat=s.RGB,this._glInternalFormat=s.RGB16F,this._glPixelType=s.HALF_FLOAT;break;case 12:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA16F,this._glPixelType=s.HALF_FLOAT;break;case 13:this._glFormat=s.RGB,this._glInternalFormat=s.RGB32F,this._glPixelType=s.FLOAT;break;case 14:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA32F,this._glPixelType=s.FLOAT;break;case 15:this._glFormat=s.RED,this._glInternalFormat=s.R32F,this._glPixelType=s.FLOAT;break;case 16:this._glFormat=s.DEPTH_COMPONENT,this._glInternalFormat=s.DEPTH_COMPONENT32F,this._glPixelType=s.FLOAT;break;case 69:this._glFormat=s.DEPTH_COMPONENT,this._glInternalFormat=s.DEPTH_COMPONENT16,this._glPixelType=s.UNSIGNED_SHORT;break;case 17:this._glFormat=s.DEPTH_STENCIL,this._glInternalFormat=s.DEPTH24_STENCIL8,this._glPixelType=s.UNSIGNED_INT_24_8;break;case 18:this._glFormat=s.RGB,this._glInternalFormat=s.R11F_G11F_B10F,this._glPixelType=s.UNSIGNED_INT_10F_11F_11F_REV;break;case 19:this._glFormat=s.RGB,this._glInternalFormat=s.SRGB8,this._glPixelType=s.UNSIGNED_BYTE;break;case 20:this._glFormat=s.RGBA,this._glInternalFormat=s.SRGB8_ALPHA8,this._glPixelType=s.UNSIGNED_BYTE;break;case 32:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R8I,this._glPixelType=s.BYTE;break;case 33:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R8UI,this._glPixelType=s.UNSIGNED_BYTE;break;case 34:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R16I,this._glPixelType=s.SHORT;break;case 35:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R16UI,this._glPixelType=s.UNSIGNED_SHORT;break;case 36:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R32I,this._glPixelType=s.INT;break;case 37:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R32UI,this._glPixelType=s.UNSIGNED_INT;break;case 38:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG8I,this._glPixelType=s.BYTE;break;case 39:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG8UI,this._glPixelType=s.UNSIGNED_BYTE;break;case 40:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG16I,this._glPixelType=s.SHORT;break;case 41:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG16UI,this._glPixelType=s.UNSIGNED_SHORT;break;case 42:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG32I,this._glPixelType=s.INT;break;case 43:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG32UI,this._glPixelType=s.UNSIGNED_INT;break;case 44:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA8I,this._glPixelType=s.BYTE;break;case 45:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA8UI,this._glPixelType=s.UNSIGNED_BYTE;break;case 46:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA16I,this._glPixelType=s.SHORT;break;case 47:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA16UI,this._glPixelType=s.UNSIGNED_SHORT;break;case 48:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA32I,this._glPixelType=s.INT;break;case 49:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA32UI,this._glPixelType=s.UNSIGNED_INT;break}this._glCreated=!1}upload(e,t){let s=e.gl;if(!t._needsUpload&&(t._needsMipmapsUpload&&t._mipmapsUploaded||!t.pot))return;let i=0,r,a,n=t.numLevels;for(t.array&&s.texStorage3D(s.TEXTURE_2D_ARRAY,n,this._glInternalFormat,t._width,t._height,t._arrayLength);t._levels[i]||i===0;){if(!t._needsUpload&&i===0){i++;continue}else if(i&&(!t._needsMipmapsUpload||!t._mipmaps))break;if(r=t._levels[i],a=1/Math.pow(2,i),i===1&&!t._compressed&&!t._integerFormat&&t._levels.length<n&&(s.generateMipmap(this._glTarget),t._mipmapsUploaded=!0),t._cubemap){let l;if(e._isBrowserInterface(r[0]))for(l=0;l<6;l++){if(!t._levelsUpdated[0][l])continue;let h=r[l];e._isImageBrowserInterface(h)&&(h.width>e.maxCubeMapSize||h.height>e.maxCubeMapSize)&&(h=XN(h,e.maxCubeMapSize),i===0&&(t._width=h.width,t._height=h.height)),e.setUnpackFlipY(!1),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated?s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,i,0,0,this._glFormat,this._glPixelType,h):s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,i,this._glInternalFormat,this._glFormat,this._glPixelType,h)}else for(a=1/Math.pow(2,i),l=0;l<6;l++){if(!t._levelsUpdated[0][l])continue;let h=r[l];t._compressed?this._glCreated&&h?s.compressedTexSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,i,0,0,Math.max(t._width*a,1),Math.max(t._height*a,1),this._glInternalFormat,h):s.compressedTexImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,i,this._glInternalFormat,Math.max(t._width*a,1),Math.max(t._height*a,1),0,h):(e.setUnpackFlipY(!1),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated&&h?s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,i,0,0,Math.max(t._width*a,1),Math.max(t._height*a,1),this._glFormat,this._glPixelType,h):s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,i,this._glInternalFormat,Math.max(t._width*a,1),Math.max(t._height*a,1),0,this._glFormat,this._glPixelType,h))}}else if(t._volume)t._compressed?s.compressedTexImage3D(s.TEXTURE_3D,i,this._glInternalFormat,Math.max(t._width*a,1),Math.max(t._height*a,1),Math.max(t._depth*a,1),0,r):(e.setUnpackFlipY(!1),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),s.texImage3D(s.TEXTURE_3D,i,this._glInternalFormat,Math.max(t._width*a,1),Math.max(t._height*a,1),Math.max(t._depth*a,1),0,this._glFormat,this._glPixelType,r));else if(t.array&&typeof r=="object"){if(t._arrayLength===r.length)if(t._compressed)for(let l=0;l<t._arrayLength;l++)s.compressedTexSubImage3D(s.TEXTURE_2D_ARRAY,i,0,0,l,Math.max(Math.floor(t._width*a),1),Math.max(Math.floor(t._height*a),1),1,this._glInternalFormat,r[l]);else for(let l=0;l<t._arrayLength;l++)s.texSubImage3D(s.TEXTURE_2D_ARRAY,i,0,0,l,Math.max(Math.floor(t._width*a),1),Math.max(Math.floor(t._height*a),1),1,this._glFormat,this._glPixelType,r[l])}else{if(e._isBrowserInterface(r)){e._isImageBrowserInterface(r)&&(r.width>e.maxTextureSize||r.height>e.maxTextureSize)&&(r=XN(r,e.maxTextureSize),i===0&&(t._width=r.width,t._height=r.height));let l=r.width||r.videoWidth,h=r.height||r.videoHeight;e.setUnpackFlipY(t._flipY),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated&&t._width===l&&t._height===h&&!e._isImageVideoInterface(r)?s.texSubImage2D(s.TEXTURE_2D,i,0,0,this._glFormat,this._glPixelType,r):(s.texImage2D(s.TEXTURE_2D,i,this._glInternalFormat,this._glFormat,this._glPixelType,r),i===0&&(t._width=l,t._height=h))}else a=1/Math.pow(2,i),t._compressed?this._glCreated&&r?s.compressedTexSubImage2D(s.TEXTURE_2D,i,0,0,Math.max(Math.floor(t._width*a),1),Math.max(Math.floor(t._height*a),1),this._glInternalFormat,r):s.compressedTexImage2D(s.TEXTURE_2D,i,this._glInternalFormat,Math.max(Math.floor(t._width*a),1),Math.max(Math.floor(t._height*a),1),0,r):(e.setUnpackFlipY(!1),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated&&r?s.texSubImage2D(s.TEXTURE_2D,i,0,0,Math.max(t._width*a,1),Math.max(t._height*a,1),this._glFormat,this._glPixelType,r):s.texImage2D(s.TEXTURE_2D,i,this._glInternalFormat,Math.max(t._width*a,1),Math.max(t._height*a,1),0,this._glFormat,this._glPixelType,r));i===0?t._mipmapsUploaded=!1:t._mipmapsUploaded=!0}i++}if(t._needsUpload)if(t._cubemap)for(let l=0;l<6;l++)t._levelsUpdated[0][l]=!1;else t._levelsUpdated[0]=!1;!t._compressed&&!t._integerFormat&&t._mipmaps&&t._needsMipmapsUpload&&t._levels.length===1&&(s.generateMipmap(this._glTarget),t._mipmapsUploaded=!0),t._gpuSize&&t.adjustVramSizeTracking(e._vram,-t._gpuSize),t._gpuSize=t.gpuSize,t.adjustVramSizeTracking(e._vram,t._gpuSize),this._glCreated=!0}read(e,t,s,i,r){let a=this.texture;return a.device.readTextureAsync(a,e,t,s,i,r)}write(e,t,s,i,r){let{texture:a}=this,{device:n}=a;return n.setTexture(a,0),n.writeTextureAsync(a,e,t,s,i,r)}}});var uw,Mx,YN=m(()=>{UI();uw=class{constructor(e,t){this.msaaFB=e,this.resolveFB=t}destroy(e){this.msaaFB&&(e.deleteRenderbuffer(this.msaaFB),this.msaaFB=null),this.resolveFB&&(e.deleteRenderbuffer(this.resolveFB),this.resolveFB=null)}},Mx=class{destroy(e){let t=e.gl;this._isInitialized=!1,this._glFrameBuffer&&(this._glFrameBuffer!==this.suppliedColorFramebuffer&&t.deleteFramebuffer(this._glFrameBuffer),this._glFrameBuffer=null),this._glDepthBuffer&&(t.deleteRenderbuffer(this._glDepthBuffer),this._glDepthBuffer=null),this._glResolveFrameBuffer&&(this._glResolveFrameBuffer!==this.suppliedColorFramebuffer&&t.deleteFramebuffer(this._glResolveFrameBuffer),this._glResolveFrameBuffer=null),this._glMsaaColorBuffers.forEach(s=>{t.deleteRenderbuffer(s)}),this._glMsaaColorBuffers.length=0,this.colorMrtFramebuffers?.forEach(s=>{s.destroy(t)}),this.colorMrtFramebuffers=null,this._glMsaaDepthBuffer&&(this._glMsaaDepthBuffer=null,this.msaaDepthBufferKey&&Sf(e).release(this.msaaDepthBufferKey)),this.suppliedColorFramebuffer=void 0}get initialized(){return this._isInitialized}init(e,t){let s=e.gl;this._isInitialized=!0;let i=[];if(this.suppliedColorFramebuffer!==void 0)this._glFrameBuffer=this.suppliedColorFramebuffer;else{this._glFrameBuffer=s.createFramebuffer(),e.setFramebuffer(this._glFrameBuffer);let r=t._colorBuffers?.length??0,a=s.COLOR_ATTACHMENT0;for(let l=0;l<r;++l){let h=t.getColorBuffer(l);h&&(h.impl._glTexture||(h._width=Math.min(h.width,e.maxRenderBufferSize),h._height=Math.min(h.height,e.maxRenderBufferSize),e.setTexture(h,0)),s.framebufferTexture2D(s.FRAMEBUFFER,a+l,h._cubemap?s.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:s.TEXTURE_2D,h.impl._glTexture,t.mipLevel),i.push(a+l))}s.drawBuffers(i);let n=t._depthBuffer;if(n||t._depth){let l=t._stencil?s.DEPTH_STENCIL_ATTACHMENT:s.DEPTH_ATTACHMENT;if(n)n.impl._glTexture||(n._width=Math.min(n.width,e.maxRenderBufferSize),n._height=Math.min(n.height,e.maxRenderBufferSize),e.setTexture(n,0)),s.framebufferTexture2D(s.FRAMEBUFFER,l,n._cubemap?s.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:s.TEXTURE_2D,t._depthBuffer.impl._glTexture,t.mipLevel);else if(!(t._samples>1)){this._glDepthBuffer||(this._glDepthBuffer=s.createRenderbuffer());let c=t._stencil?s.DEPTH24_STENCIL8:s.DEPTH_COMPONENT32F;s.bindRenderbuffer(s.RENDERBUFFER,this._glDepthBuffer),s.renderbufferStorage(s.RENDERBUFFER,c,t.width,t.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,l,s.RENDERBUFFER,this._glDepthBuffer),s.bindRenderbuffer(s.RENDERBUFFER,null)}}}if(t._samples>1){this._glResolveFrameBuffer=this._glFrameBuffer,this._glFrameBuffer=s.createFramebuffer(),e.setFramebuffer(this._glFrameBuffer);let r=t._colorBuffers?.length??0;if(this.suppliedColorFramebuffer!==void 0){let a=s.createRenderbuffer();this._glMsaaColorBuffers.push(a);let n=e.backBufferFormat===7?s.RGBA8:s.RGB8;s.bindRenderbuffer(s.RENDERBUFFER,a),s.renderbufferStorageMultisample(s.RENDERBUFFER,t._samples,n,t.width,t.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.RENDERBUFFER,a)}else for(let a=0;a<r;++a){let n=t.getColorBuffer(a);if(n){let l=s.createRenderbuffer();this._glMsaaColorBuffers.push(l),s.bindRenderbuffer(s.RENDERBUFFER,l),s.renderbufferStorageMultisample(s.RENDERBUFFER,t._samples,n.impl._glInternalFormat,t.width,t.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0+a,s.RENDERBUFFER,l)}}if(t._depth){let a=t._stencil?s.DEPTH24_STENCIL8:s.DEPTH_COMPONENT32F,n=t._stencil?s.DEPTH_STENCIL_ATTACHMENT:s.DEPTH_ATTACHMENT,l,h=t._depthBuffer;h&&(l=`${h.id}:${t.width}:${t.height}:${t._samples}:${a}:${n}`,this._glMsaaDepthBuffer=Sf(e).get(l)),this._glMsaaDepthBuffer||(this._glMsaaDepthBuffer=s.createRenderbuffer(),s.bindRenderbuffer(s.RENDERBUFFER,this._glMsaaDepthBuffer),s.renderbufferStorageMultisample(s.RENDERBUFFER,t._samples,a,t.width,t.height),this._glMsaaDepthBuffer.destroy=function(){s.deleteRenderbuffer(this)},h&&Sf(e).set(l,this._glMsaaDepthBuffer)),this.msaaDepthBufferKey=l,s.framebufferRenderbuffer(s.FRAMEBUFFER,n,s.RENDERBUFFER,this._glMsaaDepthBuffer)}r>1&&(this._createMsaaMrtFramebuffers(e,t,r),e.setFramebuffer(this._glFrameBuffer),s.drawBuffers(i))}}_createMsaaMrtFramebuffers(e,t,s){let i=e.gl;this.colorMrtFramebuffers=[];for(let r=0;r<s;++r){let a=t.getColorBuffer(r),n=i.createFramebuffer();e.setFramebuffer(n);let l=this._glMsaaColorBuffers[r];i.bindRenderbuffer(i.RENDERBUFFER,l),i.renderbufferStorageMultisample(i.RENDERBUFFER,t._samples,a.impl._glInternalFormat,t.width,t.height),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.RENDERBUFFER,l),i.drawBuffers([i.COLOR_ATTACHMENT0]);let h=i.createFramebuffer();e.setFramebuffer(h),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,a._cubemap?i.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:i.TEXTURE_2D,a.impl._glTexture,0),this.colorMrtFramebuffers[r]=new uw(n,h)}}_checkFbo(e,t,s=""){let i=e.gl;switch(i.checkFramebufferStatus(i.FRAMEBUFFER)){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:break;case i.FRAMEBUFFER_UNSUPPORTED:break}}loseContext(){this._glFrameBuffer=null,this._glDepthBuffer=null,this._glResolveFrameBuffer=null,this._glMsaaColorBuffers.length=0,this._glMsaaDepthBuffer=null,this.msaaDepthBufferKey=void 0,this.colorMrtFramebuffers=null,this.suppliedColorFramebuffer=void 0,this._isInitialized=!1}internalResolve(e,t,s,i,r){e.setScissor(0,0,i.width,i.height);let a=e.gl;a.bindFramebuffer(a.READ_FRAMEBUFFER,t),a.bindFramebuffer(a.DRAW_FRAMEBUFFER,s),a.blitFramebuffer(0,0,i.width,i.height,0,0,i.width,i.height,r,a.NEAREST)}resolve(e,t,s,i){let r=e.gl;if(this.colorMrtFramebuffers){if(s)for(let a=0;a<this.colorMrtFramebuffers.length;a++){let n=this.colorMrtFramebuffers[a];this.internalResolve(e,n.msaaFB,n.resolveFB,t,r.COLOR_BUFFER_BIT)}i&&this.internalResolve(e,this._glFrameBuffer,this._glResolveFrameBuffer,t,r.DEPTH_BUFFER_BIT)}else this.internalResolve(e,this._glFrameBuffer,this._glResolveFrameBuffer,t,(s?r.COLOR_BUFFER_BIT:0)|(i?r.DEPTH_BUFFER_BIT:0));r.bindFramebuffer(r.FRAMEBUFFER,this._glFrameBuffer)}constructor(){this._glFrameBuffer=null,this._glDepthBuffer=null,this._glResolveFrameBuffer=null,this.colorMrtFramebuffers=null,this._glMsaaColorBuffers=[],this._glMsaaDepthBuffer=null,this._isInitialized=!1}}});var mw,Dx,KN=m(()=>{ow();mw=class{destroy(e){this.queries.forEach(t=>e.deleteQuery(t)),this.queries=null}constructor(){this.queries=[]}},Dx=class extends nm{constructor(e){super(),this.freeQueries=[],this.frameQueries=[],this.previousFrameQueries=[],this.timings=[],this.device=e,this.ext=e.extDisjointTimerQuery}destroy(){this.freeQueries.forEach(e=>this.device.gl.deleteQuery(e)),this.frameQueries.forEach(e=>this.device.gl.deleteQuery(e)),this.previousFrameQueries.forEach(e=>e.destroy(this.device.gl)),this.freeQueries=null,this.frameQueries=null,this.previousFrameQueries=null}loseContext(){super.loseContext(),this.freeQueries=[],this.frameQueries=[],this.previousFrameQueries=[]}restoreContext(){this.ext=this.device.extDisjointTimerQuery}getQuery(){return this.freeQueries.pop()??this.device.gl.createQuery()}start(e){if(this.ext){let t=this.getSlot(e),s=this.getQuery();return this.frameQueries[t]=s,this.device.gl.beginQuery(this.ext.TIME_ELAPSED_EXT,s),t}}end(e){e!==void 0&&this.device.gl.endQuery(this.ext.TIME_ELAPSED_EXT)}frameStart(){this.processEnableRequest(),this._enabled&&(this.frameGPUMarkerSlot=this.start("GpuFrame"))}frameEnd(){this._enabled&&this.end(this.frameGPUMarkerSlot)}request(){if(this._enabled){let e=this.ext,t=this.device.gl,s=this.device.renderVersion,i=this.frameQueries;if(i.length>0){this.frameQueries=[];let r=new mw;r.queries=i,r.renderVersion=s,this.previousFrameQueries.push(r)}if(this.previousFrameQueries.length>0){let r=this.previousFrameQueries[0],a=r.queries,n=a[a.length-1],l=t.getQueryParameter(n,t.QUERY_RESULT_AVAILABLE),h=t.getParameter(e.GPU_DISJOINT_EXT);if(l&&!h){this.previousFrameQueries.shift();let c=this.timings;c.length=0;for(let f=0;f<a.length;f++){let d=a[f],u=t.getQueryParameter(d,t.QUERY_RESULT);c[f]=u*1e-6,this.freeQueries.push(d)}this.report(r.renderVersion,c)}h&&(this.previousFrameQueries.forEach(c=>{this.report(c.renderVersion,null),c.destroy(t)}),this.previousFrameQueries.length=0)}super.request(s)}}}});var cm,Eh,Ox=m(()=>{me();bt();De();j();Zu();Rt();Fe();kN();GN();HN();WN();YN();qt();ii();gf();KN();_f();Xv();cm=[],Eh=class extends Qe{constructor(e,t={}){super(e,t),this._defaultFramebuffer=null,this._defaultFramebufferChanged=!1,t=this.initOptions,this.updateClientRect(),this.initTextureUnits(),this.contextLost=!1,this._contextLostHandler=u=>{u.preventDefault(),this.loseContext(),this.fire("devicelost")},this._contextRestoredHandler=()=>{this.restoreContext(),this.fire("devicerestored")};let s=typeof navigator<"u"&&navigator.userAgent;if(this.forceDisableMultisampling=s&&s.includes("AppleWebKit")&&(s.includes("15.4")||s.includes("15_4")),this.forceDisableMultisampling&&(t.antialias=!1),ue.browserName==="firefox"){let p=(typeof navigator<"u"?navigator.userAgent:"").match(/Firefox\/(\d+(\.\d+)*)/),_=p?p[1]:null;if(_){let S=parseFloat(_);(ue.name==="windows"&&(S>=120||S===115)||ue.name==="android"&&S>=132)&&(t.antialias=!1)}}this.backBufferAntialias=t.antialias??!1,t.antialias=!1;let i=t.gl??e.getContext("webgl2",t);if(!i)throw new Error("WebGL not supported");this.gl=i,this.isWebGL2=!0,this._deviceType=fh,this.updateBackbufferFormat(null);let r=ue.browserName==="chrome",a=ue.browserName==="safari",n=ue.browser&&navigator.appVersion.indexOf("Mac")!==-1;this._tempEnableSafariTextureUnitWorkaround=a,this._tempMacChromeBlitFramebufferWorkaround=n&&r&&!t.alpha,e.addEventListener("webglcontextlost",this._contextLostHandler,!1),e.addEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),this.initializeContextCaches(),this.createBackbuffer(null),this.supportsImageBitmap=!a&&typeof ImageBitmap<"u",this._samplerTypes=new Set([i.SAMPLER_2D,i.SAMPLER_CUBE,i.UNSIGNED_INT_SAMPLER_2D,i.INT_SAMPLER_2D,i.SAMPLER_2D_SHADOW,i.SAMPLER_CUBE_SHADOW,i.SAMPLER_3D,i.INT_SAMPLER_3D,i.UNSIGNED_INT_SAMPLER_3D,i.SAMPLER_2D_ARRAY,i.INT_SAMPLER_2D_ARRAY,i.UNSIGNED_INT_SAMPLER_2D_ARRAY]),this.glAddress=[i.REPEAT,i.CLAMP_TO_EDGE,i.MIRRORED_REPEAT],this.glBlendEquation=[i.FUNC_ADD,i.FUNC_SUBTRACT,i.FUNC_REVERSE_SUBTRACT,i.MIN,i.MAX],this.glBlendFunctionColor=[i.ZERO,i.ONE,i.SRC_COLOR,i.ONE_MINUS_SRC_COLOR,i.DST_COLOR,i.ONE_MINUS_DST_COLOR,i.SRC_ALPHA,i.SRC_ALPHA_SATURATE,i.ONE_MINUS_SRC_ALPHA,i.DST_ALPHA,i.ONE_MINUS_DST_ALPHA,i.CONSTANT_COLOR,i.ONE_MINUS_CONSTANT_COLOR],this.glBlendFunctionAlpha=[i.ZERO,i.ONE,i.SRC_COLOR,i.ONE_MINUS_SRC_COLOR,i.DST_COLOR,i.ONE_MINUS_DST_COLOR,i.SRC_ALPHA,i.SRC_ALPHA_SATURATE,i.ONE_MINUS_SRC_ALPHA,i.DST_ALPHA,i.ONE_MINUS_DST_ALPHA,i.CONSTANT_ALPHA,i.ONE_MINUS_CONSTANT_ALPHA],this.glComparison=[i.NEVER,i.LESS,i.EQUAL,i.LEQUAL,i.GREATER,i.NOTEQUAL,i.GEQUAL,i.ALWAYS],this.glStencilOp=[i.KEEP,i.ZERO,i.REPLACE,i.INCR,i.INCR_WRAP,i.DECR,i.DECR_WRAP,i.INVERT],this.glClearFlag=[0,i.COLOR_BUFFER_BIT,i.DEPTH_BUFFER_BIT,i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT,i.STENCIL_BUFFER_BIT,i.STENCIL_BUFFER_BIT|i.COLOR_BUFFER_BIT,i.STENCIL_BUFFER_BIT|i.DEPTH_BUFFER_BIT,i.STENCIL_BUFFER_BIT|i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT],this.glCull=[0,i.BACK,i.FRONT,i.FRONT_AND_BACK],this.glFilter=[i.NEAREST,i.LINEAR,i.NEAREST_MIPMAP_NEAREST,i.NEAREST_MIPMAP_LINEAR,i.LINEAR_MIPMAP_NEAREST,i.LINEAR_MIPMAP_LINEAR],this.glPrimitive=[i.POINTS,i.LINES,i.LINE_LOOP,i.LINE_STRIP,i.TRIANGLES,i.TRIANGLE_STRIP,i.TRIANGLE_FAN],this.glType=[i.BYTE,i.UNSIGNED_BYTE,i.SHORT,i.UNSIGNED_SHORT,i.INT,i.UNSIGNED_INT,i.FLOAT,i.HALF_FLOAT],this.pcUniformType={},this.pcUniformType[i.BOOL]=za,this.pcUniformType[i.INT]=Yi,this.pcUniformType[i.FLOAT]=Ht,this.pcUniformType[i.FLOAT_VEC2]=Ki,this.pcUniformType[i.FLOAT_VEC3]=fs,this.pcUniformType[i.FLOAT_VEC4]=qi,this.pcUniformType[i.INT_VEC2]=yr,this.pcUniformType[i.INT_VEC3]=Ar,this.pcUniformType[i.INT_VEC4]=Pr,this.pcUniformType[i.BOOL_VEC2]=Un,this.pcUniformType[i.BOOL_VEC3]=Bn,this.pcUniformType[i.BOOL_VEC4]=Vn,this.pcUniformType[i.FLOAT_MAT2]=Xo,this.pcUniformType[i.FLOAT_MAT3]=sa,this.pcUniformType[i.FLOAT_MAT4]=pi,this.pcUniformType[i.SAMPLER_2D]=Rv,this.pcUniformType[i.SAMPLER_CUBE]=Cv,this.pcUniformType[i.UNSIGNED_INT]=ia,this.pcUniformType[i.UNSIGNED_INT_VEC2]=ra,this.pcUniformType[i.UNSIGNED_INT_VEC3]=aa,this.pcUniformType[i.UNSIGNED_INT_VEC4]=na,this.pcUniformType[i.SAMPLER_2D_SHADOW]=Iv,this.pcUniformType[i.SAMPLER_CUBE_SHADOW]=wv,this.pcUniformType[i.SAMPLER_2D_ARRAY]=bv,this.pcUniformType[i.SAMPLER_3D]=Lv,this.pcUniformType[i.INT_SAMPLER_2D]=Mv,this.pcUniformType[i.UNSIGNED_INT_SAMPLER_2D]=Dv,this.pcUniformType[i.INT_SAMPLER_CUBE]=Ov,this.pcUniformType[i.UNSIGNED_INT_SAMPLER_2D]=Nv,this.pcUniformType[i.INT_SAMPLER_3D]=Fv,this.pcUniformType[i.UNSIGNED_INT_SAMPLER_3D]=Uv,this.pcUniformType[i.INT_SAMPLER_2D_ARRAY]=Bv,this.pcUniformType[i.UNSIGNED_INT_SAMPLER_2D_ARRAY]=Vv,this.targetToSlot={},this.targetToSlot[i.TEXTURE_2D]=0,this.targetToSlot[i.TEXTURE_CUBE_MAP]=1,this.targetToSlot[i.TEXTURE_3D]=2;let l,h,c,f,d;this.commitFunction=[],this.commitFunction[za]=function(u,p){u.value!==p&&(i.uniform1i(u.locationId,p),u.value=p)},this.commitFunction[Yi]=this.commitFunction[za],this.commitFunction[Ht]=function(u,p){u.value!==p&&(i.uniform1f(u.locationId,p),u.value=p)},this.commitFunction[Ki]=function(u,p){d=u.value,l=p[0],h=p[1],(d[0]!==l||d[1]!==h)&&(i.uniform2fv(u.locationId,p),d[0]=l,d[1]=h)},this.commitFunction[fs]=function(u,p){d=u.value,l=p[0],h=p[1],c=p[2],(d[0]!==l||d[1]!==h||d[2]!==c)&&(i.uniform3fv(u.locationId,p),d[0]=l,d[1]=h,d[2]=c)},this.commitFunction[qi]=function(u,p){d=u.value,l=p[0],h=p[1],c=p[2],f=p[3],(d[0]!==l||d[1]!==h||d[2]!==c||d[3]!==f)&&(i.uniform4fv(u.locationId,p),d[0]=l,d[1]=h,d[2]=c,d[3]=f)},this.commitFunction[yr]=function(u,p){d=u.value,l=p[0],h=p[1],(d[0]!==l||d[1]!==h)&&(i.uniform2iv(u.locationId,p),d[0]=l,d[1]=h)},this.commitFunction[Un]=this.commitFunction[yr],this.commitFunction[Ar]=function(u,p){d=u.value,l=p[0],h=p[1],c=p[2],(d[0]!==l||d[1]!==h||d[2]!==c)&&(i.uniform3iv(u.locationId,p),d[0]=l,d[1]=h,d[2]=c)},this.commitFunction[Bn]=this.commitFunction[Ar],this.commitFunction[Pr]=function(u,p){d=u.value,l=p[0],h=p[1],c=p[2],f=p[3],(d[0]!==l||d[1]!==h||d[2]!==c||d[3]!==f)&&(i.uniform4iv(u.locationId,p),d[0]=l,d[1]=h,d[2]=c,d[3]=f)},this.commitFunction[Vn]=this.commitFunction[Pr],this.commitFunction[Xo]=function(u,p){i.uniformMatrix2fv(u.locationId,!1,p)},this.commitFunction[sa]=function(u,p){i.uniformMatrix3fv(u.locationId,!1,p)},this.commitFunction[pi]=function(u,p){i.uniformMatrix4fv(u.locationId,!1,p)},this.commitFunction[kn]=function(u,p){i.uniform1fv(u.locationId,p)},this.commitFunction[Gn]=function(u,p){i.uniform2fv(u.locationId,p)},this.commitFunction[zn]=function(u,p){i.uniform3fv(u.locationId,p)},this.commitFunction[lh]=function(u,p){i.uniform4fv(u.locationId,p)},this.commitFunction[ia]=function(u,p){u.value!==p&&(i.uniform1ui(u.locationId,p),u.value=p)},this.commitFunction[ra]=function(u,p){d=u.value,l=p[0],h=p[1],(d[0]!==l||d[1]!==h)&&(i.uniform2uiv(u.locationId,p),d[0]=l,d[1]=h)},this.commitFunction[aa]=function(u,p){d=u.value,l=p[0],h=p[1],c=p[2],(d[0]!==l||d[1]!==h||d[2]!==c)&&(i.uniform3uiv(u.locationId,p),d[0]=l,d[1]=h,d[2]=c)},this.commitFunction[na]=function(u,p){d=u.value,l=p[0],h=p[1],c=p[2],f=p[3],(d[0]!==l||d[1]!==h||d[2]!==c||d[3]!==f)&&(i.uniform4uiv(u.locationId,p),d[0]=l,d[1]=h,d[2]=c,d[3]=f)},this.commitFunction[oa]=function(u,p){i.uniform1iv(u.locationId,p)},this.commitFunction[Hn]=function(u,p){i.uniform1uiv(u.locationId,p)},this.commitFunction[Xn]=this.commitFunction[oa],this.commitFunction[la]=function(u,p){i.uniform2iv(u.locationId,p)},this.commitFunction[Wn]=function(u,p){i.uniform2uiv(u.locationId,p)},this.commitFunction[Yn]=this.commitFunction[la],this.commitFunction[ha]=function(u,p){i.uniform3iv(u.locationId,p)},this.commitFunction[Kn]=function(u,p){i.uniform3uiv(u.locationId,p)},this.commitFunction[qn]=this.commitFunction[ha],this.commitFunction[Wo]=function(u,p){i.uniform4iv(u.locationId,p)},this.commitFunction[hh]=function(u,p){i.uniform4uiv(u.locationId,p)},this.commitFunction[ch]=this.commitFunction[Wo],this.commitFunction[Mu]=function(u,p){i.uniformMatrix4fv(u.locationId,!1,p)},this.constantTexSource=this.scope.resolve("source"),this.postInit()}postInit(){super.postInit(),this.gpuProfiler=new Dx(this)}destroy(){super.destroy();let e=this.gl;this.feedback&&e.deleteTransformFeedback(this.feedback),this.clearVertexArrayObjectCache(),this.canvas.removeEventListener("webglcontextlost",this._contextLostHandler,!1),this.canvas.removeEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this._contextLostHandler=null,this._contextRestoredHandler=null,this.gl=null,super.postDestroy()}createBackbuffer(e){this.supportsStencil=this.initOptions.stencil,this.backBuffer=new xe({name:"WebglFramebuffer",graphicsDevice:this,depth:this.initOptions.depth,stencil:this.supportsStencil,samples:this.samples}),this.backBuffer.impl.suppliedColorFramebuffer=e}updateBackbufferFormat(e){let t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,e);let s=this.gl.getParameter(this.gl.ALPHA_BITS);this.backBufferFormat=s?7:6}updateBackbuffer(){let e=this.canvas.width!==this.backBufferSize.x||this.canvas.height!==this.backBufferSize.y;(this._defaultFramebufferChanged||e)&&(this._defaultFramebufferChanged&&this.updateBackbufferFormat(this._defaultFramebuffer),this._defaultFramebufferChanged=!1,this.backBufferSize.set(this.canvas.width,this.canvas.height),this.backBuffer.destroy(),this.createBackbuffer(this._defaultFramebuffer))}createVertexBufferImpl(e,t){return new Cx}createIndexBufferImpl(e){return new Ix(e)}createShaderImpl(e){return new Lx(e)}createTextureImpl(e){return new bx(e)}createRenderTargetImpl(e){return new Mx}getPrecision(){let e=this.gl,t="highp";if(e.getShaderPrecisionFormat){let s=e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT),i=e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT),r=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT),a=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT);if(s&&i&&r&&a){let n=s.precision>0&&r.precision>0,l=i.precision>0&&a.precision>0;n||(l?t="mediump":t="lowp")}}return t}getExtension(){for(let e=0;e<arguments.length;e++)if(this.supportedExtensions.indexOf(arguments[e])!==-1)return this.gl.getExtension(arguments[e]);return null}get extDisjointTimerQuery(){return this._extDisjointTimerQuery||(this._extDisjointTimerQuery=this.getExtension("EXT_disjoint_timer_query_webgl2","EXT_disjoint_timer_query")),this._extDisjointTimerQuery}initializeExtensions(){let e=this.gl;this.supportedExtensions=e.getSupportedExtensions()??[],this._extDisjointTimerQuery=null,this.textureRG11B10Renderable=!0,this.extColorBufferFloat=this.getExtension("EXT_color_buffer_float"),this.textureFloatRenderable=!!this.extColorBufferFloat,this.extColorBufferHalfFloat=this.getExtension("EXT_color_buffer_half_float"),this.textureHalfFloatRenderable=!!this.extColorBufferHalfFloat||!!this.extColorBufferFloat,this.extDebugRendererInfo=this.getExtension("WEBGL_debug_renderer_info"),this.extTextureFloatLinear=this.getExtension("OES_texture_float_linear"),this.textureFloatFilterable=!!this.extTextureFloatLinear,this.extFloatBlend=this.getExtension("EXT_float_blend"),this.extTextureFilterAnisotropic=this.getExtension("EXT_texture_filter_anisotropic","WEBKIT_EXT_texture_filter_anisotropic"),this.extParallelShaderCompile=this.getExtension("KHR_parallel_shader_compile"),this.extCompressedTextureETC1=this.getExtension("WEBGL_compressed_texture_etc1"),this.extCompressedTextureETC=this.getExtension("WEBGL_compressed_texture_etc"),this.extCompressedTexturePVRTC=this.getExtension("WEBGL_compressed_texture_pvrtc","WEBKIT_WEBGL_compressed_texture_pvrtc"),this.extCompressedTextureS3TC=this.getExtension("WEBGL_compressed_texture_s3tc","WEBKIT_WEBGL_compressed_texture_s3tc"),this.extCompressedTextureS3TC_SRGB=this.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this.extCompressedTextureATC=this.getExtension("WEBGL_compressed_texture_atc"),this.extCompressedTextureASTC=this.getExtension("WEBGL_compressed_texture_astc"),this.extTextureCompressionBPTC=this.getExtension("EXT_texture_compression_bptc")}initializeCapabilities(){let e=this.gl,t,s=typeof navigator<"u"?navigator.userAgent:"";this.maxPrecision=this.precision=this.getPrecision();let i=e.getContextAttributes();this.supportsMsaa=i?.antialias??!1,this.supportsStencil=i?.stencil??!1,this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this.maxCubeMapSize=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),this.maxRenderBufferSize=e.getParameter(e.MAX_RENDERBUFFER_SIZE),this.maxTextures=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this.maxCombinedTextures=e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this.maxVertexTextures=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.vertexUniformsCount=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),this.fragmentUniformsCount=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),this.maxColorAttachments=e.getParameter(e.MAX_COLOR_ATTACHMENTS),this.maxVolumeSize=e.getParameter(e.MAX_3D_TEXTURE_SIZE),t=this.extDebugRendererInfo,this.unmaskedRenderer=t?e.getParameter(t.UNMASKED_RENDERER_WEBGL):"",this.unmaskedVendor=t?e.getParameter(t.UNMASKED_VENDOR_WEBGL):"";let r=/\bMali-G52+/,a=/SM-[a-zA-Z0-9]+/;this.supportsGpuParticles=!(this.unmaskedVendor==="ARM"&&s.match(a))&&!this.unmaskedRenderer.match(r),t=this.extTextureFilterAnisotropic,this.maxAnisotropy=t?e.getParameter(t.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1;let n=!this.forceDisableMultisampling;this.maxSamples=n?e.getParameter(e.MAX_SAMPLES):1,this.maxSamples=Math.min(this.maxSamples,4),this.samples=n&&this.backBufferAntialias?this.maxSamples:1,this.supportsAreaLights=!ue.android,this.maxTextures<=8&&(this.supportsAreaLights=!1),this.initCapsDefines()}initializeRenderState(){super.initializeRenderState();let e=this.gl;e.disable(e.BLEND),e.blendFunc(e.ONE,e.ZERO),e.blendEquation(e.FUNC_ADD),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0),e.enable(e.CULL_FACE),this.cullFace=e.BACK,e.cullFace(e.BACK),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.depthMask(!0),this.stencil=!1,e.disable(e.STENCIL_TEST),this.stencilFuncFront=this.stencilFuncBack=7,this.stencilRefFront=this.stencilRefBack=0,this.stencilMaskFront=this.stencilMaskBack=255,e.stencilFunc(e.ALWAYS,0,255),this.stencilFailFront=this.stencilFailBack=Dn,this.stencilZfailFront=this.stencilZfailBack=Dn,this.stencilZpassFront=this.stencilZpassBack=Dn,this.stencilWriteMaskFront=255,this.stencilWriteMaskBack=255,e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.stencilMask(255),this.alphaToCoverage=!1,this.raster=!0,e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.RASTERIZER_DISCARD),this.depthBiasEnabled=!1,e.disable(e.POLYGON_OFFSET_FILL),this.clearDepth=1,e.clearDepth(1),this.clearColor=new N(0,0,0,0),e.clearColor(0,0,0,0),this.clearStencil=0,e.clearStencil(0),e.hint(e.FRAGMENT_SHADER_DERIVATIVE_HINT,e.NICEST),e.enable(e.SCISSOR_TEST),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e.NONE),this.unpackFlipY=!1,e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),this.unpackPremultiplyAlpha=!1,e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),e.pixelStorei(e.UNPACK_ALIGNMENT,1)}initTextureUnits(e=16){this.textureUnits=[];for(let t=0;t<e;t++)this.textureUnits.push([null,null,null])}initializeContextCaches(){super.initializeContextCaches(),this._vaoMap=new Map,this.boundVao=null,this.activeFramebuffer=null,this.feedback=null,this.transformFeedbackBuffer=null,this.textureUnit=0,this.initTextureUnits(this.maxCombinedTextures)}loseContext(){super.loseContext();for(let e of this.shaders)e.loseContext()}restoreContext(){this.initializeExtensions(),this.initializeCapabilities(),super.restoreContext();for(let e of this.shaders)e.restoreContext()}setViewport(e,t,s,i){(this.vx!==e||this.vy!==t||this.vw!==s||this.vh!==i)&&(this.gl.viewport(e,t,s,i),this.vx=e,this.vy=t,this.vw=s,this.vh=i)}setScissor(e,t,s,i){(this.sx!==e||this.sy!==t||this.sw!==s||this.sh!==i)&&(this.gl.scissor(e,t,s,i),this.sx=e,this.sy=t,this.sw=s,this.sh=i)}setFramebuffer(e){if(this.activeFramebuffer!==e){let t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,e),this.activeFramebuffer=e}}copyRenderTarget(e,t,s,i){let r=this.gl;if(e===this.backBuffer&&(e=null),s){if(t){if(e&&(!e._colorBuffer||!t._colorBuffer||e._colorBuffer._format!==t._colorBuffer._format))return!1}else if(!e._colorBuffer)return!1}if(i&&e&&!e._depth&&(!e._depthBuffer||!t._depthBuffer||e._depthBuffer._format!==t._depthBuffer._format))return!1;let a=this.renderTarget;this.renderTarget=t,this.updateBegin();let n=e?e.impl._glFrameBuffer:this.backBuffer?.impl._glFrameBuffer,l=t?t.impl._glFrameBuffer:this.backBuffer?.impl._glFrameBuffer;r.bindFramebuffer(r.READ_FRAMEBUFFER,n),r.bindFramebuffer(r.DRAW_FRAMEBUFFER,l);let h=e?e.width:t?t.width:this.width,c=e?e.height:t?t.height:this.height;return r.blitFramebuffer(0,0,h,c,0,0,h,c,(s?r.COLOR_BUFFER_BIT:0)|(i?r.DEPTH_BUFFER_BIT:0),r.NEAREST),this.renderTarget=a,r.bindFramebuffer(r.FRAMEBUFFER,a?a.impl._glFrameBuffer:null),!0}frameStart(){super.frameStart(),this.updateBackbuffer(),this.gpuProfiler.frameStart()}frameEnd(){super.frameEnd(),this.gpuProfiler.frameEnd(),this.gpuProfiler.request()}startRenderPass(e){let t=e.renderTarget??this.backBuffer;this.renderTarget=t,this.updateBegin();let{width:s,height:i}=t;this.setViewport(0,0,s,i),this.setScissor(0,0,s,i);let r=e.colorOps,a=e.depthStencilOps;if(r?.clear||a.clearDepth||a.clearStencil){let n=0,l={};r?.clear&&(n|=1,l.color=[r.clearValue.r,r.clearValue.g,r.clearValue.b,r.clearValue.a]),a.clearDepth&&(n|=2,l.depth=a.clearDepthValue),a.clearStencil&&(n|=4,l.stencil=a.clearStencilValue),l.flags=n,this.clear(l)}this.insideRenderPass=!0}endRenderPass(e){this.unbindVertexArray();let t=this.renderTarget,s=e.colorArrayOps.length;if(t){cm.length=0;let i=this.gl;for(let r=0;r<s;r++){let a=e.colorArrayOps[r];a.store||a.resolve||cm.push(i.COLOR_ATTACHMENT0+r)}t!==this.backBuffer&&(e.depthStencilOps.storeDepth||cm.push(i.DEPTH_ATTACHMENT),e.depthStencilOps.storeStencil||cm.push(i.STENCIL_ATTACHMENT)),cm.length>0&&e.fullSizeClearRect&&i.invalidateFramebuffer(i.DRAW_FRAMEBUFFER,cm),s&&e.colorOps?.resolve&&e.samples>1&&t.autoResolve&&t.resolve(!0,!1),t.depthBuffer&&e.depthStencilOps.resolveDepth&&e.samples>1&&t.autoResolve&&t.resolve(!1,!0);for(let r=0;r<s;r++)if(e.colorArrayOps[r].genMipmaps){let n=t._colorBuffers[r];n&&n.impl._glTexture&&n.mipmaps&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(n),this.gl.generateMipmap(n.impl._glTarget))}}this.insideRenderPass=!1}set defaultFramebuffer(e){this._defaultFramebuffer!==e&&(this._defaultFramebuffer=e,this._defaultFramebufferChanged=!0)}get defaultFramebuffer(){return this._defaultFramebuffer}updateBegin(){if(this.boundVao=null,this._tempEnableSafariTextureUnitWorkaround)for(let s=0;s<this.textureUnits.length;++s)for(let i=0;i<3;++i)this.textureUnits[s][i]=null;let e=this.renderTarget??this.backBuffer,t=e.impl;t.initialized||this.initRenderTarget(e),this.setFramebuffer(t._glFrameBuffer)}updateEnd(){this.unbindVertexArray();let e=this.renderTarget;if(e&&e!==this.backBuffer){e._samples>1&&e.autoResolve&&e.resolve();let t=e._colorBuffer;t&&t.impl._glTexture&&t.mipmaps&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(t),this.gl.generateMipmap(t.impl._glTarget))}}setUnpackFlipY(e){if(this.unpackFlipY!==e){this.unpackFlipY=e;let t=this.gl;t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,e)}}setUnpackPremultiplyAlpha(e){if(this.unpackPremultiplyAlpha!==e){this.unpackPremultiplyAlpha=e;let t=this.gl;t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e)}}activeTexture(e){this.textureUnit!==e&&(this.gl.activeTexture(this.gl.TEXTURE0+e),this.textureUnit=e)}bindTexture(e){let t=e.impl,s=t._glTarget,i=t._glTexture,r=this.textureUnit,a=this.targetToSlot[s];this.textureUnits[r][a]!==i&&(this.gl.bindTexture(s,i),this.textureUnits[r][a]=i)}bindTextureOnUnit(e,t){let s=e.impl,i=s._glTarget,r=s._glTexture,a=this.targetToSlot[i];this.textureUnits[t][a]!==r&&(this.activeTexture(t),this.gl.bindTexture(i,r),this.textureUnits[t][a]=r)}setTextureParameters(e){let t=this.gl,s=e.impl.dirtyParameterFlags,i=e.impl._glTarget;if(s&Nu){let r=e._minFilter;(!e._mipmaps||e._compressed&&e._levels.length===1)&&(r===2||r===3?r=0:(r===4||r===5)&&(r=1)),t.texParameteri(i,t.TEXTURE_MIN_FILTER,this.glFilter[r])}if(s&Fu&&t.texParameteri(i,t.TEXTURE_MAG_FILTER,this.glFilter[e._magFilter]),s&Uu&&t.texParameteri(i,t.TEXTURE_WRAP_S,this.glAddress[e._addressU]),s&Bu&&t.texParameteri(i,t.TEXTURE_WRAP_T,this.glAddress[e._addressV]),s&Vu&&t.texParameteri(i,t.TEXTURE_WRAP_R,this.glAddress[e._addressW]),s&ku&&t.texParameteri(i,t.TEXTURE_COMPARE_MODE,e._compareOnRead?t.COMPARE_REF_TO_TEXTURE:t.NONE),s&Gu&&t.texParameteri(i,t.TEXTURE_COMPARE_FUNC,this.glComparison[e._compareFunc]),s&zu){let r=this.extTextureFilterAnisotropic;r&&t.texParameterf(i,r.TEXTURE_MAX_ANISOTROPY_EXT,w.clamp(Math.round(e._anisotropy),1,this.maxAnisotropy))}}setTexture(e,t){let s=e.impl;s._glTexture||s.initialize(this,e),s.dirtyParameterFlags>0||e._needsUpload||e._needsMipmapsUpload?(this.activeTexture(t),this.bindTexture(e),s.dirtyParameterFlags&&(this.setTextureParameters(e),s.dirtyParameterFlags=0),(e._needsUpload||e._needsMipmapsUpload)&&(s.upload(this,e),e._needsUpload=!1,e._needsMipmapsUpload=!1)):this.bindTextureOnUnit(e,t)}createVertexArray(e){let t,s,i=e.length>1;if(i){t="";for(let r=0;r<e.length;r++){let a=e[r];t+=a.id+a.format.renderingHash}s=this._vaoMap.get(t)}if(!s){let r=this.gl;s=r.createVertexArray(),r.bindVertexArray(s),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null);for(let a=0;a<e.length;a++){let n=e[a];r.bindBuffer(r.ARRAY_BUFFER,n.impl.bufferId);let l=n.format.elements;for(let h=0;h<l.length;h++){let c=l[h],f=Be[c.name];c.asInt?r.vertexAttribIPointer(f,c.numComponents,this.glType[c.dataType],c.stride,c.offset):r.vertexAttribPointer(f,c.numComponents,this.glType[c.dataType],c.normalize,c.stride,c.offset),r.enableVertexAttribArray(f),n.format.instancing&&r.vertexAttribDivisor(f,1)}}r.bindVertexArray(null),r.bindBuffer(r.ARRAY_BUFFER,null),i&&this._vaoMap.set(t,s)}return s}unbindVertexArray(){this.boundVao&&(this.boundVao=null,this.gl.bindVertexArray(null))}setBuffers(e){let t=this.gl,s;if(this.vertexBuffers.length===1){let r=this.vertexBuffers[0];r.impl.vao||(r.impl.vao=this.createVertexArray(this.vertexBuffers)),s=r.impl.vao}else s=this.createVertexArray(this.vertexBuffers);this.boundVao!==s&&(this.boundVao=s,t.bindVertexArray(s));let i=e?e.impl.bufferId:null;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,i)}draw(e,t,s,i,r=!0,a=!0){let n=this.shader;if(n&&(this.activateShader(),this.shaderValid)){let l=this.gl;r&&this.setBuffers(t);let h=0,c=n.impl.samplers;for(let p=0,_=c.length;p<_;p++){let S=c[p],T=S.scopeId.value;if(!T){let x=S.scopeId.name;x==="uSceneDepthMap"&&(T=Qn(this,"white")),x==="uSceneColorMap"&&(T=Qn(this,"pink")),T||(T=Qn(this,"pink"))}if(T instanceof q){let x=T;this.setTexture(x,h),S.slot!==h&&(l.uniform1i(S.locationId,h),S.slot=h),h++}else{S.array.length=0;let x=T.length;for(let A=0;A<x;A++){let E=T[A];this.setTexture(E,h),S.array[A]=h,h++}l.uniform1iv(S.locationId,S.array)}}let f=n.impl.uniforms;for(let p=0,_=f.length;p<_;p++){let S=f[p],T=S.scopeId,x=S.version,A=T.versionObject.version;if(x.globalId!==A.globalId||x.revision!==A.revision){x.globalId=A.globalId,x.revision=A.revision;let E=T.value;E!=null&&this.commitFunction[S.dataType](S,E)}}this.transformFeedbackBuffer&&(l.bindBufferBase(l.TRANSFORM_FEEDBACK_BUFFER,0,this.transformFeedbackBuffer.impl.bufferId),l.beginTransformFeedback(l.POINTS));let d=this.glPrimitive[e.type],u=e.count;if(e.indexed){let p=t.impl.glFormat,_=e.base*t.bytesPerIndex;s>0?l.drawElementsInstanced(d,u,p,_,s):l.drawElements(d,u,p,_)}else{let p=e.base;s>0?l.drawArraysInstanced(d,p,u,s):l.drawArrays(d,p,u)}this.transformFeedbackBuffer&&(l.endTransformFeedback(),l.bindBufferBase(l.TRANSFORM_FEEDBACK_BUFFER,0,null)),this._drawCallsPerFrame++}a&&this.clearVertexBuffer()}clear(e){let t=this.defaultClearOptions;e=e||t;let s=e.flags??t.flags;if(s!==0){let i=this.gl;if(s&1){let r=e.color??t.color,a=r[0],n=r[1],l=r[2],h=r[3],c=this.clearColor;(a!==c.r||n!==c.g||l!==c.b||h!==c.a)&&(this.gl.clearColor(a,n,l,h),this.clearColor.set(a,n,l,h)),this.setBlendState(Ie.NOBLEND)}if(s&2){let r=e.depth??t.depth;r!==this.clearDepth&&(this.gl.clearDepth(r),this.clearDepth=r),this.setDepthState($e.WRITEDEPTH)}if(s&4){let r=e.stencil??t.stencil;r!==this.clearStencil&&(this.gl.clearStencil(r),this.clearStencil=r),i.stencilMask(255),this.stencilWriteMaskFront=255,this.stencilWriteMaskBack=255}i.clear(this.glClearFlag[s])}}submit(){this.gl.flush()}readPixels(e,t,s,i,r){let a=this.gl;a.readPixels(e,t,s,i,a.RGBA,a.UNSIGNED_BYTE,r)}clientWaitAsync(e,t){let s=this.gl,i=s.fenceSync(s.SYNC_GPU_COMMANDS_COMPLETE,0);return this.submit(),new Promise((r,a)=>{function n(){let l=s.clientWaitSync(i,e,0);l===s.TIMEOUT_EXPIRED?setTimeout(n,t):(s.deleteSync(i),l===s.WAIT_FAILED?a(new Error("webgl clientWaitSync sync failed")):r())}n()})}async readPixelsAsync(e,t,s,i,r){let a=this.gl,n=this.renderTarget.colorBuffer?.impl,l=n?._glFormat??a.RGBA,h=n?._glPixelType??a.UNSIGNED_BYTE,c=a.createBuffer();return a.bindBuffer(a.PIXEL_PACK_BUFFER,c),a.bufferData(a.PIXEL_PACK_BUFFER,r.byteLength,a.STREAM_READ),a.readPixels(e,t,s,i,l,h,0),a.bindBuffer(a.PIXEL_PACK_BUFFER,null),await this.clientWaitAsync(0,16),a.bindBuffer(a.PIXEL_PACK_BUFFER,c),a.getBufferSubData(a.PIXEL_PACK_BUFFER,0,r),a.bindBuffer(a.PIXEL_PACK_BUFFER,null),a.deleteBuffer(c),r}readTextureAsync(e,t,s,i,r,a){let n=a.face??0,l=a.renderTarget??new xe({colorBuffer:e,depth:!1,face:n}),h=new ArrayBuffer(Cs.calcLevelGpuSize(i,r,1,e._format)),c=a.data??new(Ru(e._format))(h);return this.setRenderTarget(l),this.initRenderTarget(l),new Promise((f,d)=>{this.readPixelsAsync(t,s,i,r,c).then(u=>{a.renderTarget||l.destroy(),f(u)}).catch(d)})}async writeTextureAsync(e,t,s,i,r,a){let n=this.gl,l=e.impl,h=l?._glFormat??n.RGBA,c=l?._glPixelType??n.UNSIGNED_BYTE,f=n.createBuffer();n.bindBuffer(n.PIXEL_UNPACK_BUFFER,f),n.bufferData(n.PIXEL_UNPACK_BUFFER,a,n.STREAM_DRAW),n.bindTexture(n.TEXTURE_2D,l._glTexture),n.texSubImage2D(n.TEXTURE_2D,0,t,s,i,r,h,c,0),n.bindBuffer(n.PIXEL_UNPACK_BUFFER,null),e._needsUpload=!1,e._mipmapsUploaded=!1,await this.clientWaitAsync(0,16)}setAlphaToCoverage(e){this.alphaToCoverage!==e&&(this.alphaToCoverage=e,e?this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE):this.gl.disable(this.gl.SAMPLE_ALPHA_TO_COVERAGE))}setTransformFeedbackBuffer(e){if(this.transformFeedbackBuffer!==e){this.transformFeedbackBuffer=e;let t=this.gl;e?(this.feedback||(this.feedback=t.createTransformFeedback()),t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,this.feedback)):t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,null)}}setRaster(e){this.raster!==e&&(this.raster=e,e?this.gl.disable(this.gl.RASTERIZER_DISCARD):this.gl.enable(this.gl.RASTERIZER_DISCARD))}setStencilTest(e){if(this.stencil!==e){let t=this.gl;e?t.enable(t.STENCIL_TEST):t.disable(t.STENCIL_TEST),this.stencil=e}}setStencilFunc(e,t,s){(this.stencilFuncFront!==e||this.stencilRefFront!==t||this.stencilMaskFront!==s||this.stencilFuncBack!==e||this.stencilRefBack!==t||this.stencilMaskBack!==s)&&(this.gl.stencilFunc(this.glComparison[e],t,s),this.stencilFuncFront=this.stencilFuncBack=e,this.stencilRefFront=this.stencilRefBack=t,this.stencilMaskFront=this.stencilMaskBack=s)}setStencilFuncFront(e,t,s){if(this.stencilFuncFront!==e||this.stencilRefFront!==t||this.stencilMaskFront!==s){let i=this.gl;i.stencilFuncSeparate(i.FRONT,this.glComparison[e],t,s),this.stencilFuncFront=e,this.stencilRefFront=t,this.stencilMaskFront=s}}setStencilFuncBack(e,t,s){if(this.stencilFuncBack!==e||this.stencilRefBack!==t||this.stencilMaskBack!==s){let i=this.gl;i.stencilFuncSeparate(i.BACK,this.glComparison[e],t,s),this.stencilFuncBack=e,this.stencilRefBack=t,this.stencilMaskBack=s}}setStencilOperation(e,t,s,i){(this.stencilFailFront!==e||this.stencilZfailFront!==t||this.stencilZpassFront!==s||this.stencilFailBack!==e||this.stencilZfailBack!==t||this.stencilZpassBack!==s)&&(this.gl.stencilOp(this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[s]),this.stencilFailFront=this.stencilFailBack=e,this.stencilZfailFront=this.stencilZfailBack=t,this.stencilZpassFront=this.stencilZpassBack=s),(this.stencilWriteMaskFront!==i||this.stencilWriteMaskBack!==i)&&(this.gl.stencilMask(i),this.stencilWriteMaskFront=i,this.stencilWriteMaskBack=i)}setStencilOperationFront(e,t,s,i){(this.stencilFailFront!==e||this.stencilZfailFront!==t||this.stencilZpassFront!==s)&&(this.gl.stencilOpSeparate(this.gl.FRONT,this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[s]),this.stencilFailFront=e,this.stencilZfailFront=t,this.stencilZpassFront=s),this.stencilWriteMaskFront!==i&&(this.gl.stencilMaskSeparate(this.gl.FRONT,i),this.stencilWriteMaskFront=i)}setStencilOperationBack(e,t,s,i){(this.stencilFailBack!==e||this.stencilZfailBack!==t||this.stencilZpassBack!==s)&&(this.gl.stencilOpSeparate(this.gl.BACK,this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[s]),this.stencilFailBack=e,this.stencilZfailBack=t,this.stencilZpassBack=s),this.stencilWriteMaskBack!==i&&(this.gl.stencilMaskSeparate(this.gl.BACK,i),this.stencilWriteMaskBack=i)}setBlendState(e){let t=this.blendState;if(!t.equals(e)){let s=this.gl,{blend:i,colorOp:r,alphaOp:a,colorSrcFactor:n,colorDstFactor:l,alphaSrcFactor:h,alphaDstFactor:c}=e;if(t.blend!==i&&(i?s.enable(s.BLEND):s.disable(s.BLEND)),t.colorOp!==r||t.alphaOp!==a){let f=this.glBlendEquation;s.blendEquationSeparate(f[r],f[a])}(t.colorSrcFactor!==n||t.colorDstFactor!==l||t.alphaSrcFactor!==h||t.alphaDstFactor!==c)&&s.blendFuncSeparate(this.glBlendFunctionColor[n],this.glBlendFunctionColor[l],this.glBlendFunctionAlpha[h],this.glBlendFunctionAlpha[c]),t.allWrite!==e.allWrite&&this.gl.colorMask(e.redWrite,e.greenWrite,e.blueWrite,e.alphaWrite),t.copy(e)}}setBlendColor(e,t,s,i){let r=this.blendColor;(e!==r.r||t!==r.g||s!==r.b||i!==r.a)&&(this.gl.blendColor(e,t,s,i),r.set(e,t,s,i))}setStencilState(e,t){e||t?(this.setStencilTest(!0),e===t?(this.setStencilFunc(e.func,e.ref,e.readMask),this.setStencilOperation(e.fail,e.zfail,e.zpass,e.writeMask)):(e??=ws.DEFAULT,this.setStencilFuncFront(e.func,e.ref,e.readMask),this.setStencilOperationFront(e.fail,e.zfail,e.zpass,e.writeMask),t??=ws.DEFAULT,this.setStencilFuncBack(t.func,t.ref,t.readMask),this.setStencilOperationBack(t.fail,t.zfail,t.zpass,t.writeMask))):this.setStencilTest(!1)}setDepthState(e){let t=this.depthState;if(!t.equals(e)){let s=this.gl,i=e.write;t.write!==i&&s.depthMask(i);let{func:r,test:a}=e;!a&&i&&(a=!0,r=7),t.func!==r&&s.depthFunc(this.glComparison[r]),t.test!==a&&(a?s.enable(s.DEPTH_TEST):s.disable(s.DEPTH_TEST));let{depthBias:n,depthBiasSlope:l}=e;n||l?(this.depthBiasEnabled||(this.depthBiasEnabled=!0,this.gl.enable(this.gl.POLYGON_OFFSET_FILL)),s.polygonOffset(l,n)):this.depthBiasEnabled&&(this.depthBiasEnabled=!1,this.gl.disable(this.gl.POLYGON_OFFSET_FILL)),t.copy(e)}}setCullMode(e){if(this.cullMode!==e){if(e===0)this.gl.disable(this.gl.CULL_FACE);else{this.cullMode===0&&this.gl.enable(this.gl.CULL_FACE);let t=this.glCull[e];this.cullFace!==t&&(this.gl.cullFace(t),this.cullFace=t)}this.cullMode=e}}setShader(e,t=!1){e!==this.shader&&(this.shader=e,this.shaderAsyncCompile=t,this.shaderValid=void 0)}activateShader(){let{shader:e}=this,{impl:t}=e;this.shaderValid===void 0&&(e.failed?this.shaderValid=!1:e.ready||(this.shaderAsyncCompile?t.isLinked(this)?t.finalize(this,e)||(e.failed=!0,this.shaderValid=!1):this.shaderValid=!1:t.finalize(this,e)||(e.failed=!0,this.shaderValid=!1))),this.shaderValid===void 0&&(this.gl.useProgram(t.glProgram),this.shaderValid=!0)}clearVertexArrayObjectCache(){let e=this.gl;this._vaoMap.forEach((t,s,i)=>{e.deleteVertexArray(t)}),this._vaoMap.clear()}set fullscreen(e){e?this.gl.canvas.requestFullscreen():document.exitFullscreen()}get fullscreen(){return!!document.fullscreenElement}}});var Nx,qN=m(()=>{Nx=class{unlock(e){}}});var Fx,jN=m(()=>{Fx=class{destroy(e){}init(e,t){}loseContext(){}resolve(e,t,s,i){}}});var Ux,$N=m(()=>{Ux=class{destroy(e){}loseContext(){}restoreContext(e,t){}}});var Bx,ZN=m(()=>{Bx=class{destroy(e){}propertyChanged(e){}loseContext(){}}});var Vx,QN=m(()=>{Vx=class{destroy(e){}unlock(e){}}});var fm,pw=m(()=>{j();Zu();Rt();qN();jN();$N();ZN();QN();fm=class extends Qe{constructor(e,t={}){super(e,t),t=this.initOptions,this.isNull=!0,this._deviceType=dh,this.samples=1,this.backBuffer=new xe({name:"Framebuffer",graphicsDevice:this,depth:this.initOptions.depth,stencil:this.supportsStencil,samples:this.samples}),this.initDeviceCaps()}destroy(){super.destroy()}initDeviceCaps(){this.disableParticleSystem=!0,this.precision="highp",this.maxPrecision="highp",this.maxSamples=4,this.maxTextures=16,this.maxTextureSize=4096,this.maxCubeMapSize=4096,this.maxVolumeSize=4096,this.maxColorAttachments=8,this.maxPixelRatio=1,this.maxAnisotropy=16,this.supportsUniformBuffers=!1,this.supportsAreaLights=!0,this.supportsGpuParticles=!1,this.textureFloatRenderable=!0,this.textureHalfFloatRenderable=!0,this.supportsImageBitmap=!1}postInit(){super.postInit()}frameStart(){super.frameStart()}frameEnd(){super.frameEnd()}updateBegin(){}updateEnd(){}readPixels(e,t,s,i,r){}createVertexBufferImpl(e,t){return new Vx(e,t)}createIndexBufferImpl(e){return new Nx(e)}createShaderImpl(e){return new Ux(e)}createTextureImpl(e){return new Bx(e)}createRenderTargetImpl(e){return new Fx(e)}draw(e,t,s,i,r=!0,a=!0){}setShader(e,t=!1){}setBlendState(e){}setDepthState(e){}setStencilState(e,t){}setBlendColor(e,t,s,i){}setCullMode(e){}setAlphaToCoverage(e){}initializeContextCaches(){super.initializeContextCaches()}clear(e){}setViewport(e,t,s,i){}setScissor(e,t,s,i){}copyRenderTarget(e,t,s,i){return!0}}});function kx(o,e={}){let t=e.deviceTypes??[];t.includes(fh)||t.push(fh),t.includes(dh)||t.push(dh),ue.browser&&navigator.xr&&(e.xrCompatible??=!0);let s=[];for(let i=0;i<t.length;i++){let r=t[i];r===Du&&window?.navigator?.gpu&&s.push(()=>new lm(o,e).initWebGpu(e.glslangUrl,e.twgslUrl)),r===fh&&s.push(()=>new Eh(o,e)),r===dh&&s.push(()=>new fm(o,e))}return new Promise((i,r)=>{let a=0,n=()=>{a>=s.length?r(new Error("Failed to create a graphics device")):Promise.resolve(s[a++]()).then(l=>{l?i(l):n()}).catch(l=>{console.log(l),n()})};n()})}var JN=m(()=>{bt();j();cw();Ox();pw()});var _w,Gx,e3=m(()=>{_w=class{constructor(){this.scopeId=null}},Gx=class{constructor(e,t,s="Unnamed"){this.shader=null,this.parameters=new Map,this.countX=1,this.device=e,this.shader=t,this.name=s,e.supportsCompute&&(this.impl=e.createComputeImpl(this))}setParameter(e,t){let s=this.parameters.get(e);s||(s=new _w,s.scopeId=this.device.scope.resolve(e),this.parameters.set(e,s)),s.value=t}getParameter(e){return this.parameters.get(e)?.value}deleteParameter(e){this.parameters.delete(e)}applyParameters(){for(let[,e]of this.parameters)e.scopeId.setValue(e.value)}setupDispatch(e,t,s){this.countX=e,this.countY=t,this.countZ=s}}});var Bre,Ls,vh=m(()=>{j();Bre=0,Ls=class{constructor(e,t,s,i=0,r,a){this.device=e,this.format=t,this.numIndices=s,this.usage=i,this.id=Bre++,this.impl=e.createIndexBufferImpl(this,a);let n=Hv[t];this.bytesPerIndex=n,this.numBytes=this.numIndices*n,r?this.setData(r):this.storage=new ArrayBuffer(this.numBytes),this.adjustVramSizeTracking(e._vram,this.numBytes),this.device.buffers.push(this)}destroy(){let e=this.device,t=e.buffers.indexOf(this);t!==-1&&e.buffers.splice(t,1),this.device.indexBuffer===this&&(this.device.indexBuffer=null),this.impl.initialized&&(this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this.storage.byteLength))}adjustVramSizeTracking(e,t){e.ib+=t}loseContext(){this.impl.loseContext()}getFormat(){return this.format}getNumIndices(){return this.numIndices}lock(){return this.storage}unlock(){this.impl.unlock(this)}setData(e){return e.byteLength!==this.numBytes?!1:(this.storage=e,this.unlock(),!0)}_lockTypedArray(){let e=this.lock();return this.format===2?new Uint32Array(e):this.format===1?new Uint16Array(e):new Uint8Array(e)}writeData(e,t){let s=this._lockTypedArray();if(e.length>t)if(ArrayBuffer.isView(e))e=e.subarray(0,t),s.set(e);else for(let i=0;i<t;i++)s[i]=e[i];else s.set(e);this.unlock()}readData(e){let t=this._lockTypedArray(),s=this.numIndices;if(ArrayBuffer.isView(e))e.set(t);else{e.length=0;for(let i=0;i<s;i++)e[i]=t[i]}return s}}});var gw,Sw,Xe,us=m(()=>{De();j();gw=class{constructor(){this.clearValue=new N(0,0,0,1),this.clearValueLinear=new N(0,0,0,1),this.clear=!1,this.store=!1,this.resolve=!0,this.genMipmaps=!1}},Sw=class{constructor(){this.clearDepthValue=1,this.clearStencilValue=0,this.clearDepth=!1,this.clearStencil=!1,this.storeDepth=!1,this.resolveDepth=!1,this.storeStencil=!1}},Xe=class{get colorOps(){return this.colorArrayOps[0]}constructor(e){this._enabled=!0,this._skipStart=!1,this._skipEnd=!1,this.executeEnabled=!0,this.samples=0,this.colorArrayOps=[],this.requiresCubemaps=!0,this.fullSizeClearRect=!0,this.beforePasses=[],this.afterPasses=[],this.device=e}set name(e){this._name=e}get name(){return this._name||(this._name=this.constructor.name),this._name}set scaleX(e){this._options.scaleX=e}get scaleX(){return this._options.scaleX}set scaleY(e){this._options.scaleY=e}get scaleY(){return this._options.scaleY}set options(e){this._options=e,e&&(this.scaleX=this.scaleX??1,this.scaleY=this.scaleY??1)}get options(){return this._options}init(e=null,t){this.options=t,this.renderTarget=e,this.samples=Math.max(this.renderTarget?this.renderTarget.samples:this.device.samples,1),this.allocateAttachments(),this.postInit()}allocateAttachments(){let e=this.renderTarget;this.depthStencilOps=new Sw,e?.depthBuffer&&(this.depthStencilOps.storeDepth=!0);let t=e?e._colorBuffers?.length??0:1;this.colorArrayOps.length=0;for(let s=0;s<t;s++){let i=new gw;this.colorArrayOps[s]=i,this.samples===1&&(i.store=!0,i.resolve=!1);let r=this.renderTarget?._colorBuffers?.[s];if(this.renderTarget?.mipmaps&&r?.mipmaps){let a=Xi(r._format);i.genMipmaps=!a}}}destroy(){}postInit(){}frameUpdate(){if(this._options&&this.renderTarget){let e=this._options.resizeSource??this.device.backBuffer,t=Math.floor(e.width*this.scaleX),s=Math.floor(e.height*this.scaleY);this.renderTarget.resize(t,s)}}before(){}execute(){}after(){}onEnable(){}onDisable(){}set enabled(e){this._enabled!==e&&(this._enabled=e,e?this.onEnable():this.onDisable())}get enabled(){return this._enabled}setClearColor(e){let t=this.colorArrayOps.length;for(let s=0;s<t;s++){let i=this.colorArrayOps[s];e&&(i.clearValue.copy(e),i.clearValueLinear.linear(e)),i.clear=!!e}}setClearDepth(e){e&&(this.depthStencilOps.clearDepthValue=e),this.depthStencilOps.clearDepth=e!==void 0}setClearStencil(e){e&&(this.depthStencilOps.clearStencilValue=e),this.depthStencilOps.clearStencil=e!==void 0}render(){if(this.enabled){let e=this.device,t=this.renderTarget!==void 0;this.before(),this.executeEnabled&&(t&&!this._skipStart&&e.startRenderPass(this),this.execute(),t&&!this._skipEnd&&e.endRenderPass(this)),this.after(),e.renderPassIndex++}}}});var zx,t3=m(()=>{j();$i();Th();Sh();zx=class{constructor(e,t=3){this.device=e.device;let s=this.device.gl;this._inputBuffer=e,t===3&&e.usage!==t&&(s.bindBuffer(s.ARRAY_BUFFER,e.impl.bufferId),s.bufferData(s.ARRAY_BUFFER,e.storage,s.DYNAMIC_COPY)),this._outputBuffer=new mt(e.device,e.format,e.numVertices,{usage:t,data:e.storage})}static createShader(e,t,s){return new ai(e,ri.createDefinition(e,{name:s,vertexCode:t,useTransformFeedback:!0,fragmentCode:"void main(void) {gl_FragColor = vec4(0.0);}"}))}destroy(){this._outputBuffer.destroy()}process(e,t=!0){let s=this.device,i=s.getRenderTarget();if(s.setRenderTarget(null),s.updateBegin(),s.setVertexBuffer(this._inputBuffer,0),s.setRaster(!1),s.setTransformFeedbackBuffer(this._outputBuffer),s.setShader(e),s.draw({type:qr,base:0,baseVertex:0,count:this._inputBuffer.numVertices,indexed:!1}),s.setTransformFeedbackBuffer(null),s.setRaster(!0),s.updateEnd(),s.setRenderTarget(i),t){let r=this._inputBuffer.impl.bufferId;this._inputBuffer.impl.bufferId=this._outputBuffer.impl.bufferId,this._outputBuffer.impl.bufferId=r,r=this._inputBuffer.impl.vao,this._inputBuffer.impl.vao=this._outputBuffer.impl.vao,this._outputBuffer.impl.vao=r}}get inputBuffer(){return this._inputBuffer}get outputBuffer(){return this._outputBuffer}}});function Vre(o){this.array[this.index]=o}function kre(o,e){this.array[this.index]=o,this.array[this.index+1]=e}function Gre(o,e,t){this.array[this.index]=o,this.array[this.index+1]=e,this.array[this.index+2]=t}function zre(o,e,t,s){this.array[this.index]=o,this.array[this.index+1]=e,this.array[this.index+2]=t,this.array[this.index+3]=s}function Hre(o,e,t){this.array[o]=e[t]}function Xre(o,e,t){this.array[o]=e[t],this.array[o+1]=e[t+1]}function Wre(o,e,t){this.array[o]=e[t],this.array[o+1]=e[t+1],this.array[o+2]=e[t+2]}function Yre(o,e,t){this.array[o]=e[t],this.array[o+1]=e[t+1],this.array[o+2]=e[t+2],this.array[o+3]=e[t+3]}function Kre(o,e,t){e[t]=this.array[o]}function qre(o,e,t){e[t]=this.array[o],e[t+1]=this.array[o+1]}function jre(o,e,t){e[t]=this.array[o],e[t+1]=this.array[o+1],e[t+2]=this.array[o+2]}function $re(o,e,t){e[t]=this.array[o],e[t+1]=this.array[o+1],e[t+2]=this.array[o+2],e[t+3]=this.array[o+3]}var Tw,ua,pS=m(()=>{j();Tw=class{constructor(e,t,s){switch(this.index=0,this.numComponents=t.numComponents,s.interleaved?this.array=new Xa[t.dataType](e,t.offset):this.array=new Xa[t.dataType](e,t.offset,s.vertexCount*t.numComponents),this.stride=t.stride/this.array.constructor.BYTES_PER_ELEMENT,t.numComponents){case 1:this.set=Vre,this.getToArray=Kre,this.setFromArray=Hre;break;case 2:this.set=kre,this.getToArray=qre,this.setFromArray=Xre;break;case 3:this.set=Gre,this.getToArray=jre,this.setFromArray=Wre;break;case 4:this.set=zre,this.getToArray=$re,this.setFromArray=Yre;break}}get(e){return this.array[this.index+e]}set(e,t,s,i){}getToArray(e,t,s){}setFromArray(e,t,s){}},ua=class{constructor(e){this.vertexBuffer=e,this.vertexFormatSize=e.getFormat().size,this.buffer=this.vertexBuffer.lock(),this.accessors=[],this.element={};let t=this.vertexBuffer.getFormat();for(let s=0;s<t.elements.length;s++){let i=t.elements[s];this.accessors[s]=new Tw(this.buffer,i,t),this.element[i.name]=this.accessors[s]}}next(e=1){let t=0,s=this.accessors,i=this.accessors.length;for(;t<i;){let r=s[t++];r.index+=e*r.stride}}end(){this.vertexBuffer.unlock()}writeData(e,t,s){let i=this.element[e];if(i){s>this.vertexBuffer.numVertices&&(s=this.vertexBuffer.numVertices);let r=i.numComponents;if(this.vertexBuffer.getFormat().interleaved){let a=0;for(let n=0;n<s;n++)i.setFromArray(a,t,n*r),a+=i.stride}else if(t.length>s*r){let a=s*r;if(ArrayBuffer.isView(t))t=t.subarray(0,a),i.array.set(t);else for(let n=0;n<a;n++)i.array[n]=t[n]}else i.array.set(t)}}readData(e,t){let s=this.element[e],i=0;if(s){i=this.vertexBuffer.numVertices;let r,a=s.numComponents;if(this.vertexBuffer.getFormat().interleaved){Array.isArray(t)&&(t.length=0),s.index=0;let n=0;for(r=0;r<i;r++)s.getToArray(n,t,r*a),n+=s.stride}else if(ArrayBuffer.isView(t))t.set(s.array);else{t.length=0;let n=i*a;for(r=0;r<n;r++)t[r]=s.array[r]}}return i}}});var dm,um,mm,s3,i3,r3,a3,n3,o3,l3,h3,c3,f3,d3,u3,m3,p3,_3,g3,S3,T3,E3,v3,x3,y3,A3,P3,R3,C3,I3,w3,L3,b3,M3,D3,O3,N3,F3,U3,B3,V3,k3,G3,z3,H3,X3,W3,Y3,K3,q3,j3,$3,Z3,Q3,J3,eF,tF,sF,iF,rF,aF,nF,oF,lF,hF,cF,fF,dF,uF,mF,pF,_F,gF,SF,TF,EF,vF,xF,yF,AF,PF,RF,CF,IF,wF,LF,bF,MF,DF,OF,NF,FF,UF,BF,VF,kF,GF,zF,HF,XF,WF,YF,KF,qF,jF,$F,ZF,Ew,_S,gS,SS,Hx,QF,JF,eU,vw,xw,yw,Aw,Pw,Rw,Cw,Iw,ww,Lw,bw,Mw,Dw,Ow,Nw,Fw,Uw,TS,ES,vS,xS,Bw,Vw,kw,Gw,zw,Hw,Xw,Ww,Yw,Kw,qw=m(()=>{dm="mouse",um="keyboard",mm="gamepad",s3="mousex",i3="mousey",r3="padlx",a3="padly",n3="padrx",o3="padry",l3="key",h3=8,c3=9,f3=13,d3=13,u3=16,m3=17,p3=18,_3=19,g3=20,S3=27,T3=32,E3=33,v3=34,x3=35,y3=36,A3=37,P3=38,R3=39,C3=40,I3=44,w3=45,L3=46,b3=48,M3=49,D3=50,O3=51,N3=52,F3=53,U3=54,B3=55,V3=56,k3=57,G3=59,z3=61,H3=65,X3=66,W3=67,Y3=68,K3=69,q3=70,j3=71,$3=72,Z3=73,Q3=74,J3=75,eF=76,tF=77,sF=78,iF=79,rF=80,aF=81,nF=82,oF=83,lF=84,hF=85,cF=86,fF=87,dF=88,uF=89,mF=90,pF=91,_F=93,gF=96,SF=97,TF=98,EF=99,vF=100,xF=101,yF=102,AF=103,PF=104,RF=105,CF=106,IF=107,wF=108,LF=109,bF=110,MF=111,DF=112,OF=113,NF=114,FF=115,UF=116,BF=117,VF=118,kF=119,GF=120,zF=121,HF=122,XF=123,WF=188,YF=190,KF=191,qF=219,jF=220,$F=221,ZF=224,Ew=-1,_S=0,gS=1,SS=2,Hx=0,QF=1,JF=2,eU=3,vw=0,xw=1,yw=2,Aw=3,Pw=4,Rw=5,Cw=6,Iw=7,ww=8,Lw=9,bw=10,Mw=11,Dw=12,Ow=13,Nw=14,Fw=15,Uw=16,TS=0,ES=1,vS=2,xS=3,Bw=0,Vw=1,kw=2,Gw=3,zw=2,Hw=0,Xw=1,Ww=3,Yw=4,Kw=5});var pm,jw=m(()=>{pm=class{constructor(e,t){this.key=null,this.element=null,this.event=null,t&&(this.key=t.keyCode,this.element=t.target,this.event=t)}}});function $w(o){return Xx.key=o.keyCode,Xx.element=o.target,Xx.event=o,Xx}function Wx(o){return typeof o=="string"?o.toUpperCase().charCodeAt(0):o}var Xx,Zre,_m,Zw=m(()=>{Pe();jw();Xx=new pm;Zre={9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",27:"Escape",37:"Left",38:"Up",39:"Right",40:"Down",46:"Delete",91:"Win"},_m=class extends K{static{this.EVENT_KEYDOWN="keydown"}static{this.EVENT_KEYUP="keyup"}constructor(e,t={}){super(),this._element=null,this._keymap={},this._lastmap={},this._keyDownHandler=this._handleKeyDown.bind(this),this._keyUpHandler=this._handleKeyUp.bind(this),this._keyPressHandler=this._handleKeyPress.bind(this),this._visibilityChangeHandler=this._handleVisibilityChange.bind(this),this._windowBlurHandler=this._handleWindowBlur.bind(this),e&&this.attach(e),this.preventDefault=t.preventDefault||!1,this.stopPropagation=t.stopPropagation||!1}attach(e){this._element&&this.detach(),this._element=e,this._element.addEventListener("keydown",this._keyDownHandler,!1),this._element.addEventListener("keypress",this._keyPressHandler,!1),this._element.addEventListener("keyup",this._keyUpHandler,!1),document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1),window.addEventListener("blur",this._windowBlurHandler,!1)}detach(){this._element&&(this._element.removeEventListener("keydown",this._keyDownHandler),this._element.removeEventListener("keypress",this._keyPressHandler),this._element.removeEventListener("keyup",this._keyUpHandler),this._element=null,document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),window.removeEventListener("blur",this._windowBlurHandler,!1))}toKeyIdentifier(e){e=Wx(e);let t=Zre[e.toString()];if(t)return t;let s=e.toString(16).toUpperCase(),i=s.length;for(let r=0;r<4-i;r++)s=`0${s}`;return`U+${s}`}_handleKeyDown(e){let t=e.keyCode||e.charCode;if(t===void 0)return;let s=this.toKeyIdentifier(t);this._keymap[s]=!0,this.fire("keydown",$w(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation()}_handleKeyUp(e){let t=e.keyCode||e.charCode;if(t===void 0)return;let s=this.toKeyIdentifier(t);delete this._keymap[s],this.fire("keyup",$w(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation()}_handleKeyPress(e){this.fire("keypress",$w(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation()}_handleVisibilityChange(){document.visibilityState==="hidden"&&this._handleWindowBlur()}_handleWindowBlur(){this._keymap={},this._lastmap={}}update(){for(let e in this._lastmap)delete this._lastmap[e];for(let e in this._keymap)this._keymap.hasOwnProperty(e)&&(this._lastmap[e]=this._keymap[e])}isPressed(e){let t=Wx(e),s=this.toKeyIdentifier(t);return!!this._keymap[s]}wasPressed(e){let t=Wx(e),s=this.toKeyIdentifier(t);return!!this._keymap[s]&&!this._lastmap[s]}wasReleased(e){let t=Wx(e),s=this.toKeyIdentifier(t);return!this._keymap[s]&&!!this._lastmap[s]}}});function Yx(){return!!(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)}var qa,Kx=m(()=>{qa=class o{constructor(e,t){this.x=0,this.y=0,this.dx=0,this.dy=0,this.button=-1,this.wheelDelta=0,this.ctrlKey=!1,this.altKey=!1,this.shiftKey=!1,this.metaKey=!1;let s={x:0,y:0};if(t){if(t instanceof o)throw Error("Expected MouseEvent");s=e._getTargetCoords(t)}else t={};if(s)this.x=s.x,this.y=s.y;else if(Yx())this.x=0,this.y=0;else return;t.type==="wheel"&&(t.deltaY>0?this.wheelDelta=1:t.deltaY<0&&(this.wheelDelta=-1)),Yx()?(this.dx=t.movementX||t.webkitMovementX||t.mozMovementX||0,this.dy=t.movementY||t.webkitMovementY||t.mozMovementY||0):(this.dx=this.x-e._lastX,this.dy=this.y-e._lastY),(t.type==="mousedown"||t.type==="mouseup")&&(this.button=t.button),this.buttons=e._buttons.slice(0),this.element=t.target,this.ctrlKey=t.ctrlKey??!1,this.altKey=t.altKey??!1,this.shiftKey=t.shiftKey??!1,this.metaKey=t.metaKey??!1,this.event=t}}});var ma,qx=m(()=>{bt();Pe();Kx();ma=class extends K{static{this.EVENT_MOUSEMOVE="mousemove"}static{this.EVENT_MOUSEDOWN="mousedown"}static{this.EVENT_MOUSEUP="mouseup"}static{this.EVENT_MOUSEWHEEL="mousewheel"}constructor(e){super(),this._lastX=0,this._lastY=0,this._buttons=[!1,!1,!1],this._lastbuttons=[!1,!1,!1],this._target=null,this._attached=!1,this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._contextMenuHandler=t=>{t.preventDefault()},this.attach(e)}static isPointerLocked(){return Yx()}attach(e){if(this._target=e,this._attached)return;this._attached=!0;let t={passive:!1},s=ue.passiveEvents?t:!1;window.addEventListener("mouseup",this._upHandler,s),window.addEventListener("mousedown",this._downHandler,s),window.addEventListener("mousemove",this._moveHandler,s),window.addEventListener("wheel",this._wheelHandler,s)}detach(){if(!this._attached)return;this._attached=!1,this._target=null;let e={passive:!1},t=ue.passiveEvents?e:!1;window.removeEventListener("mouseup",this._upHandler,t),window.removeEventListener("mousedown",this._downHandler,t),window.removeEventListener("mousemove",this._moveHandler,t),window.removeEventListener("wheel",this._wheelHandler,t)}disableContextMenu(){this._target&&this._target.addEventListener("contextmenu",this._contextMenuHandler)}enableContextMenu(){this._target&&this._target.removeEventListener("contextmenu",this._contextMenuHandler)}enablePointerLock(e,t){if(!document.body.requestPointerLock){t&&t();return}let s=()=>{e(),document.removeEventListener("pointerlockchange",s)},i=()=>{t(),document.removeEventListener("pointerlockerror",i)};e&&document.addEventListener("pointerlockchange",s,!1),t&&document.addEventListener("pointerlockerror",i,!1),document.body.requestPointerLock()}disablePointerLock(e){if(!document.exitPointerLock)return;let t=()=>{e(),document.removeEventListener("pointerlockchange",t)};e&&document.addEventListener("pointerlockchange",t,!1),document.exitPointerLock()}update(){this._lastbuttons[0]=this._buttons[0],this._lastbuttons[1]=this._buttons[1],this._lastbuttons[2]=this._buttons[2]}isPressed(e){return this._buttons[e]}wasPressed(e){return this._buttons[e]&&!this._lastbuttons[e]}wasReleased(e){return!this._buttons[e]&&this._lastbuttons[e]}_handleUp(e){this._buttons[e.button]=!1;let t=new qa(this,e);t.event&&this.fire("mouseup",t)}_handleDown(e){this._buttons[e.button]=!0;let t=new qa(this,e);t.event&&this.fire("mousedown",t)}_handleMove(e){let t=new qa(this,e);t.event&&(this.fire("mousemove",t),this._lastX=t.x,this._lastY=t.y)}_handleWheel(e){let t=new qa(this,e);t.event&&this.fire("mousewheel",t)}_getTargetCoords(e){let t=this._target.getBoundingClientRect(),s=Math.floor(t.left),i=Math.floor(t.top);return e.clientX<s||e.clientX>=s+this._target.clientWidth||e.clientY<i||e.clientY>=i+this._target.clientHeight?null:{x:e.clientX-s,y:e.clientY-i}}}});var jx,tU=m(()=>{qw();Zw();qx();jx=class{constructor(e,t={}){this._element=null,this._actions={},this._axes={},this._axesValues={},this._keyboard=t.keyboard||null,this._mouse=t.mouse||null,this._gamepads=t.gamepads||null,e&&this.attach(e)}attach(e){this._element=e,this._keyboard&&this._keyboard.attach(e),this._mouse&&this._mouse.attach(e)}detach(){this._keyboard&&this._keyboard.detach(),this._mouse&&this._mouse.detach(),this._element=null}disableContextMenu(){this._mouse||this._enableMouse(),this._mouse.disableContextMenu()}enableContextMenu(){this._mouse||this._enableMouse(),this._mouse.enableContextMenu()}update(e){this._keyboard&&this._keyboard.update(),this._mouse&&this._mouse.update(),this._gamepads&&this._gamepads.update(),this._axesValues={};for(let t in this._axes)this._axesValues[t]=[]}appendAction(e,t){this._actions[e]=this._actions[e]||[],this._actions[e].push(t)}registerKeys(e,t){if(this._keyboard||this._enableKeyboard(),this._actions[e])throw new Error(`Action: ${e} already registered`);if(t===void 0)throw new Error("Invalid button");t.length||(t=[t]),this.appendAction(e,{type:um,keys:t})}registerMouse(e,t){if(this._mouse||this._enableMouse(),t===void 0)throw new Error("Invalid button");this.appendAction(e,{type:dm,button:t})}registerPadButton(e,t,s){if(s===void 0)throw new Error("Invalid button");this.appendAction(e,{type:mm,button:s,pad:t})}registerAxis(e){let t=e.name;this._axes[t]||(this._axes[t]=[]);let s=this._axes[t].push(t);e=e||{},e.pad=e.pad||0;let i=function(r,a,n,l){switch(a){case"mousex":r._mouse.on("mousemove",h=>{r._axesValues[t][s]=h.dx/10});break;case"mousey":r._mouse.on("mousemove",h=>{r._axesValues[t][s]=h.dy/10});break;case"key":r._axes[t].push(()=>r._keyboard.isPressed(l)?n:0);break;case"padrx":r._axes[t].push(()=>r._gamepads.getAxis(e.pad,2));break;case"padry":r._axes[t].push(()=>r._gamepads.getAxis(e.pad,3));break;case"padlx":r._axes[t].push(()=>r._gamepads.getAxis(e.pad,0));break;case"padly":r._axes[t].push(()=>r._gamepads.getAxis(e.pad,1));break;default:throw new Error("Unknown axis")}};i(this,e.positive,1,e.positiveKey),(e.negativeKey||e.negative!==e.positive)&&i(this,e.negative,-1,e.negativeKey)}isPressed(e){if(!this._actions[e])return!1;let t=this._actions[e].length;for(let s=0;s<t;++s){let i=this._actions[e][s];switch(i.type){case um:if(this._keyboard){let r=i.keys.length;for(let a=0;a<r;a++)if(this._keyboard.isPressed(i.keys[a]))return!0}break;case dm:if(this._mouse&&this._mouse.isPressed(i.button))return!0;break;case mm:if(this._gamepads&&this._gamepads.isPressed(i.pad,i.button))return!0;break}}return!1}wasPressed(e){if(!this._actions[e])return!1;let t=this._actions[e].length;for(let s=0;s<t;++s){let i=this._actions[e][s];switch(i.type){case um:if(this._keyboard){let r=i.keys.length;for(let a=0;a<r;a++)if(this._keyboard.wasPressed(i.keys[a]))return!0}break;case dm:if(this._mouse&&this._mouse.wasPressed(i.button))return!0;break;case mm:if(this._gamepads&&this._gamepads.wasPressed(i.pad,i.button))return!0;break}}return!1}getAxis(e){let t=0;if(this._axes[e]){let s=this._axes[e].length;for(let i=0;i<s;i++)if(typeof this._axes[e][i]=="function"){let r=this._axes[e][i]();Math.abs(r)>Math.abs(t)&&(t=r)}else this._axesValues[e]&&Math.abs(this._axesValues[e][i])>Math.abs(t)&&(t=this._axesValues[e][i])}return t}_enableMouse(){if(this._mouse=new ma,!this._element)throw new Error("Controller must be attached to an Element");this._mouse.attach(this._element)}_enableKeyboard(){if(this._keyboard=new _m,!this._element)throw new Error("Controller must be attached to an Element");this._keyboard.attach(this._element)}}});function aU(o){let e=$x[o.id];if(e)return e;for(let i in iU)if(o.id.indexOf(i)!==-1){let r=iU[i];if(!o.mapping){let a=yS[`RAW_${r}`];if(a)return a}return yS[r]}if(o.mapping==="xr-standard")return yS.DEFAULT_XR;let t=yS.DEFAULT,s=o.buttons.length<t.buttons.length?yS.DEFAULT_DUAL:t;return s.mapping=o.mapping,s}function Qre(o){return new Promise(e=>{setTimeout(e,o)})}var rU,Jw,sU,yS,iU,$x,eL,AS,Qw,Zx,Qx,nU=m(()=>{Pe();me();bt();rU=Object.freeze([]),Jw=function(){return rU};typeof navigator<"u"&&(Jw=(navigator.getGamepads||navigator.webkitGetGamepads||Jw).bind(navigator));sU={buttons:{PAD_FACE_1:0,PAD_FACE_2:1,PAD_FACE_3:2,PAD_FACE_4:3,PAD_L_SHOULDER_1:4,PAD_R_SHOULDER_1:5,PAD_L_SHOULDER_2:6,PAD_R_SHOULDER_2:7,PAD_SELECT:8,PAD_START:9,PAD_L_STICK_BUTTON:10,PAD_R_STICK_BUTTON:11,PAD_UP:12,PAD_DOWN:13,PAD_LEFT:14,PAD_RIGHT:15,PAD_VENDOR:16,XRPAD_TRIGGER:0,XRPAD_SQUEEZE:1,XRPAD_TOUCHPAD_BUTTON:2,XRPAD_STICK_BUTTON:3,XRPAD_A:4,XRPAD_B:5},axes:{PAD_L_STICK_X:0,PAD_L_STICK_Y:1,PAD_R_STICK_X:2,PAD_R_STICK_Y:3,XRPAD_TOUCHPAD_X:0,XRPAD_TOUCHPAD_Y:1,XRPAD_STICK_X:2,XRPAD_STICK_Y:3}},yS={DEFAULT:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_3","PAD_FACE_4","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_UP","PAD_DOWN","PAD_LEFT","PAD_RIGHT","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]},DEFAULT_DUAL:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_3","PAD_FACE_4","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"],synthesizedButtons:{PAD_UP:{axis:0,min:0,max:1},PAD_DOWN:{axis:0,min:-1,max:0},PAD_LEFT:{axis:0,min:-1,max:0},PAD_RIGHT:{axis:0,min:0,max:1}}},PS3:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_4","PAD_FACE_3","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_UP","PAD_DOWN","PAD_LEFT","PAD_RIGHT","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"],mapping:"standard"},DEFAULT_XR:{buttons:["XRPAD_TRIGGER","XRPAD_SQUEEZE","XRPAD_TOUCHPAD_BUTTON","XRPAD_STICK_BUTTON","XRPAD_A","XRPAD_B"],axes:["XRPAD_TOUCHPAD_X","XRPAD_TOUCHPAD_Y","XRPAD_STICK_X","XRPAD_STICK_Y"],mapping:"xr-standard"}},iU={"Product: 0268":"PS3"},$x={};eL=.25;AS=class{constructor(e,t){this.value=0,this.pressed=!1,this.touched=!1,this.wasPressed=!1,this.wasReleased=!1,this.wasTouched=!1,typeof e=="number"?(this.value=e,this.pressed=e===1,this.touched=e>0):(this.value=e.value,this.pressed=e.pressed,this.touched=e.touched??e.value>0),t&&(typeof t=="number"?(this.wasPressed=t!==1&&this.pressed,this.wasReleased=t===1&&!this.pressed,this.wasTouched=t===0&&this.touched):(this.wasPressed=!t.pressed&&this.pressed,this.wasReleased=t.pressed&&!this.pressed,this.wasTouched=!(t.touched??t.value>0)&&this.touched))}update(e){let{value:t,pressed:s}=e,i=e.touched??t>0;this.wasPressed=!this.pressed&&s,this.wasReleased=this.pressed&&!s,this.wasTouched=!this.touched&&i,this.value=t,this.pressed=s,this.touched=i}},Qw=Object.freeze(new AS(0)),Zx=class{constructor(e,t){this._compiledMapping={buttons:[],axes:[]},this.id=e.id,this.index=e.index,this._buttons=e.buttons.map(s=>new AS(s)),this._axes=[...e.axes],this._previousAxes=[...e.axes],this.mapping=t.mapping,this.map=t,this.hand=e.hand||"none",this.pad=e,this._compileMapping()}get connected(){return this.pad.connected}_compileMapping(){let{axes:e,buttons:t}=this._compiledMapping,s=sU.axes,i=sU.buttons;e.length=0,t.length=0,this.map.axes&&this.map.axes.forEach((l,h)=>{e[s[l]]=()=>this.pad.axes[h]||0});for(let l=0,h=e.length;l<h;l++)e[l]||(e[l]=()=>0);let a=this.map.buttons;a&&a.forEach((l,h)=>{t[i[l]]=()=>this._buttons[h]||Qw});let n=this.map.synthesizedButtons;n&&Object.entries(n).forEach(l=>{let{axis:h,max:c,min:f}=l[1];t[i[l[0]]]=()=>new AS(Math.abs(w.clamp(this._axes[h]??0,f,c)),Math.abs(w.clamp(this._previousAxes[h]??0,f,c)))});for(let l=0,h=t.length;l<h;l++)t[l]||(t[l]=()=>Qw)}update(e){this.pad=e;let t=this._previousAxes,s=this._axes;t.length=0,t.push(...s),s.length=0,s.push(...e.axes);let i=this._buttons;for(let r=0,a=i.length;r<a;r++)i[r].update(e.buttons[r]);return this}updateMap(e){e.mapping="custom",$x[this.id]=e,this.map=e,this.mapping="custom",this._compileMapping()}resetMap(){if($x[this.id]){delete $x[this.id];let e=aU(this.pad);this.map=e,this.mapping=e.mapping,this._compileMapping()}}get axes(){return this._compiledMapping.axes.map(e=>e())}get buttons(){return this._compiledMapping.buttons.map(e=>e())}async pulse(e,t,s){let i=this.pad.vibrationActuator?[this.pad.vibrationActuator]:this.pad.hapticActuators||rU;if(i.length){let r=s?.startDelay??0,a=s?.strongMagnitude??e,n=s?.weakMagnitude??e;return(await Promise.all(i.map(async h=>h?h.playEffect?h.playEffect(h.type,{duration:t,startDelay:r,strongMagnitude:a,weakMagnitude:n}):h.pulse?(await Qre(r),h.pulse(e,t)):!1:!0))).some(h=>h===!0||h==="complete")}return!1}getButton(e){let t=this._compiledMapping.buttons[e];return t?t():Qw}isPressed(e){return this.getButton(e).pressed}wasPressed(e){return this.getButton(e).wasPressed}wasReleased(e){return this.getButton(e).wasReleased}isTouched(e){return this.getButton(e).touched}wasTouched(e){return this.getButton(e).wasTouched}getValue(e){return this.getButton(e).value}getAxis(e){let t=this.axes[e];return t&&Math.abs(t)>eL?t:0}},Qx=class extends K{static{this.EVENT_GAMEPADCONNECTED="gamepadconnected"}static{this.EVENT_GAMEPADDISCONNECTED="gamepaddisconnected"}constructor(){super(),this.gamepadsSupported=ue.gamepads,this.current=[],this._previous=[],this._ongamepadconnectedHandler=this._ongamepadconnected.bind(this),this._ongamepaddisconnectedHandler=this._ongamepaddisconnected.bind(this),window.addEventListener("gamepadconnected",this._ongamepadconnectedHandler,!1),window.addEventListener("gamepaddisconnected",this._ongamepaddisconnectedHandler,!1),this.poll()}set deadZone(e){eL=e}get deadZone(){return eL}get previous(){let e=this.current;for(let t=0,s=e.length;t<s;t++){let i=e[t]._buttons;this._previous[t]||(this._previous[t]=[]);for(let r=0,a=i.length;r<a;r++){let n=i[t];this.previous[t][r]=n?!n.wasPressed&&n.pressed||n.wasReleased:!1}}return this._previous.length=this.current.length,this._previous}_ongamepadconnected(e){let t=new Zx(e.gamepad,this.getMap(e.gamepad)),s=this.current,i=s.findIndex(r=>r.index===t.index);for(;i!==-1;)s.splice(i,1),i=s.findIndex(r=>r.index===t.index);s.push(t),this.fire("gamepadconnected",t)}_ongamepaddisconnected(e){let t=this.current,s=t.findIndex(i=>i.index===e.gamepad.index);s!==-1&&(this.fire("gamepaddisconnected",t[s]),t.splice(s,1))}update(){this.poll()}poll(e=[]){e.length>0&&(e.length=0);let t=Jw();for(let s=0,i=t.length;s<i;s++)if(t[s]){let r=this.findByIndex(t[s].index);if(r)e.push(r.update(t[s]));else{let a=new Zx(t[s],this.getMap(t[s]));this.current.push(a),e.push(a)}}return e}destroy(){window.removeEventListener("gamepadconnected",this._ongamepadconnectedHandler,!1),window.removeEventListener("gamepaddisconnected",this._ongamepaddisconnectedHandler,!1)}getMap(e){return aU(e)}isPressed(e,t){return this.current[e]?.isPressed(t)||!1}wasPressed(e,t){return this.current[e]?.wasPressed(t)||!1}wasReleased(e,t){return this.current[e]?.wasReleased(t)||!1}getAxis(e,t){return this.current[e]?.getAxis(t)||0}pulse(e,t,s,i){let r=this.current[e];return r?r.pulse(t,s,i):Promise.resolve(!1)}pulseAll(e,t,s){return Promise.all(this.current.map(i=>i.pulse(e,t,s)))}findById(e){return this.current.find(t=>t&&t.id===e)||null}findByIndex(e){return this.current.find(t=>t&&t.index===e)||null}}});function Ef(o){let e=0,t=0,s=o.target;for(;!(s instanceof HTMLElement)&&s;)s=s.parentNode;for(;s;)e+=s.offsetLeft-s.scrollLeft,t+=s.offsetTop-s.scrollTop,s=s.offsetParent;return{x:o.pageX-e,y:o.pageY-t}}var gm,$o,Jx=m(()=>{gm=class{constructor(e){let t=Ef(e);this.id=e.identifier,this.x=t.x,this.y=t.y,this.target=e.target,this.touch=e}},$o=class{constructor(e,t){this.touches=[],this.changedTouches=[],this.element=t.target,this.event=t,this.touches=Array.from(t.touches).map(s=>new gm(s)),this.changedTouches=Array.from(t.changedTouches).map(s=>new gm(s))}getTouchById(e,t){return t.find(s=>s.id===e)||null}}});var Sm,oU=m(()=>{Pe();Jx();Sm=class extends K{static{this.EVENT_TOUCHSTART="touchstart"}static{this.EVENT_TOUCHEND="touchend"}static{this.EVENT_TOUCHMOVE="touchmove"}static{this.EVENT_TOUCHCANCEL="touchcancel"}constructor(e){super(),this._element=null,this._startHandler=this._handleTouchStart.bind(this),this._endHandler=this._handleTouchEnd.bind(this),this._moveHandler=this._handleTouchMove.bind(this),this._cancelHandler=this._handleTouchCancel.bind(this),this.attach(e)}attach(e){this._element&&this.detach(),this._element=e,this._element.addEventListener("touchstart",this._startHandler,!1),this._element.addEventListener("touchend",this._endHandler,!1),this._element.addEventListener("touchmove",this._moveHandler,!1),this._element.addEventListener("touchcancel",this._cancelHandler,!1)}detach(){this._element&&(this._element.removeEventListener("touchstart",this._startHandler,!1),this._element.removeEventListener("touchend",this._endHandler,!1),this._element.removeEventListener("touchmove",this._moveHandler,!1),this._element.removeEventListener("touchcancel",this._cancelHandler,!1)),this._element=null}_handleTouchStart(e){this.fire("touchstart",new $o(this,e))}_handleTouchEnd(e){this.fire("touchend",new $o(this,e))}_handleTouchMove(e){e.preventDefault(),this.fire("touchmove",new $o(this,e))}_handleTouchCancel(e){this.fire("touchcancel",new $o(this,e))}}});var jt,Le,Ct=m(()=>{su();ql();Fs();QC();me();jt=class o{static{this.ContentType={AAC:"audio/aac",BASIS:"image/basis",BIN:"application/octet-stream",DDS:"image/dds",FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",GLB:"model/gltf-binary",JPEG:"image/jpeg",JSON:"application/json",MP3:"audio/mpeg",MP4:"audio/mp4",OGG:"audio/ogg",OPUS:'audio/ogg; codecs="opus"',PNG:"image/png",TEXT:"text/plain",WAV:"audio/x-wav",XML:"application/xml"}}static{this.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document",JSON:"json"}}static{this.binaryExtensions=[".model",".wav",".ogg",".mp3",".mp4",".m4a",".aac",".dds",".basis",".glb",".opus"]}static{this.retryDelay=100}get(e,t,s){typeof t=="function"&&(s=t,t={});let i=this.request("GET",e,t,s),{progress:r}=t;if(r){let a=l=>{l.lengthComputable&&r.fire("progress",l.loaded,l.total)},n=l=>{a(l),i.removeEventListener("loadstart",a),i.removeEventListener("progress",a),i.removeEventListener("loadend",n)};i.addEventListener("loadstart",a),i.addEventListener("progress",a),i.addEventListener("loadend",n)}return i}post(e,t,s,i){return typeof s=="function"&&(i=s,s={}),s.postdata=t,this.request("POST",e,s,i)}put(e,t,s,i){return typeof s=="function"&&(i=s,s={}),s.postdata=t,this.request("PUT",e,s,i)}del(e,t,s){return typeof t=="function"&&(s=t,t={}),this.request("DELETE",e,t,s)}request(e,t,s,i){let r,a,n,l=!1;if(typeof s=="function"&&(i=s,s={}),s.retry&&(s=Object.assign({retries:0,maxRetries:5},s)),s.callback=i,s.async==null&&(s.async=!0),s.headers==null&&(s.headers={}),s.postdata!=null)if(s.postdata instanceof Document)n=s.postdata;else if(s.postdata instanceof FormData)n=s.postdata;else if(s.postdata instanceof Object){let c=s.headers["Content-Type"];switch(c===void 0&&(s.headers["Content-Type"]=o.ContentType.FORM_URLENCODED,c=s.headers["Content-Type"]),c){case o.ContentType.FORM_URLENCODED:{n="";let f=!0;for(let d in s.postdata)if(s.postdata.hasOwnProperty(d)){f?f=!1:n+="&";let u=encodeURIComponent(d),p=encodeURIComponent(s.postdata[d]);n+=`${u}=${p}`}break}default:case o.ContentType.JSON:c==null&&(s.headers["Content-Type"]=o.ContentType.JSON),n=JSON.stringify(s.postdata);break}}else n=s.postdata;if(s.cache===!1){let c=Us();r=new jl(t),r.query?r.query=`${r.query}&ts=${c}`:r.query=`ts=${c}`,t=r.toString()}s.query&&(r=new jl(t),a=Hl(r.getQuery(),s.query),r.setQuery(a),t=r.toString());let h=new XMLHttpRequest;h.open(e,t,s.async),h.withCredentials=s.withCredentials!==void 0?s.withCredentials:!1,h.responseType=s.responseType||this._guessResponseType(t);for(let c in s.headers)s.headers.hasOwnProperty(c)&&h.setRequestHeader(c,s.headers[c]);h.onreadystatechange=()=>{this._onReadyStateChange(e,t,s,h)},h.onerror=()=>{this._onError(e,t,s,h),l=!0};try{h.send(n)}catch(c){l||s.error(h.status,h,c)}return h}_guessResponseType(e){let t=new jl(e),s=ve.getExtension(t.path).toLowerCase();return o.binaryExtensions.indexOf(s)>=0?o.ResponseType.ARRAY_BUFFER:s===".json"?o.ResponseType.JSON:s===".xml"?o.ResponseType.DOCUMENT:o.ResponseType.TEXT}_isBinaryContentType(e){return[o.ContentType.BASIS,o.ContentType.BIN,o.ContentType.DDS,o.ContentType.GLB,o.ContentType.MP3,o.ContentType.MP4,o.ContentType.OGG,o.ContentType.OPUS,o.ContentType.WAV].indexOf(e)>=0}_isBinaryResponseType(e){return e===o.ResponseType.ARRAY_BUFFER||e===o.ResponseType.BLOB||e===o.ResponseType.JSON}_onReadyStateChange(e,t,s,i){if(i.readyState===4)switch(i.status){case 0:{i.responseURL&&i.responseURL.startsWith("file:///")?this._onSuccess(e,t,s,i):this._onError(e,t,s,i);break}case 200:case 201:case 206:case 304:{this._onSuccess(e,t,s,i);break}default:{this._onError(e,t,s,i);break}}}_onSuccess(e,t,s,i){let r,a,n=i.getResponseHeader("Content-Type");n&&(a=n.split(";")[0].trim());try{this._isBinaryContentType(a)||this._isBinaryResponseType(i.responseType)?r=i.response:a===o.ContentType.JSON||t.split("?")[0].endsWith(".json")?r=JSON.parse(i.responseText):i.responseType===o.ResponseType.DOCUMENT||a===o.ContentType.XML?r=i.responseXML:r=i.responseText,s.callback(null,r)}catch(l){s.callback(l)}}_onError(e,t,s,i){if(!s.retrying)if(s.retry&&s.retries<s.maxRetries){s.retries++,s.retrying=!0;let r=w.clamp(Math.pow(2,s.retries)*o.retryDelay,0,s.maxRetryDelay||5e3);console.log(`${e}: ${t} - Error ${i.status}. Retrying in ${r} ms`),setTimeout(()=>{s.retrying=!1,this.request(e,t,s,s.callback)},r)}else s.callback(i.status===0?"Network error":i.status,null)}},Le=new jt});var vf,ey,ty,sy=m(()=>{vf="linear",ey="inverse",ty="exponential"});var iy,lU=m(()=>{Ke();Q();iy=class{constructor(e){this.position=new g,this.orientation=new k,this._manager=e}getPosition(){return this.position}setPosition(e){this.position.copy(e);let t=this.listener;t&&("positionX"in t?(t.positionX.value=e.x,t.positionY.value=e.y,t.positionZ.value=e.z):t.setPosition&&t.setPosition(e.x,e.y,e.z))}setOrientation(e){this.orientation.copy(e);let t=this.listener;if(t){let s=e.data;"forwardX"in t?(t.forwardX.value=-s[8],t.forwardY.value=-s[9],t.forwardZ.value=-s[10],t.upX.value=s[4],t.upY.value=s[5],t.upZ.value=s[6]):t.setOrientation&&t.setOrientation(-s[8],-s[9],-s[10],s[4],s[5],s[6])}}getOrientation(){return this.orientation}get listener(){let e=this._manager.context;return e?e.listener:null}}});var ry,hU,Tm,tL=m(()=>{Pe();me();lU();ry="running",hU=["click","touchstart","mousedown"],Tm=class extends K{constructor(){super(),this._context=null,this.AudioContext=typeof AudioContext<"u"&&AudioContext||typeof webkitAudioContext<"u"&&webkitAudioContext,this.AudioContext,this._unlockHandlerFunc=this._unlockHandler.bind(this),this._userSuspended=!1,this.listener=new iy(this),this._volume=1}set volume(e){e=w.clamp(e,0,1),this._volume=e,this.fire("volumechange",e)}get volume(){return this._volume}get suspended(){return this._userSuspended}get context(){return!this._context&&this.AudioContext&&(this._context=new this.AudioContext,this._context.state!==ry&&this._registerUnlockListeners()),this._context}suspend(){this._userSuspended||(this._userSuspended=!0,this._context&&this._context.state===ry&&this._suspend())}resume(){this._userSuspended&&(this._userSuspended=!1,this._context&&this._context.state!==ry&&this._resume())}destroy(){this.fire("destroy"),this._context&&(this._removeUnlockListeners(),this._context?.close(),this._context=null)}_resume(){this._context.resume().then(()=>{let e=this._context.createBufferSource();e.buffer=this._context.createBuffer(1,1,this._context.sampleRate),e.connect(this._context.destination),e.start(0),e.onended=t=>{e.disconnect(0),this.fire("resume")}},e=>{}).catch(e=>{})}_suspend(){this._context.suspend().then(()=>{this.fire("suspend")},e=>{}).catch(e=>{})}_unlockHandler(){this._removeUnlockListeners(),!this._userSuspended&&this._context.state!==ry&&this._resume()}_registerUnlockListeners(){hU.forEach(e=>{window.addEventListener(e,this._unlockHandlerFunc,!1)})}_removeUnlockListeners(){hU.forEach(e=>{window.removeEventListener(e,this._unlockHandlerFunc,!1)})}}});var Em,sL=m(()=>{Em=class{constructor(e){e instanceof Audio?this.audio=e:this.buffer=e}get duration(){let e=0;return this.buffer?e=this.buffer.duration:this.audio&&(e=this.audio.duration),e||0}}});function Zo(){return typeof AudioContext<"u"||typeof webkitAudioContext<"u"}var PS=m(()=>{});function Ji(o,e){return o%e||0}var Qi,vm,ja,Ir,ay=m(()=>{Pe();me();PS();Qi=0,vm=1,ja=2;Ir=class extends K{static{this.EVENT_PLAY="play"}static{this.EVENT_PAUSE="pause"}static{this.EVENT_RESUME="resume"}static{this.EVENT_STOP="stop"}static{this.EVENT_END="end"}constructor(e,t,s){super(),this.source=null,this._manager=e,this._volume=s.volume!==void 0?w.clamp(Number(s.volume)||0,0,1):1,this._pitch=s.pitch!==void 0?Math.max(.01,Number(s.pitch)||0):1,this._loop=!!(s.loop!==void 0&&s.loop),this._sound=t,this._state=ja,this._suspended=!1,this._suspendEndEvent=0,this._suspendInstanceEvents=!1,this._playWhenLoaded=!0,this._startTime=Math.max(0,Number(s.startTime)||0),this._duration=Math.max(0,Number(s.duration)||0),this._startOffset=null,this._onPlayCallback=s.onPlay,this._onPauseCallback=s.onPause,this._onResumeCallback=s.onResume,this._onStopCallback=s.onStop,this._onEndCallback=s.onEnd,Zo()?(this._startedAt=0,this._currentTime=0,this._currentOffset=0,this._inputNode=null,this._connectorNode=null,this._firstNode=null,this._lastNode=null,this._waitingContextSuspension=!1,this._initializeNodes(),this._endedHandler=this._onEnded.bind(this)):(this._isReady=!1,this._loadedMetadataHandler=this._onLoadedMetadata.bind(this),this._timeUpdateHandler=this._onTimeUpdate.bind(this),this._endedHandler=this._onEnded.bind(this),this._createSource())}set currentTime(e){if(!(e<0))if(this._state===Qi){let t=this._suspendInstanceEvents;this._suspendInstanceEvents=!0,this.stop(),this._startOffset=e,this.play(),this._suspendInstanceEvents=t}else this._startOffset=e,this._currentTime=e}get currentTime(){return this._startOffset!==null?this._startOffset:this._state===vm?this._currentTime:this._state===ja||!this.source?0:(this._updateCurrentTime(),this._currentTime)}set duration(e){this._duration=Math.max(0,Number(e)||0);let t=this._state===Qi;this.stop(),t&&this.play()}get duration(){return this._sound?this._duration?Ji(this._duration,this._sound.duration):this._sound.duration:0}get isPaused(){return this._state===vm}get isPlaying(){return this._state===Qi}get isStopped(){return this._state===ja}get isSuspended(){return this._suspended}set loop(e){this._loop=!!e,this.source&&(this.source.loop=this._loop)}get loop(){return this._loop}set pitch(e){this._currentOffset=this.currentTime,this._startedAt=this._manager.context.currentTime,this._pitch=Math.max(Number(e)||0,.01),this.source&&(this.source.playbackRate.value=this._pitch)}get pitch(){return this._pitch}set sound(e){this._sound=e,this._state!==ja?this.stop():this._createSource()}get sound(){return this._sound}set startTime(e){this._startTime=Math.max(0,Number(e)||0);let t=this._state===Qi;this.stop(),t&&this.play()}get startTime(){return this._startTime}set volume(e){e=w.clamp(e,0,1),this._volume=e,this.gain&&(this.gain.gain.value=e*this._manager.volume)}get volume(){return this._volume}_onPlay(){this.fire("play"),this._onPlayCallback&&this._onPlayCallback(this)}_onPause(){this.fire("pause"),this._onPauseCallback&&this._onPauseCallback(this)}_onResume(){this.fire("resume"),this._onResumeCallback&&this._onResumeCallback(this)}_onStop(){this.fire("stop"),this._onStopCallback&&this._onStopCallback(this)}_onEnded(){if(this._suspendEndEvent>0){this._suspendEndEvent--;return}this.fire("end"),this._onEndCallback&&this._onEndCallback(this),this.stop()}_onManagerVolumeChange(){this.volume=this._volume}_onManagerSuspend(){this._state===Qi&&!this._suspended&&(this._suspended=!0,this.pause())}_onManagerResume(){this._suspended&&(this._suspended=!1,this.resume())}_initializeNodes(){this.gain=this._manager.context.createGain(),this._inputNode=this.gain,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination)}play(){return this._state!==ja&&this.stop(),this._state=Qi,this._playWhenLoaded=!1,this._waitingContextSuspension?!1:this._manager.suspended?(this._manager.once("resume",this._playAudioImmediate,this),this._waitingContextSuspension=!0,!1):(this._playAudioImmediate(),!0)}_playAudioImmediate(){if(this._waitingContextSuspension=!1,this._state!==Qi)return;this.source||this._createSource();let e=Ji(this._startOffset,this.duration);e=Ji(this._startTime+e,this._sound.duration),this._startOffset=null,this._duration?this.source.start(0,e,this._duration):this.source.start(0,e),this._startedAt=this._manager.context.currentTime,this._currentTime=0,this._currentOffset=e,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._suspendInstanceEvents||this._onPlay()}pause(){return this._playWhenLoaded=!1,this._state!==Qi?!1:(this._state=vm,this._waitingContextSuspension||(this._updateCurrentTime(),this._suspendEndEvent++,this.source.stop(0),this.source=null,this._startOffset=null,this._suspendInstanceEvents||this._onPause()),!0)}resume(){if(this._state!==vm)return!1;let e=this.currentTime;return this._state=Qi,this._waitingContextSuspension||(this.source||this._createSource(),this._startOffset!==null&&(e=Ji(this._startOffset,this.duration),e=Ji(this._startTime+e,this._sound.duration),this._startOffset=null),this._duration?this.source.start(0,e,this._duration):this.source.start(0,e),this._startedAt=this._manager.context.currentTime,this._currentOffset=e,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._playWhenLoaded=!1,this._suspendInstanceEvents||this._onResume()),!0}stop(){if(this._playWhenLoaded=!1,this._state===ja)return!1;let e=this._state===Qi;return this._state=ja,this._waitingContextSuspension||(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._startedAt=0,this._currentTime=0,this._currentOffset=0,this._startOffset=null,this._suspendEndEvent++,e&&this.source&&this.source.stop(0),this.source=null,this._suspendInstanceEvents||this._onStop()),!0}setExternalNodes(e,t){if(!e){console.error("The firstNode must be a valid Audio Node");return}t||(t=e);let s=this._manager.context.destination;this._firstNode!==e&&(this._firstNode?this._connectorNode.disconnect(this._firstNode):this._connectorNode.disconnect(s),this._firstNode=e,this._connectorNode.connect(e)),this._lastNode!==t&&(this._lastNode&&this._lastNode.disconnect(s),this._lastNode=t,this._lastNode.connect(s))}clearExternalNodes(){let e=this._manager.context.destination;this._firstNode&&(this._connectorNode.disconnect(this._firstNode),this._firstNode=null),this._lastNode&&(this._lastNode.disconnect(e),this._lastNode=null),this._connectorNode.connect(e)}getExternalNodes(){return[this._firstNode,this._lastNode]}_createSource(){if(!this._sound)return null;let e=this._manager.context;return this._sound.buffer&&(this.source=e.createBufferSource(),this.source.buffer=this._sound.buffer,this.source.connect(this._inputNode),this.source.onended=this._endedHandler,this.source.loopStart=Ji(this._startTime,this.source.buffer.duration),this._duration&&(this.source.loopEnd=Math.max(this.source.loopStart,Ji(this._startTime+this._duration,this.source.buffer.duration)))),this.source}_updateCurrentTime(){this._currentTime=Ji((this._manager.context.currentTime-this._startedAt)*this._pitch+this._currentOffset,this.duration)}_onManagerDestroy(){this.source&&this._state===Qi&&(this.source.stop(0),this.source=null)}};Zo()||(Object.assign(Ir.prototype,{play:function(){return this._state!==ja&&this.stop(),!this.source&&!this._createSource()?!1:(this.volume=this._volume,this.pitch=this._pitch,this.loop=this._loop,this.source.play(),this._state=Qi,this._playWhenLoaded=!1,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._manager.suspended&&this._onManagerSuspend(),this._suspendInstanceEvents||this._onPlay(),!0)},pause:function(){return!this.source||this._state!==Qi?!1:(this._suspendEndEvent++,this.source.pause(),this._playWhenLoaded=!1,this._state=vm,this._startOffset=null,this._suspendInstanceEvents||this._onPause(),!0)},resume:function(){return!this.source||this._state!==vm?!1:(this._state=Qi,this._playWhenLoaded=!1,this.source.paused&&(this.source.play(),this._suspendInstanceEvents||this._onResume()),!0)},stop:function(){return!this.source||this._state===ja?!1:(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._suspendEndEvent++,this.source.pause(),this._playWhenLoaded=!1,this._state=ja,this._startOffset=null,this._suspendInstanceEvents||this._onStop(),!0)},setExternalNodes:function(){},clearExternalNodes:function(){},getExternalNodes:function(){return[null,null]},_onLoadedMetadata:function(){this.source.removeEventListener("loadedmetadata",this._loadedMetadataHandler),this._isReady=!0;let o=Ji(this._startOffset,this.duration);o=Ji(this._startTime+o,this._sound.duration),this._startOffset=null,this.source.currentTime=o},_createSource:function(){return this._sound&&this._sound.audio&&(this._isReady=!1,this.source=this._sound.audio.cloneNode(!0),this.source.addEventListener("loadedmetadata",this._loadedMetadataHandler),this.source.addEventListener("timeupdate",this._timeUpdateHandler),this.source.onended=this._endedHandler),this.source},_onTimeUpdate:function(){this._duration&&this.source.currentTime>Ji(this._startTime+this._duration,this.source.duration)&&(this.loop?this.source.currentTime=Ji(this._startTime,this.source.duration):(this.source.removeEventListener("timeupdate",this._timeUpdateHandler),this.source.pause(),this._onEnded()))},_onManagerDestroy:function(){this.source&&this.source.pause()}}),Object.defineProperty(Ir.prototype,"volume",{get:function(){return this._volume},set:function(o){o=w.clamp(o,0,1),this._volume=o,this.source&&(this.source.volume=o*this._manager.volume)}}),Object.defineProperty(Ir.prototype,"pitch",{get:function(){return this._pitch},set:function(o){this._pitch=Math.max(Number(o)||0,.01),this.source&&(this.source.playbackRate=this._pitch)}}),Object.defineProperty(Ir.prototype,"sound",{get:function(){return this._sound},set:function(o){this.stop(),this._sound=o}}),Object.defineProperty(Ir.prototype,"currentTime",{get:function(){return this._startOffset!==null?this._startOffset:this._state===ja||!this.source?0:this.source.currentTime-this._startTime},set:function(o){o<0||(this._startOffset=o,this.source&&this._isReady&&(this.source.currentTime=Ji(this._startTime+Ji(o,this.duration),this._sound.duration),this._startOffset=null))}}))});var Jre,$a,iL=m(()=>{me();Q();sy();PS();ay();Jre=1e4,$a=class extends Ir{constructor(e,t,s={}){super(e,t,s),this._position=new g,this._velocity=new g,s.position&&(this.position=s.position),this.maxDistance=s.maxDistance!==void 0?Number(s.maxDistance):Jre,this.refDistance=s.refDistance!==void 0?Number(s.refDistance):1,this.rollOffFactor=s.rollOffFactor!==void 0?Number(s.rollOffFactor):1,this.distanceModel=s.distanceModel!==void 0?s.distanceModel:vf}_initializeNodes(){this.gain=this._manager.context.createGain(),this.panner=this._manager.context.createPanner(),this.panner.connect(this.gain),this._inputNode=this.panner,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination)}set position(e){this._position.copy(e);let t=this.panner;"positionX"in t?(t.positionX.value=e.x,t.positionY.value=e.y,t.positionZ.value=e.z):t.setPosition&&t.setPosition(e.x,e.y,e.z)}get position(){return this._position}set velocity(e){this._velocity.copy(e)}get velocity(){return this._velocity}set maxDistance(e){this.panner.maxDistance=e}get maxDistance(){return this.panner.maxDistance}set refDistance(e){this.panner.refDistance=e}get refDistance(){return this.panner.refDistance}set rollOffFactor(e){this.panner.rolloffFactor=e}get rollOffFactor(){return this.panner.rolloffFactor}set distanceModel(e){this.panner.distanceModel=e}get distanceModel(){return this.panner.distanceModel}};if(!Zo()){let o=new g,e=function(t,s,i,r,a,n){o=o.sub2(t,s);let l=o.length();if(l<i)return 1;if(l>r)return 0;let h=0;return n===vf?h=1-a*(l-i)/(r-i):n===ey?h=i/(i+a*(l-i)):n===ty&&(h=Math.pow(l/i,-a)),w.clamp(h,0,1)};Object.defineProperty($a.prototype,"position",{get:function(){return this._position},set:function(t){if(this._position.copy(t),this.source){let i=this._manager.listener.getPosition(),r=e(i,this._position,this.refDistance,this.maxDistance,this.rollOffFactor,this.distanceModel),a=this.volume;this.source.volume=a*r*this._manager.volume}}}),Object.defineProperty($a.prototype,"maxDistance",{get:function(){return this._maxDistance},set:function(t){this._maxDistance=t}}),Object.defineProperty($a.prototype,"refDistance",{get:function(){return this._refDistance},set:function(t){this._refDistance=t}}),Object.defineProperty($a.prototype,"rollOffFactor",{get:function(){return this._rollOffFactor},set:function(t){this._rollOffFactor=t}}),Object.defineProperty($a.prototype,"distanceModel",{get:function(){return this._distanceModel},set:function(t){this._distanceModel=t}})}});var xf,yf,es,$t,er,Af,Pf,Rf,Cf,If,wf,xm,tr,ny,cU,fU,rL,Qo,oy,ly,dU,ym,ms,Xt,to,so,pa,ge,Ge,uU,Ye,mU,RS,xh,bs,CS,IS,wS,hy,Lf,LS,cy,Hs,pU,Am,_U,bf,gU,aL,SU,bS,TU,Za,MS,DS,nL,gi,EU,vU,xU,yU,fy,AU,yh,Mf,PU,RU,CU,Pm,IU,Si,dy,Jo,uy,wU,Mt,Xs,Qa,Ja,Df,Of,OS,my,NS,LU,bU,MU,DU,OU,Mi,io,Rm,ro,NU,FU,py,UU,BU,Ah,Ph,FS,en,US,_y,sr,Rh,Ch,Ih,BS,gy,Nf,Ff,Uf,Sy,wh,ao,Lh,Cm,Im,no,Bf,wm,bh,Mh,oo,lo,Lm,ho,Vf,Ms,Di,Dh,ps,ir,_a,Ti,ga,bm,Sa,VU,kU,GU,zU,HU,XU,WU,YU,KU,qU,jU,ni,Et,vt,Ty,$U,Oh,kf,ZU,QU,tn,Ey,vy,VS,xy,yy,Nh,Gf,Ue,it,Fh,Ay,Py,Ei,oL,lL,hL,Ry,Cy,Iy,wy,Ly,Mm,Dm,by,J=m(()=>{xf=0,yf=1,es=2,$t=3,er=4,Af=5,Pf=6,Rf=7,Cf=8,If=9,wf=10,xm={[xf]:"SUBTRACTIVE",[yf]:"ADDITIVE",[es]:"NORMAL",[$t]:"NONE",[er]:"PREMULTIPLIED",[Af]:"MULTIPLICATIVE",[Pf]:"ADDITIVEALPHA",[Rf]:"MULTIPLICATIVE2X",[Cf]:"SCREEN",[If]:"MIN",[wf]:"MAX"},tr="none",ny="linear",cU="exp",fU="exp2",rL=0,Qo=2,oy={[rL]:"NONE",[Qo]:"SCHLICK"},ly=0,dU=1,ym=15,ms=0,Xt=1,to=2,so=3,pa=4,ge=0,Ge=1,uU=Ge,Ye=2,mU=3,RS={[ge]:"DIRECTIONAL",[Ge]:"OMNI",[Ye]:"SPOT"},xh=100,bs=0,CS=1,IS=2,wS=3,hy={[bs]:"PUNCTUAL",[CS]:"RECT",[IS]:"DISK",[wS]:"SPHERE"},Lf=0,LS=1,cy={[Lf]:"LINEAR",[LS]:"INVERSESQUARED"},Hs=0,pU=0,Am=2,_U=2,bf=3,gU=3,aL=4,SU=4,bS=5,TU=5,Za=6,MS=7,DS=8,nL=9,gi=new Map([[bS,{name:"PCF1_32F",kind:"PCF1",format:16,pcf:!0}],[Hs,{name:"PCF3_32F",kind:"PCF3",format:16,pcf:!0}],[aL,{name:"PCF5_32F",kind:"PCF5",format:16,pcf:!0}],[MS,{name:"PCF1_16F",kind:"PCF1",format:69,pcf:!0}],[DS,{name:"PCF3_16F",kind:"PCF3",format:69,pcf:!0}],[nL,{name:"PCF5_16F",kind:"PCF5",format:69,pcf:!0}],[Am,{name:"VSM_16F",kind:"VSM",format:12,vsm:!0}],[bf,{name:"VSM_32F",kind:"VSM",format:14,vsm:!0}],[Za,{name:"PCSS_32F",kind:"PCSS",format:15,pcss:!0}]]),EU=1,vU=2,xU=4,yU=8,fy=255,AU=0,yh=1,Mf=0,PU=1,RU=2,CU=3,Pm=0,IU=1,Si=0,dy=1,Jo=0,uy=1,wU=2,Mt=0,Xs=1,Qa=0,Ja=1,Df=2,Of=0,OS=1,my={[Of]:"NONE",[OS]:"BOX"},NS="mul",LU="add",bU="screen",MU="overlay",DU="min",OU="max",Mi=0,io=1,Rm={[Mi]:"NONE",[io]:"SRGB"},ro=0,NU=1,FU=2,py=3,UU=4,BU=5,Ah=6,Ph=["LINEAR","FILMIC","HEJL","ACES","ACES2","NEUTRAL","NONE"],FS=0,en=1,US=2,_y={[FS]:"NONE",[en]:"AO",[US]:"GLOSSDEPENDENT"},sr="none",Rh="envAtlas",Ch="envAtlasHQ",Ih="cubeMap",BS="sphereMap",gy={[sr]:"NONE",[Rh]:"ENVATLAS",[Ch]:"ENVATLASHQ",[Ih]:"CUBEMAP",[BS]:"SPHEREMAP"},Nf="ambientSH",Ff="envAtlas",Uf="constant",Sy={[Nf]:"AMBIENTSH",[Ff]:"ENVALATLAS",[Uf]:"CONSTANT"},wh=1,ao=2,Lh=4,Cm=8,Im=16,no=32,Bf=64,wm=128,bh=256,Mh=512,oo=1024,lo=2048,Lm=4096,ho=8192,Vf=16384,Ms=0,Di=1,Dh=2,ps=1,ir=2,_a=4,Ti=0,ga=1,bm=2,Sa=3,VU="forward",kU="debug_albedo",GU="debug_world_normal",zU="debug_opacity",HU="debug_specularity",XU="debug_gloss",WU="debug_metalness",YU="debug_ao",KU="debug_emission",qU="debug_lighting",jU="debug_uv0",ni=0,Et=1,vt=2,Ty={[ni]:"SIMPLE",[Et]:"SLICED",[vt]:"TILED"},$U=0,Oh=1,kf=0,ZU=1,QU=2,tn=0,Ey=1,vy=2,VS=3,xy=4,yy=5,Nh=0,Gf=1,Ue=0,it=1,Fh="infinite",Ay="box",Py="dome",Ei="none",oL="bayer8",lL="bluenoise",hL="ignnoise",Ry={[Ei]:"NONE",[oL]:"BAYER8",[lL]:"BLUENOISE",[hL]:"IGNNOISE"},Cy="prerender",Iy="postrender",wy="prerender:layer",Ly="postrender:layer",Mm="precull",Dm="postcull",by="cull:end"});var Ta,Om=m(()=>{j();Ta=class{constructor(e,t,s){this.uniformFormats=[],this.bindGroupFormats=[],this.uniformFormats[Ha]=e,this.bindGroupFormats[Ha]=t,this.vertexFormat=s}hasUniform(e){for(let t=0;t<this.uniformFormats.length;t++)if(this.uniformFormats[t]?.get(e))return!0;return!1}hasTexture(e){for(let t=0;t<this.bindGroupFormats.length;t++)if(this.bindGroupFormats[t]?.getTexture(e))return!0;return!1}getVertexElement(e){return this.vertexFormat?.elements.find(t=>t.name===e)}generateKey(e){let t=JSON.stringify(this.uniformFormats)+JSON.stringify(this.bindGroupFormats);return e.isWebGPU&&(t+=this.vertexFormat?.shaderProcessingHashString),t}}});function rr(o){return JU.get(o)}function eB(o,e){JU.get(o,()=>e)}var JU,Uh=m(()=>{bi();JU=new st});var vi,Nm=m(()=>{Ya();vi=class{static definesHash(e){let t=Array.from(e).sort((s,i)=>s[0]>i[0]?1:-1);return Is(JSON.stringify(t))}}});var eae,cL,Ds,el=m(()=>{bi();J();eae=new st,cL=class{constructor(e,t,s={}){this.defines=new Map,this.name=e,this.index=t,Object.assign(this,s),this.buildShaderDefines()}buildShaderDefines(){let e;this.isShadow?e="SHADOW":this.isForward?e="FORWARD":this.index===Sa&&(e="PICK"),this.defines.set(`${e}_PASS`,""),this.defines.set(`${this.name.toUpperCase()}_PASS`,"")}},Ds=class o{constructor(){this.passesNamed=new Map,this.passesIndexed=[],this.nextIndex=0;let e=(t,s,i)=>{this.allocate(t,i)};e("forward",Ti,{isForward:!0}),e("prepass"),e("shadow"),e("pick")}static get(e){return eae.get(e,()=>new o)}allocate(e,t){let s=this.passesNamed.get(e);return s===void 0&&(s=new cL(e,this.nextIndex,t),this.passesNamed.set(s.name,s),this.passesIndexed[s.index]=s,this.nextIndex++),s}getByIndex(e){return this.passesIndexed[e]}getByName(e){return this.passesNamed.get(e)}}});var kS,tB=m(()=>{Ya();kS=class extends Map{set(e,t){return(!this.has(e)||this.get(e)!==t)&&this.markDirty(),super.set(e,t)}add(e){for(let[t,s]of Object.entries(e))this.set(t,s);return this}delete(e){let t=this.has(e),s=super.delete(e);return t&&s&&this.markDirty(),s}clear(){this.size>0&&this.markDirty(),super.clear()}markDirty(){this._dirty=!0,this._keyDirty=!0}isDirty(){return this._dirty}resetDirty(){this._dirty=!1}get key(){return this._keyDirty&&(this._keyDirty=!1,this._key=Array.from(this.entries()).sort(([e],[t])=>e<t?-1:e>t?1:0).map(([e,t])=>`${e}=${Is(t)}`).join(",")),this._key}copy(e){this.clear();for(let[t,s]of e)this.set(t,s);return this}constructor(...e){super(...e),this._keyDirty=!1,this._key=""}}});var tae,ie,It=m(()=>{j();bi();tB();tae=new st,ie=class o{static get(e,t=oe){let s=tae.get(e,()=>new o);return t===oe?s.glsl:s.wgsl}get useWGSL(){return this.glsl.size===0||this.wgsl.size>0}get key(){return`GLSL:${this.glsl.key}|WGSL:${this.wgsl.key}|API:${this.version}`}isDirty(){return this.glsl.isDirty()||this.wgsl.isDirty()}resetDirty(){this.glsl.resetDirty(),this.wgsl.resetDirty()}copy(e){return this.version=e.version,this.glsl.copy(e.glsl),this.wgsl.copy(e.wgsl),this}constructor(){this.glsl=new kS,this.wgsl=new kS,this.version=""}}});var sn,GS=m(()=>{sn=class{static merge(...e){let t=new Map(e[0]??[]);for(let s=1;s<e.length;s++){let i=e[s];if(i)for(let[r,a]of i)t.set(r,a)}return t}}});function sB(o,e,t,s=!1,i={}){}function iB(o,e,t,s,i,r=!1,a={}){typeof r=="boolean"?a.useTransformFeedback=r:typeof r=="object"&&(a={...a,...r});let n=rr(o),l=n.getCachedShader(s);return l||(l=new ai(o,ri.createDefinition(o,{...a,name:s,vertexCode:e,fragmentCode:t,attributes:i})),n.setCachedShader(s,l)),l}var fL,Te,Dt=m(()=>{Th();Sh();Uh();Nm();el();j();It();GS();fL=class extends vi{constructor(e,t){super(),this.key=e,this.shaderDefinition=t}generateKey(e){return this.key}createShaderDefinition(e,t){return this.shaderDefinition}},Te=class{static createShader(e,t){let s=rr(e),i=s.getCachedShader(t.uniqueName);if(!i){let r=e.isWebGPU&&(!!t.vertexWGSL||!!t.vertexChunk)&&(!!t.fragmentWGSL||!!t.fragmentChunk),a=ie.get(e,r?le:oe),n=t.vertexChunk?a.get(t.vertexChunk):r?t.vertexWGSL:t.vertexGLSL,l=t.fragmentChunk?a.get(t.fragmentChunk):r?t.fragmentWGSL:t.fragmentGLSL,h=sn.merge(a,t.fragmentIncludes),c=sn.merge(a,t.vertexIncludes);i=new ai(e,ri.createDefinition(e,{name:t.uniqueName,shaderLanguage:r?le:oe,attributes:t.attributes,vertexCode:n,fragmentCode:l,useTransformFeedback:t.useTransformFeedback,vertexIncludes:c,vertexDefines:t.vertexDefines,fragmentIncludes:h,fragmentDefines:t.fragmentDefines,fragmentOutputTypes:t.fragmentOutputTypes})),s.setCachedShader(t.uniqueName,i)}return i}static getCoreDefines(e,t){let s=new Map(e.defines);return t.cameraShaderParams.defines.forEach((r,a)=>s.set(a,r)),Ds.get(t.device).getByIndex(t.pass).defines.forEach((r,a)=>s.set(a,r)),s}static processShader(e,t){let s=e.definition,r=`${s.name??"shader"}-id-${e.id}`,a=new fL(r,s),n="shader",l=rr(e.device);l.register(n,a);let h=l.getProgram(n,{},t);return l.unregister(n),h}static addScreenDepthChunkDefines(e,t,s){t.sceneDepthMapLinear&&s.set("SCENE_DEPTHMAP_LINEAR",""),e.textureFloatRenderable&&s.set("SCENE_DEPTHMAP_FLOAT","")}}});var sae,zS,HS,dL,Oi,zf=m(()=>{Ze();_h();j();Om();am();Dt();sae={type:rs,base:0,baseVertex:0,count:4,indexed:!1},zS=new W,HS=new W,dL=new ph,Oi=class{constructor(e){let t=e.device;if(this.shader=e,t.supportsUniformBuffers){let s=new Ta;this.shader=Te.processShader(e,s);let i=this.shader.meshUniformBufferFormat;i&&(this.uniformBuffer=new da(t,i,!1));let r=this.shader.meshBindGroupFormat;this.bindGroup=new ji(t,r)}}destroy(){this.uniformBuffer?.destroy(),this.uniformBuffer=null,this.bindGroup?.destroy(),this.bindGroup=null}render(e,t){let s=this.shader.device;e&&(zS.set(s.vx,s.vy,s.vw,s.vh),HS.set(s.sx,s.sy,s.sw,s.sh),t=t??e,s.setViewport(e.x,e.y,e.z,e.w),s.setScissor(t.x,t.y,t.z,t.w)),s.setVertexBuffer(s.quadVertexBuffer,0);let i=this.shader;if(s.setShader(i),s.supportsUniformBuffers){s.setBindGroup(Ha,s.emptyBindGroup);let r=this.bindGroup;r.update(),s.setBindGroup(ca,r);let a=this.uniformBuffer;a?(a.update(dL),s.setBindGroup(Rr,dL.bindGroup,dL.offsets)):s.setBindGroup(Rr,s.emptyBindGroup)}s.draw(sae),e&&(s.setViewport(zS.x,zS.y,zS.z,zS.w),s.setScissor(HS.x,HS.y,HS.z,HS.w))}}});var My,rB=m(()=>{ii();us();My=class extends Xe{constructor(e,t,s,i){super(e),this.quad=t,this.rect=s,this.scissorRect=i}execute(){let{device:e}=this;e.setCullMode(0),e.setDepthState($e.NODEPTH),e.setStencilState(null,null),this.quad.render(this.rect,this.scissorRect)}}});function Ot(o,e,t,s,i){let r=new Oi(t);s||(s=iae,s.x=0,s.y=0,s.z=e?e.width:o.width,s.w=e?e.height:o.height);let a=new My(o,r,s,i);a.init(e),a.colorOps.clear=!1,a.depthStencilOps.clearDepth=!1,o.isWebGPU&&e===null&&o.samples>1&&(a.colorOps.store=!0),a.render(),r.destroy()}var iae,Ea=m(()=>{Ze();zf();rB();iae=new W});var Hf,uL=m(()=>{Vt();Hf=class{constructor(e,t,s){this._aabb=new _e,this.meshInstance=null,this.origMeshInstances=e,this.dynamic=t,this.batchGroupId=s}destroy(e,t){this.meshInstance&&(this.removeFromLayers(e,t),this.meshInstance.destroy(),this.meshInstance=null)}addToLayers(e,t){for(let s=0;s<t.length;s++){let i=e.layers.getLayerById(t[s]);i&&i.addMeshInstances([this.meshInstance])}}removeFromLayers(e,t){for(let s=0;s<t.length;s++){let i=e.layers.getLayerById(t[s]);i&&i.removeMeshInstances([this.meshInstance])}}updateBoundingBox(){this._aabb.copy(this.origMeshInstances[0].aabb);for(let e=1;e<this.origMeshInstances.length;e++)this._aabb.add(this.origMeshInstances[e].aabb);this.meshInstance.aabb=this._aabb,this.meshInstance._aabbVer=0}get model(){}}});var wt,Xf=m(()=>{J();wt=class{constructor(e,t,s,i,r=[ms]){this._ui=!1,this._sprite=!1,this._obj={model:[],element:[],sprite:[],render:[]},this.id=e,this.name=t,this.dynamic=s,this.maxAabbSize=i,this.layers=r}static{this.MODEL="model"}static{this.ELEMENT="element"}static{this.SPRITE="sprite"}static{this.RENDER="render"}}});var aB,ar,Wf=m(()=>{me();Ke();j();Fe();aB=new k,ar=class{constructor(e){this._dirty=!0,this._rootBone=null,this._skinUpdateIndex=-1,this._updateBeforeCull=!0,e&&this.initSkin(e)}set rootBone(e){this._rootBone=e}get rootBone(){return this._rootBone}init(e,t){let s=t*3,i=Math.ceil(Math.sqrt(s));i=w.roundUp(i,3);let r=Math.ceil(s/i);this.boneTexture=new q(e,{width:i,height:r,format:14,mipmaps:!1,minFilter:0,magFilter:0,name:"skin"}),this.matrixPalette=this.boneTexture.lock({mode:bu}),this.boneTexture.unlock()}destroy(){this.boneTexture&&(this.boneTexture.destroy(),this.boneTexture=null)}resolve(e,t){this.rootBone=e;let s=this.skin,i=[];for(let r=0;r<s.boneNames.length;r++){let a=s.boneNames[r],n=e.findByName(a);n||(n=t),i.push(n)}this.bones=i}initSkin(e){this.skin=e,this.bones=[];let t=e.inverseBindPose.length;this.init(e.device,t),this.matrices=[];for(let s=0;s<t;s++)this.matrices[s]=new k}uploadBones(e){this.boneTexture.upload()}_updateMatrices(e,t){if(this._skinUpdateIndex!==t){this._skinUpdateIndex=t,aB.copy(e.getWorldTransform()).invert();for(let s=this.bones.length-1;s>=0;s--)this.matrices[s].mulAffine2(aB,this.bones[s].getWorldTransform()),this.matrices[s].mulAffine2(this.matrices[s],this.skin.inverseBindPose[s])}}updateMatrices(e,t){this._updateBeforeCull&&this._updateMatrices(e,t)}updateMatrixPalette(e,t){this._updateMatrices(e,t);let s=this.matrixPalette,i=this.bones.length;for(let r=0;r<i;r++){let a=this.matrices[r].data,n=r*12;s[n]=a[0],s[n+1]=a[4],s[n+2]=a[8],s[n+3]=a[12],s[n+4]=a[1],s[n+5]=a[5],s[n+6]=a[9],s[n+7]=a[13],s[n+8]=a[2],s[n+9]=a[6],s[n+10]=a[10],s[n+11]=a[14]}this.uploadBones(this.skin.device)}}});var Yf,mL=m(()=>{Wf();Yf=class extends ar{constructor(e,t,s){super();let i=t.length;this.init(e,i),this.device=e,this.rootNode=s,this.bones=t}updateMatrices(e,t){}updateMatrixPalette(e,t){let s=this.matrixPalette,i=this.bones.length;for(let r=0;r<i;r++){let a=this.bones[r].getWorldTransform().data,n=r*12;s[n]=a[0],s[n+1]=a[4],s[n+2]=a[8],s[n+3]=a[12],s[n+4]=a[1],s[n+5]=a[5],s[n+6]=a[9],s[n+7]=a[13],s[n+8]=a[2],s[n+9]=a[6],s[n+10]=a[10],s[n+11]=a[14]}this.uploadBones(this.device)}}});var rae,Bh,pL,Ce,Ws=m(()=>{mS();Q();Vt();j();vh();$i();Cr();pS();J();rae=0,Bh=class{constructor(){this.initDefaults()}initDefaults(){this.recreate=!1,this.verticesUsage=0,this.indicesUsage=0,this.maxVertices=0,this.maxIndices=0,this.vertexCount=0,this.indexCount=0,this.vertexStreamsUpdated=!1,this.indexStreamUpdated=!1,this.vertexStreamDictionary={},this.indices=null}_changeVertexCount(e,t){this.vertexCount||(this.vertexCount=e)}static{this.DEFAULT_COMPONENTS_POSITION=3}static{this.DEFAULT_COMPONENTS_NORMAL=3}static{this.DEFAULT_COMPONENTS_UV=2}static{this.DEFAULT_COMPONENTS_COLORS=4}},pL=class{constructor(e,t,s,i,r){this.data=e,this.componentCount=t,this.dataType=s,this.dataTypeNormalize=i,this.asInt=r}},Ce=class o extends eo{constructor(e,t){super(),this.indexBuffer=[null],this.vertexBuffer=null,this.primitive=[{type:0,base:0,baseVertex:0,count:0}],this.skin=null,this.boneAabb=null,this._aabbVer=0,this._aabb=new _e,this._geometryData=null,this._morph=null,this._storageIndex=!1,this._storageVertex=!1,this.id=rae++,this.device=e,this._storageIndex=t?.storageIndex||!1,this._storageVertex=t?.storageVertex||!1}static fromGeometry(e,t,s={}){let i=new o(e,s),{positions:r,normals:a,tangents:n,colors:l,uvs:h,uvs1:c,blendIndices:f,blendWeights:d,indices:u}=t;return r&&i.setPositions(r),a&&i.setNormals(a),n&&i.setVertexStream(as,n,4),l&&i.setColors32(l),h&&i.setUvs(0,h),c&&i.setUvs(1,c),f&&i.setVertexStream(Gt,f,4,f.length/4,zs),d&&i.setVertexStream(hs,d,4),u&&i.setIndices(u),i.update(),i}set morph(e){e!==this._morph&&(this._morph&&this._morph.decRefCount(),this._morph=e,e&&e.incRefCount())}get morph(){return this._morph}set aabb(e){this._aabb=e,this._aabbVer++}get aabb(){return this._aabb}destroy(){let e=this.morph;e&&(this.morph=null,e.refCount<1&&e.destroy()),this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);for(let t=0;t<this.indexBuffer.length;t++)this._destroyIndexBuffer(t);this.indexBuffer.length=0,this._geometryData=null}_destroyIndexBuffer(e){this.indexBuffer[e]&&(this.indexBuffer[e].destroy(),this.indexBuffer[e]=null)}_initBoneAabbs(e){this.boneAabb=[],this.boneUsed=[];let t,s,i,r,a,n=[],l=[],h=this.boneUsed,c=this.skin.boneNames.length,f,d,u;for(let E=0;E<c;E++)n[E]=new g(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),l[E]=new g(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);let p=new ua(this.vertexBuffer),_=p.element[te],S=p.element[hs],T=p.element[Gt],x=this.vertexBuffer.numVertices;for(let E=0;E<x;E++){for(let v=0;v<4;v++)if(S.array[S.index+v]>0){let P=T.array[T.index+v];if(h[P]=!0,t=_.array[_.index],s=_.array[_.index+1],i=_.array[_.index+2],r=l[P],a=n[P],a.x>t&&(a.x=t),a.y>s&&(a.y=s),a.z>i&&(a.z=i),r.x<t&&(r.x=t),r.y<s&&(r.y=s),r.z<i&&(r.z=i),e){let y=f=t,C=d=s,L=u=i;for(let O=0;O<e.length;O++){let M=e[O],U=M.deltaPositions[E*3],G=M.deltaPositions[E*3+1],$=M.deltaPositions[E*3+2];U<0?y+=U:f+=U,G<0?C+=G:d+=G,$<0?L+=$:u+=$}a.x>y&&(a.x=y),a.y>C&&(a.y=C),a.z>L&&(a.z=L),r.x<f&&(r.x=f),r.y<d&&(r.y=d),r.z<u&&(r.z=u)}}p.next()}let A=this.vertexBuffer.getFormat().elements.find(E=>E.name===te);if(A&&A.normalize){let E=(()=>{switch(A.dataType){case Ps:return v=>Math.max(v/127,-1);case zs:return v=>v/255;case Rs:return v=>Math.max(v/32767,-1);case mi:return v=>v/65535;default:return v=>v}})();for(let v=0;v<c;v++)if(h[v]){let R=n[v],P=l[v];R.set(E(R.x),E(R.y),E(R.z)),P.set(E(P.x),E(P.y),E(P.z))}}for(let E=0;E<c;E++){let v=new _e;v.setMinMax(n[E],l[E]),this.boneAabb.push(v)}}_initGeometryData(){this._geometryData||(this._geometryData=new Bh,this.vertexBuffer&&(this._geometryData.vertexCount=this.vertexBuffer.numVertices,this._geometryData.maxVertices=this.vertexBuffer.numVertices),this.indexBuffer.length>0&&this.indexBuffer[0]&&(this._geometryData.indexCount=this.indexBuffer[0].numIndices,this._geometryData.maxIndices=this.indexBuffer[0].numIndices))}clear(e,t,s=0,i=0){this._initGeometryData(),this._geometryData.initDefaults(),this._geometryData.recreate=!0,this._geometryData.maxVertices=s,this._geometryData.maxIndices=i,this._geometryData.verticesUsage=e?0:1,this._geometryData.indicesUsage=t?0:1}setVertexStream(e,t,s,i,r=pe,a=!1,n=!1){this._initGeometryData();let l=i||t.length/s;this._geometryData._changeVertexCount(l,e),this._geometryData.vertexStreamsUpdated=!0,this._geometryData.vertexStreamDictionary[e]=new pL(t,s,r,a,n)}getVertexStream(e,t){let s=0,i=!1;if(this._geometryData){let r=this._geometryData.vertexStreamDictionary[e];r&&(i=!0,s=this._geometryData.vertexCount,ArrayBuffer.isView(t)?t.set(r.data):(t.length=0,t.push(r.data)))}return i||this.vertexBuffer&&(s=new ua(this.vertexBuffer).readData(e,t)),s}setPositions(e,t=Bh.DEFAULT_COMPONENTS_POSITION,s){this.setVertexStream(te,e,t,s,pe,!1)}setNormals(e,t=Bh.DEFAULT_COMPONENTS_NORMAL,s){this.setVertexStream(Pt,e,t,s,pe,!1)}setUvs(e,t,s=Bh.DEFAULT_COMPONENTS_UV,i){this.setVertexStream(aS+e,t,s,i,pe,!1)}setColors(e,t=Bh.DEFAULT_COMPONENTS_COLORS,s){this.setVertexStream(nt,e,t,s,pe,!1)}setColors32(e,t){this.setVertexStream(nt,e,Bh.DEFAULT_COMPONENTS_COLORS,t,zs,!0)}setIndices(e,t){this._initGeometryData(),this._geometryData.indexStreamUpdated=!0,this._geometryData.indices=e,this._geometryData.indexCount=t||e.length}getPositions(e){return this.getVertexStream(te,e)}getNormals(e){return this.getVertexStream(Pt,e)}getUvs(e,t){return this.getVertexStream(aS+e,t)}getColors(e){return this.getVertexStream(nt,e)}getIndices(e){let t=0;if(this._geometryData&&this._geometryData.indices){let s=this._geometryData.indices;if(t=this._geometryData.indexCount,ArrayBuffer.isView(e))e.set(s);else{e.length=0;for(let i=0,r=s.length;i<r;i++)e.push(s[i])}}else this.indexBuffer.length>0&&this.indexBuffer[0]&&(t=this.indexBuffer[0].readData(e));return t}update(e=As,t=!0){if(this._geometryData){if(t){let r=this._geometryData.vertexStreamDictionary[te];r&&r.componentCount===3&&(this._aabb.compute(r.data,this._geometryData.vertexCount),this._aabbVer++)}let s=this._geometryData.recreate;this._geometryData.vertexCount>this._geometryData.maxVertices&&(s=!0,this._geometryData.maxVertices=this._geometryData.vertexCount),s&&this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);let i=this._geometryData.recreate;this._geometryData.indexCount>this._geometryData.maxIndices&&(i=!0,this._geometryData.maxIndices=this._geometryData.indexCount),i&&this.indexBuffer.length>0&&this.indexBuffer[0]&&(this.indexBuffer[0].destroy(),this.indexBuffer[0]=null),this._geometryData.vertexStreamsUpdated&&this._updateVertexBuffer(),this._geometryData.indexStreamUpdated&&this._updateIndexBuffer(),this.primitive[0].type=e,this.indexBuffer.length>0&&this.indexBuffer[0]?this._geometryData.indexStreamUpdated&&(this.primitive[0].count=this._geometryData.indexCount,this.primitive[0].indexed=!0):this._geometryData.vertexStreamsUpdated&&(this.primitive[0].count=this._geometryData.vertexCount,this.primitive[0].indexed=!1),this._geometryData.vertexCount=0,this._geometryData.indexCount=0,this._geometryData.vertexStreamsUpdated=!1,this._geometryData.indexStreamUpdated=!1,this._geometryData.recreate=!1,this.updateRenderStates()}}_buildVertexFormat(e){let t=[];for(let s in this._geometryData.vertexStreamDictionary){let i=this._geometryData.vertexStreamDictionary[s];t.push({semantic:s,components:i.componentCount,type:i.dataType,normalize:i.dataTypeNormalize,asInt:i.asInt})}return new Tt(this.device,t,e)}_updateVertexBuffer(){if(!this.vertexBuffer){let s=this._geometryData.maxVertices,i=this._buildVertexFormat(s);this.vertexBuffer=new mt(this.device,i,s,{usage:this._geometryData.verticesUsage,storage:this._storageVertex})}let e=new ua(this.vertexBuffer),t=this._geometryData.vertexCount;for(let s in this._geometryData.vertexStreamDictionary){let i=this._geometryData.vertexStreamDictionary[s];e.writeData(s,i.data,t),delete this._geometryData.vertexStreamDictionary[s]}e.end()}_updateIndexBuffer(){if(this.indexBuffer.length<=0||!this.indexBuffer[0]){let t=this._geometryData.maxVertices,s=t>65535||t===0?2:1,i=this._storageIndex?{storage:!0}:void 0;this.indexBuffer[0]=new Ls(this.device,s,this._geometryData.maxIndices,this._geometryData.indicesUsage,void 0,i)}let e=this._geometryData.indices;e&&(this.indexBuffer[0].writeData(e,this._geometryData.indexCount),this._geometryData.indices=null)}prepareRenderState(e){e===Ja?this.generateWireframe():e===Df&&(this.primitive[Df]={type:qr,base:0,baseVertex:0,count:this.vertexBuffer?this.vertexBuffer.numVertices:0,indexed:!1})}updateRenderStates(){this.primitive[Df]&&this.prepareRenderState(Df),this.primitive[Ja]&&this.prepareRenderState(Ja)}generateWireframe(){this._destroyIndexBuffer(Ja);let e=this.vertexBuffer.numVertices,t=[],s;if(this.indexBuffer.length>0&&this.indexBuffer[0]){let a=[[0,1],[1,2],[2,0]],n=this.primitive[Qa].base,l=this.primitive[Qa].count,h=this.primitive[Qa].baseVertex||0,c=this.indexBuffer[Qa],f=new Yo[c.format](c.storage),d=new Set;for(let u=n;u<n+l;u+=3)for(let p=0;p<3;p++){let _=f[u+a[p][0]]+h,S=f[u+a[p][1]]+h,T=_>S?S*e+_:_*e+S;d.has(T)||(d.add(T),t.push(_,S))}s=c.format}else{for(let a=0;a<e;a+=3)t.push(a,a+1,a+1,a+2,a+2,a);s=t.length>65535?2:1}let i=new Ls(this.vertexBuffer.device,s,t.length);new Yo[i.format](i.storage).set(t),i.unlock(),this.primitive[Ja]={type:Mn,base:0,baseVertex:0,count:t.length,indexed:!0},this.indexBuffer[Ja]=i}}});function va(o){return nB.get(o)}function oB(o,e){nB.get(o,()=>e)}var nB,Vh=m(()=>{bi();nB=new st});var Dy,lB=m(()=>{Dy=class{destroy(){this.cache.forEach((e,t)=>{t.destroy()}),this.cache.clear()}incRef(e){let t=(this.cache.get(e)||0)+1;this.cache.set(e,t)}decRef(e){if(e){let t=this.cache.get(e);t&&(t--,t===0?(this.cache.delete(e),e.destroy()):this.cache.set(e,t))}}constructor(){this.cache=new Map}}});var xa,_L=m(()=>{lB();xa=class{static{this.cache=new Dy}static incRef(e){this.cache.incRef(e)}static decRef(e){this.cache.decRef(e)}static destroy(){this.cache.destroy()}}});var aae,nae,Oy,gL,SL,Fm,TL,EL,vL,Oe,_s=m(()=>{Vt();fu();_h();am();J();Vh();_L();Ya();aae=0,nae=new _e,Oy=new _e,gL=new Hr,SL=new Set,Fm=new Uint32Array(4),TL=class{constructor(e){this.vertexBuffer=null,this._destroyVertexBuffer=!1,this.count=e}destroy(){this._destroyVertexBuffer&&this.vertexBuffer?.destroy(),this.vertexBuffer=null}},EL=class{get(e){return this.map.get(e)??this.map.get(null)}constructor(){this.map=new Map,this.meshMetaData=new Int32Array(4)}},vL=class{getBindGroup(e){if(!this.bindGroup){let s=this.shader.meshBindGroupFormat;this.bindGroup=new ji(e,s)}return this.bindGroup}getUniformBuffer(e){if(!this.uniformBuffer){let s=this.shader.meshUniformBufferFormat;this.uniformBuffer=new da(e,s,!1)}return this.uniformBuffer}destroy(){this.bindGroup?.destroy(),this.bindGroup=null,this.uniformBuffer?.destroy(),this.uniformBuffer=null}constructor(){this.bindGroup=null,this.uniformBuffer=null}},Oe=class o{constructor(e,t,s=null){if(this.castShadow=!1,this.shadowCascadeMask=fy,this.cull=!0,this.drawOrder=0,this._drawBucket=127,this.visible=!0,this.visibleThisFrame=!1,this.flipFacesFactor=1,this.gsplatInstance=null,this.id=aae++,this.isVisibleFunc=null,this.instancingData=null,this.indirectData=null,this.parameters={},this.pick=!0,this.stencilFront=null,this.stencilBack=null,this.transparent=!1,this._aabb=new _e,this._aabbVer=-1,this._aabbMeshVer=-1,this._customAabb=null,this._updateAabb=!0,this._updateAabbFunc=null,this._sortKeyShadow=0,this._sortKeyForward=0,this._sortKeyDynamic=0,this._layer=ym,this._material=null,this._skinInstance=null,this._morphInstance=null,this._receiveShadow=!0,this._renderStyle=Qa,this._screenSpace=!1,this._shaderCache=new Map,this._shaderDefs=ps<<16,this._calculateSortDistance=null,this.node=s,this._mesh=e,e.incRefCount(),this.material=t,e.vertexBuffer){let i=e.vertexBuffer.format;this._shaderDefs|=i.hasUv0?Lh:0,this._shaderDefs|=i.hasUv1?Cm:0,this._shaderDefs|=i.hasColor?Im:0,this._shaderDefs|=i.hasTangents?Mh:0}this.updateKey()}set drawBucket(e){this._drawBucket=Math.floor(e)&255,this.updateKey()}get drawBucket(){return this._drawBucket}set renderStyle(e){this._renderStyle=e,this.mesh.prepareRenderState(e)}get renderStyle(){return this._renderStyle}set mesh(e){e!==this._mesh&&(this._mesh&&this._mesh.decRefCount(),this._mesh=e,e&&e.incRefCount())}get mesh(){return this._mesh}set aabb(e){this._aabb=e}get aabb(){if(!this._updateAabb)return this._aabb;if(this._updateAabbFunc)return this._updateAabbFunc(this._aabb);let e=this._customAabb,t=!!e;if(!e){if(e=nae,this.skinInstance){if(!this.mesh.boneAabb){let r=this._morphInstance?this._morphInstance.morph._targets:null;this.mesh._initBoneAabbs(r)}let s=this.mesh.boneUsed,i=!0;for(let r=0;r<this.mesh.boneAabb.length;r++)s[r]&&(Oy.setFromTransformedAabb(this.mesh.boneAabb[r],this.skinInstance.matrices[r]),i?(i=!1,e.center.copy(Oy.center),e.halfExtents.copy(Oy.halfExtents)):e.add(Oy));t=!0}else if(this.node._aabbVer!==this._aabbVer||this.mesh._aabbVer!==this._aabbMeshVer){if(this.mesh?(e.center.copy(this.mesh.aabb.center),e.halfExtents.copy(this.mesh.aabb.halfExtents)):(e.center.set(0,0,0),e.halfExtents.set(0,0,0)),this.mesh&&this.mesh.morph){let s=this.mesh.morph.aabb;e._expand(s.getMin(),s.getMax())}t=!0,this._aabbVer=this.node._aabbVer,this._aabbMeshVer=this.mesh._aabbVer}}return t&&this._aabb.setFromTransformedAabb(e,this.node.getWorldTransform()),this._aabb}clearShaders(){this._shaderCache.forEach(e=>{e.destroy()}),this._shaderCache.clear()}getShaderInstance(e,t,s,i,r,a,n){let l=this._shaderDefs;Fm[0]=e,Fm[1]=t,Fm[2]=l,Fm[3]=i.hash;let h=$u(Fm),c=this._shaderCache.get(h);if(!c){let f=this._material;if(c=new vL,c.shader=f.variants.get(h),c.hashes=new Uint32Array(Fm),!c.shader){let d=f.getShaderVariant({device:this.mesh.device,scene:s,objDefs:l,cameraShaderParams:i,pass:e,sortedLights:n,viewUniformFormat:r,viewBindGroupFormat:a,vertexFormat:this.mesh.vertexBuffer?.format});f.variants.set(h,d),c.shader=d}this._shaderCache.set(h,c)}return c}set material(e){this.clearShaders();let t=this._material;t&&t.removeMeshInstanceRef(this),this._material=e,e&&(e.addMeshInstanceRef(this),this.transparent=e.transparent,this.updateKey())}get material(){return this._material}_updateShaderDefs(e){e!==this._shaderDefs&&(this._shaderDefs=e,this.clearShaders())}set calculateSortDistance(e){this._calculateSortDistance=e}get calculateSortDistance(){return this._calculateSortDistance}set receiveShadow(e){this._receiveShadow!==e&&(this._receiveShadow=e,this._updateShaderDefs(e?this._shaderDefs&-2:this._shaderDefs|wh))}get receiveShadow(){return this._receiveShadow}set batching(e){this._updateShaderDefs(e?this._shaderDefs|Vf:this._shaderDefs&-16385)}get batching(){return(this._shaderDefs&Vf)!==0}set skinInstance(e){this._skinInstance=e,this._updateShaderDefs(e?this._shaderDefs|ao:this._shaderDefs&-3),this._setupSkinUpdate()}get skinInstance(){return this._skinInstance}set morphInstance(e){this._morphInstance?.destroy(),this._morphInstance=e;let t=this._shaderDefs;t=e&&e.morph.morphPositions?t|oo:t&-1025,t=e&&e.morph.morphNormals?t|lo:t&-2049,t=e&&e.morph.intRenderFormat?t|ho:t&-8193,this._updateShaderDefs(t)}get morphInstance(){return this._morphInstance}set screenSpace(e){this._screenSpace!==e&&(this._screenSpace=e,this._updateShaderDefs(e?this._shaderDefs|bh:this._shaderDefs&-257))}get screenSpace(){return this._screenSpace}set key(e){this._sortKeyForward=e}get key(){return this._sortKeyForward}set mask(e){let t=this._shaderDefs&65535;this._updateShaderDefs(t|e<<16)}get mask(){return this._shaderDefs>>16}set instancingCount(e){this.instancingData&&(this.instancingData.count=e)}get instancingCount(){return this.instancingData?this.instancingData.count:0}destroy(){let e=this.mesh;e&&(this.mesh=null,e.refCount<1&&e.destroy()),this.setRealtimeLightmap(o.lightmapParamNames[0],null),this.setRealtimeLightmap(o.lightmapParamNames[1],null),this._skinInstance?.destroy(),this._skinInstance=null,this.morphInstance?.destroy(),this.morphInstance=null,this.clearShaders(),this.material=null,this.instancingData?.destroy()}static{this.lightmapParamNames=["texture_lightMap","texture_dirLightMap"]}static _prepareRenderStyleForArray(e,t){if(e){for(let s=0;s<e.length;s++){e[s]._renderStyle=t;let i=e[s].mesh;SL.has(i)||(SL.add(i),i.prepareRenderState(t))}SL.clear()}}_isVisible(e){return this.visible?this.isVisibleFunc?this.isVisibleFunc(e):(gL.center=this.aabb.center,gL.radius=this._aabb.halfExtents.length(),e.frustum.containsSphere(gL)>0):!1}updateKey(){let{material:e}=this;this._sortKeyForward=this._drawBucket<<23|(e.alphaToCoverage||e.alphaTest?4194304:0)|e.id&4194303}setInstancing(e,t=!1){e?(this.instancingData=new TL(e.numVertices),this.instancingData.vertexBuffer=e,e.format.instancing=!0,this.cull=t):(this.instancingData=null,this.cull=!0),this._updateShaderDefs(e?this._shaderDefs|no:this._shaderDefs&-33)}setIndirect(e,t){this._allocIndirectData(),this.indirectData.map.set(e?.camera??null,t),this.mesh.device.mapsToClear.add(this.indirectData.map)}getIndirectMetaData(){this._allocIndirectData();let e=this.mesh?.primitive[this.renderStyle],t=this.indirectData.meshMetaData;return t[0]=e.count,t[1]=e.base,t[2]=e.baseVertex,t}_allocIndirectData(){this.indirectData||(this.indirectData=new EL)}ensureMaterial(e){this.material||(this.material=va(e))}clearParameters(){this.parameters={}}getParameters(){return this.parameters}getParameter(e){return this.parameters[e]}setParameter(e,t,s=4294967295){let i=this.parameters[e];i?(i.data=t,i.passFlags=s):this.parameters[e]={scopeId:null,data:t,passFlags:s}}setRealtimeLightmap(e,t){let s=this.getParameter(e);s!==t&&(s&&xa.decRef(s.data),t?(xa.incRef(t),this.setParameter(e,t)):this.deleteParameter(e))}deleteParameter(e){this.parameters[e]&&delete this.parameters[e]}setParameters(e,t){let s=this.parameters;for(let i in s){let r=s[i];r.passFlags&t&&(r.scopeId||(r.scopeId=e.scope.resolve(i)),r.scopeId.setValue(r.data))}}setLightmapped(e){e?this.mask=(this.mask|ir)&-6:(this.setRealtimeLightmap(o.lightmapParamNames[0],null),this.setRealtimeLightmap(o.lightmapParamNames[1],null),this._shaderDefs&=-4289,this.mask=(this.mask|ps)&-7)}setCustomAabb(e){e?this._customAabb?this._customAabb.copy(e):this._customAabb=e.clone():(this._customAabb=null,this._aabbVer=-1),this._setupSkinUpdate()}_setupSkinUpdate(){this._skinInstance&&(this._skinInstance._updateBeforeCull=!this._customAabb)}}});function cB(o,e){if(o&&!e||!o&&e)return!1;if(o=o.data,e=e.data,o===e)return!0;if(o instanceof Float32Array&&e instanceof Float32Array){if(o.length!==e.length)return!1;for(let t=0;t<o.length;t++)if(o[t]!==e[t])return!1;return!0}return!1}function hae(o,e){for(let t in o)if(o.hasOwnProperty(t)&&!cB(o[t],e[t]))return!1;for(let t in e)if(e.hasOwnProperty(t)&&!cB(e[t],o[t]))return!1;return!0}function xL(o){return o.node.worldTransform.scaleSign}var oae,lae,hB,Um,yL=m(()=>{Zl();Vt();j();J();Ws();_s();uL();Xf();mL();oae=[0,1,3,2,3,1],lae=[0,1,3,0,3,2],hB=new Vs;Um=class{constructor(e,t,s){this.device=e,this.rootNode=t,this.scene=s,this._init=!1,this._batchGroups={},this._batchGroupCounter=0,this._batchList=[],this._dirtyGroups=[]}destroy(){this.device=null,this.rootNode=null,this.scene=null,this._batchGroups={},this._batchList=[],this._dirtyGroups=[]}addGroup(e,t,s,i,r){if(i===void 0&&(i=this._batchGroupCounter,this._batchGroupCounter++),this._batchGroups[i])return;let a=new wt(i,e,t,s,r);return this._batchGroups[i]=a,a}removeGroup(e){if(!this._batchGroups[e])return;let t=[];for(let s=0;s<this._batchList.length;s++)this._batchList[s].batchGroupId===e?this.destroyBatch(this._batchList[s]):t.push(this._batchList[s]);this._batchList=t,this._removeModelsFromBatchGroup(this.rootNode,e),delete this._batchGroups[e]}markGroupDirty(e){this._dirtyGroups.indexOf(e)<0&&this._dirtyGroups.push(e)}getGroupByName(e){let t=this._batchGroups;for(let s in t)if(t.hasOwnProperty(s)&&t[s].name===e)return t[s];return null}getBatches(e){let t=[],s=this._batchList.length;for(let i=0;i<s;i++){let r=this._batchList[i];r.batchGroupId===e&&t.push(r)}return t}_removeModelsFromBatchGroup(e,t){if(e.enabled){e.model&&e.model.batchGroupId===t&&(e.model.batchGroupId=-1),e.render&&e.render.batchGroupId===t&&(e.render.batchGroupId=-1),e.element&&e.element.batchGroupId===t&&(e.element.batchGroupId=-1),e.sprite&&e.sprite.batchGroupId===t&&(e.sprite.batchGroupId=-1);for(let s=0;s<e._children.length;s++)this._removeModelsFromBatchGroup(e._children[s],t)}}insert(e,t,s){let i=this._batchGroups[t];i&&i._obj[e].indexOf(s)<0&&(i._obj[e].push(s),this.markGroupDirty(t))}remove(e,t,s){let i=this._batchGroups[t];if(i){let r=i._obj[e].indexOf(s);r>=0&&(i._obj[e].splice(r,1),this.markGroupDirty(t))}}_extractRender(e,t,s,i){return e.render&&(t=i[e.render.batchGroupId]=t.concat(e.render.meshInstances),e.render.removeFromLayers()),t}_extractModel(e,t,s,i){return e.model&&e.model.model&&(t=i[e.model.batchGroupId]=t.concat(e.model.meshInstances),e.model.removeModelFromLayers()),t}_extractElement(e,t,s){if(!e.element)return;let i=!1;e.element._text&&e.element._text._model.meshInstances.length>0?(t.push(e.element._text._model.meshInstances[0]),e.element.removeModelFromLayers(e.element._text._model),i=!0):e.element._image&&(t.push(e.element._image._renderable.meshInstance),e.element.removeModelFromLayers(e.element._image._renderable.model),e.element._image._renderable.unmaskMeshInstance&&(t.push(e.element._image._renderable.unmaskMeshInstance),(!e.element._image._renderable.unmaskMeshInstance.stencilFront||!e.element._image._renderable.unmaskMeshInstance.stencilBack)&&(e.element._dirtifyMask(),e.element._onPrerender())),i=!0),i&&(s._ui=!0)}_collectAndRemoveMeshInstances(e,t){for(let s=0;s<t.length;s++){let i=t[s],r=this._batchGroups[i];if(!r)continue;let a=e[i];a||(a=e[i]=[]);for(let n=0;n<r._obj.model.length;n++)a=this._extractModel(r._obj.model[n],a,r,e);for(let n=0;n<r._obj.render.length;n++)a=this._extractRender(r._obj.render[n],a,r,e);for(let n=0;n<r._obj.element.length;n++)this._extractElement(r._obj.element[n],a,r);for(let n=0;n<r._obj.sprite.length;n++){let l=r._obj.sprite[n];l.sprite&&l.sprite._meshInstance&&(r.dynamic||l.sprite.sprite._renderMode===ni)&&(a.push(l.sprite._meshInstance),l.sprite.removeModelFromLayers(),r._sprite=!0,l.sprite._batchGroup=r)}}}generate(e){let t={};e||(e=Object.keys(this._batchGroups));let s=[];for(let l=0;l<this._batchList.length;l++){if(e.indexOf(this._batchList[l].batchGroupId)<0){s.push(this._batchList[l]);continue}this.destroyBatch(this._batchList[l])}if(this._batchList=s,this._collectAndRemoveMeshInstances(t,e),e===this._dirtyGroups)this._dirtyGroups.length=0;else{let l=[];for(let h=0;h<this._dirtyGroups.length;h++)e.indexOf(this._dirtyGroups[h])<0&&l.push(this._dirtyGroups[h]);this._dirtyGroups=l}let i,r,a,n;for(let l in t)if(t.hasOwnProperty(l)&&(i=t[l],a=this._batchGroups[l],!!a)){r=this.prepare(i,a.dynamic,a.maxAabbSize,a._ui||a._sprite);for(let h=0;h<r.length;h++)n=this.create(r[h],a.dynamic,parseInt(l,10)),n&&n.addToLayers(this.scene,a.layers)}}prepare(e,t,s=Number.POSITIVE_INFINITY,i){if(e.length===0)return[];let r=s*.5,a=1024,n=4294967295,l=new _e,h=new _e,c=null,f,d=[],u=0;i&&e.sort((T,x)=>T.drawOrder-x.drawOrder);let p=e,_,S=i?function(T){c?c.add(T.aabb):c=T.aabb.clone(),_.push(T)}:function(T){_.push(T)};for(;p.length>0;){d[u]=[p[0]],_=[];let T=p[0].material,x=p[0].layer,A=p[0]._shaderDefs,E=p[0].parameters,v=p[0].stencilFront,R=p[0].mesh.vertexBuffer.getNumVertices(),P=p[0].drawOrder;l.copy(p[0].aabb);let y=xL(p[0]),C=p[0].mesh.vertexBuffer.format.batchingHash,L=p[0].mesh.primitive[0].indexed;c=null;for(let O=1;O<p.length;O++){let M=p[O];if(t&&d[u].length>=a){_=_.concat(p.slice(O));break}if(T!==M.material||x!==M.layer||C!==M.mesh.vertexBuffer.format.batchingHash||L!==M.mesh.primitive[0].indexed||A!==M._shaderDefs||R+M.mesh.vertexBuffer.getNumVertices()>n){S(M);continue}if(h.copy(l),h.add(M.aabb),h.halfExtents.x>r||h.halfExtents.y>r||h.halfExtents.z>r){S(M);continue}if(v&&(!(f=M.stencilFront)||v.func!==f.func||v.zpass!==f.zpass)){S(M);continue}if(y!==xL(M)){S(M);continue}if(!hae(E,M.parameters)){S(M);continue}if(i&&c&&c.intersects(M.aabb)&&M.drawOrder!==P){S(M);continue}l.add(M.aabb),R+=M.mesh.vertexBuffer.getNumVertices(),d[u].push(M)}u++,p=_}return d}collectBatchedMeshData(e,t){let s=null,i=0,r=0,a=null;for(let n=0;n<e.length;n++)if(e[n].visible){let l=e[n].mesh,h=l.vertexBuffer.numVertices;if(i+=h,l.primitive[0].indexed)r+=l.primitive[0].count;else{let c=l.primitive[0].type;(c===Wi||c===rs)&&l.primitive[0].count===4&&(r+=6)}if(!s){a=e[n].material,s={};let c=l.vertexBuffer.format.elements;for(let f=0;f<c.length;f++){let d=c[f].name;s[d]={numComponents:c[f].numComponents,dataType:c[f].dataType,normalize:c[f].normalize,count:0}}t&&(s[Gt]={numComponents:1,dataType:pe,normalize:!1,count:0})}}return{streams:s,batchNumVerts:i,batchNumIndices:r,material:a}}create(e,t,s){this._init||(this.vertexFormats={},this._init=!0);let i=null,r,a,n,l=null,h=this.collectBatchedMeshData(e,t);if(h.streams){let c=h.streams,f=h.material,d=h.batchNumVerts,u=h.batchNumIndices;l=new Hf(e,t,s),this._batchList.push(l);let p,_,S,T,x=0,A=0,E,v=d<=65535?Uint16Array:Uint32Array,R=new v(u);for(r in c)i=c[r],i.typeArrayType=Xa[i.dataType],i.elementByteSize=$n[i.dataType],i.buffer=new i.typeArrayType(d*i.numComponents);for(let C=0;C<e.length;C++)if(e[C].visible){a=e[C].mesh,n=a.vertexBuffer.numVertices,t||(E=e[C].node.getWorldTransform());for(r in c)if(r!==Gt){i=c[r];let L=new i.typeArrayType(i.buffer.buffer,i.elementByteSize*i.count),O=a.getVertexStream(r,L)*i.numComponents;if(i.count+=O,!t&&i.numComponents>=3){if(r===te){let M=E.data,U=M[0],G=M[1],$=M[2],X=M[4],I=M[5],b=M[6],F=M[8],B=M[9],V=M[10],z=M[12],ee=M[13],se=M[14],Y,ne,ce;for(let ze=0;ze<O;ze+=i.numComponents)Y=L[ze],ne=L[ze+1],ce=L[ze+2],L[ze]=Y*U+ne*X+ce*F+z,L[ze+1]=Y*G+ne*I+ce*B+ee,L[ze+2]=Y*$+ne*b+ce*V+se}else if(r===Pt||r===as){hB.invertMat4(E).transpose();let[M,U,G,$,X,I,b,F,B]=hB.data,V,z,ee;for(let se=0;se<O;se+=i.numComponents)V=L[se],z=L[se+1],ee=L[se+2],L[se]=V*M+z*$+ee*b,L[se+1]=V*U+z*X+ee*F,L[se+2]=V*G+z*I+ee*B}}}if(t){i=c[Gt];for(let L=0;L<n;L++)i.buffer[i.count++]=C}if(a.primitive[0].indexed){p=a.primitive[0].base,_=a.primitive[0].baseVertex||0,S=a.primitive[0].count;let L=a.indexBuffer[0].getFormat();T=new Yo[L](a.indexBuffer[0].storage)}else{_=0;let L=a.primitive[0].type;if(L===Wi||L===rs)if(a.primitive[0].count===4)p=0,S=6,T=L===Wi?oae:lae;else{S=0;continue}}for(let L=0;L<S;L++)R[L+A]=T[p+L]+_+x;A+=S,x+=n}a=new Ce(this.device);for(r in c)i=c[r],a.setVertexStream(r,i.buffer,i.numComponents,void 0,i.dataType,i.normalize);R.length>0&&a.setIndices(R),a.update(As,!1),t&&(f=f.clone(),f.update());let P=new Oe(a,f,this.rootNode);P.castShadow=l.origMeshInstances[0].castShadow,P.parameters=l.origMeshInstances[0].parameters,P.layer=l.origMeshInstances[0].layer,P._shaderDefs=l.origMeshInstances[0]._shaderDefs,P.batching=!0,P.cull=l.origMeshInstances[0].cull;let y=this._batchGroups[s];if(y&&y._ui&&(P.cull=!1),t){let C=[];for(let L=0;L<l.origMeshInstances.length;L++)C.push(l.origMeshInstances[L].node);P.skinInstance=new Yf(this.device,C,this.rootNode)}P._updateAabb=!1,P.drawOrder=l.origMeshInstances[0].drawOrder,P.stencilFront=l.origMeshInstances[0].stencilFront,P.stencilBack=l.origMeshInstances[0].stencilBack,P.flipFacesFactor=xL(l.origMeshInstances[0]),P.castShadow=l.origMeshInstances[0].castShadow,l.meshInstance=P,l.updateBoundingBox()}return l}updateAll(){this._dirtyGroups.length>0&&this.generate(this._dirtyGroups);for(let e=0;e<this._batchList.length;e++)this._batchList[e].dynamic&&this._batchList[e].updateBoundingBox()}clone(e,t){let s=new Hf(t,e.dynamic,e.batchGroupId);this._batchList.push(s);let i=[];for(let r=0;r<t.length;r++)i.push(t[r].node);return s.meshInstance=new Oe(e.meshInstance.mesh,e.meshInstance.material,e.meshInstance.node),s.meshInstance._updateAabb=!1,s.meshInstance.parameters=t[0].parameters,s.meshInstance.cull=t[0].cull,s.meshInstance.layer=t[0].layer,e.dynamic&&(s.meshInstance.skinInstance=new Yf(this.device,i,this.rootNode)),s.meshInstance.castShadow=e.meshInstance.castShadow,s}destroyBatch(e){e.destroy(this.scene,this._batchGroups[e.batchGroupId].layers)}}});var fB,kh,Ny=m(()=>{us();Rt();Fe();fB="uSceneColorMap",kh=class extends Xe{destroy(){super.destroy(),this.releaseRenderTarget(this.colorRenderTarget)}shouldReallocate(e,t,s){if(e?.colorBuffer.format!==s)return!0;let r=t?.width||this.device.width,a=t?.height||this.device.height;return!e||r!==e.width||a!==e.height}allocateRenderTarget(e,t,s,i){let r=new q(s,{name:fB,format:i,width:t?t.colorBuffer.width:s.width,height:t?t.colorBuffer.height:s.height,mipmaps:!0,minFilter:5,magFilter:1,addressU:1,addressV:1});return e?(e.destroyFrameBuffers(),e._colorBuffer=r,e._colorBuffers=[r]):e=new xe({name:"ColorGrabRT",colorBuffer:r,depth:!1,stencil:!1,autoResolve:!1}),e}releaseRenderTarget(e){e&&(e.destroyTextureBuffers(),e.destroy())}frameUpdate(){let e=this.device,t=this.source,s=t?.colorBuffer.format??this.device.backBufferFormat;this.shouldReallocate(this.colorRenderTarget,t?.colorBuffer,s)&&(this.releaseRenderTarget(this.colorRenderTarget),this.colorRenderTarget=this.allocateRenderTarget(this.colorRenderTarget,t,e,s));let i=this.colorRenderTarget.colorBuffer;e.scope.resolve(fB).setValue(i)}execute(){let e=this.device,t=this.source,s=this.colorRenderTarget.colorBuffer;e.isWebGPU?(e.copyRenderTarget(t,this.colorRenderTarget,!0,!1),e.mipmapRenderer.generate(this.colorRenderTarget.colorBuffer.impl)):(e.copyRenderTarget(t,this.colorRenderTarget,!0,!1),e.activeTexture(e.maxCombinedTextures-1),e.bindTexture(s),e.gl.generateMipmap(s.impl._glTarget))}constructor(...e){super(...e),this.colorRenderTarget=null,this.source=null}}});var dB,Fy,uB=m(()=>{us();Rt();Fe();dB="uSceneDepthMap",Fy=class extends Xe{constructor(e,t){super(e),this.depthRenderTarget=null,this.camera=null,this.camera=t}destroy(){super.destroy(),this.releaseRenderTarget(this.depthRenderTarget)}shouldReallocate(e,t){let s=t?.width||this.device.width,i=t?.height||this.device.height;return!e||s!==e.width||i!==e.height}allocateRenderTarget(e,t,s,i,r){let a=new q(s,{name:dB,format:i,width:t?t.colorBuffer.width:s.width,height:t?t.colorBuffer.height:s.height,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1});return e?(e.destroyFrameBuffers(),r?e._depthBuffer=a:(e._colorBuffer=a,e._colorBuffers=[a])):e=new xe({name:"DepthGrabRT",colorBuffer:r?null:a,depthBuffer:r?a:null,depth:!r,stencil:s.supportsStencil,autoResolve:!1}),e}releaseRenderTarget(e){e&&(e.destroyTextureBuffers(),e.destroy())}before(){let e=this.camera,t=this.device,s=e?.renderTarget??t.backBuffer,i=!0,r=s.stencil?17:16;t.isWebGPU&&s.samples>1&&(r=15,i=!1);let a=e.renderTarget?.depthBuffer??e.renderTarget?.colorBuffer;this.shouldReallocate(this.depthRenderTarget,a)&&(this.releaseRenderTarget(this.depthRenderTarget),this.depthRenderTarget=this.allocateRenderTarget(this.depthRenderTarget,e.renderTarget,t,r,i));let n=i?this.depthRenderTarget.depthBuffer:this.depthRenderTarget.colorBuffer;t.scope.resolve(dB).setValue(n)}execute(){let e=this.device;if(e.isWebGL2&&e.renderTarget.samples>1){let t=e.renderTarget.impl._glFrameBuffer,s=this.depthRenderTarget;e.renderTarget=s,e.updateBegin(),this.depthRenderTarget.impl.internalResolve(e,t,s.impl._glFrameBuffer,this.depthRenderTarget,e.gl.DEPTH_BUFFER_BIT)}else e.copyRenderTarget(e.renderTarget,this.depthRenderTarget,!1,!0)}}});var Bm,AL=m(()=>{Ya();J();Bm=class{get hash(){if(this._hash===void 0){let e=`${this.gammaCorrection}_${this.toneMapping}_${this.srgbRenderTarget}_${this.fog}_${this.ssaoEnabled}_${this.sceneDepthMapLinear}`;this._hash=Is(e)}return this._hash}get defines(){let e=this._defines;return this._definesDirty&&(this._definesDirty=!1,e.clear(),this._sceneDepthMapLinear&&e.set("SCENE_DEPTHMAP_LINEAR",!0),e.set("FOG",this._fog.toUpperCase()),e.set("TONEMAP",Ph[this._toneMapping]),e.set("GAMMA",Rm[this.shaderOutputGamma])),e}markDirty(){this._hash=void 0,this._definesDirty=!0}set fog(e){this._fog!==e&&(this._fog=e,this.markDirty())}get fog(){return this._fog}set ssaoEnabled(e){this._ssaoEnabled!==e&&(this._ssaoEnabled=e,this.markDirty())}get ssaoEnabled(){return this._ssaoEnabled}set gammaCorrection(e){this._gammaCorrectionAssigned=!0,this._gammaCorrection!==e&&(this._gammaCorrection=e,this.markDirty())}get gammaCorrection(){return this._gammaCorrection}set toneMapping(e){this._toneMapping!==e&&(this._toneMapping=e,this.markDirty())}get toneMapping(){return this._toneMapping}set srgbRenderTarget(e){this._srgbRenderTarget!==e&&(this._srgbRenderTarget=e,this.markDirty())}get srgbRenderTarget(){return this._srgbRenderTarget}set sceneDepthMapLinear(e){this._sceneDepthMapLinear!==e&&(this._sceneDepthMapLinear=e,this.markDirty())}get sceneDepthMapLinear(){return this._sceneDepthMapLinear}get shaderOutputGamma(){return this._gammaCorrection===io&&!this._srgbRenderTarget?io:Mi}constructor(){this._gammaCorrection=io,this._toneMapping=ro,this._srgbRenderTarget=!1,this._ssaoEnabled=!1,this._fog=tr,this._sceneDepthMapLinear=!1,this._defines=new Map,this._definesDirty=!0}}});var Vm,XS,mB,pB,cae,co,WS=m(()=>{De();Ke();Q();Ze();me();aI();J();Ny();uB();AL();Vm=new g,XS=new g,mB=new g,pB=new k,cae=[new g,new g,new g,new g,new g,new g,new g,new g],co=class o{constructor(){this.shaderPassInfo=null,this.renderPassColorGrab=null,this.renderPassDepthGrab=null,this.fogParams=null,this.shaderParams=new Bm,this.renderPasses=[],this.jitter=0,this._aspectRatio=16/9,this._aspectRatioMode=Nh,this._calculateProjection=null,this._calculateTransform=null,this._clearColor=new N(.75,.75,.75,1),this._clearColorBuffer=!0,this._clearDepth=1,this._clearDepthBuffer=!0,this._clearStencil=0,this._clearStencilBuffer=!0,this._cullFaces=!0,this._farClip=1e3,this._flipFaces=!1,this._fov=45,this._frustumCulling=!0,this._horizontalFov=!1,this._layers=[ms,Xt,to,pa,so],this._layersSet=new Set(this._layers),this._nearClip=.1,this._node=null,this._orthoHeight=10,this._projection=Mt,this._rect=new W(0,0,1,1),this._renderTarget=null,this._scissorRect=new W(0,0,1,1),this._scissorRectClear=!1,this._aperture=16,this._shutter=1/1e3,this._sensitivity=1e3,this._projMat=new k,this._projMatDirty=!0,this._projMatSkybox=new k,this._viewMat=new k,this._viewMatDirty=!0,this._viewProjMat=new k,this._viewProjMatDirty=!0,this._shaderMatricesVersion=0,this._viewProjInverse=new k,this._viewProjCurrent=null,this._viewProjPrevious=new k,this._jitters=[0,0,0,0],this.frustum=new du,this._xr=null,this._xrProperties={horizontalFov:this._horizontalFov,fov:this._fov,aspectRatio:this._aspectRatio,farClip:this._farClip,nearClip:this._nearClip}}destroy(){this.renderPassColorGrab?.destroy(),this.renderPassColorGrab=null,this.renderPassDepthGrab?.destroy(),this.renderPassDepthGrab=null,this.renderPasses.length=0}_storeShaderMatrices(e,t,s,i){this._shaderMatricesVersion!==i&&(this._shaderMatricesVersion=i,this._viewProjPrevious.copy(this._viewProjCurrent??e),this._viewProjCurrent??=new k,this._viewProjCurrent.copy(e),this._viewProjInverse.invert(e),this._jitters[2]=this._jitters[0],this._jitters[3]=this._jitters[1],this._jitters[0]=t,this._jitters[1]=s)}get fullSizeClearRect(){let e=this._scissorRectClear?this.scissorRect:this._rect;return e.x===0&&e.y===0&&e.z===1&&e.w===1}set aspectRatio(e){this._aspectRatio!==e&&(this._aspectRatio=e,this._projMatDirty=!0)}get aspectRatio(){return this.xr?.active?this._xrProperties.aspectRatio:this._aspectRatio}set aspectRatioMode(e){this._aspectRatioMode!==e&&(this._aspectRatioMode=e,this._projMatDirty=!0)}get aspectRatioMode(){return this._aspectRatioMode}set calculateProjection(e){this._calculateProjection=e,this._projMatDirty=!0}get calculateProjection(){return this._calculateProjection}set calculateTransform(e){this._calculateTransform=e}get calculateTransform(){return this._calculateTransform}set clearColor(e){this._clearColor.copy(e)}get clearColor(){return this._clearColor}set clearColorBuffer(e){this._clearColorBuffer=e}get clearColorBuffer(){return this._clearColorBuffer}set clearDepth(e){this._clearDepth=e}get clearDepth(){return this._clearDepth}set clearDepthBuffer(e){this._clearDepthBuffer=e}get clearDepthBuffer(){return this._clearDepthBuffer}set clearStencil(e){this._clearStencil=e}get clearStencil(){return this._clearStencil}set clearStencilBuffer(e){this._clearStencilBuffer=e}get clearStencilBuffer(){return this._clearStencilBuffer}set cullFaces(e){this._cullFaces=e}get cullFaces(){return this._cullFaces}set farClip(e){this._farClip!==e&&(this._farClip=e,this._projMatDirty=!0)}get farClip(){return this.xr?.active?this._xrProperties.farClip:this._farClip}set flipFaces(e){this._flipFaces=e}get flipFaces(){return this._flipFaces}set fov(e){this._fov!==e&&(this._fov=e,this._projMatDirty=!0)}get fov(){return this.xr?.active?this._xrProperties.fov:this._fov}set frustumCulling(e){this._frustumCulling=e}get frustumCulling(){return this._frustumCulling}set horizontalFov(e){this._horizontalFov!==e&&(this._horizontalFov=e,this._projMatDirty=!0)}get horizontalFov(){return this.xr?.active?this._xrProperties.horizontalFov:this._horizontalFov}set layers(e){this._layers=e.slice(0),this._layersSet=new Set(this._layers)}get layers(){return this._layers}get layersSet(){return this._layersSet}set nearClip(e){this._nearClip!==e&&(this._nearClip=e,this._projMatDirty=!0)}get nearClip(){return this.xr?.active?this._xrProperties.nearClip:this._nearClip}set node(e){this._node=e}get node(){return this._node}set orthoHeight(e){this._orthoHeight!==e&&(this._orthoHeight=e,this._projMatDirty=!0)}get orthoHeight(){return this._orthoHeight}set projection(e){this._projection!==e&&(this._projection=e,this._projMatDirty=!0)}get projection(){return this._projection}get projectionMatrix(){return this._evaluateProjectionMatrix(),this._projMat}set rect(e){this._rect.copy(e)}get rect(){return this._rect}set renderTarget(e){this._renderTarget=e}get renderTarget(){return this._renderTarget}set scissorRect(e){this._scissorRect.copy(e)}get scissorRect(){return this._scissorRect}get viewMatrix(){if(this._viewMatDirty){let e=this._node.getWorldTransform();this._viewMat.copy(e).invert(),this._viewMatDirty=!1}return this._viewMat}set aperture(e){this._aperture=e}get aperture(){return this._aperture}set sensitivity(e){this._sensitivity=e}get sensitivity(){return this._sensitivity}set shutter(e){this._shutter=e}get shutter(){return this._shutter}set xr(e){this._xr!==e&&(this._xr=e,this._projMatDirty=!0)}get xr(){return this._xr}clone(){return new o().copy(this)}copy(e){return this._aspectRatio=e._aspectRatio,this._farClip=e._farClip,this._fov=e._fov,this._horizontalFov=e._horizontalFov,this._nearClip=e._nearClip,this._xrProperties.aspectRatio=e._xrProperties.aspectRatio,this._xrProperties.farClip=e._xrProperties.farClip,this._xrProperties.fov=e._xrProperties.fov,this._xrProperties.horizontalFov=e._xrProperties.horizontalFov,this._xrProperties.nearClip=e._xrProperties.nearClip,this.aspectRatioMode=e.aspectRatioMode,this.calculateProjection=e.calculateProjection,this.calculateTransform=e.calculateTransform,this.clearColor=e.clearColor,this.clearColorBuffer=e.clearColorBuffer,this.clearDepth=e.clearDepth,this.clearDepthBuffer=e.clearDepthBuffer,this.clearStencil=e.clearStencil,this.clearStencilBuffer=e.clearStencilBuffer,this.cullFaces=e.cullFaces,this.flipFaces=e.flipFaces,this.frustumCulling=e.frustumCulling,this.layers=e.layers,this.orthoHeight=e.orthoHeight,this.projection=e.projection,this.rect=e.rect,this.renderTarget=e.renderTarget,this.scissorRect=e.scissorRect,this.aperture=e.aperture,this.shutter=e.shutter,this.sensitivity=e.sensitivity,this.shaderPassInfo=e.shaderPassInfo,this.jitter=e.jitter,this._projMatDirty=!0,this}_enableRenderPassColorGrab(e,t){t?this.renderPassColorGrab||(this.renderPassColorGrab=new kh(e)):(this.renderPassColorGrab?.destroy(),this.renderPassColorGrab=null)}_enableRenderPassDepthGrab(e,t,s){s?this.renderPassDepthGrab||(this.renderPassDepthGrab=new Fy(e,this)):(this.renderPassDepthGrab?.destroy(),this.renderPassDepthGrab=null)}_updateViewProjMat(){(this._projMatDirty||this._viewMatDirty||this._viewProjMatDirty)&&(this._viewProjMat.mul2(this.projectionMatrix,this.viewMatrix),this._viewProjMatDirty=!1)}worldToScreen(e,t,s,i=new g){this._updateViewProjMat(),this._viewProjMat.transformPoint(e,i);let r=this._viewProjMat.data,a=e.x*r[3]+e.y*r[7]+e.z*r[11]+1*r[15];i.x=(i.x/a+1)*.5,i.y=(1-i.y/a)*.5;let{x:n,y:l,z:h,w:c}=this._rect;return i.x=i.x*h*t+n*t,i.y=i.y*c*s+(1-l-c)*s,i}screenToWorld(e,t,s,i,r,a=new g){let{x:n,y:l,z:h,w:c}=this._rect,f=this.farClip-this.nearClip;if(Vm.set((e-n*i)/(h*i),1-(t-(1-l-c)*r)/(c*r),s/f),Vm.mulScalar(2),Vm.sub(g.ONE),this._projection===Mt){k._getPerspectiveHalfSize(XS,this.fov,this.aspectRatio,this.nearClip,this.horizontalFov),XS.x*=Vm.x,XS.y*=Vm.y;let d=this._node.getWorldTransform();XS.z=-this.nearClip,d.transformPoint(XS,mB);let u=this._node.getPosition();a.sub2(mB,u),a.normalize(),a.mulScalar(s),a.add(u)}else this._updateViewProjMat(),pB.copy(this._viewProjMat).invert(),pB.transformPoint(Vm,a);return a}_evaluateProjectionMatrix(){if(this._projMatDirty){if(this._projection===Mt)this._projMat.setPerspective(this.fov,this.aspectRatio,this.nearClip,this.farClip,this.horizontalFov),this._projMatSkybox.copy(this._projMat);else{let e=this._orthoHeight,t=e*this.aspectRatio;this._projMat.setOrtho(-t,t,-e,e,this.nearClip,this.farClip),this._projMatSkybox.setPerspective(this.fov,this.aspectRatio,this.nearClip,this.farClip)}this._projMatDirty=!1}}getProjectionMatrixSkybox(){return this._evaluateProjectionMatrix(),this._projMatSkybox}getExposure(){let e=Math.log2(this._aperture*this._aperture/this._shutter*100/this._sensitivity);return 1/(Math.pow(2,e)*1.2)}getScreenSize(e){if(this._projection===Mt){let t=this._node.getPosition().distance(e.center);if(t<e.radius)return 1;let s=Math.asin(e.radius/t),i=Math.tan(s),r=Math.tan(this.fov/2*w.DEG_TO_RAD);return Math.min(i/r,1)}return w.clamp(e.radius/this._orthoHeight,0,1)}getFrustumCorners(e=this.nearClip,t=this.farClip){let s=this.fov*Math.PI/180,i,r;this.projection===Mt?this.horizontalFov?(i=e*Math.tan(s/2),r=i/this.aspectRatio):(r=e*Math.tan(s/2),i=r*this.aspectRatio):(r=this._orthoHeight,i=r*this.aspectRatio);let a=cae;return a[0].x=i,a[0].y=-r,a[0].z=-e,a[1].x=i,a[1].y=r,a[1].z=-e,a[2].x=-i,a[2].y=r,a[2].z=-e,a[3].x=-i,a[3].y=-r,a[3].z=-e,this._projection===Mt&&(this.horizontalFov?(i=t*Math.tan(s/2),r=i/this.aspectRatio):(r=t*Math.tan(s/2),i=r*this.aspectRatio)),a[4].x=i,a[4].y=-r,a[4].z=-t,a[5].x=i,a[5].y=r,a[5].z=-t,a[6].x=-i,a[6].y=r,a[6].z=-t,a[7].x=-i,a[7].y=-r,a[7].z=-t,a}setXrProperties(e){Object.assign(this._xrProperties,e),this._projMatDirty=!0}}});function vB(o,e){return o instanceof Function?o:t=>{let s=t[o];return s instanceof Function&&(s=s()),s===e}}function xB(o,e){if(e(o))return o;let t=o._children,s=t.length;for(let i=0;i<s;++i){let r=xB(t[i],e);if(r)return r}return null}var _B,PL,gB,RL,SB,TB,fae,dae,wr,YS,Lr,km,EB,CL,Uy,Ae,Zt=m(()=>{Pe();wE();Zl();Ke();Ve();Q();_B=new k,PL=new g,gB=new H,RL=new H,SB=new g,TB=new g,fae=new k,dae=new H,wr=new g,YS=new k,Lr=new H,km=new H,EB=new k,CL=new g,Uy=new g;Ae=class extends K{constructor(e="Untitled"){super(),this.tags=new Kl(this),this.localPosition=new g,this.localRotation=new H,this.localScale=new g(1,1,1),this.localEulerAngles=new g,this.position=new g,this.rotation=new H,this.eulerAngles=new g,this._scale=null,this.localTransform=new k,this._dirtyLocal=!1,this._aabbVer=0,this._frozen=!1,this.worldTransform=new k,this._dirtyWorld=!1,this._worldScaleSign=0,this._normalMatrix=new Vs,this._dirtyNormal=!0,this._right=null,this._up=null,this._forward=null,this._parent=null,this._children=[],this._graphDepth=0,this._enabled=!0,this._enabledInHierarchy=!1,this.scaleCompensation=!1,this.name=e}get right(){return this._right||(this._right=new g),this.getWorldTransform().getX(this._right).normalize()}get up(){return this._up||(this._up=new g),this.getWorldTransform().getY(this._up).normalize()}get forward(){return this._forward||(this._forward=new g),this.getWorldTransform().getZ(this._forward).normalize().mulScalar(-1)}get normalMatrix(){let e=this._normalMatrix;return this._dirtyNormal&&(e.invertMat4(this.getWorldTransform()).transpose(),this._dirtyNormal=!1),e}set enabled(e){this._enabled!==e&&(this._enabled=e,(e&&this._parent?.enabled||!e)&&this._notifyHierarchyStateChanged(this,e))}get enabled(){return this._enabled&&this._enabledInHierarchy}get parent(){return this._parent}get path(){let e=this._parent;if(!e)return"";let t=this.name;for(;e&&e._parent;)t=`${e.name}/${t}`,e=e._parent;return t}get root(){let e=this;for(;e._parent;)e=e._parent;return e}get children(){return this._children}get graphDepth(){return this._graphDepth}_notifyHierarchyStateChanged(e,t){e._onHierarchyStateChanged(t);let s=e._children;for(let i=0,r=s.length;i<r;i++)s[i]._enabled&&this._notifyHierarchyStateChanged(s[i],t)}_onHierarchyStateChanged(e){this._enabledInHierarchy=e,e&&!this._frozen&&this._unfreezeParentToRoot()}_cloneInternal(e){e.name=this.name;let t=this.tags._list;e.tags.clear();for(let s=0;s<t.length;s++)e.tags.add(t[s]);e.localPosition.copy(this.localPosition),e.localRotation.copy(this.localRotation),e.localScale.copy(this.localScale),e.localEulerAngles.copy(this.localEulerAngles),e.position.copy(this.position),e.rotation.copy(this.rotation),e.eulerAngles.copy(this.eulerAngles),e.localTransform.copy(this.localTransform),e._dirtyLocal=this._dirtyLocal,e.worldTransform.copy(this.worldTransform),e._dirtyWorld=this._dirtyWorld,e._dirtyNormal=this._dirtyNormal,e._aabbVer=this._aabbVer+1,e._enabled=this._enabled,e.scaleCompensation=this.scaleCompensation,e._enabledInHierarchy=!1}clone(){let e=new this.constructor;return this._cloneInternal(e),e}copy(e){return e._cloneInternal(this),this}destroy(){this.remove();let e=this._children;for(;e.length;){let t=e.pop();t._parent=null,t.destroy()}this.fire("destroy",this),this.off()}find(e,t){let s=[],i=vB(e,t);return this.forEach(r=>{i(r)&&s.push(r)}),s}findOne(e,t){let s=vB(e,t);return xB(this,s)}findByTag(...e){let t=[],s=(i,r)=>{r&&i.tags.has(...e)&&t.push(i);for(let a=0;a<i._children.length;a++)s(i._children[a],!0)};return s(this,!1),t}findByName(e){return this.findOne("name",e)}findByPath(e){let t=Array.isArray(e)?e:e.split("/"),s=this;for(let i=0,r=t.length;i<r;++i)if(s=s.children.find(a=>a.name===t[i]),!s)return null;return s}forEach(e,t){e.call(t,this);let s=this._children,i=s.length;for(let r=0;r<i;++r)s[r].forEach(e,t)}isDescendantOf(e){let t=this._parent;for(;t;){if(t===e)return!0;t=t._parent}return!1}isAncestorOf(e){return e.isDescendantOf(this)}getEulerAngles(){return this.getWorldTransform().getEulerAngles(this.eulerAngles),this.eulerAngles}getLocalEulerAngles(){return this.localRotation.getEulerAngles(this.localEulerAngles),this.localEulerAngles}getLocalPosition(){return this.localPosition}getLocalRotation(){return this.localRotation}getLocalScale(){return this.localScale}getLocalTransform(){return this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this.localTransform}getPosition(){return this.getWorldTransform().getTranslation(this.position),this.position}getRotation(){return this.rotation.setFromMat4(this.getWorldTransform()),this.rotation}getScale(){return this._scale||(this._scale=new g),this.getWorldTransform().getScale(this._scale)}getWorldTransform(){return!this._dirtyLocal&&!this._dirtyWorld?this.worldTransform:(this._parent&&this._parent.getWorldTransform(),this._sync(),this.worldTransform)}get worldScaleSign(){return this._worldScaleSign===0&&(this._worldScaleSign=this.getWorldTransform().scaleSign),this._worldScaleSign}remove(){this._parent?.removeChild(this)}reparent(e,t){this.remove(),e&&(t>=0?e.insertChild(this,t):e.addChild(this))}setLocalEulerAngles(e,t,s){this.localRotation.setFromEulerAngles(e,t,s),this._dirtyLocal||this._dirtifyLocal()}setLocalPosition(e,t,s){e instanceof g?this.localPosition.copy(e):this.localPosition.set(e,t,s),this._dirtyLocal||this._dirtifyLocal()}setLocalRotation(e,t,s,i){e instanceof H?this.localRotation.copy(e):this.localRotation.set(e,t,s,i),this._dirtyLocal||this._dirtifyLocal()}setLocalScale(e,t,s){e instanceof g?this.localScale.copy(e):this.localScale.set(e,t,s),this._dirtyLocal||this._dirtifyLocal()}_dirtifyLocal(){this._dirtyLocal||(this._dirtyLocal=!0,this._dirtyWorld||this._dirtifyWorld())}_unfreezeParentToRoot(){let e=this._parent;for(;e;)e._frozen=!1,e=e._parent}_dirtifyWorld(){this._dirtyWorld||this._unfreezeParentToRoot(),this._dirtifyWorldInternal()}_dirtifyWorldInternal(){if(!this._dirtyWorld){this._frozen=!1,this._dirtyWorld=!0;for(let e=0;e<this._children.length;e++)this._children[e]._dirtyWorld||this._children[e]._dirtifyWorldInternal()}this._dirtyNormal=!0,this._worldScaleSign=0,this._aabbVer++}setPosition(e,t,s){e instanceof g?wr.copy(e):wr.set(e,t,s),this._parent===null?this.localPosition.copy(wr):(YS.copy(this._parent.getWorldTransform()).invert(),YS.transformPoint(wr,this.localPosition)),this._dirtyLocal||this._dirtifyLocal()}setRotation(e,t,s,i){if(e instanceof H?Lr.copy(e):Lr.set(e,t,s,i),this._parent===null)this.localRotation.copy(Lr);else{let r=this._parent.getRotation();km.copy(r).invert(),this.localRotation.copy(km).mul(Lr)}this._dirtyLocal||this._dirtifyLocal()}setPositionAndRotation(e,t){if(this._parent===null)this.localPosition.copy(e),this.localRotation.copy(t);else{let s=this._parent.getWorldTransform();YS.copy(s).invert(),YS.transformPoint(e,this.localPosition),this.localRotation.setFromMat4(YS).mul(t)}this._dirtyLocal||this._dirtifyLocal()}setEulerAngles(e,t,s){if(this.localRotation.setFromEulerAngles(e,t,s),this._parent!==null){let i=this._parent.getRotation();km.copy(i).invert(),this.localRotation.mul2(km,this.localRotation)}this._dirtyLocal||this._dirtifyLocal()}addChild(e){this._prepareInsertChild(e),this._children.push(e),this._onInsertChild(e)}addChildAndSaveTransform(e){let t=e.getPosition(),s=e.getRotation();this._prepareInsertChild(e),e.setPosition(fae.copy(this.worldTransform).invert().transformPoint(t)),e.setRotation(dae.copy(this.getRotation()).invert().mul(s)),this._children.push(e),this._onInsertChild(e)}insertChild(e,t){this._prepareInsertChild(e),this._children.splice(t,0,e),this._onInsertChild(e)}_prepareInsertChild(e){e.remove()}_fireOnHierarchy(e,t,s){this.fire(e,s);for(let i=0;i<this._children.length;i++)this._children[i]._fireOnHierarchy(t,t,s)}_onInsertChild(e){e._parent=this;let t=e._enabled&&this.enabled;e._enabledInHierarchy!==t&&(e._enabledInHierarchy=t,e._notifyHierarchyStateChanged(e,t)),e._updateGraphDepth(),e._dirtifyWorld(),this._frozen&&e._unfreezeParentToRoot(),e._fireOnHierarchy("insert","inserthierarchy",this),this.fire&&this.fire("childinsert",e)}_updateGraphDepth(){this._graphDepth=this._parent?this._parent._graphDepth+1:0;for(let e=0,t=this._children.length;e<t;e++)this._children[e]._updateGraphDepth()}removeChild(e){let t=this._children.indexOf(e);t!==-1&&(this._children.splice(t,1),e._parent=null,e._fireOnHierarchy("remove","removehierarchy",this),this.fire("childremove",e))}_sync(){if(this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this._dirtyWorld){if(this._parent===null)this.worldTransform.copy(this.localTransform);else if(this.scaleCompensation){let e,t=this._parent,s=this.localScale,i=t;if(i){for(;i&&i.scaleCompensation;)i=i._parent;i&&(i=i._parent,i&&(e=i.worldTransform.getScale(),SB.mul2(e,this.localScale),s=SB))}RL.setFromMat4(t.worldTransform),gB.mul2(RL,this.localRotation);let r=t.worldTransform;t.scaleCompensation&&(TB.mul2(e,t.getLocalScale()),_B.setTRS(t.worldTransform.getTranslation(PL),RL,TB),r=_B),r.transformPoint(this.localPosition,PL),this.worldTransform.setTRS(PL,gB,s)}else this.worldTransform.mulAffine2(this._parent.worldTransform,this.localTransform);this._dirtyWorld=!1}}syncHierarchy(){if(!this._enabled||this._frozen)return;this._frozen=!0,(this._dirtyLocal||this._dirtyWorld)&&this._sync();let e=this._children;for(let t=0,s=e.length;t<s;t++)e[t].syncHierarchy()}lookAt(e,t,s,i=0,r=1,a=0){if(e instanceof g)CL.copy(e),t instanceof g?Uy.copy(t):Uy.copy(g.UP);else{if(s===void 0)return;CL.set(e,t,s),Uy.set(i,r,a)}EB.setLookAt(this.getPosition(),CL,Uy),Lr.setFromMat4(EB),this.setRotation(Lr)}translate(e,t,s){e instanceof g?wr.copy(e):wr.set(e,t,s),wr.add(this.getPosition()),this.setPosition(wr)}translateLocal(e,t,s){e instanceof g?wr.copy(e):wr.set(e,t,s),this.localRotation.transformVector(wr,wr),this.localPosition.add(wr),this._dirtyLocal||this._dirtifyLocal()}rotate(e,t,s){if(Lr.setFromEulerAngles(e,t,s),this._parent===null)this.localRotation.mul2(Lr,this.localRotation);else{let i=this.getRotation(),r=this._parent.getRotation();km.copy(r).invert(),Lr.mul2(km,Lr),this.localRotation.mul2(Lr,i)}this._dirtyLocal||this._dirtifyLocal()}rotateLocal(e,t,s){Lr.setFromEulerAngles(e,t,s),this.localRotation.mul(Lr),this._dirtyLocal||this._dirtifyLocal()}}});var yB,AB,PB,fo,KS=m(()=>{Ve();Q();Ke();J();WS();Zt();yB=new k,AB=new k,PB=new k,fo=class o{static{this.pointLightRotations=[new H().setFromEulerAngles(0,90,180),new H().setFromEulerAngles(0,-90,180),new H().setFromEulerAngles(90,0,0),new H().setFromEulerAngles(-90,0,0),new H().setFromEulerAngles(0,180,180),new H().setFromEulerAngles(0,0,180)]}static create(e,t,s){let i=new co;switch(i.node=new Ae(e),i.aspectRatio=1,i.aspectRatioMode=Gf,i._scissorRectClear=!0,t){case Ge:i.node.setRotation(o.pointLightRotations[s]),i.fov=90,i.projection=Mt;break;case Ye:i.projection=Mt;break;case ge:i.projection=Xs;break}return i}static{this._spotCookieCamera=null}static evalSpotCookieMatrix(e){let t=o._spotCookieCamera;t||(t=o.create("SpotCookieCamera",Ye),o._spotCookieCamera=t),t.fov=e._outerConeAngle*2;let s=t._node;s.setPosition(e._node.getPosition()),s.setRotation(e._node.getRotation()),s.rotateLocal(-90,0,0),yB.setTRS(s.getPosition(),s.getRotation(),g.ONE).invert(),AB.mul2(t.projectionMatrix,yB);let i=e.cookieMatrix,r=e.atlasViewport;return PB.setViewport(r.x,r.y,r.z,r.w),i.mul2(PB,AB),i}}});var ya,Kf,uae,mae,Wt,pae,RB,CB,By,IB=m(()=>{Q();j();$l();J();Fe();KS();It();ya=new g,Kf=new Float32Array(6),uae=new g(-.5,0,0),mae=new g(0,0,.5),Wt={POSITION_RANGE:0,DIRECTION_FLAGS:1,COLOR_ANGLES_BIAS:2,PROJ_MAT_0:3,ATLAS_VIEWPORT:3,PROJ_MAT_1:4,PROJ_MAT_2:5,PROJ_MAT_3:6,AREA_DATA_WIDTH:7,AREA_DATA_HEIGHT:8,COUNT:9},pae={LIGHTSHAPE_PUNCTUAL:`${bs}u`,LIGHTSHAPE_RECT:`${CS}u`,LIGHTSHAPE_DISK:`${IS}u`,LIGHTSHAPE_SPHERE:`${wS}u`,LIGHT_COLOR_DIVIDER:`${xh}.0`},RB=(o,e)=>Object.keys(o).map(t=>`#define {${e}${t}} ${o[t]}`).join(`
`),CB=`

		${RB(Wt,"CLUSTER_TEXTURE_")}
		${RB(pae,"")}
`,By=class{constructor(e){this.areaLightsEnabled=!1,this.device=e,ie.get(e,oe).set("lightBufferDefinesPS",CB),ie.get(e,le).set("lightBufferDefinesPS",CB),this.cookiesEnabled=!1,this.shadowsEnabled=!1,this.areaLightsEnabled=!1,this.maxLights=255;let t=Wt.COUNT;this.lightsFloat=new Float32Array(4*t*this.maxLights),this.lightsUint=new Uint32Array(this.lightsFloat.buffer),this.lightsTexture=this.createTexture(this.device,t,this.maxLights,14,"LightsTexture"),this._lightsTextureId=this.device.scope.resolve("lightsTexture"),this.invMaxColorValue=0,this.invMaxAttenuation=0,this.boundsMin=new g,this.boundsDelta=new g}destroy(){this.lightsTexture?.destroy(),this.lightsTexture=null}createTexture(e,t,s,i,r){return new q(e,{name:r,width:t,height:s,mipmaps:!1,format:i,addressU:1,addressV:1,type:zt,magFilter:0,minFilter:0,anisotropy:1})}setBounds(e,t){this.boundsMin.copy(e),this.boundsDelta.copy(t)}uploadTextures(){this.lightsTexture.lock().set(this.lightsFloat),this.lightsTexture.unlock()}updateUniforms(){this._lightsTextureId.setValue(this.lightsTexture)}getSpotDirection(e,t){t._node.getWorldTransform().getY(e).mulScalar(-1),e.normalize()}getLightAreaSizes(e){let t=e._node.getWorldTransform();return t.transformVector(uae,ya),Kf[0]=ya.x,Kf[1]=ya.y,Kf[2]=ya.z,t.transformVector(mae,ya),Kf[3]=ya.x,Kf[4]=ya.y,Kf[5]=ya.z,Kf}addLightData(e,t){let s=e._type===Ye,i=e.atlasViewportAllocated,r=this.cookiesEnabled&&!!e._cookie&&i,a=this.areaLightsEnabled&&e.shape!==bs,n=this.shadowsEnabled&&e.castShadows&&i,l=e._node.getPosition(),h=null,c=null;s?n?h=e.getRenderData(null,0).shadowMatrix:r&&(h=fo.evalSpotCookieMatrix(e)):(n||r)&&(c=e.atlasViewport);let f=this.lightsFloat,d=this.lightsUint,u=t*this.lightsTexture.width*4;f[u+4*Wt.POSITION_RANGE+0]=l.x,f[u+4*Wt.POSITION_RANGE+1]=l.y,f[u+4*Wt.POSITION_RANGE+2]=l.z,f[u+4*Wt.POSITION_RANGE+3]=e.attenuationEnd;let p=e.clusteredData;if(d[u+4*Wt.COLOR_ANGLES_BIAS+0]=p[0],d[u+4*Wt.COLOR_ANGLES_BIAS+1]=p[1],d[u+4*Wt.COLOR_ANGLES_BIAS+2]=p[2],e.castShadows){let _=e.getRenderData(null,0),S=e._getUniformBiasValues(_),T=Bs.float2Half(S.bias),x=Bs.float2Half(S.normalBias);d[u+4*Wt.COLOR_ANGLES_BIAS+3]=T|x<<16}if(s&&(this.getSpotDirection(ya,e),f[u+4*Wt.DIRECTION_FLAGS+0]=ya.x,f[u+4*Wt.DIRECTION_FLAGS+1]=ya.y,f[u+4*Wt.DIRECTION_FLAGS+2]=ya.z),d[u+4*Wt.DIRECTION_FLAGS+3]=e.getClusteredFlags(n,r),h){let _=h.data;for(let S=0;S<16;S++)f[u+4*Wt.PROJ_MAT_0+S]=_[S]}if(c&&(f[u+4*Wt.ATLAS_VIEWPORT+0]=c.x,f[u+4*Wt.ATLAS_VIEWPORT+1]=c.y,f[u+4*Wt.ATLAS_VIEWPORT+2]=c.z/3),a){let _=this.getLightAreaSizes(e);f[u+4*Wt.AREA_DATA_WIDTH+0]=_[0],f[u+4*Wt.AREA_DATA_WIDTH+1]=_[1],f[u+4*Wt.AREA_DATA_WIDTH+2]=_[2],f[u+4*Wt.AREA_DATA_HEIGHT+0]=_[3],f[u+4*Wt.AREA_DATA_HEIGHT+1]=_[4],f[u+4*Wt.AREA_DATA_HEIGHT+2]=_[5]}}}});var Vy,ky,Gy,IL,zy,tl,Hy=m(()=>{Q();me();Vt();J();IB();Vy=new g,ky=new g,Gy=new g,IL=new _e,zy=class{constructor(){this.light=null,this.min=new g,this.max=new g}},tl=class{constructor(e){this.device=e,this.name="Untitled",this.reportCount=0,this.boundsMin=new g,this.boundsMax=new g,this.boundsDelta=new g,this._cells=new g(1,1,1),this._cellsLimit=new g,this.cells=this._cells,this.maxCellLightCount=4,this._usedLights=[],this._usedLights.push(new zy),this.lightsBuffer=new By(e),this.registerUniforms(e)}set maxCellLightCount(e){e!==this._maxCellLightCount&&(this._maxCellLightCount=e,this._cellsDirty=!0)}get maxCellLightCount(){return this._maxCellLightCount}set cells(e){Vy.copy(e).floor(),this._cells.equals(Vy)||(this._cells.copy(Vy),this._cellsLimit.copy(Vy).sub(g.ONE),this._cellsDirty=!0)}get cells(){return this._cells}destroy(){this.lightsBuffer.destroy(),this.releaseClusterTexture()}releaseClusterTexture(){this.clusterTexture&&(this.clusterTexture.destroy(),this.clusterTexture=null)}registerUniforms(e){this._clusterSkipId=e.scope.resolve("clusterSkip"),this._clusterMaxCellsId=e.scope.resolve("clusterMaxCells"),this._clusterWorldTextureId=e.scope.resolve("clusterWorldTexture"),this._clusterTextureSizeId=e.scope.resolve("clusterTextureSize"),this._clusterTextureSizeData=new Float32Array(3),this._clusterBoundsMinId=e.scope.resolve("clusterBoundsMin"),this._clusterBoundsMinData=new Float32Array(3),this._clusterBoundsDeltaId=e.scope.resolve("clusterBoundsDelta"),this._clusterBoundsDeltaData=new Float32Array(3),this._clusterCellsCountByBoundsSizeId=e.scope.resolve("clusterCellsCountByBoundsSize"),this._clusterCellsCountByBoundsSizeData=new Float32Array(3),this._clusterCellsDotId=e.scope.resolve("clusterCellsDot"),this._clusterCellsDotData=new Float32Array(3),this._clusterCellsMaxId=e.scope.resolve("clusterCellsMax"),this._clusterCellsMaxData=new Float32Array(3)}updateParams(e){e&&(this.cells=e.cells,this.maxCellLightCount=e.maxLightsPerCell,this.lightsBuffer.cookiesEnabled=e.cookiesEnabled,this.lightsBuffer.shadowsEnabled=e.shadowsEnabled,this.lightsBuffer.areaLightsEnabled=e.areaLightsEnabled)}updateCells(){if(this._cellsDirty){this._cellsDirty=!1;let e=this._cells.x,t=this._cells.y,s=this._cells.z,i=e*t*s,r=this.maxCellLightCount*i,a=Math.ceil(Math.sqrt(r));a=w.roundUp(a,this.maxCellLightCount);let n=Math.ceil(r/a);this._clusterCellsMaxData[0]=e,this._clusterCellsMaxData[1]=t,this._clusterCellsMaxData[2]=s,this._clusterCellsDotData[0]=this.maxCellLightCount,this._clusterCellsDotData[1]=e*s*this.maxCellLightCount,this._clusterCellsDotData[2]=e*this.maxCellLightCount,this.clusters=new Uint8ClampedArray(r),this.counts=new Int32Array(i),this._clusterTextureSizeData[0]=a,this._clusterTextureSizeData[1]=1/a,this._clusterTextureSizeData[2]=1/n,this.releaseClusterTexture(),this.clusterTexture=this.lightsBuffer.createTexture(this.device,a,n,52,"ClusterTexture")}}uploadTextures(){this.clusterTexture.lock().set(this.clusters),this.clusterTexture.unlock(),this.lightsBuffer.uploadTextures()}updateUniforms(){this._clusterSkipId.setValue(this._usedLights.length>1?0:1),this.lightsBuffer.updateUniforms(),this._clusterWorldTextureId.setValue(this.clusterTexture),this._clusterMaxCellsId.setValue(this.maxCellLightCount);let e=this.boundsDelta;this._clusterCellsCountByBoundsSizeData[0]=this._cells.x/e.x,this._clusterCellsCountByBoundsSizeData[1]=this._cells.y/e.y,this._clusterCellsCountByBoundsSizeData[2]=this._cells.z/e.z,this._clusterCellsCountByBoundsSizeId.setValue(this._clusterCellsCountByBoundsSizeData),this._clusterBoundsMinData[0]=this.boundsMin.x,this._clusterBoundsMinData[1]=this.boundsMin.y,this._clusterBoundsMinData[2]=this.boundsMin.z,this._clusterBoundsDeltaData[0]=e.x,this._clusterBoundsDeltaData[1]=e.y,this._clusterBoundsDeltaData[2]=e.z,this._clusterTextureSizeId.setValue(this._clusterTextureSizeData),this._clusterBoundsMinId.setValue(this._clusterBoundsMinData),this._clusterBoundsDeltaId.setValue(this._clusterBoundsDeltaData),this._clusterCellsDotId.setValue(this._clusterCellsDotData),this._clusterCellsMaxId.setValue(this._clusterCellsMaxData)}evalLightCellMinMax(e,t,s){t.copy(e.min),t.sub(this.boundsMin),t.div(this.boundsDelta),t.mul2(t,this.cells),t.floor(),s.copy(e.max),s.sub(this.boundsMin),s.div(this.boundsDelta),s.mul2(s,this.cells),s.ceil(),t.max(g.ZERO),s.min(this._cellsLimit)}collectLights(e){let t=this.lightsBuffer.maxLights,s=this._usedLights,i=1;e.forEach(r=>{let a=!!(r.mask&(ps|ir)),n=r.type===Ye&&r._outerConeAngle===0;if(r.enabled&&r.type!==ge&&r.visibleThisFrame&&r.intensity>0&&a&&!n&&i<t){let l;i<s.length?l=s[i]:(l=new zy,s.push(l)),l.light=r,r.getBoundingBox(IL),l.min.copy(IL.getMin()),l.max.copy(IL.getMax()),i++}}),s.length=i}evaluateBounds(){let e=this._usedLights,t=this.boundsMin,s=this.boundsMax;if(e.length>1){t.copy(e[1].min),s.copy(e[1].max);for(let i=2;i<e.length;i++)t.min(e[i].min),s.max(e[i].max)}else t.set(0,0,0),s.set(1,1,1);this.boundsDelta.sub2(s,t),this.lightsBuffer.setBounds(t,this.boundsDelta)}updateClusters(e){this.counts.fill(0),this.clusters.fill(0),this.lightsBuffer.areaLightsEnabled=e?e.areaLightsEnabled:!1;let t=this._cells.x,s=this._cells.z,i=this.counts,r=this._maxCellLightCount,a=this.clusters,n=this.maxCellLightCount,l=this._usedLights;for(let h=1;h<l.length;h++){let c=l[h],f=c.light;this.lightsBuffer.addLightData(f,h),this.evalLightCellMinMax(c,ky,Gy);let d=ky.x,u=Gy.x,p=ky.y,_=Gy.y,S=ky.z,T=Gy.z;for(let x=d;x<=u;x++)for(let A=S;A<=T;A++)for(let E=p;E<=_;E++){let v=x+t*(A+E*s),R=i[v];R<r&&(a[n*v+R]=h,i[v]=R+1)}}}update(e,t=null){this.updateParams(t),this.updateCells(),this.collectLights(e),this.evaluateBounds(),this.updateClusters(t),this.uploadTextures()}activate(){this.updateUniforms()}}});var _ae,sl,wB,LB,Gm,Xy=m(()=>{Ze();_ae="muPIHORMLNDCz4DxVR/ZvYfAUVEFR47KRIC4nwAAAAAP7WxlhD6Ci+2HCe7BF8jRAPZwdH2UPpI5PdLCJdkvG4UTaNDJ/0crAzne71GCrb4kbdMjjCEGzdX6fNxDMLJq5xkeoIVTdfiZkodEeArmZmp/FQzFjD4x8iOW7Dg64n+3mWqyEwLxXT8zoJXfbw8QJKDCaarUYyTlMzNFHbgUe9IQV7g4YOgtSKpIFZJ0qERm7u4PpmiF89ktHWCywaGmD6h+hfh2/Zd8KYlKqqo4Cem4T42bT/Z9FpCQF1hhSjfBzZ5XFn/y3jegWC6u86KuELRundQS/1Rp+XuKKGIgRv3CvP5y749yqLlFO495JOT3+f2CXgd71npU0/KjjpkZucbJ5m78IVyuSrSozc9jgBUhDrz0hFsyb7LFUH9//wJbBgLdNWJZObfKxrNt8TliLA9w9sXFv6g26iXpf6r/BqcAusj/QzGBZuoUGeEtw8BCXCZ3jUiw4hvM18ZVqlUD3C40LAFXW6FRjuAZGRNstb0/qVk4skwyT+MHrvRorI4rKHVMWZmKyAkzL/78u/9pMQuX14pZN50b2PHn6fRxeaCQLsfT4dpvIkWWFuFVENZIh+8xgR6lU+85W0PPdAu1j99kcCG40JBQa4JMyRzq6qriOBLtqF87vpCJan0WEduVr/mOYkS00urVA0mA6M3031+GmGmW48PaJDYOEIb3bIXWPaLoAOEinX1TN3+/vwhG6nqJu0TdHpedS7QsGZIoxH3nQYYjQP1jmbahlbNngw5ogsGk1y50XZyUmQBY+/JBJ3Unu4dApm+WmPwHPU9gLb+4mHh4BiY6M86pq+WeTyWdI3s0CXPEtHGXZ8zMZgUoyRomBi1VdazzuN+WOmQ9Pa0Z0tlNopUi8AJ4x2Xn4mmOKEbXLxlbVsWu8XhuDGYFOGCRVdSqDPXrHU5SDdUlti3k5///SBwzTMwK3L4a1H7w4lnpEas6////AfX8asyIBfeFXVJ3tgvxQ/blZuUKyIODIfr/UzdWNu7pciLBpdZRZ4pIfZ1R6szq+XNxkGG///8EZFpu7VHAhFWqHEOrB9unw+YQa5o8/9IR/V5/zq+986rJSyfgJKt2u9hxU1wzyQWPjJGvzG9+eWWxGFOHVKqI4jBQALwZZswesnvZ2UmmkEXdiRpz8B+oWE7PY70ZTMndisYSXg2TqoI+3y9BxbnY2Y4EfbdcRhAvG59NqDENNYbxKvK5HJfPG5M+Wi2AcpLVJrD6caiEOzgSoVNSgQK8fm2M3zGcF4xtClv/8Hs9oD7C3jitTATYNQxmKqKf1LhIxzf1bmfiNn7UKFmcJu4sLqVLwxGSue3taBEyknkw5hXTsUCvqmmL/f8n/w0giR7Hu/9EHvpkz3yuu64TioMkzdTJ30i0+hFnQqW1+v9mMwq+z9qGX0UFu9MomvVG2xod6vc12AAAAACq7sGa5qptFR0jF3nQt/D+7PibKYahaxP3hEixPbGi9nwNf2LAa7LkEZRKxzXeCD64Xpii5n+8Kpg8eHIv7AWXZltgMoGltmoJ0XGdOCL8WkzphvR9N2o3ARSZ42l5e5Pe4B58MCRlP3EKv+mcloknH+fto5BWsmEutW6KvjOVsznFCktkSczVk4aGvj9VXlRcLeDoKG8RkBgdcNG2bf8HUL4MT2DM+ar7NImJhKpxakX4Vk0CnP+/XNhl5UsP0lXgeZXPoDBMSW5An+DXlTCO5FQGwSPYwHLKYVIimEdAoVe49rQLaaNcye5LxU2/c5TijTgJtD5eQQIe1snxauj5jZsxJBUJdoP/zqpjqv8qBruoPsVsP8N44PCUW5Dd0DzqjSS/Dl5mI9cn1w2ndN/0KAEm1QAAAACwu6KM/083IBbH5bPa/9oHUwcU8I9v3j6/v18QYammrf+P6VL///8BrpuM3fOLCxaLNOFNF1zPbPYTP65ni6njft4eVcyrVXRQFrs52tr35StiSp55edVDCBC0H5rIfac6nzUwxQSt7y15QoKb+5zebEQUmVbrPjXuUa19Ey7sqXMiSUKHaw72PJKDdrutJoQr3u6lEYJ8K0MakWKj9zjTFi4X94TsKYco0GrLeB60M6D8M/80rhXUW8iMequg8y5F838WI0+gp3GBN5Kj/xIOxTWQuUaPV/LwvARr1VH93BFgGZR1MFW0Ua30GbYmdnAgo9VWy8SQtpDUgGE2r2zq2eTEMCL7sMKmE1hchVhuF/TCq9iXKEm86kzOf3Rp9ZnCxbpDUj+FKNxVyXe6pVZkRXv/m95SnB/EB8aME29N85MtAcDoXWlor8De2Q5Dg1tar+8wgiZufbMam81j//ASUohoR/zSh2KG4bvT6mkIPz6C5/98DC3LaWlaEZ1zA5JORZRu6J/a0GY285sEYzw71YqOT1ihAG0z5SDt1xNiDQWZdFpndArp6xWhqSDkRb4kSJEHb9liPvw7uLV/6i5MVf//A9Qjr8xkAEUh+KDI+zdtJ68d6MBOktg1iyp/SCq8O9f5pbamn1VVVQPRTWqNBvhQKa07s6P0lc9Luu/3gw4HeyOUfz8MxMwV4UQhua+t9cr4bz/nIB2wnDSK1K7I94M+s6C84htaX/CNlMQUSs2KJO+yaebfTbkNX5yWcqEJevo0vbKUiETuFXiL019A3E+lmsyZMwXrXLLiQAZ5t9+jI3JobhJTMiDH5ZOQ+8Jau5555NMjHSscP9qCVaa40doh+1a3Ukf6jqBmLddgh79/fwTfCyqiuldNkUoy+nUp+4nerwg0OjtGv2x485PJOJvUEokNhYIdWjpx7BWk0VZGWOp3jSFTJ2bnu6KCduZtG/UcBC9RZ3W/jMSfSMw4Etr/DoD/XYP2V5Ovw+YoM3F5g2dGLdvuG6ZkVGLE6Dk5Zr+sdSyGliJP1y2OFf/KFO0RWO+3gsGhesTnfZVpTd8/HwgO216gwaqo+vY3TljfJWowY+i0p0Os4SLn/1wLqDHMlszggmT/D8MRFzs+pLv6LNJSsNZ/r41mWi/rF6ZcKp/yzJdK0VU44hskq3RGpgO6mIpJDsf/mZkFrz0yYOMLbuaj/wp1v7JMFM5eqvBhmTd7U8frQAtHtys4zgpjZmzUhOVTfNNLifElGXADlqHGKrkBT/nYwX8ZRm3RjvyPvjKyEqEGKUpVnvOGx+NKPHiWM//ZDpDVGvvrjmk8RPF/wiYZD3+Us8YCXjrVOfjdd1UPAfjLp8jgSn4me7DPTpz1Ggy9XL80guFO7ECT10AvILKfD18Qx+KY/f8aRqu0oOO8hfKRFZa9PUJwCsp6VdZz6LFkm2b9Pl2LIifCwzRy7TpdG2uAtOxP2OemY26bJMa9ZGSLIRlMsgpDpnDJwd0oa5pQ13x1hrHf52HpulUWonGWsfXZbSQYKu9bnEN76ciQih0opN3deDVrbrxorfVlnCmL1R9zq3ePGWIv21c7pW8kEiFTM5JX8dAw867s/60cf79/BH+MDFCZBHlz1L+qGOJf/1txhhmrf3//As+RIJwevDb+fgNXVeHw67QptZegayhrEwr5Gy+EPo1RLaMtPbqOZYoVzXzwzjMFWZxyUG9YUIf6////AQWy84iAygLk9COtXt92+0mT/xg0zMzMBeLkb8y9SL2TDXgSX422hDgpGNLJyuPioA+YJ91G8znrpNqHkwYyscaJDEc9Vc+j4cXle3hvcd2JqDQH2lBZxDn6mUTs0b75raMvbs727codX01Anj8f3wir9P2xQaQ22v/TxCMglKDFoTjaP01XTLgxnTvPv02JgEUrW6UDgOnobFpLdvKdlypgIzPcq14fgXU5tvVW0FEs7VRlsG1IyA69fN4n+awHhT34cE+xUvdj86C8LgAsFheTjI9Ht9EyYAAAAAAVBVKRx2wLgUTI0/2QfyJo2riRw3JDqzEShmx/Lifo6mRkQVbS7X53t+EvKxcXogtdts31e9MRHdcHgsA8rt4/mt2unlzQ/wsU8Gu7+W6Oj7eD8EQdDp5XlCsVaS/AV/t5ZpPOHR3rGpyAJe9IPV+xMrBL1Oz/8MQhFs31h0N1cVnq371uqIJYHyafKH1jteAK3VpMXBcuC+yt0ZeKyRUY4QhdrJJ4tJ1wg3Hu6kDsbovxupTMkGdRrm8oZSoYPbJ+PwH/xotgTdkA1205vUEfnqkI04T/fnnd1fiZW5AwNcggd7fi4j5zasmcntZexIxqFZQMzMJpfndmI5jn17cgn5EV5t9XN0C///8Q9wlJpMGXdoiaMTG2sVyHQsn8mWRISCLNG777S0OuDRP2GlLcJ2UeOg7Fo8hTNPeJ//iTJhyqxhKRUntdXOihq2wfKfH///8B0GGrwT+fSOQRdctKxjjGCSS11d6BlQ9BDfE0J6Z25FaNTKGpFKNCMr2G/041KpWwBLVe1k08vncseQbKZdXi8x1t9XA45U/Wd43D9wAh3Tal0aiLVzGPusOZ1F+W3TWoqlX/A95+dNef11TsuGful+ctGssldk3fqpfqh+43XTxL42+leSHoF/dWHYGX6maqUEuLX7UB+r/6Llr4LKocbVIeu+hB9QTPfz9fCP8RyWmX4SmbhMFsNtCijV7lVcwejLKlvl0GfCndnWV7/39VBrtTRuUx92oke3GBgKkC5fdGK0YvNK+xenKaDmsHDjNFUM3NMz3ZiXXFuLgojosPVCDEl2W5BjX3Ms+j0GSqACHmh0+RPWyuNm/Qe8vFf9AW7N1uRaxWirrUytqEJnJ4/Flm8hSoiZ2NQBsS6w/yQlC4gCaFo8q4nyY6AFdo4hiwhBXzbNKKvZvktCjSCukRR/BbYVbNwZi2Yh3hGodEacLW8qijiWJODf0P2bhfaiPspPT4lYJBgi/KfcFwCfvyUIgkJOv///8CG/JEepRBLaMFE+2TgrqsJXOVOWHt6g/bFwVLLMVBsMR50dis/39/AlBX+/rMTJkUQrnlxpR2iu0Tp8tATkRYGmDIrcAiRP8PjoWIlb7/0ecTdSCE9Y58+a+n/FovJQTVF4F2jAxMZhTgrM/KVS5BQu6bVbkWY5HXnxRshks3urDdW4RkWp4M4TeLmFK5KF/uHkkiO5Kv96RioH984v/CSDBnG+BwlnU9B+o7Y+0X0Nob+0pLsStxjvPXMy2eCpzhOWV4XbObBHN4UE2sLQ/DIqXhOzxVf38GlTi6aG7EnePO7TRJm9yOfUUcqq1I2iQHrVDqn3TUNRi/lMw8KbMW/3/nqCz/Ef8PoW5Qxcz2yHR/f78EPB2Stbd+ZFmfNTUYILzsb9YNhpaHcaymYrBiNHmFE3Y4ccYJ25Prqm7zHobGHED8/93ZNlWro9vcKivGZs31UiK1k5zjUhexUgbqJb+fUTjxce/7Zly8a5KMC1fX5nfjPgibdvzbXV1jRT2asXvmSAusaLdq1TSIJ8fXINk5AtT34EWPAsfP9IFQqM5K11O6saoHJA==",sl=null,wB=()=>{if(!sl){let o=atob(_ae);sl=Uint8Array.from(o,e=>e.charCodeAt(0))}},LB=()=>(wB(),sl),Gm=class{constructor(e=0){this.seed=0,this.seed=e*4,wB()}_next(){this.seed=(this.seed+4)%sl.length}value(){return this._next(),sl[this.seed]/255}vec4(e=new W){return this._next(),e.set(sl[this.seed],sl[this.seed+1],sl[this.seed+2],sl[this.seed+3]).mulScalar(1/255)}}});var gae,Wy,bB=m(()=>{Q();J();gae=[new g(-1,0,0),new g(1,0,0),new g(0,-1,0),new g(0,1,0),new g(0,0,-1),new g(0,0,1)],Wy=class{update(e,t){let s=this.colors,{r:i,g:r,b:a}=e;for(let n=0;n<6;n++)s[n*3]=i,s[n*3+1]=r,s[n*3+2]=a;for(let n=0;n<t.length;n++){let l=t[n];if(l._type===ge)for(let h=0;h<6;h++){let c=Math.max(gae[h].dot(l._direction),0)*l._intensity,f=l._color;s[h*3]+=f.r*c,s[h*3+1]+=f.g*c,s[h*3+2]+=f.b*c}}}constructor(){this.colors=new Float32Array(18)}}});var Sae,Tae,MB,DB=m(()=>{Xy();j();bi();Fe();Sae=(o,e,t,s)=>{let i=new q(o,{name:`${e}${t}`,width:t,height:t,format:7,addressU:0,addressV:0,type:zt,magFilter:0,minFilter:0,anisotropy:1,mipmaps:!1});return i.lock().set(s),i.unlock(),i},Tae=new st,MB=o=>Tae.get(o,()=>{let e=LB(),t=Math.sqrt(e.length/4);return Sae(o,"BlueNoise",t,e)})});var uo,qS=m(()=>{j();Rt();Fe();J();uo=class o{constructor(e,t){this.texture=e,this.cached=!1,this.renderTargets=t}destroy(){this.texture&&(this.texture.destroy(),this.texture=null);let e=this.renderTargets;for(let t=0;t<e.length;t++)e[t].destroy();this.renderTargets.length=0}static create(e,t){let s=null;return t._type===Ge?s=this.createCubemap(e,t._shadowResolution,t._shadowType):s=this.create2dMap(e,t._shadowResolution,t._shadowType),s}static createAtlas(e,t,s){let i=this.create2dMap(e,t,s),r=i.renderTargets,a=r[0];for(let n=0;n<5;n++)r.push(a);return i}static create2dMap(e,t,s){let i=gi.get(s),r=i.format;r===15&&!e.textureFloatRenderable&&e.textureHalfFloatRenderable&&(r=50);let a=ei.get(r)?.name,n=1;s===bf&&(n=e.extTextureFloatLinear?1:0),s===Za&&(n=0);let l=new q(e,{format:r,width:t,height:t,mipmaps:!1,minFilter:n,magFilter:n,addressU:1,addressV:1,name:`ShadowMap2D_${a}`}),h=null;return i?.pcf?(l.compareOnRead=!0,l.compareFunc=1,h=new xe({depthBuffer:l})):h=new xe({colorBuffer:l,depth:!0}),e.isWebGPU&&(h.flipY=!0),new o(l,[h])}static createCubemap(e,t,s){let i=gi.get(s),r=ei.get(i.format)?.name,a=s===Za,n=a?0:1,l=new q(e,{format:i?.format,width:t,height:t,cubemap:!0,mipmaps:!1,minFilter:n,magFilter:n,addressU:1,addressV:1,name:`ShadowMapCube_${r}`});a||(l.compareOnRead=!0,l.compareFunc=1);let h=[];for(let c=0;c<6;c++)a?h.push(new xe({colorBuffer:l,face:c,depth:!0})):h.push(new xe({depthBuffer:l,face:c}));return new o(l,h)}}});var Eae,vae,il,wL,jS,Yy,OB=m(()=>{Ne();Ze();Rt();Fe();J();qS();Eae=[],vae=[],il=new W,wL=new W,jS=class{constructor(e){this.size=Math.floor(e.w*1024),this.used=!1,this.lightId=-1,this.rect=e}},Yy=class{constructor(e){this.device=e,this.version=1,this.shadowAtlasResolution=2048,this.shadowAtlas=null,this.shadowEdgePixels=3,this.cookieAtlasResolution=4,this.cookieAtlas=new q(this.device,{name:"CookieAtlas",width:this.cookieAtlasResolution,height:this.cookieAtlasResolution,format:20,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1}),this.cookieRenderTarget=new xe({colorBuffer:this.cookieAtlas,depth:!1,flipY:!0}),this.slots=[],this.atlasSplit=[],this.cubeSlotsOffsets=[new D(0,0),new D(0,1),new D(1,0),new D(1,1),new D(2,0),new D(2,1)],this.scissorVec=new W,this.allocateShadowAtlas(1),this.allocateCookieAtlas(1),this.allocateUniforms()}destroy(){this.destroyShadowAtlas(),this.destroyCookieAtlas()}destroyShadowAtlas(){this.shadowAtlas?.destroy(),this.shadowAtlas=null}destroyCookieAtlas(){this.cookieAtlas?.destroy(),this.cookieAtlas=null,this.cookieRenderTarget?.destroy(),this.cookieRenderTarget=null}allocateShadowAtlas(e,t=Hs){let s=this.shadowAtlas?.texture.format,i=gi.get(t).format;if(!this.shadowAtlas||this.shadowAtlas.texture.width!==e||s!==i){this.version++,this.destroyShadowAtlas(),this.shadowAtlas=uo.createAtlas(this.device,e,t),this.shadowAtlas.cached=!0;let r=4/this.shadowAtlasResolution;this.scissorVec.set(r,r,-2*r,-2*r)}}allocateCookieAtlas(e){this.cookieAtlas.width!==e&&(this.cookieRenderTarget.resize(e,e),this.version++)}allocateUniforms(){this._shadowAtlasTextureId=this.device.scope.resolve("shadowAtlasTexture"),this._shadowAtlasParamsId=this.device.scope.resolve("shadowAtlasParams"),this._shadowAtlasParams=new Float32Array(2),this._cookieAtlasTextureId=this.device.scope.resolve("cookieAtlasTexture")}updateUniforms(){let t=this.shadowAtlas.renderTargets[0].depthBuffer;this._shadowAtlasTextureId.setValue(t),this._shadowAtlasParams[0]=this.shadowAtlasResolution,this._shadowAtlasParams[1]=this.shadowEdgePixels,this._shadowAtlasParamsId.setValue(this._shadowAtlasParams),this._cookieAtlasTextureId.setValue(this.cookieAtlas)}subdivide(e,t){let s=t.atlasSplit;if(!s){let r=Math.ceil(Math.sqrt(e));s=vae,s[0]=r,s.length=1}if(!((r,a)=>r.length===a.length&&r.every((n,l)=>n===a[l]))(s,this.atlasSplit)){this.version++,this.slots.length=0,this.atlasSplit.length=0,this.atlasSplit.push(...s);let r=this.atlasSplit[0];if(r>1){let a=1/r;for(let n=0;n<r;n++)for(let l=0;l<r;l++){let h=new W(n*a,l*a,a,a),c=this.atlasSplit[1+n*r+l];if(c>1)for(let f=0;f<c;f++)for(let d=0;d<c;d++){let u=a/c,p=new W(h.x+f*u,h.y+d*u,u,u);this.slots.push(new jS(p))}else this.slots.push(new jS(h))}}else this.slots.push(new jS(new W(0,0,1,1)));this.slots.sort((a,n)=>n.size-a.size)}}collectLights(e,t){let s=t.cookiesEnabled,i=t.shadowsEnabled,r=!1,a=!1,n=Eae;return n.length=0,(s||i)&&(h=>{for(let c=0;c<h.length;c++){let f=h[c];if(f.visibleThisFrame){let d=i&&f.castShadows,u=s&&!!f.cookie;r||=d,a||=u,(d||u)&&n.push(f)}}})(e),n.sort((h,c)=>c.maxScreenSize-h.maxScreenSize),r&&this.allocateShadowAtlas(this.shadowAtlasResolution,t.shadowType),a&&this.allocateCookieAtlas(this.cookieAtlasResolution),(r||a)&&this.subdivide(n.length,t),n}setupSlot(e,t){e.atlasViewport.copy(t);let s=e.numShadowFaces;for(let i=0;i<s;i++)if(e.castShadows||e._cookie){if(il.copy(t),wL.copy(t),e._type===Ye&&il.add(this.scissorVec),e._type===Ge){let r=il.z/3,a=this.cubeSlotsOffsets[i];il.x+=r*a.x,il.y+=r*a.y,il.z=r,il.w=r,wL.copy(il)}if(e.castShadows){let r=e.getRenderData(null,i);r.shadowViewport.copy(il),r.shadowScissor.copy(wL)}}}assignSlot(e,t,s){e.atlasViewportAllocated=!0;let i=this.slots[t];i.lightId=e.id,i.used=!0,s&&(e.atlasSlotUpdated=!0,e.atlasVersion=this.version,e.atlasSlotIndex=t)}update(e,t){this.shadowAtlasResolution=t.shadowAtlasResolution,this.cookieAtlasResolution=t.cookieAtlasResolution;let s=this.collectLights(e,t);if(s.length>0){let i=this.slots;for(let n=0;n<i.length;n++)i[n].used=!1;let r=Math.min(s.length,i.length);for(let n=0;n<r;n++){let l=s[n];l.castShadows&&(l._shadowMap=this.shadowAtlas);let h=i[l.atlasSlotIndex];if(l.atlasVersion===this.version&&l.id===h?.lightId){let c=i[l.atlasSlotIndex];c.size===i[n].size&&!c.used&&this.assignSlot(l,l.atlasSlotIndex,!1)}}let a=0;for(let n=0;n<r;n++){for(;a<i.length&&i[a].used;)a++;let l=s[n];l.atlasViewportAllocated||this.assignSlot(l,a,!0);let h=i[l.atlasSlotIndex];this.setupSlot(l,h.rect)}}this.updateUniforms()}}});var nr,xae,Os,rl=m(()=>{j();qt();ii();J();Vh();It();nr=[];nr[xf]={src:1,dst:1,op:2};nr[$t]={src:1,dst:0,op:0};nr[es]={src:6,dst:8,op:0,alphaSrc:1};nr[er]={src:1,dst:8,op:0};nr[yf]={src:1,dst:1,op:0};nr[Pf]={src:6,dst:1,op:0};nr[Rf]={src:4,dst:2,op:0};nr[Cf]={src:5,dst:1,op:0};nr[Af]={src:4,dst:0,op:0};nr[If]={src:1,dst:1,op:3};nr[wf]={src:1,dst:1,op:4};xae=0,Os=class{constructor(){this.meshInstances=[],this.name="Untitled",this.userId="",this.id=xae++,this.variants=new Map,this.defines=new Map,this._definesDirty=!1,this.parameters={},this.alphaTest=0,this.alphaToCoverage=!1,this._blendState=new Ie,this._depthState=new $e,this.cull=1,this.stencilFront=null,this.stencilBack=null,this._shaderChunks=null,this._oldChunks={},this._dirtyShader=!0,this._shaderVersion=0,this._scene=null,this.dirty=!0}get hasShaderChunks(){return this._shaderChunks!=null}get shaderChunks(){return this._shaderChunks||(this._shaderChunks=new ie),this._shaderChunks}getShaderChunks(e=oe){let t=this.shaderChunks;return e===oe?t.glsl:t.wgsl}set shaderChunksVersion(e){this.shaderChunks.version=e}get shaderChunksVersion(){return this.shaderChunks.version}set chunks(e){this._oldChunks=e}get chunks(){return Object.assign(this._oldChunks,Object.fromEntries(this.shaderChunks.glsl)),this._oldChunks}set depthBias(e){this._depthState.depthBias=e}get depthBias(){return this._depthState.depthBias}set slopeDepthBias(e){this._depthState.depthBiasSlope=e}get slopeDepthBias(){return this._depthState.depthBiasSlope}set redWrite(e){this._blendState.redWrite=e}get redWrite(){return this._blendState.redWrite}set greenWrite(e){this._blendState.greenWrite=e}get greenWrite(){return this._blendState.greenWrite}set blueWrite(e){this._blendState.blueWrite=e}get blueWrite(){return this._blendState.blueWrite}set alphaWrite(e){this._blendState.alphaWrite=e}get alphaWrite(){return this._blendState.alphaWrite}get transparent(){return this._blendState.blend}_updateTransparency(){let e=this.transparent,t=this.meshInstances;for(let s=0;s<t.length;s++)t[s].transparent=e}set blendState(e){this._blendState.copy(e),this._updateTransparency()}get blendState(){return this._blendState}set blendType(e){let t=nr[e];this._blendState.setColorBlend(t.op,t.src,t.dst),this._blendState.setAlphaBlend(t.alphaOp??t.op,t.alphaSrc??t.src,t.alphaDst??t.dst);let s=e!==$t;this._blendState.blend!==s&&(this._blendState.blend=s,this._updateTransparency()),this._updateMeshInstanceKeys()}get blendType(){if(!this.transparent)return $t;let{colorOp:e,colorSrcFactor:t,colorDstFactor:s,alphaOp:i,alphaSrcFactor:r,alphaDstFactor:a}=this._blendState;for(let n=0;n<nr.length;n++){let l=nr[n];if(l.src===t&&l.dst===s&&l.op===e&&l.src===r&&l.dst===a&&l.op===i)return n}return es}set depthState(e){this._depthState.copy(e)}get depthState(){return this._depthState}set depthTest(e){this._depthState.test=e}get depthTest(){return this._depthState.test}set depthFunc(e){this._depthState.func=e}get depthFunc(){return this._depthState.func}set depthWrite(e){this._depthState.write=e}get depthWrite(){return this._depthState.write}copy(e){this.name=e.name,this.alphaTest=e.alphaTest,this.alphaToCoverage=e.alphaToCoverage,this._blendState.copy(e._blendState),this._depthState.copy(e._depthState),this.cull=e.cull,this.stencilFront=e.stencilFront?.clone(),e.stencilBack&&(this.stencilBack=e.stencilFront===e.stencilBack?this.stencilFront:e.stencilBack.clone()),this.clearParameters();for(let t in e.parameters)e.parameters.hasOwnProperty(t)&&this._setParameterSimple(t,e.parameters[t].data);return this.defines.clear(),e.defines.forEach((t,s)=>this.defines.set(s,t)),this._shaderChunks=e.hasShaderChunks?new ie:null,this._shaderChunks?.copy(e._shaderChunks),this}clone(){return new this.constructor().copy(this)}_updateMeshInstanceKeys(){let e=this.meshInstances;for(let t=0;t<e.length;t++)e[t].updateKey()}updateUniforms(e,t){this._dirtyShader&&this.clearVariants()}getShaderVariant(e){}update(){if(Object.keys(this._oldChunks).length>0)for(let[e,t]of Object.entries(this._oldChunks))this.shaderChunks.glsl.set(e,t),delete this._oldChunks[e];(this._definesDirty||this._shaderChunks?.isDirty())&&(this._definesDirty=!1,this._shaderChunks?.resetDirty(),this.clearVariants()),this.dirty=!0}clearParameters(){this.parameters={}}getParameters(){return this.parameters}clearVariants(){this.variants.clear();let e=this.meshInstances,t=e.length;for(let s=0;s<t;s++)e[s].clearShaders()}getParameter(e){return this.parameters[e]}_setParameterSimple(e,t){let s=this.parameters[e];s?s.data=t:this.parameters[e]={scopeId:null,data:t}}setParameter(e,t){if(t===void 0&&typeof e=="object"){let s=e;if(s.length){for(let i=0;i<s.length;i++)this.setParameter(s[i]);return}e=s.name,t=s.value}this._setParameterSimple(e,t)}deleteParameter(e){this.parameters[e]&&delete this.parameters[e]}setParameters(e,t){let s=this.parameters;t===void 0&&(t=s);for(let i in t){let r=s[i];r&&(r.scopeId||(r.scopeId=e.scope.resolve(i)),r.scopeId.setValue(r.data))}}setDefine(e,t){let s=!1,{defines:i}=this;t!==void 0&&t!==!1?(s=!i.has(e)||i.get(e)!==t,i.set(e,t)):(s=i.has(e),i.delete(e)),this._definesDirty||=s}getDefine(e){return this.defines.has(e)}destroy(){this.variants.clear();for(let e=0;e<this.meshInstances.length;e++){let t=this.meshInstances[e];if(t.clearShaders(),t._material=null,t.mesh){let s=va(t.mesh.device);this!==s&&(t.material=s)}}this.meshInstances.length=0}addMeshInstanceRef(e){this.meshInstances.push(e)}removeMeshInstanceRef(e){let t=this.meshInstances,s=t.indexOf(e);s!==-1&&t.splice(s,1)}}});var Ky,NB=m(()=>{J();qS();Ky=class{constructor(){this.cache=new Map}destroy(){this.clear(),this.cache=null}clear(){this.cache.forEach(e=>{e.forEach(t=>{t.destroy()})}),this.cache.clear()}getKey(e){let t=e._type===Ge,s=e._shadowType,i=e._shadowResolution;return`${t}-${s}-${i}`}get(e,t){let s=this.getKey(t),i=this.cache.get(s);if(i&&i.length)return i.pop();let r=uo.create(e,t);return r.cached=!0,r}add(e,t){let s=this.getKey(e),i=this.cache.get(s);i?i.push(t):this.cache.set(s,[t])}}});var qy,FB=m(()=>{us();qy=class extends Xe{constructor(e,t,s,i,r){super(e),this.requiresCubemaps=!1,this.shadowRenderer=t,this.light=s,this.face=i,this.applyVsm=r,this.shadowCamera=t.prepareFace(s,null,i),t.setupRenderPass(this,this.shadowCamera,!0)}execute(){this.shadowRenderer.renderFace(this.light,null,this.face,!1)}after(){this.applyVsm&&this.shadowRenderer.renderVsm(this.light,this.shadowCamera)}}});var jy,UB=m(()=>{me();J();qS();FB();jy=class{constructor(e,t){this.shadowLights=[],this.renderer=e,this.shadowRenderer=t,this.device=e.device}cull(e,t,s=null){let i=this.renderer.scene.clusteredLightingEnabled;e.visibleThisFrame=!0,i||e._shadowMap||(e._shadowMap=uo.create(this.device,e));let r=e._type,a=r===Ye?1:6;for(let n=0;n<a;n++){let l=e.getRenderData(null,n),h=l.shadowCamera;h.nearClip=e.attenuationEnd/1e3,h.farClip=e.attenuationEnd;let c=h._node,f=e._node;if(c.setPosition(f.getPosition()),r===Ye)h.fov=e._outerConeAngle*2,c.setRotation(f.getRotation()),c.rotateLocal(-90,0,0);else if(r===Ge)if(i){let p=2/(this.shadowRenderer.lightTextureAtlas.shadowAtlasResolution*e.atlasViewport.z/3)*this.shadowRenderer.lightTextureAtlas.shadowEdgePixels;h.fov=Math.atan(1+p)*w.RAD_TO_DEG*2}else h.fov=90;this.renderer.updateCameraFrustum(h),this.shadowRenderer.cullShadowCasters(t,e,l.visibleCasters,h,s)}}prepareLights(e,t){let s;for(let i=0;i<t.length;i++){let r=t[i];if(this.shadowRenderer.needsShadowRendering(r)&&r.atlasViewportAllocated){e.push(r);for(let a=0;a<r.numShadowFaces;a++)s=this.shadowRenderer.prepareFace(r,null,a)}}return s}buildNonClusteredRenderPasses(e,t){for(let s=0;s<t.length;s++){let i=t[s];if(this.shadowRenderer.needsShadowRendering(i)){let r=i._type===Ye,a=i.numShadowFaces;for(let n=0;n<a;n++){let l=new qy(this.device,this.shadowRenderer,i,n,r);e.addRenderPass(l)}}}}}});var $y,BB=m(()=>{us();J();$y=class extends Xe{constructor(e,t,s,i,r){super(e),this.shadowRenderer=t,this.light=s,this.camera=i,this.allCascadesRendering=r}execute(){let{light:e,camera:t,shadowRenderer:s,allCascadesRendering:i}=this,r=e.numShadowFaces,a=e.shadowUpdateOverrides;for(let n=0;n<r;n++)a?.[n]!==Ms&&s.renderFace(e,t,n,!i),a?.[n]===Di&&(a[n]=Ms)}after(){this.shadowRenderer.renderVsm(this.light,this.camera)}}});function yae(o,e,t){yt[0].x=yt[1].x=yt[2].x=yt[3].x=e.x,yt[1].y=yt[3].y=yt[7].y=yt[5].y=e.y,yt[2].z=yt[3].z=yt[6].z=yt[7].z=e.z,yt[4].x=yt[5].x=yt[6].x=yt[7].x=t.x,yt[0].y=yt[2].y=yt[4].y=yt[6].y=t.y,yt[0].z=yt[1].z=yt[4].z=yt[5].z=t.z;let s=9999999999,i=-9999999999;for(let r=0;r<8;++r){o.transformPoint(yt[r],yt[r]);let a=yt[r].z;a<s&&(s=a),a>i&&(i=a)}return LL.min=s,LL.max=i,LL}var Zy,al,VB,yt,LL,Qy,kB=m(()=>{me();Q();Ke();Vt();J();qS();BB();Zy=new _e,al=new g,VB=new k,yt=[new g,new g,new g,new g,new g,new g,new g,new g],LL={min:0,max:0};Qy=class{constructor(e,t){this.renderer=e,this.shadowRenderer=t,this.device=e.device}cull(e,t,s,i=null){e.visibleThisFrame=!0,e._shadowMap||(e._shadowMap=uo.create(this.device,e));let r=s._nearClip;this.generateSplitDistances(e,r,Math.min(s._farClip,e.shadowDistance));let a=e.shadowUpdateOverrides;for(let n=0;n<e.numCascades&&a?.[n]!==Ms;n++){let l=e.getRenderData(s,n),h=l.shadowCamera;h.renderTarget=e._shadowMap.renderTargets[0],l.shadowViewport.copy(e.cascades[n]),l.shadowScissor.copy(e.cascades[n]);let c=h._node,f=e._node;c.setPosition(f.getPosition()),c.setRotation(f.getRotation()),c.rotateLocal(-90,0,0);let d=n===0?r:e._shadowCascadeDistances[n-1],u=e._shadowCascadeDistances[n],p=s.getFrustumCorners(d,u);al.set(0,0,0);let _=s.node.getWorldTransform();for(let X=0;X<8;X++)_.transformPoint(p[X],p[X]),al.add(p[X]);al.mulScalar(1/8);let S=0;for(let X=0;X<8;X++){let I=p[X].sub(al).length();I>S&&(S=I)}let T=c.right,x=c.up,A=c.forward,E=.25*e._shadowResolution/S,v=Math.ceil(al.dot(x)*E)/E,R=Math.ceil(al.dot(T)*E)/E,P=x.mulScalar(v),y=T.mulScalar(R),C=al.dot(A),L=A.mulScalar(C);al.add2(P,y).add(L),c.setPosition(al),c.translateLocal(0,0,1e6),h.nearClip=.01,h.farClip=2e6,h.orthoHeight=S,this.renderer.updateCameraFrustum(h),this.shadowRenderer.cullShadowCasters(t,e,l.visibleCasters,h,i);let O=1<<n,M=l.visibleCasters,U=M.length,G=0;for(let X=0;X<U;X++){let I=M[X];I.shadowCascadeMask&O&&(M[G++]=I,G===1?Zy.copy(I.aabb):Zy.add(I.aabb))}U!==G&&(M.length=G),VB.copy(c.getWorldTransform()).invert();let $=yae(VB,Zy.getMin(),Zy.getMax());c.translateLocal(0,0,$.max+.1),h.farClip=$.max-$.min+.2,l.projectionCompensation=S}}generateSplitDistances(e,t,s){e._shadowCascadeDistances.fill(s);for(let i=1;i<e.numCascades;i++){let r=i/e.numCascades,a=t+(s-t)*r,n=t*(s/t)**r,l=w.lerp(a,n,e.cascadeDistribution);e._shadowCascadeDistances[i-1]=l}}getLightRenderPass(e,t){let s=null;if(this.shadowRenderer.needsShadowRendering(e)){let i=e.numShadowFaces,r=e.shadowUpdateOverrides,a=!0,n;for(let l=0;l<i;l++)r?.[l]===Ms&&(a=!1),n=this.shadowRenderer.prepareFace(e,t,l);s=new $y(this.device,this.shadowRenderer,e,t,a),this.shadowRenderer.setupRenderPass(s,n,a)}return s}}});function Aae(o,e){return Math.exp(-(o*o)/(2*e*e))}function Pae(o){let e=(o-1)/6,t=(o-1)*.5,s=new Array(o),i=0;for(let r=0;r<o;++r)s[r]=Aae(r-t,e),i+=s[r];for(let r=0;r<o;++r)s[r]/=i;return s}var bL,GB,zB,qf,$S,HB,zm,ML=m(()=>{De();Ke();Q();Ze();j();Ea();J();el();Dt();KS();Tf();mh();qt();bL=new Set,GB=new k,zB=new k,qf=new Float32Array(2),$S=new W(1,1,0,0),HB=new k;zm=class{constructor(e,t){this.shadowPassCache=[],this.device=e.device,this.renderer=e,this.lightTextureAtlas=t;let s=this.device.scope;this.sourceId=s.resolve("source"),this.pixelOffsetId=s.resolve("pixelOffset"),this.weightId=s.resolve("weight[0]"),this.blurVsmShader=[{},{}],this.blurVsmWeights={},this.shadowMapLightRadiusId=s.resolve("light_radius"),this.viewUniformFormat=null,this.viewBindGroupFormat=null,this.blendStateWrite=new Ie,this.blendStateNoWrite=new Ie,this.blendStateNoWrite.setColorWrite(!1,!1,!1,!1)}static createShadowCamera(e,t,s){let i=fo.create("ShadowCamera",t,s),r=gi.get(e),a=r?.vsm??!1,n=r?.pcf??!1;return a?i.clearColor=new N(0,0,0,0):i.clearColor=new N(1,1,1,1),i.clearDepthBuffer=!0,i.clearStencilBuffer=!1,i.clearColorBuffer=!n,i}_cullShadowCastersInternal(e,t,s){let i=e.length;for(let r=0;r<i;r++){let a=e[r];a.castShadow&&(!a.cull||a._isVisible(s))&&(a.visibleThisFrame=!0,t.push(a))}}cullShadowCasters(e,t,s,i,r){if(this.renderer.scene?.fire(Mm,i),s.length=0,r)this._cullShadowCastersInternal(r,s,i);else{let a=e.layerList,n=a.length;for(let l=0;l<n;l++){let h=a[l];h._lightsSet.has(t)&&(bL.has(h)||(bL.add(h),this._cullShadowCastersInternal(h.shadowCasters,s,i)))}bL.clear()}s.sort(this.sortCompareShader),this.renderer.scene?.fire(Dm,i)}sortCompareShader(e,t){let s=e._sortKeyShadow,i=t._sortKeyShadow;return s===i?t.mesh.id-e.mesh.id:i-s}setupRenderState(e,t){let i=this.renderer.scene.clusteredLightingEnabled?t._isPcf:t._isPcf&&t._type!==Ge;e.setBlendState(i?this.blendStateNoWrite:this.blendStateWrite),e.setDepthState(t.shadowDepthState),e.setStencilState(null,null)}dispatchUniforms(e,t,s,i){let r=t._node;e._type!==ge&&(this.renderer.dispatchViewPos(r.getPosition()),this.shadowMapLightRadiusId.setValue(e.attenuationEnd)),GB.setTRS(r.getPosition(),r.getRotation(),g.ONE).invert(),zB.mul2(t.projectionMatrix,GB);let a=s.shadowViewport;t.rect=a,t.scissorRect=s.shadowScissor,HB.setViewport(a.x,a.y,a.z,a.w),s.shadowMatrix.mul2(HB,zB),e._type===ge&&e._shadowMatrixPalette.set(s.shadowMatrix.data,i*16)}getShadowPass(e){let t=e._type,s=e._shadowType,i=this.shadowPassCache[t]?.[s];if(!i){let r=`ShadowPass_${t}_${s}`;i=Ds.get(this.device).allocate(r,{isShadow:!0,lightType:t,shadowType:s}),this.shadowPassCache[t]||(this.shadowPassCache[t]=[]),this.shadowPassCache[t][s]=i}return i.index}submitCasters(e,t,s){let i=this.device,r=this.renderer,a=r.scene,n=1<<bm,l=this.getShadowPass(t),h=s.shaderParams,c=s.renderTarget.flipY?-1:1,f=e.length;for(let d=0;d<f;d++){let u=e[d],p=u.mesh,_=u.instancingData;if(_&&_.count<=0)continue;u.ensureMaterial(i);let S=u.material;r.setBaseConstants(i,S),r.setSkinning(i,u),S.dirty&&(S.updateUniforms(i,a),S.dirty=!1),r.setupCullMode(!0,c,u),S.setParameters(i),u.setParameters(i,n);let T=u.getShaderInstance(l,0,a,h,this.viewUniformFormat,this.viewBindGroupFormat),x=T.shader;if(x.failed)continue;u._sortKeyShadow=x.id,i.setShader(x),r.setVertexBuffers(i,p),r.setMorphing(i,u.morphInstance),_&&i.setVertexBuffer(_.vertexBuffer),r.setMeshInstanceMatrices(u),r.setupMeshUniformBuffers(T);let A=u.renderStyle,E=u.indirectData?.get(s);i.draw(p.primitive[A],p.indexBuffer[A],_?.count,E),r._shadowDrawCalls++,_&&r._instancedDrawCalls++}}needsShadowRendering(e){let t=e.enabled&&e.castShadows&&e.shadowUpdateMode!==Ms&&e.visibleThisFrame;return e.shadowUpdateMode===Di&&(e.shadowUpdateMode=Ms),t&&(this.renderer._shadowMapUpdates+=e.numShadowFaces),t}getLightRenderData(e,t,s){return e.getRenderData(e._type===ge?t:null,s)}setupRenderPass(e,t,s){let i=t.renderTarget;e.init(i),e.depthStencilOps.clearDepthValue=1,e.depthStencilOps.clearDepth=s,i.depthBuffer?e.depthStencilOps.storeDepth=!0:(e.colorOps.clearValue.copy(t.clearColor),e.colorOps.clear=s,e.depthStencilOps.storeDepth=!1),e.requiresCubemaps=!1}prepareFace(e,t,s){let i=e._type,a=this.getLightRenderData(e,t,s).shadowCamera,n=i===ge?0:s;return a.renderTarget=e._shadowMap.renderTargets[n],a}renderFace(e,t,s,i,r=!0){let a=this.device,n=this.getLightRenderData(e,t,s),l=n.shadowCamera;this.dispatchUniforms(e,l,n,s);let h=l.renderTarget,c=this.renderer;c.setCameraUniforms(l,h),a.supportsUniformBuffers&&c.setupViewUniformBuffers(n.viewBindGroups,this.viewUniformFormat,this.viewBindGroupFormat,null),r?(c.setupViewport(l,h),i&&c.clear(l)):c.clearView(l,h,!0,!1),this.setupRenderState(a,e),this.submitCasters(n.visibleCasters,e,l)}render(e,t,s=!0){if(this.needsShadowRendering(e)){let i=e.numShadowFaces;for(let r=0;r<i;r++)this.prepareFace(e,t,r),this.renderFace(e,t,r,!0,s);this.renderVsm(e,t)}}renderVsm(e,t){e._isVsm&&e._vsmBlurSize>1&&(!this.renderer.scene.clusteredLightingEnabled||e._type===ge)&&this.applyVsmBlur(e,t)}getVsmBlurShader(e,t){let s=this.blurVsmShader,i=s[e][t];if(!i){this.blurVsmWeights[t]=Pae(t);let r=new Map;r.set("{SAMPLES}",t),e===1&&r.set("GAUSS",""),i=Te.createShader(this.device,{uniqueName:`blurVsm${e}${t}`,attributes:{vertex_position:te},vertexChunk:"fullscreenQuadVS",fragmentChunk:"blurVSMPS",fragmentDefines:r}),s[e][t]=i}return i}applyVsmBlur(e,t){let s=this.device;s.setBlendState(Ie.NOBLEND);let a=e.getRenderData(e._type===ge?t:null,0).shadowCamera.renderTarget,n=this.renderer.shadowMapCache.get(s,e),l=n.renderTargets[0],h=e.vsmBlurMode,c=e._vsmBlurSize,f=this.getVsmBlurShader(h,c);$S.z=e._shadowResolution-2,$S.w=$S.z,this.sourceId.setValue(a.colorBuffer),qf[0]=1/e._shadowResolution,qf[1]=0,this.pixelOffsetId.setValue(qf),h===yh&&this.weightId.setValue(this.blurVsmWeights[c]),Ot(s,l,f,null,$S),this.sourceId.setValue(l.colorBuffer),qf[1]=qf[0],qf[0]=0,this.pixelOffsetId.setValue(qf),Ot(s,a,f,null,$S),this.renderer.shadowMapCache.add(e,n)}initViewBindGroupFormat(){this.device.supportsUniformBuffers&&!this.viewUniformFormat&&(this.viewUniformFormat=new Zi(this.device,[new qe("matrix_viewProjection",pi)]),this.viewBindGroupFormat=new _i(this.device,[new Wa(jn,wi|Li)]))}frameUpdate(){this.initViewBindGroupFormat()}}});var Jy,eA,XB=m(()=>{Hy();Jy=[],eA=class{constructor(e){this._empty=null,this._allocated=[],this._clusters=new Map,this.device=e}destroy(){this._empty&&(this._empty.destroy(),this._empty=null),this._allocated.forEach(e=>{e.destroy()}),this._allocated.length=0}get count(){return this._allocated.length}get empty(){if(!this._empty){let e=new tl(this.device);e.name="ClusterEmpty",e.update([]),this._empty=e}return this._empty}assign(e){let t=this.empty;Jy.push(...this._allocated),this._allocated.length=0,this._clusters.clear();let s=e.length;for(let i=0;i<s;i++){let a=e[i].renderActions;if(a){let n=a.length;for(let l=0;l<n;l++){let h=a[l];h.lightClusters=null;let c=h.layer;if(c.hasClusteredLights&&c.meshInstances.length){let f=c.getLightIdHash(),u=this._clusters.get(f)?.lightClusters;u||(u=Jy.pop()??new tl(this.device),this._allocated.push(u),this._clusters.set(f,h)),h.lightClusters=u}h.lightClusters||(h.lightClusters=t)}}}Jy.forEach(i=>i.destroy()),Jy.length=0}update(e,t){this.assign(e),this._clusters.forEach(s=>{let i=s.layer;s.lightClusters.update(i.clusteredLightsSet,t)})}}});var Gh,DL,tA,WB=m(()=>{Ze();Ke();j();J();Dt();KS();qt();zf();ii();us();Gh=new W,DL=[],tA=class o extends Xe{constructor(e,t){super(e),this._quadRenderer2D=null,this._quadRendererCube=null,this._filteredLights=[],this._forceCopy=!1,this._evtDeviceRestored=null,this._cubeSlotsOffsets=t,this.requiresCubemaps=!1,this.blitTextureId=e.scope.resolve("blitTexture"),this.invViewProjId=e.scope.resolve("invViewProj"),this._evtDeviceRestored=e.on("devicerestored",this.onDeviceRestored,this)}destroy(){this._quadRenderer2D?.destroy(),this._quadRenderer2D=null,this._quadRendererCube?.destroy(),this._quadRendererCube=null,this._evtDeviceRestored?.off(),this._evtDeviceRestored=null}static create(e,t){let s=new o(e.device,t);return s.init(e),s.colorOps.clear=!1,s.depthStencilOps.clearDepth=!1,s}onDeviceRestored(){this._forceCopy=!0}update(e){let t=this._filteredLights;this.filter(e,t),this.executeEnabled=t.length>0}filter(e,t){for(let s=0;s<e.length;s++){let i=e[s];i._type!==ge&&i.atlasViewportAllocated&&(!i.atlasSlotUpdated&&!this._forceCopy||i.enabled&&i.cookie&&i.visibleThisFrame&&t.push(i))}this._forceCopy=!1}initInvViewProjMatrices(){if(!DL.length)for(let e=0;e<6;e++){let t=fo.create(null,Ge,e),s=t.projectionMatrix,i=t.node.getLocalTransform().clone().invert();DL[e]=new k().mul2(s,i).invert()}}get quadRenderer2D(){if(!this._quadRenderer2D){let e=Te.createShader(this.device,{uniqueName:"cookieRenderer2d",attributes:{vertex_position:te},vertexChunk:"cookieBlitVS",fragmentChunk:"cookieBlit2DPS"});this._quadRenderer2D=new Oi(e)}return this._quadRenderer2D}get quadRendererCube(){if(!this._quadRendererCube){let e=Te.createShader(this.device,{uniqueName:"cookieRendererCube",attributes:{vertex_position:te},vertexChunk:"cookieBlitVS",fragmentChunk:"cookieBlitCubePS"});this._quadRendererCube=new Oi(e)}return this._quadRendererCube}execute(){let e=this.device;e.setBlendState(Ie.NOBLEND),e.setCullMode(0),e.setDepthState($e.NODEPTH),e.setStencilState();let t=this.renderTarget.colorBuffer.width,s=this._cubeSlotsOffsets,i=this._filteredLights;for(let r=0;r<i.length;r++){let a=i[r],n=a.numShadowFaces,l=n>1?this.quadRendererCube:this.quadRenderer2D;n>1&&this.initInvViewProjMatrices(),this.blitTextureId.setValue(a.cookie);for(let h=0;h<n;h++){if(Gh.copy(a.atlasViewport),n>1){let c=Gh.z/3,f=s[h];Gh.x+=c*f.x,Gh.y+=c*f.y,Gh.z=c,Gh.w=c,this.invViewProjId.setValue(DL[h].data)}Gh.mulScalar(t),l.render(Gh)}}i.length=0}}});var sA,YB=m(()=>{us();sA=class extends Xe{constructor(e,t,s){super(e),this.requiresCubemaps=!1,this.shadowRenderer=t,this.shadowRendererLocal=s}update(e){let t=this.shadowRendererLocal.shadowLights,s=this.shadowRendererLocal.prepareLights(t,e),i=t.length;this.enabled=i>0,i&&this.shadowRenderer.setupRenderPass(this,s,!1)}execute(){let e=this.shadowRendererLocal.shadowLights,t=e.length;for(let s=0;s<t;s++){let i=e[s];for(let r=0;r<i.numShadowFaces;r++)this.shadowRenderer.renderFace(i,null,r,!0)}e.length=0}}});var iA,KB=m(()=>{us();WB();YB();iA=class extends Xe{constructor(e,t,s,i,r){super(e),this.renderer=t,this.frameGraph=null,this.cookiesRenderPass=tA.create(r.cookieRenderTarget,r.cubeSlotsOffsets),this.beforePasses.push(this.cookiesRenderPass),this.shadowRenderPass=new sA(e,s,i),this.beforePasses.push(this.shadowRenderPass)}update(e,t,s,i,r){this.frameGraph=e,this.cookiesRenderPass.enabled=s,s&&this.cookiesRenderPass.update(i),this.shadowRenderPass.enabled=t,t&&this.shadowRenderPass.update(r)}destroy(){this.cookiesRenderPass.destroy(),this.cookiesRenderPass=null}execute(){let{renderer:e}=this,{scene:t}=e;e.worldClustersAllocator.update(this.frameGraph.renderPasses,t.lighting)}}});var OL,zh,Hh,Hm,qB,NL,jB,FL,UL,BL,$B,ZB,Rae,Cae,Iae,wae,Lae,bae,Xm,VL,kL,rA,QB=m(()=>{Xy();Ne();Q();Ze();Zl();Ke();fu();j();am();_h();Tf();mh();J();bB();DB();OB();rl();NB();UB();kB();ML();XB();KB();OL=0,zh=new k,Hh=new k,Hm=new k,qB=new Vs,NL=new Hr,jB=new k().setScale(1,-1,1),FL=new Set,UL=new Set,BL=new ph,$B=new k().set([1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1]),ZB=[new D(.5,.333333),new D(.25,.666667),new D(.75,.111111),new D(.125,.444444),new D(.625,.777778),new D(.375,.222222),new D(.875,.555556),new D(.0625,.888889),new D(.5625,.037037),new D(.3125,.37037),new D(.8125,.703704),new D(.1875,.148148),new D(.6875,.481481),new D(.4375,.814815),new D(.9375,.259259),new D(.03125,.592593)],Rae=new k,Cae=new k,Iae=new k,wae=new k,Lae=new k,bae=new k,Xm=new Set,VL=[],kL=[],rA=class{constructor(e){this.clustersDebugRendered=!1,this.processingMeshInstances=new Set,this.lights=[],this.localLights=[],this.cameraDirShadowLights=new Map,this.dirLightShadows=new Map,this.blueNoise=new Gm(123),this.device=e,this.scene=null,this.worldClustersAllocator=new eA(e),this.lightTextureAtlas=new Yy(e),this.shadowMapCache=new Ky,this.shadowRenderer=new zm(this,this.lightTextureAtlas),this._shadowRendererLocal=new jy(this,this.shadowRenderer),this._shadowRendererDirectional=new Qy(this,this.shadowRenderer),this._renderPassUpdateClustered=new iA(this.device,this,this.shadowRenderer,this._shadowRendererLocal,this.lightTextureAtlas),this.viewUniformFormat=null,this.viewBindGroupFormat=null,this._skinTime=0,this._morphTime=0,this._cullTime=0,this._shadowMapTime=0,this._lightClustersTime=0,this._layerCompositionUpdateTime=0,this._shadowDrawCalls=0,this._skinDrawCalls=0,this._instancedDrawCalls=0,this._shadowMapUpdates=0,this._numDrawCallsCulled=0,this._camerasRendered=0,this._lightClusters=0;let t=e.scope;this.boneTextureId=t.resolve("texture_poseMap"),this.modelMatrixId=t.resolve("matrix_model"),this.normalMatrixId=t.resolve("matrix_normal"),this.viewInvId=t.resolve("matrix_viewInverse"),this.viewPos=new Float32Array(3),this.viewPosId=t.resolve("view_position"),this.projId=t.resolve("matrix_projection"),this.projSkyboxId=t.resolve("matrix_projectionSkybox"),this.viewId=t.resolve("matrix_view"),this.viewId3=t.resolve("matrix_view3"),this.viewProjId=t.resolve("matrix_viewProjection"),this.flipYId=t.resolve("projectionFlipY"),this.tbnBasis=t.resolve("tbnBasis"),this.nearClipId=t.resolve("camera_near"),this.farClipId=t.resolve("camera_far"),this.cameraParams=new Float32Array(4),this.cameraParamsId=t.resolve("camera_params"),this.viewIndexId=t.resolve("view_index"),this.viewIndexId.setValue(0),this.blueNoiseJitterVersion=0,this.blueNoiseJitterVec=new W,this.blueNoiseJitterData=new Float32Array(4),this.blueNoiseJitterId=t.resolve("blueNoiseJitter"),this.blueNoiseTextureId=t.resolve("blueNoiseTex32"),this.alphaTestId=t.resolve("alpha_ref"),this.opacityMapId=t.resolve("texture_opacityMap"),this.exposureId=t.resolve("exposure"),this.twoSidedLightingNegScaleFactorId=t.resolve("twoSidedLightingNegScaleFactor"),this.twoSidedLightingNegScaleFactorId.setValue(0),this.morphPositionTex=t.resolve("morphPositionTex"),this.morphNormalTex=t.resolve("morphNormalTex"),this.morphTexParams=t.resolve("morph_tex_params"),this.lightCube=new Wy,this.constantLightCube=t.resolve("lightCube[0]")}destroy(){this.shadowRenderer=null,this._shadowRendererLocal=null,this._shadowRendererDirectional=null,this.shadowMapCache.destroy(),this.shadowMapCache=null,this._renderPassUpdateClustered.destroy(),this._renderPassUpdateClustered=null,this.lightTextureAtlas.destroy(),this.lightTextureAtlas=null}setupViewport(e,t){let s=this.device,i=t?t.width:s.width,r=t?t.height:s.height,a=e.rect,n=Math.floor(a.x*i),l=Math.floor(a.y*r),h=Math.floor(a.z*i),c=Math.floor(a.w*r);if(s.setViewport(n,l,h,c),e._scissorRectClear){let f=e.scissorRect;n=Math.floor(f.x*i),l=Math.floor(f.y*r),h=Math.floor(f.z*i),c=Math.floor(f.w*r)}s.setScissor(n,l,h,c)}setCameraUniforms(e,t){let s=t?.flipY,i=null;if(e.xr&&e.xr.session){let n=e._node?.parent?.getWorldTransform()||null;i=e.xr.views.list;for(let h=0;h<i.length;h++){let c=i[h];c.updateTransforms(n),e.frustum.setFromMat4(c.projViewOffMat)}}else{let n=e.projectionMatrix;e.calculateProjection&&e.calculateProjection(n,kf);let l=e.getProjectionMatrixSkybox();s&&(n=Rae.mul2(jB,n),l=Cae.mul2(jB,l)),this.device.isWebGPU&&(n=Iae.mul2($B,n),l=wae.mul2($B,l));let{jitter:h}=e,c=0,f=0;if(h>0){let u=t?t.width:this.device.width,p=t?t.height:this.device.height,_=ZB[this.device.renderVersion%ZB.length];c=h*(_.x*2-1)/u,f=h*(_.y*2-1)/p,n=Lae.copy(n),n.data[8]=c,n.data[9]=f,l=bae.copy(l),l.data[8]=c,l.data[9]=f,this.blueNoiseJitterVersion!==this.device.renderVersion&&(this.blueNoiseJitterVersion=this.device.renderVersion,this.blueNoise.vec4(this.blueNoiseJitterVec))}let d=h>0?this.blueNoiseJitterVec:W.ZERO;if(this.blueNoiseJitterData[0]=d.x,this.blueNoiseJitterData[1]=d.y,this.blueNoiseJitterData[2]=d.z,this.blueNoiseJitterData[3]=d.w,this.blueNoiseJitterId.setValue(this.blueNoiseJitterData),this.projId.setValue(n.data),this.projSkyboxId.setValue(l.data),e.calculateTransform)e.calculateTransform(Hh,kf);else{let u=e._node.getPosition(),p=e._node.getRotation();Hh.setTRS(u,p,g.ONE)}this.viewInvId.setValue(Hh.data),Hm.copy(Hh).invert(),this.viewId.setValue(Hm.data),qB.setFromMat4(Hm),this.viewId3.setValue(qB.data),zh.mul2(n,Hm),this.viewProjId.setValue(zh.data),e._storeShaderMatrices(zh,c,f,this.device.renderVersion),this.flipYId.setValue(s?-1:1),this.dispatchViewPos(e._node.getPosition()),e.frustum.setFromMat4(zh)}this.tbnBasis.setValue(s?-1:1);let r=e._nearClip,a=e._farClip;return this.nearClipId.setValue(r),this.farClipId.setValue(a),this.cameraParams[0]=1/a,this.cameraParams[1]=a,this.cameraParams[2]=r,this.cameraParams[3]=e.projection===Xs?1:0,this.cameraParamsId.setValue(this.cameraParams),this.exposureId.setValue(this.scene.physicalUnits?e.getExposure():this.scene.exposure),i}clear(e,t,s,i){let r=(t??e._clearColorBuffer?1:0)|(s??e._clearDepthBuffer?2:0)|(i??e._clearStencilBuffer?4:0);r&&this.device.clear({color:[e._clearColor.r,e._clearColor.g,e._clearColor.b,e._clearColor.a],depth:e._clearDepth,stencil:e._clearStencil,flags:r})}setCamera(e,t,s,i=null){this.setCameraUniforms(e,t),this.clearView(e,t,s,!1)}clearView(e,t,s,i){let r=this.device;if(r.setRenderTarget(t),r.updateBegin(),i&&(r.setColorWrite(!0,!0,!0,!0),r.setDepthWrite(!0)),this.setupViewport(e,t),s){let a=e._clearOptions;r.clear(a||{color:[e._clearColor.r,e._clearColor.g,e._clearColor.b,e._clearColor.a],depth:e._clearDepth,flags:(e._clearColorBuffer?1:0)|(e._clearDepthBuffer?2:0)|(e._clearStencilBuffer?4:0),stencil:e._clearStencil})}}setupCullMode(e,t,s){let i=s.material,r=0;if(e){let a=1;(i.cull===2||i.cull===1)&&(a=t*s.flipFacesFactor*s.node.worldScaleSign),a<0?r=i.cull===2?1:2:r=i.cull}this.device.setCullMode(r),r===0&&i.cull===0&&this.twoSidedLightingNegScaleFactorId.setValue(s.node.worldScaleSign)}updateCameraFrustum(e){if(e.xr&&e.xr.views.list.length){let s=e.xr.views.list[0];zh.mul2(s.projMat,s.viewOffMat),e.frustum.setFromMat4(zh);return}let t=e.projectionMatrix;if(e.calculateProjection&&e.calculateProjection(t,kf),e.calculateTransform)e.calculateTransform(Hh,kf);else{let s=e._node.getPosition(),i=e._node.getRotation();Hh.setTRS(s,i,g.ONE),this.viewInvId.setValue(Hh.data)}Hm.copy(Hh).invert(),zh.mul2(t,Hm),e.frustum.setFromMat4(zh)}setBaseConstants(e,t){e.setCullMode(t.cull),t.opacityMap&&this.opacityMapId.setValue(t.opacityMap),(t.opacityMap||t.alphaTest>0)&&this.alphaTestId.setValue(t.alphaTest)}updateCpuSkinMatrices(e){OL++;let t=e.length;if(t!==0)for(let s=0;s<t;s++){let i=e[s].skinInstance;i&&(i.updateMatrices(e[s].node,OL),i._dirty=!0)}}updateGpuSkinMatrices(e){for(let t of e){let s=t.skinInstance;s&&s._dirty&&(s.updateMatrixPalette(t.node,OL),s._dirty=!1)}}updateMorphing(e){for(let t of e){let s=t.morphInstance;s&&s._dirty&&s.update()}}updateGSplats(e){for(let t of e)t.gsplatInstance?.update()}gpuUpdate(e){this.updateGpuSkinMatrices(e),this.updateMorphing(e),this.updateGSplats(e)}setVertexBuffers(e,t){e.setVertexBuffer(t.vertexBuffer)}setMorphing(e,t){t&&(t.prepareRendering(e),e.setVertexBuffer(t.morph.vertexBufferIds),this.morphPositionTex.setValue(t.texturePositions),this.morphNormalTex.setValue(t.textureNormals),this.morphTexParams.setValue(t._textureParams))}setSkinning(e,t){let s=t.skinInstance;if(s){this._skinDrawCalls++;let i=s.boneTexture;this.boneTextureId.setValue(i)}}dispatchViewPos(e){let t=this.viewPos;t[0]=e.x,t[1]=e.y,t[2]=e.z,this.viewPosId.setValue(t)}initViewBindGroupFormat(e){if(this.device.supportsUniformBuffers&&!this.viewUniformFormat){let t=[new qe("matrix_view",pi),new qe("matrix_viewInverse",pi),new qe("matrix_projection",pi),new qe("matrix_projectionSkybox",pi),new qe("matrix_viewProjection",pi),new qe("matrix_view3",sa),new qe("cubeMapRotationMatrix",sa),new qe("view_position",fs),new qe("skyboxIntensity",Ht),new qe("exposure",Ht),new qe("textureBias",Ht),new qe("view_index",Ht)];e&&t.push(new qe("clusterCellsCountByBoundsSize",fs),new qe("clusterTextureSize",fs),new qe("clusterBoundsMin",fs),new qe("clusterBoundsDelta",fs),new qe("clusterCellsDot",fs),new qe("clusterCellsMax",fs),new qe("shadowAtlasParams",Ki),new qe("clusterMaxCells",Yi),new qe("clusterSkip",Ht)),this.viewUniformFormat=new Zi(this.device,t);let s=[new Wa(jn,wi|Li)];this.viewBindGroupFormat=new _i(this.device,s)}}setupViewUniforms(e,t){this.projId.setValue(e.projMat.data),this.projSkyboxId.setValue(e.projMat.data),this.viewId.setValue(e.viewOffMat.data),this.viewInvId.setValue(e.viewInvOffMat.data),this.viewId3.setValue(e.viewMat3.data),this.viewProjId.setValue(e.projViewOffMat.data),this.viewPosId.setValue(e.positionData),this.viewIndexId.setValue(t)}setupViewUniformBuffers(e,t,s,i){let{device:r}=this,a=i?.length??1;for(;e.length<a;){let n=new da(r,t,!1),l=new ji(r,s,n);e.push(l)}if(i)for(let n=0;n<a;n++){let l=i[n];this.setupViewUniforms(l,n);let h=e[n];h.defaultUniformBuffer.update(),h.update()}else{let n=e[0];n.defaultUniformBuffer.update(),n.update()}i||r.setBindGroup(Ha,e[0])}setupMeshUniformBuffers(e){let t=this.device;if(t.supportsUniformBuffers){let s=e.getBindGroup(t);s.update(),t.setBindGroup(ca,s),e.getUniformBuffer(t).update(BL),t.setBindGroup(Rr,BL.bindGroup,BL.offsets)}}setMeshInstanceMatrices(e,t=!1){let s=e.node.worldTransform;this.modelMatrixId.setValue(s.data),t&&this.normalMatrixId.setValue(e.node.normalMatrix.data)}cull(e,t,s){let i=s.opaque;i.length=0;let r=s.transparent;r.length=0;let a=e.frustumCulling,n=t.length;for(let l=0;l<n;l++){let h=t[l];h.visible&&(!a||!h.cull||h._isVisible(e))&&(h.visibleThisFrame=!0,(h.transparent?r:i).push(h),(h.skinInstance||h.morphInstance||h.gsplatInstance)&&(this.processingMeshInstances.add(h),h.gsplatInstance&&h.gsplatInstance.cameras.push(e)))}}collectLights(e){this.lights.length=0,this.localLights.length=0;let t=this.scene._stats,s=e.layerList.length;for(let i=0;i<s;i++){let r=e.layerList[i];if(!UL.has(r)){UL.add(r);let a=r._lights;for(let n=0;n<a.length;n++){let l=a[n];FL.has(l)||(FL.add(l),this.lights.push(l),l._type!==ge&&this.localLights.push(l))}}}t.lights=this.lights.length,FL.clear(),UL.clear()}cullLights(e,t){let s=this.scene.clusteredLightingEnabled,i=this.scene.physicalUnits;for(let r=0;r<t.length;r++){let a=t[r];if(a.enabled)if(a._type!==ge)if(a.getBoundingSphere(NL),e.frustum.containsSphere(NL)){a.visibleThisFrame=!0,a.usePhysicalUnits=i;let n=e.getScreenSize(NL);a.maxScreenSize=Math.max(a.maxScreenSize,n)}else s||a.castShadows&&!a.shadowMap&&(a.visibleThisFrame=!0);else a.usePhysicalUnits=this.scene.physicalUnits}}cullShadowmaps(e){let t=this.scene.clusteredLightingEnabled;for(let i=0;i<this.localLights.length;i++){let r=this.localLights[i];r._type!==ge&&(t?r.atlasSlotUpdated&&r.shadowUpdateMode===Ms&&(r.shadowUpdateMode=Di):r.shadowUpdateMode===Ms&&r.castShadows&&(r.getRenderData(null,0).shadowCamera.renderTarget||(r.shadowUpdateMode=Di)),r.visibleThisFrame&&r.castShadows&&r.shadowUpdateMode!==Ms&&this._shadowRendererLocal.cull(r,e))}this.cameraDirShadowLights.clear();let s=e.cameras;for(let i=0;i<s.length;i++){let r=s[i];if(r.enabled){let a=r.camera,n,l=a.layers;for(let h=0;h<l.length;h++){let c=e.getLayerById(l[h]);if(c){let f=c.splitLights[ge];for(let d=0;d<f.length;d++){let u=f[d];u.castShadows&&!Xm.has(u)&&(Xm.add(u),n=n??[],n.push(u),this._shadowRendererDirectional.cull(u,e,a))}}}n&&this.cameraDirShadowLights.set(a,n),Xm.clear()}}}cullComposition(e){let{scene:t}=this;this.processingMeshInstances.clear();let s=e.cameras.length;this._camerasRendered+=s;for(let i=0;i<s;i++){let r=e.cameras[i];t?.fire(Mm,r);let a=r.renderTarget;r.frameUpdate(a),this.updateCameraFrustum(r.camera);let n=r.layers;for(let l=0;l<n.length;l++){let h=e.getLayerById(n[l]);if(h&&h.enabled){this.cullLights(r.camera,h._lights);let c=h.getCulledInstances(r.camera);this.cull(r.camera,h.meshInstances,c)}}t?.fire(Dm,r)}t.clusteredLightingEnabled&&this.updateLightTextureAtlas(),this.cullShadowmaps(e),t?.fire(by)}updateShaders(e,t){let s=e.length;for(let i=0;i<s;i++){let r=e[i].material;if(r&&!Xm.has(r)&&(Xm.add(r),r.getShaderVariant!==Os.prototype.getShaderVariant)){if(t&&(!r.useLighting||r.emitter&&!r.emitter.lighting))continue;r.clearVariants()}}Xm.clear()}updateFrameUniforms(){this.blueNoiseTextureId.setValue(MB(this.device))}beginFrame(e){let t=this.scene,s=t.updateShaders||this.device._shadersDirty,i=e.layerList,r=i.length;for(let l=0;l<r;l++){let c=i[l].meshInstances,f=c.length;for(let d=0;d<f;d++){let u=c[d];u.visibleThisFrame=!1,s&&VL.push(u),u.skinInstance&&kL.push(u)}}if(s){let l=!t.updateShaders||!this.device._shadersDirty;this.updateShaders(VL,l),t.updateShaders=!1,this.device._shadersDirty=!1,t._shaderVersion++}this.updateFrameUniforms(),this.updateCpuSkinMatrices(kL),VL.length=0,kL.length=0;let a=this.lights,n=a.length;for(let l=0;l<n;l++)a[l].beginFrame()}updateLightTextureAtlas(){this.lightTextureAtlas.update(this.localLights,this.scene.lighting)}updateLayerComposition(e){let t=e.layerList.length,i=this.scene._shaderVersion;for(let r=0;r<t;r++){let a=e.layerList[r];a._shaderVersion=i}e._update()}frameUpdate(){this.clustersDebugRendered=!1,this.initViewBindGroupFormat(this.scene.clusteredLightingEnabled),this.dirLightShadows.clear()}}});var Wm,GL=m(()=>{Wm=class{constructor(){this.camera=null,this.layer=null,this.transparent=!1,this.renderTarget=null,this.lightClusters=null,this.clearColor=!1,this.clearDepth=!1,this.clearStencil=!1,this.triggerPostprocess=!1,this.firstCameraUse=!1,this.lastCameraUse=!1,this.viewBindGroups=[],this.useCameraPasses=!1}destroy(){this.viewBindGroups.forEach(e=>{e.defaultUniformBuffer.destroy(),e.destroy()}),this.viewBindGroups.length=0}setupClears(e,t){this.clearColor=e?.clearColorBuffer||t.clearColorBuffer,this.clearDepth=e?.clearDepthBuffer||t.clearDepthBuffer,this.clearStencil=e?.clearStencilBuffer||t.clearStencilBuffer}}});var mo,aA=m(()=>{qt();us();GL();J();mo=class extends Xe{constructor(e,t,s,i){super(e),this.renderActions=[],this.noDepthClear=!1,this.layerComposition=t,this.scene=s,this.renderer=i}get rendersAnything(){return this.renderActions.length>0}addRenderAction(e){this.renderActions.push(e)}addLayer(e,t,s,i=!0){let r=new Wm;if(r.renderTarget=this.renderTarget,r.camera=e,r.layer=t,r.transparent=s,i){let a=this.renderActions.length===0;r.setupClears(a?e:void 0,t)}this.addRenderAction(r)}addLayers(e,t,s,i,r,a=!0){let{layerList:n,subLayerList:l}=e,h=i,c=s;for(;c<n.length;){let f=n[c],d=l[c];if(t.camera.layersSet.has(f.id)&&(this.addLayer(t,f,d,h),h=!1),c++,f.id===r&&d===a)break}return c}updateDirectionalShadows(){let{renderer:e,renderActions:t}=this;for(let s=0;s<t.length;s++){let a=t[s].camera.camera,n=this.renderer.cameraDirShadowLights.get(a);if(n)for(let l=0;l<n.length;l++){let h=n[l];if(e.dirLightShadows.get(h)!==a){e.dirLightShadows.set(h,a);let c=e._shadowRendererDirectional.getLightRenderPass(h,a);c&&this.beforePasses.push(c)}}}}updateClears(){let e=this.renderActions[0];if(e){let s=e.camera.camera,i=s.fullSizeClearRect;this.setClearColor(i&&e.clearColor?s.clearColor:void 0),this.setClearDepth(i&&e.clearDepth&&!this.noDepthClear?s.clearDepth:void 0),this.setClearStencil(i&&e.clearStencil?s.clearStencil:void 0)}}frameUpdate(){super.frameUpdate(),this.updateDirectionalShadows(),this.updateClears()}before(){let{renderActions:e}=this;for(let t=0;t<e.length;t++){let s=e[t];s.firstCameraUse&&this.scene.fire(Cy,s.camera)}}execute(){let{layerComposition:e,renderActions:t}=this;for(let s=0;s<t.length;s++){let i=t[s],r=i.layer;e.isEnabled(r,i.transparent)&&this.renderRenderAction(i,s===0)}}after(){for(let e=0;e<this.renderActions.length;e++){let t=this.renderActions[e];t.lastCameraUse&&this.scene.fire(Iy,t.camera)}this.beforePasses.length=0}renderRenderAction(e,t){let{renderer:s,scene:i}=this,r=s.device,{layer:a,transparent:n,camera:l}=e;if(l){let h=l.gammaCorrection,c=l.toneMapping;this.gammaCorrection!==void 0&&(l.gammaCorrection=this.gammaCorrection),this.toneMapping!==void 0&&(l.toneMapping=this.toneMapping),i.fire(wy,l,a,n);let f={lightClusters:e.lightClusters},d=l.camera.shaderPassInfo?.index??Ti;(!t||!l.camera.fullSizeClearRect)&&(f.clearColor=e.clearColor,f.clearDepth=e.clearDepth,f.clearStencil=e.clearStencil);let u=e.renderTarget??r.backBuffer;s.renderForwardLayer(l.camera,u,a,n,d,e.viewBindGroups,f),r.setBlendState(Ie.NOBLEND),r.setStencilState(null,null),r.setAlphaToCoverage(!1),i.fire(Ly,l,a,n),this.gammaCorrection!==void 0&&(l.gammaCorrection=h),this.toneMapping!==void 0&&(l.toneMapping=c)}}}});var nA,JB=m(()=>{us();nA=class extends Xe{constructor(e,t,s){super(e),this.renderer=t,this.renderAction=s,this.requiresCubemaps=!1}execute(){this.renderAction.camera.onPostprocessing()}}});function Dae(o){let e=[];for(let t=0;t<o;++t){let s=Math.sqrt(t+.5)/Math.sqrt(o);e.push(s)}return e}function Oae(o){let e=[];for(let t=0;t<o;t++){let s=t/o,i=Math.sqrt(s*s);e.push(i)}return e}var Mae,Xh,jf,Wh,oA=m(()=>{Q();De();J();QB();KS();aA();JB();j();Mae=[[],[],[]],Xh=new N,jf={drawCalls:[],shaderInstances:[],isNewMaterial:[],lightMaskChanged:[],clear:function(){this.drawCalls.length=0,this.shaderInstances.length=0,this.isNewMaterial.length=0,this.lightMaskChanged.length=0}};Wh=class extends rA{constructor(e){super(e);let t=this.device;this._forwardDrawCalls=0,this._materialSwitches=0,this._depthMapTime=0,this._forwardTime=0,this._sortTime=0;let s=t.scope;this.fogColorId=s.resolve("fog_color"),this.fogStartId=s.resolve("fog_start"),this.fogEndId=s.resolve("fog_end"),this.fogDensityId=s.resolve("fog_density"),this.ambientId=s.resolve("light_globalAmbient"),this.skyboxIntensityId=s.resolve("skyboxIntensity"),this.cubeMapRotationMatrixId=s.resolve("cubeMapRotationMatrix"),this.pcssDiskSamplesId=s.resolve("pcssDiskSamples[0]"),this.pcssSphereSamplesId=s.resolve("pcssSphereSamples[0]"),this.lightColorId=[],this.lightDir=[],this.lightDirId=[],this.lightShadowMapId=[],this.lightShadowMatrixId=[],this.lightShadowParamsId=[],this.lightShadowIntensity=[],this.lightRadiusId=[],this.lightPos=[],this.lightPosId=[],this.lightWidth=[],this.lightWidthId=[],this.lightHeight=[],this.lightHeightId=[],this.lightInAngleId=[],this.lightOutAngleId=[],this.lightCookieId=[],this.lightCookieIntId=[],this.lightCookieMatrixId=[],this.lightCookieOffsetId=[],this.lightShadowSearchAreaId=[],this.lightCameraParamsId=[],this.lightSoftShadowParamsId=[],this.shadowMatrixPaletteId=[],this.shadowCascadeDistancesId=[],this.shadowCascadeCountId=[],this.shadowCascadeBlendId=[],this.screenSizeId=s.resolve("uScreenSize"),this._screenSize=new Float32Array(4),this.fogColor=new Float32Array(3),this.ambientColor=new Float32Array(3),this.pcssDiskSamples=Dae(16),this.pcssSphereSamples=Oae(16)}destroy(){super.destroy()}dispatchGlobalLights(e){let t=this.ambientColor;if(Xh.linear(e.ambientLight),t[0]=Xh.r,t[1]=Xh.g,t[2]=Xh.b,e.physicalUnits)for(let s=0;s<3;s++)t[s]*=e.ambientLuminance;this.ambientId.setValue(t),this.skyboxIntensityId.setValue(e.physicalUnits?e.skyboxLuminance:e.skyboxIntensity),this.cubeMapRotationMatrixId.setValue(e._skyboxRotationMat3.data)}_resolveLight(e,t){let s=`light${t}`;this.lightColorId[t]=e.resolve(`${s}_color`),this.lightDir[t]=new Float32Array(3),this.lightDirId[t]=e.resolve(`${s}_direction`),this.lightShadowMapId[t]=e.resolve(`${s}_shadowMap`),this.lightShadowMatrixId[t]=e.resolve(`${s}_shadowMatrix`),this.lightShadowParamsId[t]=e.resolve(`${s}_shadowParams`),this.lightShadowIntensity[t]=e.resolve(`${s}_shadowIntensity`),this.lightShadowSearchAreaId[t]=e.resolve(`${s}_shadowSearchArea`),this.lightRadiusId[t]=e.resolve(`${s}_radius`),this.lightPos[t]=new Float32Array(3),this.lightPosId[t]=e.resolve(`${s}_position`),this.lightWidth[t]=new Float32Array(3),this.lightWidthId[t]=e.resolve(`${s}_halfWidth`),this.lightHeight[t]=new Float32Array(3),this.lightHeightId[t]=e.resolve(`${s}_halfHeight`),this.lightInAngleId[t]=e.resolve(`${s}_innerConeAngle`),this.lightOutAngleId[t]=e.resolve(`${s}_outerConeAngle`),this.lightCookieId[t]=e.resolve(`${s}_cookie`),this.lightCookieIntId[t]=e.resolve(`${s}_cookieIntensity`),this.lightCookieMatrixId[t]=e.resolve(`${s}_cookieMatrix`),this.lightCookieOffsetId[t]=e.resolve(`${s}_cookieOffset`),this.lightCameraParamsId[t]=e.resolve(`${s}_cameraParams`),this.lightSoftShadowParamsId[t]=e.resolve(`${s}_softShadowParams`),this.shadowMatrixPaletteId[t]=e.resolve(`${s}_shadowMatrixPalette[0]`),this.shadowCascadeDistancesId[t]=e.resolve(`${s}_shadowCascadeDistances`),this.shadowCascadeCountId[t]=e.resolve(`${s}_shadowCascadeCount`),this.shadowCascadeBlendId[t]=e.resolve(`${s}_shadowCascadeBlend`)}setLTCDirectionalLight(e,t,s,i,r){this.lightPos[t][0]=i.x-s.x*r,this.lightPos[t][1]=i.y-s.y*r,this.lightPos[t][2]=i.z-s.z*r,this.lightPosId[t].setValue(this.lightPos[t]);let a=e.transformVector(new g(-.5,0,0));this.lightWidth[t][0]=a.x*r,this.lightWidth[t][1]=a.y*r,this.lightWidth[t][2]=a.z*r,this.lightWidthId[t].setValue(this.lightWidth[t]);let n=e.transformVector(new g(0,0,.5));this.lightHeight[t][0]=n.x*r,this.lightHeight[t][1]=n.y*r,this.lightHeight[t][2]=n.z*r,this.lightHeightId[t].setValue(this.lightHeight[t])}dispatchDirectLights(e,t,s){let i=0,r=this.device.scope;for(let a=0;a<e.length;a++){if(!(e[a].mask&t))continue;let n=e[a],l=n._node.getWorldTransform();if(this.lightColorId[i]||this._resolveLight(r,i),this.lightColorId[i].setValue(n._colorLinear),l.getY(n._direction).mulScalar(-1),n._direction.normalize(),this.lightDir[i][0]=n._direction.x,this.lightDir[i][1]=n._direction.y,this.lightDir[i][2]=n._direction.z,this.lightDirId[i].setValue(this.lightDir[i]),n.shape!==bs&&this.setLTCDirectionalLight(l,i,n._direction,s._node.getPosition(),s.farClip),n.castShadows){let h=n.getRenderData(s,0),c=n._getUniformBiasValues(h);this.lightShadowMapId[i].setValue(h.shadowBuffer),this.lightShadowMatrixId[i].setValue(h.shadowMatrix.data),this.shadowMatrixPaletteId[i].setValue(n._shadowMatrixPalette),this.shadowCascadeDistancesId[i].setValue(n._shadowCascadeDistances),this.shadowCascadeCountId[i].setValue(n.numCascades),this.shadowCascadeBlendId[i].setValue(1-n.cascadeBlend),this.lightShadowIntensity[i].setValue(n.shadowIntensity),this.lightSoftShadowParamsId[i].setValue(n._softShadowParams),h.shadowCamera.renderTarget&&this.lightShadowSearchAreaId[i].setValue(n.penumbraSize/h.shadowCamera.renderTarget.width*h.projectionCompensation);let d=n._shadowCameraParams;d.length=4,d[0]=0,d[1]=h.shadowCamera._farClip,d[2]=h.shadowCamera._nearClip,d[3]=1,this.lightCameraParamsId[i].setValue(d);let u=n._shadowRenderParams;u.length=4,u[0]=n._shadowResolution,u[1]=c.normalBias,u[2]=c.bias,u[3]=0,this.lightShadowParamsId[i].setValue(u)}i++}return i}setLTCPositionalLight(e,t){let s=e.transformVector(new g(-.5,0,0));this.lightWidth[t][0]=s.x,this.lightWidth[t][1]=s.y,this.lightWidth[t][2]=s.z,this.lightWidthId[t].setValue(this.lightWidth[t]);let i=e.transformVector(new g(0,0,.5));this.lightHeight[t][0]=i.x,this.lightHeight[t][1]=i.y,this.lightHeight[t][2]=i.z,this.lightHeightId[t].setValue(this.lightHeight[t])}dispatchOmniLight(e,t,s){let i=t._node.getWorldTransform();if(this.lightColorId[s]||this._resolveLight(e,s),this.lightRadiusId[s].setValue(t.attenuationEnd),this.lightColorId[s].setValue(t._colorLinear),i.getTranslation(t._position),this.lightPos[s][0]=t._position.x,this.lightPos[s][1]=t._position.y,this.lightPos[s][2]=t._position.z,this.lightPosId[s].setValue(this.lightPos[s]),t.shape!==bs&&this.setLTCPositionalLight(i,s),t.castShadows){let r=t.getRenderData(null,0);this.lightShadowMapId[s].setValue(r.shadowBuffer);let a=t._getUniformBiasValues(r),n=t._shadowRenderParams;n.length=4,n[0]=t._shadowResolution,n[1]=a.normalBias,n[2]=a.bias,n[3]=1/t.attenuationEnd,this.lightShadowParamsId[s].setValue(n),this.lightShadowIntensity[s].setValue(t.shadowIntensity);let l=t.penumbraSize/r.shadowCamera.renderTarget.width;this.lightShadowSearchAreaId[s].setValue(l);let h=t._shadowCameraParams;h.length=4,h[0]=0,h[1]=r.shadowCamera._farClip,h[2]=r.shadowCamera._nearClip,h[3]=0,this.lightCameraParamsId[s].setValue(h)}t._cookie&&(this.lightCookieId[s].setValue(t._cookie),this.lightShadowMatrixId[s].setValue(i.data),this.lightCookieIntId[s].setValue(t.cookieIntensity))}dispatchSpotLight(e,t,s){let i=t._node.getWorldTransform();if(this.lightColorId[s]||this._resolveLight(e,s),this.lightInAngleId[s].setValue(t._innerConeAngleCos),this.lightOutAngleId[s].setValue(t._outerConeAngleCos),this.lightRadiusId[s].setValue(t.attenuationEnd),this.lightColorId[s].setValue(t._colorLinear),i.getTranslation(t._position),this.lightPos[s][0]=t._position.x,this.lightPos[s][1]=t._position.y,this.lightPos[s][2]=t._position.z,this.lightPosId[s].setValue(this.lightPos[s]),t.shape!==bs&&this.setLTCPositionalLight(i,s),i.getY(t._direction).mulScalar(-1),t._direction.normalize(),this.lightDir[s][0]=t._direction.x,this.lightDir[s][1]=t._direction.y,this.lightDir[s][2]=t._direction.z,this.lightDirId[s].setValue(this.lightDir[s]),t.castShadows){let r=t.getRenderData(null,0);this.lightShadowMapId[s].setValue(r.shadowBuffer),this.lightShadowMatrixId[s].setValue(r.shadowMatrix.data);let a=t._getUniformBiasValues(r),n=t._shadowRenderParams;n.length=4,n[0]=t._shadowResolution,n[1]=a.normalBias,n[2]=a.bias,n[3]=1/t.attenuationEnd,this.lightShadowParamsId[s].setValue(n),this.lightShadowIntensity[s].setValue(t.shadowIntensity);let l=t.penumbraSize/r.shadowCamera.renderTarget.width,h=r.shadowCamera._fov*Math.PI/180,c=1/Math.tan(h/2);this.lightShadowSearchAreaId[s].setValue(l*c);let f=t._shadowCameraParams;f.length=4,f[0]=0,f[1]=r.shadowCamera._farClip,f[2]=r.shadowCamera._nearClip,f[3]=0,this.lightCameraParamsId[s].setValue(f)}if(t._cookie){if(!t.castShadows){let r=fo.evalSpotCookieMatrix(t);this.lightShadowMatrixId[s].setValue(r.data)}this.lightCookieId[s].setValue(t._cookie),this.lightCookieIntId[s].setValue(t.cookieIntensity),t._cookieTransform&&(t._cookieTransformUniform[0]=t._cookieTransform.x,t._cookieTransformUniform[1]=t._cookieTransform.y,t._cookieTransformUniform[2]=t._cookieTransform.z,t._cookieTransformUniform[3]=t._cookieTransform.w,this.lightCookieMatrixId[s].setValue(t._cookieTransformUniform),t._cookieOffsetUniform[0]=t._cookieOffset.x,t._cookieOffsetUniform[1]=t._cookieOffset.y,this.lightCookieOffsetId[s].setValue(t._cookieOffsetUniform))}}dispatchLocalLights(e,t,s){let i=s,r=this.device.scope,a=e[Ge],n=a.length;for(let c=0;c<n;c++){let f=a[c];f.mask&t&&(this.dispatchOmniLight(r,f,i),i++)}let l=e[Ye],h=l.length;for(let c=0;c<h;c++){let f=l[c];f.mask&t&&(this.dispatchSpotLight(r,f,i),i++)}}renderForwardPrepareMaterials(e,t,s,i,r,a){let n=e.fogParams??this.scene.fog,l=e.shaderParams;l.fog=n.type,l.srgbRenderTarget=t?.isColorBufferSrgb(0)??!1;let h=(x,A,E,v)=>{jf.drawCalls.push(x),jf.shaderInstances.push(A),jf.isNewMaterial.push(E),jf.lightMaskChanged.push(v)};jf.clear();let c=this.device,f=this.scene,d=f.clusteredLightingEnabled,u=r?.getLightHash(d)??0,p=null,_,S,T=s.length;for(let x=0;x<T;x++){let A=s[x],E=A.instancingData;if(E&&E.count<=0)continue;A.ensureMaterial(c);let v=A.material,R=A._shaderDefs,P=A.mask;v&&v===p&&R!==_&&(p=null),v!==p&&(this._materialSwitches++,v._scene=f,v.dirty&&(v.updateUniforms(c,f),v.dirty=!1));let y=A.getShaderInstance(a,u,f,l,this.viewUniformFormat,this.viewBindGroupFormat,i);h(A,y,v!==p,!p||P!==S),p=v,_=R,S=P}return jf}renderForwardInternal(e,t,s,i,r,a,n){let l=this.device,h=this.scene,c=1<<i,f=a?-1:1,d=h.clusteredLightingEnabled,u=e.xr?.session&&e.xr.views.list.length?e.xr.views.list:null,p=t.drawCalls.length;for(let _=0;_<p;_++){let S=t.drawCalls[_],T=t.isNewMaterial[_],x=t.lightMaskChanged[_],A=t.shaderInstances[_],E=S.material,v=S.mask;if(A.shader.failed)continue;if(T){if(l.setShader(A.shader,!1),E.setParameters(l),x){let G=this.dispatchDirectLights(s[ge],v,e);d||this.dispatchLocalLights(s,v,G)}this.alphaTestId.setValue(E.alphaTest),l.setBlendState(E.blendState),l.setDepthState(E.depthState),l.setAlphaToCoverage(E.alphaToCoverage)}this.setupCullMode(e._cullFaces,f,S);let R=S.stencilFront??E.stencilFront,P=S.stencilBack??E.stencilBack;l.setStencilState(R,P),S.setParameters(l,c),l.scope.resolve("meshInstanceId").setValue(S.id);let y=S.mesh;this.setVertexBuffers(l,y),this.setMorphing(l,S.morphInstance),this.setSkinning(l,S);let C=S.instancingData;C&&l.setVertexBuffer(C.vertexBuffer),this.setMeshInstanceMatrices(S,!0),this.setupMeshUniformBuffers(A);let L=S.renderStyle,O=y.indexBuffer[L];r?.(S,_);let M=S.indirectData?.get(e);if(u)for(let U=0;U<u.length;U++){let G=u[U];if(l.setViewport(G.viewport.x,G.viewport.y,G.viewport.z,G.viewport.w),l.supportsUniformBuffers){let I=n[U];l.setBindGroup(Ha,I)}else this.setupViewUniforms(G,U);let $=U===0,X=U===u.length-1;l.draw(y.primitive[L],O,C?.count,M,$,X),this._forwardDrawCalls++,S.instancingData&&this._instancedDrawCalls++}else l.draw(y.primitive[L],O,C?.count,M),this._forwardDrawCalls++,S.instancingData&&this._instancedDrawCalls++;_<p-1&&!t.isNewMaterial[_+1]&&E.setParameters(l,S.parameters)}}renderForward(e,t,s,i,r,a,n,l,h){let c=this.renderForwardPrepareMaterials(e,t,s,i,n,r);this.renderForwardInternal(e,c,i,r,a,l,h),jf.clear()}renderForwardLayer(e,t,s,i,r,a,n={}){let{scene:l,device:h}=this,c=l.clusteredLightingEnabled;this.setupViewport(e,t);let f,d;if(s){s.sortVisible(e,i);let E=s.getCulledInstances(e);f=i?E.transparent:E.opaque,l.immediate.onPreRenderLayer(s,f,i),s.requiresLightCube&&(this.lightCube.update(l.ambientLight,s._lights),this.constantLightCube.setValue(this.lightCube.colors)),d=s.splitLights}else f=n.meshInstances,d=n.splitLights??Mae;c&&((n.lightClusters??this.worldClustersAllocator.empty).activate(),s&&!this.clustersDebugRendered&&l.lighting.debugLayer===s.id&&(this.clustersDebugRendered=!0)),l._activeCamera=e;let u=e.fogParams??this.scene.fog;this.setFogConstants(u);let p=this.setCameraUniforms(e,t);h.supportsUniformBuffers&&this.setupViewUniformBuffers(a,this.viewUniformFormat,this.viewBindGroupFormat,p);let _=n.clearColor??!1,S=n.clearDepth??!1,T=n.clearStencil??!1;(_||S||T)&&this.clear(e,_,S,T);let x=!!(e._flipFaces^t?.flipY),A=this._forwardDrawCalls;this.renderForward(e,t,f,d,r,null,s,x,a),s&&(s._forwardDrawCalls+=this._forwardDrawCalls-A)}setFogConstants(e){if(e.type!==tr){Xh.linear(e.color);let t=this.fogColor;t[0]=Xh.r,t[1]=Xh.g,t[2]=Xh.b,this.fogColorId.setValue(t),e.type===ny?(this.fogStartId.setValue(e.start),this.fogEndId.setValue(e.end)):this.fogDensityId.setValue(e.density)}}setSceneConstants(){let e=this.scene;this.dispatchGlobalLights(e);let t=this.device;this._screenSize[0]=t.width,this._screenSize[1]=t.height,this._screenSize[2]=1/t.width,this._screenSize[3]=1/t.height,this.screenSizeId.setValue(this._screenSize),this.pcssDiskSamplesId.setValue(this.pcssDiskSamples),this.pcssSphereSamplesId.setValue(this.pcssSphereSamples)}buildFrameGraph(e,t){let s=this.scene;if(e.reset(),s.clusteredLightingEnabled){let{shadowsEnabled:l,cookiesEnabled:h}=s.lighting;this._renderPassUpdateClustered.update(e,l,h,this.lights,this.localLights),e.addRenderPass(this._renderPassUpdateClustered)}else this._shadowRendererLocal.buildNonClusteredRenderPasses(e,this.localLights);let i=0,r=!0,a=null,n=t._renderActions;for(let l=i;l<n.length;l++){let h=n[l],{layer:c,camera:f}=h;if(h.useCameraPasses)f.camera.renderPasses.forEach(d=>{e.addRenderPass(d)});else{let d=c.id===Xt,u=d&&(f.renderSceneColorMap||f.renderSceneDepthMap);r&&(r=!1,i=l,a=h.renderTarget);let p=n[l+1],S=(p?!p.useCameraPasses&&p.layer.id===Xt:!1)&&(f.renderSceneColorMap||f.renderSceneDepthMap),T=p?p.firstCameraUse&&this.cameraDirShadowLights.has(p.camera.camera):!1;if(!p||p.renderTarget!==a||T||S||u){if(d&&i===l||this.addMainRenderPass(e,t,a,i,l),d){if(f.renderSceneColorMap){let A=f.camera.renderPassColorGrab;A.source=f.renderTarget,e.addRenderPass(A)}f.renderSceneDepthMap&&e.addRenderPass(f.camera.renderPassDepthGrab)}if(h.triggerPostprocess&&f?.onPostprocessing){let A=new nA(this.device,this,h);e.addRenderPass(A)}r=!0}}}}addMainRenderPass(e,t,s,i,r){let a=new mo(this.device,t,this.scene,this);a.init(s);let n=t._renderActions;for(let l=i;l<=r;l++)a.addRenderAction(n[l]);e.addRenderPass(a)}update(e){this.frameUpdate(),this.shadowRenderer.frameUpdate(),this.scene._updateSkyMesh(),this.updateLayerComposition(e),this.collectLights(e),this.beginFrame(e),this.setSceneConstants(),this.cullComposition(e),this.gpuUpdate(this.processingMeshInstances)}}});function Nae(o,e){return o.drawOrder-e.drawOrder}function Fae(o,e){let t=o._sortKeyForward,s=e._sortKeyForward;return t===s?e.mesh.id-o.mesh.id:s-t}function Uae(o,e){return e._sortKeyDynamic-o._sortKeyDynamic}function Bae(o,e){return o._sortKeyDynamic-e._sortKeyDynamic}var zL,ZS,lA,Vae,HL,At,Ym=m(()=>{Ya();J();rl();zL=0,ZS=[],lA=new Set;Vae=[null,Nae,Fae,Uae,Bae],HL=class{constructor(){this.opaque=[],this.transparent=[]}},At=class{constructor(e={}){this.meshInstances=[],this.meshInstancesSet=new Set,this.shadowCasters=[],this.shadowCastersSet=new Set,this._visibleInstances=new WeakMap,this._lights=[],this._lightsSet=new Set,this._clusteredLightsSet=new Set,this._splitLights=[[],[],[]],this._splitLightsDirty=!0,this.requiresLightCube=!1,this.cameras=[],this.camerasSet=new Set,this._dirtyComposition=!1,e.id!==void 0?(this.id=e.id,zL=Math.max(this.id+1,zL)):this.id=zL++,this.name=e.name,this._enabled=e.enabled??!0,this._refCounter=this._enabled?1:0,this.opaqueSortMode=e.opaqueSortMode??vy,this.transparentSortMode=e.transparentSortMode??VS,e.renderTarget&&(this.renderTarget=e.renderTarget),this._clearColorBuffer=!!e.clearColorBuffer,this._clearDepthBuffer=!!e.clearDepthBuffer,this._clearStencilBuffer=!!e.clearStencilBuffer,this.onEnable=e.onEnable,this.onDisable=e.onDisable,this._enabled&&this.onEnable&&this.onEnable(),this.customSortCallback=null,this.customCalculateSortValues=null,this._lightHash=0,this._lightHashDirty=!1,this._lightIdHash=0,this._lightIdHashDirty=!1,this._shaderVersion=-1}set enabled(e){e!==this._enabled&&(this._dirtyComposition=!0,this._enabled=e,e?(this.incrementCounter(),this.onEnable&&this.onEnable()):(this.decrementCounter(),this.onDisable&&this.onDisable()))}get enabled(){return this._enabled}set clearColorBuffer(e){this._clearColorBuffer=e,this._dirtyComposition=!0}get clearColorBuffer(){return this._clearColorBuffer}set clearDepthBuffer(e){this._clearDepthBuffer=e,this._dirtyComposition=!0}get clearDepthBuffer(){return this._clearDepthBuffer}set clearStencilBuffer(e){this._clearStencilBuffer=e,this._dirtyComposition=!0}get clearStencilBuffer(){return this._clearStencilBuffer}get hasClusteredLights(){return this._clusteredLightsSet.size>0}get clusteredLightsSet(){return this._clusteredLightsSet}incrementCounter(){this._refCounter===0&&(this._enabled=!0,this.onEnable&&this.onEnable()),this._refCounter++}decrementCounter(){if(this._refCounter===1)this._enabled=!1,this.onDisable&&this.onDisable();else if(this._refCounter===0)return;this._refCounter--}addMeshInstances(e,t){let s=this.meshInstances,i=this.meshInstancesSet;for(let r=0;r<e.length;r++){let a=e[r];i.has(a)||(s.push(a),i.add(a),lA.add(a.material))}if(t||this.addShadowCasters(e),lA.size>0){let r=this._shaderVersion;lA.forEach(a=>{r>=0&&a._shaderVersion!==r&&(a.getShaderVariant!==Os.prototype.getShaderVariant&&a.clearVariants(),a._shaderVersion=r)}),lA.clear()}}removeMeshInstances(e,t){let s=this.meshInstances,i=this.meshInstancesSet;for(let r=0;r<e.length;r++){let a=e[r];if(i.has(a)){i.delete(a);let n=s.indexOf(a);n>=0&&s.splice(n,1)}}t||this.removeShadowCasters(e)}addShadowCasters(e){let t=this.shadowCasters,s=this.shadowCastersSet;for(let i=0;i<e.length;i++){let r=e[i];r.castShadow&&!s.has(r)&&(s.add(r),t.push(r))}}removeShadowCasters(e){let t=this.shadowCasters,s=this.shadowCastersSet;for(let i=0;i<e.length;i++){let r=e[i];if(s.has(r)){s.delete(r);let a=t.indexOf(r);a>=0&&t.splice(a,1)}}}clearMeshInstances(e=!1){this.meshInstances.length=0,this.meshInstancesSet.clear(),e||(this.shadowCasters.length=0,this.shadowCastersSet.clear())}markLightsDirty(){this._lightHashDirty=!0,this._lightIdHashDirty=!0,this._splitLightsDirty=!0}hasLight(e){return this._lightsSet.has(e)}addLight(e){let t=e.light;this._lightsSet.has(t)||(this._lightsSet.add(t),this._lights.push(t),this.markLightsDirty()),t.type!==ge&&this._clusteredLightsSet.add(t)}removeLight(e){let t=e.light;this._lightsSet.has(t)&&(this._lightsSet.delete(t),this._lights.splice(this._lights.indexOf(t),1),this.markLightsDirty()),t.type!==ge&&this._clusteredLightsSet.delete(t)}clearLights(){this._lightsSet.forEach(e=>e.removeLayer(this)),this._lightsSet.clear(),this._clusteredLightsSet.clear(),this._lights.length=0,this.markLightsDirty()}get splitLights(){if(this._splitLightsDirty){this._splitLightsDirty=!1;let e=this._splitLights;for(let s=0;s<e.length;s++)e[s].length=0;let t=this._lights;for(let s=0;s<t.length;s++){let i=t[s];i.enabled&&e[i._type].push(i)}for(let s=0;s<e.length;s++)e[s].sort((i,r)=>i.key-r.key)}return this._splitLights}evaluateLightHash(e,t,s){let i=0,r=this._lights;for(let a=0;a<r.length;a++){let n=r[a].type!==ge;(e&&n||t&&!n)&&ZS.push(s?r[a].id:r[a].key)}return ZS.length>0&&(ZS.sort(),i=$u(ZS),ZS.length=0),i}getLightHash(e){return this._lightHashDirty&&(this._lightHashDirty=!1,this._lightHash=this.evaluateLightHash(!e,!0,!1)),this._lightHash}getLightIdHash(){return this._lightIdHashDirty&&(this._lightIdHashDirty=!1,this._lightIdHash=this.evaluateLightHash(!0,!1,!0)),this._lightIdHash}addCamera(e){this.camerasSet.has(e.camera)||(this.camerasSet.add(e.camera),this.cameras.push(e),this._dirtyComposition=!0)}removeCamera(e){if(this.camerasSet.has(e.camera)){this.camerasSet.delete(e.camera);let t=this.cameras.indexOf(e);this.cameras.splice(t,1),this._dirtyComposition=!0}}clearCameras(){this.cameras.length=0,this.camerasSet.clear(),this._dirtyComposition=!0}_calculateSortDistances(e,t,s){let i=e.length,{x:r,y:a,z:n}=t,{x:l,y:h,z:c}=s;for(let f=0;f<i;f++){let d=e[f],u;if(d.calculateSortDistance)u=d.calculateSortDistance(d,t,s);else{let _=d.aabb.center;u=(_.x-r)*l+(_.y-a)*h+(_.z-n)*c}let p=d._drawBucket*1e9;d._sortKeyDynamic=p+u}}getCulledInstances(e){let t=this._visibleInstances.get(e);return t||(t=new HL,this._visibleInstances.set(e,t)),t}sortVisible(e,t){let s=t?this.transparentSortMode:this.opaqueSortMode;if(s===tn)return;let i=this.getCulledInstances(e),r=t?i.transparent:i.opaque,a=e.node;if(s===yy){let n=a.getPosition(),l=a.forward;this.customCalculateSortValues&&this.customCalculateSortValues(r,r.length,n,l),this.customSortCallback&&r.sort(this.customSortCallback)}else{if(s===VS||s===xy){let n=a.getPosition(),l=a.forward;this._calculateSortDistances(r,n,l)}r.sort(Vae[s])}}}});var kae,Yh,hA=m(()=>{kae=(o,e)=>o.priority-e.priority,Yh=o=>o.sort(kae)});var nl,cA=m(()=>{Pe();hA();J();GL();nl=class extends K{constructor(e="Untitled"){super(),this.layerList=[],this.layerIdMap=new Map,this.layerNameMap=new Map,this.layerOpaqueIndexMap=new Map,this.layerTransparentIndexMap=new Map,this.subLayerList=[],this.subLayerEnabled=[],this.cameras=[],this._renderActions=[],this._dirty=!1,this.name=e,this._opaqueOrder={},this._transparentOrder={}}destroy(){this.destroyRenderActions()}destroyRenderActions(){this._renderActions.forEach(e=>e.destroy()),this._renderActions.length=0}markDirty(){this._dirty=!0}_update(){let e=this.layerList.length;if(!this._dirty){for(let t=0;t<e;t++)if(this.layerList[t]._dirtyComposition){this._dirty=!0;break}}if(this._dirty){this._dirty=!1,this.cameras.length=0;for(let s=0;s<e;s++){let i=this.layerList[s];i._dirtyComposition=!1;for(let r=0;r<i.cameras.length;r++){let a=i.cameras[r];this.cameras.indexOf(a)<0&&this.cameras.push(a)}}this.cameras.length>1&&Yh(this.cameras);let t=0;this.destroyRenderActions();for(let s=0;s<this.cameras.length;s++){let i=this.cameras[s];if(i.camera.renderPasses.length>0){this.addDummyRenderAction(t,i),t++;continue}let r=!0,a=t,n=null,l=!1;for(let h=0;h<e;h++){let c=this.layerList[h];if(c.enabled&&this.subLayerEnabled[h]&&c.cameras.length>0&&i.layers.indexOf(c.id)>=0){!l&&c.id===i.disablePostEffectsLayer&&(l=!0,n&&(n.triggerPostprocess=!0));let d=this.subLayerList[h];n=this.addRenderAction(t,c,d,i,r,l),t++,r=!1}}a<t&&(n.lastCameraUse=!0),!l&&n&&(n.triggerPostprocess=!0),i.renderTarget&&i.postEffectsEnabled&&this.propagateRenderTarget(a-1,i)}this._logRenderActions()}}getNextRenderAction(e){let t=new Wm;return this._renderActions.push(t),t}addDummyRenderAction(e,t){let s=this.getNextRenderAction(e);s.camera=t,s.useCameraPasses=!0}addRenderAction(e,t,s,i,r,a){let n=t.id!==Xt?i.renderTarget:null,l=!1,h=this._renderActions;for(let u=e-1;u>=0;u--)if(h[u].camera===i&&h[u].renderTarget===n){l=!0;break}a&&i.postEffectsEnabled&&(n=null);let c=this.getNextRenderAction(e);c.triggerPostprocess=!1,c.layer=t,c.transparent=s,c.camera=i,c.renderTarget=n,c.firstCameraUse=r,c.lastCameraUse=!1;let f=r||!l,d=t.clearColorBuffer||t.clearDepthBuffer||t.clearStencilBuffer;return(f||d)&&c.setupClears(f?i:void 0,t),c}propagateRenderTarget(e,t){for(let s=e;s>=0;s--){let i=this._renderActions[s],r=i.layer;if(i.renderTarget&&r.id!==Xt)break;if(r.id===Xt)continue;if(i.useCameraPasses)break;let a=i?.camera.camera;if(a&&(!t.camera.rect.equals(a.rect)||!t.camera.scissorRect.equals(a.scissorRect)))break;i.renderTarget=t.renderTarget}}_logRenderActions(){}_isLayerAdded(e){return this.layerIdMap.get(e.id)===e}_isSublayerAdded(e,t){return(t?this.layerTransparentIndexMap:this.layerOpaqueIndexMap).get(e)!==void 0}push(e){this._isLayerAdded(e)||(this.layerList.push(e),this.layerList.push(e),this._opaqueOrder[e.id]=this.subLayerList.push(!1)-1,this._transparentOrder[e.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this.subLayerEnabled.push(!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e))}insert(e,t){if(this._isLayerAdded(e))return;this.layerList.splice(t,0,e,e),this.subLayerList.splice(t,0,!1,!0);let s=this.layerList.length;this._updateOpaqueOrder(t,s-1),this._updateTransparentOrder(t,s-1),this.subLayerEnabled.splice(t,0,!0,!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e)}remove(e){let t=this.layerList.indexOf(e);for(delete this._opaqueOrder[t],delete this._transparentOrder[t];t>=0;)this.layerList.splice(t,1),this.subLayerList.splice(t,1),this.subLayerEnabled.splice(t,1),t=this.layerList.indexOf(e),this._dirty=!0,this.fire("remove",e);let s=this.layerList.length;this._updateOpaqueOrder(0,s-1),this._updateTransparentOrder(0,s-1),this._updateLayerMaps()}pushOpaque(e){this._isSublayerAdded(e,!1)||(this.layerList.push(e),this._opaqueOrder[e.id]=this.subLayerList.push(!1)-1,this.subLayerEnabled.push(!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e))}insertOpaque(e,t){if(this._isSublayerAdded(e,!1))return;this.layerList.splice(t,0,e),this.subLayerList.splice(t,0,!1);let s=this.subLayerList.length;this._updateOpaqueOrder(t,s-1),this.subLayerEnabled.splice(t,0,!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e)}removeOpaque(e){for(let t=0,s=this.layerList.length;t<s;t++)if(this.layerList[t]===e&&!this.subLayerList[t]){this.layerList.splice(t,1),this.subLayerList.splice(t,1),s--,this._updateOpaqueOrder(t,s-1),this.subLayerEnabled.splice(t,1),this._dirty=!0,this.layerList.indexOf(e)<0&&this.fire("remove",e);break}this._updateLayerMaps()}pushTransparent(e){this._isSublayerAdded(e,!0)||(this.layerList.push(e),this._transparentOrder[e.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e))}insertTransparent(e,t){if(this._isSublayerAdded(e,!0))return;this.layerList.splice(t,0,e),this.subLayerList.splice(t,0,!0);let s=this.subLayerList.length;this._updateTransparentOrder(t,s-1),this.subLayerEnabled.splice(t,0,!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e)}removeTransparent(e){for(let t=0,s=this.layerList.length;t<s;t++)if(this.layerList[t]===e&&this.subLayerList[t]){this.layerList.splice(t,1),this.subLayerList.splice(t,1),s--,this._updateTransparentOrder(t,s-1),this.subLayerEnabled.splice(t,1),this._dirty=!0,this.layerList.indexOf(e)<0&&this.fire("remove",e);break}this._updateLayerMaps()}getOpaqueIndex(e){return this.layerOpaqueIndexMap.get(e)??-1}getTransparentIndex(e){return this.layerTransparentIndexMap.get(e)??-1}isEnabled(e,t){if(e.enabled){let s=t?this.getTransparentIndex(e):this.getOpaqueIndex(e);if(s>=0)return this.subLayerEnabled[s]}return!1}_updateLayerMaps(){this.layerIdMap.clear(),this.layerNameMap.clear(),this.layerOpaqueIndexMap.clear(),this.layerTransparentIndexMap.clear();for(let e=0;e<this.layerList.length;e++){let t=this.layerList[e];this.layerIdMap.set(t.id,t),this.layerNameMap.set(t.name,t),(this.subLayerList[e]?this.layerTransparentIndexMap:this.layerOpaqueIndexMap).set(t,e)}}getLayerById(e){return this.layerIdMap.get(e)??null}getLayerByName(e){return this.layerNameMap.get(e)??null}_updateOpaqueOrder(e,t){for(let s=e;s<=t;s++)this.subLayerList[s]===!1&&(this._opaqueOrder[this.layerList[s].id]=s)}_updateTransparentOrder(e,t){for(let s=e;s<=t;s++)this.subLayerList[s]===!0&&(this._transparentOrder[this.layerList[s].id]=s)}_sortLayersDescending(e,t,s){let i=-1,r=-1;for(let a=0,n=e.length;a<n;a++){let l=e[a];s.hasOwnProperty(l)&&(i=Math.max(i,s[l]))}for(let a=0,n=t.length;a<n;a++){let l=t[a];s.hasOwnProperty(l)&&(r=Math.max(r,s[l]))}return i===-1&&r!==-1?1:r===-1&&i!==-1?-1:r-i}sortTransparentLayers(e,t){return this._sortLayersDescending(e,t,this._transparentOrder)}sortOpaqueLayers(e,t){return this._sortLayersDescending(e,t,this._opaqueOrder)}}});var fA,ol,QS,XL,JS,Gae,zae,Hae,WL,Kh,dA=m(()=>{me();De();Ke();Ne();Q();Ze();J();ML();ii();$l();fA=new g,ol={bias:0,normalBias:0},QS=new N,XL={r:0,g:1,b:2,a:3},JS={directional:ge,omni:Ge,point:Ge,spot:Ye},Gae=[[new W(0,0,1,1)],[new W(0,0,.5,.5),new W(0,.5,.5,.5)],[new W(0,0,.5,.5),new W(0,.5,.5,.5),new W(.5,0,.5,.5)],[new W(0,0,.5,.5),new W(0,.5,.5,.5),new W(.5,0,.5,.5),new W(.5,.5,.5,.5)]],zae={rrr:1,ggg:2,bbb:4,aaa:8,rgb:7},Hae=0,WL=class{constructor(e,t,s){this.light=s,this.camera=e,this.shadowCamera=zm.createShadowCamera(s._shadowType,s._type,t),this.shadowMatrix=new k,this.shadowViewport=new W(0,0,1,1),this.shadowScissor=new W(0,0,1,1),this.projectionCompensation=0,this.face=t,this.visibleCasters=[],this.viewBindGroups=[]}destroy(){this.viewBindGroups.forEach(e=>{e.defaultUniformBuffer.destroy(),e.destroy()}),this.viewBindGroups.length=0}get shadowBuffer(){let e=this.shadowCamera.renderTarget;return e?this.light._isPcf?e.depthBuffer:e.colorBuffer:null}},Kh=class o{constructor(e,t){this.layers=new Set,this.shadowDepthState=$e.DEFAULT.clone(),this.clusteredFlags=0,this.clusteredData=new Uint32Array(3),this.clusteredData16=new Uint16Array(this.clusteredData.buffer),this._evtDeviceRestored=null,this.device=e,this.clusteredLighting=t,this.id=Hae++,this._evtDeviceRestored=e.on("devicerestored",this.onDeviceRestored,this),this._type=ge,this._color=new N(.8,.8,.8),this._intensity=1,this._affectSpecularity=!0,this._luminance=0,this._castShadows=!1,this._enabled=!1,this._mask=ps,this.isStatic=!1,this.key=0,this.bakeDir=!0,this.bakeNumSamples=1,this.bakeArea=0,this.attenuationStart=10,this.attenuationEnd=10,this._falloffMode=Lf,this._shadowType=Hs,this._vsmBlurSize=11,this.vsmBlurMode=yh,this.vsmBias=.01*.25,this._cookie=null,this.cookieIntensity=1,this._cookieFalloff=!0,this._cookieChannel="rgb",this._cookieTransform=null,this._cookieTransformUniform=new Float32Array(4),this._cookieOffset=null,this._cookieOffsetUniform=new Float32Array(2),this._cookieTransformSet=!1,this._cookieOffsetSet=!1,this._innerConeAngle=40,this._outerConeAngle=45,this.cascades=null,this._shadowMatrixPalette=null,this._shadowCascadeDistances=null,this.numCascades=1,this._cascadeBlend=0,this.cascadeDistribution=.5,this._shape=bs,this._colorLinear=new Float32Array(3),this._updateLinearColor(),this._position=new g(0,0,0),this._direction=new g(0,0,0),this._innerConeAngleCos=Math.cos(this._innerConeAngle*Math.PI/180),this._updateOuterAngle(this._outerConeAngle),this._usePhysicalUnits=void 0,this._shadowMap=null,this._shadowRenderParams=[],this._shadowCameraParams=[],this.shadowDistance=40,this._shadowResolution=1024,this._shadowBias=-5e-4,this._shadowIntensity=1,this._normalOffsetBias=0,this.shadowUpdateMode=Dh,this.shadowUpdateOverrides=null,this._isVsm=!1,this._isPcf=!0,this._softShadowParams=new Float32Array(4),this.shadowSamples=16,this.shadowBlockerSamples=16,this.penumbraSize=1,this.penumbraFalloff=1,this._cookieMatrix=null,this._atlasViewport=null,this.atlasViewportAllocated=!1,this.atlasVersion=0,this.atlasSlotIndex=0,this.atlasSlotUpdated=!1,this._node=null,this._renderData=[],this.visibleThisFrame=!1,this.maxScreenSize=0,this._updateShadowBias()}destroy(){this._evtDeviceRestored?.off(),this._evtDeviceRestored=null,this._destroyShadowMap(),this.releaseRenderData(),this._renderData=null}onDeviceRestored(){this.shadowUpdateMode===Ms&&(this.shadowUpdateMode=Di)}releaseRenderData(){if(this._renderData){for(let e=0;e<this._renderData.length;e++)this._renderData[e].destroy();this._renderData.length=0}}addLayer(e){this.layers.add(e)}removeLayer(e){this.layers.delete(e)}set shadowSamples(e){this._softShadowParams[0]=e}get shadowSamples(){return this._softShadowParams[0]}set shadowBlockerSamples(e){this._softShadowParams[1]=e}get shadowBlockerSamples(){return this._softShadowParams[1]}set shadowBias(e){this._shadowBias!==e&&(this._shadowBias=e,this._updateShadowBias())}get shadowBias(){return this._shadowBias}set numCascades(e){(!this.cascades||this.numCascades!==e)&&(this.cascades=Gae[e-1],this._shadowMatrixPalette=new Float32Array(64),this._shadowCascadeDistances=new Float32Array(4),this._destroyShadowMap(),this.updateKey())}get numCascades(){return this.cascades.length}set cascadeBlend(e){this._cascadeBlend!==e&&(this._cascadeBlend=e,this.updateKey())}get cascadeBlend(){return this._cascadeBlend}set shadowMap(e){this._shadowMap!==e&&(this._destroyShadowMap(),this._shadowMap=e)}get shadowMap(){return this._shadowMap}set mask(e){this._mask!==e&&(this._mask=e,this.updateKey(),this.updateClusteredFlags())}get mask(){return this._mask}get numShadowFaces(){let e=this._type;return e===ge?this.numCascades:e===Ge?6:1}set type(e){if(this._type===e)return;this._type=e,this._destroyShadowMap(),this._updateShadowBias(),this.updateKey(),this.updateClusteredFlags();let t=this._shadowType;this._shadowType=null,this.shadowUpdateOverrides=null,this.shadowType=t}get type(){return this._type}set shape(e){if(this._shape===e)return;this._shape=e,this._destroyShadowMap(),this.updateKey(),this.updateClusteredFlags();let t=this._shadowType;this._shadowType=null,this.shadowType=t}get shape(){return this._shape}set usePhysicalUnits(e){this._usePhysicalUnits!==e&&(this._usePhysicalUnits=e,this._updateLinearColor())}get usePhysicalUnits(){return this._usePhysicalUnits}set shadowType(e){if(this._shadowType===e)return;let t=gi.get(e);t||(e=Hs);let s=this.device;e===Za&&!s.textureFloatRenderable&&!s.textureHalfFloatRenderable&&(e=Hs),this._type===Ge&&e!==bS&&e!==Hs&&e!==MS&&e!==DS&&e!==Za&&(e=Hs),e===bf&&(!s.textureFloatRenderable||!s.textureFloatFilterable)&&(e=Am),e===Am&&!s.textureHalfFloatRenderable&&(e=Hs),t=gi.get(e),this._isVsm=t?.vsm??!1,this._isPcf=t?.pcf??!1,this._shadowType=e,this._destroyShadowMap(),this.updateKey()}get shadowType(){return this._shadowType}set enabled(e){this._enabled!==e&&(this._enabled=e,this.layersDirty())}get enabled(){return this._enabled}set castShadows(e){this._castShadows!==e&&(this._castShadows=e,this._destroyShadowMap(),this.layersDirty(),this.updateKey())}get castShadows(){return this._castShadows&&this._mask!==_a&&this._mask!==0}set shadowIntensity(e){this._shadowIntensity!==e&&(this._shadowIntensity=e,this.updateKey())}get shadowIntensity(){return this._shadowIntensity}get bakeShadows(){return this._castShadows&&this._mask===_a}set shadowResolution(e){this._shadowResolution!==e&&(this._type===Ge?e=Math.min(e,this.device.maxCubeMapSize):e=Math.min(e,this.device.maxTextureSize),this._shadowResolution=e,this._destroyShadowMap())}get shadowResolution(){return this._shadowResolution}set vsmBlurSize(e){this._vsmBlurSize!==e&&(e%2===0&&e++,this._vsmBlurSize=e)}get vsmBlurSize(){return this._vsmBlurSize}set normalOffsetBias(e){if(this._normalOffsetBias!==e){let t=!this._normalOffsetBias&&e||this._normalOffsetBias&&!e;this._normalOffsetBias=e,t&&this.updateKey()}}get normalOffsetBias(){return this._normalOffsetBias}set falloffMode(e){this._falloffMode!==e&&(this._falloffMode=e,this.updateKey(),this.updateClusteredFlags())}get falloffMode(){return this._falloffMode}set innerConeAngle(e){this._innerConeAngle!==e&&(this._innerConeAngle=e,this._innerConeAngleCos=Math.cos(e*Math.PI/180),this.updateClusterData(!1,!0),this._usePhysicalUnits&&this._updateLinearColor())}get innerConeAngle(){return this._innerConeAngle}set outerConeAngle(e){this._outerConeAngle!==e&&(this._outerConeAngle=e,this._updateOuterAngle(e),this._usePhysicalUnits&&this._updateLinearColor())}get outerConeAngle(){return this._outerConeAngle}set penumbraSize(e){this._penumbraSize=e,this._softShadowParams[2]=e}get penumbraSize(){return this._penumbraSize}set penumbraFalloff(e){this._softShadowParams[3]=e}get penumbraFalloff(){return this._softShadowParams[3]}_updateOuterAngle(e){let t=e*Math.PI/180;this._outerConeAngleCos=Math.cos(t),this._outerConeAngleSin=Math.sin(t),this.updateClusterData(!1,!0)}set intensity(e){this._intensity!==e&&(this._intensity=e,this._updateLinearColor())}get intensity(){return this._intensity}set affectSpecularity(e){this._type===ge&&(this._affectSpecularity=e,this.updateKey())}get affectSpecularity(){return this._affectSpecularity}set luminance(e){this._luminance!==e&&(this._luminance=e,this._updateLinearColor())}get luminance(){return this._luminance}get cookieMatrix(){return this._cookieMatrix||(this._cookieMatrix=new k),this._cookieMatrix}get atlasViewport(){return this._atlasViewport||(this._atlasViewport=new W(0,0,1,1)),this._atlasViewport}set cookie(e){this._cookie!==e&&(this._cookie=e,this.updateKey())}get cookie(){return this._cookie}set cookieFalloff(e){this._cookieFalloff!==e&&(this._cookieFalloff=e,this.updateKey())}get cookieFalloff(){return this._cookieFalloff}set cookieChannel(e){if(this._cookieChannel!==e){if(e.length<3){let t=e.charAt(e.length-1),s=3-e.length;for(let i=0;i<s;i++)e+=t}this._cookieChannel=e,this.updateKey(),this.updateClusteredFlags()}}get cookieChannel(){return this._cookieChannel}set cookieTransform(e){this._cookieTransform!==e&&(this._cookieTransform=e,this._cookieTransformSet=!!e,e&&!this._cookieOffset&&(this.cookieOffset=new D,this._cookieOffsetSet=!1),this.updateKey())}get cookieTransform(){return this._cookieTransform}set cookieOffset(e){if(this._cookieOffset===e)return;!!(this._cookieTransformSet||e)&&!e&&this._cookieOffset?this._cookieOffset.set(0,0):this._cookieOffset=e,this._cookieOffsetSet=!!e,e&&!this._cookieTransform&&(this.cookieTransform=new W(1,1,0,0),this._cookieTransformSet=!1),this.updateKey()}get cookieOffset(){return this._cookieOffset}beginFrame(){this.visibleThisFrame=this._type===ge&&this._enabled,this.maxScreenSize=0,this.atlasViewportAllocated=!1,this.atlasSlotUpdated=!1}_destroyShadowMap(){if(this.releaseRenderData(),this._shadowMap&&(this._shadowMap.cached||this._shadowMap.destroy(),this._shadowMap=null),this.shadowUpdateMode===Ms&&(this.shadowUpdateMode=Di),this.shadowUpdateOverrides)for(let e=0;e<this.shadowUpdateOverrides.length;e++)this.shadowUpdateOverrides[e]===Ms&&(this.shadowUpdateOverrides[e]=Di)}getRenderData(e,t){for(let i=0;i<this._renderData.length;i++){let r=this._renderData[i];if(r.camera===e&&r.face===t)return r}let s=new WL(e,t,this);return this._renderData.push(s),s}clone(){let e=new o(this.device,this.clusteredLighting);return e.type=this._type,e.setColor(this._color),e.intensity=this._intensity,e.affectSpecularity=this._affectSpecularity,e.luminance=this._luminance,e.castShadows=this.castShadows,e._enabled=this._enabled,e.attenuationStart=this.attenuationStart,e.attenuationEnd=this.attenuationEnd,e.falloffMode=this._falloffMode,e.shadowType=this._shadowType,e.vsmBlurSize=this._vsmBlurSize,e.vsmBlurMode=this.vsmBlurMode,e.vsmBias=this.vsmBias,e.shadowUpdateMode=this.shadowUpdateMode,e.mask=this.mask,this.shadowUpdateOverrides&&(e.shadowUpdateOverrides=this.shadowUpdateOverrides.slice()),e.innerConeAngle=this._innerConeAngle,e.outerConeAngle=this._outerConeAngle,e.numCascades=this.numCascades,e.cascadeDistribution=this.cascadeDistribution,e.cascadeBlend=this._cascadeBlend,e.shape=this._shape,e.shadowDepthState.copy(this.shadowDepthState),e.shadowBias=this.shadowBias,e.normalOffsetBias=this._normalOffsetBias,e.shadowResolution=this._shadowResolution,e.shadowDistance=this.shadowDistance,e.shadowIntensity=this.shadowIntensity,e.shadowSamples=this.shadowSamples,e.shadowBlockerSamples=this.shadowBlockerSamples,e.penumbraSize=this.penumbraSize,e.penumbraFalloff=this.penumbraFalloff,e}static getLightUnitConversion(e,t=Math.PI/4,s=0){switch(e){case Ye:{let i=Math.cos(t),r=Math.cos(s);return 2*Math.PI*(1-r+(r-i)/2)}case Ge:return 4*Math.PI;case ge:return 1}}_getUniformBiasValues(e){let t=e.shadowCamera._farClip;switch(this._type){case Ge:ol.bias=this.shadowBias,ol.normalBias=this._normalOffsetBias;break;case Ye:this._isVsm?ol.bias=-1e-5*20:ol.bias=this.shadowBias*20,ol.normalBias=this._isVsm?this.vsmBias/(this.attenuationEnd/7):this._normalOffsetBias;break;case ge:this._isVsm?ol.bias=-1e-5*20:ol.bias=this.shadowBias/t*100,ol.normalBias=this._isVsm?this.vsmBias/(t/7):this._normalOffsetBias;break}return ol}getColor(){return this._color}getBoundingSphere(e){if(this._type===Ye){let t=this.attenuationEnd,s=this._outerConeAngle,i=this._outerConeAngleCos,r=this._node;fA.copy(r.up),s>45?(e.radius=t*this._outerConeAngleSin,fA.mulScalar(-t*i)):(e.radius=t/(2*i),fA.mulScalar(-e.radius)),e.center.add2(r.getPosition(),fA)}else this._type===Ge&&(e.center=this._node.getPosition(),e.radius=this.attenuationEnd)}getBoundingBox(e){if(this._type===Ye){let t=this.attenuationEnd,s=this._outerConeAngle,i=this._node,r=Math.abs(Math.sin(s*w.DEG_TO_RAD)*t);e.center.set(0,-t*.5,0),e.halfExtents.set(r,t*.5,r),e.setFromTransformedAabb(e,i.getWorldTransform(),!0)}else this._type===Ge&&(e.center.copy(this._node.getPosition()),e.halfExtents.set(this.attenuationEnd,this.attenuationEnd,this.attenuationEnd))}_updateShadowBias(){if(this._type===Ge&&!this.clusteredLighting)this.shadowDepthState.depthBias=0,this.shadowDepthState.depthBiasSlope=0;else{let e=this.shadowBias*-1e3;this.shadowDepthState.depthBias=e,this.shadowDepthState.depthBiasSlope=e}}_updateLinearColor(){let e=this._intensity;this._usePhysicalUnits&&(e=this._luminance/o.getLightUnitConversion(this._type,this._outerConeAngle*w.DEG_TO_RAD,this._innerConeAngle*w.DEG_TO_RAD));let t=this._color,s=this._colorLinear;e>=1?QS.linear(t).mulScalar(e):QS.copy(t).mulScalar(e).linear(),s[0]=QS.r,s[1]=QS.g,s[2]=QS.b,this.updateClusterData(!0)}setColor(){arguments.length===1?this._color.set(arguments[0].r,arguments[0].g,arguments[0].b):arguments.length===3&&this._color.set(arguments[0],arguments[1],arguments[2]),this._updateLinearColor()}layersDirty(){this.layers.forEach(e=>{e.hasLight(this)&&e.markLightsDirty()})}updateKey(){let e=this._type<<29|this._shadowType<<25|this._falloffMode<<23|(this._normalOffsetBias!==0?1:0)<<22|(this._cookie?1:0)<<21|(this._cookieFalloff?1:0)<<20|XL[this._cookieChannel.charAt(0)]<<18|(this._cookieTransform?1:0)<<12|this._shape<<10|(this.numCascades>0?1:0)<<9|(this._cascadeBlend>0?1:0)<<8|(this.affectSpecularity?1:0)<<7|this.mask<<6|(this._castShadows?1:0)<<3;this._cookieChannel.length===3&&(e|=XL[this._cookieChannel.charAt(1)]<<16,e|=XL[this._cookieChannel.charAt(2)]<<14),e!==this.key&&this.layersDirty(),this.key=e}updateClusteredFlags(){let e=!!(this.mask&ps),t=!!(this.mask&ir);this.clusteredFlags=(this.type===Ye?1:0)<<30|(this._shape&3)<<28|(this._falloffMode&1)<<27|(zae[this._cookieChannel]??0)<<23|(e?1:0)<<22|(t?1:0)<<21}getClusteredFlags(e,t){return this.clusteredFlags|((e?Math.floor(this.shadowIntensity*255):0)&255)<<0|((t?Math.floor(this.cookieIntensity*255):0)&255)<<8}updateClusterData(e,t){let{clusteredData16:s}=this,i=Bs.float2Half;e&&(s[0]=i(w.clamp(this._colorLinear[0]/xh,0,65504)),s[1]=i(w.clamp(this._colorLinear[1]/xh,0,65504)),s[2]=i(w.clamp(this._colorLinear[2]/xh,0,65504))),t&&(s[4]=i(this._innerConeAngleCos),s[5]=i(this._outerConeAngleCos))}}});var qh,uA=m(()=>{me();Q();J();qh=class{constructor(e,t,s){this._areaLightsEnabled=!1,this._cells=new g(10,3,10),this._maxLightsPerCell=255,this._shadowsEnabled=!0,this._shadowType=Hs,this._shadowAtlasResolution=2048,this._cookiesEnabled=!1,this._cookieAtlasResolution=2048,this.atlasSplit=null,this._supportsAreaLights=e,this._maxTextureSize=t,this._dirtyLightsFnc=s}applySettings(e){this.shadowsEnabled=e.lightingShadowsEnabled??this.shadowsEnabled,this.cookiesEnabled=e.lightingCookiesEnabled??this.cookiesEnabled,this.areaLightsEnabled=e.lightingAreaLightsEnabled??this.areaLightsEnabled,this.shadowAtlasResolution=e.lightingShadowAtlasResolution??this.shadowAtlasResolution,this.cookieAtlasResolution=e.lightingCookieAtlasResolution??this.cookieAtlasResolution,this.maxLightsPerCell=e.lightingMaxLightsPerCell??this.maxLightsPerCell,this.shadowType=e.lightingShadowType??this.shadowType,e.lightingCells&&(this.cells=new g(e.lightingCells))}set cells(e){this._cells.copy(e)}get cells(){return this._cells}set maxLightsPerCell(e){this._maxLightsPerCell=w.clamp(e,1,255)}get maxLightsPerCell(){return this._maxLightsPerCell}set cookieAtlasResolution(e){this._cookieAtlasResolution=w.clamp(e,32,this._maxTextureSize)}get cookieAtlasResolution(){return this._cookieAtlasResolution}set shadowAtlasResolution(e){this._shadowAtlasResolution=w.clamp(e,32,this._maxTextureSize)}get shadowAtlasResolution(){return this._shadowAtlasResolution}set shadowType(e){this._shadowType!==e&&(this._shadowType=e,this._dirtyLightsFnc())}get shadowType(){return this._shadowType}set cookiesEnabled(e){this._cookiesEnabled!==e&&(this._cookiesEnabled=e,this._dirtyLightsFnc())}get cookiesEnabled(){return this._cookiesEnabled}set areaLightsEnabled(e){this._supportsAreaLights&&this._areaLightsEnabled!==e&&(this._areaLightsEnabled=e,this._dirtyLightsFnc())}get areaLightsEnabled(){return this._areaLightsEnabled}set shadowsEnabled(e){this._shadowsEnabled!==e&&(this._shadowsEnabled=e,this._dirtyLightsFnc())}get shadowsEnabled(){return this._shadowsEnabled}}});var br,Km=m(()=>{j();Ea();Rt();Dt();qt();br=class o{constructor(e){this.morph=e,e.incRefCount(),this.device=e.device;let t=e._targets.length;this.shader=this._createShader(t),this._weights=[],this._weightMap=new Map;for(let a=0;a<e._targets.length;a++){let n=e._targets[a];n.name&&this._weightMap.set(n.name,a),this.setWeight(a,n.defaultWeight)}this._shaderMorphWeights=new Float32Array(t),this._shaderMorphIndex=new Uint32Array(t);let s=(a,n)=>(this[n]=e._createTexture(a,e._renderTextureFormat),new xe({colorBuffer:this[n],depth:!1}));e.morphPositions&&(this.rtPositions=s("MorphRTPos","texturePositions")),e.morphNormals&&(this.rtNormals=s("MorphRTNrm","textureNormals")),this._textureParams=new Float32Array([e.morphTextureWidth,e.morphTextureHeight]);let i=e.aabb.halfExtents;this._aabbSize=new Float32Array([i.x*4,i.y*4,i.z*4]);let r=e.aabb.getMin();this._aabbMin=new Float32Array([r.x*2,r.y*2,r.z*2]),this._aabbNrmSize=new Float32Array([2,2,2]),this._aabbNrmMin=new Float32Array([-1,-1,-1]),this.aabbSizeId=this.device.scope.resolve("aabbSize"),this.aabbMinId=this.device.scope.resolve("aabbMin"),this.morphTextureId=this.device.scope.resolve("morphTexture"),this.morphFactor=this.device.scope.resolve("morphFactor[0]"),this.morphIndex=this.device.scope.resolve("morphIndex[0]"),this.countId=this.device.scope.resolve("count"),this.zeroTextures=!1}destroy(){this.shader=null;let e=this.morph;e&&(this.morph=null,e.decRefCount(),e.refCount<1&&e.destroy()),this.rtPositions?.destroy(),this.rtPositions=null,this.texturePositions?.destroy(),this.texturePositions=null,this.rtNormals?.destroy(),this.rtNormals=null,this.textureNormals?.destroy(),this.textureNormals=null}clone(){return new o(this.morph)}_getWeightIndex(e){return typeof e=="string"?this._weightMap.get(e):e}getWeight(e){let t=this._getWeightIndex(e);return this._weights[t]}setWeight(e,t){let s=this._getWeightIndex(e);this._weights[s]=t,this._dirty=!0}_createShader(e){let t=new Map;t.set("{MORPH_TEXTURE_MAX_COUNT}",e),this.morph.intRenderFormat&&t.set("MORPH_INT","");let s=this.morph.intRenderFormat?"uvec4":"vec4";return Te.createShader(this.device,{uniqueName:`TextureMorphShader_${e}-${this.morph.intRenderFormat?"int":"float"}`,attributes:{vertex_position:te},vertexChunk:"morphVS",fragmentChunk:"morphPS",fragmentDefines:t,fragmentOutputTypes:[s]})}_updateTextureRenderTarget(e,t,s){let{morph:i,device:r}=this;this.setAabbUniforms(s),this.morphTextureId.setValue(s?i.targetsTexturePositions:i.targetsTextureNormals),r.setBlendState(Ie.NOBLEND),this.countId.setValue(t),this.morphFactor.setValue(this._shaderMorphWeights),this.morphIndex.setValue(this._shaderMorphIndex),Ot(r,e,this.shader)}_updateTextureMorph(e){this.device,(e>0||!this.zeroTextures)&&(this.rtPositions&&this._updateTextureRenderTarget(this.rtPositions,e,!0),this.rtNormals&&this._updateTextureRenderTarget(this.rtNormals,e,!1),this.zeroTextures=e===0)}setAabbUniforms(e=!0){this.aabbSizeId.setValue(e?this._aabbSize:this._aabbNrmSize),this.aabbMinId.setValue(e?this._aabbMin:this._aabbNrmMin)}prepareRendering(e){this.setAabbUniforms()}update(){this._dirty=!1;let e=this.morph._targets,t=1e-5,s=this._shaderMorphWeights,i=this._shaderMorphIndex,r=0;for(let a=0;a<e.length;a++)Math.abs(this.getWeight(a))>t&&(s[r]=this.getWeight(a),i[r]=a,r++);this._updateTextureMorph(r)}}});var Ys,ll=m(()=>{J();_s();Km();Wf();Ys=class o{constructor(){this.graph=null,this.meshInstances=[],this.skinInstances=[],this.morphInstances=[],this.cameras=[],this.lights=[],this._shadersVersion=0,this._immutable=!1}getGraph(){return this.graph}setGraph(e){this.graph=e}getCameras(){return this.cameras}setCameras(e){this.cameras=e}getLights(){return this.lights}setLights(e){this.lights=e}getMaterials(){let e=[];for(let t=0;t<this.meshInstances.length;t++){let s=this.meshInstances[t];e.indexOf(s.material)===-1&&e.push(s.material)}return e}clone(){let e=[],t=[],s=function(h){let c=h.clone();e.push(h),t.push(c);for(let f=0;f<h._children.length;f++)c.addChild(s(h._children[f]));return c},i=s(this.graph),r=[],a=[],n=[];for(let h=0;h<this.skinInstances.length;h++){let c=this.skinInstances[h].skin,f=new ar(c),d=[];for(let u=0;u<c.boneNames.length;u++){let p=c.boneNames[u],_=i.findByName(p);d.push(_)}f.bones=d,a.push(f)}for(let h=0;h<this.morphInstances.length;h++){let c=this.morphInstances[h].morph,f=new br(c);n.push(f)}for(let h=0;h<this.meshInstances.length;h++){let c=this.meshInstances[h],f=e.indexOf(c.node),d=new Oe(c.mesh,c.material,t[f]);if(c.skinInstance){let u=this.skinInstances.indexOf(c.skinInstance);d.skinInstance=a[u]}if(c.morphInstance){let u=this.morphInstances.indexOf(c.morphInstance);d.morphInstance=n[u]}r.push(d)}let l=new o;return l.graph=i,l.meshInstances=r,l.skinInstances=a,l.morphInstances=n,l.getGraph().syncHierarchy(),l}destroy(){let e=this.meshInstances;for(let t=0;t<e.length;t++)e[t].destroy();this.meshInstances.length=0}generateWireframe(){Oe._prepareRenderStyleForArray(this.meshInstances,Ja)}}});var po,eT=m(()=>{mS();Q();$l();Vt();j();Fe();$i();Cr();po=class extends eo{constructor(e,t,{preferHighPrecision:s=!1}={}){super(),this.device=t;let i=t;this.preferHighPrecision=s,this._targets=e.slice();let r=i.textureHalfFloatRenderable?12:void 0,a=i.textureFloatRenderable?14:void 0;this._renderTextureFormat=this.preferHighPrecision?a??r:r??a,this._renderTextureFormat=this._renderTextureFormat??47,this.intRenderFormat=Xi(this._renderTextureFormat),this._textureFormat=this.preferHighPrecision?14:12,this._init(),this._updateMorphFlags()}destroy(){this.vertexBufferIds?.destroy(),this.vertexBufferIds=null,this.targetsTexturePositions?.destroy(),this.targetsTexturePositions=null,this.targetsTextureNormals?.destroy(),this.targetsTextureNormals=null}get aabb(){if(!this._aabb){let e=new g,t=new g;for(let s=0;s<this._targets.length;s++){let i=this._targets[s].aabb;e.min(i.getMin()),t.max(i.getMax())}this._aabb=new _e,this._aabb.setMinMax(e,t)}return this._aabb}get morphPositions(){return this._morphPositions}get morphNormals(){return this._morphNormals}_init(){this._initTextureBased();for(let e=0;e<this._targets.length;e++)this._targets[e]._postInit()}_findSparseSet(e,t,s){let i=1,r=e[0].length;for(let a=0;a<r;a+=3){let n=!1;for(let l=0;l<e.length;l++){let h=e[l];if(h[a]!==0||h[a+1]!==0||h[a+2]!==0){n=!0;break}}n?(t.push(i),s.push(a/3),i++):t.push(0)}return i}_initTextureBased(){let e=[],t=[],s=this._targets;for(let S=0;S<s.length;S++){let T=s[S];T.options.deltaPositions&&(e.push(T.options.deltaPositions),t.push(!0)),T.options.deltaNormals&&(e.push(T.options.deltaNormals),t.push(!1))}let i=[],r=[],a=this._findSparseSet(e,i,r),n=this.device.maxTextureSize,l=Math.ceil(Math.sqrt(a));l=Math.min(l,n);let h=Math.ceil(a/l);if(h>n)return;this.morphTextureWidth=l,this.morphTextureHeight=h;let c=!1,f=Bs.float2Half;this._textureFormat===12&&(c=!0);let d=[],u=[],p=l*h*4;for(let S=0;S<e.length;S++){let T=e[S],x=this._textureFormat===12?new Uint16Array(p):new Float32Array(p);if((t[S]?d:u).push(x),c)for(let A=0;A<r.length;A++){let E=r[A]*3,v=A*4+4;x[v]=f(T[E]),x[v+1]=f(T[E+1]),x[v+2]=f(T[E+2])}else for(let A=0;A<r.length;A++){let E=r[A]*3,v=A*4+4;x[v]=T[E],x[v+1]=T[E+1],x[v+2]=T[E+2]}}d.length>0&&(this.targetsTexturePositions=this._createTexture("MorphPositionsTexture",this._textureFormat,s.length,[d]),this.targetsTexturePositions.upload()),u.length>0&&(this.targetsTextureNormals=this._createTexture("MorphNormalsTexture",this._textureFormat,s.length,[u]),this.targetsTextureNormals.upload());let _=[{semantic:ta,components:1,type:gt,asInt:!0}];return this.vertexBufferIds=new mt(this.device,new Tt(this.device,_,i.length),i.length,{data:new Uint32Array(i)}),!0}get targets(){return this._targets}_updateMorphFlags(){this._morphPositions=!1,this._morphNormals=!1;for(let e=0;e<this._targets.length;e++){let t=this._targets[e];t.morphPositions&&(this._morphPositions=!0),t.morphNormals&&(this._morphNormals=!0)}}_createTexture(e,t,s,i){return new q(this.device,{levels:i,arrayLength:s,width:this.morphTextureWidth,height:this.morphTextureHeight,format:t,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1,name:e})}}});var jh,mA=m(()=>{Vt();jh=class o{constructor(e){this.used=!1,this.options=e,this._name=e.name,this._defaultWeight=e.defaultWeight||0,this._aabb=e.aabb,this.deltaPositions=e.deltaPositions,this.morphPositions=!!e.deltaPositions,this.morphNormals=!!e.deltaNormals}get name(){return this._name}get defaultWeight(){return this._defaultWeight}get aabb(){return this._aabb||(this._aabb=new _e,this.deltaPositions&&this._aabb.compute(this.deltaPositions)),this._aabb}clone(){return new o(this.options)}_postInit(){this.options.preserveData||(this.options=null),this.used=!0}}});function Zm(o){return o-Math.floor(o)}function Xae(o){return Math.max(Math.min(o,1),0)}function qL(o,e){return o-e*Math.floor(o/e)}function Wae(o){let e=Zm(o),t=Zm(255*o),s=Zm(65025*o),i=Zm(160581375*o);return e-=t/255,t-=s/255,s-=i/255,i-=i/255,[e,t,s,i]}function _A(o){let e=Zm(o),t=Zm(255*o);return e-=t/255,t-=t/255,[e,t]}var hl,eV,Se,YL,KL,_o,Nt,rn,qm,Mr,ns,jm,$m,tT,tV,xi,pA,$f,gA,sV=m(()=>{me();Ke();Q();J();eV=1,Se=4,YL=new k,KL=new k,_o=new g,Nt=new g,rn=new g,qm=new g,Mr=new g,ns=new g,jm=new g,$m=new g,tT=new g,tV=new g,xi=new g,pA=new g,$f=new g;gA=class{constructor(e){this._emitter=e}calcSpawnPosition(e,t,s,i,r){let a=this._emitter,n=Math.random(),l=Math.random(),h=Math.random(),c=Math.random();if(a.useCpu&&(e[r*Se+0+a.numParticlesPot*2*Se]=n,e[r*Se+1+a.numParticlesPot*2*Se]=l,e[r*Se+2+a.numParticlesPot*2*Se]=h),Nt.x=n-.5,Nt.y=l-.5,Nt.z=h-.5,a.emitterShape===Si){let u=Math.max(Math.abs(Nt.x),Math.max(Math.abs(Nt.y),Math.abs(Nt.z))),p=u+(.5-u)*s[0],_=u+(.5-u)*s[1],S=u+(.5-u)*s[2];Nt.x=p*(u===Math.abs(Nt.x)?Math.sign(Nt.x):2*Nt.x),Nt.y=_*(u===Math.abs(Nt.y)?Math.sign(Nt.y):2*Nt.y),Nt.z=S*(u===Math.abs(Nt.z)?Math.sign(Nt.z):2*Nt.z),a.localSpace?_o.copy(t.transformPoint(Nt)):_o.copy(i).add(t.transformPoint(Nt))}else{Nt.normalize();let u=a.emitterRadius===0?0:a.emitterRadiusInner/a.emitterRadius,p=c*(1-u)+u;a.localSpace?_o.copy(Nt.mulScalar(p*a.emitterRadius)):_o.copy(i).add(Nt.mulScalar(p*a.emitterRadius))}let d=-w.lerp(a.rate,a.rate2,n)*r;if(a.pack8){let u=(_o.x-a.worldBounds.center.x)/a.worldBoundsSize.x+.5,p=(_o.y-a.worldBounds.center.y)/a.worldBoundsSize.y+.5,_=(_o.z-a.worldBounds.center.z)/a.worldBoundsSize.z+.5,S=w.lerp(a.startAngle*w.DEG_TO_RAD,a.startAngle2*w.DEG_TO_RAD,n);S=S%(Math.PI*2)/(Math.PI*2);let T=_A(u);e[r*Se]=T[0],e[r*Se+1]=T[1];let x=_A(p);e[r*Se+2]=x[0],e[r*Se+3]=x[1];let A=_A(_);e[r*Se+0+a.numParticlesPot*Se]=A[0],e[r*Se+1+a.numParticlesPot*Se]=A[1];let E=_A(S);e[r*Se+2+a.numParticlesPot*Se]=E[0],e[r*Se+3+a.numParticlesPot*Se]=E[1];let v=1;e[r*Se+3+a.numParticlesPot*Se*2]=v;let R=Math.max(a.lifetime,(a.numParticles-1)*Math.max(a.rate,a.rate2)),P=a.lifetime+1;d=(d+R)/(R+P);let y=Wae(d);e[r*Se+0+a.numParticlesPot*Se*3]=y[0],e[r*Se+1+a.numParticlesPot*Se*3]=y[1],e[r*Se+2+a.numParticlesPot*Se*3]=y[2],e[r*Se+3+a.numParticlesPot*Se*3]=y[3]}else e[r*Se]=_o.x,e[r*Se+1]=_o.y,e[r*Se+2]=_o.z,e[r*Se+3]=w.lerp(a.startAngle*w.DEG_TO_RAD,a.startAngle2*w.DEG_TO_RAD,n),e[r*Se+3+a.numParticlesPot*Se]=d}update(e,t,s,i,r,a,n,l){let h,c,f,d=this._emitter;if(d.meshInstance.node){let C=d.meshInstance.node.worldTransform;for(let L=0;L<12;L++)YL.data[L]=C.data[L];KL.copy(YL),KL.invert(),hl=d.meshInstance.node.localScale,eV=Math.max(Math.max(hl.x,hl.y),hl.z)}a=d.meshInstance.node===null||d.localSpace?g.ZERO:d.meshInstance.node.getPosition();let u=d.camera?d.camera._node.getPosition():g.ZERO,p=d.useMesh?17:15,_,S,T,x,A,E,v,R,P,y=d.precision-1;for(let C=0;C<d.numParticles;C++){let L=Math.floor(d.vbCPU[C*d.numParticleVerts*(d.useMesh?6:4)+3]),O=s[L*Se+0+d.numParticlesPot*2*Se];rn.x=O,rn.y=s[L*Se+1+d.numParticlesPot*2*Se],rn.z=s[L*Se+2+d.numParticlesPot*2*Se];let M=d.rate+(d.rate2-d.rate)*O,U=d.lifetime,G=s[L*Se+3+d.numParticlesPot*Se]+n,$=Xae(G/U),X=0,I=0,b=0;(G-n<=0||G>=U)&&this.calcSpawnPosition(s,i,r,a,L);let B=G>0&&G<U;B&&(f=$*y,_=Math.floor(f),S=Math.ceil(f),f%=1,h=d.qRotSpeed[_],c=d.qRotSpeed[S],T=h+(c-h)*f,h=d.qRotSpeed2[_],c=d.qRotSpeed2[S],x=h+(c-h)*f,h=d.qScale[_],c=d.qScale[S],X=h+(c-h)*f,h=d.qScale2[_],c=d.qScale2[S],A=h+(c-h)*f,h=d.qAlpha[_],c=d.qAlpha[S],E=h+(c-h)*f,h=d.qAlpha2[_],c=d.qAlpha2[S],v=h+(c-h)*f,h=d.qRadialSpeed[_],c=d.qRadialSpeed[S],R=h+(c-h)*f,h=d.qRadialSpeed2[_],c=d.qRadialSpeed2[S],P=h+(c-h)*f,R+=(P-R)*(O*100%1),qm.x=s[L*Se],qm.y=s[L*Se+1],qm.z=s[L*Se+2],d.localSpace?tT.copy(qm):tT.copy(qm).sub(a),tT.normalize().mulScalar(R),_*=3,S*=3,h=d.qLocalVelocity[_],c=d.qLocalVelocity[S],ns.x=h+(c-h)*f,h=d.qLocalVelocity[_+1],c=d.qLocalVelocity[S+1],ns.y=h+(c-h)*f,h=d.qLocalVelocity[_+2],c=d.qLocalVelocity[S+2],ns.z=h+(c-h)*f,h=d.qLocalVelocity2[_],c=d.qLocalVelocity2[S],$m.x=h+(c-h)*f,h=d.qLocalVelocity2[_+1],c=d.qLocalVelocity2[S+1],$m.y=h+(c-h)*f,h=d.qLocalVelocity2[_+2],c=d.qLocalVelocity2[S+2],$m.z=h+(c-h)*f,h=d.qVelocity[_],c=d.qVelocity[S],Mr.x=h+(c-h)*f,h=d.qVelocity[_+1],c=d.qVelocity[S+1],Mr.y=h+(c-h)*f,h=d.qVelocity[_+2],c=d.qVelocity[S+2],Mr.z=h+(c-h)*f,h=d.qVelocity2[_],c=d.qVelocity2[S],jm.x=h+(c-h)*f,h=d.qVelocity2[_+1],c=d.qVelocity2[S+1],jm.y=h+(c-h)*f,h=d.qVelocity2[_+2],c=d.qVelocity2[S+2],jm.z=h+(c-h)*f,ns.x+=($m.x-ns.x)*rn.x,ns.y+=($m.y-ns.y)*rn.y,ns.z+=($m.z-ns.z)*rn.z,d.initialVelocity>0&&(d.emitterShape===dy?(Nt.copy(rn).mulScalar(2).sub(g.ONE).normalize(),ns.add(Nt.mulScalar(d.initialVelocity))):ns.add(g.FORWARD.mulScalar(d.initialVelocity))),Mr.x+=(jm.x-Mr.x)*rn.x,Mr.y+=(jm.y-Mr.y)*rn.y,Mr.z+=(jm.z-Mr.z)*rn.z,T+=(x-T)*rn.y,X=(X+(A-X)*(O*1e4%1))*eV,I=(v-E)*(O*1e3%1),d.meshInstance.node&&(d.localSpace?(ns.x/=hl.x,ns.y/=hl.y,ns.z/=hl.z):YL.transformPoint(ns,ns)),d.localSpace?(KL.transformPoint(Mr,Mr),ns.add(Mr).add(tT)):(ns.add(Mr.mul(hl)),ns.add(tT.mul(hl))),pA.copy(ns),tV.copy(qm).add(ns.mulScalar(n)),xi.copy(tV),s[L*Se]=xi.x,s[L*Se+1]=xi.y,s[L*Se+2]=xi.z,s[L*Se+3]+=T*n,d.wrap&&d.wrapBounds&&(d.localSpace||xi.sub(a),xi.x=qL(xi.x,d.wrapBounds.x)-d.wrapBounds.x*.5,xi.y=qL(xi.y,d.wrapBounds.y)-d.wrapBounds.y*.5,xi.z=qL(xi.z,d.wrapBounds.z)-d.wrapBounds.z*.5,d.localSpace||xi.add(a)),d.sort>0&&(d.sort===1?($f.copy(xi).sub(u),d.particleDistance[L]=-($f.x*$f.x+$f.y*$f.y+$f.z*$f.z)):d.sort===2?d.particleDistance[L]=G:d.sort===3&&(d.particleDistance[L]=-G))),l?G<0&&(s[L*Se+3+d.numParticlesPot*2*Se]=-1):(G>=U&&(G-=Math.max(U,(d.numParticles-1)*M),s[L*Se+3+d.numParticlesPot*2*Se]=d.loop?1:-1),G<0&&d.loop&&(s[L*Se+3+d.numParticlesPot*2*Se]=1)),s[L*Se+3+d.numParticlesPot*2*Se]<0&&(B=!1),s[L*Se+3+d.numParticlesPot*Se]=G;for(let V=0;V<d.numParticleVerts;V++){let z=(C*d.numParticleVerts+V)*(d.useMesh?6:4),ee=d.vbCPU[z],se=d.vbCPU[z+1],Y=d.vbCPU[z+2];B||(ee=se=Y=0);let ne=C*d.numParticleVerts*p+V*p;e[ne]=xi.x,e[ne+1]=xi.y,e[ne+2]=xi.z,e[ne+3]=$,e[ne+4]=d.alignToMotion?b:s[L*Se+3],e[ne+5]=X,e[ne+6]=I,e[ne+7]=pA.x,e[ne+8]=ee,e[ne+9]=se,e[ne+10]=Y,e[ne+11]=pA.y,e[ne+12]=L,e[ne+13]=pA.z,e[ne+14]=d.vbCPU[z+3],d.useMesh&&(e[ne+15]=d.vbCPU[z+4],e[ne+16]=d.vbCPU[z+5])}}if(d.sort>Mf&&d.camera){let C=d.useMesh?6:4,L=d.particleDistance;for(let O=0;O<d.numParticles;O++)t[O][0]=O,t[O][1]=L[Math.floor(d.vbCPU[O*d.numParticleVerts*C+3])];d.vbOld.set(d.vbCPU),t.sort((O,M)=>O[1]-M[1]);for(let O=0;O<d.numParticles;O++){let M=t[O][0]*d.numParticleVerts*C,U=O*d.numParticleVerts*C;for(let G=0;G<d.numParticleVerts*C;G++)d.vbCPU[U+G]=d.vbOld[M+G]}}}}});var iV,rV,aV,SA,nV=m(()=>{me();Zl();Ke();Q();qt();ii();Ea();J();iV=new Vs,rV=new Vs,aV=new Vs,SA=class{constructor(e,t){this._emitter=e,this.frameRandomUniform=new Float32Array(3),this.emitterPosUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),this.worldBoundsMulUniform=new Float32Array(3),this.worldBoundsAddUniform=new Float32Array(3),this.inBoundsSizeUniform=new Float32Array(3),this.inBoundsCenterUniform=new Float32Array(3),this.constantParticleTexIN=t.scope.resolve("particleTexIN"),this.constantParticleTexOUT=t.scope.resolve("particleTexOUT"),this.constantEmitterPos=t.scope.resolve("emitterPos"),this.constantEmitterScale=t.scope.resolve("emitterScale"),this.constantSpawnBounds=t.scope.resolve("spawnBounds"),this.constantSpawnPosInnerRatio=t.scope.resolve("spawnPosInnerRatio"),this.constantSpawnBoundsSphere=t.scope.resolve("spawnBoundsSphere"),this.constantSpawnBoundsSphereInnerRatio=t.scope.resolve("spawnBoundsSphereInnerRatio"),this.constantInitialVelocity=t.scope.resolve("initialVelocity"),this.constantFrameRandom=t.scope.resolve("frameRandom"),this.constantDelta=t.scope.resolve("delta"),this.constantRate=t.scope.resolve("rate"),this.constantRateDiv=t.scope.resolve("rateDiv"),this.constantLifetime=t.scope.resolve("lifetime"),this.constantGraphSampleSize=t.scope.resolve("graphSampleSize"),this.constantGraphNumSamples=t.scope.resolve("graphNumSamples"),this.constantInternalTex0=t.scope.resolve("internalTex0"),this.constantInternalTex1=t.scope.resolve("internalTex1"),this.constantInternalTex2=t.scope.resolve("internalTex2"),this.constantInternalTex3=t.scope.resolve("internalTex3"),this.constantEmitterMatrix=t.scope.resolve("emitterMatrix"),this.constantEmitterMatrixInv=t.scope.resolve("emitterMatrixInv"),this.constantNumParticles=t.scope.resolve("numParticles"),this.constantNumParticlesPot=t.scope.resolve("numParticlesPot"),this.constantLocalVelocityDivMult=t.scope.resolve("localVelocityDivMult"),this.constantVelocityDivMult=t.scope.resolve("velocityDivMult"),this.constantRotSpeedDivMult=t.scope.resolve("rotSpeedDivMult"),this.constantSeed=t.scope.resolve("seed"),this.constantStartAngle=t.scope.resolve("startAngle"),this.constantStartAngle2=t.scope.resolve("startAngle2"),this.constantOutBoundsMul=t.scope.resolve("outBoundsMul"),this.constantOutBoundsAdd=t.scope.resolve("outBoundsAdd"),this.constantInBoundsSize=t.scope.resolve("inBoundsSize"),this.constantInBoundsCenter=t.scope.resolve("inBoundsCenter"),this.constantMaxVel=t.scope.resolve("maxVel"),this.constantFaceTangent=t.scope.resolve("faceTangent"),this.constantFaceBinorm=t.scope.resolve("faceBinorm")}_setInputBounds(){this.inBoundsSizeUniform[0]=this._emitter.prevWorldBoundsSize.x,this.inBoundsSizeUniform[1]=this._emitter.prevWorldBoundsSize.y,this.inBoundsSizeUniform[2]=this._emitter.prevWorldBoundsSize.z,this.constantInBoundsSize.setValue(this.inBoundsSizeUniform),this.inBoundsCenterUniform[0]=this._emitter.prevWorldBoundsCenter.x,this.inBoundsCenterUniform[1]=this._emitter.prevWorldBoundsCenter.y,this.inBoundsCenterUniform[2]=this._emitter.prevWorldBoundsCenter.z,this.constantInBoundsCenter.setValue(this.inBoundsCenterUniform)}randomize(){this.frameRandomUniform[0]=Math.random(),this.frameRandomUniform[1]=Math.random(),this.frameRandomUniform[2]=Math.random()}update(e,t,s,i,r){let a=this._emitter;e.setBlendState(Ie.NOBLEND),e.setDepthState($e.NODEPTH),e.setCullMode(0),this.randomize(),this.constantGraphSampleSize.setValue(1/a.precision),this.constantGraphNumSamples.setValue(a.precision),this.constantNumParticles.setValue(a.numParticles),this.constantNumParticlesPot.setValue(a.numParticlesPot),this.constantInternalTex0.setValue(a.internalTex0),this.constantInternalTex1.setValue(a.internalTex1),this.constantInternalTex2.setValue(a.internalTex2),this.constantInternalTex3.setValue(a.internalTex3);let n=a.meshInstance.node,l=n===null?g.ONE:n.localScale;if(a.pack8){this.worldBoundsMulUniform[0]=a.worldBoundsMul.x,this.worldBoundsMulUniform[1]=a.worldBoundsMul.y,this.worldBoundsMulUniform[2]=a.worldBoundsMul.z,this.constantOutBoundsMul.setValue(this.worldBoundsMulUniform),this.worldBoundsAddUniform[0]=a.worldBoundsAdd.x,this.worldBoundsAddUniform[1]=a.worldBoundsAdd.y,this.worldBoundsAddUniform[2]=a.worldBoundsAdd.z,this.constantOutBoundsAdd.setValue(this.worldBoundsAddUniform),this._setInputBounds();let u=a.maxVel*Math.max(Math.max(l.x,l.y),l.z);u=Math.max(u,1),this.constantMaxVel.setValue(u)}let h=n===null||a.localSpace?g.ZERO:n.getPosition(),c=n===null?k.IDENTITY:n.getWorldTransform();a.emitterShape===Si?(iV.setFromMat4(t),this.constantSpawnBounds.setValue(iV.data),this.constantSpawnPosInnerRatio.setValue(s)):(this.constantSpawnBoundsSphere.setValue(a.emitterRadius),this.constantSpawnBoundsSphereInnerRatio.setValue(a.emitterRadius===0?0:a.emitterRadiusInner/a.emitterRadius)),this.constantInitialVelocity.setValue(a.initialVelocity),rV.setFromMat4(c),aV.invertMat4(c),this.emitterPosUniform[0]=h.x,this.emitterPosUniform[1]=h.y,this.emitterPosUniform[2]=h.z,this.constantEmitterPos.setValue(this.emitterPosUniform),this.constantFrameRandom.setValue(this.frameRandomUniform),this.constantDelta.setValue(i),this.constantRate.setValue(a.rate),this.constantRateDiv.setValue(a.rate2-a.rate),this.constantStartAngle.setValue(a.startAngle*w.DEG_TO_RAD),this.constantStartAngle2.setValue(a.startAngle2*w.DEG_TO_RAD),this.constantSeed.setValue(a.seed),this.constantLifetime.setValue(a.lifetime),this.emitterScaleUniform[0]=l.x,this.emitterScaleUniform[1]=l.y,this.emitterScaleUniform[2]=l.z,this.constantEmitterScale.setValue(this.emitterScaleUniform),this.constantEmitterMatrix.setValue(rV.data),this.constantEmitterMatrixInv.setValue(aV.data),this.constantLocalVelocityDivMult.setValue(a.localVelocityUMax),this.constantVelocityDivMult.setValue(a.velocityUMax),this.constantRotSpeedDivMult.setValue(a.rotSpeedUMax[0]);let f=a.swapTex?a.particleTexOUT:a.particleTexIN;f=a.beenReset?a.particleTexStart:f;let d=a.swapTex?a.particleTexIN:a.particleTexOUT;this.constantParticleTexIN.setValue(f),Ot(e,a.swapTex?a.rtParticleTexIN:a.rtParticleTexOUT,r?a.shaderParticleUpdateOnStop:a.loop?a.shaderParticleUpdateRespawn:a.shaderParticleUpdateNoRespawn),a.material.setParameter("particleTexOUT",f),a.material.setParameter("particleTexIN",d),a.beenReset=!1,a.swapTex=!a.swapTex,a.prevWorldBoundsSize.copy(a.worldBoundsSize),a.prevWorldBoundsCenter.copy(a.worldBounds.center),a.pack8&&this._setInputBounds()}}});var oV,jL,lV,hV=m(()=>{j();Sh();J();Nm();It();oV=["NONE","VERTEX","MAP"],jL=class extends vi{generateKey(e){let s=`particle_${vi.definesHash(e.defines)}_`;for(let i in e)e.hasOwnProperty(i)&&(s+=e[i]);return s}createVertexDefines(e,t){let s=new Map(e.defines);return e.mesh&&s.set("USE_MESH",""),e.meshUv&&s.set("USE_MESH_UV",""),e.localSpace&&s.set("LOCAL_SPACE",""),e.screenSpace&&s.set("SCREEN_SPACE",""),e.animTex&&s.set("ANIMTEX",""),e.soft>0&&s.set("SOFT",""),e.stretch>0&&s.set("STRETCH",""),e.customFace&&s.set("CUSTOM_FACE",""),e.pack8&&s.set("PACK8",""),e.localSpace&&s.set("LOCAL_SPACE",""),e.animTexLoop&&s.set("ANIMTEX_LOOP",""),e.wrap&&s.set("WRAP",""),e.alignToMotion&&s.set("ALIGN_TO_MOTION",""),s.set("NORMAL",oV[e.normal]),t.particle_vertexData=te,e.mesh&&e.meshUv&&(t.particle_uv=ot),e.useCpu&&(t.particle_vertexData2=oh,t.particle_vertexData3=af,t.particle_vertexData4=nf,t.particle_vertexData5=of),s}createFragmentDefines(e){let t=new Map(e.defines);return e.soft>0&&t.set("SOFT",""),e.halflambert&&t.set("HALF_LAMBERT",""),t.set("NORMAL",oV[e.normal]),t.set("BLEND",xm[e.blend]),t}createShaderDefinition(e,t){let s=e.isWebGPU?le:oe,i=ie.get(e,s),r={},a=this.createVertexDefines(t,r),n=this.createFragmentDefines(t),l=`PARTICLE_${t.useCpu?"CPU":"GPU"}
`;a.set(l,""),n.set(l,"");let h=new Map(i);return ri.createDefinition(e,{name:"ParticleShader",shaderLanguage:s,attributes:r,vertexCode:i.get("particle_shaderVS"),fragmentCode:i.get("particle_shaderPS"),fragmentDefines:n,fragmentIncludes:h,vertexIncludes:h,vertexDefines:a})}},lV=new jL});var TA,cV=m(()=>{Om();J();Uh();rl();hV();Dt();TA=class extends Os{constructor(e){super(),this.emitter=null,this.emitter=e}getShaderVariant(e){let{device:t,scene:s,cameraShaderParams:i,objDefs:r}=e,{emitter:a}=this,n={defines:Te.getCoreDefines(this,e),pass:Ti,useCpu:this.emitter.useCpu,normal:a.lighting?a.normalMap!==null?2:1:0,halflambert:this.emitter.halfLambert,stretch:this.emitter.stretch,alignToMotion:this.emitter.alignToMotion,soft:this.emitter.depthSoftening,mesh:this.emitter.useMesh,meshUv:r&Lh,gamma:i?.shaderOutputGamma??Mi,toneMap:i?.toneMapping??ro,fog:s&&!this.emitter.noFog?s.fog.type:"none",wrap:this.emitter.wrap&&this.emitter.wrapBounds,localSpace:this.emitter.localSpace,screenSpace:a.inTools?!1:this.emitter.screenSpace,blend:this.emitter.blendType,animTex:this.emitter._isAnimated(),animTexLoop:this.emitter.animLoop,pack8:this.emitter.pack8,customFace:this.emitter.orientation!==Jo},l=new Ta(e.viewUniformFormat,e.viewBindGroupFormat,e.vertexFormat),h=rr(t);return h.register("particle",lV),h.getProgram("particle",n,l,this.userId)}}});function Aa(o,e,t,s,i=14,r,a){let n=0;a&&(i===7||i===20)&&(n=1);let l=new q(o,{width:e,height:t,format:i,cubemap:!1,mipmaps:!1,minFilter:n,magFilter:n,addressU:1,addressV:1,name:"ParticleSystemTexture"}),h=l.lock();if(i===7||i===20){let c=new Uint8Array(s.length);for(let f=0;f<s.length;f++)c[f]=s[f]*r*255;s=c}return h.set(s),l.unlock(),l}function dV(o){return Math.max(Math.min(o,1),0)}function Ee(o,e){yA[o]!==void 0&&yA[o]!==null?$L[o]=yA[o]:$L[o]=e}function SV(o,e,t){return(o*255<<16|e*255<<8|t*255)/(1<<24)}function gV(o,e){let t=o.length/3,s=new Array(t*4);for(let i=0;i<t;i++)s[i*4]=o[i*3],s[i*4+1]=o[i*3+1],s[i*4+2]=o[i*3+2],s[i*4+3]=SV(e[i*3],e[i*3+1],e[i*3+2]);return s}function Kae(o,e){let t=new Array(e.length*4);for(let s=0;s<e.length;s++)t[s*4]=o[s*3],t[s*4+1]=o[s*3+1],t[s*4+2]=o[s*3+2],t[s*4+3]=e[s];return t}function qae(o,e,t,s,i){let r=new Array(o.length*4);for(let a=0;a<o.length;a++)r[a*4]=o[a],r[a*4+1]=e[a],r[a*4+2]=0,r[a*4+3]=SV(t[a],s[a],i[a]);return r}function jae(o,e){let t=new Array(o.length*4);for(let s=0;s<o.length;s++)t[s*4]=o[s],t[s*4+1]=e[s],t[s*4+2]=0,t[s*4+3]=0;return t}function $ae(o){let e=Math.max(o.rate,o.rate2)*o.numParticles+o.lifetime;return Date.now()+e*1e3}function Zae(o,e){let t=new Float32Array(o.length);for(let s=0;s<o.length;s++)t[s]=o[s]-e[s];return t}function Jf(o,e){let t=e.length,s=o.length/t;for(let i=0;i<s;i++)for(let r=0;r<t;r++){let a=Math.abs(o[i*t+r]);e[r]=Math.max(e[r],a)}}function Qae(o,e){let t=e.length,s=o.length/t;for(let i=0;i<s;i++)for(let r=0;r<t;r++)o[i*t+r]/=e[r]===0?1:e[r],o[i*t+r]*=.5,o[i*t+r]+=.5}function Qf(o,e,t){let s=Zae(e,o);return Jf(s,t),Qae(s,t),s}var fV,uV,mV,pV,Yae,cl,EA,fl,Zf,_V,vA,xA,$L,yA,Jae,Qm,ZL=m(()=>{ou();jg();Ke();me();Ve();Q();Vt();j();bi();vh();Rt();Fe();$i();Cr();J();Ws();_s();Dt();sV();nV();cV();It();fV=[[-1,-1],[1,-1],[1,1],[-1,1]];uV=new Ts([0,0,1,0]),mV=new Ts([0,1,1,1]),pV=new Bi([0,0,1,0],[0,0,1,0],[0,0,1,0]),Yae=new Bi([0,1,1,1],[0,1,1,1],[0,1,1,1]),cl=2,EA=4,fl=new Float32Array(3),Zf=new k,_V=new g,vA=new g,xA=new g;Jae=new st,Qm=class{constructor(e,t){this.material=null,this.internalTex0=null,this.internalTex1=null,this.internalTex2=null,this.colorParam=null,this.graphicsDevice=e;let s=e,i=32;this.precision=i,this._addTimeTime=0,$L=this,yA=t,Ee("numParticles",1),this.numParticles>e.maxTextureSize&&(this.numParticles=e.maxTextureSize),Ee("rate",1),Ee("rate2",this.rate),Ee("lifetime",50),Ee("emitterExtents",new g(0,0,0)),Ee("emitterExtentsInner",new g(0,0,0)),Ee("emitterRadius",0),Ee("emitterRadiusInner",0),Ee("emitterShape",Si),Ee("initialVelocity",1),Ee("wrap",!1),Ee("localSpace",!1),Ee("screenSpace",!1),Ee("wrapBounds",null),Ee("colorMap",this.defaultParamTexture),Ee("normalMap",null),Ee("loop",!0),Ee("preWarm",!1),Ee("sort",Mf),Ee("mode",Pm),Ee("scene",null),Ee("lighting",!1),Ee("halfLambert",!1),Ee("intensity",1),Ee("stretch",0),Ee("alignToMotion",!1),Ee("depthSoftening",0),Ee("mesh",null),Ee("particleNormal",new g(0,1,0)),Ee("orientation",Jo),Ee("depthWrite",!1),Ee("noFog",!1),Ee("blendType",es),Ee("node",null),Ee("startAngle",0),Ee("startAngle2",this.startAngle),Ee("animTilesX",1),Ee("animTilesY",1),Ee("animStartFrame",0),Ee("animNumFrames",1),Ee("animNumAnimations",1),Ee("animIndex",0),Ee("randomizeAnimIndex",!1),Ee("animSpeed",1),Ee("animLoop",!0),this._gpuUpdater=new SA(this,s),this._cpuUpdater=new gA(this),this.emitterPosUniform=new Float32Array(3),this.wrapBoundsUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),Ee("colorGraph",Yae),Ee("colorGraph2",this.colorGraph),Ee("scaleGraph",mV),Ee("scaleGraph2",this.scaleGraph),Ee("alphaGraph",mV),Ee("alphaGraph2",this.alphaGraph),Ee("localVelocityGraph",pV),Ee("localVelocityGraph2",this.localVelocityGraph),Ee("velocityGraph",pV),Ee("velocityGraph2",this.velocityGraph),Ee("rotationSpeedGraph",uV),Ee("rotationSpeedGraph2",this.rotationSpeedGraph),Ee("radialSpeedGraph",uV),Ee("radialSpeedGraph2",this.radialSpeedGraph),this.animTilesParams=new Float32Array(2),this.animParams=new Float32Array(4),this.animIndexParams=new Float32Array(2),this.vbToSort=null,this.vbOld=null,this.particleDistance=null,this.camera=null,this.swapTex=!1,this.useMesh=!0,this.useCpu=!e.supportsGpuParticles,this.pack8=!0,this.localBounds=new _e,this.worldBoundsNoTrail=new _e,this.worldBoundsTrail=[new _e,new _e],this.worldBounds=new _e,this.worldBoundsSize=new g,this.prevWorldBoundsSize=new g,this.prevWorldBoundsCenter=new g,this.prevEmitterExtents=this.emitterExtents,this.prevEmitterRadius=this.emitterRadius,this.worldBoundsMul=new g,this.worldBoundsAdd=new g,this.timeToSwitchBounds=0,this.shaderParticleUpdateRespawn=null,this.shaderParticleUpdateNoRespawn=null,this.shaderParticleUpdateOnStop=null,this.numParticleVerts=0,this.numParticleIndices=0,this.material=null,this.meshInstance=null,this.drawOrder=0,this.seed=Math.random(),this.fixedTimeStep=1/60,this.maxSubSteps=10,this.simTime=0,this.simTimeTotal=0,this.beenReset=!1,this._layer=null,this.rebuild()}get defaultParamTexture(){return Jae.get(this.graphicsDevice,()=>{let s=new Float32Array(1024);for(let r=0;r<16;r++)for(let a=0;a<16;a++){let n=a+1-8.5,l=r+1-8.5,h=dV(1-dV(Math.sqrt(n*n+l*l)/16)-.5),c=r*16+a;s[c*4]=1,s[c*4+1]=1,s[c*4+2]=1,s[c*4+3]=h}let i=Aa(this.graphicsDevice,16,16,s,20,1,!0);return i.minFilter=1,i.magFilter=1,i})}onChangeCamera(){this.resetMaterial()}calculateBoundsMad(){this.worldBoundsMul.x=1/this.worldBoundsSize.x,this.worldBoundsMul.y=1/this.worldBoundsSize.y,this.worldBoundsMul.z=1/this.worldBoundsSize.z,this.worldBoundsAdd.copy(this.worldBounds.center).mul(this.worldBoundsMul).mulScalar(-1),this.worldBoundsAdd.x+=.5,this.worldBoundsAdd.y+=.5,this.worldBoundsAdd.z+=.5}calculateWorldBounds(){if(!this.node)return;if(this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),!this.useCpu){let s=!1;this.emitterShape===Si?s=!this.emitterExtents.equals(this.prevEmitterExtents):s=this.emitterRadius!==this.prevEmitterRadius,s&&this.calculateLocalBounds()}let e=this.node.getWorldTransform();this.localSpace?this.worldBoundsNoTrail.copy(this.localBounds):this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,e),this.worldBoundsTrail[0].add(this.worldBoundsNoTrail),this.worldBoundsTrail[1].add(this.worldBoundsNoTrail);let t=this.simTimeTotal;t>=this.timeToSwitchBounds&&(this.worldBoundsTrail[0].copy(this.worldBoundsTrail[1]),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.timeToSwitchBounds=t+this.lifetime),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.localSpace?(this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,e),this.meshInstance.mesh.aabb.setFromTransformedAabb(this.worldBounds,e)):(this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance.mesh.aabb.copy(this.worldBounds)),this.meshInstance._aabbVer=1-this.meshInstance._aabbVer,this.pack8&&this.calculateBoundsMad()}resetWorldBounds(){this.node&&(this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,this.localSpace?k.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBoundsNoTrail),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.simTimeTotal=0,this.timeToSwitchBounds=0)}calculateLocalBounds(){let e=Number.MAX_VALUE,t=Number.MAX_VALUE,s=Number.MAX_VALUE,i=-Number.MAX_VALUE,r=-Number.MAX_VALUE,a=-Number.MAX_VALUE,n=0,l=0,h=this.lifetime/this.precision,c=[this.qVelocity,this.qVelocity2],f=[this.qLocalVelocity,this.qLocalVelocity2],d=[0,0],u=[0,0],p=[0,0],_=[0,0],S=[0,0],T,x,A;for(let v=0;v<this.precision+1;v++){let R=Math.min(v,this.precision-1);for(let P=0;P<2;P++)T=f[P][R*3+0]*h+d[P],x=f[P][R*3+1]*h+u[P],A=f[P][R*3+2]*h+p[P],e=Math.min(T,e),t=Math.min(x,t),s=Math.min(A,s),i=Math.max(T,i),r=Math.max(x,r),a=Math.max(A,a),d[P]=T,u[P]=x,p[P]=A;for(let P=0;P<2;P++)S[P]+=h*Math.sqrt(c[P][R*3+0]*c[P][R*3+0]+c[P][R*3+1]*c[P][R*3+1]+c[P][R*3+2]*c[P][R*3+2]);_[0]+=this.qRadialSpeed[R]*h,_[1]+=this.qRadialSpeed2[R]*h,n=Math.max(n,Math.max(Math.abs(_[0]),Math.abs(_[1]))),l=Math.max(l,this.qScale[R])}this.emitterShape===Si?(T=this.emitterExtents.x*.5,x=this.emitterExtents.y*.5,A=this.emitterExtents.z*.5):(T=this.emitterRadius,x=this.emitterRadius,A=this.emitterRadius);let E=Math.max(S[0],S[1]);vA.x=e-l-T-n-E,vA.y=t-l-x-n-E,vA.z=s-l-A-n-E,xA.x=i+l+T+n+E,xA.y=r+l+x+n+E,xA.z=a+l+A+n+E,this.localBounds.setMinMax(vA,xA)}rebuild(){let e=this.graphicsDevice;this.colorMap===null&&(this.colorMap=this.defaultParamTexture),this.spawnBounds=this.emitterShape===Si?this.emitterExtents:this.emitterRadius,this.useCpu=this.useCpu||this.sort>Mf||e.maxVertexTextures<=1||e.fragmentUniformsCount<64||e.forceCpuParticles,this._destroyResources(),this.pack8=(this.pack8||!e.textureFloatRenderable)&&!this.useCpu,cl=this.useCpu||this.pack8?4:2,this.useMesh=!!this.mesh,this.numParticlesPot=w.nextPowerOfTwo(this.numParticles),this.rebuildGraphs(),this.calculateLocalBounds(),this.resetWorldBounds(),this.node&&(this.worldBounds.setFromTransformedAabb(this.localBounds,this.localSpace?k.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBounds),this.worldBoundsTrail[1].copy(this.worldBounds),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.pack8&&this.calculateBoundsMad()),this.vbToSort=new Array(this.numParticles);for(let c=0;c<this.numParticles;c++)this.vbToSort[c]=[0,0];this.particleDistance=new Float32Array(this.numParticles),this._gpuUpdater.randomize(),this.particleTex=new Float32Array(this.numParticlesPot*cl*EA);let t=this.node===null||this.localSpace?g.ZERO:this.node.getPosition();this.emitterShape===Si&&(this.node===null||this.localSpace?Zf.setTRS(g.ZERO,H.IDENTITY,this.spawnBounds):Zf.setTRS(g.ZERO,this.node.getRotation(),_V.copy(this.spawnBounds).mul(this.node.localScale)),fl[0]=this.emitterExtents.x!==0?this.emitterExtentsInner.x/this.emitterExtents.x:0,fl[1]=this.emitterExtents.y!==0?this.emitterExtentsInner.y/this.emitterExtents.y:0,fl[2]=this.emitterExtents.z!==0?this.emitterExtentsInner.z/this.emitterExtents.z:0);for(let c=0;c<this.numParticles;c++)this._cpuUpdater.calcSpawnPosition(this.particleTex,Zf,fl,t,c),this.useCpu&&(this.particleTex[c*EA+3+this.numParticlesPot*2*EA]=1);this.particleTexStart=new Float32Array(this.numParticlesPot*cl*EA);for(let c=0;c<this.particleTexStart.length;c++)this.particleTexStart[c]=this.particleTex[c];this.useCpu||(this.pack8?(this.particleTexIN=Aa(e,this.numParticlesPot,cl,this.particleTex,7,1,!1),this.particleTexOUT=Aa(e,this.numParticlesPot,cl,this.particleTex,7,1,!1),this.particleTexStart=Aa(e,this.numParticlesPot,cl,this.particleTexStart,7,1,!1)):(this.particleTexIN=Aa(e,this.numParticlesPot,cl,this.particleTex),this.particleTexOUT=Aa(e,this.numParticlesPot,cl,this.particleTex),this.particleTexStart=Aa(e,this.numParticlesPot,cl,this.particleTexStart)),this.rtParticleTexIN=new xe({colorBuffer:this.particleTexIN,depth:!1}),this.rtParticleTexOUT=new xe({colorBuffer:this.particleTexOUT,depth:!1}),this.swapTex=!1);let s=new Map;this.localSpace&&s.set("LOCAL_SPACE",""),this.pack8&&s.set("PACK8",""),this.emitterShape===Si&&s.set("EMITTERSHAPE_BOX","");let i=`Shape:${this.emitterShape}-Pack:${this.pack8}-Local:${this.localSpace}`,r=ie.get(e,e.isWebGPU?le:oe),a=new Map(r),n={attributes:{vertex_position:te},vertexChunk:"fullscreenQuadVS",fragmentChunk:"particle_simulationPS",fragmentDefines:s,fragmentIncludes:a};n.uniqueName=`ParticleUpdateRespawn-${i}`,s.set("RESPAWN",""),this.shaderParticleUpdateRespawn=Te.createShader(e,n),s.delete("RESPAWN"),n.uniqueName=`ParticleUpdateNoRespawn-${i}`,s.set("NO_RESPAWN",""),this.shaderParticleUpdateNoRespawn=Te.createShader(e,n),s.delete("NO_RESPAWN"),n.uniqueName=`ParticleUpdateStop-${i}`,s.set("ON_STOP",""),this.shaderParticleUpdateOnStop=Te.createShader(e,n),this.numParticleVerts=this.useMesh?this.mesh.vertexBuffer.numVertices:4,this.numParticleIndices=this.useMesh?this.mesh.indexBuffer[0].numIndices:6,this._allocate(this.numParticles);let l=new Ce(e);l.vertexBuffer=this.vertexBuffer,l.indexBuffer[0]=this.indexBuffer,l.primitive[0].type=As,l.primitive[0].base=0,l.primitive[0].count=this.numParticles*this.numParticleIndices,l.primitive[0].indexed=!0,this.material=this._createMaterial(),this.resetMaterial();let h=this.meshInstance?this.meshInstance.visible:!0;this.meshInstance=new Oe(l,this.material,this.node),this.meshInstance.pick=!1,this.meshInstance.updateKey(),this.meshInstance.cull=!0,this.localSpace?this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,this.node.getWorldTransform()):this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance._updateAabb=!1,this.meshInstance.visible=h,this._setMaterialTextures(),this.resetTime(),this.addTime(0,!1),this.preWarm&&this.prewarm(this.lifetime)}_isAnimated(){return this.animNumFrames>=1&&(this.animTilesX>1||this.animTilesY>1)&&(this.colorMap&&this.colorMap!==this.defaultParamTexture||this.normalMap)}rebuildGraphs(){let e=this.precision,t=this.graphicsDevice;this.qLocalVelocity=this.localVelocityGraph.quantize(e),this.qVelocity=this.velocityGraph.quantize(e),this.qColor=this.colorGraph.quantizeClamped(e,0,1),this.qRotSpeed=this.rotationSpeedGraph.quantize(e),this.qScale=this.scaleGraph.quantize(e),this.qAlpha=this.alphaGraph.quantize(e),this.qRadialSpeed=this.radialSpeedGraph.quantize(e),this.qLocalVelocity2=this.localVelocityGraph2.quantize(e),this.qVelocity2=this.velocityGraph2.quantize(e),this.qColor2=this.colorGraph2.quantizeClamped(e,0,1),this.qRotSpeed2=this.rotationSpeedGraph2.quantize(e),this.qScale2=this.scaleGraph2.quantize(e),this.qAlpha2=this.alphaGraph2.quantize(e),this.qRadialSpeed2=this.radialSpeedGraph2.quantize(e);for(let s=0;s<e;s++)this.qRotSpeed[s]*=w.DEG_TO_RAD,this.qRotSpeed2[s]*=w.DEG_TO_RAD;if(this.localVelocityUMax=new Float32Array(3),this.velocityUMax=new Float32Array(3),this.colorUMax=new Float32Array(3),this.rotSpeedUMax=[0],this.scaleUMax=[0],this.alphaUMax=[0],this.radialSpeedUMax=[0],this.qLocalVelocityDiv=Qf(this.qLocalVelocity,this.qLocalVelocity2,this.localVelocityUMax),this.qVelocityDiv=Qf(this.qVelocity,this.qVelocity2,this.velocityUMax),this.qColorDiv=Qf(this.qColor,this.qColor2,this.colorUMax),this.qRotSpeedDiv=Qf(this.qRotSpeed,this.qRotSpeed2,this.rotSpeedUMax),this.qScaleDiv=Qf(this.qScale,this.qScale2,this.scaleUMax),this.qAlphaDiv=Qf(this.qAlpha,this.qAlpha2,this.alphaUMax),this.qRadialSpeedDiv=Qf(this.qRadialSpeed,this.qRadialSpeed2,this.radialSpeedUMax),this.pack8){let s=[0,0,0];Jf(this.qVelocity,s);let i=[0,0,0];Jf(this.qVelocity2,i);let r=[0,0,0];Jf(this.qLocalVelocity,r);let a=[0,0,0];Jf(this.qLocalVelocity2,a);let n=[0];Jf(this.qRadialSpeed,n);let l=[0];Jf(this.qRadialSpeed2,l);let h=Math.max(s[0],i[0]);h=Math.max(h,s[1]),h=Math.max(h,i[1]),h=Math.max(h,s[2]),h=Math.max(h,i[2]);let c=Math.max(r[0],a[0]);c=Math.max(c,r[1]),c=Math.max(c,a[1]),c=Math.max(c,r[2]),c=Math.max(c,a[2]);let f=Math.max(n[0],l[0]);this.maxVel=h+c+f}this.useCpu||(this.internalTex0=Aa(t,e,1,gV(this.qLocalVelocity,this.qLocalVelocityDiv)),this.internalTex1=Aa(t,e,1,gV(this.qVelocity,this.qVelocityDiv)),this.internalTex2=Aa(t,e,1,qae(this.qRotSpeed,this.qScale,this.qScaleDiv,this.qRotSpeedDiv,this.qAlphaDiv)),this.internalTex3=Aa(t,e,1,jae(this.qRadialSpeed,this.qRadialSpeedDiv))),this.colorParam=Aa(t,e,1,Kae(this.qColor,this.qAlpha),20,1,!0)}_setMaterialTextures(){this.colorMap&&(this.material.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&this.material.setParameter("normalMap",this.normalMap))}_createMaterial(){let e=new TA(this);return e.name=`EmitterMaterial:${this.node.name}`,e.cull=0,e.alphaWrite=!1,e.blendType=this.blendType,e.depthWrite=this.depthWrite,e}resetMaterial(){let e=this.material;e.setParameter("stretch",this.stretch),this._isAnimated()&&(e.setParameter("animTexTilesParams",this.animTilesParams),e.setParameter("animTexParams",this.animParams),e.setParameter("animTexIndexParams",this.animIndexParams)),e.setParameter("colorMult",this.intensity),this.useCpu||(e.setParameter("internalTex0",this.internalTex0),e.setParameter("internalTex1",this.internalTex1),e.setParameter("internalTex2",this.internalTex2),e.setParameter("internalTex3",this.internalTex3)),e.setParameter("colorParam",this.colorParam),e.setParameter("numParticles",this.numParticles),e.setParameter("numParticlesPot",this.numParticlesPot),e.setParameter("lifetime",this.lifetime),e.setParameter("rate",this.rate),e.setParameter("rateDiv",this.rate2-this.rate),e.setParameter("seed",this.seed),e.setParameter("scaleDivMult",this.scaleUMax[0]),e.setParameter("alphaDivMult",this.alphaUMax[0]),e.setParameter("radialSpeedDivMult",this.radialSpeedUMax[0]),e.setParameter("graphNumSamples",this.precision),e.setParameter("graphSampleSize",1/this.precision),e.setParameter("emitterScale",new Float32Array([1,1,1])),this.pack8&&(this._gpuUpdater._setInputBounds(),e.setParameter("inBoundsSize",this._gpuUpdater.inBoundsSizeUniform),e.setParameter("inBoundsCenter",this._gpuUpdater.inBoundsCenterUniform),e.setParameter("maxVel",this.maxVel)),this.wrap&&this.wrapBounds&&(this.wrapBoundsUniform[0]=this.wrapBounds.x,this.wrapBoundsUniform[1]=this.wrapBounds.y,this.wrapBoundsUniform[2]=this.wrapBounds.z,e.setParameter("wrapBounds",this.wrapBoundsUniform)),this._setMaterialTextures(),this.depthSoftening>0&&e.setParameter("softening",1/(this.depthSoftening*this.depthSoftening*100)),this.stretch>0&&(e.cull=0),this._compParticleFaceParams()}_compParticleFaceParams(){let e,t;if(this.orientation===Jo)e=new Float32Array([1,0,0]),t=new Float32Array([0,0,1]);else{let s;this.orientation===uy?s=this.particleNormal.normalize():s=(this.node===null?k.IDENTITY:this.node.getWorldTransform()).transformVector(this.particleNormal).normalize();let i=new g(1,0,0);Math.abs(i.dot(s))===1&&i.set(0,0,1);let r=new g().cross(s,i).normalize();i.cross(r,s).normalize(),e=new Float32Array([i.x,i.y,i.z]),t=new Float32Array([r.x,r.y,r.z])}this.material.setParameter("faceTangent",e),this.material.setParameter("faceBinorm",t)}getVertexInfo(){let e=[];return this.useCpu?e.push({semantic:Iu,components:4,type:pe},{semantic:oh,components:4,type:pe},{semantic:af,components:4,type:pe},{semantic:nf,components:1,type:pe},{semantic:of,components:this.useMesh?4:2,type:pe}):(e.push({semantic:Iu,components:4,type:pe}),this.useMesh&&e.push({semantic:oh,components:2,type:pe})),e}_allocate(e){let t=e*this.numParticleVerts,s=e*this.numParticleIndices;if(this.vertexBuffer===void 0||this.vertexBuffer.getNumVertices()!==t){let i=this.getVertexInfo(),r=new Tt(this.graphicsDevice,i);this.vertexBuffer=new mt(this.graphicsDevice,r,t,{usage:1}),this.indexBuffer=new Ls(this.graphicsDevice,2,s);let a=new Float32Array(this.vertexBuffer.lock()),n,l,h;if(this.useMesh){n=new Float32Array(this.mesh.vertexBuffer.lock()),l=n.length/this.mesh.vertexBuffer.numVertices;for(let d=0;d<this.mesh.vertexBuffer.format.elements.length;d++)if(this.mesh.vertexBuffer.format.elements[d].name===ot){h=this.mesh.vertexBuffer.format.elements[d].offset/4;break}}for(let d=0;d<t;d++){let u=Math.floor(d/this.numParticleVerts);if(this.useMesh){let p=d%this.numParticleVerts;a[d*6]=n[p*l],a[d*6+1]=n[p*l+1],a[d*6+2]=n[p*l+2],a[d*6+3]=u,a[d*6+4]=n[p*l+h+0],a[d*6+5]=1-n[p*l+h+1]}else{let p=d%4;a[d*4]=fV[p][0],a[d*4+1]=fV[p][1],a[d*4+2]=0,a[d*4+3]=u}}this.useCpu&&(this.vbCPU=new Float32Array(a),this.vbOld=new Float32Array(this.vbCPU.length)),this.vertexBuffer.unlock(),this.useMesh&&this.mesh.vertexBuffer.unlock();let c=0,f=new Uint32Array(this.indexBuffer.lock());if(this.useMesh){let d=this.mesh.indexBuffer[0];n=new Yo[d.format](d.lock())}for(let d=0;d<e;d++)if(this.useMesh)for(let u=0;u<this.numParticleIndices;u++)f[d*this.numParticleIndices+u]=n[u]+d*this.numParticleVerts;else{let u=d*4;f[c++]=u,f[c++]=u+1,f[c++]=u+2,f[c++]=u,f[c++]=u+2,f[c++]=u+3}this.indexBuffer.unlock(),this.useMesh&&this.mesh.indexBuffer[0].unlock()}}reset(){if(this.beenReset=!0,this.seed=Math.random(),this.material.setParameter("seed",this.seed),this.useCpu)for(let t=0;t<this.particleTexStart.length;t++)this.particleTex[t]=this.particleTexStart[t];else this._setMaterialTextures();this.resetWorldBounds(),this.resetTime();let e=this.loop;this.loop=!0,this.addTime(0,!1),this.loop=e,this.preWarm&&this.prewarm(this.lifetime)}prewarm(e){let t=e/this.lifetime,s=Math.min(Math.floor(t*this.precision),this.precision),i=e/s;for(let r=0;r<s;r++)this.addTime(i,!1)}resetTime(){this.endTime=$ae(this)}finishFrame(){this.useCpu&&this.vertexBuffer.unlock()}addTime(e,t){let s=this.graphicsDevice;if(this.simTimeTotal+=e,this.calculateWorldBounds(),this._isAnimated()){let a=this.animTilesParams;a[0]=1/this.animTilesX,a[1]=1/this.animTilesY;let n=this.animParams;n[0]=this.animStartFrame,n[1]=this.animNumFrames*this.animSpeed,n[2]=this.animNumFrames-1,n[3]=this.animNumAnimations-1;let l=this.animIndexParams;l[0]=this.animIndex,l[1]=this.randomizeAnimIndex}this.scene&&this.camera!==this.scene._activeCamera&&(this.camera=this.scene._activeCamera,this.onChangeCamera()),this.emitterShape===Si&&(fl[0]=this.emitterExtents.x!==0?this.emitterExtentsInner.x/this.emitterExtents.x:0,fl[1]=this.emitterExtents.y!==0?this.emitterExtentsInner.y/this.emitterExtents.y:0,fl[2]=this.emitterExtents.z!==0?this.emitterExtentsInner.z/this.emitterExtents.z:0,this.meshInstance.node===null?Zf.setTRS(g.ZERO,H.IDENTITY,this.emitterExtents):Zf.setTRS(g.ZERO,this.meshInstance.node.getRotation(),_V.copy(this.emitterExtents).mul(this.meshInstance.node.localScale)));let i,r=this.meshInstance.node===null?g.ONE:this.meshInstance.node.localScale;if(this.emitterScaleUniform[0]=r.x,this.emitterScaleUniform[1]=r.y,this.emitterScaleUniform[2]=r.z,this.material.setParameter("emitterScale",this.emitterScaleUniform),this.localSpace&&this.meshInstance.node&&(i=this.meshInstance.node.getPosition(),this.emitterPosUniform[0]=i.x,this.emitterPosUniform[1]=i.y,this.emitterPosUniform[2]=i.z,this.material.setParameter("emitterPos",this.emitterPosUniform)),this._compParticleFaceParams(),!this.useCpu)this._gpuUpdater.update(s,Zf,fl,e,t);else{let a=new Float32Array(this.vertexBuffer.lock());this._cpuUpdater.update(a,this.vbToSort,this.particleTex,Zf,fl,i,e,t)}this.loop||Date.now()>this.endTime&&(this.onFinished&&this.onFinished(),this.meshInstance.visible=!1),this.meshInstance&&(this.meshInstance.drawOrder=this.drawOrder)}_destroyResources(){this.particleTexIN?.destroy(),this.particleTexIN=null,this.particleTexOUT?.destroy(),this.particleTexOUT=null,this.particleTexStart&&this.particleTexStart.destroy&&(this.particleTexStart.destroy(),this.particleTexStart=null),this.rtParticleTexIN?.destroy(),this.rtParticleTexIN=null,this.rtParticleTexOUT?.destroy(),this.rtParticleTexOUT=null,this.internalTex0?.destroy(),this.internalTex0=null,this.internalTex1?.destroy(),this.internalTex1=null,this.internalTex2?.destroy(),this.internalTex2=null,this.internalTex3?.destroy(),this.internalTex3=null,this.colorParam?.destroy(),this.colorParam=null,this.vertexBuffer?.destroy(),this.vertexBuffer=void 0,this.indexBuffer?.destroy(),this.indexBuffer=void 0,this.material?.destroy(),this.material=null}destroy(){this.camera=null,this._destroyResources()}}});var QL,TV,EV=m(()=>{Ya();GS();j();Sh();Nm();It();QL=class extends vi{generateKey(e){let t=e.shaderDesc,s=t.vertexGLSL?Is(t.vertexGLSL):0,i=t.fragmentGLSL?Is(t.fragmentGLSL):0,r=t.vertexWGSL?Is(t.vertexWGSL):0,a=t.fragmentWGSL?Is(t.fragmentWGSL):0,n=vi.definesHash(e.defines),l=e.shaderChunks?.key??"",h=`${t.uniqueName}_${n}_${s}_${i}_${r}_${a}_${l}`;return e.skin&&(h+="_skin"),e.useInstancing&&(h+="_inst"),e.useMorphPosition&&(h+="_morphp"),e.useMorphNormal&&(h+="_morphn"),e.useMorphTextureBasedInt&&(h+="_morphi"),h}createAttributesDefinition(e,t){let s=t.shaderDesc.attributes,i=s?{...s}:void 0;t.skin&&(i.vertex_boneWeights=hs,i.vertex_boneIndices=Gt),(t.useMorphPosition||t.useMorphNormal)&&(i.morph_vertex_id=ta),e.attributes=i}createVertexDefinition(e,t,s,i){let r=t.shaderDesc,a=new Map(s);a.set("transformInstancingVS","");let n=new Map(t.defines);t.skin&&n.set("SKIN",!0),t.useInstancing&&n.set("INSTANCING",!0),(t.useMorphPosition||t.useMorphNormal)&&(n.set("MORPHING",!0),t.useMorphTextureBasedInt&&n.set("MORPHING_INT",!0),t.useMorphPosition&&n.set("MORPHING_POSITION",!0),t.useMorphNormal&&n.set("MORPHING_NORMAL",!0)),e.vertexCode=i?r.vertexWGSL:r.vertexGLSL,e.vertexIncludes=a,e.vertexDefines=n}createFragmentDefinition(e,t,s,i){let r=t.shaderDesc,a=new Map(s),n=new Map(t.defines);e.fragmentCode=i?r.fragmentWGSL:r.fragmentGLSL,e.fragmentIncludes=a,e.fragmentDefines=n}createShaderDefinition(e,t){let s=t.shaderDesc,i=e.isWebGPU&&!!s.vertexWGSL&&!!s.fragmentWGSL&&(t.shaderChunks?.useWGSL??!0),r={name:`ShaderMaterial-${s.uniqueName}`,shaderLanguage:i?le:oe,fragmentOutputTypes:s.fragmentOutputTypes,meshUniformBufferFormat:s.meshUniformBufferFormat,meshBindGroupFormat:s.meshBindGroupFormat},a=i?le:oe,n=sn.merge(ie.get(e,a),t.shaderChunks[a]);return this.createAttributesDefinition(r,t),this.createVertexDefinition(r,t,n,i),this.createFragmentDefinition(r,t,n,i),ri.createDefinition(e,r)}},TV=new QL});var oi,$h=m(()=>{j();Om();J();Uh();EV();Dt();rl();oi=class extends Os{constructor(e){super(),this.shaderDesc=e}set shaderDesc(e){if(this._shaderDesc=void 0,e&&(this._shaderDesc={uniqueName:e.uniqueName,attributes:e.attributes,fragmentOutputTypes:e.fragmentOutputTypes,vertexGLSL:e.vertexGLSL,fragmentGLSL:e.fragmentGLSL,vertexWGSL:e.vertexWGSL,fragmentWGSL:e.fragmentWGSL},e.vertexCode||e.fragmentCode||e.shaderLanguage)){let t=e.shaderLanguage??oe;t===oe?(this._shaderDesc.vertexGLSL=e.vertexCode,this._shaderDesc.fragmentGLSL=e.fragmentCode):t===le&&(this._shaderDesc.vertexWGSL=e.vertexCode,this._shaderDesc.fragmentWGSL=e.fragmentCode)}this.clearVariants()}get shaderDesc(){return this._shaderDesc}copy(e){return super.copy(e),this.shaderDesc=e.shaderDesc,this}getShaderVariant(e){let{objDefs:t}=e,s={defines:Te.getCoreDefines(this,e),skin:(t&ao)!==0,useInstancing:(t&no)!==0,useMorphPosition:(t&oo)!==0,useMorphNormal:(t&lo)!==0,useMorphTextureBasedInt:(t&ho)!==0,pass:e.pass,gamma:e.cameraShaderParams.shaderOutputGamma,toneMapping:e.cameraShaderParams.toneMapping,fog:e.cameraShaderParams.fog,shaderDesc:this.shaderDesc,shaderChunks:this.shaderChunks},i=new Ta(e.viewUniformFormat,e.viewBindGroupFormat,e.vertexFormat),r=rr(e.device);return r.register("shader-material",TV),r.getProgram("shader-material",s,i,this.userId)}}});var ene,tne,li,ed=m(()=>{ene={linear:"decodeLinear",srgb:"decodeGamma",rgbm:"decodeRGBM",rgbe:"decodeRGBE",rgbp:"decodeRGBP",xy:"unpackNormalXY",xyz:"unpackNormalXYZ"},tne={linear:"encodeLinear",srgb:"encodeGamma",rgbm:"encodeRGBM",rgbe:"encodeRGBE",rgbp:"encodeRGBP"},li=class{static decodeFunc(e){return ene[e]??"decodeGamma"}static encodeFunc(e){return tne[e]??"encodeGamma"}}});var Jm,Ks,an=m(()=>{Ne();Q();Jm=(o,e)=>{let t=e.length/3,s=o.length/3,i=new g,r=new g,a=new g,n=new g,l=new g,h=new g,c=[];for(let f=0;f<o.length;f++)c[f]=0;for(let f=0;f<t;f++){let d=e[f*3],u=e[f*3+1],p=e[f*3+2];i.set(o[d*3],o[d*3+1],o[d*3+2]),r.set(o[u*3],o[u*3+1],o[u*3+2]),a.set(o[p*3],o[p*3+1],o[p*3+2]),n.sub2(r,i),l.sub2(a,i),h.cross(n,l).normalize(),c[d*3]+=h.x,c[d*3+1]+=h.y,c[d*3+2]+=h.z,c[u*3]+=h.x,c[u*3+1]+=h.y,c[u*3+2]+=h.z,c[p*3]+=h.x,c[p*3+1]+=h.y,c[p*3+2]+=h.z}for(let f=0;f<s;f++){let d=c[f*3],u=c[f*3+1],p=c[f*3+2],_=1/Math.sqrt(d*d+u*u+p*p);c[f*3]*=_,c[f*3+1]*=_,c[f*3+2]*=_}return c},Ks=(o,e,t,s)=>{let i=s.length/3,r=o.length/3,a=new g,n=new g,l=new g,h=new D,c=new D,f=new D,d=new g,u=new g,p=new Float32Array(r*3),_=new Float32Array(r*3),S=[];for(let v=0;v<i;v++){let R=s[v*3],P=s[v*3+1],y=s[v*3+2];a.set(o[R*3],o[R*3+1],o[R*3+2]),n.set(o[P*3],o[P*3+1],o[P*3+2]),l.set(o[y*3],o[y*3+1],o[y*3+2]),h.set(t[R*2],t[R*2+1]),c.set(t[P*2],t[P*2+1]),f.set(t[y*2],t[y*2+1]);let C=n.x-a.x,L=l.x-a.x,O=n.y-a.y,M=l.y-a.y,U=n.z-a.z,G=l.z-a.z,$=c.x-h.x,X=f.x-h.x,I=c.y-h.y,b=f.y-h.y,F=$*b-X*I;if(F===0)d.set(0,1,0),u.set(1,0,0);else{let B=1/F;d.set((b*C-I*L)*B,(b*O-I*M)*B,(b*U-I*G)*B),u.set(($*L-X*C)*B,($*M-X*O)*B,($*G-X*U)*B)}p[R*3+0]+=d.x,p[R*3+1]+=d.y,p[R*3+2]+=d.z,p[P*3+0]+=d.x,p[P*3+1]+=d.y,p[P*3+2]+=d.z,p[y*3+0]+=d.x,p[y*3+1]+=d.y,p[y*3+2]+=d.z,_[R*3+0]+=u.x,_[R*3+1]+=u.y,_[R*3+2]+=u.z,_[P*3+0]+=u.x,_[P*3+1]+=u.y,_[P*3+2]+=u.z,_[y*3+0]+=u.x,_[y*3+1]+=u.y,_[y*3+2]+=u.z}let T=new g,x=new g,A=new g,E=new g;for(let v=0;v<r;v++){A.set(e[v*3],e[v*3+1],e[v*3+2]),T.set(p[v*3],p[v*3+1],p[v*3+2]),x.set(_[v*3],_[v*3+1],_[v*3+2]);let R=A.dot(T);E.copy(A).mulScalar(R),E.sub2(T,E).normalize(),S[v*4]=E.x,S[v*4+1]=E.y,S[v*4+2]=E.z,E.cross(A,T),S[v*4+3]=E.dot(x)<0?-1:1}return S}});var Qt,nn=m(()=>{an();Qt=class{calculateNormals(){this.normals=Jm(this.positions,this.indices)}calculateTangents(){this.tangents=Ks(this.positions,this.normals,this.uvs,this.indices)}}});var JL,vV,hi,Zh=m(()=>{Q();an();nn();JL=4/64,vV=1-JL*2,hi=class extends Qt{constructor(e={}){super();let t=e.halfExtents??new g(.5,.5,.5),s=e.widthSegments??1,i=e.lengthSegments??1,r=e.heightSegments??1,a=e.yOffset??0,n=-t.y+a,l=t.y+a,h=[new g(-t.x,n,t.z),new g(t.x,n,t.z),new g(t.x,l,t.z),new g(-t.x,l,t.z),new g(t.x,n,-t.z),new g(-t.x,n,-t.z),new g(-t.x,l,-t.z),new g(t.x,l,-t.z)],c=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],f=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],d={FRONT:0,BACK:1,TOP:2,BOTTOM:3,RIGHT:4,LEFT:5},u=[],p=[],_=[],S=[],T=0,x=(A,E,v)=>{let R=new g,P=new g,y=new g,C=new g;for(let L=0;L<=E;L++)for(let O=0;O<=v;O++){R.lerp(h[c[A][0]],h[c[A][1]],L/E),P.lerp(h[c[A][0]],h[c[A][2]],O/v),y.sub2(P,h[c[A][0]]),C.add2(R,y);let M=L/E,U=O/v;u.push(C.x,C.y,C.z),p.push(f[A][0],f[A][1],f[A][2]),_.push(M,1-U),M=M*vV+JL,U=U*vV+JL,M/=3,U/=3,M+=A%3/3,U+=Math.floor(A/3)/3,L<E&&O<v&&(S.push(T+v+1,T+1,T),S.push(T+v+1,T+v+2,T+1)),T++}};x(d.FRONT,s,r),x(d.BACK,s,r),x(d.TOP,s,i),x(d.BOTTOM,s,i),x(d.RIGHT,i,r),x(d.LEFT,i,r),this.positions=u,this.normals=p,this.uvs=_,this.uvs1=_,this.indices=S,e.calculateTangents&&(this.tangents=Ks(u,p,_,S))}}});var or,td=m(()=>{an();nn();or=class extends Qt{constructor(e={}){super();let t=e.radius??.5,s=e.latitudeBands??16,i=e.longitudeBands??16,r=[],a=[],n=[],l=[];for(let h=0;h<=s;h++){let c=h*Math.PI/s,f=Math.sin(c),d=Math.cos(c);for(let u=0;u<=i;u++){let p=u*2*Math.PI/i-Math.PI/2,_=Math.sin(p),T=Math.cos(p)*f,x=d,A=_*f,E=1-u/i,v=1-h/s;r.push(T*t,x*t,A*t),a.push(T,x,A),n.push(E,1-v)}}for(let h=0;h<s;++h)for(let c=0;c<i;++c){let f=h*(i+1)+c,d=f+i+1;l.push(f+1,d,f),l.push(f+1,d+1,d)}this.positions=r,this.normals=a,this.uvs=n,this.uvs1=n,this.indices=l,e.calculateTangents&&(this.tangents=Ks(r,a,n,l))}}});var ep,eb=m(()=>{td();ep=class extends or{constructor(e={}){let s=e.latitudeBands??16,i=e.longitudeBands??16;super({radius:.5,latitudeBands:s,longitudeBands:i});let r=.1,a=.95,n=a*a,l=this.positions;for(let h=0;h<l.length;h+=3){let c=l[h]/.5,f=l[h+1]/.5,d=l[h+2]/.5;f<0&&(f*=.3,c*c+d*d<n&&(f=-.1)),f+=r,f*=.5,l[h+1]=f}}}});var AA,xV=m(()=>{J();Ws();Zh();eb();AA=class o{static create(e,t){switch(t){case Ay:return o.box(e);case Py:return o.dome(e)}return o.infinite(e)}static infinite(e){return Ce.fromGeometry(e,new hi(e))}static box(e){return Ce.fromGeometry(e,new hi({yOffset:.5}))}static dome(e){let t=new ep({latitudeBands:50,longitudeBands:50});return t.normals=void 0,t.uvs=void 0,Ce.fromGeometry(e,t)}}});var PA,yV=m(()=>{j();J();$h();_s();ed();xV();It();PA=class{constructor(e,t,s,i,r){this.meshInstance=null,this._depthWrite=!1;let a=new oi({uniqueName:"SkyMaterial",vertexGLSL:ie.get(e,oe).get("skyboxVS"),fragmentGLSL:ie.get(e,oe).get("skyboxPS"),vertexWGSL:ie.get(e,le).get("skyboxVS"),fragmentWGSL:ie.get(e,le).get("skyboxPS"),attributes:{aPosition:te}});a.setDefine("{SKYBOX_DECODE_FNC}",li.decodeFunc(i.encoding)),r!==Fh&&a.setDefine("SKYMESH",""),i.cubemap&&a.setDefine("SKY_CUBEMAP",""),a.setParameter("skyboxHighlightMultiplier",t.skyboxHighlightMultiplier),i.cubemap?a.setParameter("texture_cubeMap",i):(a.setParameter("texture_envAtlas",i),a.setParameter("mipLevel",t.skyboxMip)),a.cull=2,a.depthWrite=this._depthWrite;let n=t.layers.getLayerById(to);if(n){let l=AA.create(e,r),h=new Oe(l,a,s);this.meshInstance=h,h.cull=!1,h.pick=!1,n.addMeshInstances([h]),this.skyLayer=n}}destroy(){this.meshInstance&&(this.skyLayer&&this.skyLayer.removeMeshInstances([this.meshInstance]),this.meshInstance.destroy(),this.meshInstance=null)}set depthWrite(e){this._depthWrite=e,this.meshInstance&&(this.meshInstance.material.depthWrite=e)}get depthWrite(){return this._depthWrite}}});var tp,tb=m(()=>{Q();J();Zt();yV();tp=class{constructor(e){this._type=Fh,this._center=new g(0,1,0),this.skyMesh=null,this._depthWrite=!1,this.node=new Ae("SkyMeshNode"),this.device=e.device,this.scene=e,this.center=new g(0,1,0),this.centerArray=new Float32Array(3),this.projectedSkydomeCenterId=this.device.scope.resolve("projectedSkydomeCenter")}applySettings(e){this.type=e.skyType??Fh,this.node.setLocalPosition(new g(e.skyMeshPosition??[0,0,0])),this.node.setLocalEulerAngles(new g(e.skyMeshRotation??[0,0,0])),this.node.setLocalScale(new g(e.skyMeshScale??[1,1,1])),e.skyCenter&&(this._center=new g(e.skyCenter))}set type(e){this._type!==e&&(this._type=e,this.scene.updateShaders=!0,this.updateSkyMesh())}get type(){return this._type}set center(e){this._center.copy(e)}get center(){return this._center}set depthWrite(e){this._depthWrite!==e&&(this._depthWrite=e,this.skyMesh&&(this.skyMesh.depthWrite=e))}get depthWrite(){return this._depthWrite}updateSkyMesh(){let e=this.scene._getSkyboxTex();e&&(this.resetSkyMesh(),this.skyMesh=new PA(this.device,this.scene,this.node,e,this.type),this.skyMesh.depthWrite=this._depthWrite,this.scene.fire("set:skybox",e))}resetSkyMesh(){this.skyMesh?.destroy(),this.skyMesh=null}update(){if(this.type!==Fh){let{center:e,centerArray:t}=this,s=new g;this.node.getWorldTransform().transformPoint(e,s),t[0]=s.x,t[1]=s.y,t[2]=s.z,this.projectedSkydomeCenterId.setValue(t)}}}});var RA,CA,AV=m(()=>{Ke();j();Ws();_s();Zt();RA=new Ae;RA.worldTransform=k.IDENTITY;RA._dirtyWorld=RA._dirtyNormal=!1;CA=class{constructor(e,t,s){this.material=t,this.layer=s,this.positions=[],this.colors=[],this.mesh=new Ce(e),this.meshInstance=null}addLines(e,t){let s=this.positions,i=e.length;for(let a=0;a<i;a++){let n=e[a];s.push(n.x,n.y,n.z)}let r=this.colors;if(t.length)for(let a=0;a<i;a++){let n=t[a];r.push(n.r,n.g,n.b,n.a)}else for(let a=0;a<i;a++)r.push(t.r,t.g,t.b,t.a)}addLinesArrays(e,t){let s=this.positions;for(let r=0;r<e.length;r+=3)s.push(e[r],e[r+1],e[r+2]);let i=this.colors;if(t.length)for(let r=0;r<t.length;r+=4)i.push(t[r],t[r+1],t[r+2],t[r+3]);else{let r=e.length/3;for(let a=0;a<r;a++)i.push(t.r,t.g,t.b,t.a)}}onPreRender(e,t){this.positions.length>0&&this.material.transparent===t&&(this.mesh.setPositions(this.positions),this.mesh.setColors(this.colors),this.mesh.update(Mn,!1),this.meshInstance||(this.meshInstance=new Oe(this.mesh,this.material,RA)),e.push(this.meshInstance))}clear(){this.positions.length=0,this.colors.length=0}}});var IA,PV=m(()=>{AV();IA=class{constructor(e){this.device=e,this.map=new Map}getBatch(e,t){let s=this.map.get(e);return s||(s=new CA(this.device,e,t),this.map.set(e,s)),s}onPreRender(e,t){this.map.forEach(s=>{s.onPreRender(e,t)})}clear(){this.map.forEach(e=>e.clear())}}});var Pa,sp,wA,RV=m(()=>{j();J();Zt();Ws();_s();$h();PV();Q();ed();It();Pa=[],sp=new g,wA=class{constructor(e){this.shaderDescs=new Map,this.device=e,this.quadMesh=null,this.textureShader=null,this.depthTextureShader=null,this.cubeLocalPos=null,this.cubeWorldPos=null,this.batchesMap=new Map,this.allBatches=new Set,this.updatedLayers=new Set,this._materialDepth=null,this._materialNoDepth=null,this.layerMeshInstances=new Map}createMaterial(e){let t=new oi({uniqueName:"ImmediateLine",vertexGLSL:ie.get(this.device,oe).get("immediateLineVS"),fragmentGLSL:ie.get(this.device,oe).get("immediateLinePS"),vertexWGSL:ie.get(this.device,le).get("immediateLineVS"),fragmentWGSL:ie.get(this.device,le).get("immediateLinePS"),attributes:{vertex_position:te,vertex_color:nt}});return t.blendType=es,t.depthTest=e,t.update(),t}get materialDepth(){return this._materialDepth||(this._materialDepth=this.createMaterial(!0)),this._materialDepth}get materialNoDepth(){return this._materialNoDepth||(this._materialNoDepth=this.createMaterial(!1)),this._materialNoDepth}getBatch(e,t){let s=this.batchesMap.get(e);s||(s=new IA(this.device),this.batchesMap.set(e,s)),this.allBatches.add(s);let i=t?this.materialDepth:this.materialNoDepth;return s.getBatch(i,e)}getShaderDesc(e,t,s){return this.shaderDescs.has(e)||this.shaderDescs.set(e,{uniqueName:`DebugShader:${e}`,vertexGLSL:`
					attribute vec2 vertex_position;
					uniform mat4 matrix_model;
					varying vec2 uv0;
					void main(void) {
						gl_Position = matrix_model * vec4(vertex_position, 0, 1);
						uv0 = vertex_position.xy + 0.5;
					}
				`,vertexWGSL:`
					attribute vertex_position: vec2f;
					uniform matrix_model: mat4x4f;
					varying uv0: vec2f;
					@vertex fn vertexMain(input: VertexInput) -> VertexOutput {
						var output: VertexOutput;
						output.position = uniform.matrix_model * vec4f(input.vertex_position, 0.0, 1.0);
						output.uv0 = input.vertex_position.xy + vec2f(0.5);
						return output;
					}
				`,fragmentGLSL:t,fragmentWGSL:s,attributes:{vertex_position:te}}),this.shaderDescs.get(e)}getTextureShaderDesc(e){let t=li.decodeFunc(e);return this.getShaderDesc(`textureShader-${e}`,`
			#include "gammaPS"
			varying vec2 uv0;
			uniform sampler2D colorMap;
			void main (void) {
				vec3 linearColor = ${t}(texture2D(colorMap, uv0));
				gl_FragColor = vec4(gammaCorrectOutput(linearColor), 1);
			}
		`,`
			#include "gammaPS"
			varying uv0: vec2f;
			var colorMap: texture_2d<f32>;
			var colorMapSampler: sampler;
			@fragment fn fragmentMain(input : FragmentInput) -> FragmentOutput {
				var output: FragmentOutput;
				let sampledTex = textureSample(colorMap, colorMapSampler, input.uv0);
				let linearColor: vec3f = ${t}(sampledTex);
				output.color = vec4f(gammaCorrectOutput(linearColor), 1.0);
				return output;
			}
		`)}getUnfilterableTextureShaderDesc(){return this.getShaderDesc("textureShaderUnfilterable",`
			varying vec2 uv0;
			uniform highp sampler2D colorMap;
			void main (void) {
				ivec2 uv = ivec2(uv0 * textureSize(colorMap, 0));
				gl_FragColor = vec4(texelFetch(colorMap, uv, 0).xyz, 1);
			}
		`,`
			varying uv0: vec2f;
			var colorMap: texture_2d<uff>;
			@fragment fn fragmentMain(input : FragmentInput) -> FragmentOutput {
				var output: FragmentOutput;
				let uv : vec2<i32> = vec2<i32>(input.uv0 * vec2f(textureDimensions(colorMap, 0)));
				let fetchedColor : vec4f = textureLoad(colorMap, uv, 0);
				output.color = vec4f(fetchedColor.xyz, 1.0);
				return output;
			}
		`)}getDepthTextureShaderDesc(){return this.getShaderDesc("depthTextureShader",`
			#include "screenDepthPS"
			#include "gammaPS"
			varying vec2 uv0;
			void main() {
				float depth = getLinearScreenDepth(getImageEffectUV(uv0)) * camera_params.x;
				gl_FragColor = vec4(gammaCorrectOutput(vec3(depth)), 1.0);
			}
		`,`
			#include "screenDepthPS"
			#include "gammaPS"
			varying uv0: vec2f;
			@fragment fn fragmentMain(input: FragmentInput) -> FragmentOutput {
				var output: FragmentOutput;
				let depth: f32 = getLinearScreenDepth(getImageEffectUV(input.uv0)) * uniform.camera_params.x;
				output.color = vec4f(gammaCorrectOutput(vec3f(depth)), 1.0);
				return output;
			}
		`)}getQuadMesh(){return this.quadMesh||(this.quadMesh=new Ce(this.device),this.quadMesh.setPositions([-.5,-.5,0,.5,-.5,0,-.5,.5,0,.5,.5,0]),this.quadMesh.update(rs)),this.quadMesh}drawMesh(e,t,s,i,r){if(!i){let n=this.getGraphNode(t);i=new Oe(s,e,n)}let a=this.layerMeshInstances.get(r);a||(a=[],this.layerMeshInstances.set(r,a)),a.push(i)}drawWireAlignedBox(e,t,s,i,r,a){if(a){let l=(h,c,f)=>{sp.set(h,c,f),a.transformPoint(sp,sp),Pa.push(sp.x,sp.y,sp.z)};l(e.x,e.y,e.z),l(e.x,t.y,e.z),l(e.x,t.y,e.z),l(t.x,t.y,e.z),l(t.x,t.y,e.z),l(t.x,e.y,e.z),l(t.x,e.y,e.z),l(e.x,e.y,e.z),l(e.x,e.y,t.z),l(e.x,t.y,t.z),l(e.x,t.y,t.z),l(t.x,t.y,t.z),l(t.x,t.y,t.z),l(t.x,e.y,t.z),l(t.x,e.y,t.z),l(e.x,e.y,t.z),l(e.x,e.y,e.z),l(e.x,e.y,t.z),l(e.x,t.y,e.z),l(e.x,t.y,t.z),l(t.x,t.y,e.z),l(t.x,t.y,t.z),l(t.x,e.y,e.z),l(t.x,e.y,t.z)}else Pa.push(e.x,e.y,e.z,e.x,t.y,e.z,e.x,t.y,e.z,t.x,t.y,e.z,t.x,t.y,e.z,t.x,e.y,e.z,t.x,e.y,e.z,e.x,e.y,e.z,e.x,e.y,t.z,e.x,t.y,t.z,e.x,t.y,t.z,t.x,t.y,t.z,t.x,t.y,t.z,t.x,e.y,t.z,t.x,e.y,t.z,e.x,e.y,t.z,e.x,e.y,e.z,e.x,e.y,t.z,e.x,t.y,e.z,e.x,t.y,t.z,t.x,t.y,e.z,t.x,t.y,t.z,t.x,e.y,e.z,t.x,e.y,t.z);this.getBatch(r,i).addLinesArrays(Pa,s),Pa.length=0}drawWireSphere(e,t,s,i,r,a){let n=2*Math.PI/i,l=0;for(let c=0;c<i;c++){let f=Math.sin(l),d=Math.cos(l);l+=n;let u=Math.sin(l),p=Math.cos(l);Pa.push(e.x+t*f,e.y,e.z+t*d),Pa.push(e.x+t*u,e.y,e.z+t*p),Pa.push(e.x+t*f,e.y+t*d,e.z),Pa.push(e.x+t*u,e.y+t*p,e.z),Pa.push(e.x,e.y+t*f,e.z+t*d),Pa.push(e.x,e.y+t*u,e.z+t*p)}this.getBatch(a,r).addLinesArrays(Pa,s),Pa.length=0}getGraphNode(e){let t=new Ae("ImmediateDebug");return t.worldTransform=e,t._dirtyWorld=t._dirtyNormal=!1,t}onPreRenderLayer(e,t,s){if(this.batchesMap.forEach((i,r)=>{r===e&&i.onPreRender(t,s)}),!this.updatedLayers.has(e)){this.updatedLayers.add(e);let i=this.layerMeshInstances.get(e);if(i){for(let r=0;r<i.length;r++)t.push(i[r]);i.length=0}}}onPostRender(){this.allBatches.forEach(e=>e.clear()),this.allBatches.clear(),this.updatedLayers.clear()}}});var CV,Qh,LA=m(()=>{me();CV=2.399963229728653,Qh={circlePoint(o){let e=Math.sqrt(Math.random()),t=Math.random()*2*Math.PI;o.x=e*Math.cos(t),o.y=e*Math.sin(t)},circlePointDeterministic(o,e,t){let s=e*CV,i=Math.sqrt(e)/Math.sqrt(t);o.x=i*Math.cos(s),o.y=i*Math.sin(s)},spherePointDeterministic(o,e,t,s=0,i=1){s=1-2*s,i=1-2*i;let r=w.lerp(s,i,e/t),a=Math.sqrt(1-r*r),n=CV*e;o.x=Math.cos(n)*a,o.y=r,o.z=Math.sin(n)*a},radicalInverse(o){let e=(o<<16|o>>>16)>>>0;return e=((e&1431655765)<<1|(e&2863311530)>>>1)>>>0,e=((e&858993459)<<2|(e&3435973836)>>>2)>>>0,e=((e&252645135)<<4|(e&4042322160)>>>4)>>>0,e=((e&16711935)<<8|(e&4278255360)>>>8)>>>0,e*23283064365386963e-26}}});function Ra(o,e,t={}){let s=t.seamPixels??0,i=(t.rect?.z??e.width)-s*2,r=(t.rect?.w??e.height)-s*2;if(i<1||r<1)return!1;let a={none:"reproject",lambert:"prefilterSamplesUnweighted",phong:"prefilterSamplesUnweighted",ggx:"prefilterSamples"},n=t.hasOwnProperty("specularPower")?t.specularPower:1,l=t.hasOwnProperty("face")?t.face:null,h=t.hasOwnProperty("distribution")?t.distribution:n===1?"none":"phong",c=a[h]||"reproject",f=c.startsWith("prefilterSamples"),d=li.decodeFunc(o.encoding),u=li.encodeFunc(e.encoding),p=`sample${IV(o.projection)}`,_=`getDirection${IV(e.projection)}`,S=t.hasOwnProperty("numSamples")?t.numSamples:1024,T=`ReprojectShader:${c}_${d}_${u}_${p}_${_}_${S}`,x=o.device,A=rr(x).getCachedShader(T);if(!A){let y=new Map;f&&y.set("USE_SAMPLES_TEX",""),o.cubemap&&y.set("CUBEMAP_SOURCE",""),y.set("{PROCESS_FUNC}",c),y.set("{DECODE_FUNC}",d),y.set("{ENCODE_FUNC}",u),y.set("{SOURCE_FUNC}",p),y.set("{TARGET_FUNC}",_),y.set("{NUM_SAMPLES}",S),y.set("{NUM_SAMPLES_SQRT}",Math.round(Math.sqrt(S)).toFixed(1));let C=x.isWebGPU,L=ie.get(x,C?le:oe),O=new Map;O.set("decodePS",L.get("decodePS")),O.set("encodePS",L.get("encodePS")),A=Te.createShader(x,{uniqueName:T,attributes:{vertex_position:te},vertexChunk:"reprojectVS",fragmentChunk:"reprojectPS",fragmentIncludes:O,fragmentDefines:y})}x.setBlendState(Ie.NOBLEND),x.scope.resolve(o.cubemap?"sourceCube":"sourceTex").setValue(o);let v=x.scope.resolve("params"),R=x.scope.resolve("uvMod");s>0?R.setValue([(i+s*2)/i,(r+s*2)/r,-s/i,-s/r]):R.setValue([1,1,0,0]);let P=[0,e.width*e.height*(e.cubemap?6:1),o.width*o.height*(o.cubemap?6:1)];if(f){let y=o.width*o.height*(o.cubemap?6:1),C=h==="ggx"?gne(x,S,n,y):h==="lambert"?pne(x,S,y):_ne(x,S,n);x.scope.resolve("samplesTex").setValue(C),x.scope.resolve("samplesTexInverseSize").setValue([1/C.width,1/C.height])}for(let y=0;y<(e.cubemap?6:1);y++)if(l===null||y===l){let C=new xe({colorBuffer:e,face:y,depth:!1,flipY:x.isWebGPU});P[0]=y,v.setValue(P),Ot(x,C,A,t?.rect),C.destroy()}return!0}var IV,bA,sne,ine,rne,ane,nne,one,lne,hne,cne,fne,dne,MA,une,mne,sb,pne,_ne,gne,ib=m(()=>{LA();Q();j();bi();Rt();Fe();ed();Uh();Dt();qt();Ea();It();IV=o=>{switch(o){case uf:return"Cubemap";case Pv:return"Octahedral";default:return"Equirect"}},bA=(o,e,t)=>{if(o<=0)e[t+0]=0,e[t+1]=0,e[t+2]=0,e[t+3]=0;else if(o>=1)e[t+0]=255,e[t+1]=0,e[t+2]=0,e[t+3]=0;else{let s=1*o%1,i=255*o%1,r=65025*o%1,a=16581375*o%1;s-=i/255,i-=r/255,r-=a/255,e[t+0]=Math.min(255,Math.floor(s*256)),e[t+1]=Math.min(255,Math.floor(i*256)),e[t+2]=Math.min(255,Math.floor(r*256)),e[t+3]=Math.min(255,Math.floor(a*256))}},sne=o=>{let e=o.length,t=Math.min(e,512),s=Math.ceil(e/t),i=new Uint8Array(t*s*4),r=0;for(let a=0;a<e;a+=4)bA(o[a+0]*.5+.5,i,r+0),bA(o[a+1]*.5+.5,i,r+4),bA(o[a+2]*.5+.5,i,r+8),bA(o[a+3]/8,i,r+12),r+=16;return{width:t,height:s,data:i}},ine=(o,e,t,s)=>{let i=t*2*Math.PI,r=Math.pow(1-e,1/(s+1)),a=Math.sqrt(1-r*r);o.set(Math.cos(i)*a,Math.sin(i)*a,r).normalize()},rne=(o,e,t)=>{let s=t*2*Math.PI,i=Math.sqrt(1-e),r=Math.sqrt(e);o.set(Math.cos(s)*r,Math.sin(s)*r,i).normalize()},ane=(o,e,t,s)=>{let i=t*2*Math.PI,r=Math.sqrt((1-e)/(1+(s*s-1)*e)),a=Math.sqrt(1-r*r);o.set(Math.cos(i)*a,Math.sin(i)*a,r).normalize()},nne=(o,e)=>{let t=o*e,s=e/(1-o*o+t*t);return s*s*(1/Math.PI)},one=(o,e)=>{let t=new g,s=[];for(let i=0;i<o;++i)ine(t,i/o,Qh.radicalInverse(i),e),s.push(t.x,t.y,t.z,0);return s},lne=(o,e)=>{let t=e/o,s=new g,i=[];for(let r=0;r<o;++r){rne(s,r/o,Qh.radicalInverse(r));let a=s.z/Math.PI,n=.5*Math.log2(t/a);i.push(s.x,s.y,s.z,n)}return i},hne={16:{2:26,8:20,32:17,128:16,512:16},32:{2:53,8:40,32:34,128:32,512:32},128:{2:214,8:163,32:139,128:130,512:128},1024:{2:1722,8:1310,32:1114,128:1041,512:1025}},cne=(o,e)=>{let t=hne[o];return t&&t[e]||o},fne=(o,e,t)=>{let s=t/o,i=1-Math.log2(e)/11,r=i*i,a=new g,n=new g,l=new g(0,0,1),h=[],c=cne(o,e);for(let f=0;f<c;++f){ane(a,f/c,Qh.radicalInverse(f),r);let d=a.z;if(n.set(a.x,a.y,a.z).mulScalar(2*d).sub(l),n.z>0){let u=nne(Math.min(1,d),r)/4+.001,p=.5*Math.log2(s/u);h.push(n.x,n.y,n.z,p)}}for(;h.length<o*4;)h.push(0,0,0,0);return h},dne=(o,e,t)=>{let s=sne(t);return new q(o,{name:e,width:s.width,height:s.height,mipmaps:!1,minFilter:0,magFilter:0,levels:[s.data]})},MA=class{constructor(e=!0){this.map=new Map,this.destroyContent=e}destroy(){this.destroyContent&&this.map.forEach((e,t)=>{e.destroy()})}get(e,t){if(!this.map.has(e)){let s=t();return this.map.set(e,s),s}return this.map.get(e)}},une=new MA(!1),mne=new st,sb=(o,e,t)=>mne.get(o,()=>new MA).get(e,()=>dne(o,e,une.get(e,t))),pne=(o,e,t)=>{let s=`lambert-samples-${e}-${t}`;return sb(o,s,()=>lne(e,t))},_ne=(o,e,t)=>{let s=`phong-samples-${e}-${t}`;return sb(o,s,()=>one(e,t))},gne=(o,e,t,s)=>{let i=`ggx-samples-${e}-${t}-${s}`;return sb(o,i,()=>fne(e,t,s))}});var rb,Sne,Tne,Ene,vne,xne,Jh,DA=m(()=>{Ze();Fe();ib();j();rb=(o,e=0)=>1+Math.floor(Math.log2(Math.max(o,e))),Sne=o=>o.textureHalfFloatRenderable,Tne=o=>o.textureFloatRenderable,Ene=o=>Sne(o)?12:Tne(o)?14:7,vne=o=>7,xne=(o,e,t,s)=>new q(o,{name:`lighting-${e}`,cubemap:!0,width:e,height:e,format:t,type:On,addressU:1,addressV:1,mipmaps:!1}),Jh=class{static generateSkyboxCubemap(e,t){let s=e.device,i=xne(s,t||(e.cubemap?e.width:e.width/4),7);return Ra(e,i,{numSamples:1024}),i}static generateLightingSource(e,t){let s=e.device,i=Ene(s),r=t?.target||new q(s,{name:"lighting-source",cubemap:!0,width:t?.size||128,height:t?.size||128,format:i,type:i===7?On:zt,addressU:1,addressV:1,mipmaps:!0});return Ra(e,r,{numSamples:e.mipmaps?1:1024}),r}static generateAtlas(e,t){let s=e.device,i=vne(),r=t?.target||new q(s,{name:"envAtlas",width:t?.size||512,height:t?.size||512,format:i,type:On,projection:lS,addressU:1,addressV:1,mipmaps:!1}),a=r.width/512,n=new W(0,0,512*a,256*a),l=rb(256)-rb(4);for(let h=0;h<l;++h)Ra(e,r,{numSamples:1,rect:n,seamPixels:a}),n.x+=n.w,n.y+=n.w,n.z=Math.max(1,Math.floor(n.z*.5)),n.w=Math.max(1,Math.floor(n.w*.5));n.set(0,256*a,256*a,128*a);for(let h=1;h<7;++h)Ra(e,r,{numSamples:t?.numReflectionSamples||1024,distribution:t?.distribution||"ggx",specularPower:Math.max(1,2048>>h*2),rect:n,seamPixels:a}),n.y+=n.w,n.z=Math.max(1,Math.floor(n.z*.5)),n.w=Math.max(1,Math.floor(n.w*.5));return n.set(128*a,384*a,64*a,32*a),Ra(e,r,{numSamples:t?.numAmbientSamples||2048,distribution:"lambert",rect:n,seamPixels:a}),r}static generatePrefilteredAtlas(e,t){let s=e[0].device,i=e[0].format,r=e[0].type,a=t?.target||new q(s,{name:"envPrefilteredAtlas",width:t?.size||512,height:t?.size||512,format:i,type:r,projection:lS,addressU:1,addressV:1,mipmaps:!1}),n=a.width/512,l=new W(0,0,512*n,256*n),h=rb(512);for(let c=0;c<h;++c)Ra(e[0],a,{numSamples:1,rect:l,seamPixels:n}),l.x+=l.w,l.y+=l.w,l.z=Math.max(1,Math.floor(l.z*.5)),l.w=Math.max(1,Math.floor(l.w*.5));l.set(0,256*n,256*n,128*n);for(let c=1;c<e.length;++c)Ra(e[c],a,{numSamples:1,rect:l,seamPixels:n}),l.y+=l.w,l.z=Math.max(1,Math.floor(l.z*.5)),l.w=Math.max(1,Math.floor(l.w*.5));return l.set(128*n,384*n,64*n,32*n),t?.legacyAmbient?Ra(e[5],a,{numSamples:1,rect:l,seamPixels:n}):Ra(e[0],a,{numSamples:t?.numSamples||2048,distribution:"lambert",rect:l,seamPixels:n}),a}}});var ip,ab=m(()=>{De();J();ip=class{constructor(){this.type=tr,this.color=new N(0,0,0),this.density=0,this.start=1,this.end=1e3}}});var qs,OA=m(()=>{Pe();De();Q();Ve();me();Zl();Ke();J();uA();tb();RV();DA();ab();qs=class extends K{static{this.EVENT_SETLAYERS="set:layers"}static{this.EVENT_SETSKYBOX="set:skybox"}static{this.EVENT_PRERENDER="prerender"}static{this.EVENT_POSTRENDER="postrender"}static{this.EVENT_PRERENDER_LAYER="prerender:layer"}static{this.EVENT_POSTRENDER_LAYER="postrender:layer"}static{this.EVENT_PRECULL="precull"}static{this.EVENT_POSTCULL="postcull"}constructor(e){super(),this.ambientBake=!1,this.ambientBakeOcclusionBrightness=0,this.ambientBakeOcclusionContrast=0,this.ambientLight=new N(0,0,0),this.ambientLuminance=0,this.exposure=1,this.lightmapSizeMultiplier=1,this.lightmapMaxResolution=2048,this.lightmapMode=Oh,this.lightmapFilterEnabled=!1,this.lightmapHDR=!1,this.root=null,this.physicalUnits=!1,this._envAtlas=null,this._skyboxCubeMap=null,this._fogParams=new ip,this.forcePassThroughSpecular=!1,this.device=e,this._gravity=new g(0,-9.8,0),this._layers=null,this._prefilteredCubemaps=[],this._internalEnvAtlas=null,this._skyboxIntensity=1,this._skyboxLuminance=0,this._skyboxMip=0,this._skyboxHighlightMultiplier=1,this._skyboxRotationShaderInclude=!1,this._skyboxRotation=new H,this._skyboxRotationMat3=new Vs,this._skyboxRotationMat4=new k,this._ambientBakeNumSamples=1,this._ambientBakeSpherePart=.4,this._lightmapFilterRange=10,this._lightmapFilterSmoothness=.2,this._clusteredLightingEnabled=!0,this._lightingParams=new qh(this.device.supportsAreaLights,this.device.maxTextureSize,()=>{this.updateShaders=!0}),this._sky=new tp(this),this._stats={meshInstances:0,lights:0,dynamicLights:0,bakedLights:0,updateShadersTime:0},this.updateShaders=!0,this._shaderVersion=0,this.immediate=new wA(this.device)}get defaultDrawLayer(){return this.layers.getLayerById(so)}set ambientBakeNumSamples(e){this._ambientBakeNumSamples=w.clamp(Math.floor(e),1,255)}get ambientBakeNumSamples(){return this._ambientBakeNumSamples}set ambientBakeSpherePart(e){this._ambientBakeSpherePart=w.clamp(e,.001,1)}get ambientBakeSpherePart(){return this._ambientBakeSpherePart}set clusteredLightingEnabled(e){if(!(this.device.isWebGPU&&!e)){if(!this._clusteredLightingEnabled&&e){console.error("Turning on disabled clustered lighting is not currently supported");return}this._clusteredLightingEnabled=e}}get clusteredLightingEnabled(){return this._clusteredLightingEnabled}set envAtlas(e){e!==this._envAtlas&&(this._envAtlas=e,e&&(e.addressU=1,e.addressV=1,e.minFilter=1,e.magFilter=1,e.mipmaps=!1),this._prefilteredCubemaps=[],this._internalEnvAtlas&&(this._internalEnvAtlas.destroy(),this._internalEnvAtlas=null),this._resetSkyMesh())}get envAtlas(){return this._envAtlas}set layers(e){let t=this._layers;this._layers=e,this.fire("set:layers",t,e)}get layers(){return this._layers}get sky(){return this._sky}get lighting(){return this._lightingParams}get fog(){return this._fogParams}set lightmapFilterRange(e){this._lightmapFilterRange=Math.max(e,.001)}get lightmapFilterRange(){return this._lightmapFilterRange}set lightmapFilterSmoothness(e){this._lightmapFilterSmoothness=Math.max(e,.001)}get lightmapFilterSmoothness(){return this._lightmapFilterSmoothness}set prefilteredCubemaps(e){e=e||[];let t=this._prefilteredCubemaps;(t.length!==e.length||t.some((i,r)=>i!==e[r]))&&(e.length===6&&e.every(r=>!!r)?(this._internalEnvAtlas=Jh.generatePrefilteredAtlas(e,{target:this._internalEnvAtlas}),this._envAtlas=this._internalEnvAtlas):(this._internalEnvAtlas&&(this._internalEnvAtlas.destroy(),this._internalEnvAtlas=null),this._envAtlas=null),this._prefilteredCubemaps=e.slice(),this._resetSkyMesh())}get prefilteredCubemaps(){return this._prefilteredCubemaps}set skybox(e){e!==this._skyboxCubeMap&&(this._skyboxCubeMap=e,this._resetSkyMesh())}get skybox(){return this._skyboxCubeMap}set skyboxIntensity(e){e!==this._skyboxIntensity&&(this._skyboxIntensity=e,this._resetSkyMesh())}get skyboxIntensity(){return this._skyboxIntensity}set skyboxLuminance(e){e!==this._skyboxLuminance&&(this._skyboxLuminance=e,this._resetSkyMesh())}get skyboxLuminance(){return this._skyboxLuminance}set skyboxMip(e){e!==this._skyboxMip&&(this._skyboxMip=e,this._resetSkyMesh())}get skyboxMip(){return this._skyboxMip}set skyboxHighlightMultiplier(e){e!==this._skyboxHighlightMultiplier&&(this._skyboxHighlightMultiplier=e,this._resetSkyMesh())}get skyboxHighlightMultiplier(){return this._skyboxHighlightMultiplier}set skyboxRotation(e){if(!this._skyboxRotation.equals(e)){let t=e.equals(H.IDENTITY);this._skyboxRotation.copy(e),t?this._skyboxRotationMat3.setIdentity():(this._skyboxRotationMat4.setTRS(g.ZERO,e,g.ONE),this._skyboxRotationMat3.invertMat4(this._skyboxRotationMat4)),!this._skyboxRotationShaderInclude&&!t&&(this._skyboxRotationShaderInclude=!0,this._resetSkyMesh())}}get skyboxRotation(){return this._skyboxRotation}destroy(){this._resetSkyMesh(),this.root=null,this.off()}drawLine(e,t,s=N.WHITE,i=!0,r=this.defaultDrawLayer){this.immediate.getBatch(r,i).addLines([e,t],[s,s])}drawLines(e,t,s=!0,i=this.defaultDrawLayer){this.immediate.getBatch(i,s).addLines(e,t)}drawLineArrays(e,t,s=!0,i=this.defaultDrawLayer){this.immediate.getBatch(i,s).addLinesArrays(e,t)}applySettings(e){let t=e.physics,s=e.render;this._gravity.set(t.gravity[0],t.gravity[1],t.gravity[2]),this.ambientLight.set(s.global_ambient[0],s.global_ambient[1],s.global_ambient[2]),this.ambientLuminance=s.ambientLuminance,this.fog.type=s.fog,this.fog.color.set(s.fog_color[0],s.fog_color[1],s.fog_color[2]),this.fog.start=s.fog_start,this.fog.end=s.fog_end,this.fog.density=s.fog_density,this.lightmapSizeMultiplier=s.lightmapSizeMultiplier,this.lightmapMaxResolution=s.lightmapMaxResolution,this.lightmapMode=s.lightmapMode,this.exposure=s.exposure,this._skyboxIntensity=s.skyboxIntensity??1,this._skyboxLuminance=s.skyboxLuminance??2e4,this._skyboxMip=s.skyboxMip??0,s.skyboxRotation&&(this.skyboxRotation=new H().setFromEulerAngles(s.skyboxRotation[0],s.skyboxRotation[1],s.skyboxRotation[2])),this.sky.applySettings(s),this.clusteredLightingEnabled=s.clusteredLightingEnabled??!1,this.lighting.applySettings(s),["lightmapFilterEnabled","lightmapFilterRange","lightmapFilterSmoothness","ambientBake","ambientBakeNumSamples","ambientBakeSpherePart","ambientBakeOcclusionBrightness","ambientBakeOcclusionContrast"].forEach(i=>{s.hasOwnProperty(i)&&(this[i]=s[i])}),this._resetSkyMesh()}_getSkyboxTex(){let e=this._prefilteredCubemaps;return this._skyboxMip?e[[0,1,3,4,5,6][this._skyboxMip]]||this._envAtlas||e[0]||this._skyboxCubeMap:this._skyboxCubeMap||e[0]||this._envAtlas}_updateSkyMesh(){this.sky.skyMesh||this.sky.updateSkyMesh(),this.sky.update()}_resetSkyMesh(){this.sky.resetSkyMesh(),this.updateShaders=!0}setSkybox(e){e?(this.skybox=e[0]||null,e[1]&&!e[1].cubemap?this.envAtlas=e[1]:this.prefilteredCubemaps=e.slice(1)):(this.skybox=null,this.envAtlas=null)}get lightmapPixelFormat(){return this.lightmapHDR&&this.device.getRenderableHdrFormat()||7}}});var ec,NA=m(()=>{ec=class{constructor(e,t,s){this.device=e,this.inverseBindPose=t,this.boneNames=s}}});var yne,Ane,rp,nb=m(()=>{Pe();Ne();J();Ws();nn();yne=[0,0,1,0,0,1,0,0,1,0,0,1],Ane=[0,1,3,2,3,1],rp=class extends K{constructor(e,t){super(),this._device=e,this._pixelsPerUnit=t&&t.pixelsPerUnit!==void 0?t.pixelsPerUnit:1,this._renderMode=t&&t.renderMode!==void 0?t.renderMode:ni,this._atlas=t&&t.atlas!==void 0?t.atlas:null,this._frameKeys=t&&t.frameKeys!==void 0?t.frameKeys:null,this._meshes=[],this._updatingProperties=!1,this._meshesDirty=!1,this._atlas&&this._frameKeys&&this._createMeshes()}set frameKeys(e){this._frameKeys=e,this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes()),this.fire("set:frameKeys",e)}get frameKeys(){return this._frameKeys}set atlas(e){e!==this._atlas&&(this._atlas&&(this._atlas.off("set:frames",this._onSetFrames,this),this._atlas.off("set:frame",this._onFrameChanged,this),this._atlas.off("remove:frame",this._onFrameRemoved,this)),this._atlas=e,this._atlas&&this._frameKeys&&(this._atlas.on("set:frames",this._onSetFrames,this),this._atlas.on("set:frame",this._onFrameChanged,this),this._atlas.on("remove:frame",this._onFrameRemoved,this),this._updatingProperties?this._meshesDirty=!0:this._createMeshes()),this.fire("set:atlas",e))}get atlas(){return this._atlas}set pixelsPerUnit(e){this._pixelsPerUnit!==e&&(this._pixelsPerUnit=e,this.fire("set:pixelsPerUnit",e),this._atlas&&this._frameKeys&&this.renderMode===ni&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes()))}get pixelsPerUnit(){return this._pixelsPerUnit}set renderMode(e){if(this._renderMode===e)return;let t=this._renderMode;this._renderMode=e,this.fire("set:renderMode",e),(t===ni||e===ni)&&this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes())}get renderMode(){return this._renderMode}get meshes(){return this._meshes}_createMeshes(){let e=this._meshes.length;for(let i=0;i<e;i++){let r=this._meshes[i];r&&r.destroy()}let t=this._frameKeys.length;this._meshes=new Array(t);let s=this.renderMode===Et||this._renderMode===vt?this._create9SliceMesh:this._createSimpleMesh;for(let i=0;i<t;i++){let r=this._atlas.frames[this._frameKeys[i]];this._meshes[i]=r?s.call(this,r):null}this.fire("set:meshes")}_createSimpleMesh(e){let t=e.rect,s=this._atlas.texture.width,i=this._atlas.texture.height,r=t.z/this._pixelsPerUnit,a=t.w/this._pixelsPerUnit,n=e.pivot.x,l=e.pivot.y,h=[-n*r,-l*a,0,(1-n)*r,-l*a,0,(1-n)*r,(1-l)*a,0,-n*r,(1-l)*a,0],c=t.x/s,f=1-t.y/i,d=(t.x+t.z)/s,u=1-(t.y+t.w)/i,p=[c,f,d,f,d,u,c,u],_=new Qt;return _.positions=h,_.normals=yne,_.uvs=p,_.indices=Ane,Ce.fromGeometry(this._device,_)}_create9SliceMesh(){let e=D.ONE,t=3,s=3,i=[],r=[],a=[],n=[],l=0;for(let c=0;c<=t;c++){let f=c===0||c===t?0:1;for(let d=0;d<=s;d++){let u=-e.x+2*e.x*(c<=1?0:3)/t,p=0,_=-(-e.y+2*e.y*(d<=1?0:3)/s),S=d===0||d===s?0:1;i.push(-u,p,_),r.push(0,1,0),a.push(f,S),c<t&&d<s&&(n.push(l+s+1,l+1,l),n.push(l+s+1,l+s+2,l+1)),l++}}let h=new Qt;return h.positions=i,h.normals=r,h.uvs=a,h.indices=n,Ce.fromGeometry(this._device,h)}_onSetFrames(e){this._updatingProperties?this._meshesDirty=!0:this._createMeshes()}_onFrameChanged(e,t){let s=this._frameKeys.indexOf(e);s<0||(t?this.renderMode===ni&&(this._meshes[s]=this._createSimpleMesh(t)):this._meshes[s]=null,this.fire("set:meshes"))}_onFrameRemoved(e){let t=this._frameKeys.indexOf(e);t<0||(this._meshes[t]=null,this.fire("set:meshes"))}startUpdate(){this._updatingProperties=!0,this._meshesDirty=!1}endUpdate(){this._updatingProperties=!1,this._meshesDirty&&this._atlas&&this._frameKeys&&this._createMeshes(),this._meshesDirty=!1}destroy(){for(let e of this._meshes)e&&e.destroy();this._meshes.length=0}}});var ap,ob=m(()=>{Pe();ap=class extends K{constructor(){super(),this._texture=null,this._frames=null}set texture(e){this._texture=e,this.fire("set:texture",e)}get texture(){return this._texture}set frames(e){this._frames=e,this.fire("set:frames",e)}get frames(){return this._frames}setFrame(e,t){let s=this._frames[e];s?(s.rect.copy(t.rect),s.pivot.copy(t.pivot),s.border.copy(t.border)):(s={rect:t.rect.clone(),pivot:t.pivot.clone(),border:t.border.clone()},this._frames[e]=s),this.fire("set:frame",e.toString(),s)}removeFrame(e){let t=this._frames[e];t&&(delete this._frames[e],this.fire("remove:frame",e.toString(),t))}destroy(){this._texture&&this._texture.destroy()}}});var dl,ul,sd,FA=m(()=>{dl=class{constructor(e,t,s,i){this.time=e,this.position=t,this.rotation=s,this.scale=i}},ul=class{constructor(){this._name="",this._keys=[]}},sd=class{constructor(){this.name="",this.duration=0,this._nodes=[],this._nodeDict={}}getNode(e){return this._nodeDict[e]}addNode(e){this._nodes.push(e),this._nodeDict[e._name]=e}get nodes(){return this._nodes}}});var lb,tc,hb=m(()=>{Ve();Q();lb=class{constructor(){this._written=!1,this._name="",this._keyFrames=[],this._quat=new H,this._pos=new g,this._scale=new g,this._targetNode=null}getTarget(){return this._targetNode}setTarget(e){this._targetNode=e}},tc=class{constructor(e){this.looping=!0,this._animation=null,this._time=0,this._interpolatedKeys=[],this._interpolatedKeyDict={},this._currKeyIndices={},this.graph=null;let t=s=>{let i=new lb;i._name=s.name,this._interpolatedKeys.push(i),this._interpolatedKeyDict[s.name]=i,this._currKeyIndices[s.name]=0;for(let r=0;r<s._children.length;r++)t(s._children[r])};t(e)}set animation(e){this._animation=e,this.currentTime=0}get animation(){return this._animation}set currentTime(e){this._time=e;let t=this._interpolatedKeys.length;for(let s=0;s<t;s++){let r=this._interpolatedKeys[s]._name;this._currKeyIndices[r]=0}this.addTime(0),this.updateGraph()}get currentTime(){return this._time}get numNodes(){return this._interpolatedKeys.length}addTime(e){if(this._animation!==null){let t=this._animation._nodes,s=this._animation.duration;if(this._time===s&&!this.looping)return;if(this._time+=e,this._time>s){this._time=this.looping?0:s;for(let r=0;r<t.length;r++){let n=t[r]._name;this._currKeyIndices[n]=0}}else if(this._time<0){this._time=this.looping?s:0;for(let r=0;r<t.length;r++){let a=t[r],n=a._name;this._currKeyIndices[n]=a._keys.length-2}}let i=e>=0?1:-1;for(let r=0;r<t.length;r++){let a=t[r],n=a._name,l=a._keys,h=this._interpolatedKeyDict[n];if(h===void 0)continue;let c=!1;if(l.length!==1)for(let f=this._currKeyIndices[n];f<l.length-1&&f>=0;f+=i){let d=l[f],u=l[f+1];if(d.time<=this._time&&u.time>=this._time){let p=(this._time-d.time)/(u.time-d.time);h._pos.lerp(d.position,u.position,p),h._quat.slerp(d.rotation,u.rotation,p),h._scale.lerp(d.scale,u.scale,p),h._written=!0,this._currKeyIndices[n]=f,c=!0;break}}(l.length===1||!c&&this._time===0&&this.looping)&&(h._pos.copy(l[0].position),h._quat.copy(l[0].rotation),h._scale.copy(l[0].scale),h._written=!0)}}}blend(e,t,s){let i=this._interpolatedKeys.length;for(let r=0;r<i;r++){let a=e._interpolatedKeys[r],n=t._interpolatedKeys[r],l=this._interpolatedKeys[r];a._written&&n._written?(l._quat.slerp(a._quat,t._interpolatedKeys[r]._quat,s),l._pos.lerp(a._pos,t._interpolatedKeys[r]._pos,s),l._scale.lerp(a._scale,n._scale,s),l._written=!0):a._written?(l._quat.copy(a._quat),l._pos.copy(a._pos),l._scale.copy(a._scale),l._written=!0):n._written&&(l._quat.copy(n._quat),l._pos.copy(n._pos),l._scale.copy(n._scale),l._written=!0)}}setGraph(e){if(this.graph=e,e)for(let t=0;t<this._interpolatedKeys.length;t++){let s=this._interpolatedKeys[t],i=e.findByName(s._name);this._interpolatedKeys[t].setTarget(i)}else for(let t=0;t<this._interpolatedKeys.length;t++)this._interpolatedKeys[t].setTarget(null)}updateGraph(){if(this.graph)for(let e=0;e<this._interpolatedKeys.length;e++){let t=this._interpolatedKeys[e];if(t._written){let s=t.getTarget();s.localPosition.copy(t._pos),s.localRotation.copy(t._quat),s.localScale.copy(t._scale),s._dirtyLocal||s._dirtifyLocal(),t._written=!1}}}}});var Pne,UA,wV=m(()=>{Ze();qt();Ea();Pne=new W,UA=class{constructor(e){this.device=e,this.needsDepthBuffer=!1}static{this.quadVertexShader=`
				attribute vec2 aPosition;
				varying vec2 vUv0;
				void main(void)
				{
						gl_Position = vec4(aPosition, 0.0, 1.0);
						vUv0 = getImageEffectUV((aPosition.xy + 1.0) * 0.5);
				}
		`}render(e,t,s){}drawQuad(e,t,s){let i;if(s){let r=e?e.width:this.device.width,a=e?e.height:this.device.height;i=Pne.set(s.x*r,s.y*a,s.z*r,s.w*a)}this.device.setBlendState(Ie.NOBLEND),Ot(this.device,e,t,i)}}});var gs,go=m(()=>{zf();qt();ii();us();gs=class extends Xe{set shader(e){this.quadRender?.destroy(),this.quadRender=null,this._shader=e,e&&(this.quadRender=new Oi(e))}get shader(){return this._shader}execute(){let e=this.device;e.setBlendState(this.blendState),e.setCullMode(this.cullMode),e.setDepthState(this.depthState),e.setStencilState(this.stencilFront,this.stencilBack),this.quadRender.render()}constructor(...e){super(...e),this._shader=null,this.quadRender=null,this.cullMode=0,this.blendState=Ie.NOBLEND,this.depthState=$e.NODEPTH,this.stencilFront=null,this.stencilBack=null}}});var on,sT=m(()=>{J();on=class{constructor(){this.hasTangents=!1,this.shaderChunks=null,this.pass=0,this.alphaTest=!1,this.blendType=$t,this.separateAmbient=!1,this.screenSpace=!1,this.skin=!1,this.batch=!1,this.useInstancing=!1,this.useMorphPosition=!1,this.useMorphNormal=!1,this.useMorphTextureBasedInt=!1,this.nineSlicedMode=0,this.clusteredLightingEnabled=!0,this.clusteredLightingCookiesEnabled=!1,this.clusteredLightingShadowsEnabled=!1,this.clusteredLightingShadowType=0,this.clusteredLightingAreaLightsEnabled=!1,this.vertexColors=!1,this.lightMapEnabled=!1,this.dirLightMapEnabled=!1,this.useHeights=!1,this.useNormals=!1,this.useClearCoatNormals=!1,this.useAo=!1,this.diffuseMapEnabled=!1,this.pixelSnap=!1,this.ambientSH=!1,this.ssao=!1,this.twoSidedLighting=!1,this.occludeDirect=!1,this.occludeSpecular=0,this.occludeSpecularFloat=!1,this.useMsdf=!1,this.msdfTextAttribute=!1,this.alphaToCoverage=!1,this.opacityFadesSpecular=!1,this.opacityDither=Ei,this.opacityShadowDither=Ei,this.cubeMapProjection=0,this.useSpecular=!1,this.useSpecularityFactor=!1,this.enableGGXSpecular=!1,this.fresnelModel=0,this.useRefraction=!1,this.useClearCoat=!1,this.useSheen=!1,this.useIridescence=!1,this.useMetalness=!1,this.useDynamicRefraction=!1,this.dispersion=!1,this.fog=tr,this.gamma=Mi,this.toneMap=-1,this.reflectionSource=sr,this.reflectionEncoding=null,this.reflectionCubemapEncoding=null,this.ambientSource="constant",this.ambientEncoding=null,this.skyboxIntensity=1,this.useCubeMapRotation=!1,this.lightMapWithoutAmbient=!1,this.lights=[],this.noShadow=!1,this.lightMaskDynamic=0,this.userAttributes={},this.linearDepth=!1,this.shadowCatcher=!1}}});var BA,LV=m(()=>{sT();BA=class{constructor(){this.litOptions=new on}}});var sc,cb=m(()=>{J();sc=class o{static update(e,t,s,i,r,a,n){o.updateSharedOptions(e,t,s,r,a),o.updateMaterialOptions(e,t),o.updateEnvOptions(e,t,s,i),o.updateLightingOptions(e,t,s,r,n)}static updateSharedOptions(e,t,s,i,r){e.shaderChunks=t.shaderChunks,e.pass=r,e.alphaTest=t.alphaTest>0,e.blendType=t.blendType,e.screenSpace=i&&(i&bh)!==0,e.skin=i&&(i&ao)!==0,e.useInstancing=i&&(i&no)!==0,e.useMorphPosition=i&&(i&oo)!==0,e.useMorphNormal=i&&(i&lo)!==0,e.useMorphTextureBasedInt=i&&(i&ho)!==0,e.hasTangents=i&&(i&Mh)!==0,e.nineSlicedMode=t.nineSlicedMode||ni,t.useLighting&&s.clusteredLightingEnabled?(e.clusteredLightingEnabled=!0,e.clusteredLightingCookiesEnabled=s.lighting.cookiesEnabled,e.clusteredLightingShadowsEnabled=s.lighting.shadowsEnabled,e.clusteredLightingShadowType=s.lighting.shadowType,e.clusteredLightingAreaLightsEnabled=s.lighting.areaLightsEnabled):(e.clusteredLightingEnabled=!1,e.clusteredLightingCookiesEnabled=!1,e.clusteredLightingShadowsEnabled=!1,e.clusteredLightingAreaLightsEnabled=!1)}static updateMaterialOptions(e,t){e.separateAmbient=!1,e.pixelSnap=t.pixelSnap,e.ambientSH=t.ambientSH,e.twoSidedLighting=t.twoSidedLighting,e.occludeDirect=t.occludeDirect,e.occludeSpecular=t.occludeSpecular,e.occludeSpecularFloat=t.occludeSpecularIntensity!==1,e.useMsdf=!1,e.msdfTextAttribute=!1,e.alphaToCoverage=t.alphaToCoverage,e.opacityFadesSpecular=t.opacityFadesSpecular,e.opacityDither=t.opacityDither,e.cubeMapProjection=Of,e.useSpecular=t.hasSpecular,e.useSpecularityFactor=t.hasSpecularityFactor,e.enableGGXSpecular=t.ggxSpecular,e.fresnelModel=t.fresnelModel,e.useRefraction=t.hasRefraction,e.useClearCoat=t.hasClearCoat,e.useSheen=t.hasSheen,e.useIridescence=t.hasIrridescence,e.useMetalness=t.hasMetalness,e.useDynamicRefraction=t.dynamicRefraction,e.dispersion=t.dispersion>0,e.vertexColors=!1,e.lightMapEnabled=t.hasLighting,e.dirLightMapEnabled=t.dirLightMap,e.useHeights=t.hasHeights,e.useNormals=t.hasNormals,e.useClearCoatNormals=t.hasClearCoatNormals,e.useAo=t.hasAo,e.diffuseMapEnabled=t.hasDiffuseMap}static updateEnvOptions(e,t,s,i){e.fog=t.useFog?i.fog:tr,e.gamma=i.shaderOutputGamma,e.toneMap=t.useTonemap?i.toneMapping:Ah,t.useSkybox&&s.envAtlas&&s.skybox?(e.reflectionSource=Ch,e.reflectionEncoding=s.envAtlas.encoding,e.reflectionCubemapEncoding=s.skybox.encoding):t.useSkybox&&s.envAtlas?(e.reflectionSource=Rh,e.reflectionEncoding=s.envAtlas.encoding):t.useSkybox&&s.skybox?(e.reflectionSource=Ih,e.reflectionEncoding=s.skybox.encoding):(e.reflectionSource=sr,e.reflectionEncoding=null),t.ambientSH?(e.ambientSource=Nf,e.ambientEncoding=null):e.reflectionSource!==sr&&s.envAtlas?(e.ambientSource=Ff,e.ambientEncoding=s.envAtlas.encoding):(e.ambientSource=Uf,e.ambientEncoding=null);let r=e.reflectionSource!==sr;e.skyboxIntensity=r,e.useCubeMapRotation=r&&s._skyboxRotationShaderInclude}static updateLightingOptions(e,t,s,i,r){if(e.lightMapWithoutAmbient=!1,t.useLighting){let a=[],n=i?i>>16:ps;e.lightMaskDynamic=!!(n&ps),e.lightMapWithoutAmbient=!1,r&&(o.collectLights(ge,r[ge],a,n),s.clusteredLightingEnabled||(o.collectLights(Ge,r[Ge],a,n),o.collectLights(Ye,r[Ye],a,n))),e.lights=a}else e.lights=[];(e.lights.length===0&&!s.clusteredLightingEnabled||(i&wh)!==0)&&(e.noShadow=!0)}static collectLights(e,t,s,i){for(let r=0;r<t.length;r++){let a=t[r];a.enabled&&a.mask&i&&s.push(a)}}}});var fb,np,db=m(()=>{j();J();ed();el();It();fb={vertex_normal:Pt,vertex_tangent:as,vertex_texCoord0:ot,vertex_texCoord1:ks,vertex_color:nt,vertex_boneWeights:hs,vertex_boneIndices:Gt},np=class{constructor(e,t,s=!0){this.varyingsCode="",this.vDefines=new Map,this.fDefines=new Map,this.includes=new Map,this.chunks=null,this.device=e,this.options=t;let i=t.shaderChunks;if(this.shaderLanguage=e.isWebGPU&&s&&i?.useWGSL?le:oe,this.attributes={vertex_position:te},t.userAttributes)for(let[a,n]of Object.entries(t.userAttributes))this.attributes[n]=a;let r=ie.get(e,this.shaderLanguage);this.chunks=new Map(r),i&&(this.shaderLanguage===oe?i.glsl:i.wgsl).forEach((n,l)=>{for(let h in fb)fb.hasOwnProperty(h)&&n.indexOf(h)>=0&&(this.attributes[h]=fb[h]);this.chunks.set(l,n)}),this.shaderPassInfo=Ds.get(this.device).getByIndex(t.pass),this.shadowPass=this.shaderPassInfo.isShadow,this.lighting=t.lights.length>0||t.dirLightMapEnabled||t.clusteredLightingEnabled,this.reflections=t.reflectionSource!==sr,this.needsNormal=this.lighting||this.reflections||t.useSpecular||t.ambientSH||t.useHeights||t.enableGGXSpecular||t.clusteredLightingEnabled&&!this.shadowPass||t.useClearCoatNormals,this.needsNormal=this.needsNormal&&!this.shadowPass,this.needsSceneColor=t.useDynamicRefraction,this.needsScreenSize=t.useDynamicRefraction,this.needsTransforms=t.useDynamicRefraction,this.vshader=null,this.fshader=null}fDefineSet(e,t,s=""){e&&this.fDefines.set(t,s)}generateVertexShader(e,t,s){let{options:i,vDefines:r,attributes:a}=this,n=new Map;if(n.set("vPositionW","vec3"),(i.nineSlicedMode===Et||i.nineSlicedMode===vt)&&r.set("NINESLICED",!0),this.options.linearDepth&&(r.set("LINEAR_DEPTH",!0),n.set("vLinearDepth","float")),this.needsNormal&&r.set("NORMALS",!0),this.options.useInstancing){let f=ie.get(this.device,this.shaderLanguage);this.chunks.get("transformInstancingVS")===f.get("transformInstancingVS")&&(a.instance_line1=lf,a.instance_line2=hf,a.instance_line3=ff,a.instance_line4=ta)}this.needsNormal&&(a.vertex_normal=Pt,n.set("vNormalW","vec3"),i.hasTangents&&(i.useHeights||i.useNormals||i.useClearCoatNormals||i.enableGGXSpecular)?(r.set("TANGENTS",!0),a.vertex_tangent=as,n.set("vTangentW","vec3"),n.set("vBinormalW","vec3")):i.enableGGXSpecular&&(r.set("GGX_SPECULAR",!0),n.set("vObjectSpaceUpW","vec3")));let l=2;for(let f=0;f<l;f++)e[f]&&(r.set(`UV${f}`,!0),a[`vertex_texCoord${f}`]=`TEXCOORD${f}`),t[f]&&(r.set(`UV${f}_UNMODIFIED`,!0),n.set(`vUv${f}`,"vec2"));let h=0,c=new Set;s.forEach(f=>{let{id:d,uv:u,name:p}=f,_=d+u*100;if(!c.has(_)){c.add(_),n.set(`vUV${u}_${d}`,"vec2");let S=`texture_${p}MapTransform`;r.set(`{TRANSFORM_NAME_${h}}`,S),r.set(`{TRANSFORM_UV_${h}}`,u),r.set(`{TRANSFORM_ID_${h}}`,d),h++}}),r.set("UV_TRANSFORMS_COUNT",h),i.vertexColors&&(a.vertex_color=nt,r.set("VERTEX_COLOR",!0),n.set("vVertexColor","vec4")),i.useMsdf&&i.msdfTextAttribute&&(a.vertex_outlineParameters=ko,a.vertex_shadowParameters=Go,r.set("MSDF",!0)),(i.useMorphPosition||i.useMorphNormal)&&(r.set("MORPHING",!0),i.useMorphTextureBasedInt&&r.set("MORPHING_INT",!0),i.useMorphPosition&&r.set("MORPHING_POSITION",!0),i.useMorphNormal&&r.set("MORPHING_NORMAL",!0),a.morph_vertex_id=ta),i.skin&&(a.vertex_boneIndices=Gt,i.batch?r.set("BATCH",!0):(a.vertex_boneWeights=hs,r.set("SKIN",!0))),i.useInstancing&&r.set("INSTANCING",!0),i.screenSpace&&r.set("SCREENSPACE",!0),i.pixelSnap&&r.set("PIXELSNAP",!0),n.forEach((f,d)=>{this.varyingsCode+=`#define VARYING_${d.toUpperCase()}
`,this.varyingsCode+=this.shaderLanguage===le?`varying ${d}: ${Xu.get(f)};
`:`varying ${f} ${d};
`}),this.includes.set("varyingsVS",this.varyingsCode),this.includes.set("varyingsPS",this.varyingsCode),this.vshader=`
						#include "litMainVS"
				`}_setupLightingDefines(e,t){let s=this.fDefines,i=this.options;if(this.fDefines.set("LIGHT_COUNT",i.lights.length),e&&s.set("AREA_LIGHTS",!0),t&&this.lighting&&(s.set("LIT_CLUSTERED_LIGHTS",!0),i.clusteredLightingCookiesEnabled&&s.set("CLUSTER_COOKIES",!0),i.clusteredLightingAreaLightsEnabled&&s.set("CLUSTER_AREALIGHTS",!0),i.lightMaskDynamic&&s.set("CLUSTER_MESH_DYNAMIC_LIGHTS",!0),i.clusteredLightingShadowsEnabled&&!i.noShadow)){let r=gi.get(i.clusteredLightingShadowType);s.set("CLUSTER_SHADOWS",!0),s.set(`SHADOW_KIND_${r.kind}`,!0),s.set(`CLUSTER_SHADOW_TYPE_${r.kind}`,!0)}for(let r=0;r<i.lights.length;r++){let a=i.lights[r],n=a._type;if(t&&n!==ge)continue;let l=e&&a._shape?a._shape:bs,h=a._shadowType,c=a.castShadows&&!i.noShadow,f=gi.get(h);s.set(`LIGHT${r}`,!0),s.set(`LIGHT${r}TYPE`,`${RS[n]}`),s.set(`LIGHT${r}SHADOWTYPE`,`${f.name}`),s.set(`LIGHT${r}SHAPE`,`${hy[l]}`),s.set(`LIGHT${r}FALLOFF`,`${cy[a._falloffMode]}`),a.affectSpecularity&&s.set(`LIGHT${r}AFFECT_SPECULARITY`,!0),a._cookie&&(n===Ye&&!a._cookie._cubemap||n===Ge&&a._cookie._cubemap)&&(s.set(`LIGHT${r}COOKIE`,!0),s.set(`{LIGHT${r}COOKIE_CHANNEL}`,a._cookieChannel),n===Ye&&(a._cookieTransform&&s.set(`LIGHT${r}COOKIE_TRANSFORM`,!0),a._cookieFalloff&&s.set(`LIGHT${r}COOKIE_FALLOFF`,!0))),c&&(s.set(`LIGHT${r}CASTSHADOW`,!0),f.pcf&&s.set(`LIGHT${r}SHADOW_PCF`,!0),a._normalOffsetBias&&!a._isVsm&&s.set(`LIGHT${r}_SHADOW_SAMPLE_NORMAL_OFFSET`,!0),n===ge&&(s.set(`LIGHT${r}_SHADOW_SAMPLE_ORTHO`,!0),a.cascadeBlend>0&&s.set(`LIGHT${r}_SHADOW_CASCADE_BLEND`,!0),a.numCascades>1&&s.set(`LIGHT${r}_SHADOW_CASCADES`,!0)),(f.pcf||f.pcss||this.device.isWebGPU)&&s.set(`LIGHT${r}_SHADOW_SAMPLE_SOURCE_ZBUFFER`,!0),n===Ge&&s.set(`LIGHT${r}_SHADOW_SAMPLE_POINT`,!0)),c&&(s.set(`SHADOW_KIND_${f.kind}`,!0),n===ge&&s.set("SHADOW_DIRECTIONAL",!0))}}prepareForwardPass(e){let{options:t}=this,i=t.clusteredLightingEnabled&&t.clusteredLightingAreaLightsEnabled||t.lights.some(n=>n._shape&&n._shape!==bs),r=!t.lightMapEnabled||t.lightMapWithoutAmbient,a=this.needsNormal&&(t.useNormals||t.useClearCoatNormals||t.enableGGXSpecular&&!t.useHeights);t.useSpecular&&(this.fDefineSet(!0,"LIT_SPECULAR"),this.fDefineSet(this.reflections,"LIT_REFLECTIONS"),this.fDefineSet(t.useClearCoat,"LIT_CLEARCOAT"),this.fDefineSet(t.fresnelModel>0,"LIT_SPECULAR_FRESNEL"),this.fDefineSet(t.useSheen,"LIT_SHEEN"),this.fDefineSet(t.useIridescence,"LIT_IRIDESCENCE")),this.fDefineSet(this.lighting&&t.useSpecular||this.reflections,"LIT_SPECULAR_OR_REFLECTION"),this.fDefineSet(this.needsSceneColor,"LIT_SCENE_COLOR"),this.fDefineSet(this.needsScreenSize,"LIT_SCREEN_SIZE"),this.fDefineSet(this.needsTransforms,"LIT_TRANSFORMS"),this.fDefineSet(this.needsNormal,"LIT_NEEDS_NORMAL"),this.fDefineSet(this.lighting,"LIT_LIGHTING"),this.fDefineSet(t.useMetalness,"LIT_METALNESS"),this.fDefineSet(t.enableGGXSpecular,"LIT_GGX_SPECULAR"),this.fDefineSet(t.useSpecularityFactor,"LIT_SPECULARITY_FACTOR"),this.fDefineSet(t.useCubeMapRotation,"CUBEMAP_ROTATION"),this.fDefineSet(t.occludeSpecularFloat,"LIT_OCCLUDE_SPECULAR_FLOAT"),this.fDefineSet(t.separateAmbient,"LIT_SEPARATE_AMBIENT"),this.fDefineSet(t.twoSidedLighting,"LIT_TWO_SIDED_LIGHTING"),this.fDefineSet(t.lightMapEnabled,"LIT_LIGHTMAP"),this.fDefineSet(t.dirLightMapEnabled,"LIT_DIR_LIGHTMAP"),this.fDefineSet(t.skyboxIntensity>0,"LIT_SKYBOX_INTENSITY"),this.fDefineSet(t.clusteredLightingShadowsEnabled,"LIT_CLUSTERED_SHADOWS"),this.fDefineSet(t.clusteredLightingAreaLightsEnabled,"LIT_CLUSTERED_AREA_LIGHTS"),this.fDefineSet(a,"LIT_TBN"),this.fDefineSet(r,"LIT_ADD_AMBIENT"),this.fDefineSet(t.hasTangents,"LIT_TANGENTS"),this.fDefineSet(t.useNormals,"LIT_USE_NORMALS"),this.fDefineSet(t.useClearCoatNormals,"LIT_USE_CLEARCOAT_NORMALS"),this.fDefineSet(t.useRefraction,"LIT_REFRACTION"),this.fDefineSet(t.useDynamicRefraction,"LIT_DYNAMIC_REFRACTION"),this.fDefineSet(t.dispersion,"LIT_DISPERSION"),this.fDefineSet(t.useHeights,"LIT_HEIGHTS"),this.fDefineSet(t.opacityFadesSpecular,"LIT_OPACITY_FADES_SPECULAR"),this.fDefineSet(t.alphaToCoverage,"LIT_ALPHA_TO_COVERAGE"),this.fDefineSet(t.alphaTest,"LIT_ALPHA_TEST"),this.fDefineSet(t.useMsdf,"LIT_MSDF"),this.fDefineSet(t.ssao,"LIT_SSAO"),this.fDefineSet(t.useAo,"LIT_AO"),this.fDefineSet(t.occludeDirect,"LIT_OCCLUDE_DIRECT"),this.fDefineSet(t.msdfTextAttribute,"LIT_MSDF_TEXT_ATTRIBUTE"),this.fDefineSet(t.diffuseMapEnabled,"LIT_DIFFUSE_MAP"),this.fDefineSet(t.shadowCatcher,"LIT_SHADOW_CATCHER"),this.fDefineSet(!0,"LIT_FRESNEL_MODEL",oy[t.fresnelModel]),this.fDefineSet(!0,"LIT_NONE_SLICE_MODE",Ty[t.nineSlicedMode]),this.fDefineSet(!0,"LIT_BLEND_TYPE",xm[t.blendType]),this.fDefineSet(!0,"LIT_CUBEMAP_PROJECTION",my[t.cubeMapProjection]),this.fDefineSet(!0,"LIT_OCCLUDE_SPECULAR",_y[t.occludeSpecular]),this.fDefineSet(!0,"LIT_REFLECTION_SOURCE",gy[t.reflectionSource]),this.fDefineSet(!0,"LIT_AMBIENT_SOURCE",Sy[t.ambientSource]),this.fDefineSet(!0,"{lightingUv}",e??""),this.fDefineSet(!0,"{reflectionDecode}",li.decodeFunc(t.reflectionEncoding)),this.fDefineSet(!0,"{reflectionCubemapDecode}",li.decodeFunc(t.reflectionCubemapEncoding)),this.fDefineSet(!0,"{ambientDecode}",li.decodeFunc(t.ambientEncoding)),this._setupLightingDefines(i,t.clusteredLightingEnabled)}prepareShadowPass(){let{options:e}=this,t=this.shaderPassInfo.lightType,s=this.shaderPassInfo.shadowType,i=gi.get(s),r=t===ge||!i.vsm&&t===Ye;this.fDefineSet(r,"PERSPECTIVE_DEPTH"),this.fDefineSet(!0,"LIGHT_TYPE",`${RS[t]}`),this.fDefineSet(!0,"SHADOW_TYPE",`${i.name}`),this.fDefineSet(e.alphaTest,"LIT_ALPHA_TEST")}generateFragmentShader(e,t,s){let i=this.options;this.includes.set("frontendDeclPS",e??""),this.includes.set("frontendCodePS",t??""),i.pass===Sa||i.pass===ga||(this.shadowPass?this.prepareShadowPass():this.prepareForwardPass(s)),this.fshader=`
						#include "litMainPS"
				`}}});var iT,ub=m(()=>{J();iT={generateKey(o){return`lit${Object.keys(o).sort().map(e=>e==="shaderChunks"?o.shaderChunks?.key??"":e==="lights"?iT.generateLightsKey(o):e+o[e]).join(`
`)}`},generateLightsKey(o){return`lights:${o.lights.map(e=>!o.clusteredLightingEnabled||e._type===ge?`${e.key},`:"").join("")}`}}});var Rne,mb,bV,MV=m(()=>{db();ub();Nm();j();Sh();Ya();GS();Rne=[0,1,2,3,4,5,6,7],mb=class extends vi{generateKey(e){let t=vi.definesHash(e.defines),s=Is(e.shaderChunkGLSL??""),i=Is(e.shaderChunkWGSL??""),r=iT.generateKey(e.litOptions),a=`${Rne.map((n,l)=>e.usedUvs[l]?"1":"0").join("")}`;return`lit_${t}_${a}_${s}_${i}_${r}`}createShaderDefinition(e,t){let s=!!t.shaderChunkWGSL,i=new np(e,t.litOptions,s),r={name:"LitShader",shaderLanguage:i.shaderLanguage,tag:i.shaderPassInfo.isForward?wu:void 0},a=t.usedUvs||[!0],n=[];i.generateVertexShader(a,a,n),i.generateFragmentShader("",i.shaderLanguage===le?t.shaderChunkWGSL:t.shaderChunkGLSL,"vUv0");let l=sn.merge(i.chunks,i.includes),h=i.vDefines;t.defines.forEach((f,d)=>h.set(d,f));let c=i.fDefines;return t.defines.forEach((f,d)=>c.set(d,f)),r.attributes=i.attributes,r.vertexCode=i.vshader,r.vertexIncludes=l,r.vertexDefines=h,r.fragmentCode=i.fshader,r.fragmentIncludes=l,r.fragmentDefines=c,ri.createDefinition(e,r)}},bV=new mb});var op,VA,DV=m(()=>{Om();J();rl();LV();cb();Uh();MV();Dt();op=new BA,VA=class extends Os{getShaderVariant(e){op.usedUvs=this.usedUvs.slice(),op.shaderChunkGLSL=this.shaderChunkGLSL,op.shaderChunkWGSL=this.shaderChunkWGSL,op.defines=Te.getCoreDefines(this,e),sc.update(op.litOptions,this,e.scene,e.cameraShaderParams,e.objDefs,e.pass,e.sortedLights);let t=new Ta(e.viewUniformFormat,e.viewBindGroupFormat,e.vertexFormat),s=rr(e.device);return s.register("lit",bV),s.getProgram("lit",op,t,this.userId)}constructor(...e){super(...e),this.usedUvs=[!0],this.shaderChunkGLSL=null,this.shaderChunkWGSL=null,this.useLighting=!0,this.useFog=!0,this.useTonemap=!0,this.useSkybox=!0,this.ambientSH=null,this.pixelSnap=!1,this.nineSlicedMode=null,this.twoSidedLighting=!1,this.occludeDirect=!1,this.occludeSpecular=en,this.occludeSpecularIntensity=1,this.opacityFadesSpecular=!0,this.opacityDither=Ei,this.opacityShadowDither=Ei,this.shadowCatcher=!1,this.ggxSpecular=!1,this.fresnelModel=Qo,this.dynamicRefraction=!1,this.hasAo=!1,this.hasSpecular=!1,this.hasSpecularityFactor=!1,this.hasLighting=!1,this.hasHeights=!1,this.hasNormals=!1,this.hasSheen=!1,this.hasRefraction=!1,this.hasIrridescence=!1,this.hasMetalness=!1,this.hasClearCoat=!1,this.hasClearCoatNormals=!1}}});var lr,lp=m(()=>{sT();lr=class{get pass(){return this.litOptions.pass}constructor(){this.defines=new Map,this.forceUv1=!1,this.specularTint=!1,this.metalnessTint=!1,this.glossTint=!1,this.emissiveEncoding="linear",this.lightMapEncoding="linear",this.packedNormal=!1,this.normalDetailPackedNormal=!1,this.clearCoatPackedNormal=!1,this.glossInvert=!1,this.sheenGlossInvert=!1,this.clearCoatGlossInvert=!1,this.useAO=!1,this.litOptions=new on}}});var ic,pb,_b,kA,gb=m(()=>{J();el();db();ed();lp();ub();Nm();Sh();j();GS();ic=[],pb=o=>Object.keys(o).filter(e=>e!=="litOptions").sort(),_b=class extends vi{generateKey(e){let t;return e===this.optionsContextMin?(this.propsMin||(this.propsMin=pb(e)),t=this.propsMin):e===this.optionsContext?(this.props||(this.props=pb(e)),t=this.props):t=pb(e),`standard:
${vi.definesHash(e.defines)}
${t.map(r=>r+e[r]).join(`
`)}${iT.generateKey(e.litOptions)}`}_getUvSourceExpression(e,t,s){let i=s[e],r=s[t],a=s.litOptions.pass===Ti,n;return a&&s.litOptions.nineSlicedMode===Et||a&&s.litOptions.nineSlicedMode===vt?n="nineSlicedUv":(i===0?n=`vUv${r}`:n=`vUV${r}_${i}`,s.heightMap&&e!=="heightMapTransform"&&(n+=" + dUvOffset")),n}_validateMapChunk(e,t,s){}_addMapDefines(e,t,s,i,r,a,n=null){let l=`${t}Map`,h=t.toUpperCase(),c=`${l}Uv`,f=`${l}Identifier`,d=`${l}Transform`,u=`${l}Channel`,p=`${t}VertexColorChannel`,_=`${t}Tint`,S=`${t}VertexColor`,T=`${t}Mode`,x=`${t}Invert`,A=i[_],E=i[S],v=i[l],R=i[f],P=i[T],y=r.get(s);if(v){e.set(`STD_${h}_TEXTURE`,"");let C=this._getUvSourceExpression(d,c,i);e.set(`{STD_${h}_TEXTURE_UV}`,C),e.set(`{STD_${h}_TEXTURE_CHANNEL}`,i[u]);let L=`{STD_${h}_TEXTURE_NAME}`;if(y.includes(L)){let O=`texture_${l}`,M=a[R];M?O=M:(a[R]=O,e.set(`STD_${h}_TEXTURE_ALLOCATE`,"")),e.set(L,O)}if(n){let O=i[u]==="aaa"?"passThrough":li.decodeFunc(n);e.set(`{STD_${h}_TEXTURE_DECODE}`,O)}}E&&(e.set(`STD_${h}_VERTEX`,""),e.set(`{STD_${h}_VERTEX_CHANNEL}`,i[p])),P&&e.set(`{STD_${h}_DETAILMODE}`,P),A&&e.set(`STD_${h}_CONSTANT`,""),i[x]&&e.set(`STD_${h}_INVERT`,"")}_correctChannel(e,t,s){if(s[e]>0){if(s[e]<t.length)return t.substring(0,s[e]);if(s[e]>t.length){let i=t,r=i.charAt(i.length-1),a=s[e]-i.length;for(let n=0;n<a;n++)i+=r;return i}return t}}createVertexShader(e,t){let s=[],i=[],r=[];for(let n in ic){let l=`${n}Map`;if(t[`${n}VertexColor`]){let h=`${n}VertexColorChannel`;t[h]=this._correctChannel(n,t[h],ic)}if(t[l]){let h=`${l}Channel`,c=`${l}Transform`,f=`${l}Uv`;t[f]=Math.min(t[f],1),t[h]=this._correctChannel(n,t[h],ic);let d=t[f];s[d]=!0,i[d]=i[d]||t[l]&&!t[c],t[c]&&r.push({name:n,id:t[c],uv:t[f]})}}t.forceUv1&&(s[1]=!0,i[1]=i[1]!==void 0?i[1]:!0),e.generateVertexShader(s,i,r)}prepareFragmentDefines(e,t,s){let i=(r,a,n="")=>{r&&t.set(a,n)};i(e.lightMap,"STD_LIGHTMAP",""),i(e.lightVertexColor,"STD_LIGHT_VERTEX_COLOR",""),i(e.dirLightMap&&e.litOptions.useSpecular,"STD_LIGHTMAP_DIR",""),i(e.heightMap,"STD_HEIGHT_MAP",""),i(e.useSpecularColor,"STD_SPECULAR_COLOR",""),i(e.aoMap||e.aoVertexColor||e.useAO,"STD_AO",""),i(!0,"STD_OPACITY_DITHER",Ry[s.isForward?e.litOptions.opacityDither:e.litOptions.opacityShadowDither])}createShaderDefinition(e,t){let s=Ds.get(e).getByIndex(t.litOptions.pass),i=s.isForward,r=new np(e,t.litOptions);this.createVertexShader(r,t);let a={};t.litOptions.fresnelModel=t.litOptions.fresnelModel===0?Qo:t.litOptions.fresnelModel;let n=r.fDefines;this.prepareFragmentDefines(t,n,s);let l="";if(i){if(t.heightMap&&this._addMapDefines(n,"height","parallaxPS",t,r.chunks,a),(t.litOptions.blendType!==$t||t.litOptions.alphaTest||t.litOptions.alphaToCoverage||t.litOptions.opacityDither!==Ei)&&this._addMapDefines(n,"opacity","opacityPS",t,r.chunks,a),r.needsNormal){if((t.normalMap||t.clearCoatNormalMap)&&!t.litOptions.hasTangents){let d=t.normalMap?"normalMap":"clearCoatNormalMap";l=this._getUvSourceExpression(`${d}Transform`,`${d}Uv`,t)}this._addMapDefines(n,"normalDetail","normalMapPS",t,r.chunks,a,t.normalDetailPackedNormal?"xy":"xyz"),this._addMapDefines(n,"normal","normalMapPS",t,r.chunks,a,t.packedNormal?"xy":"xyz")}t.diffuseDetail&&this._addMapDefines(n,"diffuseDetail","diffusePS",t,r.chunks,a,t.diffuseDetailEncoding),this._addMapDefines(n,"diffuse","diffusePS",t,r.chunks,a,t.diffuseEncoding),t.litOptions.useRefraction&&(this._addMapDefines(n,"refraction","transmissionPS",t,r.chunks,a),this._addMapDefines(n,"thickness","thicknessPS",t,r.chunks,a)),t.litOptions.useIridescence&&(this._addMapDefines(n,"iridescence","iridescencePS",t,r.chunks,a),this._addMapDefines(n,"iridescenceThickness","iridescenceThicknessPS",t,r.chunks,a)),(r.lighting&&t.litOptions.useSpecular||r.reflections)&&(t.litOptions.useSheen&&(this._addMapDefines(n,"sheen","sheenPS",t,r.chunks,a,t.sheenEncoding),this._addMapDefines(n,"sheenGloss","sheenGlossPS",t,r.chunks,a)),t.litOptions.useMetalness&&(this._addMapDefines(n,"metalness","metalnessPS",t,r.chunks,a),this._addMapDefines(n,"ior","iorPS",t,r.chunks,a)),t.litOptions.useSpecularityFactor&&this._addMapDefines(n,"specularityFactor","specularityFactorPS",t,r.chunks,a),t.useSpecularColor&&this._addMapDefines(n,"specular","specularPS",t,r.chunks,a,t.specularEncoding),this._addMapDefines(n,"gloss","glossPS",t,r.chunks,a)),t.aoDetail&&this._addMapDefines(n,"aoDetail","aoPS",t,r.chunks,a),(t.aoMap||t.aoVertexColor||t.useAO)&&this._addMapDefines(n,"ao","aoPS",t,r.chunks,a),this._addMapDefines(n,"emissive","emissivePS",t,r.chunks,a,t.emissiveEncoding),t.litOptions.useClearCoat&&(this._addMapDefines(n,"clearCoat","clearCoatPS",t,r.chunks,a),this._addMapDefines(n,"clearCoatGloss","clearCoatGlossPS",t,r.chunks,a),this._addMapDefines(n,"clearCoatNormal","clearCoatNormalPS",t,r.chunks,a,t.clearCoatPackedNormal?"xy":"xyz")),t.litOptions.enableGGXSpecular&&this._addMapDefines(n,"anisotropy","anisotropyPS",t,r.chunks,a),(t.lightMap||t.lightVertexColor)&&this._addMapDefines(n,"light","lightmapPS",t,r.chunks,a,t.lightMapEncoding)}else{let d=t.litOptions.opacityShadowDither;(t.litOptions.alphaTest||d)&&this._addMapDefines(n,"opacity","opacityPS",t,r.chunks,a)}r.generateFragmentShader(r.chunks.get("stdDeclarationPS"),r.chunks.get("stdFrontEndPS"),l);let h=sn.merge(r.chunks,r.includes),c=r.vDefines;t.defines.forEach((d,u)=>c.set(u,d)),t.defines.forEach((d,u)=>n.set(u,d));let f=ri.createDefinition(e,{name:"StandardShader",attributes:r.attributes,shaderLanguage:r.shaderLanguage,vertexCode:r.vshader,fragmentCode:r.fshader,vertexIncludes:h,fragmentIncludes:h,fragmentDefines:n,vertexDefines:c});return r.shaderPassInfo.isForward&&(f.tag=wu),f}constructor(...e){super(...e),this.optionsContext=new lr,this.optionsContextMin=new lr}},kA=new _b});var OV,Cne,Ine,GA,NV=m(()=>{j();J();gb();cb();OV=(o,e)=>{if(o.length!==e.length)return!1;for(let t=0;t<o.length;++t)if(o[t]!==e[t])return!1;return!0},Cne=o=>o.r!==1||o.g!==1||o.b!==1,Ine=o=>o.r!==0||o.g!==0||o.b!==0,GA=class{constructor(){this._mapXForms=null}updateMinRef(e,t,s,i,r,a){this._updateSharedOptions(e,t,s,i,r),this._updateMinOptions(e,s,r),this._updateUVOptions(e,s,i,!0)}updateRef(e,t,s,i,r,a,n){this._updateSharedOptions(e,t,i,r,a),this._updateEnvOptions(e,i,t,s),this._updateMaterialOptions(e,i,t),e.litOptions.hasTangents=r&&(r&Mh)!==0,this._updateLightOptions(e,t,i,r,n),this._updateUVOptions(e,i,r,!1,s)}_updateSharedOptions(e,t,s,i,r){e.forceUv1=s.forceUv1,s.userAttributes&&(e.litOptions.userAttributes=Object.fromEntries(s.userAttributes.entries())),e.litOptions.shaderChunks=s.shaderChunks,e.litOptions.pass=r,e.litOptions.alphaTest=s.alphaTest>0,e.litOptions.blendType=s.blendType,e.litOptions.screenSpace=i&&(i&bh)!==0,e.litOptions.skin=i&&(i&ao)!==0,e.litOptions.batch=i&&(i&Vf)!==0,e.litOptions.useInstancing=i&&(i&no)!==0,e.litOptions.useMorphPosition=i&&(i&oo)!==0,e.litOptions.useMorphNormal=i&&(i&lo)!==0,e.litOptions.useMorphTextureBasedInt=i&&(i&ho)!==0,e.litOptions.nineSlicedMode=s.nineSlicedMode||0,t.clusteredLightingEnabled&&s.useLighting?(e.litOptions.clusteredLightingEnabled=!0,e.litOptions.clusteredLightingCookiesEnabled=t.lighting.cookiesEnabled,e.litOptions.clusteredLightingShadowsEnabled=t.lighting.shadowsEnabled,e.litOptions.clusteredLightingShadowType=t.lighting.shadowType,e.litOptions.clusteredLightingAreaLightsEnabled=t.lighting.areaLightsEnabled):(e.litOptions.clusteredLightingEnabled=!1,e.litOptions.clusteredLightingCookiesEnabled=!1,e.litOptions.clusteredLightingShadowsEnabled=!1,e.litOptions.clusteredLightingAreaLightsEnabled=!1)}_updateUVOptions(e,t,s,i,r){let a=!1,n=!1,l=!1;s&&(a=(s&Lh)!==0,n=(s&Cm)!==0,l=(s&Im)!==0),e.litOptions.vertexColors=!1,this._mapXForms=[];let h={};for(let c in ic)this._updateTexOptions(e,t,c,a,n,l,i,h);this._mapXForms=null,e.litOptions.ssao=r?.ssaoEnabled,e.useAO=e.litOptions.ssao,e.litOptions.lightMapEnabled=e.lightMap,e.litOptions.dirLightMapEnabled=e.dirLightMap,e.litOptions.useHeights=e.heightMap,e.litOptions.useNormals=e.normalMap,e.litOptions.useClearCoatNormals=e.clearCoatNormalMap,e.litOptions.useAo=e.aoMap||e.aoVertexColor||e.litOptions.ssao,e.litOptions.diffuseMapEnabled=e.diffuseMap}_updateTexOptions(e,t,s,i,r,a,n,l){let h=s==="opacity";if(!n||h){let c=`${s}Map`,f=`${s}VertexColor`,d=`${s}VertexColorChannel`,u=`${c}Channel`,p=`${c}Transform`,_=`${c}Uv`,S=`${c}Identifier`;if(s!=="light"&&(e[c]=!1,e[S]=void 0,e[u]="",e[p]=0,e[_]=0),e[f]=!1,e[d]="",h&&t.blendType===$t&&t.alphaTest===0&&!t.alphaToCoverage&&t.opacityDither===Ei)return;if(s!=="height"&&t[f]&&a&&(e[f]=t[f],e[d]=t[d],e.litOptions.vertexColors=!0),t[c]){let T=!0;if(t[_]===0&&!i&&(T=!1),t[_]===1&&!r&&(T=!1),T){let x=t[c].id,A=l[x];A===void 0&&(l[x]=s,A=s),e[c]=!!t[c],e[S]=A,e[p]=this._getMapTransformID(t.getUniform(p),t[_]),e[u]=t[u],e[_]=t[_]}}}}_updateMinOptions(e,t,s){let i=s===ga;e.litOptions.opacityShadowDither=i?t.opacityDither:t.opacityShadowDither,e.litOptions.linearDepth=i,e.litOptions.lights=[]}_updateMaterialOptions(e,t,s){let i=!!(t.useMetalness||t.specularMap||t.sphereMap||t.cubeMap||Ine(t.specular)||t.specularityFactor>0&&t.useMetalness||t.enableGGXSpecular||t.clearCoat>0),r=!t.useMetalness||t.useMetalnessSpecularColor,a=i&&(t.specularTint||!t.specularMap&&!t.specularVertexColor)&&Cne(t.specular),n=i&&t.useMetalnessSpecularColor&&(t.specularityFactorTint||t.specularityFactor<1&&!t.specularityFactorMap),l=c=>c?c.format===10||c.type===Nn:!1,h=(c,f)=>Math.abs(c-f)<1e-4;e.specularTint=a,e.specularityFactorTint=n,e.metalnessTint=t.useMetalness&&t.metalness<1,e.glossTint=!0,e.diffuseEncoding=t.diffuseMap?.encoding,e.diffuseDetailEncoding=t.diffuseDetailMap?.encoding,e.emissiveEncoding=t.emissiveMap?.encoding,e.lightMapEncoding=t.lightMap?.encoding,e.packedNormal=l(t.normalMap),e.refractionTint=h(t.refraction,1),e.refractionIndexTint=h(t.refractionIndex,1/1.5),e.thicknessTint=t.useDynamicRefraction&&t.thickness!==1,e.specularEncoding=t.specularMap?.encoding,e.sheenEncoding=t.sheenMap?.encoding,e.aoMapUv=t.aoUvSet,e.aoDetail=!!t.aoDetailMap,e.diffuseDetail=!!t.diffuseDetailMap,e.normalDetail=!!t.normalMap,e.normalDetailPackedNormal=l(t.normalDetailMap),e.diffuseDetailMode=t.diffuseDetailMode,e.aoDetailMode=t.aoDetailMode,e.clearCoatGloss=!!t.clearCoatGloss,e.clearCoatPackedNormal=l(t.clearCoatNormalMap),e.iorTint=h(t.refractionIndex,1/1.5),s.forcePassThroughSpecular&&(e.specularEncoding="linear",e.sheenEncoding="linear"),e.iridescenceTint=t.iridescence!==1,e.glossInvert=t.glossInvert,e.sheenGlossInvert=t.sheenGlossInvert,e.clearCoatGlossInvert=t.clearCoatGlossInvert,e.useSpecularColor=r,e.litOptions.separateAmbient=!1,e.litOptions.pixelSnap=t.pixelSnap,e.litOptions.ambientSH=!!t.ambientSH,e.litOptions.twoSidedLighting=t.twoSidedLighting,e.litOptions.occludeSpecular=t.occludeSpecular,e.litOptions.occludeSpecularFloat=t.occludeSpecularIntensity!==1,e.litOptions.useMsdf=!!t.msdfMap,e.litOptions.msdfTextAttribute=!!t.msdfTextAttribute,e.litOptions.alphaToCoverage=t.alphaToCoverage,e.litOptions.opacityFadesSpecular=t.opacityFadesSpecular,e.litOptions.opacityDither=t.opacityDither,e.litOptions.cubeMapProjection=t.cubeMapProjection,e.litOptions.occludeDirect=t.occludeDirect,e.litOptions.useSpecular=i,e.litOptions.useSpecularityFactor=(n||!!t.specularityFactorMap)&&t.useMetalnessSpecularColor,e.litOptions.enableGGXSpecular=t.enableGGXSpecular,e.litOptions.fresnelModel=t.fresnelModel,e.litOptions.useRefraction=(t.refraction||!!t.refractionMap)&&(t.useDynamicRefraction||e.litOptions.reflectionSource!==sr),e.litOptions.useClearCoat=!!t.clearCoat,e.litOptions.useSheen=t.useSheen,e.litOptions.useIridescence=t.useIridescence&&t.iridescence!==0,e.litOptions.useMetalness=t.useMetalness,e.litOptions.useDynamicRefraction=t.useDynamicRefraction,e.litOptions.dispersion=t.dispersion>0,e.litOptions.shadowCatcher=t.shadowCatcher}_updateEnvOptions(e,t,s,i){e.litOptions.fog=t.useFog?i.fog:tr,e.litOptions.gamma=i.shaderOutputGamma,e.litOptions.toneMap=t.useTonemap?i.toneMapping:Ah;let r=!1;if(t.envAtlas&&t.cubeMap?(e.litOptions.reflectionSource=Ch,e.litOptions.reflectionEncoding=t.envAtlas.encoding,e.litOptions.reflectionCubemapEncoding=t.cubeMap.encoding):t.envAtlas?(e.litOptions.reflectionSource=Rh,e.litOptions.reflectionEncoding=t.envAtlas.encoding):t.cubeMap?(e.litOptions.reflectionSource=Ih,e.litOptions.reflectionEncoding=t.cubeMap.encoding):t.sphereMap?(e.litOptions.reflectionSource=BS,e.litOptions.reflectionEncoding=t.sphereMap.encoding):t.useSkybox&&s.envAtlas&&s.skybox?(e.litOptions.reflectionSource=Ch,e.litOptions.reflectionEncoding=s.envAtlas.encoding,e.litOptions.reflectionCubemapEncoding=s.skybox.encoding,r=!0):t.useSkybox&&s.envAtlas?(e.litOptions.reflectionSource=Rh,e.litOptions.reflectionEncoding=s.envAtlas.encoding,r=!0):t.useSkybox&&s.skybox?(e.litOptions.reflectionSource=Ih,e.litOptions.reflectionEncoding=s.skybox.encoding,r=!0):(e.litOptions.reflectionSource=sr,e.litOptions.reflectionEncoding=null),t.ambientSH)e.litOptions.ambientSource=Nf,e.litOptions.ambientEncoding=null;else{let a=t.envAtlas||(t.useSkybox&&s.envAtlas?s.envAtlas:null);a&&!t.sphereMap?(e.litOptions.ambientSource=Ff,e.litOptions.ambientEncoding=a.encoding):(e.litOptions.ambientSource=Uf,e.litOptions.ambientEncoding=null)}e.litOptions.skyboxIntensity=r,e.litOptions.useCubeMapRotation=r&&s._skyboxRotationShaderInclude}_updateLightOptions(e,t,s,i,r){if(e.lightMap=!1,e.lightMapChannel="",e.lightMapUv=0,e.lightMapTransform=0,e.litOptions.lightMapWithoutAmbient=!1,e.dirLightMap=!1,i&&(e.litOptions.noShadow=(i&wh)!==0,(i&Bf)!==0&&(e.lightMapEncoding=t.lightmapPixelFormat===7?"rgbm":"linear",e.lightMap=!0,e.lightMapChannel="rgb",e.lightMapUv=1,e.lightMapTransform=0,e.litOptions.lightMapWithoutAmbient=!s.lightMap,(i&wm)!==0&&(e.dirLightMap=!0),(i&Lm)!==0&&(e.litOptions.lightMapWithoutAmbient=!1))),s.useLighting){let a=[],n=i?i>>16:ps;e.litOptions.lightMaskDynamic=!!(n&ps),r&&(sc.collectLights(ge,r[ge],a,n),t.clusteredLightingEnabled||(sc.collectLights(Ge,r[Ge],a,n),sc.collectLights(Ye,r[Ye],a,n))),e.litOptions.lights=a}else e.litOptions.lights=[];e.litOptions.lights.length===0&&!t.clusteredLightingEnabled&&(e.litOptions.noShadow=!0)}_getMapTransformID(e,t){if(!e)return 0;let s=this._mapXForms[t];s||(s=[],this._mapXForms[t]=s);for(let i=0;i<s.length;i++)if(OV(s[i][0].value,e[0].value)&&OV(s[i][1].value,e[1].value))return i+1;return s.push(e)}}});function Yt(o,e=!0,t=!0){let s={};return s[`${o}Map`]="texture",s[`${o}MapTiling`]="vec2",s[`${o}MapOffset`]="vec2",s[`${o}MapRotation`]="number",s[`${o}MapUv`]="number",e&&(s[`${o}MapChannel`]="string",t&&(s[`${o}VertexColor`]="boolean",s[`${o}VertexColorChannel`]="string")),s}var rc,id,rT,FV,hp=m(()=>{rc={name:"string",chunks:"chunks",mappingFormat:"string",_engine:"boolean",ambient:"rgb",...Yt("ao"),...Yt("aoDetail",!0,!1),aoDetailMode:"string",aoIntensity:"number",diffuse:"rgb",...Yt("diffuse"),...Yt("diffuseDetail",!0,!1),diffuseDetailMode:"string",specular:"rgb",specularTint:"boolean",...Yt("specular"),occludeSpecular:"enum:occludeSpecular",specularityFactor:"number",specularityFactorTint:"boolean",...Yt("specularityFactor"),useMetalness:"boolean",metalness:"number",enableGGXSpecular:"boolean",metalnessTint:"boolean",...Yt("metalness"),useMetalnessSpecularColor:"boolean",anisotropyIntensity:"number",anisotropyRotation:"number",...Yt("anisotropy"),shininess:"number",gloss:"number",glossInvert:"boolean",...Yt("gloss"),clearCoat:"number",...Yt("clearCoat"),clearCoatGloss:"number",clearCoatGlossInvert:"boolean",...Yt("clearCoatGloss"),clearCoatBumpiness:"number",...Yt("clearCoatNormal",!1),useSheen:"boolean",sheen:"rgb",...Yt("sheen"),sheenGloss:"number",sheenGlossInvert:"boolean",...Yt("sheenGloss"),fresnelModel:"number",emissive:"rgb",...Yt("emissive"),emissiveIntensity:"number",...Yt("normal",!1),bumpiness:"number",...Yt("normalDetail",!1),normalDetailMapBumpiness:"number",...Yt("height",!0,!1),heightMapFactor:"number",alphaToCoverage:"boolean",alphaTest:"number",alphaFade:"number",opacity:"number",...Yt("opacity"),opacityFadesSpecular:"boolean",opacityDither:"string",opacityShadowDither:"string",reflectivity:"number",refraction:"number",refractionTint:"boolean",...Yt("refraction"),refractionIndex:"number",dispersion:"number",thickness:"number",thicknessTint:"boolean",...Yt("thickness"),attenuation:"rgb",attenuationDistance:"number",useDynamicRefraction:"boolean",sphereMap:"texture",cubeMap:"cubemap",cubeMapProjection:"number",cubeMapProjectionBox:"boundingbox",useIridescence:"boolean",iridescence:"number",iridescenceTint:"boolean",...Yt("iridescence"),iridescenceThicknessTint:"boolean",iridescenceThicknessMin:"number",iridescenceThicknessMax:"number",iridescenceRefractionIndex:"number",...Yt("iridescenceThickness"),...Yt("light"),depthTest:"boolean",depthFunc:"enum:depthFunc",depthWrite:"boolean",depthBias:"number",slopeDepthBias:"number",cull:"enum:cull",blendType:"enum:blendType",useFog:"boolean",useLighting:"boolean",useSkybox:"boolean",useTonemap:"boolean",envAtlas:"texture",twoSidedLighting:"boolean",shadowCatcher:"boolean"},id=[];for(let o in rc)rc[o]==="texture"&&id.push(o);rT=[];for(let o in rc)rc[o]==="cubemap"&&rT.push(o);FV={aoMapVertexColor:"boolean",diffuseMapTint:"boolean",diffuseMapVertexColor:"boolean",emissiveMapTint:"boolean",emissiveMapVertexColor:"boolean",glossMapVertexColor:"boolean",metalnessMapVertexColor:"boolean",opacityMapVertexColor:"boolean",specularAntialias:"boolean",specularMapTint:"boolean",specularMapVertexColor:"boolean",ambientTint:"boolean",emissiveTint:"boolean",diffuseTint:"boolean",sheenTint:"boolean",conserveEnergy:"boolean",useGamma:"boolean",useGammaTonemap:"boolean",sheenGlossTint:"boolean",anisotropy:"boolean"}});function Ft(o,e="rgb",t=!0,s=0){ic[o]=e.length||-1,Ca({name:`${o}Map`,defaultValue:null,dirtyShaderFunc:(l,h)=>!!l!=!!h||l&&(l.type!==h.type||l.format!==h.format)}),Ca({name:`${o}MapTiling`,defaultValue:new D(1,1)}),Ca({name:`${o}MapOffset`,defaultValue:new D(0,0)}),Ca({name:`${o}MapRotation`,defaultValue:0}),Ca({name:`${o}MapUv`,defaultValue:s}),e&&(Ca({name:`${o}MapChannel`,defaultValue:e}),t&&(Ca({name:`${o}VertexColor`,defaultValue:!1}),Ca({name:`${o}VertexColorChannel`,defaultValue:e})));let i=`${o}MapTiling`,r=`${o}MapOffset`,a=`${o}MapRotation`,n=`${o}MapTransform`;XA(n,(l,h,c)=>{let f=l[i],d=l[r],u=l[a];if(f.x===1&&f.y===1&&d.x===0&&d.y===0&&u===0)return null;let p=l._allocUniform(n,()=>[{name:`texture_${n}0`,value:new Float32Array(3)},{name:`texture_${n}1`,value:new Float32Array(3)}]),_=Math.cos(u*w.DEG_TO_RAD),S=Math.sin(u*w.DEG_TO_RAD),T=p[0].value;T[0]=_*f.x,T[1]=-S*f.y,T[2]=d.x;let x=p[1].value;return x[0]=S*f.x,x[1]=_*f.y,x[2]=1-f.y-d.y,p})}function cp(o,e){Ca({name:o,defaultValue:e,getterFunc:function(){return this._dirtyShader=!0,this[`_${o}`]}}),XA(o,(t,s,i)=>{let r=t._allocUniform(o,()=>new Float32Array(3)),a=t[o];return zA.linear(a),r[0]=zA.r,r[1]=zA.g,r[2]=zA.b,r})}function pt(o,e,t){Ca({name:o,defaultValue:e,dirtyShaderFunc:(s,i)=>(s===0||s===1)!=(i===0||i===1)}),XA(o,t)}function nT(o,e){Ca({name:o,defaultValue:null,dirtyShaderFunc:(t,s)=>!!t==!!s}),XA(o,e)}function ht(o,e){Ca({name:o,defaultValue:e})}function bne(){cp("ambient",new N(1,1,1)),cp("diffuse",new N(1,1,1)),cp("specular",new N(0,0,0)),cp("emissive",new N(0,0,0)),cp("sheen",new N(1,1,1)),cp("attenuation",new N(1,1,1)),pt("emissiveIntensity",1),pt("specularityFactor",1),pt("sheenGloss",0),pt("gloss",.25),pt("aoIntensity",1),pt("heightMapFactor",1,(s,i,r)=>s.heightMapFactor*.025),pt("opacity",1),pt("alphaFade",1),pt("alphaTest",0),pt("bumpiness",1),pt("normalDetailMapBumpiness",1),pt("reflectivity",1),pt("occludeSpecularIntensity",1),pt("refraction",0),pt("refractionIndex",1/1.5),pt("dispersion",0),pt("thickness",0),pt("attenuationDistance",0),pt("metalness",1),pt("anisotropyIntensity",0),pt("anisotropyRotation",0),pt("clearCoat",0),pt("clearCoatGloss",1),pt("clearCoatBumpiness",1),pt("aoUvSet",0,null),pt("iridescence",0),pt("iridescenceRefractionIndex",1/1.5),pt("iridescenceThicknessMin",0),pt("iridescenceThicknessMax",0),nT("ambientSH"),nT("cubeMapProjectionBox",(s,i,r)=>{let a=s._allocUniform("cubeMapProjectionBox",()=>[{name:"envBoxMin",value:new Float32Array(3)},{name:"envBoxMax",value:new Float32Array(3)}]),n=s.cubeMapProjectionBox.getMin(),l=a[0].value;l[0]=n.x,l[1]=n.y,l[2]=n.z;let h=s.cubeMapProjectionBox.getMax(),c=a[1].value;return c[0]=h.x,c[1]=h.y,c[2]=h.z,a}),ht("specularTint",!1),ht("specularityFactorTint",!1),ht("useMetalness",!1),ht("useMetalnessSpecularColor",!1),ht("useSheen",!1),ht("enableGGXSpecular",!1),ht("occludeDirect",!1),ht("opacityFadesSpecular",!0),ht("occludeSpecular",en),ht("fresnelModel",Qo),ht("useDynamicRefraction",!1),ht("cubeMapProjection",Of),ht("useFog",!0),ht("useLighting",!0),ht("useTonemap",!0),ht("useSkybox",!0),ht("forceUv1",!1),ht("pixelSnap",!1),ht("twoSidedLighting",!1),ht("nineSlicedMode",void 0),ht("msdfTextAttribute",!1),ht("useIridescence",!1),ht("glossInvert",!1),ht("sheenGlossInvert",!1),ht("clearCoatGlossInvert",!1),ht("opacityDither",Ei),ht("opacityShadowDither",Ei),ht("shadowCatcher",!1),Ft("diffuse"),Ft("specular"),Ft("emissive"),Ft("thickness","g"),Ft("specularityFactor","g"),Ft("normal",""),Ft("metalness","g"),Ft("gloss","g"),Ft("opacity","a"),Ft("refraction","g"),Ft("height","g",!1),Ft("ao","g"),Ft("light","rgb",!0,1),Ft("msdf",""),Ft("diffuseDetail","rgb",!1),Ft("normalDetail",""),Ft("aoDetail","g",!1),Ft("clearCoat","g"),Ft("clearCoatGloss","g"),Ft("clearCoatNormal",""),Ft("sheen","rgb"),Ft("sheenGloss","g"),Ft("iridescence","g"),Ft("iridescenceThickness","g"),Ft("anisotropy",""),ht("diffuseDetailMode",NS),ht("aoDetailMode",NS),nT("cubeMap"),nT("sphereMap"),nT("envAtlas");let o=function(){return this._prefilteredCubemaps},e=function(s){let i=this._prefilteredCubemaps;s=s||[];let r=!1,a=!0;for(let n=0;n<6;++n){let l=s[n]||null;i[n]!==l&&(i[n]=l,r=!0),a=a&&!!i[n]}r&&(a?this.envAtlas=Jh.generatePrefilteredAtlas(i,{target:this.envAtlas}):this.envAtlas&&(this.envAtlas.destroy(),this.envAtlas=null),this._dirtyShader=!0)},t=[null,null,null,null,null,null];Sb("prefilteredCubemaps",()=>t.slice(),e,o)}var HA,UV,aT,zA,ct,XA,Sb,wne,Lne,Ca,ln=m(()=>{De();me();Ne();Om();J();el();DA();Uh();gb();rl();NV();hp();Dt();HA={},UV={},aT=new Set,zA=new N,ct=class extends Os{static{this.TEXTURE_PARAMETERS=id}static{this.CUBEMAP_PARAMETERS=rT}constructor(){super(),this.userAttributes=new Map,this._assetReferences={},this._activeParams=new Set,this._activeLightingParams=new Set,this.shaderOptBuilder=new GA,this.reset()}reset(){Object.keys(HA).forEach(e=>{this[`_${e}`]=HA[e].value()}),this._uniformCache={}}copy(e){return super.copy(e),Object.keys(HA).forEach(t=>{this[t]=e[t]}),this.userAttributes=new Map(e.userAttributes),this}setAttribute(e,t){this.userAttributes.set(t,e)}_setParameter(e,t){aT.add(e),this.setParameter(e,t)}_setParameters(e){e.forEach(t=>{this._setParameter(t.name,t.value)})}_processParameters(e){let t=this[e];t.forEach(s=>{aT.has(s)||delete this.parameters[s]}),this[e]=aT,aT=t,aT.clear()}_updateMap(e){let t=`${e}Map`,s=this[t];if(s){this._setParameter(`texture_${t}`,s);let i=`${t}Transform`,r=this.getUniform(i);r&&this._setParameters(r)}}_allocUniform(e,t){let s=this._uniformCache[e];return s||(s=t(),this._uniformCache[e]=s),s}getUniform(e,t,s){return UV[e](this,t,s)}updateUniforms(e,t){let s=i=>this.getUniform(i,e,t);this._setParameter("material_ambient",s("ambient")),this._setParameter("material_diffuse",s("diffuse")),this._setParameter("material_aoIntensity",this.aoIntensity),this.useMetalness?((!this.metalnessMap||this.metalness<1)&&this._setParameter("material_metalness",this.metalness),(!this.specularMap||this.specularTint)&&this._setParameter("material_specular",s("specular")),(!this.specularityFactorMap||this.specularityFactorTint)&&this._setParameter("material_specularityFactor",this.specularityFactor),this._setParameter("material_sheen",s("sheen")),this._setParameter("material_sheenGloss",this.sheenGloss),this._setParameter("material_refractionIndex",this.refractionIndex)):(!this.specularMap||this.specularTint)&&this._setParameter("material_specular",s("specular")),this.enableGGXSpecular&&(this._setParameter("material_anisotropyIntensity",this.anisotropyIntensity),this._setParameter("material_anisotropyRotation",[Math.cos(this.anisotropyRotation*w.DEG_TO_RAD),Math.sin(this.anisotropyRotation*w.DEG_TO_RAD)])),this.clearCoat>0&&(this._setParameter("material_clearCoat",this.clearCoat),this._setParameter("material_clearCoatGloss",this.clearCoatGloss),this._setParameter("material_clearCoatBumpiness",this.clearCoatBumpiness)),this._setParameter("material_gloss",this.gloss),this._setParameter("material_emissive",s("emissive")),this._setParameter("material_emissiveIntensity",this.emissiveIntensity),this.refraction>0&&this._setParameter("material_refraction",this.refraction),this.dispersion>0&&this._setParameter("material_dispersion",this.dispersion),this.useDynamicRefraction&&(this._setParameter("material_thickness",this.thickness),this._setParameter("material_attenuation",s("attenuation")),this._setParameter("material_invAttenuationDistance",this.attenuationDistance===0?0:1/this.attenuationDistance)),this.useIridescence&&(this._setParameter("material_iridescence",this.iridescence),this._setParameter("material_iridescenceRefractionIndex",this.iridescenceRefractionIndex),this._setParameter("material_iridescenceThicknessMin",this.iridescenceThicknessMin),this._setParameter("material_iridescenceThicknessMax",this.iridescenceThicknessMax)),this._setParameter("material_opacity",this.opacity),this.opacityFadesSpecular===!1&&this._setParameter("material_alphaFade",this.alphaFade),this.occludeSpecular&&this._setParameter("material_occludeSpecularIntensity",this.occludeSpecularIntensity),this.cubeMapProjection===OS&&this._setParameter(s("cubeMapProjectionBox"));for(let i in ic)this._updateMap(i);this.ambientSH&&this._setParameter("ambientSH[0]",this.ambientSH),this.normalMap&&this._setParameter("material_bumpiness",this.bumpiness),this.normalMap&&this.normalDetailMap&&this._setParameter("material_normalDetailMapBumpiness",this.normalDetailMapBumpiness),this.heightMap&&this._setParameter("material_heightMapFactor",s("heightMapFactor")),this.envAtlas&&this.cubeMap?(this._setParameter("texture_envAtlas",this.envAtlas),this._setParameter("texture_cubeMap",this.cubeMap)):this.envAtlas?this._setParameter("texture_envAtlas",this.envAtlas):this.cubeMap?this._setParameter("texture_cubeMap",this.cubeMap):this.sphereMap&&this._setParameter("texture_sphereMap",this.sphereMap),this._setParameter("material_reflectivity",this.reflectivity),this._processParameters("_activeParams"),super.updateUniforms(e,t)}updateEnvUniforms(e,t){!(this.envAtlas||this.cubeMap||this.sphereMap)&&this.useSkybox&&(t.envAtlas&&t.skybox?(this._setParameter("texture_envAtlas",t.envAtlas),this._setParameter("texture_cubeMap",t.skybox)):t.envAtlas?this._setParameter("texture_envAtlas",t.envAtlas):t.skybox&&this._setParameter("texture_cubeMap",t.skybox)),this._processParameters("_activeLightingParams")}getShaderVariant(e){let{device:t,scene:s,pass:i,objDefs:r,sortedLights:a,cameraShaderParams:n}=e;this.updateEnvUniforms(t,s);let l=Ds.get(t).getByIndex(i),h=i===Sa||i===ga||l.isShadow,c=h?kA.optionsContextMin:kA.optionsContext;c.defines=Te.getCoreDefines(this,e),h?this.shaderOptBuilder.updateMinRef(c,s,this,r,i,a):this.shaderOptBuilder.updateRef(c,s,n,this,r,i,a),this.useFog||c.defines.set("FOG","NONE"),c.defines.set("TONEMAP",Ph[c.litOptions.toneMap]),this.onUpdateShader&&(c=this.onUpdateShader(c));let f=new Ta(e.viewUniformFormat,e.viewBindGroupFormat,e.vertexFormat),d=rr(t);d.register("standard",kA);let u=d.getProgram("standard",c,f,this.userId);return this._dirtyShader=!1,u}destroy(){for(let e in this._assetReferences)this._assetReferences[e]._unbind();this._assetReferences=null,super.destroy()}},XA=(o,e)=>{UV[o]=e},Sb=(o,e,t,s)=>{Object.defineProperty(ct.prototype,o,{get:s||function(){return this[`_${o}`]},set:t}),HA[o]={value:e}},wne=o=>{let e=`_${o.name}`,t=o.dirtyShaderFunc||(()=>!0),s=function(i){let r=this[e];r!==i&&(this._dirtyShader=this._dirtyShader||t(r,i),this[e]=i)};Sb(o.name,()=>o.defaultValue,s,o.getterFunc)},Lne=o=>{let e=`_${o.name}`,t=o.dirtyShaderFunc||(()=>!0),s=function(i){let r=this[e];r.equals(i)||(this._dirtyShader=this._dirtyShader||t(r,i),this[e]=r.copy(i))};Sb(o.name,()=>o.defaultValue.clone(),s,o.getterFunc)},Ca=o=>o.defaultValue&&o.defaultValue.clone?Lne(o):wne(o);bne()});var hn,So,ac,WA=m(()=>{Q();nn();hn=4/64,So=1-hn*2,ac=class extends Qt{constructor(e,t,s,i,r,a){super();let n=new g,l=new g,h=new g,c=new g,f=new g,d=new g,u=[],p=[],_=[],S=[],T=[],x;if(s>0)for(let A=0;A<=i;A++)for(let E=0;E<=r;E++){let v=E/r*2*Math.PI-Math.PI,R=Math.sin(v),P=Math.cos(v);f.set(R*e,-s/2,P*e),c.set(R*t,s/2,P*t),n.lerp(f,c,A/i),l.sub2(c,f).normalize(),d.set(P,0,-R),h.cross(d,l).normalize(),u.push(n.x,n.y,n.z),p.push(h.x,h.y,h.z);let y=E/r,C=A/i;_.push(y,1-C);let L=C;if(C=y,y=L,y=y*So+hn,C=C*So+hn,y/=3,S.push(y,1-C),A<i&&E<r){let O=A*(r+1)+E,M=A*(r+1)+(E+1),U=(A+1)*(r+1)+E,G=(A+1)*(r+1)+(E+1);T.push(O,M,U),T.push(M,G,U)}}if(a){let A=Math.floor(r/2),E=r,v=s/2;for(let R=0;R<=A;R++){let P=R*Math.PI*.5/A,y=Math.sin(P),C=Math.cos(P);for(let L=0;L<=E;L++){let O=L*2*Math.PI/E-Math.PI/2,M=Math.sin(O),G=Math.cos(O)*y,$=C,X=M*y,I=1-L/E,b=1-R/A;u.push(G*t,$*t+v,X*t),p.push(G,$,X),_.push(I,1-b),I=I*So+hn,b=b*So+hn,I/=3,b/=3,I+=1/3,S.push(I,1-b)}}x=(i+1)*(r+1);for(let R=0;R<A;++R)for(let P=0;P<E;++P){let y=R*(E+1)+P,C=y+E+1;T.push(x+y+1,x+C,x+y),T.push(x+y+1,x+C+1,x+C)}for(let R=0;R<=A;R++){let P=Math.PI*.5+R*Math.PI*.5/A,y=Math.sin(P),C=Math.cos(P);for(let L=0;L<=E;L++){let O=L*2*Math.PI/E-Math.PI/2,M=Math.sin(O),G=Math.cos(O)*y,$=C,X=M*y,I=1-L/E,b=1-R/A;u.push(G*t,$*t-v,X*t),p.push(G,$,X),_.push(I,1-b),I=I*So+hn,b=b*So+hn,I/=3,b/=3,I+=2/3,S.push(I,1-b)}}x=(i+1)*(r+1)+(E+1)*(A+1);for(let R=0;R<A;++R)for(let P=0;P<E;++P){let y=R*(E+1)+P,C=y+E+1;T.push(x+y+1,x+C,x+y),T.push(x+y+1,x+C+1,x+C)}}else{if(x=(i+1)*(r+1),e>0)for(let A=0;A<r;A++){let E=A/r*2*Math.PI,v=Math.sin(E),R=-s/2,P=Math.cos(E),y=1-(v+1)/2,C=(P+1)/2;u.push(v*e,R,P*e),p.push(0,-1,0),_.push(y,1-C),y=y*So+hn,C=C*So+hn,y/=3,C/=3,y+=1/3,S.push(y,1-C),A>1&&T.push(x,x+A,x+A-1)}if(x+=r,t>0)for(let A=0;A<r;A++){let E=A/r*2*Math.PI,v=Math.sin(E),R=s/2,P=Math.cos(E),y=1-(v+1)/2,C=(P+1)/2;u.push(v*t,R,P*t),p.push(0,1,0),_.push(y,1-C),y=y*So+hn,C=C*So+hn,y/=3,C/=3,y+=2/3,S.push(y,1-C),A>1&&T.push(x,x+A-1,x+A)}}this.positions=u,this.normals=p,this.uvs=_,this.uvs1=S,this.indices=T}}});var nc,YA=m(()=>{WA();an();nc=class extends ac{constructor(e={}){let t=e.radius??.3,s=e.height??1,i=e.heightSegments??1,r=e.sides??20;super(t,t,s-2*t,i,r,!0),e.calculateTangents&&(this.tangents=Ks(this.positions,this.normals,this.uvs,this.indices))}}});var Ia,fp=m(()=>{WA();an();Ia=class extends ac{constructor(e={}){let t=e.baseRadius??.5,s=e.peakRadius??0,i=e.height??1,r=e.heightSegments??5,a=e.capSegments??18;super(t,s,i,r,a,!1),e.calculateTangents&&(this.tangents=Ks(this.positions,this.normals,this.uvs,this.indices))}}});var hr,rd=m(()=>{WA();an();hr=class extends ac{constructor(e={}){let t=e.radius??.5,s=e.height??1,i=e.heightSegments??5,r=e.capSegments??20;super(t,t,s,i,r,!1),e.calculateTangents&&(this.tangents=Ks(this.positions,this.normals,this.uvs,this.indices))}}});var wa,dp=m(()=>{Ne();an();nn();wa=class extends Qt{constructor(e={}){super();let t=e.halfExtents??new D(.5,.5),s=e.widthSegments??5,i=e.lengthSegments??5,r=[],a=[],n=[],l=[],h=0;for(let c=0;c<=s;c++)for(let f=0;f<=i;f++){let d=-t.x+2*t.x*c/s,u=0,p=-(-t.y+2*t.y*f/i),_=c/s,S=f/i;r.push(d,u,p),a.push(0,1,0),n.push(_,1-S),c<s&&f<i&&(l.push(h+i+1,h+1,h),l.push(h+i+1,h+i+2,h+1)),h++}this.positions=r,this.normals=a,this.uvs=n,this.uvs1=n,this.indices=l,e.calculateTangents&&(this.tangents=Ks(r,a,n,l))}}});var Dr,up=m(()=>{me();an();nn();Dr=class extends Qt{constructor(e={}){super();let t=e.tubeRadius??.2,s=e.ringRadius??.3,i=(e.sectorAngle??360)*w.DEG_TO_RAD,r=e.segments??30,a=e.sides??20,n=[],l=[],h=[],c=[];for(let f=0;f<=a;f++)for(let d=0;d<=r;d++){let u=Math.cos(i*d/r)*(s+t*Math.cos(2*Math.PI*f/a)),p=Math.sin(2*Math.PI*f/a)*t,_=Math.sin(i*d/r)*(s+t*Math.cos(2*Math.PI*f/a)),S=Math.cos(i*d/r)*Math.cos(2*Math.PI*f/a),T=Math.sin(2*Math.PI*f/a),x=Math.sin(i*d/r)*Math.cos(2*Math.PI*f/a),A=f/a,E=1-d/r;if(n.push(u,p,_),l.push(S,T,x),h.push(A,1-E),f<a&&d<r){let v=f*(r+1)+d,R=(f+1)*(r+1)+d,P=f*(r+1)+(d+1),y=(f+1)*(r+1)+(d+1);c.push(v,R,P),c.push(R,y,P)}}this.positions=n,this.normals=l,this.uvs=h,this.uvs1=h,this.indices=c,e.calculateTangents&&(this.tangents=Ks(n,l,h,c))}}});var mp,Tb=m(()=>{Ya();su();Th();J();el();lp();AL();mp=class{constructor(e,t){this.processedCache=new Map,this.definitionsCache=new Map,this._generators=new Map,this._device=e,this._isClearingCache=!1,this._precached=!1,this._programsCollection=[],this._defaultStdMatOption=new lr,this._defaultStdMatOptionMin=new lr;let s=new Bm;t.shaderOptBuilder.updateRef(this._defaultStdMatOption,{},s,t,null,[],Ti,null),t.shaderOptBuilder.updateMinRef(this._defaultStdMatOptionMin,{},t,null,bm,null),e.on("destroy:shader",i=>{this.removeFromCache(i)})}destroy(){this.clearCache()}register(e,t){this._generators.has(e)||this._generators.set(e,t)}unregister(e){this._generators.has(e)&&this._generators.delete(e)}isRegistered(e){return this._generators.has(e)}generateShaderDefinition(e,t,s,i){let r=this.definitionsCache.get(s);if(!r){let a;i.litOptions?.lights&&(a=i.litOptions.lights,i.litOptions.lights=a.map(l=>{let h=l.clone?l.clone():l;return h.key=l.key,h})),this.storeNewProgram(t,i),i.litOptions?.lights&&(i.litOptions.lights=a),this._precached;let n=this._device;r=e.createShaderDefinition(n,i),r.name=r.name??(i.pass?`${t}-pass:${i.pass}`:t),this.definitionsCache.set(s,r)}return r}getCachedShader(e){return this.processedCache.get(e)}setCachedShader(e,t){this.processedCache.set(e,t)}getProgram(e,t,s,i){let r=this._generators.get(e);if(!r)return null;let a=r.generateKey(t),n=Is(a),l=s.generateKey(this._device),h=Is(l),c=`${n}#${h}`,f=this.getCachedShader(c);if(!f){let d=this.generateShaderDefinition(r,e,n,t),u="",p;t.pass!==void 0&&(p=Ds.get(this._device).getByIndex(t.pass),u=`-${p.name}`),this._device.fire("shader:generate",{userMaterialId:i,shaderPassInfo:p,definition:d});let _={name:`${d.name}${u}-proc`,attributes:d.attributes,vshader:d.vshader,vincludes:d.vincludes,fincludes:d.fincludes,fshader:d.fshader,processingOptions:s,shaderLanguage:d.shaderLanguage,meshUniformBufferFormat:d.meshUniformBufferFormat,meshBindGroupFormat:d.meshBindGroupFormat};f=new ai(this._device,_),this.setCachedShader(c,f)}return f}storeNewProgram(e,t){let s={};if(e==="standard"){let i=this._getDefaultStdMatOptions(t.pass);for(let r in t)(t.hasOwnProperty(r)&&i[r]!==t[r]||r==="pass")&&(s[r]=t[r]);for(let r in t.litOptions)s[r]=t.litOptions[r]}else s=t;this._programsCollection.push(JSON.stringify({name:e,options:s}))}dumpPrograms(){let e=`let device = pc.app ? pc.app.graphicsDevice : pc.Application.getApplication().graphicsDevice;
`;e+="let shaders = [",this._programsCollection[0]&&(e+=`
	${this._programsCollection[0]}`);for(let s=1;s<this._programsCollection.length;++s)e+=`,
	${this._programsCollection[s]}`;e+=`
];
`,e+=`pc.getProgramLibrary(device).precompile(shaders);
`,e+=`if (pc.version != "${tu}" || pc.revision != "${AE}")
`,e+='	console.warn("precompile-shaders.js: engine version mismatch, rebuild shaders lib with current engine");';let t=document.createElement("a");t.setAttribute("href",`data:text/plain;charset=utf-8,${encodeURIComponent(e)}`),t.setAttribute("download","precompile-shaders.js"),t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t)}clearCache(){this._isClearingCache=!0,this.processedCache.forEach(e=>{e.destroy()}),this.processedCache.clear(),this._isClearingCache=!1}removeFromCache(e){this._isClearingCache||this.processedCache.forEach((t,s)=>{e===t&&this.processedCache.delete(s)})}_getDefaultStdMatOptions(e){let t=Ds.get(this._device).getByIndex(e);return e===Sa||e===ga||t.isShadow?this._defaultStdMatOptionMin:this._defaultStdMatOption}precompile(e){if(e){let t=new Array(e.length);for(let s=0;s<e.length;s++){if(e[s].name==="standard"){let i=e[s].options,r=this._getDefaultStdMatOptions(i.pass);for(let a in r)r.hasOwnProperty(a)&&i[a]===void 0&&(i[a]=r[a])}t[s]=this.getProgram(e[s].name,e[s].options)}}this._precached=!0}}});var pp,BV,Eb,VV,Mne,vb,xb,kV,cn,oT=m(()=>{De();Ke();Ve();Q();Vt();pp=new k,BV=new H,Eb=new _e,VV=new _e,Mne=new N(1,1,0,.4),vb=.28209479177387814,xb=class{constructor(e,t,s,i,r){let a=e.getProp("x"),n=e.getProp("y"),l=e.getProp("z"),h=e.getProp("rot_1"),c=e.getProp("rot_2"),f=e.getProp("rot_3"),d=e.getProp("rot_0"),u=e.getProp("scale_0"),p=e.getProp("scale_1"),_=e.getProp("scale_2"),S=e.getProp("f_dc_0"),T=e.getProp("f_dc_1"),x=e.getProp("f_dc_2"),A=e.getProp("opacity"),E=v=>{if(v>0)return 1/(1+Math.exp(-v));let R=Math.exp(v);return R/(1+R)};this.read=v=>{t&&(t.x=a[v],t.y=n[v],t.z=l[v]),s&&s.set(h[v],c[v],f[v],d[v]),i&&i.set(Math.exp(u[v]),Math.exp(p[v]),Math.exp(_[v])),r&&r.set(.5+S[v]*vb,.5+T[v]*vb,.5+x[v]*vb,E(A[v]))}}},kV=(o,e,t)=>{BV.set(t.x,t.y,t.z,t.w).normalize(),o.setTRS(e,BV,g.ONE)},cn=class o{constructor(e,t=[]){this.elements=e,this.numSplats=this.getElement("vertex").count,this.comments=t}static calcSplatAabb(e,t,s,i){kV(pp,t,s),Eb.center.set(0,0,0),Eb.halfExtents.set(i.x*2,i.y*2,i.z*2),e.setFromTransformedAabb(Eb,pp)}getProp(e,t="vertex"){return this.getElement(t)?.properties.find(s=>s.name===e)?.storage}getElement(e){return this.elements.find(t=>t.name===e)}addProp(e,t){this.getElement("vertex").properties.push({type:"float",name:e,storage:t,byteSize:4})}createIter(e,t,s,i){return new xb(this,e,t,s,i)}calcAabb(e,t){let s,i,r,a,n,l,h=!0,c=this.getProp("x"),f=this.getProp("y"),d=this.getProp("z"),u=this.getProp("scale_0"),p=this.getProp("scale_1"),_=this.getProp("scale_2");for(let S=0;S<this.numSplats;++S){if(t&&!t(S))continue;let T=c[S],x=f[S],A=d[S],E=Math.max(u[S],p[S],_[S]);if(!isFinite(T)||!isFinite(x)||!isFinite(A)||!isFinite(E))continue;let v=2*Math.exp(E);h?(h=!1,s=T-v,i=x-v,r=A-v,a=T+v,n=x+v,l=A+v):(s=Math.min(s,T-v),i=Math.min(i,x-v),r=Math.min(r,A-v),a=Math.max(a,T+v),n=Math.max(n,x+v),l=Math.max(l,A+v))}return h||(e.center.set((s+a)*.5,(i+n)*.5,(r+l)*.5),e.halfExtents.set((a-s)*.5,(n-i)*.5,(l-r)*.5)),!h}calcAabbExact(e,t){let s=new g,i=new H,r=new g,a=this.createIter(s,i,r),n=!0;for(let l=0;l<this.numSplats;++l)t&&!t(l)||(a.read(l),n?(n=!1,o.calcSplatAabb(e,s,i,r)):(o.calcSplatAabb(VV,s,i,r),e.add(VV)));return!n}getCenters(e){let t=this.getProp("x"),s=this.getProp("y"),i=this.getProp("z");for(let r=0;r<this.numSplats;++r)e[r*3+0]=t[r],e[r*3+1]=s[r],e[r*3+2]=i[r]}calcFocalPoint(e,t){let s=this.getProp("x"),i=this.getProp("y"),r=this.getProp("z"),a=this.getProp("scale_0"),n=this.getProp("scale_1"),l=this.getProp("scale_2");e.x=0,e.y=0,e.z=0;let h=0;for(let c=0;c<this.numSplats;++c){if(t&&!t(c))continue;let f=s[c],d=i[c],u=r[c];if(!isFinite(f)||!isFinite(d)||!isFinite(u))continue;let p=1/(1+Math.exp(Math.max(a[c],n[c],l[c])));e.x+=f*p,e.y+=d*p,e.z+=u*p,h+=p}e.mulScalar(1/h)}renderWireframeBounds(e,t){let s=new g,i=new H,r=new g,a=new g,n=new g,l=this.createIter(s,i,r);for(let h=0;h<this.numSplats;++h)l.read(h),kV(pp,s,i),pp.mul2(t,pp),a.set(r.x*-2,r.y*-2,r.z*-2),n.set(r.x*2,r.y*2,r.z*2),e.immediate.drawWireAlignedBox(a,n,Mne,!0,e.defaultDrawLayer,pp)}get isCompressed(){return!1}get shBands(){return{9:1,24:2,45:3}[(()=>{for(let s=0;s<45;++s)if(!this.getProp(`f_rest_${s}`))return s;return 45})()]??0}calcMortonOrder(){let e=A=>{let E=A[0],v=A[0];for(let R=1;R<A.length;R++)A[R]<E&&(E=A[R]),A[R]>v&&(v=A[R]);return{min:E,max:v}},t=(A,E,v)=>{let R=P=>(P&=1023,P=(P^P<<16)&4278190335,P=(P^P<<8)&50393103,P=(P^P<<4)&51130563,P=(P^P<<2)&153391689,P);return(R(v)<<2)+(R(E)<<1)+R(A)},s=this.getProp("x"),i=this.getProp("y"),r=this.getProp("z"),{min:a,max:n}=e(s),{min:l,max:h}=e(i),{min:c,max:f}=e(r),d=a===n?0:1024/(n-a),u=l===h?0:1024/(h-l),p=c===f?0:1024/(f-c),_=new Map;for(let A=0;A<this.numSplats;A++){let E=Math.min(1023,Math.floor((s[A]-a)*d)),v=Math.min(1023,Math.floor((i[A]-l)*u)),R=Math.min(1023,Math.floor((r[A]-c)*p)),P=t(E,v,R),y=_.get(P);y?y.push(A):_.set(P,[A])}let S=Array.from(_.keys()).sort((A,E)=>A-E),T=new Uint32Array(this.numSplats),x=0;for(let A=0;A<S.length;++A){let E=_.get(S[A]);for(let v=0;v<E.length;++v)T[x++]=E[v]}return T}reorder(e){let t=new Map,s=a=>{if(t.has(a)){let n=t.get(a);return t.delete(a),n}return new ArrayBuffer(a)},i=a=>{t.set(a.byteLength,a)},r=a=>{let n=new a.constructor(s(a.byteLength));for(let l=0;l<e.length;l++)n[l]=a[e[l]];return i(a.buffer),n};this.elements.forEach(a=>{a.properties.forEach(n=>{n.storage&&(n.storage=r(n.storage))})})}reorderData(){this.reorder(this.calcMortonOrder())}}});var To,lT=m(()=>{Ne();Vt();j();Fe();Cr();$i();Ws();To=class{constructor(e,t){this.device=e,this.gsplatData=t,this.centers=new Float32Array(t.numSplats*3),t.getCenters(this.centers),this.aabb=new _e,t.calcAabb(this.aabb);let s=128,r=Math.ceil(t.numSplats/s)*s/s,a=new Uint32Array(r);for(let c=0;c<r;++c)a[c]=c*s;let n=new Tt(e,[{semantic:cf,components:1,type:gt,asInt:!0}]),l=new Float32Array(12*s),h=new Uint32Array(6*s);for(let c=0;c<s;++c){l.set([-1,-1,c,1,-1,c,1,1,c,-1,1,c],c*12);let f=c*4;h.set([0+f,1+f,2+f,0+f,2+f,3+f],c*6)}this.mesh=new Ce(e),this.mesh.setPositions(l,3),this.mesh.setIndices(h),this.mesh.update(),this.mesh.incRefCount(),this.mesh.aabb.copy(this.aabb),this.instanceIndices=new mt(e,n,r,{usage:0,data:a.buffer})}destroy(){this.mesh?.destroy(),this.instanceIndices?.destroy()}get instanceSize(){return 128}get numSplats(){return this.gsplatData.numSplats}configureMaterial(e){}evalTextureSize(e){return D.ZERO}createTexture(e,t,s,i){return new q(this.device,{name:e,width:s.x,height:s.y,format:t,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1,...i?{levels:[i]}:{}})}instantiate(){}}});var Dne,oc,KA=m(()=>{$l();Ve();Ne();Q();lT();Dne=(o,e)=>{let t=[];for(let s=0;s<e;++s)t.push(o.getProp(`f_rest_${s}`));return t},oc=class extends To{constructor(e,t){super(e,t);let s=t.numSplats,i=this.evalTextureSize(s);this.colorTexture=this.createTexture("splatColor",12,i),this.transformATexture=this.createTexture("transformA",49,i),this.transformBTexture=this.createTexture("transformB",12,i),this.updateColorData(t),this.updateTransformData(t),this.shBands=t.shBands,this.shBands>0&&(this.sh1to3Texture=this.createTexture("splatSH_1to3",49,i),this.shBands>1&&(this.sh4to7Texture=this.createTexture("splatSH_4to7",49,i),this.shBands>2?(this.sh8to11Texture=this.createTexture("splatSH_8to11",49,i),this.sh12to15Texture=this.createTexture("splatSH_12to15",49,i)):this.sh8to11Texture=this.createTexture("splatSH_8to11",37,i)),this.updateSHData(t))}destroy(){this.colorTexture?.destroy(),this.transformATexture?.destroy(),this.transformBTexture?.destroy(),this.sh1to3Texture?.destroy(),this.sh4to7Texture?.destroy(),this.sh8to11Texture?.destroy(),this.sh12to15Texture?.destroy(),super.destroy()}configureMaterial(e){e.setParameter("splatColor",this.colorTexture),e.setParameter("transformA",this.transformATexture),e.setParameter("transformB",this.transformBTexture),e.setDefine("SH_BANDS",this.shBands),this.sh1to3Texture&&e.setParameter("splatSH_1to3",this.sh1to3Texture),this.sh4to7Texture&&e.setParameter("splatSH_4to7",this.sh4to7Texture),this.sh8to11Texture&&e.setParameter("splatSH_8to11",this.sh8to11Texture),this.sh12to15Texture&&e.setParameter("splatSH_12to15",this.sh12to15Texture)}evalTextureSize(e){let t=Math.ceil(Math.sqrt(e)),s=Math.ceil(e/t);return new D(t,s)}updateColorData(e){let t=this.colorTexture;if(!t)return;let s=Bs.float2Half,i=t.lock(),r=e.getProp("f_dc_0"),a=e.getProp("f_dc_1"),n=e.getProp("f_dc_2"),l=e.getProp("opacity"),h=.28209479177387814;for(let c=0;c<this.numSplats;++c){let f=r[c]*h+.5,d=a[c]*h+.5,u=n[c]*h+.5,p=1/(1+Math.exp(-l[c]));i[c*4+0]=s(f),i[c*4+1]=s(d),i[c*4+2]=s(u),i[c*4+3]=s(p)}t.unlock()}updateTransformData(e){let t=Bs.float2Half;if(!this.transformATexture)return;let s=this.transformATexture.lock(),i=new Float32Array(s.buffer),r=this.transformBTexture.lock(),a=new g,n=new H,l=new g,h=e.createIter(a,n,l);for(let c=0;c<this.numSplats;c++)h.read(c),n.normalize(),n.w<0&&n.mulScalar(-1),i[c*4+0]=a.x,i[c*4+1]=a.y,i[c*4+2]=a.z,s[c*4+3]=t(n.x)|t(n.y)<<16,r[c*4+0]=t(l.x),r[c*4+1]=t(l.y),r[c*4+2]=t(l.z),r[c*4+3]=t(n.z);this.transformATexture.unlock(),this.transformBTexture.unlock()}updateSHData(e){let t=this.sh1to3Texture.lock(),s=this.sh4to7Texture?.lock(),i=this.sh8to11Texture?.lock(),r=this.sh12to15Texture?.lock(),a={1:3,2:8,3:15}[this.shBands],n=Dne(e,a*3),l=2047,h=1023,c=new Float32Array(1),f=new Uint32Array(c.buffer),d=new Array(a*3).fill(0);for(let u=0;u<e.numSplats;++u){for(let _=0;_<a;++_)d[_*3]=n[_][u],d[_*3+1]=n[_+a][u],d[_*3+2]=n[_+a*2][u];let p=d[0];for(let _=1;_<a*3;++_)p=Math.max(p,Math.abs(d[_]));if(p!==0){for(let _=0;_<a;++_)d[_*3+0]=Math.max(0,Math.min(l,Math.floor((d[_*3+0]/p*.5+.5)*l+.5))),d[_*3+1]=Math.max(0,Math.min(h,Math.floor((d[_*3+1]/p*.5+.5)*h+.5))),d[_*3+2]=Math.max(0,Math.min(l,Math.floor((d[_*3+2]/p*.5+.5)*l+.5)));c[0]=p,t[u*4+0]=f[0],t[u*4+1]=d[0]<<21|d[1]<<11|d[2],t[u*4+2]=d[3]<<21|d[4]<<11|d[5],t[u*4+3]=d[6]<<21|d[7]<<11|d[8],this.shBands>1&&(s[u*4+0]=d[9]<<21|d[10]<<11|d[11],s[u*4+1]=d[12]<<21|d[13]<<11|d[14],s[u*4+2]=d[15]<<21|d[16]<<11|d[17],s[u*4+3]=d[18]<<21|d[19]<<11|d[20],this.shBands>2?(i[u*4+0]=d[21]<<21|d[22]<<11|d[23],i[u*4+1]=d[24]<<21|d[25]<<11|d[26],i[u*4+2]=d[27]<<21|d[28]<<11|d[29],i[u*4+3]=d[30]<<21|d[31]<<11|d[32],r[u*4+0]=d[33]<<21|d[34]<<11|d[35],r[u*4+1]=d[36]<<21|d[37]<<11|d[38],r[u*4+2]=d[39]<<21|d[40]<<11|d[41],r[u*4+3]=d[42]<<21|d[43]<<11|d[44]):i[u]=d[21]<<21|d[22]<<11|d[23])}}this.sh1to3Texture.unlock(),this.sh4to7Texture?.unlock(),this.sh8to11Texture?.unlock(),this.sh12to15Texture?.unlock()}}});var One,Nne,Fne,Une,Bne,Vne,kne,yb,GV,hT,qA,zV=m(()=>{Q();Ke();qt();j();ii();Rt();Dt();It();Ne();us();zf();One=`
	attribute vec2 vertex_position;
	void main(void) {
		gl_Position = vec4(vertex_position, 0.0, 1.0);
	}
`,Nne=`
	#include "gsplatEvalSHVS"
	vec4 packRgb(vec3 v) {
		uvec3 vb = uvec3(clamp(v, vec3(0.0), vec3(1.0)) * vec3(2047.0, 2047.0, 1023.0));
		uint bits = (vb.x << 21) | (vb.y << 10) | vb.z;
		return vec4((uvec4(bits) >> uvec4(24, 16, 8, 0)) & uvec4(0xff)) / vec4(255.0);
	}
	uniform mediump vec3 dir;
	uniform mediump sampler2D centroids;
	uniform mediump float shN_mins;
	uniform mediump float shN_maxs;
	void main(void) {
		ivec2 uv = ivec2(gl_FragCoord.xy) * ivec2(SH_COEFFS, 1);
		mediump vec3 coefficients[SH_COEFFS];
		for (int i = 0; i < SH_COEFFS; i++) {
			vec3 s = texelFetch(centroids, ivec2(uv.x + i, uv.y), 0).xyz;
			coefficients[i] = mix(vec3(shN_mins), vec3(shN_maxs), s);
		}
		gl_FragColor = packRgb(evalSH(coefficients, dir) * 0.25 + 0.5);
	}
`,Fne=`
	attribute vertex_position: vec2f;
	@vertex
	fn vertexMain(input: VertexInput) -> VertexOutput {
		var output: VertexOutput;
		output.position = vec4f(vertex_position, 0.0, 1.0);
		return output;
	}
`,Une=`
	#include "gsplatEvalSHVS"
	fn packRgb(v: vec3f) -> vec4f {
		let vb = vec3u(clamp(v, vec3f(0.0), vec3f(1.0)) * vec3f(2047.0, 2047.0, 1023.0));
		let bits = dot(vb, vec3u(1 << 21, 1 << 10, 1));
		return vec4f((vec4u(bits) >> vec4u(24, 16, 8, 0)) & vec4u(0xff)) / vec4f(255.0);
	}
	uniform dir: vec3f;
	uniform shN_mins: f32;
	uniform shN_maxs: f32;
	var centroids: texture_2d<f32>;
	@fragment
	fn fragmentMain(input: FragmentInput) -> FragmentOutput {
		var output: FragmentOutput;
		var uv = vec2i(input.position.xy) * vec2i(SH_COEFFS, 1);
		var coefficients: array<vec3f, SH_COEFFS>;
		for (var i: i32 = 0; i < SH_COEFFS; i++) {
			let s: vec3f = textureLoad(centroids, vec2i(uv.x + i, uv.y), 0).xyz;
			coefficients[i] = mix(vec3f(uniform.shN_mins), vec3f(uniform.shN_maxs), s);
		}
		output.color = packRgb(evalSH(&coefficients, uniform.dir) * 0.25 + 0.5);
		return output;
	}
`,Bne=`
	uniform mediump sampler2D sh0;
	uniform highp sampler2D sh_labels;
	uniform mediump sampler2D sh_result;
	uniform vec4 sh0_mins;
	uniform vec4 sh0_maxs;
	float SH_C0 = 0.28209479177387814;
	vec3 unpackRgb(vec4 v) {
		uvec4 uv = uvec4(v * 255.0);
		uint bits = (uv.x << 24) | (uv.y << 16) | (uv.z << 8) | uv.w;
		uvec3 vb = (uvec3(bits) >> uvec3(21, 10, 0)) & uvec3(0x7ffu, 0x7ffu, 0x3ffu);
		return vec3(vb) / vec3(2047.0, 2047.0, 1023.0);
	}
	vec4 readColor(in SplatSource source) {
		vec4 baseSample = mix(sh0_mins, sh0_maxs, texelFetch(sh0, source.uv, 0));
		vec4 base = vec4(vec3(0.5) + baseSample.xyz * SH_C0, 1.0 / (1.0 + exp(-baseSample.w)));
		ivec2 labelSample = ivec2(texelFetch(sh_labels, source.uv, 0).xy * 255.0);
		int n = labelSample.x + labelSample.y * 256;
		vec4 shSample = texelFetch(sh_result, ivec2(n % 64, n / 64), 0);
		vec3 sh = (unpackRgb(shSample) - vec3(0.5)) * 4.0;
		return vec4(base.xyz + sh, base.w);
	}
`,Vne=`
	var sh0: texture_2d<f32>;
	var sh_labels: texture_2d<f32>;
	var sh_result: texture_2d<f32>;
	uniform sh0_mins: vec4f;
	uniform sh0_maxs: vec4f;
	const SH_C0: f32 = 0.28209479177387814;
	fn unpackRgb(v: vec4f) -> vec3f {
		let bits = dot(vec4u(v * 255.0), vec4u(1u << 24, 1u << 16, 1u << 8, 1u));
		let vb = (vec3u(bits) >> vec3u(21, 10, 0)) & vec3u(0x7ffu, 0x7ffu, 0x3ffu);
		return vec3f(vb) / vec3f(2047.0, 2047.0, 1023.0);
	}
	fn readColor(source: ptr<function, SplatSource>) -> vec4f {
		let baseSample: vec4f = mix(uniform.sh0_mins, uniform.sh0_maxs, textureLoad(sh0, source.uv, 0));
		let base = vec4f(vec3f(0.5) + baseSample.xyz * SH_C0, 1.0 / (1.0 + exp(-baseSample.w)));
		let labelSample: vec2i = vec2i(textureLoad(sh_labels, source.uv, 0).xy * 255.0);
		let n = labelSample.x + labelSample.y * 256;
		let shSample: vec4f = textureLoad(sh_result, vec2i(n % 64, n / 64), 0);
		let sh: vec3f = (unpackRgb(shSample) - vec3f(0.5)) * 4.0;
		return vec4f(base.xyz + sh, base.w);
	}
`,kne=(o,e)=>{for(let t in e)o.resolve(t).setValue(e[t])},yb=class extends Xe{execute(){this.executeCallback?.()}constructor(...e){super(...e),this.executeCallback=null}},GV=new k,hT=new g,qA=class{constructor(e,t){this.prevDir=new g,this.updateMode="enable",this.device=e,this.gsplatInstance=t;let{resource:s}=t,i=new Map(ie.get(e,e.isWebGPU?"wgsl":"glsl"));this.shader=Te.createShader(e,{uniqueName:"gsplatResolveSH",vertexGLSL:One,fragmentGLSL:Nne,vertexWGSL:Fne,fragmentWGSL:Une,vertexIncludes:i,fragmentIncludes:i,fragmentDefines:new Map([["SH_BANDS",s.gsplatData.shBands.toString()]]),attributes:{vertex_position:te}}),this.texture=s.createTexture("centroids",7,new D(64,1024)),this.renderTarget=new xe({colorBuffer:this.texture,depth:!1}),this.renderPass=new yb(e),this.renderPass.init(this.renderTarget,{}),this.renderPass.colorOps.clear=!0,this.quadRender=new Oi(this.shader);let{material:r}=t;r.setDefine("SH_BANDS","0");let{shaderChunks:a}=r;a.glsl.set("gsplatSogsColorVS",Bne),a.wgsl.set("gsplatSogsColorVS",Vne),r.update(),e.scope.resolve("sh_result").setValue(this.texture)}destroy(){let{gsplatInstance:e}=this,{material:t}=e;t.setDefine("SH_BANDS",e.resource.gsplatData.shBands.toString());let{shaderChunks:s}=t;s.glsl.delete("gsplatSogsColorVS"),s.wgsl.delete("gsplatSogsColorVS"),t.update(),this.quadRender.destroy(),this.renderPass.destroy(),this.renderTarget.destroy(),this.texture.destroy(),this.shader.destroy()}render(e,t){let{prevDir:s,updateMode:i}=this;if(i==="disable"||(GV.invert(t),GV.transformVector(e.forward,hT),hT.normalize(),i==="enable"&&hT.equalsApprox(s,.001)))return;s.copy(hT);let r=()=>{let{device:a}=this,{sh_centroids:n,meta:l}=this.gsplatInstance.resource.gsplatData;kne(a.scope,{dir:hT.toArray(),centroids:n,shN_mins:l.shN.mins,shN_maxs:l.shN.maxs}),a.setCullMode(0),a.setDepthState($e.NODEPTH),a.setStencilState(null,null),a.setBlendState(Ie.NOBLEND),this.quadRender.render()};this.renderPass.executeCallback=r,this.renderPass.render()}}});function HV(){let o=typeof self<"u"&&self||Tie("node:worker_threads").parentPort,e,t,s,i,r,a,n=!1,l={x:0,y:0,z:0},h={x:0,y:0,z:0},c={x:0,y:0,z:0},f={x:0,y:0,z:0},d,u,p=32,_=new Array(p).fill(0),S=new Array(p).fill(0),T=new Array(p).fill(0),x=(E,v,R)=>{for(;E<=v;){let P=v+E>>1,y=R(P);if(y>0)E=P+1;else if(y<0)v=P-1;else return P}return~E},A=()=>{if(!e||!t||t.length===0||!r||!a)return;let E=r.x,v=r.y,R=r.z,P=a.x,y=a.y,C=a.z,L=.001;if(!n&&Math.abs(E-l.x)<L&&Math.abs(v-l.y)<L&&Math.abs(R-l.z)<L&&Math.abs(P-h.x)<L&&Math.abs(y-h.y)<L&&Math.abs(C-h.z)<L)return;n=!1,l.x=E,l.y=v,l.z=R,h.x=P,h.y=y,h.z=C;let O,M;for(let V=0;V<8;++V){let z=V&1?c.x:f.x,ee=V&2?c.y:f.y,se=V&4?c.z:f.z,Y=z*P+ee*y+se*C;V===0?O=M=Y:(O=Math.min(O,Y),M=Math.max(M,Y))}let U=t.length/3,$=2**Math.max(10,Math.min(20,Math.round(Math.log2(U/4))))+1;d?.length!==U&&(d=new Uint32Array(U)),!u||u.length!==$?u=new Uint32Array($):u.fill(0);let X=M-O;if(X<1e-6)for(let V=0;V<U;++V)d[V]=0,u[0]++;else{let V=s.length/4;_.fill(0);for(let Y=0;Y<V;++Y){let ne=s[Y*4+0],ce=s[Y*4+1],ze=s[Y*4+2],Bt=s[Y*4+3],Lt=ne*P+ce*y+ze*C-O,Kt=Math.max(0,Math.floor((Lt-Bt)*p/X)),Va=Math.min(p,Math.ceil((Lt+Bt)*p/X));for(let vn=Kt;vn<Va;++vn)_[vn]++}let z=_.reduce((Y,ne)=>Y+ne,0);for(let Y=0;Y<p;++Y)T[Y]=_[Y]/z*$>>>0;for(let Y=0;Y<p;++Y)S[Y]=Y===0?0:S[Y-1]+T[Y-1];let ee=X/p,se=0;for(let Y=0;Y<U;++Y){let ne=t[se++],ce=t[se++],ze=t[se++],Bt=(ne*P+ce*y+ze*C-O)/ee,Lt=Bt>>>0,Kt=S[Lt]+T[Lt]*(Bt-Lt)>>>0;d[Y]=Kt,u[Kt]++}}for(let V=1;V<$;V++)u[V]+=u[V-1];for(let V=0;V<U;V++){let z=d[V],ee=--u[z];e[ee]=V}let I=E*P+v*y+R*C,b=V=>{let z=e[V]*3;return t[z++]*P+t[z++]*y+t[z]*C-I},F=()=>{let V=x(0,U-1,z=>-b(z));return Math.min(U,Math.abs(V))},B=b(U-1)>=0?F():U;if(i)for(let V=0;V<U;++V)e[V]=i[e[V]];o.postMessage({order:e.buffer,count:B},[e.buffer]),e=null};o.addEventListener("message",E=>{let v=E.data??E;if(v.order&&(e=new Uint32Array(v.order)),v.centers)if(t=new Float32Array(v.centers),n=!0,v.chunks){let R=new Float32Array(v.chunks);s=new Float32Array(v.chunks,0,R.length*4/6),c.x=R[0],c.y=R[1],c.z=R[2],f.x=R[3],f.y=R[4],f.z=R[5];for(let P=0;P<R.length/6;++P){let y=R[P*6+0],C=R[P*6+1],L=R[P*6+2],O=R[P*6+3],M=R[P*6+4],U=R[P*6+5];s[P*4+0]=(y+O)*.5,s[P*4+1]=(C+M)*.5,s[P*4+2]=(L+U)*.5,s[P*4+3]=Math.sqrt((O-y)**2+(M-C)**2+(U-L)**2)*.5,y<c.x&&(c.x=y),C<c.y&&(c.y=C),L<c.z&&(c.z=L),O>f.x&&(f.x=O),M>f.y&&(f.y=M),U>f.z&&(f.z=U)}}else{let R=t.length/3,P=Math.ceil(R/256);s=new Float32Array(P*4),c.x=c.y=c.z=1/0,f.x=f.y=f.z=-1/0;let y,C,L,O,M,U;for(let G=0;G<P;++G){y=C=L=1/0,O=M=U=-1/0;let $=G*256,X=Math.min(R,(G+1)*256);for(let I=$;I<X;++I){let b=t[I*3+0],F=t[I*3+1],B=t[I*3+2],V=Number.isFinite(b),z=Number.isFinite(F),ee=Number.isFinite(B);V||(t[I*3+0]=0),z||(t[I*3+1]=0),ee||(t[I*3+2]=0),!(!V||!z||!ee)&&(b<y?y=b:b>O&&(O=b),F<C?C=F:F>M&&(M=F),B<L?L=B:B>U&&(U=B),b<c.x?c.x=b:b>f.x&&(f.x=b),F<c.y?c.y=F:F>f.y&&(f.y=F),B<c.z?c.z=B:B>f.z&&(f.z=B))}s[G*4+0]=(y+O)*.5,s[G*4+1]=(C+M)*.5,s[G*4+2]=(L+U)*.5,s[G*4+3]=Math.sqrt((O-y)**2+(M-C)**2+(U-L)**2)*.5}}v.hasOwnProperty("mapping")&&(i=v.mapping?new Uint32Array(v.mapping):null,n=!0),v.cameraPosition&&(r=v.cameraPosition),v.cameraDirection&&(a=v.cameraDirection),A()})}var XV=m(()=>{});var jA,WV=m(()=>{Pe();j();bt();XV();jA=class extends K{constructor(){super();let e=s=>{let i=s.data??s,r=i.order,a=this.orderTexture._levels[0].buffer;this.worker.postMessage({order:a},[a]),this.orderTexture._levels[0]=new Uint32Array(r),this.orderTexture.upload(),this.fire("updated",i.count)},t=`(${HV.toString()})()`;ue.environment==="node"?(this.worker=new Worker(t,{eval:!0}),this.worker.on("message",e)):(this.worker=new Worker(URL.createObjectURL(new Blob([t],{type:"application/javascript"}))),this.worker.addEventListener("message",e))}destroy(){this.worker.terminate(),this.worker=null}init(e,t,s){this.orderTexture=e,this.centers=t.slice();let i=this.orderTexture.lock({mode:bu}).slice();this.orderTexture.unlock();for(let n=0;n<i.length;++n)i[n]=n;let r={order:i.buffer,centers:t.buffer,chunks:s?.buffer},a=[i.buffer,t.buffer].concat(s?[s.buffer]:[]);this.worker.postMessage(r,a)}setMapping(e){if(e){let t=new Float32Array(e.length*3);for(let s=0;s<e.length;++s){let i=e[s]*3,r=s*3;t[r+0]=this.centers[i+0],t[r+1]=this.centers[i+1],t[r+2]=this.centers[i+2]}this.worker.postMessage({centers:t.buffer,mapping:e.buffer},[t.buffer,e.buffer])}else{let t=this.centers.slice();this.worker.postMessage({centers:t.buffer,mapping:null},[t.buffer])}}setCamera(e,t){this.worker.postMessage({cameraPosition:{x:e.x,y:e.y,z:e.z},cameraDirection:{x:t.x,y:t.y,z:t.z}})}}});var YV,KV=m(()=>{YV=`
	uniform highp sampler2D means_l;
	uniform highp sampler2D means_u;
	uniform highp sampler2D quats;
	uniform highp sampler2D scales;
	uniform highp sampler2D sh_labels;
	uniform highp uint numSplats;
	uint packU32(vec4 v) {
		return uint(v.x * 255.0) << 24u |
			   uint(v.y * 255.0) << 16u |
			   uint(v.z * 255.0) << 8u |
			   uint(v.w * 255.0);
	}
	uvec4 packU32(vec4 a, vec4 b, vec4 c, vec4 d) {
		return uvec4(packU32(a), packU32(b), packU32(c), packU32(d));
	}
	void main(void) {
		int w = int(textureSize(means_l, 0).x);
		ivec2 uv = ivec2(gl_FragCoord.xy);
		if (uint(uv.x + uv.y * w) >= numSplats) {
			discard;
		}
		vec3 meansLSample = texelFetch(means_l, uv, 0).xyz;
		vec3 meansUSample = texelFetch(means_u, uv, 0).xyz;
		vec4 quatsSample = texelFetch(quats, uv, 0);
		vec3 scalesSample = texelFetch(scales, uv, 0).xyz;
		vec2 shLabelsSample = texelFetch(sh_labels, uv, 0).xy;
		pcFragColor0 = packU32(
			vec4(meansLSample, shLabelsSample.x),
			vec4(meansUSample, shLabelsSample.y),
			vec4(quatsSample),
			vec4(scalesSample, 0.0)
		);
	}
`});var qV,jV=m(()=>{qV=`
	var means_l: texture_2d<f32>;
	var means_u: texture_2d<f32>;
	var quats: texture_2d<f32>;
	var scales: texture_2d<f32>;
	var sh_labels: texture_2d<f32>;
	uniform numSplats: u32;
	fn packU32(v: vec4<f32>) -> u32 {
		return (u32(v.x * 255.0) << 24u)  |
			   (u32(v.y * 255.0) << 16u)  |
			   (u32(v.z * 255.0) << 8u) |
			   u32(v.w * 255.0);
	}
	fn packUVec32(a: vec4<f32>, b: vec4<f32>, c: vec4<f32>, d: vec4<f32>) -> vec4<u32> {
		return vec4<u32>(packU32(a), packU32(b), packU32(c), packU32(d));
	}
	@fragment
	fn fragmentMain(input: FragmentInput) -> FragmentOutput {
		var output: FragmentOutput;
		let w: u32 = textureDimensions(means_l, 0).x;
		let uv: vec2<u32> = vec2<u32>(pcPosition.xy);
		if (uv.x + uv.y * w >= uniform.numSplats) {
			discard;
			return output;
		}
		let meansLSample: vec3<f32> = textureLoad(means_l, uv, 0).xyz;
		let meansUSample: vec3<f32> = textureLoad(means_u, uv, 0).xyz;
		let quatsSample: vec4<f32> = textureLoad(quats, uv, 0);
		let scalesSample: vec3<f32> = textureLoad(scales, uv, 0).xyz;
		let shLabelsSample: vec2<f32> = textureLoad(sh_labels, uv, 0).xy;
		output.color = packUVec32(
			vec4(meansLSample, shLabelsSample.x),
			vec4(meansUSample, shLabelsSample.y),
			vec4(quatsSample),
			vec4(scalesSample, 0.0)
		);
		return output;
	}
`});var _p,ml,Gne,Ab,lc,$A=m(()=>{Ve();Q();Ze();oT();qt();ii();Rt();Fe();j();Ea();Dt();KV();jV();_p=.28209479177387814,ml=o=>o.read(0,0,o.width,o.height,{mipLevel:0,face:0,immediate:!0}),Gne=(o,e)=>{for(let t in e)o.resolve(t).setValue(e[t])},Ab=class{constructor(e,t,s,i,r,a){let n=(v,R,P)=>v*(1-P)+R*P,{meta:l}=e,{means:h,scales:c,sh0:f,shN:d}=l,u=t&&e.means_l._levels[0],p=t&&e.means_u._levels[0],_=s&&e.quats._levels[0],S=i&&e.scales._levels[0],T=r&&e.sh0._levels[0],x=a&&e.sh_labels._levels[0],A=a&&e.sh_centroids._levels[0],E=2/Math.sqrt(2);this.read=v=>{if(t){let R=n(h.mins[0],h.maxs[0],((p[v*4+0]<<8)+u[v*4+0])/65535),P=n(h.mins[1],h.maxs[1],((p[v*4+1]<<8)+u[v*4+1])/65535),y=n(h.mins[2],h.maxs[2],((p[v*4+2]<<8)+u[v*4+2])/65535);t.x=Math.sign(R)*(Math.exp(Math.abs(R))-1),t.y=Math.sign(P)*(Math.exp(Math.abs(P))-1),t.z=Math.sign(y)*(Math.exp(Math.abs(y))-1)}if(s){let R=(_[v*4+0]/255-.5)*E,P=(_[v*4+1]/255-.5)*E,y=(_[v*4+2]/255-.5)*E,C=Math.sqrt(Math.max(0,1-(R*R+P*P+y*y)));switch(_[v*4+3]-252){case 0:s.set(R,P,y,C);break;case 1:s.set(C,P,y,R);break;case 2:s.set(P,C,y,R);break;case 3:s.set(P,y,C,R);break}}if(i){let R=n(c.mins[0],c.maxs[0],S[v*4+0]/255),P=n(c.mins[1],c.maxs[1],S[v*4+1]/255),y=n(c.mins[2],c.maxs[2],S[v*4+2]/255);i.set(R,P,y)}if(r){let R=n(f.mins[0],f.maxs[0],T[v*4+0]/255),P=n(f.mins[1],f.maxs[1],T[v*4+1]/255),y=n(f.mins[2],f.maxs[2],T[v*4+2]/255),C=n(f.mins[3],f.maxs[3],T[v*4+3]/255);r.set(.5+R*_p,.5+P*_p,.5+y*_p,1/(1+Math.exp(-C)))}if(a){let R=x[v*4+0]+(x[v*4+1]<<8),P=R%64*15,y=Math.floor(R/64);for(let C=0;C<3;++C)for(let L=0;L<15;++L)a[C*15+L]=n(d.mins,d.maxs,A[(P+L)*4+C+y*e.sh_centroids.width*4]/255)}}}},lc=class{destroy(){this.means_l?.destroy(),this.means_u?.destroy(),this.quats?.destroy(),this.scales?.destroy(),this.sh0?.destroy(),this.sh_centroids?.destroy(),this.sh_labels?.destroy(),this.packedTexture?.destroy()}createIter(e,t,s,i,r){return new Ab(this,e,t,s,i,r)}calcAabb(e){let{mins:t,maxs:s}=this.meta.means,i=r=>Math.sign(r)*(Math.exp(Math.abs(r))-1);e.center.set((i(t[0])+i(s[0]))*.5,(i(t[1])+i(s[1]))*.5,(i(t[2])+i(s[2]))*.5),e.halfExtents.set((i(s[0])-i(t[0]))*.5,(i(s[1])-i(t[1]))*.5,(i(s[2])-i(t[2]))*.5)}getCenters(e){let{meta:t,means_l:s,means_u:i,numSplats:r}=this,{means:a}=t,n=new Uint32Array(i._levels[0].buffer),l=new Uint32Array(s._levels[0].buffer),h=a.mins[0]/65535,c=a.mins[1]/65535,f=a.mins[2]/65535,d=a.maxs[0]/65535,u=a.maxs[1]/65535,p=a.maxs[2]/65535;for(let _=0;_<r;_++){let S=_,T=n[S],x=l[S],A=T<<8&65280|x&255,E=T&65280|x>>>8&255,v=T>>>8&65280|x>>>16&255,R=h*(65535-A)+d*A,P=c*(65535-E)+u*E,y=f*(65535-v)+p*v,C=R<0?-R:R,L=P<0?-P:P,O=y<0?-y:y;e[_*3]=(R<0?-1:1)*(Math.exp(C)-1),e[_*3+1]=(P<0?-1:1)*(Math.exp(L)-1),e[_*3+2]=(y<0?-1:1)*(Math.exp(O)-1)}}calcFocalPoint(e,t){e.set(0,0,0)}get isSogs(){return!0}get shBands(){return{192:1,512:2,960:3}[this.sh_centroids?.width]??0}async decompress(){let e=["x","y","z","f_dc_0","f_dc_1","f_dc_2","opacity","scale_0","scale_1","scale_2","rot_0","rot_1","rot_2","rot_3"],{shBands:t}=this,{means_l:s,means_u:i,quats:r,scales:a,sh0:n,sh_labels:l,sh_centroids:h}=this;if(s._levels[0]=await ml(s),i._levels[0]=await ml(i),r._levels[0]=await ml(r),a._levels[0]=await ml(a),n._levels[0]=await ml(n),t>0){l._levels[0]=await ml(l),h._levels[0]=await ml(h);let T=[];for(let x=0;x<45;++x)T.push(`f_rest_${x}`);e.splice(e.indexOf("f_dc_0")+1,0,...T)}let c={};e.forEach(T=>{c[T]=new Float32Array(this.numSplats)});let f=new g,d=new H,u=new g,p=new W,_=t>0?new Float32Array(45):null,S=this.createIter(f,d,u,p,_);for(let T=0;T<this.numSplats;++T)if(S.read(T),c.x[T]=f.x,c.y[T]=f.y,c.z[T]=f.z,c.rot_1[T]=d.x,c.rot_2[T]=d.y,c.rot_3[T]=d.z,c.rot_0[T]=d.w,c.scale_0[T]=u.x,c.scale_1[T]=u.y,c.scale_2[T]=u.z,c.f_dc_0[T]=(p.x-.5)/_p,c.f_dc_1[T]=(p.y-.5)/_p,c.f_dc_2[T]=(p.z-.5)/_p,c.opacity[T]=p.w<=0?-40:p.w>=1?40:-Math.log(1/p.w-1),_)for(let x=0;x<45;++x)c[`f_rest_${x}`][T]=_[x];return new cn([{name:"vertex",count:this.numSplats,properties:e.map(T=>({name:T,type:"float",byteSize:4,storage:c[T]}))}])}packGpuMemory(){let{means_l:e,means_u:t,quats:s,scales:i,sh_labels:r,numSplats:a}=this,{device:n}=e,{scope:l}=n,h=Te.createShader(n,{uniqueName:"GsplatSogsReorderShader",attributes:{vertex_position:te},vertexChunk:"fullscreenQuadVS",fragmentGLSL:YV,fragmentWGSL:qV,fragmentOutputTypes:["uvec4"]}),c=new xe({colorBuffer:this.packedTexture,depth:!1,mipLevel:0});n.setCullMode(0),n.setBlendState(Ie.NOBLEND),n.setDepthState($e.NODEPTH),Gne(l,{means_l:e,means_u:t,quats:s,scales:i,sh_labels:r??e,numSplats:a}),Ot(n,c,h),c.destroy(),h.destroy()}async prepareGpuData(){let{device:e,height:t,width:s}=this.means_l;this.means_l._levels[0]=await ml(this.means_l),this.means_u._levels[0]=await ml(this.means_u),this.packedTexture=new q(e,{name:"sogsPackedTexture",width:s,height:t,format:49,mipmaps:!1}),e.on("devicerestored",()=>{this.packGpuMemory()}),this.packGpuMemory()}reorderData(){return this.prepareGpuData()}}});var zne,gp,Sp,ZA,Tp,Pb=m(()=>{Ke();Q();j();_s();zV();WV();$A();$h();J();zne=new k,gp=new g,Sp=new g,ZA=[0,0],Tp=class{constructor(e,t={}){this.options={},this.sorter=null,this.lastCameraPosition=new g,this.lastCameraDirection=new g,this.resolveSH=null,this.cameras=[],this.resource=e,this.orderTexture=e.createTexture("splatOrder",37,e.evalTextureSize(e.numSplats)),t.material?(this._material=t.material,this._material.setParameter("splatOrder",this.orderTexture)):(this._material=new oi({uniqueName:"SplatMaterial",vertexGLSL:'#include "gsplatVS"',fragmentGLSL:'#include "gsplatPS"',vertexWGSL:'#include "gsplatVS"',fragmentWGSL:'#include "gsplatPS"',attributes:{vertex_position:te,vertex_id_attrib:cf}}),this.configureMaterial(this._material),this._material.update()),this.meshInstance=new Oe(e.mesh,this._material),this.meshInstance.setInstancing(e.instanceIndices,!0),this.meshInstance.gsplatInstance=this,this.meshInstance.instancingCount=0;let s=e.centers.slice(),i=e.chunks?.slice();this.sorter=new jA,this.sorter.init(this.orderTexture,s,i),this.sorter.on("updated",r=>{this.meshInstance.instancingCount=Math.ceil(r/e.instanceSize),this.material.setParameter("numSplats",r)}),this.setHighQualitySH(t.highQualitySH??!1)}destroy(){this.resolveSH?.destroy(),this.material?.destroy(),this.meshInstance?.destroy(),this.sorter?.destroy()}set material(e){this._material!==e&&(this._material=e,this._material.setParameter("splatOrder",this.orderTexture),this.meshInstance&&(this.meshInstance.material=e))}get material(){return this._material}configureMaterial(e,t={}){this.resource.configureMaterial(e),e.setParameter("numSplats",0),e.setParameter("splatOrder",this.orderTexture),e.setParameter("alphaClip",.3),e.setDefine(`DITHER_${t.dither?"BLUENOISE":"NONE"}`,""),e.cull=0,e.blendType=t.dither?$t:er,e.depthWrite=!!t.dither}updateViewport(e){let t=e?.camera,s=t?.renderTarget,{width:i,height:r}=s??this.resource.device;ZA[0]=i,ZA[1]=r;let a=t?.camera?.xr;a?.active&&a.views.list.length===2&&(ZA[0]*=.5),this.material.setParameter("viewport",ZA)}sort(e){if(this.sorter){let t=e.getWorldTransform();t.getTranslation(gp),t.getZ(Sp);let s=this.meshInstance.node.getWorldTransform(),i=zne.invert(s);i.transformPoint(gp,gp),i.transformVector(Sp,Sp),(!gp.equalsApprox(this.lastCameraPosition)||!Sp.equalsApprox(this.lastCameraDirection))&&(this.lastCameraPosition.copy(gp),this.lastCameraDirection.copy(Sp),this.sorter.setCamera(gp,Sp))}this.updateViewport(e)}update(){if(this.cameras.length>0){let e=this.cameras[0];this.sort(e._node),this.resolveSH?.render(e._node,this.meshInstance.node.getWorldTransform()),this.cameras.length=0}}setHighQualitySH(e){let{resource:t}=this,{gsplatData:s}=t;s instanceof lc&&s.shBands>0&&e===!!this.resolveSH&&(this.resolveSH?(this.resolveSH.destroy(),this.resolveSH=null):this.resolveSH=new qA(t.device,this))}}});var Ep,Rb=m(()=>{Ne();lT();Ep=class extends To{destroy(){this.gsplatData.destroy(),super.destroy()}configureMaterial(e){let{gsplatData:t}=this;e.setDefine("GSPLAT_SOGS_DATA",!0),e.setDefine("SH_BANDS",this.gsplatData.shBands),["packedTexture","sh0","sh_centroids"].forEach(s=>{t[s]&&e.setParameter(s,t[s])}),["means","scales","sh0","shN"].forEach(s=>{let i=t.meta[s];i&&(e.setParameter(`${s}_mins`,i.mins),e.setParameter(`${s}_maxs`,i.maxs))})}evalTextureSize(e){return new D(this.gsplatData.means_l.width,this.gsplatData.means_l.height)}}});var QA,JA,cT,ad,e0,Cb=m(()=>{QA="NONE",JA="FILL_WINDOW",cT="KEEP_ASPECT",ad="AUTO",e0="FIXED"});function Ss(){return $V}function t0(o){$V=o}var $V,hc=m(()=>{});var ZV,vp,s0=m(()=>{hc();ZV=!1,vp={app:null,createLoadingScreen(o){if(ZV)return;ZV=!0;let e=Ss();o(e)}}});var i0,QV=m(()=>{i0=class{addRenderPass(e){e.frameUpdate();let t=e.beforePasses;for(let i=0;i<t.length;i++){let r=t[i];r.enabled&&this.addRenderPass(r)}e.enabled&&this.renderPasses.push(e);let s=e.afterPasses;for(let i=0;i<s.length;i++){let r=s[i];r.enabled&&this.addRenderPass(r)}}reset(){this.renderPasses.length=0}compile(){let e=this.renderTargetMap,t=this.renderPasses;for(let r=0;r<t.length;r++){let a=t[r],n=a.renderTarget;if(n!==void 0){let l=e.get(n);if(l){let h=a.colorArrayOps.length;for(let c=0;c<h;c++)a.colorArrayOps[c].clear||(l.colorArrayOps[c].store=!0);a.depthStencilOps.clearDepth||(l.depthStencilOps.storeDepth=!0),a.depthStencilOps.clearStencil||(l.depthStencilOps.storeStencil=!0)}e.set(n,a)}}for(let r=0;r<t.length-1;r++){let a=t[r],n=a.renderTarget,l=t[r+1],h=l.renderTarget;n!==h||n===void 0||l.depthStencilOps.clearDepth||l.depthStencilOps.clearStencil||l.colorArrayOps.some(c=>c.clear)||a.afterPasses.length>0||l.beforePasses.length>0||(a._skipEnd=!0,l._skipStart=!0)}let s=null,i=null;for(let r=0;r<t.length;r++){let a=t[r],n=a.renderTarget,l=n?.colorBuffer;if(l?.cubemap){if(s===l){let h=i.colorArrayOps.length;for(let c=0;c<h;c++)i.colorArrayOps[c].mipmaps=!1}s=n.colorBuffer,i=a}else a.requiresCubemaps&&(s=null,i=null)}e.clear()}render(e){this.compile();let t=this.renderPasses;for(let s=0;s<t.length;s++)t[s].render()}constructor(){this.renderPasses=[],this.renderTargetMap=new Map}}});var Ib,JV,fT,ek=m(()=>{$l();Fe();bi();j();Ib=class{constructor(e,t){this.texture0=e,this.texture1=t}destroy(){this.texture0?.destroy(),this.texture1?.destroy()}},JV=new st,fT=class o{static createTexture(e,t,s,i=""){return new q(e,{name:`AreaLightLUT${i}`,width:s,height:s,format:t,addressU:1,addressV:1,type:zt,magFilter:1,minFilter:0,anisotropy:1,mipmaps:!1})}static applyTextures(e,t,s){JV.remove(e),JV.get(e,()=>new Ib(t,t===s?null:s)),e.scope.resolve("areaLightsLutTex1").setValue(t),e.scope.resolve("areaLightsLutTex2").setValue(s)}static createPlaceholder(e){let t=o.createTexture(e,12,2,"placeholder");t.lock().fill(0),t.unlock(),o.applyTextures(e,t,t)}static set(e,t,s){function i(d,u,p){let _=o.createTexture(d,p,64);return _.lock().set(u),_.unlock(),_}function r(d){let u=d.length,p=new Uint16Array(u),_=Bs.float2Half;for(let S=0;S<u;S++)p[S]=_(d[S]);return p}let a=t,n=s,l=r(a),h=r(n),c=i(e,l,12),f=i(e,h,12);o.applyTextures(e,c,f)}}});var xp,yp,wb=m(()=>{xp="en-US",yp={en:"en-US",es:"en-ES",zh:"zh-CN","zh-HK":"zh-TW","zh-TW":"zh-HK","zh-MO":"zh-HK",fr:"fr-FR",de:"de-DE",it:"it-IT",ru:"ru-RU",ja:"ja-JP"}});function cc(o,e){for(let t=0,s=o.length;t<s;t++)Lb[o[t]]=e}function Eo(o){let e=o.indexOf("-");return e!==-1?o.substring(0,e):o}function tk(o,e){let t=o.indexOf("-");return t!==-1?e+o.substring(t):e}function r0(o,e){if(e[o])return o;let t=yp[o];if(t&&e[t])return t;let s=Eo(o);return t=yp[s],e[t]?t:e[s]?s:xp}function a0(o){return Lb[o]||Hne}var Lb,Hne,bb=m(()=>{wb();Lb={};cc(["ja","ko","th","vi","zh","id"],o=>0);cc(["fa","hi"],o=>o>=0&&o<=1?0:1);cc(["fr","pt"],o=>o>=0&&o<2?0:1);cc(["da"],o=>o===1||!Number.isInteger(o)&&o>=0&&o<=1?0:1);cc(["de","en","it","el","es","tr","fi","sv","nb","no","ur"],o=>o===1?0:1);cc(["ru","uk"],o=>{if(Number.isInteger(o)){let e=o%10,t=o%100;if(e===1&&t!==11)return 0;if(e>=2&&e<=4&&(t<12||t>14))return 1;if(e===0||e>=5&&e<=9||t>=11&&t<=14)return 2}return 3});cc(["pl"],o=>{if(Number.isInteger(o)){if(o===1)return 0;let e=o%10,t=o%100;if(e>=2&&e<=4&&(t<12||t>14))return 1;if(e>=0&&e<=1||e>=5&&e<=9||t>=12&&t<=14)return 2}return 3});cc(["ar"],o=>{if(o===0)return 0;if(o===1)return 1;if(o===2)return 2;if(Number.isInteger(o)){let e=o%100;if(e>=3&&e<=10)return 3;if(e>=11&&e<=99)return 4}return 5});Hne=Lb[Eo(xp)]});var La,sk,ik,rk,ak,nk,ok,lk,hk,ck,fk,dk,uk,mk,pk,_k,Ap=m(()=>{La=new RegExp("^\\s*(?:(?:[a-z]+[a-z0-9\\-+.]*:)?//|data:|blob:)","i"),sk="animation",ik="audio",rk="image",ak="json",nk="model",ok="material",lk="text",hk="texture",ck="textureatlas",fk="cubemap",dk="shader",uk="css",mk="html",pk="script",_k="container"});var n0,gk=m(()=>{n0=class{constructor(e="",t="",s=null,i=null,r=null,a=null){this.url=e,this.filename=t,this.hash=s,this.size=i,this.opt=r,this.contents=a}equals(e){return this.url===e.url&&this.filename===e.filename&&this.hash===e.hash&&this.size===e.size&&this.opt===e.opt&&this.contents===e.contents}}});var Xne,Wne,Sk,re,rt=m(()=>{Fs();wE();Pe();bb();Ap();gk();hc();Ct();Xne=-1,Wne={pvr:"extCompressedTexturePVRTC",dxt:"extCompressedTextureS3TC",etc2:"extCompressedTextureETC",etc1:"extCompressedTextureETC1",basis:"canvas"},Sk=["pvr","dxt","etc2","etc1","basis"],re=class extends K{static{this.EVENT_LOAD="load"}static{this.EVENT_UNLOAD="unload"}static{this.EVENT_REMOVE="remove"}static{this.EVENT_ERROR="error"}static{this.EVENT_CHANGE="change"}static{this.EVENT_PROGRESS="progress"}static{this.EVENT_ADDLOCALIZED="add:localized"}static{this.EVENT_REMOVELOCALIZED="remove:localized"}constructor(e,t,s,i={},r={}){super(),this._file=null,this._i18n={},this._preload=!1,this._resources=[],this.id=Xne--,this.loaded=!1,this.loading=!1,this.options={},this.registry=null,this.tags=new Kl(this),this.urlObject=null,this._name=e||"",this.type=t,this._data=i||{},this.options=r||{},s&&(this.file=s)}set name(e){if(this._name===e)return;let t=this._name;this._name=e,this.fire("name",this,this._name,t)}get name(){return this._name}set file(e){if(e&&e.variants&&["texture","textureatlas","bundle"].indexOf(this.type)!==-1){let i=this.registry?._loader?._app||Ss(),r=i?.graphicsDevice;if(r)for(let a=0,n=Sk.length;a<n;a++){let l=Sk[a];if(e.variants[l]&&r[Wne[l]]){e=e.variants[l];break}if(i.enableBundles){let h=i.bundles.listBundlesForAsset(this);if(h&&h.find(c=>c?.file?.variants[l]))break}}}let t=this._file,s=e?new n0(e.url,e.filename,e.hash,e.size,e.opt,e.contents):null;(!!s!=!!t||s&&!s.equals(t))&&(this._file=s,this.fire("change",this,"file",s,t),this.reload())}get file(){return this._file}set data(e){let t=this._data;this._data=e,e!==t&&(this.fire("change",this,"data",e,t),this.loaded&&this.registry._loader.patch(this,this.registry))}get data(){return this._data}set resource(e){let t=this._resources[0];this._resources[0]=e,this.fire("change",this,"resource",e,t)}get resource(){return this._resources[0]}set resources(e){let t=this._resources;this._resources=e,this.fire("change",this,"resources",e,t)}get resources(){return this._resources}set preload(e){e=!!e,this._preload!==e&&(this._preload=e,this._preload&&!this.loaded&&!this.loading&&this.registry&&this.registry.load(this))}get preload(){return this._preload}set loadFaces(e){e=!!e,(!this.hasOwnProperty("_loadFaces")||e!==this._loadFaces)&&(this._loadFaces=e,this.loaded&&this.registry._loader.patch(this,this.registry))}get loadFaces(){return this._loadFaces}getFileUrl(){let e=this.file;if(!e||!e.url)return null;let t=e.url;if(this.registry&&this.registry.prefix&&!La.test(t)&&(t=this.registry.prefix+t),this.type!=="script"&&e.hash){let s=t.indexOf("?")!==-1?"&":"?";t+=`${s}t=${e.hash}`}return t}getAbsoluteUrl(e){if(e.startsWith("blob:")||e.startsWith("data:"))return e;let t=ve.getDirectory(this.file.url);return ve.join(t,e)}getLocalizedAssetId(e){return e=r0(e,this._i18n),this._i18n[e]||null}addLocalizedAssetId(e,t){this._i18n[e]=t,this.fire("add:localized",e,t)}removeLocalizedAssetId(e){let t=this._i18n[e];t&&(delete this._i18n[e],this.fire("remove:localized",e,t))}ready(e,t){t=t||this,this.loaded?e.call(t,this):this.once("load",s=>{e.call(t,s)})}reload(){this.loaded&&(this.loaded=!1,this.registry.load(this))}unload(){if(!this.loaded&&this._resources.length===0)return;this.fire("unload",this),this.registry.fire(`unload:${this.id}`,this);let e=this._resources;this.urlObject&&(URL.revokeObjectURL(this.urlObject),this.urlObject=null),this.resources=[],this.loaded=!1,this.file&&this.registry._loader.clearCache(this.getFileUrl(),this.type);for(let t=0;t<e.length;++t){let s=e[t];s&&s.destroy&&s.destroy()}}static fetchArrayBuffer(e,t,s,i=0){s?.file?.contents?setTimeout(()=>{t(null,s.file.contents)}):Le.get(e,{cache:!0,responseType:"arraybuffer",retry:i>0,maxRetries:i},t)}}});var o0,Tk=m(()=>{o0=class{constructor(e=null){this._index={},this._key=e}addItem(e){let t=e.tags._list;for(let s of t)this.add(s,e)}removeItem(e){let t=e.tags._list;for(let s of t)this.remove(s,e)}add(e,t){this._index[e]&&this._index[e].list.indexOf(t)!==-1||(this._index[e]||(this._index[e]={list:[]},this._key&&(this._index[e].keys={})),this._index[e].list.push(t),this._key&&(this._index[e].keys[t[this._key]]=t))}remove(e,t){if(!this._index[e]||this._key&&!this._index[e].keys[t[this._key]])return;let s=this._index[e].list.indexOf(t);s!==-1&&(this._index[e].list.splice(s,1),this._key&&delete this._index[e].keys[t[this._key]],this._index[e].list.length===0&&delete this._index[e])}find(e){let t={},s=[],i,r,a,n,l,h=(c,f)=>this._index[c].list.length-this._index[f].list.length;for(let c=0;c<e.length;c++){if(r=e[c],r instanceof Array){if(r.length===0)continue;if(r.length===1)r=r[0];else{l=!1;for(let f=0;f<r.length;f++)if(!this._index[r[f]]){l=!0;break}if(l)continue;a=r.slice(0).sort(h),n=a.slice(1),n.length===1&&(n=n[0]);for(let f=0;f<this._index[a[0]].list.length;f++)i=this._index[a[0]].list[f],(this._key?!t[i[this._key]]:s.indexOf(i)===-1)&&i.tags.has(n)&&(this._key&&(t[i[this._key]]=!0),s.push(i));continue}}if(r&&typeof r=="string"&&this._index[r])for(let f=0;f<this._index[r].list.length;f++)i=this._index[r].list[f],this._key?t[i[this._key]]||(t[i[this._key]]=!0,s.push(i)):s.indexOf(i)===-1&&s.push(i)}return s}}});var fc,l0=m(()=>{Fs();Pe();Tk();hp();rt();fc=class extends K{static{this.EVENT_LOAD="load"}static{this.EVENT_ADD="add"}static{this.EVENT_REMOVE="remove"}static{this.EVENT_ERROR="error"}constructor(e){super(),this._assets=new Set,this._idToAsset=new Map,this._urlToAsset=new Map,this._nameToAsset=new Map,this._tags=new o0("id"),this.prefix=null,this.bundles=null,this._loader=e}list(e={}){let t=Array.from(this._assets);return e.preload!==void 0?t.filter(s=>s.preload===e.preload):t}add(e){this._assets.has(e)||(this._assets.add(e),this._idToAsset.set(e.id,e),e.file?.url&&this._urlToAsset.set(e.file.url,e),this._nameToAsset.has(e.name)||this._nameToAsset.set(e.name,new Set),this._nameToAsset.get(e.name).add(e),e.on("name",this._onNameChange,this),e.registry=this,this._tags.addItem(e),e.tags.on("add",this._onTagAdd,this),e.tags.on("remove",this._onTagRemove,this),this.fire("add",e),this.fire(`add:${e.id}`,e),e.file?.url&&this.fire(`add:url:${e.file.url}`,e),e.preload&&this.load(e))}remove(e){if(!this._assets.has(e))return!1;if(this._assets.delete(e),this._idToAsset.delete(e.id),e.file?.url&&this._urlToAsset.delete(e.file.url),e.off("name",this._onNameChange,this),this._nameToAsset.has(e.name)){let t=this._nameToAsset.get(e.name);t.delete(e),t.size===0&&this._nameToAsset.delete(e.name)}return this._tags.removeItem(e),e.tags.off("add",this._onTagAdd,this),e.tags.off("remove",this._onTagRemove,this),e.fire("remove",e),this.fire("remove",e),this.fire(`remove:${e.id}`,e),e.file?.url&&this.fire(`remove:url:${e.file.url}`,e),!0}get(e){return this._idToAsset.get(Number(e))}getByUrl(e){return this._urlToAsset.get(e)}load(e,t){if((e.loading||e.loaded)&&!t?.force)return;let s=e.file,i=()=>{this.fire("load",e),this.fire(`load:${e.id}`,e),s&&s.url&&this.fire(`load:url:${s.url}`,e),e.fire("load",e)},r=n=>{if(n instanceof Array?e.resources=n:e.resource=n,this._loader.patch(e,this),e.type==="bundle"){let l=e.data.assets;for(let h=0;h<l.length;h++){let c=this._idToAsset.get(l[h]);c&&!c.loaded&&this.load(c,{force:!0})}e.resource.loaded?i():(this.fire("load:start",e),this.fire(`load:start:${e.id}`,e),s&&s.url&&this.fire(`load:start:url:${s.url}`,e),e.fire("load:start",e),e.resource.on("load",i))}else i()},a=(n,l,h)=>{if(e.loaded=!0,e.loading=!1,n)this.fire("error",n,e),this.fire(`error:${e.id}`,n,e),e.fire("error",n,e);else{if(e.type==="script"){let c=this._loader.getHandler("script");c._cache[e.id]&&c._cache[e.id].parentNode===document.head&&document.head.removeChild(c._cache[e.id]),c._cache[e.id]=h}r(l)}};if(s||e.type==="cubemap"){this.fire("load:start",e),this.fire(`load:${e.id}:start`,e),e.loading=!0;let n=e.getFileUrl();if(e.type==="bundle"){let l=e.data.assets;for(let h=0;h<l.length;h++){let c=this._idToAsset.get(l[h]);c&&(c.loaded||c.resource||c.loading||(c.loading=!0))}}this._loader.load(n,e.type,a,e,t)}else{let n=this._loader.open(e.type,e.data);e.loaded=!0,r(n)}}loadFromUrl(e,t,s){this.loadFromUrlAndFilename(e,null,t,s)}loadFromUrlAndFilename(e,t,s,i){let r=ve.getBasename(t||e),a={filename:t||r,url:e},n=this.getByUrl(e);if(!n)n=new re(r,s,a),this.add(n);else if(n.loaded){i(n.loadFromUrlError||null,n);return}let l=h=>{h.once("load",c=>{s==="material"?this._loadTextures(c,(f,d)=>{i(f,c)}):i(null,c)}),h.once("error",c=>{c&&(this.loadFromUrlError=c),i(c,h)}),this.load(h)};n.resource?i(null,n):s==="model"?this._loadModel(n,l):l(n)}_loadModel(e,t){let s=e.getFileUrl(),i=ve.getExtension(s);if(i===".json"||i===".glb"){let r=ve.getDirectory(s),a=ve.getBasename(s),n=ve.join(r,a.replace(i,".mapping.json"));this._loader.load(n,"json",(l,h)=>{l?(e.data={mapping:[]},t(e)):this._loadMaterials(e,h,(c,f)=>{e.data=h,t(e)})})}else t(e)}_loadMaterials(e,t,s){let i=[],r=0,a=(n,l)=>{this._loadTextures(l,(h,c)=>{i.push(l),i.length===r&&s(null,i)})};for(let n=0;n<t.mapping.length;n++){let l=t.mapping[n].path;if(l){r++;let h=e.getAbsoluteUrl(l);this.loadFromUrl(h,"material",a)}}r===0&&s(null,i)}_loadTextures(e,t){let s=[],i=0,r=e.data;if(r.mappingFormat!=="path"){t(null,s);return}let a=(l,h)=>{l&&console.error(l),s.push(h),s.length===i&&t(null,s)},n=id;for(let l=0;l<n.length;l++){let h=r[n[l]];if(h&&typeof h=="string"){i++;let c=e.getAbsoluteUrl(h);this.loadFromUrl(c,"texture",a)}}i===0&&t(null,s)}_onTagAdd(e,t){this._tags.add(e,t)}_onTagRemove(e,t){this._tags.remove(e,t)}_onNameChange(e,t,s){if(this._nameToAsset.has(s)){let i=this._nameToAsset.get(s);i.delete(e),i.size===0&&this._nameToAsset.delete(s)}this._nameToAsset.has(e.name)||this._nameToAsset.set(e.name,new Set),this._nameToAsset.get(e.name).add(e)}findByTag(...e){return this._tags.find(e)}filter(e){return Array.from(this._assets).filter(t=>e(t))}find(e,t){let s=this._nameToAsset.get(e);if(!s)return null;for(let i of s)if(!t||i.type===t)return i;return null}findAll(e,t){let s=this._nameToAsset.get(e);if(!s)return[];let i=Array.from(s);return t?i.filter(r=>r.type===t):i}}});var Pp,Mb=m(()=>{Pp=class{constructor(e){this._idToBundle=new Map,this._assetToBundles=new Map,this._urlsToBundles=new Map,this._fileRequests=new Map,this._assets=e,this._assets.bundles=this,this._assets.on("add",this._onAssetAdd,this),this._assets.on("remove",this._onAssetRemove,this)}_onAssetAdd(e){if(e.type==="bundle"){this._idToBundle.set(e.id,e),this._assets.on(`load:start:${e.id}`,this._onBundleLoadStart,this),this._assets.on(`load:${e.id}`,this._onBundleLoad,this),this._assets.on(`error:${e.id}`,this._onBundleError,this);let t=e.data.assets;for(let s=0;s<t.length;s++)this._indexAssetInBundle(t[s],e)}else this._assetToBundles.has(e.id)&&this._indexAssetFileUrls(e)}_unbindAssetEvents(e){this._assets.off(`load:start:${e}`,this._onBundleLoadStart,this),this._assets.off(`load:${e}`,this._onBundleLoad,this),this._assets.off(`error:${e}`,this._onBundleError,this)}_indexAssetInBundle(e,t){let s=this._assetToBundles.get(e);s||(s=new Set,this._assetToBundles.set(e,s)),s.add(t);let i=this._assets.get(e);i&&this._indexAssetFileUrls(i)}_indexAssetFileUrls(e){let t=this._getAssetFileUrls(e);if(t)for(let s=0;s<t.length;s++){let i=this._assetToBundles.get(e.id);i&&this._urlsToBundles.set(t[s],i)}}_getAssetFileUrls(e){let t=e.getFileUrl();if(!t)return null;t=t.split("?")[0];let s=[t];if(e.type==="font"){let i=e.data.info.maps.length;for(let r=1;r<i;r++)s.push(t.replace(".png",`${r}.png`))}return s}_onAssetRemove(e){if(e.type==="bundle"){this._idToBundle.delete(e.id),this._unbindAssetEvents(e.id);let t=e.data.assets;for(let s=0;s<t.length;s++){let i=this._assetToBundles.get(t[s]);if(i&&(i.delete(e),i.size===0)){this._assetToBundles.delete(t[s]);for(let[r,a]of this._urlsToBundles)a===i&&this._urlsToBundles.delete(r)}}this._onBundleError(`Bundle ${e.id} was removed`)}else{if(!this._assetToBundles.get(e.id))return;this._assetToBundles.delete(e.id);let s=this._getAssetFileUrls(e);if(!s)return;for(let i=0;i<s.length;i++)this._urlsToBundles.delete(s[i])}}_onBundleLoadStart(e){e.resource.on("add",(t,s)=>{let i=this._fileRequests.get(t);if(i){for(let r=0;r<i.length;r++)i[r](null,s);this._fileRequests.delete(t)}})}_onBundleLoad(e){if(!e.resource){this._onBundleError(`Bundle ${e.id} failed to load`);return}if(this._fileRequests)for(let[t,s]of this._fileRequests){let i=this._urlsToBundles.get(t);if(!i||!i.has(e))continue;let r=decodeURIComponent(t),a,n;if(e.resource.has(r))n=e.resource.get(r);else if(e.resource.loaded)a=`Bundle ${e.id} does not contain URL ${t}`;else continue;for(let l=0;l<s.length;l++)s[l](a,a||n);this._fileRequests.delete(t)}}_onBundleError(e){for(let[t,s]of this._fileRequests)if(!this._findLoadedOrLoadingBundleForUrl(t)){for(let r=0;r<s.length;r++)s[r](e);this._fileRequests.delete(t)}}_findLoadedOrLoadingBundleForUrl(e){let t=this._urlsToBundles.get(e);if(!t)return null;let s=null;for(let i of t){if(i.loaded&&i.resource)return i;i.loading&&(s=i)}return s}listBundlesForAsset(e){let t=this._assetToBundles.get(e.id);return t?Array.from(t):null}list(){return Array.from(this._idToBundle.values())}hasUrl(e){return this._urlsToBundles.has(e)}urlIsLoadedOrLoading(e){return!!this._findLoadedOrLoadingBundleForUrl(e)}loadUrl(e,t){let s=this._findLoadedOrLoadingBundleForUrl(e);if(!s){t(`URL ${e} not found in any bundles`);return}if(s.loaded){let r=decodeURIComponent(e);if(s.resource.has(r)){t(null,s.resource.get(r));return}else if(s.resource.loaded){t(`Bundle ${s.id} does not contain URL ${e}`);return}}let i=this._fileRequests.get(e);i||(i=[],this._fileRequests.set(e,i)),i.push(t)}destroy(){this._assets.off("add",this._onAssetAdd,this),this._assets.off("remove",this._onAssetRemove,this);for(let e of this._idToBundle.keys())this._unbindAssetEvents(e);this._assets=null,this._idToBundle.clear(),this._idToBundle=null,this._assetToBundles.clear(),this._assetToBundles=null,this._urlsToBundles.clear(),this._urlsToBundles=null,this._fileRequests.clear(),this._fileRequests=null}}});var Rp,Db=m(()=>{Pe();Rp=class extends K{constructor(){super(),this.list=[]}add(e){let t=e.id;if(this[t])throw new Error(`ComponentSystem name '${t}' already registered or not allowed`);this[t]=e,this.list.push(e)}remove(e){let t=e.id;if(!this[t])throw new Error(`No ComponentSystem named '${t}' registered`);delete this[t];let s=this.list.indexOf(this[t]);s!==-1&&this.list.splice(s,1)}destroy(){this.off();for(let e=0;e<this.list.length;e++)this.list[e].destroy()}}});var Cp,Ob=m(()=>{Pe();Cp=class extends K{static{this.EVENT_ADD="add"}static{this.EVENT_LOAD="load"}addFile(e,t){this._index.has(e)||(this._index.set(e,t),this.fire("add",e,t))}has(e){return this._index.has(e)}get(e){return this._index.get(e)||null}destroy(){this._index.clear()}set loaded(e){!e||this._loaded||(this._loaded=!0,this.fire("load"))}get loaded(){return this._loaded}constructor(...e){super(...e),this._index=new Map,this._loaded=!1}}});var h0,Ek=m(()=>{Pe();h0=class extends K{constructor(e,t=""){super(),this.headerSize=512,this.paddingSize=512,this.bytesRead=0,this.bytesReceived=0,this.headerRead=!1,this.reader=null,this.data=new Uint8Array(0),this.decoder=null,this.prefix="",this.fileName="",this.fileSize=0,this.fileType="",this.ustarFormat="",this.prefix=t||"",this.reader=e.body.getReader(),this.reader.read().then(s=>{this.pump(s.done,s.value)}).catch(s=>{this.fire("error",s)})}pump(e,t){if(e)return this.fire("done"),null;this.bytesReceived+=t.byteLength;let s=new Uint8Array(this.data.length+t.length);for(s.set(this.data),s.set(t,this.data.length),this.data=s;this.readFile(););return this.reader.read().then(i=>{this.pump(i.done,i.value)}).catch(i=>{this.fire("error",i)})}readFile(){if(!this.headerRead&&this.bytesReceived>this.bytesRead+this.headerSize){this.headerRead=!0;let e=new DataView(this.data.buffer,this.bytesRead,this.headerSize);this.decoder??=new TextDecoder("windows-1252");let t=this.decoder.decode(e);if(this.fileName=t.substring(0,100).replace(/\0/g,""),this.fileSize=parseInt(t.substring(124,136),8),this.fileType=t.substring(156,157),this.ustarFormat=t.substring(257,263),this.ustarFormat.indexOf("ustar")!==-1){let s=t.substring(345,500).replace(/\0/g,"");s.length>0&&(this.fileName=s.trim()+this.fileName.trim())}this.bytesRead+=512}if(this.headerRead){if(this.bytesReceived<this.bytesRead+this.fileSize)return!1;if(this.fileType===""||this.fileType==="0"){let t=new DataView(this.data.buffer,this.bytesRead,this.fileSize),s={name:this.prefix+this.fileName,size:this.fileSize,data:t};this.fire("file",s)}this.bytesRead+=this.fileSize,this.headerRead=!1;let e=this.bytesRead%this.paddingSize;return e!==0&&(this.bytesRead+=this.paddingSize-e),!0}return!1}}});var ye,_t=m(()=>{ye=class{constructor(e,t){this.handlerType="",this._maxRetries=0,this._app=e,this.handlerType=t}set maxRetries(e){this._maxRetries=e}get maxRetries(){return this._maxRetries}load(e,t,s){}open(e,t,s){return t}patch(e,t){}}});var Ip,Nb=m(()=>{Ob();Ek();_t();Ip=class extends ye{constructor(e){super(e,"bundle"),this._assets=e.assets}_fetchRetries(e,t,s=0){return new Promise((i,r)=>{let a=()=>{fetch(e,t).then(i).catch(n=>{s++,s<this.maxRetries?a():r(n)})};a()})}load(e,t){typeof e=="string"&&(e={load:e,original:e}),this._fetchRetries(e.load,{mode:"cors"},this.maxRetries).then(s=>{let i=new Cp;t(null,i);let r=new h0(s,this._assets.prefix);r.on("file",a=>{i.addFile(a.name,a.data)}),r.on("done",()=>{i.loaded=!0}),r.on("error",a=>{t(a)})}).catch(s=>{t(s)})}open(e,t){return t}}});var dc,c0=m(()=>{dc=class o{constructor(e){this._handlers={},this._requests={},this._cache={},this._app=e}addHandler(e,t){this._handlers[e]=t,t._loader=this}removeHandler(e){delete this._handlers[e]}getHandler(e){return this._handlers[e]}static makeKey(e,t){return`${e}-${t}`}load(e,t,s,i,r){let a=this._handlers[t];if(!a){let l=`No resource handler for asset type: '${t}' when loading [${e}]`;s(l);return}if(!e){this._loadNull(a,s,i);return}let n=o.makeKey(e,t);if(this._cache[n]!==void 0)s(null,this._cache[n]);else if(this._requests[n])this._requests[n].push(s);else{this._requests[n]=[s];let l=this,h=function(f,d){if(f){l._onFailure(n,f);return}if(d.load instanceof DataView){if(a.openBinary){if(!l._requests[n])return;try{let u=a.openBinary(d.load);l._onSuccess(n,u)}catch(u){l._onFailure(n,u)}return}d.load=URL.createObjectURL(new Blob([d.load])),i&&(i.urlObject&&URL.revokeObjectURL(i.urlObject),i.urlObject=d.load)}a.load(d,(u,p,_)=>{if(l._requests[n]){if(u){l._onFailure(n,u);return}try{l._onSuccess(n,a.open(d.original,p,i),_)}catch(S){l._onFailure(n,S)}}},i)},c=e.split("?")[0];if(this._app.enableBundles&&this._app.bundles.hasUrl(c)&&!(r&&r.bundlesIgnore)){if(!this._app.bundles.urlIsLoadedOrLoading(c)){let f=this._app.bundles.listBundlesForAsset(i),d;r&&r.bundlesFilter&&(d=r.bundlesFilter(f)),d||(f?.sort((u,p)=>u.file.size-p.file.size),d=f?.[0]),d&&this._app.assets?.load(d)}this._app.bundles.loadUrl(c,(f,d)=>{h(f,{load:d,original:c})})}else h(null,{load:e,original:i&&i.file.filename||e})}}_loadNull(e,t,s){let i=function(r,a,n){if(r)t(r);else try{t(null,e.open(null,a,s),n)}catch(l){t(l)}};e.load(null,i,s)}_onSuccess(e,t,s){t!==null?this._cache[e]=t:delete this._cache[e];for(let i=0;i<this._requests[e].length;i++)this._requests[e][i](null,t,s);delete this._requests[e]}_onFailure(e,t){if(console.error(t),this._requests[e]){for(let s=0;s<this._requests[e].length;s++)this._requests[e][s](t);delete this._requests[e]}}open(e,t){let s=this._handlers[e];return s?s.open(null,t):(console.warn(`No resource handler found for: ${e}`),t)}patch(e,t){let s=this._handlers[e.type];if(!s){console.warn(`No resource handler found for: ${e.type}`);return}s.patch&&s.patch(e,t)}clearCache(e,t){let s=o.makeKey(e,t);delete this._cache[s]}getFromCache(e,t){let s=o.makeKey(e,t);if(this._cache[s])return this._cache[s]}enableRetry(e=5){e=Math.max(0,e)||0;for(let t in this._handlers)this._handlers[t].maxRetries=e}disableRetry(){for(let e in this._handlers)this._handlers[e].maxRetries=0}destroy(){this._handlers={},this._requests={},this._cache={}}}});var f0,vk=m(()=>{f0=class{_validate(e){if(!e.header)throw new Error('pc.I18n#addData: Missing "header" field');if(!e.header.version)throw new Error('pc.I18n#addData: Missing "header.version" field');if(e.header.version!==1)throw new Error('pc.I18n#addData: Invalid "header.version" field');if(e.data){if(!Array.isArray(e.data))throw new Error('pc.I18n#addData: "data" field must be an array')}else throw new Error('pc.I18n#addData: Missing "data" field');for(let t=0,s=e.data.length;t<s;t++){let i=e.data[t];if(!i.info)throw new Error(`pc.I18n#addData: missing "data[${t}].info" field`);if(!i.info.locale)throw new Error(`pc.I18n#addData: missing "data[${t}].info.locale" field`);if(typeof i.info.locale!="string")throw new Error(`pc.I18n#addData: "data[${t}].info.locale" must be a string`);if(!i.messages)throw new Error(`pc.I18n#addData: missing "data[${t}].messages" field`)}}parse(e){return e.data}}});var ba,dT=m(()=>{Pe();rt();wb();bb();vk();ba=class o extends K{static{this.EVENT_CHANGE="change"}constructor(e){super(),this.locale=xp,this._translations={},this._availableLangs={},this._app=e,this._assets=[],this._parser=new f0}set assets(e){let t={};for(let i=0,r=e.length;i<r;i++){let a=e[i]instanceof re?e[i].id:e[i];t[a]=!0}let s=this._assets.length;for(;s--;){let i=this._assets[s];if(!t[i]){this._app.assets.off(`add:${i}`,this._onAssetAdd,this);let r=this._app.assets.get(i);r&&this._onAssetRemove(r),this._assets.splice(s,1)}}for(let i in t){let r=parseInt(i,10);if(this._assets.indexOf(r)!==-1)continue;this._assets.push(r);let a=this._app.assets.get(r);a?this._onAssetAdd(a):this._app.assets.once(`add:${r}`,this._onAssetAdd,this)}}get assets(){return this._assets}set locale(e){if(this._locale===e)return;let t=Eo(e);if(t==="in"&&(t="id",e=tk(e,t),this._locale===e))return;let s=this._locale;this._locale=e,this._lang=t,this._pluralFn=a0(this._lang),this.fire(o.EVENT_CHANGE,e,s)}get locale(){return this._locale}static findAvailableLocale(e,t){return r0(e,t)}findAvailableLocale(e){if(this._translations[e])return e;let t=Eo(e);return this._findFallbackLocale(e,t)}getText(e,t){let s=e,i;t||(t=this._locale,i=this._lang);let r=this._translations[t];return r||(i||(i=Eo(t)),t=this._findFallbackLocale(t,i),r=this._translations[t]),r&&r.hasOwnProperty(e)&&(s=r[e],Array.isArray(s)&&(s=s[0]),s==null&&(s=e)),s}getPluralText(e,t,s){let i=e,r,a;s?(r=Eo(s),a=a0(r)):(s=this._locale,r=this._lang,a=this._pluralFn);let n=this._translations[s];if(n||(s=this._findFallbackLocale(s,r),r=Eo(s),a=a0(r),n=this._translations[s]),n&&n[e]&&a){let l=a(t);i=n[e][l],i==null&&(i=e)}return i}addData(e){let t;try{t=this._parser.parse(e)}catch(s){console.error(s);return}for(let s=0,i=t.length;s<i;s++){let r=t[s],a=r.info.locale,n=r.messages;if(!this._translations[a]){this._translations[a]={};let l=Eo(a);this._availableLangs[l]||(this._availableLangs[l]=a)}Object.assign(this._translations[a],n),this.fire("data:add",a,n)}}removeData(e){let t;try{t=this._parser.parse(e)}catch(s){console.error(s);return}for(let s=0,i=t.length;s<i;s++){let r=t[s],a=r.info.locale,n=this._translations[a];if(!n)continue;let l=r.messages;for(let h in l)delete n[h];Object.keys(n).length===0&&(delete this._translations[a],delete this._availableLangs[Eo(a)]),this.fire("data:remove",a,l)}}destroy(){this._translations=null,this._availableLangs=null,this._assets=null,this._parser=null,this.off()}_findFallbackLocale(e,t){let s=yp[e];return s&&this._translations[s]||(s=yp[t],s&&this._translations[s])||(s=this._availableLangs[t],s&&this._translations[s])?s:xp}_onAssetAdd(e){e.on("load",this._onAssetLoad,this),e.on("change",this._onAssetChange,this),e.on("remove",this._onAssetRemove,this),e.on("unload",this._onAssetUnload,this),e.resource&&this._onAssetLoad(e)}_onAssetLoad(e){this.addData(e.resource)}_onAssetChange(e){e.resource&&this.addData(e.resource)}_onAssetRemove(e){e.off("load",this._onAssetLoad,this),e.off("change",this._onAssetChange,this),e.off("remove",this._onAssetRemove,this),e.off("unload",this._onAssetUnload,this),e.resource&&this.removeData(e.resource),this._app.assets.once(`add:${e.id}`,this._onAssetAdd,this)}_onAssetUnload(e){e.resource&&this.removeData(e.resource)}}});var wp,Fb=m(()=>{Pe();wp=class extends K{constructor(e){super(),this._scripts={},this._list=[],this._scriptSchemas=new Map,this.app=e}destroy(){this.app=null,this.off()}addSchema(e,t){t&&this._scriptSchemas.set(e,t)}getSchema(e){return this._scriptSchemas.get(e)}add(e){let t=e.__name;return this._scripts.hasOwnProperty(t)?(setTimeout(()=>{if(e.prototype.swap){let s=this._scripts[t],i=this._list.indexOf(s);this._list[i]=e,this._scripts[t]=e,this.fire("swap",t,e),this.fire(`swap:${t}`,e)}else console.warn(`script registry already has '${t}' script, define 'swap' method for new script type to enable code hot swapping`)}),!1):(this._scripts[t]=e,this._list.push(e),this.fire("add",t,e),this.fire(`add:${t}`,e),setTimeout(()=>{if(!this._scripts.hasOwnProperty(t)||!this.app||!this.app.systems||!this.app.systems.script)return;let s=this.app.systems.script._components,i,r=[],a=[];for(s.loopIndex=0;s.loopIndex<s.length;s.loopIndex++){let n=s.items[s.loopIndex];if(n._scriptsIndex[t]&&n._scriptsIndex[t].awaiting){n._scriptsData&&n._scriptsData[t]&&(i=n._scriptsData[t].attributes);let l=n.create(t,{preloading:!0,ind:n._scriptsIndex[t].ind,attributes:i});l&&r.push(l);for(let h of n.scripts)n.initializeAttributes(h)}}for(let n=0;n<r.length;n++)r[n].enabled&&(r[n]._initialized=!0,a.push(r[n]),r[n].initialize&&r[n].initialize());for(let n=0;n<a.length;n++)!a[n].enabled||a[n]._postInitialized||(a[n]._postInitialized=!0,a[n].postInitialize&&a[n].postInitialize())}),!0)}remove(e){let t=e,s=e;if(typeof s!="string"?s=t.__name:t=this.get(s),this.get(s)!==t)return!1;delete this._scripts[s];let i=this._list.indexOf(t);return this._list.splice(i,1),this.fire("remove",s,t),this.fire(`remove:${s}`,t),!0}get(e){return this._scripts[e]||null}has(e){if(typeof e=="string")return this._scripts.hasOwnProperty(e);if(!e)return!1;let t=e.__name;return this._scripts[t]===e}list(){return this._list}}});function Ak(o,e,t,s){if(e instanceof be){let i=e.c;for(let n in i){let l=i[n],h=l.system.getPropertiesOfType("entity");for(let c=0,f=h.length;c<f;c++){let u=h[c].name,p=l[u];if(!!o.findByGuid(p)){let S=s[p].getGuid();S&&(t.c[n][u]=S)}}}i.script&&t.script.resolveDuplicatedEntityReferenceProperties(i.script,s),i.render&&t.render.resolveDuplicatedEntityReferenceProperties(i.render,s),i.button&&t.button.resolveDuplicatedEntityReferenceProperties(i.button,s),i.scrollview&&t.scrollview.resolveDuplicatedEntityReferenceProperties(i.scrollview,s),i.scrollbar&&t.scrollbar.resolveDuplicatedEntityReferenceProperties(i.scrollbar,s),i.anim&&t.anim.resolveDuplicatedEntityReferenceProperties(i.anim,s);let r=e.children.filter(n=>n instanceof be),a=t.children.filter(n=>n instanceof be);for(let n=0,l=r.length;n<l;n++)Ak(o,r[n],a[n],s)}}var Yne,Kne,uT,yk,qne,xk,be,ci=m(()=>{WC();Zt();hc();Yne=(o,e)=>o.constructor.order-e.constructor.order,Kne=o=>o.sort(Yne),uT=[],yk=[],qne=()=>yk.pop()??[],xk=o=>{o.length=0,yk.push(o)},be=class o extends Ae{static{this.EVENT_DESTROY="destroy"}constructor(e,t=Ss()){super(e),this.c={},this._destroying=!1,this._guid=null,this._template=!1,this._app=t}addComponent(e,t){let s=this._app.systems[e];return!s||this.c[e]?null:s.addComponent(this,t)}removeComponent(e){let t=this._app.systems[e];t&&this.c[e]&&t.removeComponent(this)}findComponent(e){let t=this.findOne(s=>s.c?.[e]);return t&&t.c[e]}findComponents(e){return this.find(t=>t.c?.[e]).map(t=>t.c[e])}findScript(e){return this.findOne(s=>s.c?.script?.has(e))?.c.script.get(e)}findScripts(e){return this.find(s=>s.c?.script?.has(e)).map(s=>s.c.script.get(e))}getGuid(){return this._guid||this.setGuid(PE.create()),this._guid}setGuid(e){let t=this._app._entityIndex;this._guid&&delete t[this._guid],this._guid=e,t[this._guid]=this}_notifyHierarchyStateChanged(e,t){let s=!1;e===this&&uT.length===0&&(s=!0),e._beingEnabled=!0,e._onHierarchyStateChanged(t),e._onHierarchyStatePostChanged&&uT.push(e);let i=e._children;for(let r=0,a=i.length;r<a;r++)i[r]._enabled&&this._notifyHierarchyStateChanged(i[r],t);if(e._beingEnabled=!1,s){for(let r=0;r<uT.length;r++)uT[r]._onHierarchyStatePostChanged();uT.length=0}}_onHierarchyStateChanged(e){super._onHierarchyStateChanged(e);let t=this._getSortedComponents();for(let s=0;s<t.length;s++){let i=t[s];i.enabled&&(e?i.onEnable():i.onDisable())}xk(t)}_onHierarchyStatePostChanged(){let e=this._getSortedComponents();for(let t=0;t<e.length;t++)e[t].onPostStateChange();xk(e)}findByGuid(e){if(this._guid===e)return this;let t=this._app._entityIndex[e];return t&&(t===this||t.isDescendantOf(this))?t:null}destroy(){this._destroying=!0;for(let e in this.c)this.c[e].enabled=!1;for(let e in this.c)this.c[e].system.removeComponent(this);super.destroy(),this._guid&&delete this._app._entityIndex[this._guid],this._destroying=!1}clone(){let e={},t=this._cloneRecursively(e);return e[this.getGuid()]=t,Ak(this,this,t,e),t}_getSortedComponents(){let e=this.c,t=qne(),s=0;for(let i in e)if(e.hasOwnProperty(i)){let r=e[i];s|=r.constructor.order!==0,t.push(r)}return s&&t.length>1&&Kne(t),t}_cloneRecursively(e){let t=new this.constructor(void 0,this._app);super._cloneInternal(t);for(let s in this.c)this.c[s].system.cloneComponent(this,t);for(let s=0;s<this._children.length;s++){let i=this._children[s];if(i instanceof o){let r=i._cloneRecursively(e);t.addChild(r),e[i.getGuid()]=r}}return t}}});var nd,Ub=m(()=>{nd=class{constructor(e,t){this.data=null,this._loading=!1,this._onLoadedCallbacks=[],this.name=e,this.url=t}get loaded(){return!!this.data}get loading(){return this._loading}}});var Lp,Bb=m(()=>{Fs();Ap();Ub();Lp=class{constructor(e){this._list=[],this._index={},this._urlIndex={},this._app=e}destroy(){this._app=null}list(){return this._list}add(e,t){if(this._index.hasOwnProperty(e))return!1;let s=new nd(e,t),i=this._list.push(s);return this._index[s.name]=i-1,this._urlIndex[s.url]=i-1,!0}find(e){return this._index.hasOwnProperty(e)?this._list[this._index[e]]:null}findByUrl(e){return this._urlIndex.hasOwnProperty(e)?this._list[this._urlIndex[e]]:null}remove(e){if(this._index.hasOwnProperty(e)){let t=this._index[e],s=this._list[t];delete this._urlIndex[s.url],delete this._index[e],this._list.splice(t,1);for(let i=0;i<this._list.length;i++)s=this._list[i],this._index[s.name]=i,this._urlIndex[s.url]=i}}_loadSceneData(e,t,s){let i=this._app,r=e;if(typeof e=="string"&&(e=this.findByUrl(r)||this.find(r)||new nd("Untitled",r)),r=e.url,!r){s("Cannot find scene to load");return}if(e.loaded){s(null,e);return}i.assets&&i.assets.prefix&&!La.test(r)&&(r=ve.join(i.assets.prefix,r)),e._onLoadedCallbacks.push(s),e._loading||i.loader.getHandler("hierarchy").load(r,(n,l)=>{e.data=l,e._loading=!1;for(let h=0;h<e._onLoadedCallbacks.length;h++)e._onLoadedCallbacks[h](n,e);t||(e.data=null),e._onLoadedCallbacks.length=0}),e._loading=!0}loadSceneData(e,t){this._loadSceneData(e,!0,t)}unloadSceneData(e){typeof e=="string"&&(e=this.findByUrl(e)),e&&(e.data=null)}_loadSceneHierarchy(e,t,s){this._loadSceneData(e,!1,(i,r)=>{if(i){s&&s(i);return}t&&t(r);let a=this._app,n=()=>{let l=a.loader.getHandler("hierarchy");a.systems.script.preloading=!0;let h=l.open(r.url,r.data);a.systems.script.preloading=!1,a.loader.clearCache(r.url,"hierarchy"),a.root.addChild(h),a.systems.fire("initialize",h),a.systems.fire("postInitialize",h),a.systems.fire("postPostInitialize",h),s&&s(null,h)};a._preloadScripts(r.data,n)})}loadSceneHierarchy(e,t){this._loadSceneHierarchy(e,null,t)}loadSceneSettings(e,t){this._loadSceneData(e,!1,(s,i)=>{s?t&&t(s):(this._app.applySceneSettings(i.data.settings),t&&t(null))})}changeScene(e,t){let s=this._app,i=r=>{let{children:a}=s.root;for(;a.length;)a[0].destroy();s.applySceneSettings(r.data.settings)};this._loadSceneHierarchy(e,i,t)}loadScene(e,t){let s=this._app,i=s.loader.getHandler("scene");s.assets&&s.assets.prefix&&!La.test(e)&&(e=ve.join(s.assets.prefix,e)),i.load(e,(r,a)=>{if(r)t&&t(r);else{let n=()=>{s.systems.script.preloading=!0;let l=i.open(e,a),h=this.findByUrl(e);h&&!h.loaded&&(h.data=a),s.systems.script.preloading=!1,s.loader.clearCache(e,"scene"),s.loader.patch({resource:l,type:"scene"},s.assets),s.root.addChild(l.root),s.systems.rigidbody&&typeof Ammo<"u"&&s.systems.rigidbody.gravity.set(l._gravity.x,l._gravity.y,l._gravity.z),t&&t(null,l)};s._preloadScripts(a,n)}})}}});var d0,Pk=m(()=>{hc();d0=class{constructor(e){this.frame={fps:0,ms:0,dt:0,updateStart:0,updateTime:0,renderStart:0,renderTime:0,physicsStart:0,physicsTime:0,cullTime:0,sortTime:0,skinTime:0,morphTime:0,instancingTime:0,triangles:0,otherPrimitives:0,shaders:0,materials:0,cameras:0,shadowMapUpdates:0,shadowMapTime:0,depthMapTime:0,forwardTime:0,lightClustersTime:0,lightClusters:0,_timeToCountFrames:0,_fpsAccum:0},this.drawCalls={forward:0,depth:0,shadow:0,immediate:0,misc:0,total:0,skinned:0,instanced:0,removedByInstancing:0},this.misc={renderTargetCreationTime:0},this.particles={updatesPerFrame:0,_updatesPerFrame:0,frameTime:0,_frameTime:0},this.shaders=e._shaderStats,this.vram=e._vram,Object.defineProperty(this.vram,"totalUsed",{get:function(){return this.tex+this.vb+this.ib}}),Object.defineProperty(this.vram,"geom",{get:function(){return this.vb+this.ib}})}get scene(){return Ss().scene._stats}get lightmapper(){return Ss().lightmapper?.stats}get batcher(){let e=Ss()._batcher;return e?e._stats:null}}});var Rk,Ck=m(()=>{Rk=`
uniform float alpha_ref;
void alphaTest(float a) {
	if (a < alpha_ref) discard;
}
`});var Ik,wk=m(()=>{Ik=`
#ifdef LIT_AMBIENT_SOURCE == AMBIENTSH
	uniform vec3 ambientSH[9];
#endif
#if LIT_AMBIENT_SOURCE == ENVALATLAS
	#include "envAtlasPS"
	#ifndef ENV_ATLAS
	#define ENV_ATLAS
		uniform sampler2D texture_envAtlas;
	#endif
#endif
void addAmbient(vec3 worldNormal) {
	#ifdef LIT_AMBIENT_SOURCE == AMBIENTSH
		vec3 n = cubeMapRotate(worldNormal);
		vec3 color =
			ambientSH[0] +
			ambientSH[1] * n.x +
			ambientSH[2] * n.y +
			ambientSH[3] * n.z +
			ambientSH[4] * n.x * n.z +
			ambientSH[5] * n.z * n.y +
			ambientSH[6] * n.y * n.x +
			ambientSH[7] * (3.0 * n.z * n.z - 1.0) +
			ambientSH[8] * (n.x * n.x - n.y * n.y);
		dDiffuseLight += processEnvironment(max(color, vec3(0.0)));
	#endif
	#if LIT_AMBIENT_SOURCE == ENVALATLAS
		vec3 dir = normalize(cubeMapRotate(worldNormal) * vec3(-1.0, 1.0, 1.0));
		vec2 uv = mapUv(toSphericalUv(dir), vec4(128.0, 256.0 + 128.0, 64.0, 32.0) / atlasSize);
		vec4 raw = texture2D(texture_envAtlas, uv);
		vec3 linear = {ambientDecode}(raw);
		dDiffuseLight += processEnvironment(linear);
	#endif
	#if LIT_AMBIENT_SOURCE == CONSTANT
		dDiffuseLight += light_globalAmbient;
	#endif
}
`});var Lk,bk=m(()=>{Lk=`
#ifdef LIT_GGX_SPECULAR
	uniform float material_anisotropyIntensity;
	uniform vec2 material_anisotropyRotation;
#endif
void getAnisotropy() {
	dAnisotropy = 0.0;
	dAnisotropyRotation = vec2(1.0, 0.0);
#ifdef LIT_GGX_SPECULAR
	dAnisotropy = material_anisotropyIntensity;
	dAnisotropyRotation = material_anisotropyRotation;
#endif
	#ifdef STD_ANISOTROPY_TEXTURE
	vec3 anisotropyTex = texture2DBias({STD_ANISOTROPY_TEXTURE_NAME}, {STD_ANISOTROPY_TEXTURE_UV}, textureBias).rgb;
	dAnisotropy *= anisotropyTex.b;
	vec2 anisotropyRotationFromTex = anisotropyTex.rg * 2.0 - vec2(1.0);
	mat2 rotationMatrix = mat2(dAnisotropyRotation.x, dAnisotropyRotation.y, -dAnisotropyRotation.y, dAnisotropyRotation.x);
	dAnisotropyRotation = rotationMatrix * anisotropyRotationFromTex;
	#endif
	
	dAnisotropy = clamp(dAnisotropy, 0.0, 1.0);
}
`});var Mk,Dk=m(()=>{Mk=`
#if defined(STD_AO_TEXTURE) || defined(STD_AO_VERTEX)
	uniform float material_aoIntensity;
#endif
#ifdef STD_AODETAIL_TEXTURE
	#include "detailModesPS"
#endif
void getAO() {
	dAo = 1.0;
	#ifdef STD_AO_TEXTURE
		float aoBase = texture2DBias({STD_AO_TEXTURE_NAME}, {STD_AO_TEXTURE_UV}, textureBias).{STD_AO_TEXTURE_CHANNEL};
		#ifdef STD_AODETAIL_TEXTURE
			float aoDetail = texture2DBias({STD_AODETAIL_TEXTURE_NAME}, {STD_AODETAIL_TEXTURE_UV}, textureBias).{STD_AODETAIL_TEXTURE_CHANNEL};
			aoBase = detailMode_{STD_AODETAIL_DETAILMODE}(vec3(aoBase), vec3(aoDetail)).r;
		#endif
		dAo *= aoBase;
	#endif
	#ifdef STD_AO_VERTEX
		dAo *= saturate(vVertexColor.{STD_AO_VERTEX_CHANNEL});
	#endif
	#if defined(STD_AO_TEXTURE) || defined(STD_AO_VERTEX)
		dAo = mix(1.0, dAo, material_aoIntensity);
	#endif
}
`});var Ok,Nk=m(()=>{Ok=`
void occludeDiffuse(float ao) {
	dDiffuseLight *= ao;
}
`});var Fk,Uk=m(()=>{Fk=`
#if LIT_OCCLUDE_SPECULAR != NONE
	#ifdef LIT_OCCLUDE_SPECULAR_FLOAT
		uniform float material_occludeSpecularIntensity;
	#endif
#endif
void occludeSpecular(float gloss, float ao, vec3 worldNormal, vec3 viewDir) {
	#if LIT_OCCLUDE_SPECULAR == AO
		#ifdef LIT_OCCLUDE_SPECULAR_FLOAT
			float specOcc = mix(1.0, ao, material_occludeSpecularIntensity);
		#else
			float specOcc = ao;
		#endif
	#endif
	#if LIT_OCCLUDE_SPECULAR == GLOSSDEPENDENT
		float specPow = exp2(gloss * 11.0);
		float specOcc = saturate(pow(dot(worldNormal, viewDir) + ao, 0.01 * specPow) - 1.0 + ao);
		#ifdef LIT_OCCLUDE_SPECULAR_FLOAT
			specOcc = mix(1.0, specOcc, material_occludeSpecularIntensity);
		#endif
	#endif
	#if LIT_OCCLUDE_SPECULAR != NONE
		dSpecularLight *= specOcc;
		dReflection *= specOcc;
		#ifdef LIT_SHEEN
			sSpecularLight *= specOcc;
			sReflection *= specOcc;
		#endif
	#endif
}
`});var Bk,Vk=m(()=>{Bk=`
	vec4 dirLm = texture2D(texture_dirLightMap, vUv1);
	if (bakeDir > 0.5) {
		if (dAtten > 0.00001) {
			dirLm.xyz = dirLm.xyz * 2.0 - vec3(1.0);
			dAtten = saturate(dAtten);
			gl_FragColor.rgb = normalize(dLightDirNormW.xyz*dAtten + dirLm.xyz*dirLm.w) * 0.5 + vec3(0.5);
			gl_FragColor.a = dirLm.w + dAtten;
			gl_FragColor.a = max(gl_FragColor.a, 1.0 / 255.0);
		} else {
			gl_FragColor = dirLm;
		}
	} else {
		gl_FragColor.rgb = dirLm.xyz;
		gl_FragColor.a = max(dirLm.w, dAtten > 0.00001 ? (1.0/255.0) : 0.0);
	}
`});var kk,Gk=m(()=>{kk=`
#ifdef LIT_LIGHTMAP_BAKING_ADD_AMBIENT
	dDiffuseLight = ((dDiffuseLight - 0.5) * max(ambientBakeOcclusionContrast + 1.0, 0.0)) + 0.5;
	dDiffuseLight += vec3(ambientBakeOcclusionBrightness);
	dDiffuseLight = saturate(dDiffuseLight);
	dDiffuseLight *= dAmbientLight;
#endif
#ifdef LIGHTMAP_RGBM
	gl_FragColor.rgb = dDiffuseLight;
	gl_FragColor.rgb = pow(gl_FragColor.rgb, vec3(0.5));
	gl_FragColor.rgb /= 8.0;
	gl_FragColor.a = clamp( max( max( gl_FragColor.r, gl_FragColor.g ), max( gl_FragColor.b, 1.0 / 255.0 ) ), 0.0,1.0 );
	gl_FragColor.a = ceil(gl_FragColor.a * 255.0) / 255.0;
	gl_FragColor.rgb /= gl_FragColor.a;
#else
	gl_FragColor = vec4(dDiffuseLight, 1.0);
#endif
`});var zk,Hk=m(()=>{zk=`
uniform vec3 view_position;
uniform vec3 light_globalAmbient;
float square(float x) {
	return x*x;
}
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
vec3 saturate(vec3 x) {
	return clamp(x, vec3(0.0), vec3(1.0));
}
`});var Xk,Wk=m(()=>{Xk=`
#define NINESLICED
varying vec2 vMask;
varying vec2 vTiledUv;
uniform mediump vec4 innerOffset;
uniform mediump vec2 outerScale;
uniform mediump vec4 atlasRect;
vec2 nineSlicedUv;
`});var Yk,Kk=m(()=>{Yk=`
#define NINESLICED
#define NINESLICETILED
varying vec2 vMask;
varying vec2 vTiledUv;
uniform mediump vec4 innerOffset;
uniform mediump vec2 outerScale;
uniform mediump vec4 atlasRect;
vec2 nineSlicedUv;
`});var qk,jk=m(()=>{qk=`
float bayer2(vec2 p) {
	return mod(2.0 * p.y + p.x + 1.0, 4.0);
}
float bayer4(vec2 p) {
	vec2 p1 = mod(p, 2.0);
	vec2 p2 = floor(0.5 * mod(p, 4.0));
	return 4.0 * bayer2(p1) + bayer2(p2);
}
float bayer8(vec2 p) {
	vec2 p1 = mod(p, 2.0);
	vec2 p2 = floor(0.5 * mod(p, 4.0));
	vec2 p4 = floor(0.25 * mod(p, 8.0));
	return 4.0 * (4.0 * bayer2(p1) + bayer2(p2)) + bayer2(p4);
}
`});var $k,Zk=m(()=>{$k=`
varying vec2 vUv0;
uniform sampler2D source;
uniform vec2 pixelOffset;
#ifdef GAUSS
	uniform float weight[{SAMPLES}];
#endif
void main(void) {
	vec3 moments = vec3(0.0);
	vec2 uv = vUv0 - pixelOffset * (float({SAMPLES}) * 0.5);
	for (int i = 0; i < {SAMPLES}; i++) {
		vec4 c = texture2D(source, uv + pixelOffset * float(i));
		#ifdef GAUSS
			moments += c.xyz * weight[i];
		#else
			moments += c.xyz;
		#endif
	}
	#ifndef GAUSS
		moments *= 1.0 / float({SAMPLES});
	#endif
	gl_FragColor = vec4(moments.x, moments.y, moments.z, 1.0);
}
`});var Qk,Jk=m(()=>{Qk=`
uniform float material_clearCoat;
void getClearCoat() {
	ccSpecularity = material_clearCoat;
	#ifdef STD_CLEARCOAT_TEXTURE
	ccSpecularity *= texture2DBias({STD_CLEARCOAT_TEXTURE_NAME}, {STD_CLEARCOAT_TEXTURE_UV}, textureBias).{STD_CLEARCOAT_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_CLEARCOAT_VERTEX
	ccSpecularity *= saturate(vVertexColor.{STD_CLEARCOAT_VERTEX_CHANNEL});
	#endif
}
`});var eG,tG=m(()=>{eG=`
uniform float material_clearCoatGloss;
void getClearCoatGlossiness() {
	ccGlossiness = material_clearCoatGloss;
	#ifdef STD_CLEARCOATGLOSS_TEXTURE
	ccGlossiness *= texture2DBias({STD_CLEARCOATGLOSS_TEXTURE_NAME}, {STD_CLEARCOATGLOSS_TEXTURE_UV}, textureBias).{STD_CLEARCOATGLOSS_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_CLEARCOATGLOSS_VERTEX
	ccGlossiness *= saturate(vVertexColor.{STD_CLEARCOATGLOSS_VERTEX_CHANNEL});
	#endif
	#ifdef STD_CLEARCOATGLOSS_INVERT
	ccGlossiness = 1.0 - ccGlossiness;
	#endif
	ccGlossiness += 0.0000001;
}
`});var sG,iG=m(()=>{sG=`
#ifdef STD_CLEARCOATNORMAL_TEXTURE
uniform float material_clearCoatBumpiness;
#endif
void getClearCoatNormal() {
#ifdef STD_CLEARCOATNORMAL_TEXTURE
	vec3 normalMap = {STD_CLEARCOATNORMAL_TEXTURE_DECODE}(texture2DBias({STD_CLEARCOATNORMAL_TEXTURE_NAME}, {STD_CLEARCOATNORMAL_TEXTURE_UV}, textureBias));
	normalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_clearCoatBumpiness);
	ccNormalW = normalize(dTBN * normalMap);
#else
	ccNormalW = dVertexNormalW;
#endif
}
`});var rG,aG=m(()=>{rG=`
vec2 getCubemapFaceCoordinates(const vec3 dir, out float faceIndex, out vec2 tileOffset)
{
	vec3 vAbs = abs(dir);
	float ma;
	vec2 uv;
	if (vAbs.z >= vAbs.x && vAbs.z >= vAbs.y) {
		faceIndex = dir.z < 0.0 ? 5.0 : 4.0;
		ma = 0.5 / vAbs.z;
		uv = vec2(dir.z < 0.0 ? -dir.x : dir.x, -dir.y);
		tileOffset.x = 2.0;
		tileOffset.y = dir.z < 0.0 ? 1.0 : 0.0;
	} else if(vAbs.y >= vAbs.x) {
		faceIndex = dir.y < 0.0 ? 3.0 : 2.0;
		ma = 0.5 / vAbs.y;
		uv = vec2(dir.x, dir.y < 0.0 ? -dir.z : dir.z);
		tileOffset.x = 1.0;
		tileOffset.y = dir.y < 0.0 ? 1.0 : 0.0;
	} else {
		faceIndex = dir.x < 0.0 ? 1.0 : 0.0;
		ma = 0.5 / vAbs.x;
		uv = vec2(dir.x < 0.0 ? dir.z : -dir.z, -dir.y);
		tileOffset.x = 0.0;
		tileOffset.y = dir.x < 0.0 ? 1.0 : 0.0;
	}
	return uv * ma + 0.5;
}
vec2 getCubemapAtlasCoordinates(const vec3 omniAtlasViewport, float shadowEdgePixels, float shadowTextureResolution, const vec3 dir) {
	float faceIndex;
	vec2 tileOffset;
	vec2 uv = getCubemapFaceCoordinates(dir, faceIndex, tileOffset);
	float atlasFaceSize = omniAtlasViewport.z;
	float tileSize = shadowTextureResolution * atlasFaceSize;
	float offset = shadowEdgePixels / tileSize;
	uv = uv * vec2(1.0 - offset * 2.0) + vec2(offset * 1.0);
	uv *= atlasFaceSize;
	uv += tileOffset * atlasFaceSize;
	uv += omniAtlasViewport.xy;
	return uv;
}
`});var nG,oG=m(()=>{nG=`
vec3 _getCookieClustered(TEXTURE_ACCEPT(tex), vec2 uv, float intensity, vec4 cookieChannel) {
	vec4 pixel = mix(vec4(1.0), texture2DLod(tex, uv, 0.0), intensity);
	bool isRgb = dot(cookieChannel.rgb, vec3(1.0)) == 3.0;
	return isRgb ? pixel.rgb : vec3(dot(pixel, cookieChannel));
}
vec3 getCookie2DClustered(TEXTURE_ACCEPT(tex), mat4 transform, vec3 worldPosition, float intensity, vec4 cookieChannel) {
	vec4 projPos = transform * vec4(worldPosition, 1.0);
	return _getCookieClustered(TEXTURE_PASS(tex), projPos.xy / projPos.w, intensity, cookieChannel);
}
vec3 getCookieCubeClustered(TEXTURE_ACCEPT(tex), vec3 dir, float intensity, vec4 cookieChannel, float shadowTextureResolution, float shadowEdgePixels, vec3 omniAtlasViewport) {
	vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);
	return _getCookieClustered(TEXTURE_PASS(tex), uv, intensity, cookieChannel);
}
`});var lG,hG=m(()=>{lG=`
vec3 _getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {
	vec4 projPos = shadowMatrix * vec4(wPos, 1.0);
	projPos.xyz /= projPos.w;
	return projPos.xyz;
}
vec3 getShadowCoordPerspZbufferNormalOffset(mat4 shadowMatrix, vec4 shadowParams, vec3 normal) {
	vec3 wPos = vPositionW + normal * shadowParams.y;
	return _getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);
}
vec3 normalOffsetPointShadow(vec4 shadowParams, vec3 lightPos, vec3 lightDir, vec3 lightDirNorm, vec3 normal) {
	float distScale = length(lightDir);
	vec3 wPos = vPositionW + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;
	vec3 dir = wPos - lightPos;
	return dir;
}
#if defined(CLUSTER_SHADOW_TYPE_PCF1)
float getShadowOmniClusteredPCF1(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {
	float shadowTextureResolution = shadowParams.x;
	vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);
	float shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;
	return textureShadow(shadowMap, vec3(uv, shadowZ));
}
#endif
#if defined(CLUSTER_SHADOW_TYPE_PCF3)
float getShadowOmniClusteredPCF3(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {
	float shadowTextureResolution = shadowParams.x;
	vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);
	float shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;
	vec3 shadowCoord = vec3(uv, shadowZ);
	return getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);
}
#endif
#if defined(CLUSTER_SHADOW_TYPE_PCF5)
float getShadowOmniClusteredPCF5(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {
	float shadowTextureResolution = shadowParams.x;
	vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);
	float shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;
	vec3 shadowCoord = vec3(uv, shadowZ);
	return getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);
}
#endif
#if defined(CLUSTER_SHADOW_TYPE_PCF1)
float getShadowSpotClusteredPCF1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return textureShadow(shadowMap, shadowCoord);
}
#endif
#if defined(CLUSTER_SHADOW_TYPE_PCF3)
float getShadowSpotClusteredPCF3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return getShadowSpotPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);
}
#endif
#if defined(CLUSTER_SHADOW_TYPE_PCF5)
float getShadowSpotClusteredPCF5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);
}
#endif
`});var cG,fG=m(()=>{cG=`
#include "lightBufferDefinesPS"
#include "clusteredLightUtilsPS"
#ifdef CLUSTER_COOKIES
	#include "clusteredLightCookiesPS"
#endif
#ifdef CLUSTER_SHADOWS
	#include "clusteredLightShadowsPS"
#endif
uniform highp sampler2D clusterWorldTexture;
uniform highp sampler2D lightsTexture;
#ifdef CLUSTER_SHADOWS
	uniform sampler2DShadow shadowAtlasTexture;
#endif
#ifdef CLUSTER_COOKIES
	uniform sampler2D cookieAtlasTexture;
#endif
uniform int clusterMaxCells;
uniform float clusterSkip;
uniform vec3 clusterCellsCountByBoundsSize;
uniform vec3 clusterTextureSize;
uniform vec3 clusterBoundsMin;
uniform vec3 clusterBoundsDelta;
uniform vec3 clusterCellsDot;
uniform vec3 clusterCellsMax;
uniform vec2 shadowAtlasParams;
struct ClusterLightData {
	uint flags;
	vec3 halfWidth;
	bool isSpot;
	vec3 halfHeight;
	int lightIndex;
	vec3 position;
	uint shape;
	vec3 direction;
	bool falloffModeLinear;
	vec3 color;
	float shadowIntensity;
	vec3 omniAtlasViewport;
	float range;
	vec4 cookieChannelMask;
	float biasesData;
	float shadowBias;
	float shadowNormalBias;
	float anglesData;
	float innerConeAngleCos;
	float outerConeAngleCos;
	float cookieIntensity;
	bool isDynamic;
	bool isLightmapped;
};
mat4 lightProjectionMatrix;
vec4 sampleLightTextureF(const ClusterLightData clusterLightData, int index) {
	return texelFetch(lightsTexture, ivec2(index, clusterLightData.lightIndex), 0);
}
void decodeClusterLightCore(inout ClusterLightData clusterLightData, float lightIndex) {
	clusterLightData.lightIndex = int(lightIndex);
	vec4 halfData = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_COLOR_ANGLES_BIAS});
	clusterLightData.anglesData = halfData.z;
	clusterLightData.biasesData = halfData.w;
	vec2 colorRG = unpackHalf2x16(floatBitsToUint(halfData.x));
	vec2 colorB_ = unpackHalf2x16(floatBitsToUint(halfData.y));
	clusterLightData.color = vec3(colorRG, colorB_.x) * {LIGHT_COLOR_DIVIDER};
	vec4 lightPosRange = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_POSITION_RANGE});
	clusterLightData.position = lightPosRange.xyz;
	clusterLightData.range = lightPosRange.w;
	vec4 lightDir_Flags = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_DIRECTION_FLAGS});
	clusterLightData.direction = lightDir_Flags.xyz;
	clusterLightData.flags = floatBitsToUint(lightDir_Flags.w);
	clusterLightData.isSpot = (clusterLightData.flags & (1u << 30u)) != 0u;
	clusterLightData.shape = (clusterLightData.flags >> 28u) & 0x3u;
	clusterLightData.falloffModeLinear = (clusterLightData.flags & (1u << 27u)) == 0u;
	clusterLightData.shadowIntensity = float((clusterLightData.flags >> 0u) & 0xFFu) / 255.0;
	clusterLightData.cookieIntensity = float((clusterLightData.flags >> 8u) & 0xFFu) / 255.0;
	clusterLightData.isDynamic = (clusterLightData.flags & (1u << 22u)) != 0u;
	clusterLightData.isLightmapped = (clusterLightData.flags & (1u << 21u)) != 0u;
}
void decodeClusterLightSpot(inout ClusterLightData clusterLightData) {
	vec2 angles = unpackHalf2x16(floatBitsToUint(clusterLightData.anglesData));
	clusterLightData.innerConeAngleCos = angles.x;
	clusterLightData.outerConeAngleCos = angles.y;
}
void decodeClusterLightOmniAtlasViewport(inout ClusterLightData clusterLightData) {
	clusterLightData.omniAtlasViewport = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_PROJ_MAT_0}).xyz;
}
void decodeClusterLightAreaData(inout ClusterLightData clusterLightData) {
	clusterLightData.halfWidth = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_AREA_DATA_WIDTH}).xyz;
	clusterLightData.halfHeight = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_AREA_DATA_HEIGHT}).xyz;
}
void decodeClusterLightProjectionMatrixData(inout ClusterLightData clusterLightData) {
	
	vec4 m0 = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_PROJ_MAT_0});
	vec4 m1 = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_PROJ_MAT_1});
	vec4 m2 = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_PROJ_MAT_2});
	vec4 m3 = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_PROJ_MAT_3});
	lightProjectionMatrix = mat4(m0, m1, m2, m3);
}
void decodeClusterLightShadowData(inout ClusterLightData clusterLightData) {
	
	vec2 biases = unpackHalf2x16(floatBitsToUint(clusterLightData.biasesData));
	clusterLightData.shadowBias = biases.x;
	clusterLightData.shadowNormalBias = biases.y;
}
void decodeClusterLightCookieData(inout ClusterLightData clusterLightData) {
	uint cookieFlags = (clusterLightData.flags >> 23u) & 0x0Fu;
	clusterLightData.cookieChannelMask = vec4(uvec4(cookieFlags) & uvec4(1u, 2u, 4u, 8u));
	clusterLightData.cookieChannelMask = step(1.0, clusterLightData.cookieChannelMask);
}
void evaluateLight(
	ClusterLightData light, 
	vec3 worldNormal, 
	vec3 viewDir, 
	vec3 reflectionDir,
#if defined(LIT_CLEARCOAT)
	vec3 clearcoatReflectionDir,
#endif
	float gloss, 
	vec3 specularity, 
	vec3 geometricNormal, 
	mat3 tbn, 
#if defined(LIT_IRIDESCENCE)
	vec3 iridescenceFresnel,
#endif
	vec3 clearcoat_worldNormal,
	float clearcoat_gloss,
	float sheen_gloss,
	float iridescence_intensity
) {
	vec3 cookieAttenuation = vec3(1.0);
	float diffuseAttenuation = 1.0;
	float falloffAttenuation = 1.0;
	vec3 lightDirW = evalOmniLight(light.position);
	vec3 lightDirNormW = normalize(lightDirW);
	#ifdef CLUSTER_AREALIGHTS
	if (light.shape != {LIGHTSHAPE_PUNCTUAL}) {
		decodeClusterLightAreaData(light);
		if (light.shape == {LIGHTSHAPE_RECT}) {
			calcRectLightValues(light.position, light.halfWidth, light.halfHeight);
		} else if (light.shape == {LIGHTSHAPE_DISK}) {
			calcDiskLightValues(light.position, light.halfWidth, light.halfHeight);
		} else {
			calcSphereLightValues(light.position, light.halfWidth, light.halfHeight);
		}
		falloffAttenuation = getFalloffWindow(light.range, lightDirW);
	} else
	#endif
	{
		if (light.falloffModeLinear)
			falloffAttenuation = getFalloffLinear(light.range, lightDirW);
		else
			falloffAttenuation = getFalloffInvSquared(light.range, lightDirW);
	}
	if (falloffAttenuation > 0.00001) {
		#ifdef CLUSTER_AREALIGHTS
		if (light.shape != {LIGHTSHAPE_PUNCTUAL}) {
			if (light.shape == {LIGHTSHAPE_RECT}) {
				diffuseAttenuation = getRectLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;
			} else if (light.shape == {LIGHTSHAPE_DISK}) {
				diffuseAttenuation = getDiskLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;
			} else {
				diffuseAttenuation = getSphereLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;
			}
		} else
		#endif
		{
			falloffAttenuation *= getLightDiffuse(worldNormal, viewDir, lightDirNormW); 
		}
		if (light.isSpot) {
			decodeClusterLightSpot(light);
			falloffAttenuation *= getSpotEffect(light.direction, light.innerConeAngleCos, light.outerConeAngleCos, lightDirNormW);
		}
		#if defined(CLUSTER_COOKIES) || defined(CLUSTER_SHADOWS)
		if (falloffAttenuation > 0.00001) {
			if (light.shadowIntensity > 0.0 || light.cookieIntensity > 0.0) {
				if (light.isSpot) {
					decodeClusterLightProjectionMatrixData(light);
				} else {
					decodeClusterLightOmniAtlasViewport(light);
				}
				float shadowTextureResolution = shadowAtlasParams.x;
				float shadowEdgePixels = shadowAtlasParams.y;
				#ifdef CLUSTER_COOKIES
				if (light.cookieIntensity > 0.0) {
					decodeClusterLightCookieData(light);
					if (light.isSpot) {
						cookieAttenuation = getCookie2DClustered(TEXTURE_PASS(cookieAtlasTexture), lightProjectionMatrix, vPositionW, light.cookieIntensity, light.cookieChannelMask);
					} else {
						cookieAttenuation = getCookieCubeClustered(TEXTURE_PASS(cookieAtlasTexture), lightDirW, light.cookieIntensity, light.cookieChannelMask, shadowTextureResolution, shadowEdgePixels, light.omniAtlasViewport);
					}
				}
				#endif
				#ifdef CLUSTER_SHADOWS
				if (light.shadowIntensity > 0.0) {
					decodeClusterLightShadowData(light);
					vec4 shadowParams = vec4(shadowTextureResolution, light.shadowNormalBias, light.shadowBias, 1.0 / light.range);
					if (light.isSpot) {
						vec3 shadowCoord = getShadowCoordPerspZbufferNormalOffset(lightProjectionMatrix, shadowParams, geometricNormal);
						
						#if defined(CLUSTER_SHADOW_TYPE_PCF1)
							float shadow = getShadowSpotClusteredPCF1(SHADOWMAP_PASS(shadowAtlasTexture), shadowCoord, shadowParams);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF3)
							float shadow = getShadowSpotClusteredPCF3(SHADOWMAP_PASS(shadowAtlasTexture), shadowCoord, shadowParams);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF5)
							float shadow = getShadowSpotClusteredPCF5(SHADOWMAP_PASS(shadowAtlasTexture), shadowCoord, shadowParams);
						#elif defined(CLUSTER_SHADOW_TYPE_PCSS)
							float shadow = getShadowSpotClusteredPCSS(SHADOWMAP_PASS(shadowAtlasTexture), shadowCoord, shadowParams);
						#endif
						falloffAttenuation *= mix(1.0, shadow, light.shadowIntensity);
					} else {
						vec3 dir = normalOffsetPointShadow(shadowParams, light.position, lightDirW, lightDirNormW, geometricNormal);
						#if defined(CLUSTER_SHADOW_TYPE_PCF1)
							float shadow = getShadowOmniClusteredPCF1(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF3)
							float shadow = getShadowOmniClusteredPCF3(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF5)
							float shadow = getShadowOmniClusteredPCF5(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);
						#endif
						falloffAttenuation *= mix(1.0, shadow, light.shadowIntensity);
					}
				}
				#endif
			}
		}
		#endif
		#ifdef CLUSTER_AREALIGHTS
		if (light.shape != {LIGHTSHAPE_PUNCTUAL}) {
			{
				vec3 areaDiffuse = (diffuseAttenuation * falloffAttenuation) * light.color * cookieAttenuation;
				#if defined(LIT_SPECULAR)
					areaDiffuse = mix(areaDiffuse, vec3(0), dLTCSpecFres);
				#endif
				dDiffuseLight += areaDiffuse;
			}
			#ifdef LIT_SPECULAR
				float areaLightSpecular;
				if (light.shape == {LIGHTSHAPE_RECT}) {
					areaLightSpecular = getRectLightSpecular(worldNormal, viewDir);
				} else if (light.shape == {LIGHTSHAPE_DISK}) {
					areaLightSpecular = getDiskLightSpecular(worldNormal, viewDir);
				} else {
					areaLightSpecular = getSphereLightSpecular(worldNormal, viewDir);
				}
				dSpecularLight += dLTCSpecFres * areaLightSpecular * falloffAttenuation * light.color * cookieAttenuation;
				#ifdef LIT_CLEARCOAT
					float areaLightSpecularCC;
					if (light.shape == {LIGHTSHAPE_RECT}) {
						areaLightSpecularCC = getRectLightSpecular(clearcoat_worldNormal, viewDir);
					} else if (light.shape == {LIGHTSHAPE_DISK}) {
						areaLightSpecularCC = getDiskLightSpecular(clearcoat_worldNormal, viewDir);
					} else {
						areaLightSpecularCC = getSphereLightSpecular(clearcoat_worldNormal, viewDir);
					}
					ccSpecularLight += ccLTCSpecFres * areaLightSpecularCC * falloffAttenuation * light.color  * cookieAttenuation;
				#endif
			#endif
		} else
		#endif
		{
			{
				vec3 punctualDiffuse = falloffAttenuation * light.color * cookieAttenuation;
				#if defined(CLUSTER_AREALIGHTS)
				#if defined(LIT_SPECULAR)
					punctualDiffuse = mix(punctualDiffuse, vec3(0), specularity);
				#endif
				#endif
				dDiffuseLight += punctualDiffuse;
			}
	 
			#ifdef LIT_SPECULAR
				vec3 halfDir = normalize(-lightDirNormW + viewDir);
				
				#ifdef LIT_SPECULAR_FRESNEL
					dSpecularLight += 
						getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, lightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * 
						getFresnel(
							dot(viewDir, halfDir), 
							gloss, 
							specularity
						#if defined(LIT_IRIDESCENCE)
							, iridescenceFresnel,
							iridescence_intensity
						#endif
							);
				#else
					dSpecularLight += getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, lightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * specularity;
				#endif
				#ifdef LIT_CLEARCOAT
					#ifdef LIT_SPECULAR_FRESNEL
						ccSpecularLight += getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, lightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * getFresnelCC(dot(viewDir, halfDir));
					#else
						ccSpecularLight += getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, lightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation; 
					#endif
				#endif
				#ifdef LIT_SHEEN
					sSpecularLight += getLightSpecularSheen(halfDir, worldNormal, viewDir, lightDirNormW, sheen_gloss) * falloffAttenuation * light.color * cookieAttenuation;
				#endif
			#endif
		}
	}
	dAtten = falloffAttenuation;
	dLightDirNormW = lightDirNormW;
}
void evaluateClusterLight(
	float lightIndex, 
	vec3 worldNormal, 
	vec3 viewDir, 
	vec3 reflectionDir, 
#if defined(LIT_CLEARCOAT)
	vec3 clearcoatReflectionDir,
#endif
	float gloss, 
	vec3 specularity, 
	vec3 geometricNormal, 
	mat3 tbn, 
#if defined(LIT_IRIDESCENCE)
	vec3 iridescenceFresnel,
#endif
	vec3 clearcoat_worldNormal,
	float clearcoat_gloss,
	float sheen_gloss,
	float iridescence_intensity
) {
	ClusterLightData clusterLightData;
	decodeClusterLightCore(clusterLightData, lightIndex);
	#ifdef CLUSTER_MESH_DYNAMIC_LIGHTS
		bool acceptLightMask = clusterLightData.isDynamic;
	#else
		bool acceptLightMask = clusterLightData.isLightmapped;
	#endif
	if (acceptLightMask)
		evaluateLight(
			clusterLightData, 
			worldNormal, 
			viewDir, 
			reflectionDir, 
#if defined(LIT_CLEARCOAT)
			clearcoatReflectionDir, 
#endif
			gloss, 
			specularity, 
			geometricNormal, 
			tbn, 
#if defined(LIT_IRIDESCENCE)
			iridescenceFresnel,
#endif
			clearcoat_worldNormal,
			clearcoat_gloss,
			sheen_gloss,
			iridescence_intensity
		);
}
void addClusteredLights(
	vec3 worldNormal, 
	vec3 viewDir, 
	vec3 reflectionDir, 
#if defined(LIT_CLEARCOAT)
	vec3 clearcoatReflectionDir,
#endif
	float gloss, 
	vec3 specularity, 
	vec3 geometricNormal, 
	mat3 tbn, 
#if defined(LIT_IRIDESCENCE)
	vec3 iridescenceFresnel,
#endif
	vec3 clearcoat_worldNormal,
	float clearcoat_gloss,
	float sheen_gloss,
	float iridescence_intensity
) {
	if (clusterSkip > 0.5)
		return;
	vec3 cellCoords = floor((vPositionW - clusterBoundsMin) * clusterCellsCountByBoundsSize);
	if (!(any(lessThan(cellCoords, vec3(0.0))) || any(greaterThanEqual(cellCoords, clusterCellsMax)))) {
		float cellIndex = dot(clusterCellsDot, cellCoords);
		float clusterV = floor(cellIndex * clusterTextureSize.y);
		float clusterU = cellIndex - (clusterV * clusterTextureSize.x);
		for (int lightCellIndex = 0; lightCellIndex < clusterMaxCells; lightCellIndex++) {
			float lightIndex = texelFetch(clusterWorldTexture, ivec2(int(clusterU) + lightCellIndex, clusterV), 0).x;
			if (lightIndex <= 0.0)
				break;
			evaluateClusterLight(
				lightIndex * 255.0, 
				worldNormal, 
				viewDir, 
				reflectionDir,
#if defined(LIT_CLEARCOAT)
				clearcoatReflectionDir,
#endif
				gloss, 
				specularity, 
				geometricNormal, 
				tbn, 
#if defined(LIT_IRIDESCENCE)
				iridescenceFresnel,
#endif
				clearcoat_worldNormal,
				clearcoat_gloss,
				sheen_gloss,
				iridescence_intensity
			); 
		}
	}
}
`});var dG,uG=m(()=>{dG=`
vec3 combineColor(vec3 albedo, vec3 sheenSpecularity, float clearcoatSpecularity) {
	vec3 ret = vec3(0);
#ifdef LIT_OLD_AMBIENT
	ret += (dDiffuseLight - light_globalAmbient) * albedo + material_ambient * light_globalAmbient;
#else
	ret += albedo * dDiffuseLight;
#endif
#ifdef LIT_SPECULAR
	ret += dSpecularLight;
#endif
#ifdef LIT_REFLECTIONS
	ret += dReflection.rgb * dReflection.a;
#endif
#ifdef LIT_SHEEN
	float sheenScaling = 1.0 - max(max(sheenSpecularity.r, sheenSpecularity.g), sheenSpecularity.b) * 0.157;
	ret = ret * sheenScaling + (sSpecularLight + sReflection.rgb) * sheenSpecularity;
#endif
#ifdef LIT_CLEARCOAT
	float clearCoatScaling = 1.0 - ccFresnel * clearcoatSpecularity;
	ret = ret * clearCoatScaling + (ccSpecularLight + ccReflection) * clearcoatSpecularity;
#endif
	return ret;
}
`});var mG,pG=m(()=>{mG=`
	varying vec2 uv0;
	uniform sampler2D blitTexture;
	void main(void) {
		gl_FragColor = texture2D(blitTexture, uv0);
	}
`});var _G,gG=m(()=>{_G=`
	varying vec2 uv0;
	uniform samplerCube blitTexture;
	uniform mat4 invViewProj;
	void main(void) {
		vec4 projPos = vec4(uv0 * 2.0 - 1.0, 0.5, 1.0);
		vec4 worldPos = invViewProj * projPos;
		gl_FragColor = textureCube(blitTexture, worldPos.xyz);
	}
`});var SG,TG=m(()=>{SG=`
	attribute vec2 vertex_position;
	varying vec2 uv0;
	void main(void) {
		gl_Position = vec4(vertex_position, 0.5, 1.0);
		uv0 = vertex_position.xy * 0.5 + 0.5;
		#ifndef WEBGPU
			uv0.y = 1.0 - uv0.y;
		#endif
	}
`});var EG,vG=m(()=>{EG=`
vec4 getCookie2D(sampler2D tex, mat4 transform, float intensity) {
	vec4 projPos = transform * vec4(vPositionW, 1.0);
	projPos.xy /= projPos.w;
	return mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);
}
vec4 getCookie2DClip(sampler2D tex, mat4 transform, float intensity) {
	vec4 projPos = transform * vec4(vPositionW, 1.0);
	projPos.xy /= projPos.w;
	if (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);
	return mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);
}
vec4 getCookie2DXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {
	vec4 projPos = transform * vec4(vPositionW, 1.0);
	projPos.xy /= projPos.w;
	projPos.xy += cookieOffset;
	vec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);
	return mix(vec4(1.0), texture2D(tex, uv), intensity);
}
vec4 getCookie2DClipXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {
	vec4 projPos = transform * vec4(vPositionW, 1.0);
	projPos.xy /= projPos.w;
	projPos.xy += cookieOffset;
	if (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);
	vec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);
	return mix(vec4(1.0), texture2D(tex, uv), intensity);
}
vec4 getCookieCube(samplerCube tex, mat4 transform, float intensity) {
	return mix(vec4(1.0), textureCube(tex, dLightDirNormW * mat3(transform)), intensity);
}
`});var xG,yG=m(()=>{xG=`
#if LIT_CUBEMAP_PROJECTION == BOX
	uniform vec3 envBoxMin;
	uniform vec3 envBoxMax;
#endif
vec3 cubeMapProject(vec3 nrdir) {
	#if LIT_CUBEMAP_PROJECTION == NONE
		return cubeMapRotate(nrdir);
	#endif
	#if LIT_CUBEMAP_PROJECTION == BOX
		nrdir = cubeMapRotate(nrdir);
		vec3 rbmax = (envBoxMax - vPositionW) / nrdir;
		vec3 rbmin = (envBoxMin - vPositionW) / nrdir;
		vec3 rbminmax = mix(rbmin, rbmax, vec3(greaterThan(nrdir, vec3(0.0))));
		float fa = min(min(rbminmax.x, rbminmax.y), rbminmax.z);
		vec3 posonbox = vPositionW + nrdir * fa;
		vec3 envBoxPos = (envBoxMin + envBoxMax) * 0.5;
		return normalize(posonbox - envBoxPos);
	#endif
}
`});var AG,PG=m(()=>{AG=`
#ifdef CUBEMAP_ROTATION
uniform mat3 cubeMapRotationMatrix;
#endif
vec3 cubeMapRotate(vec3 refDir) {
#ifdef CUBEMAP_ROTATION
	return refDir * cubeMapRotationMatrix;
#else
	return refDir;
#endif
}
`});var RG,CG=m(()=>{RG=`
#ifdef DEBUG_ALBEDO_PASS
gl_FragColor = vec4(gammaCorrectOutput(dAlbedo), 1.0);
#endif
#ifdef DEBUG_UV0_PASS
gl_FragColor = vec4(litArgs_albedo , 1.0);
#endif
#ifdef DEBUG_WORLD_NORMAL_PASS
gl_FragColor = vec4(litArgs_worldNormal * 0.5 + 0.5, 1.0);
#endif
#ifdef DEBUG_OPACITY_PASS
gl_FragColor = vec4(vec3(litArgs_opacity) , 1.0);
#endif
#ifdef DEBUG_SPECULARITY_PASS
gl_FragColor = vec4(litArgs_specularity, 1.0);
#endif
#ifdef DEBUG_GLOSS_PASS
gl_FragColor = vec4(vec3(litArgs_gloss) , 1.0);
#endif
#ifdef DEBUG_METALNESS_PASS
gl_FragColor = vec4(vec3(litArgs_metalness) , 1.0);
#endif
#ifdef DEBUG_AO_PASS
gl_FragColor = vec4(vec3(litArgs_ao) , 1.0);
#endif
#ifdef DEBUG_EMISSION_PASS
gl_FragColor = vec4(gammaCorrectOutput(litArgs_emission), 1.0);
#endif
`});var IG,wG=m(()=>{IG=`
#ifdef DEBUG_LIGHTING_PASS
litArgs_albedo = vec3(0.5);
#endif
#ifdef DEBUG_UV0_PASS
#ifdef VARYING_VUV0
litArgs_albedo = vec3(vUv0, 0);
#else
litArgs_albedo = vec3(0);
#endif
#endif
`});var LG,bG=m(()=>{LG=`
#ifndef _DECODE_INCLUDED_
#define _DECODE_INCLUDED_
vec3 decodeLinear(vec4 raw) {
	return raw.rgb;
}
float decodeGamma(float raw) {
	return pow(raw, 2.2);
}
vec3 decodeGamma(vec3 raw) {
	return pow(raw, vec3(2.2));
}
vec3 decodeGamma(vec4 raw) {
	return pow(raw.xyz, vec3(2.2));
}
vec3 decodeRGBM(vec4 raw) {
	vec3 color = (8.0 * raw.a) * raw.rgb;
	return color * color;
}
vec3 decodeRGBP(vec4 raw) {
	vec3 color = raw.rgb * (-raw.a * 7.0 + 8.0);
	return color * color;
}
vec3 decodeRGBE(vec4 raw) {
	if (raw.a == 0.0) {
		return vec3(0.0, 0.0, 0.0);
	} else {
		return raw.xyz * pow(2.0, raw.w * 255.0 - 128.0);
	}
}
vec4 passThrough(vec4 raw) {
	return raw;
}
vec3 unpackNormalXYZ(vec4 nmap) {
	return nmap.xyz * 2.0 - 1.0;
}
vec3 unpackNormalXY(vec4 nmap) {
	vec3 normal;
	normal.xy = nmap.wy * 2.0 - 1.0;
	normal.z = sqrt(1.0 - clamp(dot(normal.xy, normal.xy), 0.0, 1.0));
	return normal;
}
#endif
`});var MG,DG=m(()=>{MG=`
#ifndef _DETAILMODES_INCLUDED_
#define _DETAILMODES_INCLUDED_
vec3 detailMode_mul(vec3 c1, vec3 c2) {
	return c1 * c2;
}
vec3 detailMode_add(vec3 c1, vec3 c2) {
	return c1 + c2;
}
vec3 detailMode_screen(vec3 c1, vec3 c2) {
	return 1.0 - (1.0 - c1)*(1.0 - c2);
}
vec3 detailMode_overlay(vec3 c1, vec3 c2) {
	return mix(1.0 - 2.0 * (1.0 - c1)*(1.0 - c2), 2.0 * c1 * c2, step(c1, vec3(0.5)));
}
vec3 detailMode_min(vec3 c1, vec3 c2) {
	return min(c1, c2);
}
vec3 detailMode_max(vec3 c1, vec3 c2) {
	return max(c1, c2);
}
#endif
`});var OG,NG=m(()=>{OG=`
uniform vec3 material_diffuse;
#ifdef STD_DIFFUSEDETAIL_TEXTURE
	#include "detailModesPS"
#endif
void getAlbedo() {
	dAlbedo = material_diffuse.rgb;
	#ifdef STD_DIFFUSE_TEXTURE
		vec3 albedoTexture = {STD_DIFFUSE_TEXTURE_DECODE}(texture2DBias({STD_DIFFUSE_TEXTURE_NAME}, {STD_DIFFUSE_TEXTURE_UV}, textureBias)).{STD_DIFFUSE_TEXTURE_CHANNEL};
		#ifdef STD_DIFFUSEDETAIL_TEXTURE
			vec3 albedoDetail = {STD_DIFFUSEDETAIL_TEXTURE_DECODE}(texture2DBias({STD_DIFFUSEDETAIL_TEXTURE_NAME}, {STD_DIFFUSEDETAIL_TEXTURE_UV}, textureBias)).{STD_DIFFUSEDETAIL_TEXTURE_CHANNEL};
			albedoTexture = detailMode_{STD_DIFFUSEDETAIL_DETAILMODE}(albedoTexture, albedoDetail);
		#endif
		dAlbedo *= albedoTexture;
	#endif
	#ifdef STD_DIFFUSE_VERTEX
		dAlbedo *= gammaCorrectInput(saturate(vVertexColor.{STD_DIFFUSE_VERTEX_CHANNEL}));
	#endif
}
`});var FG,UG=m(()=>{FG=`
uniform vec3 material_emissive;
uniform float material_emissiveIntensity;
void getEmission() {
	dEmission = material_emissive * material_emissiveIntensity;
	#ifdef STD_EMISSIVE_TEXTURE
	dEmission *= {STD_EMISSIVE_TEXTURE_DECODE}(texture2DBias({STD_EMISSIVE_TEXTURE_NAME}, {STD_EMISSIVE_TEXTURE_UV}, textureBias)).{STD_EMISSIVE_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_EMISSIVE_VERTEX
	dEmission *= gammaCorrectInput(saturate(vVertexColor.{STD_EMISSIVE_VERTEX_CHANNEL}));
	#endif
}
`});var BG,VG=m(()=>{BG=`
vec4 encodeLinear(vec3 source) {
	return vec4(source, 1.0);
}
vec4 encodeGamma(vec3 source) {
	return vec4(pow(source + 0.0000001, vec3(1.0 / 2.2)), 1.0);
}
vec4 encodeRGBM(vec3 source) {
	vec4 result;
	result.rgb = pow(source.rgb, vec3(0.5));
	result.rgb *= 1.0 / 8.0;
	result.a = saturate( max( max( result.r, result.g ), max( result.b, 1.0 / 255.0 ) ) );
	result.a = ceil(result.a * 255.0) / 255.0;
	result.rgb /= result.a;
	return result;
}
vec4 encodeRGBP(vec3 source) {
	vec3 gamma = pow(source, vec3(0.5));
	float maxVal = min(8.0, max(1.0, max(gamma.x, max(gamma.y, gamma.z))));
	float v = 1.0 - ((maxVal - 1.0) / 7.0);
	v = ceil(v * 255.0) / 255.0;
	return vec4(gamma / (-v * 7.0 + 8.0), v);	
}
vec4 encodeRGBE(vec3 source) {
	float maxVal = max(source.x, max(source.y, source.z));
	if (maxVal < 1e-32) {
		return vec4(0, 0, 0, 0);
	} else {
		float e = ceil(log2(maxVal));
		return vec4(source / pow(2.0, e), (e + 128.0) / 255.0);
	}
}
`});var kG,GG=m(()=>{kG=`
	gl_FragColor.rgb = combineColor(litArgs_albedo, litArgs_sheen_specularity, litArgs_clearcoat_specularity);
	gl_FragColor.rgb += litArgs_emission;
	gl_FragColor.rgb = addFog(gl_FragColor.rgb);
	gl_FragColor.rgb = toneMap(gl_FragColor.rgb);
	gl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);
`});var zG,HG=m(()=>{zG=`
#ifndef _ENVATLAS_INCLUDED_
#define _ENVATLAS_INCLUDED_
const float atlasSize = 512.0;
const float seamSize = 1.0 / atlasSize;
vec2 mapUv(vec2 uv, vec4 rect) {
	return vec2(mix(rect.x + seamSize, rect.x + rect.z - seamSize, uv.x),
				mix(rect.y + seamSize, rect.y + rect.w - seamSize, uv.y));
}
vec2 mapRoughnessUv(vec2 uv, float level) {
	float t = 1.0 / exp2(level);
	return mapUv(uv, vec4(0, 1.0 - t, t, t * 0.5));
}
vec2 mapShinyUv(vec2 uv, float level) {
	float t = 1.0 / exp2(level);
	return mapUv(uv, vec4(1.0 - t, 1.0 - t, t, t * 0.5));
}
#endif
`});var XG,WG=m(()=>{XG=`
#ifdef LIT_SKYBOX_INTENSITY
	uniform float skyboxIntensity;
#endif
vec3 processEnvironment(vec3 color) {
	#ifdef LIT_SKYBOX_INTENSITY
		return color * skyboxIntensity;
	#else
		return color;
	#endif
}
`});var YG,KG=m(()=>{YG=`
float getFalloffWindow(float lightRadius, vec3 lightDir) {
	float sqrDist = dot(lightDir, lightDir);
	float invRadius = 1.0 / lightRadius;
	return square(saturate(1.0 - square(sqrDist * square(invRadius))));
}
float getFalloffInvSquared(float lightRadius, vec3 lightDir) {
	float sqrDist = dot(lightDir, lightDir);
	float falloff = 1.0 / (sqrDist + 1.0);
	float invRadius = 1.0 / lightRadius;
	falloff *= 16.0;
	falloff *= square(saturate(1.0 - square(sqrDist * square(invRadius))));
	return falloff;
}
`});var qG,jG=m(()=>{qG=`
float getFalloffLinear(float lightRadius, vec3 lightDir) {
	float d = length(lightDir);
	return max(((lightRadius - d) / lightRadius), 0.0);
}
`});var $G,ZG=m(()=>{$G=`
#ifndef FLOAT_AS_UINT
#define FLOAT_AS_UINT
vec4 float2uint(float value) {
	uint intBits = floatBitsToUint(value);
	return vec4(
		float((intBits >> 24u) & 0xFFu) / 255.0,
		float((intBits >> 16u) & 0xFFu) / 255.0,
		float((intBits >> 8u) & 0xFFu) / 255.0,
		float(intBits & 0xFFu) / 255.0
	);
}
float uint2float(vec4 value) {
	uint intBits = 
		(uint(value.r * 255.0) << 24u) |
		(uint(value.g * 255.0) << 16u) |
		(uint(value.b * 255.0) << 8u) |
		uint(value.a * 255.0);
	return uintBitsToFloat(intBits);
}
vec4 float2vec4(float value) {
	#if defined(CAPS_TEXTURE_FLOAT_RENDERABLE)
		return vec4(value, 1.0, 1.0, 1.0);
	#else
		return float2uint(value);
	#endif
}
#endif
`});var QG,JG=m(()=>{QG=`
float dBlendModeFogFactor = 1.0;
#if (FOG != NONE)
	uniform vec3 fog_color;
	#if (FOG == LINEAR)
		uniform float fog_start;
		uniform float fog_end;
	#else
		uniform float fog_density;
	#endif
#endif
float getFogFactor() {
	float depth = gl_FragCoord.z / gl_FragCoord.w;
	float fogFactor = 0.0;
	#if (FOG == LINEAR)
		fogFactor = (fog_end - depth) / (fog_end - fog_start);
	#elif (FOG == EXP)
		fogFactor = exp(-depth * fog_density);
	#elif (FOG == EXP2)
		fogFactor = exp(-depth * depth * fog_density * fog_density);
	#endif
	return clamp(fogFactor, 0.0, 1.0);
}
vec3 addFog(vec3 color) {
	#if (FOG != NONE)
		return mix(fog_color * dBlendModeFogFactor, color, getFogFactor());
	#endif
	return color;
}
`});var ez,tz=m(()=>{ez=`
vec3 getFresnel(
		float cosTheta, 
		float gloss, 
		vec3 specularity
#if defined(LIT_IRIDESCENCE)
		, vec3 iridescenceFresnel, 
		float iridescenceIntensity
#endif
	) {
	float fresnel = pow(1.0 - saturate(cosTheta), 5.0);
	float glossSq = gloss * gloss;
	vec3 ret = specularity + (max(vec3(glossSq), specularity) - specularity) * fresnel;
#if defined(LIT_IRIDESCENCE)
	return mix(ret, iridescenceFresnel, iridescenceIntensity);
#else
	return ret;
#endif	
}
float getFresnelCC(float cosTheta) {
	float fresnel = pow(1.0 - saturate(cosTheta), 5.0);
	return 0.04 + (1.0 - 0.04) * fresnel;
}
`});var sz,iz=m(()=>{sz=`
attribute vec2 vertex_position;
varying vec2 vUv0;
void main(void)
{
	gl_Position = vec4(vertex_position, 0.5, 1.0);
	vUv0 = vertex_position.xy * 0.5 + 0.5;
}
`});var rz,az=m(()=>{rz=`
#include "decodePS"
#if (GAMMA == SRGB)
	float gammaCorrectInput(float color) {
		return decodeGamma(color);
	}
	vec3 gammaCorrectInput(vec3 color) {
		return decodeGamma(color);
	}
	vec4 gammaCorrectInput(vec4 color) {
		return vec4(decodeGamma(color.xyz), color.w);
	}
	vec3 gammaCorrectOutput(vec3 color) {
		return pow(color + 0.0000001, vec3(1.0 / 2.2));
	}
#else
	float gammaCorrectInput(float color) {
		return color;
	}
	vec3 gammaCorrectInput(vec3 color) {
		return color;
	}
	vec4 gammaCorrectInput(vec4 color) {
		return color;
	}
	vec3 gammaCorrectOutput(vec3 color) {
		return color;
	}
#endif
`});var nz,oz=m(()=>{nz=`
#ifdef STD_GLOSS_CONSTANT
uniform float material_gloss;
#endif
void getGlossiness() {
	dGlossiness = 1.0;
	#ifdef STD_GLOSS_CONSTANT
	dGlossiness *= material_gloss;
	#endif
	#ifdef STD_GLOSS_TEXTURE
	dGlossiness *= texture2DBias({STD_GLOSS_TEXTURE_NAME}, {STD_GLOSS_TEXTURE_UV}, textureBias).{STD_GLOSS_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_GLOSS_VERTEX
	dGlossiness *= saturate(vVertexColor.{STD_GLOSS_VERTEX_CHANNEL});
	#endif
	#ifdef STD_GLOSS_INVERT
	dGlossiness = 1.0 - dGlossiness;
	#endif
	dGlossiness += 0.0000001;
}
`});var lz,hz=m(()=>{lz=`
uniform mat4 matrix_model;
uniform mat4 matrix_view;
uniform mat4 matrix_projection;
bool initCenter(vec3 modelCenter, out SplatCenter center) {
	mat4 modelView = matrix_view * matrix_model;
	vec4 centerView = modelView * vec4(modelCenter, 1.0);
	if (centerView.z > 0.0) {
		return false;
	}
	vec4 centerProj = matrix_projection * centerView;
	#if WEBGPU
		centerProj.z = clamp(centerProj.z, 0, abs(centerProj.w));
	#else
		centerProj.z = clamp(centerProj.z, -abs(centerProj.w), abs(centerProj.w));
	#endif
	center.view = centerView.xyz / centerView.w;
	center.proj = centerProj;
	center.projMat00 = matrix_projection[0][0];
	center.modelView = modelView;
	return true;
}
`});var cz,fz=m(()=>{cz=`
uniform mediump sampler2D splatColor;
vec4 readColor(in SplatSource source) {
	return texelFetch(splatColor, source.uv, 0);
}
`});var dz,uz=m(()=>{dz=`
struct SplatSource {
	uint order;
	uint id;
	ivec2 uv;
	vec2 cornerUV;
};
struct SplatCenter {
	vec3 view;
	vec4 proj;
	mat4 modelView;
	float projMat00;
};
struct SplatCorner {
	vec2 offset;
	vec2 uv;
	#if GSPLAT_AA
		float aaFactor;
	#endif
	vec2 v;
	float dlen;
};
#include "gsplatEvalSHVS"
#include "gsplatQuatToMat3VS"
#if GSPLAT_COMPRESSED_DATA == true
	#include "gsplatCompressedDataVS"
	#if SH_COEFFS > 0
		#include "gsplatCompressedSHVS"
	#endif
#elif GSPLAT_SOGS_DATA == true
	#include "gsplatSogsDataVS"
	#include "gsplatSogsColorVS"
	#if SH_COEFFS > 0
		#include "gsplatSogsSHVS"
	#endif
#else
	#include "gsplatDataVS"
	#include "gsplatColorVS"
	#if SH_COEFFS > 0
		#include "gsplatSHVS"
	#endif
#endif
#include "gsplatSourceVS"
#include "gsplatCenterVS"
#include "gsplatCornerVS"
#include "gsplatOutputVS"
void clipCorner(inout SplatCorner corner, float alpha) {
	float clip = min(1.0, sqrt(-log(1.0 / 255.0 / alpha)) / 2.0);
	corner.offset *= clip;
	corner.uv *= clip;
}
`});var mz,pz=m(()=>{mz=`
uniform highp usampler2D packedTexture;
uniform highp sampler2D chunkTexture;
vec4 chunkDataA;
vec4 chunkDataB;
vec4 chunkDataC;
vec4 chunkDataD;
vec4 chunkDataE;
uvec4 packedData;
vec3 unpack111011(uint bits) {
	return vec3(
		float(bits >> 21u) / 2047.0,
		float((bits >> 11u) & 0x3ffu) / 1023.0,
		float(bits & 0x7ffu) / 2047.0
	);
}
vec4 unpack8888(uint bits) {
	return vec4(
		float(bits >> 24u) / 255.0,
		float((bits >> 16u) & 0xffu) / 255.0,
		float((bits >> 8u) & 0xffu) / 255.0,
		float(bits & 0xffu) / 255.0
	);
}
const float norm = 1.0 / (sqrt(2.0) * 0.5);
vec4 unpackRotation(uint bits) {
	float a = (float((bits >> 20u) & 0x3ffu) / 1023.0 - 0.5) * norm;
	float b = (float((bits >> 10u) & 0x3ffu) / 1023.0 - 0.5) * norm;
	float c = (float(bits & 0x3ffu) / 1023.0 - 0.5) * norm;
	float m = sqrt(1.0 - (a * a + b * b + c * c));
	uint mode = bits >> 30u;
	if (mode == 0u) return vec4(m, a, b, c);
	if (mode == 1u) return vec4(a, m, b, c);
	if (mode == 2u) return vec4(a, b, m, c);
	return vec4(a, b, c, m);
}
vec3 readCenter(SplatSource source) {
	uint w = uint(textureSize(chunkTexture, 0).x) / 5u;
	uint chunkId = source.id / 256u;
	ivec2 chunkUV = ivec2((chunkId % w) * 5u, chunkId / w);
	chunkDataA = texelFetch(chunkTexture, chunkUV, 0);
	chunkDataB = texelFetch(chunkTexture, chunkUV + ivec2(1, 0), 0);
	chunkDataC = texelFetch(chunkTexture, chunkUV + ivec2(2, 0), 0);
	chunkDataD = texelFetch(chunkTexture, chunkUV + ivec2(3, 0), 0);
	chunkDataE = texelFetch(chunkTexture, chunkUV + ivec2(4, 0), 0);
	packedData = texelFetch(packedTexture, source.uv, 0);
	return mix(chunkDataA.xyz, vec3(chunkDataA.w, chunkDataB.xy), unpack111011(packedData.x));
}
vec4 readColor(in SplatSource source) {
	vec4 r = unpack8888(packedData.w);
	return vec4(mix(chunkDataD.xyz, vec3(chunkDataD.w, chunkDataE.xy), r.rgb), r.w);
}
vec4 getRotation() {
	return unpackRotation(packedData.y);
}
vec3 getScale() {
	return exp(mix(vec3(chunkDataB.zw, chunkDataC.x), chunkDataC.yzw, unpack111011(packedData.z)));
}
void readCovariance(in SplatSource source, out vec3 covA, out vec3 covB) {
	mat3 rot = quatToMat3(getRotation());
	vec3 scale = getScale();
	mat3 M = transpose(mat3(
		scale.x * rot[0],
		scale.y * rot[1],
		scale.z * rot[2]
	));
	covA = vec3(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));
	covB = vec3(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));
}
`});var _z,gz=m(()=>{_z=`
#if SH_BANDS > 0
uniform highp usampler2D shTexture0;
uniform highp usampler2D shTexture1;
uniform highp usampler2D shTexture2;
vec4 unpack8888s(in uint bits) {
	return vec4((uvec4(bits) >> uvec4(0u, 8u, 16u, 24u)) & 0xffu) * (8.0 / 255.0) - 4.0;
}
void readSHData(in SplatSource source, out vec3 sh[15], out float scale) {
	uvec4 shData0 = texelFetch(shTexture0, source.uv, 0);
	uvec4 shData1 = texelFetch(shTexture1, source.uv, 0);
	uvec4 shData2 = texelFetch(shTexture2, source.uv, 0);
	vec4 r0 = unpack8888s(shData0.x);
	vec4 r1 = unpack8888s(shData0.y);
	vec4 r2 = unpack8888s(shData0.z);
	vec4 r3 = unpack8888s(shData0.w);
	vec4 g0 = unpack8888s(shData1.x);
	vec4 g1 = unpack8888s(shData1.y);
	vec4 g2 = unpack8888s(shData1.z);
	vec4 g3 = unpack8888s(shData1.w);
	vec4 b0 = unpack8888s(shData2.x);
	vec4 b1 = unpack8888s(shData2.y);
	vec4 b2 = unpack8888s(shData2.z);
	vec4 b3 = unpack8888s(shData2.w);
	sh[0] =  vec3(r0.x, g0.x, b0.x);
	sh[1] =  vec3(r0.y, g0.y, b0.y);
	sh[2] =  vec3(r0.z, g0.z, b0.z);
	sh[3] =  vec3(r0.w, g0.w, b0.w);
	sh[4] =  vec3(r1.x, g1.x, b1.x);
	sh[5] =  vec3(r1.y, g1.y, b1.y);
	sh[6] =  vec3(r1.z, g1.z, b1.z);
	sh[7] =  vec3(r1.w, g1.w, b1.w);
	sh[8] =  vec3(r2.x, g2.x, b2.x);
	sh[9] =  vec3(r2.y, g2.y, b2.y);
	sh[10] = vec3(r2.z, g2.z, b2.z);
	sh[11] = vec3(r2.w, g2.w, b2.w);
	sh[12] = vec3(r3.x, g3.x, b3.x);
	sh[13] = vec3(r3.y, g3.y, b3.y);
	sh[14] = vec3(r3.z, g3.z, b3.z);
	scale = 1.0;
}
#endif
`});var Sz,Tz=m(()=>{Sz=`
	#if SH_BANDS == 1
		#define SH_COEFFS 3
	#elif SH_BANDS == 2
		#define SH_COEFFS 8
	#elif SH_BANDS == 3
		#define SH_COEFFS 15
	#else
		#define SH_COEFFS 0
	#endif
	#if SH_BANDS > 0
	const float SH_C1 = 0.4886025119029199f;
	#if SH_BANDS > 1
		const float SH_C2_0 = 1.0925484305920792f;
		const float SH_C2_1 = -1.0925484305920792f;
		const float SH_C2_2 = 0.31539156525252005f;
		const float SH_C2_3 = -1.0925484305920792f;
		const float SH_C2_4 = 0.5462742152960396f;
	#endif
	#if SH_BANDS > 2
		const float SH_C3_0 = -0.5900435899266435f;
		const float SH_C3_1 = 2.890611442640554f;
		const float SH_C3_2 = -0.4570457994644658f;
		const float SH_C3_3 = 0.3731763325901154f;
		const float SH_C3_4 = -0.4570457994644658f;
		const float SH_C3_5 = 1.445305721320277f;
		const float SH_C3_6 = -0.5900435899266435f;
	#endif
	vec3 evalSH(in vec3 sh[SH_COEFFS], in vec3 dir) {
		float x = dir.x;
		float y = dir.y;
		float z = dir.z;
		vec3 result = SH_C1 * (-sh[0] * y + sh[1] * z - sh[2] * x);
		#if SH_BANDS > 1
			float xx = x * x;
			float yy = y * y;
			float zz = z * z;
			float xy = x * y;
			float yz = y * z;
			float xz = x * z;
			result +=
				sh[3] * (SH_C2_0 * xy) +
				sh[4] * (SH_C2_1 * yz) +
				sh[5] * (SH_C2_2 * (2.0 * zz - xx - yy)) +
				sh[6] * (SH_C2_3 * xz) +
				sh[7] * (SH_C2_4 * (xx - yy));
		#endif
		#if SH_BANDS > 2
			result +=
				sh[8]  * (SH_C3_0 * y * (3.0 * xx - yy)) +
				sh[9]  * (SH_C3_1 * xy * z) +
				sh[10] * (SH_C3_2 * y * (4.0 * zz - xx - yy)) +
				sh[11] * (SH_C3_3 * z * (2.0 * zz - 3.0 * xx - 3.0 * yy)) +
				sh[12] * (SH_C3_4 * x * (4.0 * zz - xx - yy)) +
				sh[13] * (SH_C3_5 * z * (xx - yy)) +
				sh[14] * (SH_C3_6 * x * (xx - 3.0 * yy));
		#endif
		return result;
	}
	#endif
`});var Ez,vz=m(()=>{Ez=`
mat3 quatToMat3(vec4 R) {
	vec4 R2 = R + R;
	float X = R2.x * R.w;
	vec4 Y  = R2.y * R;
	vec4 Z  = R2.z * R;
	float W = R2.w * R.w;
	return mat3(
		1.0 - Z.z - W,
			  Y.z + X,
			  Y.w - Z.x,
			  Y.z - X,
		1.0 - Y.y - W,
			  Z.w + Y.x,
			  Y.w + Z.x,
			  Z.w - Y.x,
		1.0 - Y.y - Z.z
	);
}
`});var xz,yz=m(()=>{xz=`
uniform mediump sampler2D sh0;
uniform vec4 sh0_mins;
uniform vec4 sh0_maxs;
float SH_C0 = 0.28209479177387814;
vec4 readColor(in SplatSource source) {
	vec4 clr = mix(sh0_mins, sh0_maxs, texelFetch(sh0, source.uv, 0));
	return vec4(vec3(0.5) + clr.xyz * SH_C0, 1.0 / (1.0 + exp(-clr.w)));
}
`});var Az,Pz=m(()=>{Az=`
uniform highp usampler2D packedTexture;
uniform vec3 means_mins;
uniform vec3 means_maxs;
uniform vec3 scales_mins;
uniform vec3 scales_maxs;
vec4 unpackU32(uint v) {
	return vec4(
		float((v >> 24u) & 0xFFu) / 255.0,
		float((v >> 16u) & 0xFFu) / 255.0,
		float((v >> 8u) & 0xFFu) / 255.0,
		float(v & 0xFFu) / 255.0
	);
}
uvec4 packedSample;
vec3 readCenter(SplatSource source) {
	packedSample = texelFetch(packedTexture, source.uv, 0);
	vec3 l = unpackU32(packedSample.x).xyz;
	vec3 u = unpackU32(packedSample.y).xyz;
	vec3 n = (l * 255.0 + u * 255.0 * 256.0) / 65535.0;
	vec3 v = mix(means_mins, means_maxs, n);
	return sign(v) * (exp(abs(v)) - 1.0);
}
const float norm = 2.0 / sqrt(2.0);
void readCovariance(in SplatSource source, out vec3 covA, out vec3 covB) {
	vec4 qdata = unpackU32(packedSample.z);
	vec3 sdata = unpackU32(packedSample.w).xyz;
	vec3 abc = (qdata.xyz - 0.5) * norm;
	float d = sqrt(max(0.0, 1.0 - dot(abc, abc)));
	uint mode = uint(qdata.w * 255.0 + 0.5) - 252u;
	vec4 quat = (mode == 0u) ? vec4(d, abc) :
				((mode == 1u) ? vec4(abc.x, d, abc.yz) :
				((mode == 2u) ? vec4(abc.xy, d, abc.z) : vec4(abc, d)));
	mat3 rot = quatToMat3(quat);
	vec3 scale = exp(mix(scales_mins, scales_maxs, sdata));
	mat3 M = transpose(mat3(
		scale.x * rot[0],
		scale.y * rot[1],
		scale.z * rot[2]
	));
	covA = vec3(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));
	covB = vec3(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));
}
`});var Rz,Cz=m(()=>{Rz=`
uniform highp sampler2D sh_centroids;
uniform float shN_mins;
uniform float shN_maxs;
void readSHData(in SplatSource source, out vec3 sh[SH_COEFFS], out float scale) {
	ivec2 t = ivec2(packedSample.x & 255u, packedSample.y & 255u);
	int n = t.x + t.y * 256;
	int u = (n % 64) * SH_COEFFS;
	int v = n / 64;
	for (int i = 0; i < SH_COEFFS; i++) {
		sh[i] = mix(vec3(shN_mins), vec3(shN_maxs), texelFetch(sh_centroids, ivec2(u + i, v), 0).xyz);
	}
	scale = 1.0;
}
`});var Iz,wz=m(()=>{Iz=`
uniform vec2 viewport;
uniform vec4 camera_params;
bool initCorner(SplatSource source, SplatCenter center, out SplatCorner corner) {
	vec3 covA, covB;
	readCovariance(source, covA, covB);
	mat3 Vrk = mat3(
		covA.x, covA.y, covA.z, 
		covA.y, covB.x, covB.y,
		covA.z, covB.y, covB.z
	);
	float focal = viewport.x * center.projMat00;
	vec3 v = camera_params.w == 1.0 ? vec3(0.0, 0.0, 1.0) : center.view.xyz;
	float J1 = focal / v.z;
	vec2 J2 = -J1 / v.z * v.xy;
	mat3 J = mat3(
		J1, 0.0, J2.x, 
		0.0, J1, J2.y, 
		0.0, 0.0, 0.0
	);
	mat3 W = transpose(mat3(center.modelView));
	mat3 T = W * J;
	mat3 cov = transpose(T) * Vrk * T;
	#if GSPLAT_AA
		float detOrig = cov[0][0] * cov[1][1] - cov[0][1] * cov[0][1];
		float detBlur = (cov[0][0] + 0.3) * (cov[1][1] + 0.3) - cov[0][1] * cov[0][1];
		corner.aaFactor = sqrt(max(detOrig / detBlur, 0.0));
	#endif
	float diagonal1 = cov[0][0] + 0.3;
	float offDiagonal = cov[0][1];
	float diagonal2 = cov[1][1] + 0.3;
	float mid = 0.5 * (diagonal1 + diagonal2);
	float radius = length(vec2((diagonal1 - diagonal2) / 2.0, offDiagonal));
	float lambda1 = mid + radius;
	float lambda2 = max(mid - radius, 0.1);
	float vmin = min(1024.0, min(viewport.x, viewport.y));
	float l1 = 2.0 * min(sqrt(2.0 * lambda1), vmin);
	float l2 = 2.0 * min(sqrt(2.0 * lambda2), vmin);
	if (l1 < 2.0 && l2 < 2.0) {
		return false;
	}
	vec2 c = center.proj.ww / viewport;
	if (any(greaterThan(abs(center.proj.xy) - vec2(max(l1, l2)) * c, center.proj.ww))) {
		return false;
	}
	vec2 diagonalVector = normalize(vec2(offDiagonal, lambda1 - diagonal1));
	vec2 v1 = l1 * diagonalVector;
	vec2 v2 = l2 * vec2(diagonalVector.y, -diagonalVector.x);
	corner.offset = (source.cornerUV.x * v1 + source.cornerUV.y * v2) * c;
	corner.uv = source.cornerUV;
	return true;
}
`});var Lz,bz=m(()=>{Lz=`
uniform highp usampler2D transformA;
uniform highp sampler2D transformB;
uint tAw;
vec3 readCenter(SplatSource source) {
	uvec4 tA = texelFetch(transformA, source.uv, 0);
	tAw = tA.w;
	return uintBitsToFloat(tA.xyz);
}
vec4 unpackRotation(vec3 packed) {
	return vec4(packed.xyz, sqrt(max(0.0, 1.0 - dot(packed, packed))));
}
void readCovariance(in SplatSource source, out vec3 covA, out vec3 covB) {
	vec4 tB = texelFetch(transformB, source.uv, 0);
	mat3 rot = quatToMat3(unpackRotation(vec3(unpackHalf2x16(tAw), tB.w)).wxyz);
	vec3 scale = tB.xyz;
	
	mat3 M = transpose(mat3(
		scale.x * rot[0],
		scale.y * rot[1],
		scale.z * rot[2]
	));
	covA = vec3(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));
	covB = vec3(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));
}
`});var Mz,Dz=m(()=>{Mz=`
#include "tonemappingPS"
#include "decodePS"
#include "gammaPS"
vec3 prepareOutputFromGamma(vec3 gammaColor) {
	#if TONEMAP == NONE
		#if GAMMA == NONE
			return decodeGamma(gammaColor);
		#else
			return gammaColor;
		#endif
	#else
		return gammaCorrectOutput(toneMap(decodeGamma(gammaColor)));
	#endif
}
`});var Oz,Nz=m(()=>{Oz=`
#ifndef DITHER_NONE
	#include "bayerPS"
	#include "opacityDitherPS"
	varying float id;
#endif
#ifdef PICK_PASS
	#include "pickPS"
#endif
#if defined(SHADOW_PASS) || defined(PICK_PASS) || defined(PREPASS_PASS)
	uniform float alphaClip;
#endif
#ifdef PREPASS_PASS
	varying float vLinearDepth;
	#include "floatAsUintPS"
#endif
const float  EXP_A	  = 12102203.0;
const int	EXP_BC_RMS = 1064866808;
float fastExp(float x) {
	int i = int(EXP_A * x) + EXP_BC_RMS;
	return intBitsToFloat(i);
}
varying mediump vec2 gaussianUV;
varying mediump vec4 gaussianColor;
void main(void) {
	mediump float A = dot(gaussianUV, gaussianUV);
	if (A > 1.0) {
		discard;
	}
	mediump float alpha = fastExp(-A * 4.0) * gaussianColor.a;
	#if defined(SHADOW_PASS) || defined(PICK_PASS) || defined(PREPASS_PASS)
		if (alpha < alphaClip) {
			discard;
		}
	#endif
	#ifdef PICK_PASS
		gl_FragColor = getPickOutput();
	#elif SHADOW_PASS
		gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
	#elif PREPASS_PASS
		gl_FragColor = float2vec4(vLinearDepth);
	#else
		if (alpha < 1.0 / 255.0) {
			discard;
		}
		#ifndef DITHER_NONE
			opacityDither(alpha, id * 0.013);
		#endif
		gl_FragColor = vec4(gaussianColor.xyz * alpha, alpha);
	#endif
}
`});var Fz,Uz=m(()=>{Fz=`
#if SH_BANDS > 0
vec3 unpack111011s(uint bits) {
	return vec3((uvec3(bits) >> uvec3(21u, 11u, 0u)) & uvec3(0x7ffu, 0x3ffu, 0x7ffu)) / vec3(2047.0, 1023.0, 2047.0) * 2.0 - 1.0;
}
void fetchScale(in uvec4 t, out float scale, out vec3 a, out vec3 b, out vec3 c) {
	scale = uintBitsToFloat(t.x);
	a = unpack111011s(t.y);
	b = unpack111011s(t.z);
	c = unpack111011s(t.w);
}
void fetch(in uvec4 t, out vec3 a, out vec3 b, out vec3 c, out vec3 d) {
	a = unpack111011s(t.x);
	b = unpack111011s(t.y);
	c = unpack111011s(t.z);
	d = unpack111011s(t.w);
}
void fetch(in uint t, out vec3 a) {
	a = unpack111011s(t);
}
#if SH_BANDS == 1
	uniform highp usampler2D splatSH_1to3;
	void readSHData(in SplatSource source, out vec3 sh[3], out float scale) {
		fetchScale(texelFetch(splatSH_1to3, source.uv, 0), scale, sh[0], sh[1], sh[2]);
	}
#elif SH_BANDS == 2
	uniform highp usampler2D splatSH_1to3;
	uniform highp usampler2D splatSH_4to7;
	uniform highp usampler2D splatSH_8to11;
	void readSHData(in SplatSource source, out vec3 sh[8], out float scale) {
		fetchScale(texelFetch(splatSH_1to3, source.uv, 0), scale, sh[0], sh[1], sh[2]);
		fetch(texelFetch(splatSH_4to7, source.uv, 0), sh[3], sh[4], sh[5], sh[6]);
		fetch(texelFetch(splatSH_8to11, source.uv, 0).x, sh[7]);
	}
#else
	uniform highp usampler2D splatSH_1to3;
	uniform highp usampler2D splatSH_4to7;
	uniform highp usampler2D splatSH_8to11;
	uniform highp usampler2D splatSH_12to15;
	void readSHData(in SplatSource source, out vec3 sh[15], out float scale) {
		fetchScale(texelFetch(splatSH_1to3, source.uv, 0), scale, sh[0], sh[1], sh[2]);
		fetch(texelFetch(splatSH_4to7, source.uv, 0), sh[3], sh[4], sh[5], sh[6]);
		fetch(texelFetch(splatSH_8to11, source.uv, 0), sh[7], sh[8], sh[9], sh[10]);
		fetch(texelFetch(splatSH_12to15, source.uv, 0), sh[11], sh[12], sh[13], sh[14]);
	}
#endif
#endif
`});var Bz,Vz=m(()=>{Bz=`
attribute vec3 vertex_position;
attribute uint vertex_id_attrib;
uniform uint numSplats;
uniform highp usampler2D splatOrder;
bool initSource(out SplatSource source) {
	uint w = uint(textureSize(splatOrder, 0).x);
	source.order = vertex_id_attrib + uint(vertex_position.z);
	if (source.order >= numSplats) {
		return false;
	}
	ivec2 orderUV = ivec2(source.order % w, source.order / w);
	source.id = texelFetch(splatOrder, orderUV, 0).r;
	source.uv = ivec2(source.id % w, source.id / w);
	source.cornerUV = vertex_position.xy;
	return true;
}
`});var kz,Gz=m(()=>{kz=`
#include "gsplatCommonVS"
varying mediump vec2 gaussianUV;
varying mediump vec4 gaussianColor;
#ifndef DITHER_NONE
	varying float id;
#endif
mediump vec4 discardVec = vec4(0.0, 0.0, 2.0, 1.0);
#ifdef PREPASS_PASS
	varying float vLinearDepth;
#endif
void main(void) {
	SplatSource source;
	if (!initSource(source)) {
		gl_Position = discardVec;
		return;
	}
	vec3 modelCenter = readCenter(source);
	SplatCenter center;
	if (!initCenter(modelCenter, center)) {
		gl_Position = discardVec;
		return;
	}
	SplatCorner corner;
	if (!initCorner(source, center, corner)) {
		gl_Position = discardVec;
		return;
	}
	vec4 clr = readColor(source);
	#if GSPLAT_AA
		clr.a *= corner.aaFactor;
	#endif
	#if SH_BANDS > 0
		vec3 dir = normalize(center.view * mat3(center.modelView));
		vec3 sh[SH_COEFFS];
		float scale;
		readSHData(source, sh, scale);
		clr.xyz += evalSH(sh, dir) * scale;
	#endif
	clipCorner(corner, clr.w);
	gl_Position = center.proj + vec4(corner.offset, 0, 0);
	gaussianUV = corner.uv;
	gaussianColor = vec4(prepareOutputFromGamma(max(clr.xyz, 0.0)), clr.w);
	#ifndef DITHER_NONE
		id = float(source.id);
	#endif
	#ifdef PREPASS_PASS
		vLinearDepth = -center.view.z;
	#endif
}
`});var zz,Hz=m(()=>{zz=`
	attribute vec2 aPosition;
	varying vec2 uv0;
	void main(void)
	{
		gl_Position = vec4(aPosition, 0.0, 1.0);
		uv0 = getImageEffectUV((aPosition.xy + 1.0) * 0.5);
	}
`});var Xz,Wz=m(()=>{Xz=`
		#include "gammaPS"
		varying vec4 color;
		void main(void) {
			gl_FragColor = vec4(gammaCorrectOutput(decodeGamma(color.rgb)), color.a);
		}
`});var Yz,Kz=m(()=>{Yz=`
	attribute vec4 vertex_position;
	attribute vec4 vertex_color;
	uniform mat4 matrix_model;
	uniform mat4 matrix_viewProjection;
	varying vec4 color;
	void main(void) {
		color = vertex_color;
		gl_Position = matrix_viewProjection * matrix_model * vertex_position;
	}
`});var qz,jz=m(()=>{qz=`
uniform float material_iridescenceRefractionIndex;
float iridescence_iorToFresnel(float transmittedIor, float incidentIor) {
	return pow((transmittedIor - incidentIor) / (transmittedIor + incidentIor), 2.0);
}
vec3 iridescence_iorToFresnel(vec3 transmittedIor, float incidentIor) {
	return pow((transmittedIor - vec3(incidentIor)) / (transmittedIor + vec3(incidentIor)), vec3(2.0));
}
vec3 iridescence_fresnelToIor(vec3 f0) {
	vec3 sqrtF0 = sqrt(f0);
	return (vec3(1.0) + sqrtF0) / (vec3(1.0) - sqrtF0);
}
vec3 iridescence_sensitivity(float opd, vec3 shift) {
	float PI = 3.141592653589793;
	float phase = 2.0 * PI * opd * 1.0e-9;
	const vec3 val = vec3(5.4856e-13, 4.4201e-13, 5.2481e-13);
	const vec3 pos = vec3(1.6810e+06, 1.7953e+06, 2.2084e+06);
	const vec3 var = vec3(4.3278e+09, 9.3046e+09, 6.6121e+09);
	vec3 xyz = val * sqrt(2.0 * PI * var) * cos(pos * phase + shift) * exp(-pow(phase, 2.0) * var);
	xyz.x += 9.7470e-14 * sqrt(2.0 * PI * 4.5282e+09) * cos(2.2399e+06 * phase + shift[0]) * exp(-4.5282e+09 * pow(phase, 2.0));
	xyz /= vec3(1.0685e-07);
	const mat3 XYZ_TO_REC709 = mat3(
		3.2404542, -0.9692660,  0.0556434,
	   -1.5371385,  1.8760108, -0.2040259,
	   -0.4985314,  0.0415560,  1.0572252
	);
	return XYZ_TO_REC709 * xyz;
}
float iridescence_fresnel(float cosTheta, float f0) {
	float x = clamp(1.0 - cosTheta, 0.0, 1.0);
	float x2 = x * x;
	float x5 = x * x2 * x2;
	return f0 + (1.0 - f0) * x5;
} 
vec3 iridescence_fresnel(float cosTheta, vec3 f0) {
	float x = clamp(1.0 - cosTheta, 0.0, 1.0);
	float x2 = x * x;
	float x5 = x * x2 * x2; 
	return f0 + (vec3(1.0) - f0) * x5;
}
vec3 calcIridescence(float outsideIor, float cosTheta, vec3 base_f0, float iridescenceThickness) {
	float PI = 3.141592653589793;
	float iridescenceIor = mix(outsideIor, material_iridescenceRefractionIndex, smoothstep(0.0, 0.03, iridescenceThickness));
	float sinTheta2Sq = pow(outsideIor / iridescenceIor, 2.0) * (1.0 - pow(cosTheta, 2.0));
	float cosTheta2Sq = 1.0 - sinTheta2Sq;
	if (cosTheta2Sq < 0.0) {
		return vec3(1.0);
	}
	float cosTheta2 = sqrt(cosTheta2Sq);
	float r0 = iridescence_iorToFresnel(iridescenceIor, outsideIor);
	float r12 = iridescence_fresnel(cosTheta, r0);
	float r21 = r12;
	float t121 = 1.0 - r12;
	float phi12 = iridescenceIor < outsideIor ? PI : 0.0;
	float phi21 = PI - phi12;
	vec3 baseIor = iridescence_fresnelToIor(base_f0 + vec3(0.0001));
	vec3 r1 = iridescence_iorToFresnel(baseIor, iridescenceIor);
	vec3 r23 = iridescence_fresnel(cosTheta2, r1);
	vec3 phi23 = vec3(0.0);
	if (baseIor[0] < iridescenceIor) phi23[0] = PI;
	if (baseIor[1] < iridescenceIor) phi23[1] = PI;
	if (baseIor[2] < iridescenceIor) phi23[2] = PI;
	float opd = 2.0 * iridescenceIor * iridescenceThickness * cosTheta2;
	vec3 phi = vec3(phi21) + phi23; 
	vec3 r123Sq = clamp(r12 * r23, 1e-5, 0.9999);
	vec3 r123 = sqrt(r123Sq);
	vec3 rs = pow(t121, 2.0) * r23 / (1.0 - r123Sq);
	vec3 c0 = r12 + rs;
	vec3 i = c0;
	vec3 cm = rs - t121;
	for (int m = 1; m <= 2; m++) {
		cm *= r123;
		vec3 sm = 2.0 * iridescence_sensitivity(float(m) * opd, float(m) * phi);
		i += cm * sm;
	}
	return max(i, vec3(0.0));
}
vec3 getIridescence(float cosTheta, vec3 specularity, float iridescenceThickness) {
	return calcIridescence(1.0, cosTheta, specularity, iridescenceThickness);
}
`});var $z,Zz=m(()=>{$z=`
#ifdef STD_IRIDESCENCE_CONSTANT
uniform float material_iridescence;
#endif
void getIridescence() {
	float iridescence = 1.0;
	#ifdef STD_IRIDESCENCE_CONSTANT
	iridescence *= material_iridescence;
	#endif
	#ifdef STD_IRIDESCENCE_TEXTURE
	iridescence *= texture2DBias({STD_IRIDESCENCE_TEXTURE_NAME}, {STD_IRIDESCENCE_TEXTURE_UV}, textureBias).{STD_IRIDESCENCE_TEXTURE_CHANNEL};
	#endif
	dIridescence = iridescence; 
}
`});var Qz,Jz=m(()=>{Qz=`
uniform float material_iridescenceThicknessMax;
#ifdef STD_IRIDESCENCETHICKNESS_TEXTURE
uniform float material_iridescenceThicknessMin;
#endif
void getIridescenceThickness() {
	#ifdef STD_IRIDESCENCETHICKNESS_TEXTURE
		float blend = texture2DBias({STD_IRIDESCENCETHICKNESS_TEXTURE_NAME}, {STD_IRIDESCENCETHICKNESS_TEXTURE_UV}, textureBias).{STD_IRIDESCENCETHICKNESS_TEXTURE_CHANNEL};
		float iridescenceThickness = mix(material_iridescenceThicknessMin, material_iridescenceThicknessMax, blend);
	#else
		float iridescenceThickness = material_iridescenceThicknessMax;
	#endif
	dIridescenceThickness = iridescenceThickness; 
}
`});var eH,tH=m(()=>{eH=`
#ifdef STD_IOR_CONSTANT
uniform float material_refractionIndex;
#endif
void getIor() {
#ifdef STD_IOR_CONSTANT
	dIor = material_refractionIndex;
#else
	dIor = 1.0 / 1.5;
#endif
}
`});var sH,iH=m(()=>{sH=`
#if defined(LIGHT{i})
	uniform vec3 light{i}_color;
	#if LIGHT{i}TYPE == DIRECTIONAL
		uniform vec3 light{i}_direction;
	#else
		#define LIT_CODE_LIGHTS_POINT
		uniform vec3 light{i}_position;
		uniform float light{i}_radius;
		#if LIGHT{i}TYPE == SPOT
			#define LIT_CODE_LIGHTS_SPOT
			uniform vec3 light{i}_direction;
			uniform float light{i}_innerConeAngle;
			uniform float light{i}_outerConeAngle;
		#endif
	#endif
	#if LIGHT{i}SHAPE != PUNCTUAL
		#define LIT_CODE_FALLOFF_SQUARED
		#if LIGHT{i}TYPE == DIRECTIONAL
			uniform vec3 light{i}_position;
		#endif
		uniform vec3 light{i}_halfWidth;
		uniform vec3 light{i}_halfHeight;
	#else
		#if LIGHT{i}FALLOFF == LINEAR
			#define LIT_CODE_FALLOFF_LINEAR
		#endif
		#if LIGHT{i}FALLOFF == INVERSESQUARED
			#define LIT_CODE_FALLOFF_SQUARED
		#endif
	#endif
	#if defined(LIGHT{i}CASTSHADOW)
		uniform mat4 light{i}_shadowMatrix;
		uniform float light{i}_shadowIntensity;
		uniform vec4 light{i}_shadowParams;
		#if LIGHT{i}SHADOWTYPE == PCSS_32F
			uniform float light{i}_shadowSearchArea;
			uniform vec4 light{i}_cameraParams;
			#if LIGHT{i}TYPE == DIRECTIONAL
				uniform vec4 light{i}_softShadowParams;
			#endif
		#endif
		#if LIGHT{i}TYPE == DIRECTIONAL
			uniform mat4 light{i}_shadowMatrixPalette[4];
			uniform vec4 light{i}_shadowCascadeDistances;
			uniform int light{i}_shadowCascadeCount;
			uniform float light{i}_shadowCascadeBlend;
		#endif
		#if LIGHT{i}TYPE == OMNI
			#if defined(LIGHT{i}SHADOW_PCF)
				uniform samplerCubeShadow light{i}_shadowMap;
			#else
				uniform samplerCube light{i}_shadowMap;
			#endif
		#else
			#if defined(LIGHT{i}SHADOW_PCF)
				uniform sampler2DShadow light{i}_shadowMap;
			#else
				uniform sampler2D light{i}_shadowMap;
			#endif
		#endif
	#endif
	#if defined(LIGHT{i}COOKIE)
		#define LIT_CODE_COOKIE
		#if LIGHT{i}TYPE == OMNI
			uniform samplerCube light{i}_cookie;
			uniform float light{i}_cookieIntensity;
			#if !defined(LIGHT{i}CASTSHADOW)
				uniform mat4 light{i}_shadowMatrix;
			#endif
		#endif
		#if LIGHT{i}TYPE == SPOT
			uniform sampler2D light{i}_cookie;
			uniform float light{i}_cookieIntensity;
			#if !defined(LIGHT{i}CASTSHADOW)
				uniform mat4 light{i}_shadowMatrix;
			#endif
			#if defined(LIGHT{i}COOKIE_TRANSFORM)
				uniform vec4 light{i}_cookieMatrix;
				uniform vec2 light{i}_cookieOffset;
			#endif
		#endif
	#endif
#endif
`});var rH,aH=m(()=>{rH=`
float getLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm) {
	return max(dot(worldNormal, -lightDirNorm), 0.0);
}
`});var nH,oH=m(()=>{nH=`
vec3 evalOmniLight(vec3 lightPosW) {
	return vPositionW - lightPosW;
}
`});var lH,hH=m(()=>{lH=`
#if defined(LIGHT{i})
	evaluateLight{i}(
		#if defined(LIT_IRIDESCENCE)
			iridescenceFresnel
		#endif
	);
#endif
`});var cH,fH=m(()=>{cH=`
#if defined(LIGHT{i})
void evaluateLight{i}(
	#if defined(LIT_IRIDESCENCE)
		vec3 iridescenceFresnel
	#endif
) {
	vec3 lightColor = light{i}_color;
	#if LIGHT{i}TYPE == DIRECTIONAL && !defined(LIT_SHADOW_CATCHER)
		if (all(equal(lightColor, vec3(0.0)))) {
			return;
		}
	#endif
	#if LIGHT{i}TYPE == DIRECTIONAL
		dLightDirNormW = light{i}_direction;
		dAtten = 1.0;
	#else
		
		vec3 lightDirW = evalOmniLight(light{i}_position);
		dLightDirNormW = normalize(lightDirW);
		#if defined(LIGHT{i}COOKIE)
			#if LIGHT{i}TYPE == SPOT
				#ifdef LIGHT{i}COOKIE_FALLOFF
					#ifdef LIGHT{i}COOKIE_TRANSFORM
						vec3 cookieAttenuation = getCookie2DXform(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity, light{i}_cookieMatrix, light{i}_cookieOffset).{LIGHT{i}COOKIE_CHANNEL};
					#else
						vec3 cookieAttenuation = getCookie2D(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};
					#endif
				#else
					#ifdef LIGHT{i}COOKIE_TRANSFORM
						vec3 cookieAttenuation = getCookie2DClipXform(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity, light{i}_cookieMatrix, light{i}_cookieOffset).{LIGHT{i}COOKIE_CHANNEL};
					#else
						vec3 cookieAttenuation = getCookie2DClip(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};
					#endif
				#endif
			#endif
			#if LIGHT{i}TYPE == OMNI
				vec3 cookieAttenuation = getCookieCube(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};
			#endif
			lightColor *= cookieAttenuation;
		#endif
		#if LIGHT{i}SHAPE == PUNCTUAL
			#if LIGHT{i}FALLOFF == LINEAR
				dAtten = getFalloffLinear(light{i}_radius, lightDirW);
			#else
				dAtten = getFalloffInvSquared(light{i}_radius, lightDirW);
			#endif
		#else
			dAtten = getFalloffWindow(light{i}_radius, lightDirW);
		#endif
		#if LIGHT{i}TYPE == SPOT
			#if !defined(LIGHT{i}COOKIE) || defined(LIGHT{i}COOKIE_FALLOFF)
				dAtten *= getSpotEffect(light{i}_direction, light{i}_innerConeAngle, light{i}_outerConeAngle, dLightDirNormW);
			#endif
		#endif
	#endif
	if (dAtten < 0.00001) {
		return;
	}
	#if LIGHT{i}SHAPE != PUNCTUAL
		#if LIGHT{i}SHAPE == RECT
			calcRectLightValues(light{i}_position, light{i}_halfWidth, light{i}_halfHeight);
		#elif LIGHT{i}SHAPE == DISK
			calcDiskLightValues(light{i}_position, light{i}_halfWidth, light{i}_halfHeight);
		#elif LIGHT{i}SHAPE == SPHERE
			calcSphereLightValues(light{i}_position, light{i}_halfWidth, light{i}_halfHeight);
		#endif
	#endif
	#if LIGHT{i}SHAPE != PUNCTUAL
		#if LIGHT{i}TYPE == DIRECTIONAL
			float attenDiffuse = getLightDiffuse(litArgs_worldNormal, dViewDirW, dLightDirNormW);
		#else
			#if LIGHT{i}SHAPE == RECT
				float attenDiffuse = getRectLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;
			#elif LIGHT{i}SHAPE == DISK
				float attenDiffuse = getDiskLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;
			#elif LIGHT{i}SHAPE == SPHERE
				float attenDiffuse = getSphereLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;
			#endif
		#endif
	#else
		dAtten *= getLightDiffuse(litArgs_worldNormal, vec3(0.0), dLightDirNormW);
	#endif
	#ifdef LIGHT{i}CASTSHADOW
		#if LIGHT{i}TYPE == DIRECTIONAL
			float shadow = getShadow{i}(vec3(0.0));
		#else
			float shadow = getShadow{i}(lightDirW);
		#endif
		shadow = mix(1.0, shadow, light{i}_shadowIntensity);
		dAtten *= shadow;
		#if defined(LIT_SHADOW_CATCHER) && LIGHT{i}TYPE == DIRECTIONAL
			dShadowCatcher *= shadow;
		#endif			
	#endif
	#if LIGHT{i}SHAPE != PUNCTUAL
		#ifdef LIT_SPECULAR
			dDiffuseLight += ((attenDiffuse * dAtten) * lightColor) * (1.0 - dLTCSpecFres);
		#else
			dDiffuseLight += (attenDiffuse * dAtten) * lightColor;
		#endif						
	#else
		#if defined(AREA_LIGHTS) && defined(LIT_SPECULAR)
			dDiffuseLight += (dAtten * lightColor) * (1.0 - litArgs_specularity);
		#else
			dDiffuseLight += dAtten * lightColor;
		#endif
	#endif
	#ifdef LIGHT{i}AFFECT_SPECULARITY
		#if LIGHT{i}SHAPE != PUNCTUAL
			#ifdef LIT_CLEARCOAT
				#if LIGHT{i}SHAPE == RECT
					ccSpecularLight += ccLTCSpecFres * getRectLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor;
				#elif LIGHT{i}SHAPE == DISK
					ccSpecularLight += ccLTCSpecFres * getDiskLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor;
				#elif LIGHT{i}SHAPE == SPHERE
					ccSpecularLight += ccLTCSpecFres * getSphereLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor;
				#endif
			#endif
			#ifdef LIT_SPECULAR
				#if LIGHT{i}SHAPE == RECT
					dSpecularLight += dLTCSpecFres * getRectLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor;
				#elif LIGHT{i}SHAPE == DISK
					dSpecularLight += dLTCSpecFres * getDiskLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor;
				#elif LIGHT{i}SHAPE == SPHERE
					dSpecularLight += dLTCSpecFres * getSphereLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor;
				#endif
			#endif
		#else
			#if LIGHT{i}TYPE == DIRECTIONAL && LIT_FRESNEL_MODEL != NONE
				#define LIGHT{i}FRESNEL
			#endif
			#ifdef LIT_SPECULAR
				vec3 halfDirW = normalize(-dLightDirNormW + dViewDirW);
			#endif
			#ifdef LIT_CLEARCOAT
				vec3 lightspecularCC = getLightSpecular(halfDirW, ccReflDirW, litArgs_clearcoat_worldNormal, dViewDirW, dLightDirNormW, litArgs_clearcoat_gloss, dTBN) * dAtten * lightColor;
				#ifdef LIGHT{i}FRESNEL
					lightspecularCC *= getFresnelCC(dot(dViewDirW, halfDirW));
				#endif
				ccSpecularLight += lightspecularCC;
			#endif
			#ifdef LIT_SHEEN
				sSpecularLight += getLightSpecularSheen(halfDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_sheen_gloss) * dAtten * lightColor;
			#endif
			#ifdef LIT_SPECULAR
				vec3 lightSpecular = getLightSpecular(halfDirW, dReflDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_gloss, dTBN) * dAtten * lightColor;
				#ifdef LIGHT{i}FRESNEL
					#if defined(LIT_IRIDESCENCE)
						lightSpecular *= getFresnel(dot(dViewDirW, halfDirW), litArgs_gloss, litArgs_specularity, iridescenceFresnel, litArgs_iridescence_intensity);
					#else
						lightSpecular *= getFresnel(dot(dViewDirW, halfDirW), litArgs_gloss, litArgs_specularity);
					#endif
				#else
					lightSpecular *= litArgs_specularity;
				#endif
				
				dSpecularLight += lightSpecular;
			#endif
		#endif
	#endif
}
#endif
`});var dH,uH=m(()=>{dH=`
#ifdef LIGHT{i}CASTSHADOW
	vec3 getShadowSampleCoord{i}(mat4 shadowTransform, vec4 shadowParams, vec3 worldPosition, vec3 lightPos, inout vec3 lightDir, vec3 lightDirNorm, vec3 normal) {
		vec3 surfacePosition = worldPosition;
		#ifdef LIGHT{i}_SHADOW_SAMPLE_POINT
			#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET
				float distScale = length(lightDir);
				surfacePosition = surfacePosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;
				lightDir = surfacePosition - lightPos;
				return lightDir;
			#endif
		#else
			#ifdef LIGHT{i}_SHADOW_SAMPLE_SOURCE_ZBUFFER
				#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET
					surfacePosition = surfacePosition + normal * shadowParams.y;
				#endif
			#else
				#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET
					#ifdef LIGHT{i}_SHADOW_SAMPLE_ORTHO
						float distScale = 1.0;
					#else
						float distScale = abs(dot(vPositionW - lightPos, lightDirNorm));
					#endif
					surfacePosition = surfacePosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;
				#endif
			#endif
			vec4 positionInShadowSpace = shadowTransform * vec4(surfacePosition, 1.0);
			#ifdef LIGHT{i}_SHADOW_SAMPLE_ORTHO
				positionInShadowSpace.z = saturate(positionInShadowSpace.z) - 0.0001;
			#else
				#ifdef LIGHT{i}_SHADOW_SAMPLE_SOURCE_ZBUFFER
					positionInShadowSpace.xyz /= positionInShadowSpace.w;
				#else
					positionInShadowSpace.xy /= positionInShadowSpace.w;
					positionInShadowSpace.z = length(lightDir) * shadowParams.w;
				#endif
			#endif
			#ifdef SHADOW_SAMPLE_Z_BIAS
			#endif
			surfacePosition = positionInShadowSpace.xyz;
		#endif
		return surfacePosition;
	}
	float getShadow{i}(vec3 lightDirW) {
		#ifdef LIGHT{i}_SHADOW_CASCADES
			int cascadeIndex = getShadowCascadeIndex(light{i}_shadowCascadeDistances, light{i}_shadowCascadeCount);
			#ifdef LIGHT{i}_SHADOW_CASCADE_BLEND
				cascadeIndex = ditherShadowCascadeIndex(cascadeIndex, light{i}_shadowCascadeDistances, light{i}_shadowCascadeCount, light{i}_shadowCascadeBlend);
			#endif
			mat4 shadowMatrix = light{i}_shadowMatrixPalette[cascadeIndex];
		#else
			mat4 shadowMatrix = light{i}_shadowMatrix;
		#endif
		#if LIGHT{i}TYPE == DIRECTIONAL
			vec3 shadowCoord = getShadowSampleCoord{i}(shadowMatrix, light{i}_shadowParams, vPositionW, vec3(0.0), lightDirW, dLightDirNormW, dVertexNormalW);
		#else
			vec3 shadowCoord = getShadowSampleCoord{i}(shadowMatrix, light{i}_shadowParams, vPositionW, light{i}_position, lightDirW, dLightDirNormW, dVertexNormalW);
		#endif
		#if LIGHT{i}TYPE == DIRECTIONAL
			shadowCoord = fadeShadow(shadowCoord, light{i}_shadowCascadeDistances);
		#endif
		#if LIGHT{i}TYPE == DIRECTIONAL
			#if LIGHT{i}SHADOWTYPE == VSM_16F
				return getShadowVSM16(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, 5.54);
			#endif
			#if LIGHT{i}SHADOWTYPE == VSM_32F
				return getShadowVSM32(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, 15.0);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCSS_32F
				#if LIGHT{i}SHAPE != PUNCTUAL
					vec2 shadowSearchArea = vec2(length(light{i}_halfWidth), length(light{i}_halfHeight)) * light{i}_shadowSearchArea;
					return getShadowPCSS(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, light{i}_cameraParams, shadowSearchArea, lightDirW);
				#else
					return getShadowPCSS(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, light{i}_cameraParams, light{i}_softShadowParams, lightDirW);
				#endif
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F
				return getShadowPCF1x1(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F
				return getShadowPCF3x3(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF5_16F || LIGHT{i}SHADOWTYPE == PCF5_32F
				return getShadowPCF5x5(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);
			#endif
		#endif
		#if LIGHT{i}TYPE == SPOT
			#if LIGHT{i}SHADOWTYPE == VSM_16F
				return getShadowSpotVSM16(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, 5.54, lightDirW);
			#endif
			#if LIGHT{i}SHADOWTYPE == VSM_32F
				return getShadowSpotVSM32(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, 15.0, lightDirW);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCSS_32F
				#if LIGHT{i}SHAPE != PUNCTUAL
					vec2 shadowSearchArea = vec2(length(light{i}_halfWidth), length(light{i}_halfHeight)) * light{i}_shadowSearchArea;
				#else
					vec2 shadowSearchArea = vec2(light{i}_shadowSearchArea);
				#endif
				return getShadowSpotPCSS(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, light{i}_cameraParams, shadowSearchArea, lightDirW);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F
				return getShadowSpotPCF1x1(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F
				return getShadowSpotPCF3x3(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF5_16F || LIGHT{i}SHADOWTYPE == PCF5_32F
				return getShadowSpotPCF5x5(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);
			#endif
		#endif
		#if LIGHT{i}TYPE == OMNI
			#if LIGHT{i}SHADOWTYPE == PCSS_32F
				#if LIGHT{i}SHAPE != PUNCTUAL
					vec2 shadowSearchArea = vec2(length(light{i}_halfWidth), length(light{i}_halfHeight)) * light{i}_shadowSearchArea;
				#else
					vec2 shadowSearchArea = vec2(light{i}_shadowSearchArea);
				#endif
				return getShadowOmniPCSS(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, light{i}_cameraParams, shadowSearchArea, lightDirW);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F
				return getShadowOmniPCF1x1(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, lightDirW);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F
				return getShadowOmniPCF3x3(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, lightDirW);
			#endif
		#endif
	}
#endif
`});var mH,pH=m(()=>{mH=`
#ifdef LIT_CLUSTERED_LIGHTS
	#define LIT_CODE_FALLOFF_LINEAR
	#define LIT_CODE_FALLOFF_SQUARED
	#define LIT_CODE_LIGHTS_POINT
	#define LIT_CODE_LIGHTS_SPOT
#endif
#ifdef AREA_LIGHTS
	uniform highp sampler2D areaLightsLutTex1;
	uniform highp sampler2D areaLightsLutTex2;
#endif
#ifdef LIT_LIGHTING
	#include "lightDiffuseLambertPS"
	#if defined(AREA_LIGHTS) || defined(LIT_CLUSTERED_AREA_LIGHTS)
		#include "ltcPS"
	#endif
#endif
#ifdef SHADOW_DIRECTIONAL
	#include "shadowCascadesPS"
#endif
#if defined(SHADOW_KIND_PCF1)
	#include "shadowPCF1PS"
#endif
#if defined(SHADOW_KIND_PCF3)
	#include "shadowPCF3PS"
#endif
#if defined(SHADOW_KIND_PCF5)
	#include "shadowPCF5PS"
#endif
#if defined(SHADOW_KIND_PCSS)
	#include "linearizeDepthPS"
	#include "shadowPCSSPS"
	#include "shadowSoftPS"
#endif
#if defined(SHADOW_KIND_VSM)
	#include "shadowEVSMPS"
#endif
#ifdef LIT_CODE_FALLOFF_LINEAR
	#include "falloffLinearPS"
#endif
#ifdef LIT_CODE_FALLOFF_SQUARED
	#include "falloffInvSquaredPS"
#endif
#ifdef LIT_CODE_LIGHTS_POINT
	#include "lightDirPointPS"
#endif
#ifdef LIT_CODE_LIGHTS_SPOT
	#include "spotPS"
#endif
#ifdef LIT_CODE_COOKIE
	#include "cookiePS"
#endif
#ifdef LIT_CLUSTERED_LIGHTS
	#include "clusteredLightPS"
#endif
#ifdef LIGHT_COUNT > 0
	#include "lightFunctionShadowPS, LIGHT_COUNT"
	#include "lightFunctionLightPS, LIGHT_COUNT"
#endif
`});var _H,gH=m(()=>{_H=`
void addLightMap(
	vec3 lightmap, 
	vec3 dir, 
	vec3 worldNormal, 
	vec3 viewDir, 
	vec3 reflectionDir, 
	float gloss, 
	vec3 specularity, 
	vec3 vertexNormal, 
	mat3 tbn
#if defined(LIT_IRIDESCENCE)
	vec3 iridescenceFresnel, 
	float iridescenceIntensity
#endif
) {
	#if defined(LIT_SPECULAR) && defined(LIT_DIR_LIGHTMAP)
		if (dot(dir, dir) < 0.0001) {
				dDiffuseLight += lightmap;
		} else {
			float vlight = saturate(dot(dir, -vertexNormal));
			float flight = saturate(dot(dir, -worldNormal));
			float nlight = (flight / max(vlight, 0.01)) * 0.5;
			dDiffuseLight += lightmap * nlight * 2.0;
			vec3 halfDir = normalize(-dir + viewDir);
			vec3 specularLight = lightmap * getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, dir, gloss, tbn);
			#ifdef LIT_SPECULAR_FRESNEL
				specularLight *= 
					getFresnel(dot(viewDir, halfDir), 
					gloss, 
					specularity
				#if defined(LIT_IRIDESCENCE)
					, iridescenceFresnel,
					iridescenceIntensity
				#endif
					);
			#endif
			dSpecularLight += specularLight;
		}
	#else
		dDiffuseLight += lightmap;
	#endif
}
`});var SH,TH=m(()=>{SH=`
#ifdef STD_LIGHTMAP_DIR
	vec3 dLightmapDir;
	uniform sampler2D texture_dirLightMap;
#endif
void getLightMap() {
	dLightmap = vec3(1.0);
	#ifdef STD_LIGHT_TEXTURE
		dLightmap *= {STD_LIGHT_TEXTURE_DECODE}(texture2DBias({STD_LIGHT_TEXTURE_NAME}, {STD_LIGHT_TEXTURE_UV}, textureBias)).{STD_LIGHT_TEXTURE_CHANNEL};
		#ifdef STD_LIGHTMAP_DIR
			vec3 dir = texture2DBias(texture_dirLightMap, {STD_LIGHT_TEXTURE_UV}, textureBias).xyz * 2.0 - 1.0;
			float dirDot = dot(dir, dir);
			dLightmapDir = (dirDot > 0.001) ? dir / sqrt(dirDot) : vec3(0.0);
		#endif
	#endif
	#ifdef STD_LIGHT_VERTEX
		dLightmap *= saturate(vVertexColor.{STD_LIGHT_VERTEX_CHANNEL});
	#endif
}
`});var EH,vH=m(()=>{EH=`
float calcLightSpecular(float gloss, vec3 worldNormal, vec3 viewDir, vec3 h, vec3 lightDirNorm, mat3 tbn) {
	float PI = 3.141592653589793;
	float roughness = max((1.0 - gloss) * (1.0 - gloss), 0.001);
	float alphaRoughness = roughness * roughness;
	float anisotropy = dAnisotropy;
	vec2 direction = dAnisotropyRotation;
	float at = mix(alphaRoughness, 1.0, anisotropy * anisotropy);
	float ab = clamp(alphaRoughness, 0.001, 1.0);
	vec3 anisotropicT = normalize(tbn * vec3(direction, 0.0));
	vec3 anisotropicB = normalize(cross(tbn[2], anisotropicT));
	float NoH = dot(worldNormal, h);
	float ToH = dot(anisotropicT, h);
	float BoH = dot(anisotropicB, h);
	float a2 = at * ab;
	vec3 v = vec3(ab * ToH, at * BoH, a2 * NoH);
	float v2 = dot(v, v);
	float w2 = a2 / v2;
	float D = a2 * w2 * w2 * (1.0 / PI);
	float ToV = dot(anisotropicT, viewDir);
	float BoV = dot(anisotropicB, viewDir);
	float ToL = dot(anisotropicT, -lightDirNorm);
	float BoL = dot(anisotropicB, -lightDirNorm);
	float NoV = dot(worldNormal, viewDir);
	float NoL = dot(worldNormal, -lightDirNorm);
	float lambdaV = NoL * length(vec3(at * ToV, ab * BoV, NoV));
	float lambdaL = NoV * length(vec3(at * ToL, ab * BoL, NoL));
	float G = 0.5 / (lambdaV + lambdaL);
	return D * G;
}
float getLightSpecular(vec3 h, vec3 reflDir, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float gloss, mat3 tbn) {
	return calcLightSpecular(gloss, worldNormal, viewDir, h, lightDirNorm, tbn);
}
`});var xH,yH=m(()=>{xH=`
float calcLightSpecular(float gloss, vec3 worldNormal, vec3 h) {
	float nh = max( dot( h, worldNormal ), 0.0 );
	float specPow = exp2(gloss * 11.0);
	specPow = max(specPow, 0.0001);
	return pow(nh, specPow) * (specPow + 2.0) / 8.0;
}
float getLightSpecular(vec3 h, vec3 reflDir, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float gloss, mat3 tbn) {
	return calcLightSpecular(gloss, worldNormal, h);
}
`});var AH,PH=m(()=>{AH=`
float sheenD(vec3 normal, vec3 h, float roughness) {
	const float PI = 3.141592653589793;
	float invR = 1.0 / (roughness * roughness);
	float cos2h = max(dot(normal, h), 0.0);
	cos2h *= cos2h;
	float sin2h = max(1.0 - cos2h, 0.0078125);
	return (2.0 + invR) * pow(sin2h, invR * 0.5) / (2.0 * PI);
}
float sheenV(vec3 normal, vec3 viewDir, vec3 light) {
	float NoV = max(dot(normal, viewDir), 0.000001);
	float NoL = max(dot(normal, light), 0.000001);
	return 1.0 / (4.0 * (NoL + NoV - NoL * NoV));
}
float getLightSpecularSheen(vec3 h, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float sheenGloss) {
	float D = sheenD(worldNormal, h, sheenGloss);
	float V = sheenV(worldNormal, viewDir, -lightDirNorm);
	return D * V;
}
`});var RH,CH=m(()=>{RH=`
#ifndef LINEARIZE_DEPTH
#define LINEARIZE_DEPTH
float linearizeDepthWithParams(float z, vec4 cameraParams) {
	if (cameraParams.w == 0.0)
		return (cameraParams.z * cameraParams.y) / (cameraParams.y + z * (cameraParams.z - cameraParams.y));
	else
		return cameraParams.z + z * (cameraParams.y - cameraParams.z);
}
#ifndef CAMERAPLANES
	#define CAMERAPLANES
	uniform vec4 camera_params;
#endif
float linearizeDepth(float z) {
	return linearizeDepthWithParams(z, camera_params);
}
#endif
`});var IH,wH=m(()=>{IH=`
void evaluateBackend() {
	#ifdef LIT_SSAO
		litArgs_ao *= texture2DLod(ssaoTexture, gl_FragCoord.xy * ssaoTextureSizeInv, 0.0).r;
	#endif
	#ifdef LIT_NEEDS_NORMAL
		#ifdef LIT_SPECULAR
			getReflDir(litArgs_worldNormal, dViewDirW, litArgs_gloss, dTBN);
		#endif
		#ifdef LIT_CLEARCOAT
			ccReflDirW = normalize(-reflect(dViewDirW, litArgs_clearcoat_worldNormal));
		#endif
	#endif
	#ifdef LIT_SPECULAR_OR_REFLECTION
		#ifdef LIT_METALNESS
			float f0 = 1.0 / litArgs_ior;
			f0 = (f0 - 1.0) / (f0 + 1.0);
			f0 *= f0;
			litArgs_specularity = getSpecularModulate(litArgs_specularity, litArgs_albedo, litArgs_metalness, f0);
			litArgs_albedo = getAlbedoModulate(litArgs_albedo, litArgs_metalness);
		#endif
		#ifdef LIT_IRIDESCENCE
			vec3 iridescenceFresnel = getIridescence(saturate(dot(dViewDirW, litArgs_worldNormal)), litArgs_specularity, litArgs_iridescence_thickness);
		#endif
	#endif
	#ifdef LIT_ADD_AMBIENT
		addAmbient(litArgs_worldNormal);
		#ifdef LIT_SPECULAR
			dDiffuseLight = dDiffuseLight * (1.0 - litArgs_specularity);
		#endif
		#ifdef LIT_SEPARATE_AMBIENT
			vec3 dAmbientLight = dDiffuseLight;
			dDiffuseLight = vec3(0);
		#endif
	#endif
	#ifndef LIT_OLD_AMBIENT
		dDiffuseLight *= material_ambient;
	#endif
	#ifdef LIT_AO
		#ifndef LIT_OCCLUDE_DIRECT
			occludeDiffuse(litArgs_ao);
		#endif
	#endif
	#ifdef LIT_LIGHTMAP
		addLightMap(
			litArgs_lightmap, 
			litArgs_lightmapDir, 
			litArgs_worldNormal, 
			dViewDirW, 
			dReflDirW, 
			litArgs_gloss, 
			litArgs_specularity, 
			dVertexNormalW,
			dTBN
		#if defined(LIT_IRIDESCENCE)
			, iridescenceFresnel,
			litArgs_iridescence_intensity
		#endif
		);
	#endif
	#ifdef LIT_LIGHTING || LIT_REFLECTIONS
		#ifdef LIT_REFLECTIONS
			#ifdef LIT_CLEARCOAT
				addReflectionCC(ccReflDirW, litArgs_clearcoat_gloss);
			
				#ifdef LIT_SPECULAR_FRESNEL
					ccFresnel = getFresnelCC(dot(dViewDirW, litArgs_clearcoat_worldNormal));
					ccReflection *= ccFresnel;
				#else
					ccFresnel = 0.0;
				#endif
			#endif
			#ifdef LIT_SPECULARITY_FACTOR
				ccReflection *= litArgs_specularityFactor;
			#endif
			#ifdef LIT_SHEEN
				addReflectionSheen(litArgs_worldNormal, dViewDirW, litArgs_sheen_gloss);
			#endif
			addReflection(dReflDirW, litArgs_gloss);
			#ifdef LIT_FRESNEL_MODEL
				dReflection.rgb *= getFresnel(
					dot(dViewDirW, litArgs_worldNormal), 
					litArgs_gloss, 
					litArgs_specularity
				#if defined(LIT_IRIDESCENCE)
					, iridescenceFresnel,
					litArgs_iridescence_intensity
				#endif
					);
			#else
				dReflection.rgb *= litArgs_specularity;
			#endif
			#ifdef LIT_SPECULARITY_FACTOR
				dReflection.rgb *= litArgs_specularityFactor;
			#endif
		#endif
		#ifdef AREA_LIGHTS
			dSpecularLight *= litArgs_specularity;
			#ifdef LIT_SPECULAR
				calcLTCLightValues(litArgs_gloss, litArgs_worldNormal, dViewDirW, litArgs_specularity, litArgs_clearcoat_gloss, litArgs_clearcoat_worldNormal, litArgs_clearcoat_specularity);
			#endif
		#endif
		
		#ifdef LIGHT_COUNT > 0
			#include "lightEvaluationPS, LIGHT_COUNT"
		#endif
		#ifdef LIT_CLUSTERED_LIGHTS
			addClusteredLights(litArgs_worldNormal, dViewDirW, dReflDirW,
				#if defined(LIT_CLEARCOAT)
						ccReflDirW,
				#endif
						litArgs_gloss, litArgs_specularity, dVertexNormalW, dTBN, 
				#if defined(LIT_IRIDESCENCE)
						iridescenceFresnel,
				#endif
						litArgs_clearcoat_worldNormal, litArgs_clearcoat_gloss, litArgs_sheen_gloss, litArgs_iridescence_intensity
			);
		#endif
		#ifdef AREA_LIGHTS
			#ifdef LIT_CLEARCOAT
				litArgs_clearcoat_specularity = 1.0;
			#endif
			#ifdef LIT_SPECULAR
				litArgs_specularity = vec3(1);
			#endif
		#endif
		#ifdef LIT_REFRACTION
			addRefraction(
				litArgs_worldNormal, 
				dViewDirW, 
				litArgs_thickness, 
				litArgs_gloss, 
				litArgs_specularity, 
				litArgs_albedo, 
				litArgs_transmission,
				litArgs_ior,
				litArgs_dispersion
				#if defined(LIT_IRIDESCENCE)
					, iridescenceFresnel, 
					litArgs_iridescence_intensity
				#endif
			);
		#endif
	#endif
	#ifdef LIT_AO
		#ifdef LIT_OCCLUDE_DIRECT
			occludeDiffuse(litArgs_ao);
		#endif
		#if LIT_OCCLUDE_SPECULAR != NONE
			occludeSpecular(litArgs_gloss, litArgs_ao, litArgs_worldNormal, dViewDirW);
		#endif
	#endif
	#ifdef LIT_SPECULARITY_FACTOR
		dSpecularLight *= litArgs_specularityFactor;
	#endif
	#if !defined(LIT_OPACITY_FADES_SPECULAR)
		#if LIT_BLEND_TYPE == NORMAL || LIT_BLEND_TYPE == PREMULTIPLIED
			float specLum = dot((dSpecularLight + dReflection.rgb * dReflection.a), vec3( 0.2126, 0.7152, 0.0722 ));
			#ifdef LIT_CLEARCOAT
				specLum += dot(ccSpecularLight * litArgs_clearcoat_specularity + ccReflection * litArgs_clearcoat_specularity, vec3( 0.2126, 0.7152, 0.0722 ));
			#endif
			litArgs_opacity = clamp(litArgs_opacity + gammaCorrectInput(specLum), 0.0, 1.0);
		#endif
		litArgs_opacity *= material_alphaFade;
	#endif
	#ifdef LIT_LIGHTMAP_BAKING
		#ifdef LIT_LIGHTMAP_BAKING_COLOR
			#include "bakeLmEndPS"
		#endif
		#ifdef LIT_LIGHTMAP_BAKING_DIR
			#include "bakeDirLmEndPS"
		#endif
	#else
		#include "endPS"
		#include "outputAlphaPS"
	#endif
	#ifdef LIT_MSDF
		gl_FragColor = applyMsdf(gl_FragColor);
	#endif
	#include "outputPS"
	#include "debugOutputPS"
	#ifdef LIT_SHADOW_CATCHER
		gl_FragColor.rgb = vec3(dShadowCatcher);
	#endif
}
`});var LH,bH=m(()=>{LH=`
vec3 sReflection;
vec3 dVertexNormalW;
vec3 dTangentW;
vec3 dBinormalW;
vec3 dViewDirW;
vec3 dReflDirW;
vec3 ccReflDirW;
vec3 dLightDirNormW;
float dAtten;
mat3 dTBN;
vec4 dReflection;
vec3 dDiffuseLight;
vec3 dSpecularLight;
float ccFresnel;
vec3 ccReflection;
vec3 ccSpecularLight;
float ccSpecularityNoFres;
vec3 sSpecularLight;
#ifdef LIT_DISPERSION
	uniform float material_dispersion;
#endif
#ifndef LIT_OPACITY_FADES_SPECULAR
	uniform float material_alphaFade;
#endif
#ifdef LIT_SSAO
	uniform sampler2D ssaoTexture;
	uniform vec2 ssaoTextureSizeInv;
#endif
#ifdef LIT_SHADOW_CATCHER
	float dShadowCatcher = 1.0;
#endif
#if LIGHT_COUNT > 0
	#include "lightDeclarationPS, LIGHT_COUNT"
#endif
#ifdef LIT_SPECULAR
	#if LIT_FRESNEL_MODEL == NONE && !defined(LIT_REFLECTIONS) && !defined(LIT_DIFFUSE_MAP) 
		#define LIT_OLD_AMBIENT
	#endif
#endif
#ifdef STD_LIGHTMAP_DIR
	uniform float bakeDir;
#endif
#ifdef LIT_LIGHTMAP_BAKING_ADD_AMBIENT
	uniform float ambientBakeOcclusionContrast;
	uniform float ambientBakeOcclusionBrightness;
#endif
`});var MH,DH=m(()=>{MH=`
void main(void) {
	#include "litUserMainStartPS"
	dReflection = vec4(0);
	#ifdef LIT_CLEARCOAT
		ccSpecularLight = vec3(0);
		ccReflection = vec3(0);
	#endif
	#if LIT_NONE_SLICE_MODE == SLICED
		#include "startNineSlicedPS"
	#elif LIT_NONE_SLICE_MODE == TILED
		#include "startNineSlicedTiledPS"
	#endif
	#ifdef LIT_NEEDS_NORMAL
		dVertexNormalW = normalize(vNormalW);
		#ifdef LIT_TANGENTS
			#if defined(LIT_HEIGHTS) || defined(LIT_USE_NORMALS) || defined(LIT_USE_CLEARCOAT_NORMALS) || defined(LIT_GGX_SPECULAR)
				dTangentW = vTangentW;
				dBinormalW = vBinormalW;
			#endif
		#endif
		getViewDir();
		#ifdef LIT_TBN
			getTBN(dTangentW, dBinormalW, dVertexNormalW);
			#ifdef LIT_TWO_SIDED_LIGHTING
				handleTwoSidedLighting();
			#endif
		#endif
	#endif
	evaluateFrontend();
	#include "debugProcessFrontendPS"
	evaluateBackend();
	#include "litUserMainEndPS"
}
`});var OH,NH=m(()=>{OH=`
#ifdef LIT_NEEDS_NORMAL
	#include "cubeMapRotatePS"
	#include "cubeMapProjectPS"
	#include "envProcPS"
#endif
#ifdef LIT_SPECULAR_OR_REFLECTION
	#ifdef LIT_METALNESS
		#include "metalnessModulatePS"
	#endif
	#if LIT_FRESNEL_MODEL == SCHLICK
		#include "fresnelSchlickPS"
	#endif
	#ifdef LIT_IRIDESCENCE
		#include "iridescenceDiffractionPS"
	#endif
#endif
#ifdef LIT_AO
	#include "aoDiffuseOccPS"
	#include "aoSpecOccPS"
#endif
#if LIT_REFLECTION_SOURCE == ENVATLASHQ
	#include "envAtlasPS"
	#include "reflectionEnvHQPS"
#elif LIT_REFLECTION_SOURCE == ENVATLAS
	#include "envAtlasPS"
	#include "reflectionEnvPS"
#elif LIT_REFLECTION_SOURCE == CUBEMAP
	#include "reflectionCubePS"
#elif LIT_REFLECTION_SOURCE == SPHEREMAP
	#include "reflectionSpherePS"
#endif
#ifdef LIT_REFLECTIONS
	#ifdef LIT_CLEARCOAT
		#include "reflectionCCPS"
	#endif
	#ifdef LIT_SHEEN
		#include "reflectionSheenPS"
	#endif
#endif
#ifdef LIT_REFRACTION
	#if defined(LIT_DYNAMIC_REFRACTION)
		#include "refractionDynamicPS"
	#elif defined(LIT_REFLECTIONS)
		#include "refractionCubePS"
	#endif
#endif
#ifdef LIT_SHEEN
	#include "lightSheenPS"
#endif
uniform vec3 material_ambient;
#ifdef LIT_SPECULAR
	#ifdef LIT_LIGHTING
		#ifdef LIT_GGX_SPECULAR
			#include "lightSpecularAnisoGGXPS"
		#else
			#include "lightSpecularBlinnPS"
		#endif
	#endif
#endif
#include "combinePS"
#ifdef LIT_LIGHTMAP
	#include "lightmapAddPS"
#endif
#ifdef LIT_ADD_AMBIENT
	#include "ambientPS"
#endif
#ifdef LIT_MSDF
	#include "msdfPS"
#endif
#ifdef LIT_NEEDS_NORMAL
	#include "viewDirPS"
	#ifdef LIT_SPECULAR
		#ifdef LIT_GGX_SPECULAR
			#include "reflDirAnisoPS"
		#else
			#include "reflDirPS"
		#endif
	#endif
#endif
#include "lightingPS"
`});var FH,UH=m(()=>{FH=`
#include "basePS"
#include "sphericalPS"
#include "decodePS"
#include "gammaPS"
#include "tonemappingPS"
#include "fogPS"
#if LIT_NONE_SLICE_MODE == SLICED
	#include "baseNineSlicedPS"
#elif LIT_NONE_SLICE_MODE == TILED
	#include "baseNineSlicedTiledPS"
#endif
#ifdef LIT_TBN
	#include "TBNPS"
	#ifdef LIT_TWO_SIDED_LIGHTING
		#include "twoSidedLightingPS"
	#endif
#endif
`});var BH,VH=m(()=>{BH=`
#include "varyingsPS"
#include "litUserDeclarationPS"
#include "frontendDeclPS"
#if defined(PICK_PASS) || defined(PREPASS_PASS)
	#include "frontendCodePS"
	#include "litUserCodePS"
	#include "litOtherMainPS"
#elif defined(SHADOW_PASS)
	#include "frontendCodePS"
	#include "litUserCodePS"
	#include "litShadowMainPS"
#else
	#include "litForwardDeclarationPS"
	#include "litForwardPreCodePS"
	#include "frontendCodePS"
	#include "litForwardPostCodePS"
	#include "litForwardBackendPS"
	#include "litUserCodePS"
	#include "litForwardMainPS"
#endif
`});var kH,GH=m(()=>{kH=`
#include "varyingsVS"
#include  "litUserDeclarationVS"
#ifdef VERTEX_COLOR
	attribute vec4 vertex_color;
#endif
#ifdef NINESLICED
	varying vec2 vMask;
	varying vec2 vTiledUv;
	uniform mediump vec4 innerOffset;
	uniform mediump vec2 outerScale;
	uniform mediump vec4 atlasRect;
#endif
vec3 dPositionW;
mat4 dModelMatrix;
#include "transformCoreVS"
#ifdef UV0
	attribute vec2 vertex_texCoord0;
	#include "uv0VS"
#endif
#ifdef UV1
	attribute vec2 vertex_texCoord1;
	#include "uv1VS"
#endif
#ifdef LINEAR_DEPTH
	#ifndef VIEWMATRIX
	#define VIEWMATRIX
		uniform mat4 matrix_view;
	#endif
#endif
#include "transformVS"
#ifdef NORMALS
	#include "normalCoreVS"
	#include "normalVS"
#endif
#ifdef TANGENTS
	attribute vec4 vertex_tangent;
#endif
#include "uvTransformUniformsPS, UV_TRANSFORMS_COUNT"
#ifdef MSDF
	#include "msdfVS"
#endif
#include  "litUserCodeVS"
void main(void) {
	#include "litUserMainStartVS"
	gl_PointSize = 1.0;
	gl_Position = getPosition();
	vPositionW = getWorldPosition();
	#ifdef NORMALS
		vNormalW = getNormal();
	#endif
	#ifdef TANGENTS
		vTangentW = normalize(dNormalMatrix * vertex_tangent.xyz);
		vBinormalW = cross(vNormalW, vTangentW) * vertex_tangent.w;
	#elif defined(GGX_SPECULAR)
		vObjectSpaceUpW = normalize(dNormalMatrix * vec3(0, 1, 0));
	#endif
	#ifdef UV0
		vec2 uv0 = getUv0();
		#ifdef UV0_UNMODIFIED
			vUv0 = uv0;
		#endif
	#endif
	#ifdef UV1
		vec2 uv1 = getUv1();
		#ifdef UV1_UNMODIFIED
			vUv1 = uv1;
		#endif
	#endif
	#include "uvTransformVS, UV_TRANSFORMS_COUNT"
	#ifdef VERTEX_COLOR
		vVertexColor = vertex_color;
	#endif
	#ifdef LINEAR_DEPTH
		vLinearDepth = -(matrix_view * vec4(vPositionW, 1.0)).z;
	#endif
	#ifdef MSDF
		unpackMsdfParams();
	#endif
	#include "litUserMainEndVS"
}
`});var zH,HH=m(()=>{zH=`
#ifdef PICK_PASS
	#include "pickPS"
#endif
#ifdef PREPASS_PASS
	#include "floatAsUintPS"
#endif
void main(void) {
	#include "litUserMainStartPS"
	evaluateFrontend();
	#ifdef PICK_PASS
		gl_FragColor = getPickOutput();
	#endif
	#ifdef PREPASS_PASS
		gl_FragColor = float2vec4(vLinearDepth);
	#endif
	#include "litUserMainEndPS"
}
`});var XH,WH=m(()=>{XH=`
vec3 litArgs_albedo;
float litArgs_opacity;
vec3 litArgs_emission;
vec3 litArgs_worldNormal;
float litArgs_ao;
vec3 litArgs_lightmap;
vec3 litArgs_lightmapDir;
float litArgs_metalness;
vec3 litArgs_specularity;
float litArgs_specularityFactor;
float litArgs_gloss;
float litArgs_sheen_gloss;
vec3 litArgs_sheen_specularity;
float litArgs_transmission;
float litArgs_thickness;
float litArgs_ior;
float litArgs_dispersion;
float litArgs_iridescence_intensity;
float litArgs_iridescence_thickness;
vec3 litArgs_clearcoat_worldNormal;
float litArgs_clearcoat_specularity;
float litArgs_clearcoat_gloss;
`});var YH,KH=m(()=>{YH=`
	#if LIT_NONE_SLICE_MODE == TILED
		const float textureBias = -1000.0;
	#else
		uniform float textureBias;
	#endif
	#include "litShaderArgsPS"
`});var qH,jH=m(()=>{qH=`
#if LIGHT_TYPE != DIRECTIONAL
	uniform vec3 view_position;
	uniform float light_radius;
#endif
#if SHADOW_TYPE == PCSS_32F
	#include "linearizeDepthPS"
#endif
void main(void) {
	#include "litUserMainStartPS"
	evaluateFrontend();
	#ifdef PERSPECTIVE_DEPTH
		float depth = gl_FragCoord.z;
		#if SHADOW_TYPE == PCSS_32F
			#if LIGHT_TYPE != DIRECTIONAL
				depth = linearizeDepthWithParams(depth, camera_params);
			#endif
		#endif
	#else
		float depth = min(distance(view_position, vPositionW) / light_radius, 0.99999);
		#define MODIFIED_DEPTH
	#endif
	#if SHADOW_TYPE == VSM_16F || SHADOW_TYPE == VSM_32F
		#if SHADOW_TYPE == VSM_32F
			float exponent = 15.0;
		#else
			float exponent = 5.54;
		#endif
		depth = 2.0 * depth - 1.0;
		depth =  exp(exponent * depth);
		gl_FragColor = vec4(depth, depth*depth, 1.0, 1.0);
	#else
		#if SHADOW_TYPE == PCSS_32F
			gl_FragColor.r = depth;
		#else
			#ifdef MODIFIED_DEPTH
				gl_FragDepth = depth;
			#endif
			gl_FragColor = vec4(1.0);
		#endif
	#endif
	#include "litUserMainEndPS"
}
`});var $H,ZH=m(()=>{$H=`
mat3 transposeMat3( const in mat3 m ) {
	mat3 tmp;
	tmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );
	tmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );
	tmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );
	return tmp;
}
vec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {
	const float LUT_SIZE = 64.0;
	const float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;
	const float LUT_BIAS = 0.5 / LUT_SIZE;
	float dotNV = saturate( dot( N, V ) );
	vec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );
	uv = uv * LUT_SCALE + LUT_BIAS;
	return uv;
}
float LTC_ClippedSphereFormFactor( const in vec3 f ) {
	float l = length( f );
	return max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );
}
vec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {
	float x = dot( v1, v2 );
	float y = abs( x );
	float a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;
	float b = 3.4175940 + ( 4.1616724 + y ) * y;
	float v = a / b;
	float theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;
	return cross( v1, v2 ) * theta_sintheta;
}
struct Coords {
	vec3 coord0;
	vec3 coord1;
	vec3 coord2;
	vec3 coord3;
};
float LTC_EvaluateRect( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in Coords rectCoords) {
	vec3 v1 = rectCoords.coord1 - rectCoords.coord0;
	vec3 v2 = rectCoords.coord3 - rectCoords.coord0;
	
	vec3 lightNormal = cross( v1, v2 );
	float factor = sign(-dot( lightNormal, P - rectCoords.coord0 ));
	vec3 T1, T2;
	T1 = normalize( V - N * dot( V, N ) );
	T2 =  factor * cross( N, T1 );
	mat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );
	vec3 coords[ 4 ];
	coords[ 0 ] = mat * ( rectCoords.coord0 - P );
	coords[ 1 ] = mat * ( rectCoords.coord1 - P );
	coords[ 2 ] = mat * ( rectCoords.coord2 - P );
	coords[ 3 ] = mat * ( rectCoords.coord3 - P );
	coords[ 0 ] = normalize( coords[ 0 ] );
	coords[ 1 ] = normalize( coords[ 1 ] );
	coords[ 2 ] = normalize( coords[ 2 ] );
	coords[ 3 ] = normalize( coords[ 3 ] );
	vec3 vectorFormFactor = vec3( 0.0 );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );
	float result = LTC_ClippedSphereFormFactor( vectorFormFactor );
	return result;
}
Coords dLTCCoords;
Coords getLTCLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){
	Coords coords;
	coords.coord0 = lightPos + halfWidth - halfHeight;
	coords.coord1 = lightPos - halfWidth - halfHeight;
	coords.coord2 = lightPos - halfWidth + halfHeight;
	coords.coord3 = lightPos + halfWidth + halfHeight;
	return coords;
}
float dSphereRadius;
Coords getSphereLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){
	dSphereRadius = max(length(halfWidth), length(halfHeight));
	vec3 f = reflect(normalize(lightPos - view_position), vNormalW);
	vec3 w = normalize(cross(f, halfHeight));
	vec3 h = normalize(cross(f, w));
	return getLTCLightCoords(lightPos, w * dSphereRadius, h * dSphereRadius);
}
vec2 dLTCUV;
#ifdef LIT_CLEARCOAT
	vec2 ccLTCUV;
#endif
vec2 getLTCLightUV(float gloss, vec3 worldNormal, vec3 viewDir)
{
	float roughness = max((1.0 - gloss) * (1.0 - gloss), 0.001);
	return LTC_Uv( worldNormal, viewDir, roughness );
}
vec3 dLTCSpecFres;
#ifdef LIT_CLEARCOAT
	vec3 ccLTCSpecFres;
#endif
vec3 getLTCLightSpecFres(vec2 uv, vec3 specularity)
{
	vec4 t2 = texture2DLod(areaLightsLutTex2, uv, 0.0);
	return specularity * t2.x + ( vec3( 1.0 ) - specularity) * t2.y;
}
void calcLTCLightValues(float gloss, vec3 worldNormal, vec3 viewDir, vec3 specularity, float clearcoatGloss, vec3 clearcoatWorldNormal, float clearcoatSpecularity)
{
	dLTCUV = getLTCLightUV(gloss, worldNormal, viewDir);
	dLTCSpecFres = getLTCLightSpecFres(dLTCUV, specularity); 
#ifdef LIT_CLEARCOAT
	ccLTCUV = getLTCLightUV(clearcoatGloss, clearcoatWorldNormal, viewDir);
	ccLTCSpecFres = getLTCLightSpecFres(ccLTCUV, vec3(clearcoatSpecularity));
#endif
}
void calcRectLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight) {
	dLTCCoords = getLTCLightCoords(lightPos, halfWidth, halfHeight);
}
void calcDiskLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight) {
	calcRectLightValues(lightPos, halfWidth, halfHeight);
}
void calcSphereLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight) {
	dLTCCoords = getSphereLightCoords(lightPos, halfWidth, halfHeight);
}
vec3 SolveCubic(vec4 Coefficient)
{
	float pi = 3.14159;
	Coefficient.xyz /= Coefficient.w;
	Coefficient.yz /= 3.0;
	float A = Coefficient.w;
	float B = Coefficient.z;
	float C = Coefficient.y;
	float D = Coefficient.x;
	vec3 Delta = vec3(
		-Coefficient.z * Coefficient.z + Coefficient.y,
		-Coefficient.y * Coefficient.z + Coefficient.x,
		dot(vec2(Coefficient.z, -Coefficient.y), Coefficient.xy)
	);
	float Discriminant = dot(vec2(4.0 * Delta.x, -Delta.y), Delta.zy);
	vec2 xlc, xsc;
	{
		float A_a = 1.0;
		float C_a = Delta.x;
		float D_a = -2.0 * B * Delta.x + Delta.y;
		float Theta = atan(sqrt(Discriminant), -D_a) / 3.0;
		float x_1a = 2.0 * sqrt(-C_a) * cos(Theta);
		float x_3a = 2.0 * sqrt(-C_a) * cos(Theta + (2.0 / 3.0) * pi);
		float xl;
		if ((x_1a + x_3a) > 2.0 * B)
			xl = x_1a;
		else
			xl = x_3a;
		xlc = vec2(xl - B, A);
	}
	{
		float A_d = D;
		float C_d = Delta.z;
		float D_d = -D * Delta.y + 2.0 * C * Delta.z;
		float Theta = atan(D * sqrt(Discriminant), -D_d) / 3.0;
		float x_1d = 2.0 * sqrt(-C_d) * cos(Theta);
		float x_3d = 2.0 * sqrt(-C_d) * cos(Theta + (2.0 / 3.0) * pi);
		float xs;
		if (x_1d + x_3d < 2.0 * C)
			xs = x_1d;
		else
			xs = x_3d;
		xsc = vec2(-D, xs + C);
	}
	float E =  xlc.y * xsc.y;
	float F = -xlc.x * xsc.y - xlc.y * xsc.x;
	float G =  xlc.x * xsc.x;
	vec2 xmc = vec2(C * F - B * G, -B * F + C * E);
	vec3 Root = vec3(xsc.x / xsc.y, xmc.x / xmc.y, xlc.x / xlc.y);
	if (Root.x < Root.y && Root.x < Root.z)
		Root.xyz = Root.yxz;
	else if (Root.z < Root.x && Root.z < Root.y)
		Root.xyz = Root.xzy;
	return Root;
}
float LTC_EvaluateDisk(vec3 N, vec3 V, vec3 P, mat3 Minv, Coords points)
{
	vec3 T1 = normalize(V - N * dot(V, N));
	vec3 T2 = cross(N, T1);
	mat3 R = transposeMat3( mat3( T1, T2, N ) );
	vec3 L_[ 3 ];
	L_[ 0 ] = R * ( points.coord0 - P );
	L_[ 1 ] = R * ( points.coord1 - P );
	L_[ 2 ] = R * ( points.coord2 - P );
	vec3 C  = 0.5 * (L_[0] + L_[2]);
	vec3 V1 = 0.5 * (L_[1] - L_[2]);
	vec3 V2 = 0.5 * (L_[1] - L_[0]);
	C  = Minv * C;
	V1 = Minv * V1;
	V2 = Minv * V2;
	float a, b;
	float d11 = dot(V1, V1);
	float d22 = dot(V2, V2);
	float d12 = dot(V1, V2);
	if (abs(d12) / sqrt(d11 * d22) > 0.0001)
	{
		float tr = d11 + d22;
		float det = -d12 * d12 + d11 * d22;
		det = sqrt(det);
		float u = 0.5 * sqrt(tr - 2.0 * det);
		float v = 0.5 * sqrt(tr + 2.0 * det);
		float e_max = (u + v) * (u + v);
		float e_min = (u - v) * (u - v);
		vec3 V1_, V2_;
		if (d11 > d22)
		{
			V1_ = d12 * V1 + (e_max - d11) * V2;
			V2_ = d12 * V1 + (e_min - d11) * V2;
		}
		else
		{
			V1_ = d12*V2 + (e_max - d22)*V1;
			V2_ = d12*V2 + (e_min - d22)*V1;
		}
		a = 1.0 / e_max;
		b = 1.0 / e_min;
		V1 = normalize(V1_);
		V2 = normalize(V2_);
	}
	else
	{
		a = 1.0 / dot(V1, V1);
		b = 1.0 / dot(V2, V2);
		V1 *= sqrt(a);
		V2 *= sqrt(b);
	}
	vec3 V3 = normalize(cross(V1, V2));
	if (dot(C, V3) < 0.0)
		V3 *= -1.0;
	float L  = dot(V3, C);
	float x0 = dot(V1, C) / L;
	float y0 = dot(V2, C) / L;
	float E1 = inversesqrt(a);
	float E2 = inversesqrt(b);
	a *= L * L;
	b *= L * L;
	float c0 = a * b;
	float c1 = a * b * (1.0 + x0 * x0 + y0 * y0) - a - b;
	float c2 = 1.0 - a * (1.0 + x0 * x0) - b * (1.0 + y0 * y0);
	float c3 = 1.0;
	vec3 roots = SolveCubic(vec4(c0, c1, c2, c3));
	float e1 = roots.x;
	float e2 = roots.y;
	float e3 = roots.z;
	vec3 avgDir = vec3(a * x0 / (a - e2), b * y0 / (b - e2), 1.0);
	mat3 rotate = mat3(V1, V2, V3);
	avgDir = rotate * avgDir;
	avgDir = normalize(avgDir);
	float L1 = sqrt(-e2 / e3);
	float L2 = sqrt(-e2 / e1);
	float formFactor = max(0.0, L1 * L2 * inversesqrt((1.0 + L1 * L1) * (1.0 + L2 * L2)));
	
	const float LUT_SIZE = 64.0;
	const float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;
	const float LUT_BIAS = 0.5 / LUT_SIZE;
	vec2 uv = vec2(avgDir.z * 0.5 + 0.5, formFactor);
	uv = uv*LUT_SCALE + LUT_BIAS;
	float scale = texture2DLod(areaLightsLutTex2, uv, 0.0).w;
	return formFactor*scale;
}
float FixNan(float value) {
	#ifdef WEBGPU
		return value != value ? 0.0 : value;
	#else
		return isnan(value) ? 0.0 : value;
	#endif
}
float getRectLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {
	return LTC_EvaluateRect( worldNormal, viewDir, vPositionW, mat3( 1.0 ), dLTCCoords );
}
float getDiskLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {
	return FixNan(LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, mat3( 1.0 ), dLTCCoords ));
}
float getSphereLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {
	float falloff = dSphereRadius / (dot(lightDir, lightDir) + dSphereRadius);
	return FixNan(getLightDiffuse(worldNormal, viewDir, lightDirNorm) * falloff);
}
mat3 getLTCLightInvMat(vec2 uv)
{
	vec4 t1 = texture2DLod(areaLightsLutTex1, uv, 0.0);
	return mat3(
		vec3( t1.x, 0, t1.y ),
		vec3(	0, 1,	0 ),
		vec3( t1.z, 0, t1.w )
	);
}
float calcRectLightSpecular(vec3 worldNormal, vec3 viewDir, vec2 uv) {
	mat3 mInv = getLTCLightInvMat(uv);
	return LTC_EvaluateRect( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );
}
float getRectLightSpecular(vec3 worldNormal, vec3 viewDir) {
	return calcRectLightSpecular(worldNormal, viewDir, dLTCUV);
}
float calcDiskLightSpecular(vec3 worldNormal, vec3 viewDir, vec2 uv) {
	mat3 mInv = getLTCLightInvMat(uv);
	return LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );
}
float getDiskLightSpecular(vec3 worldNormal, vec3 viewDir) {
	return calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);
}
float getSphereLightSpecular(vec3 worldNormal, vec3 viewDir) {
	return calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);
}
`});var QH,JH=m(()=>{QH=`
#ifdef STD_METALNESS_CONSTANT
uniform float material_metalness;
#endif
void getMetalness() {
	float metalness = 1.0;
	#ifdef STD_METALNESS_CONSTANT
	metalness *= material_metalness;
	#endif
	#ifdef STD_METALNESS_TEXTURE
	metalness *= texture2DBias({STD_METALNESS_TEXTURE_NAME}, {STD_METALNESS_TEXTURE_UV}, textureBias).{STD_METALNESS_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_METALNESS_VERTEX
	metalness *= saturate(vVertexColor.{STD_METALNESS_VERTEX_CHANNEL});
	#endif
	dMetalness = metalness;
}
`});var e4,t4=m(()=>{e4=`
uniform sampler2D texture_msdfMap;
float median(float r, float g, float b) {
	return max(min(r, g), min(max(r, g), b));
}
float map (float min, float max, float v) {
	return (v - min) / (max - min);
}
uniform float font_sdfIntensity;
uniform float font_pxrange;
uniform float font_textureWidth;
#ifndef LIT_MSDF_TEXT_ATTRIBUTE
	uniform vec4 outline_color;
	uniform float outline_thickness;
	uniform vec4 shadow_color;
	uniform vec2 shadow_offset;
#else
	varying vec4 outline_color;
	varying float outline_thickness;
	varying vec4 shadow_color;
	varying vec2 shadow_offset;
#endif
vec4 applyMsdf(vec4 color) {
	color.rgb = gammaCorrectInput(color.rgb);
	vec3 tsample = texture2D(texture_msdfMap, vUv0).rgb;
	vec2 uvShdw = vUv0 - shadow_offset;
	vec3 ssample = texture2D(texture_msdfMap, uvShdw).rgb;
	float sigDist = median(tsample.r, tsample.g, tsample.b);
	float sigDistShdw = median(ssample.r, ssample.g, ssample.b);
	float smoothingMax = 0.2;
	vec2 w = fwidth(vUv0);
	float smoothing = clamp(w.x * font_textureWidth / font_pxrange, 0.0, smoothingMax);
	float mapMin = 0.05;
	float mapMax = clamp(1.0 - font_sdfIntensity, mapMin, 1.0);
	float sigDistInner = map(mapMin, mapMax, sigDist);
	float sigDistOutline = map(mapMin, mapMax, sigDist + outline_thickness);
	sigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thickness);
	float center = 0.5;
	float inside = smoothstep(center-smoothing, center+smoothing, sigDistInner);
	float outline = smoothstep(center-smoothing, center+smoothing, sigDistOutline);
	float shadow = smoothstep(center-smoothing, center+smoothing, sigDistShdw);
	vec4 tcolor = (outline > inside) ? outline * vec4(outline_color.a * outline_color.rgb, outline_color.a) : vec4(0.0);
	tcolor = mix(tcolor, color, inside);
	vec4 scolor = (shadow > outline) ? shadow * vec4(shadow_color.a * shadow_color.rgb, shadow_color.a) : tcolor;
	tcolor = mix(scolor, tcolor, outline);
	tcolor.rgb = gammaCorrectOutput(tcolor.rgb);
	
	return tcolor;
}
`});var s4,i4=m(()=>{s4=`
vec3 getSpecularModulate(in vec3 specularity, in vec3 albedo, in float metalness, in float f0) {
	vec3 dielectricF0 = f0 * specularity;
	return mix(dielectricF0, albedo, metalness);
}
vec3 getAlbedoModulate(in vec3 albedo, in float metalness) {
	return albedo * (1.0 - metalness);
}
`});var r4,a4=m(()=>{r4=`
	varying vec2 uv0;
	uniform sampler2DArray morphTexture;
	uniform highp float morphFactor[{MORPH_TEXTURE_MAX_COUNT}];
	uniform highp uint morphIndex[{MORPH_TEXTURE_MAX_COUNT}];
	uniform int count;
	#ifdef MORPH_INT
		uniform vec3 aabbSize;
		uniform vec3 aabbMin;
	#endif
	void main (void) {
		highp vec3 color = vec3(0, 0, 0);
		ivec2 pixelCoords = ivec2(uv0 * vec2(textureSize(morphTexture, 0).xy));
		
		for (int i = 0; i < count; i++) {
			uint textureIndex = morphIndex[i];
			vec3 delta = texelFetch(morphTexture, ivec3(pixelCoords, int(textureIndex)), 0).xyz;
			color += morphFactor[i] * delta;
		}
		#ifdef MORPH_INT
			color = (color - aabbMin) / aabbSize * 65535.0;
			gl_FragColor = uvec4(color, 1u);
		#else
			gl_FragColor = vec4(color, 1.0);
		#endif
	}
`});var n4,o4=m(()=>{n4=`
	attribute vec2 vertex_position;
	varying vec2 uv0;
	void main(void) {
		gl_Position = vec4(vertex_position, 0.5, 1.0);
		uv0 = vertex_position.xy * 0.5 + 0.5;
	}
`});var l4,h4=m(()=>{l4=`
attribute vec3 vertex_outlineParameters;
attribute vec3 vertex_shadowParameters;
varying vec4 outline_color;
varying float outline_thickness;
varying vec4 shadow_color;
varying vec2 shadow_offset;
void unpackMsdfParams() {
	vec3 little = mod(vertex_outlineParameters, 256.);
	vec3 big = (vertex_outlineParameters - little) / 256.;
	outline_color.rb = little.xy / 255.;
	outline_color.ga = big.xy / 255.;
	outline_thickness = little.z / 255. * 0.2;
	little = mod(vertex_shadowParameters, 256.);
	big = (vertex_shadowParameters - little) / 256.;
	shadow_color.rb = little.xy / 255.;
	shadow_color.ga = big.xy / 255.;
	shadow_offset = (vec2(little.z, big.z) / 127. - 1.) * 0.005;
}
`});var c4,f4=m(()=>{c4=`
mat3 dNormalMatrix;
vec3 getNormal() {
	dNormalMatrix = getNormalMatrix(dModelMatrix);
	vec3 localNormal = getLocalNormal(vertex_normal);
	return normalize(dNormalMatrix * localNormal);
}
`});var d4,u4=m(()=>{d4=`
attribute vec3 vertex_normal;
uniform mat3 matrix_normal;
#ifdef MORPHING_NORMAL
	#ifdef MORPHING_INT
		uniform highp usampler2D morphNormalTex;
	#else
		uniform highp sampler2D morphNormalTex;
	#endif
#endif
vec3 getLocalNormal(vec3 vertexNormal) {
	vec3 localNormal = vertex_normal;
	#ifdef MORPHING_NORMAL
		ivec2 morphUV = getTextureMorphCoords();
		#ifdef MORPHING_INT
			vec3 morphNormal = vec3(texelFetch(morphNormalTex, ivec2(morphUV), 0).xyz) / 65535.0 * 2.0 - 1.0;
		#else
			vec3 morphNormal = texelFetch(morphNormalTex, ivec2(morphUV), 0).xyz;
		#endif
		localNormal += morphNormal;
	#endif
	return localNormal;
}
#if defined(SKIN) || defined(BATCH)
	mat3 getNormalMatrix(mat4 modelMatrix) {
		return mat3(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);
	}
#elif defined(INSTANCING)
	mat3 getNormalMatrix(mat4 modelMatrix) {
		return mat3(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);
	}
#else
	mat3 getNormalMatrix(mat4 modelMatrix) {
		return matrix_normal;
	}
#endif
`});var m4,p4=m(()=>{m4=`
#ifdef STD_NORMAL_TEXTURE
	uniform float material_bumpiness;
#endif
#ifdef STD_NORMALDETAIL_TEXTURE
	uniform float material_normalDetailMapBumpiness;
	vec3 blendNormals(vec3 n1, vec3 n2) {
		n1 += vec3(0, 0, 1);
		n2 *= vec3(-1, -1, 1);
		return n1 * dot(n1, n2) / n1.z - n2;
	}
#endif
void getNormal() {
#ifdef STD_NORMAL_TEXTURE
	vec3 normalMap = {STD_NORMAL_TEXTURE_DECODE}(texture2DBias({STD_NORMAL_TEXTURE_NAME}, {STD_NORMAL_TEXTURE_UV}, textureBias));
	normalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness);
	#ifdef STD_NORMALDETAIL_TEXTURE
		vec3 normalDetailMap = {STD_NORMALDETAIL_TEXTURE_DECODE}(texture2DBias({STD_NORMALDETAIL_TEXTURE_NAME}, {STD_NORMALDETAIL_TEXTURE_UV}, textureBias));
		normalDetailMap = mix(vec3(0.0, 0.0, 1.0), normalDetailMap, material_normalDetailMapBumpiness);
		normalMap = blendNormals(normalMap, normalDetailMap);
	#endif
	dNormalW = normalize(dTBN * normalMap);
#else
	dNormalW = dVertexNormalW;
#endif
}
`});var _4,g4=m(()=>{_4=`
uniform float material_opacity;
void getOpacity() {
	dAlpha = material_opacity;
	#ifdef STD_OPACITY_TEXTURE
	dAlpha *= texture2DBias({STD_OPACITY_TEXTURE_NAME}, {STD_OPACITY_TEXTURE_UV}, textureBias).{STD_OPACITY_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_OPACITY_VERTEX
	dAlpha *= clamp(vVertexColor.{STD_OPACITY_VERTEX_CHANNEL}, 0.0, 1.0);
	#endif
}
`});var S4,T4=m(()=>{S4=`
#if STD_OPACITY_DITHER == BAYER8
	#include "bayerPS"
#endif
uniform vec4 blueNoiseJitter;
#if STD_OPACITY_DITHER == BLUENOISE
	uniform sampler2D blueNoiseTex32;
#endif
void opacityDither(float alpha, float id) {
	#if STD_OPACITY_DITHER == BAYER8
		float noise = bayer8(floor(mod(gl_FragCoord.xy + blueNoiseJitter.xy + id, 8.0))) / 64.0;
	#else
		#if STD_OPACITY_DITHER == BLUENOISE
			vec2 uv = fract(gl_FragCoord.xy / 32.0 + blueNoiseJitter.xy + id);
			float noise = texture2DLod(blueNoiseTex32, uv, 0.0).y;
		#endif
		#if STD_OPACITY_DITHER == IGNNOISE
			vec3 magic = vec3(0.06711056, 0.00583715, 52.9829189);
			float noise = fract(magic.z * fract(dot(gl_FragCoord.xy + blueNoiseJitter.xy + id, magic.xy)));
		#endif
	#endif
	noise = pow(noise, 2.2);
	if (alpha < noise)
		discard;
}
`});var E4,v4=m(()=>{E4=`
`});var x4,y4=m(()=>{x4=`
#if LIT_BLEND_TYPE == NORMAL || LIT_BLEND_TYPE == ADDITIVEALPHA || defined(LIT_ALPHA_TO_COVERAGE)
	gl_FragColor.a = litArgs_opacity;
#elif LIT_BLEND_TYPE == PREMULTIPLIED
	gl_FragColor.rgb *= litArgs_opacity;
	gl_FragColor.a = litArgs_opacity;
#else
	gl_FragColor.a = 1.0;
#endif
`});var A4,P4=m(()=>{A4=`
varying vec2 vUv0;
uniform sampler2D source;
void main(void) {
	gl_FragColor = texture2D(source, vUv0);
}
`});var R4,C4=m(()=>{R4=`
uniform vec3 material_sheen;
void getSheen() {
	vec3 sheenColor = material_sheen;
	#ifdef STD_SHEEN_TEXTURE
	sheenColor *= {STD_SHEEN_TEXTURE_DECODE}(texture2DBias({STD_SHEEN_TEXTURE_NAME}, {STD_SHEEN_TEXTURE_UV}, textureBias)).{STD_SHEEN_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_SHEEN_VERTEX
	sheenColor *= saturate(vVertexColor.{STD_SHEEN_VERTEX_CHANNEL});
	#endif
	sSpecularity = sheenColor;
}
`});var I4,w4=m(()=>{I4=`
uniform float material_sheenGloss;
void getSheenGlossiness() {
	float sheenGlossiness = material_sheenGloss;
	#ifdef STD_SHEENGLOSS_TEXTURE
	sheenGlossiness *= texture2DBias({STD_SHEENGLOSS_TEXTURE_NAME}, {STD_SHEENGLOSS_TEXTURE_UV}, textureBias).{STD_SHEENGLOSS_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_SHEENGLOSS_VERTEX
	sheenGlossiness *= saturate(vVertexColor.{STD_SHEENGLOSS_VERTEX_CHANNEL});
	#endif
	#ifdef STD_SHEENGLOSS_INVERT
	sheenGlossiness = 1.0 - sheenGlossiness;
	#endif
	sGlossiness = sheenGlossiness + 0.0000001;
}
`});var L4,b4=m(()=>{L4=`
uniform float material_heightMapFactor;
void getParallax() {
	float parallaxScale = material_heightMapFactor;
	float height = texture2DBias({STD_HEIGHT_TEXTURE_NAME}, {STD_HEIGHT_TEXTURE_UV}, textureBias).{STD_HEIGHT_TEXTURE_CHANNEL};
	height = height * parallaxScale - parallaxScale * 0.5;
	vec3 viewDirT = dViewDirW * dTBN;
	viewDirT.z += 0.42;
	dUvOffset = height * (viewDirT.xy / viewDirT.z);
}
`});var M4,D4=m(()=>{M4=`
uniform uint meshInstanceId;
vec4 getPickOutput() {
	const vec4 inv = vec4(1.0 / 255.0);
	const uvec4 shifts = uvec4(16, 8, 0, 24);
	uvec4 col = (uvec4(meshInstanceId) >> shifts) & uvec4(0xff);
	return vec4(col) * inv;
}
`});var O4,N4=m(()=>{O4=`
void getReflDir(vec3 worldNormal, vec3 viewDir, float gloss, mat3 tbn) {
	dReflDirW = normalize(-reflect(viewDir, worldNormal));
}
`});var F4,U4=m(()=>{F4=`
void getReflDir(vec3 worldNormal, vec3 viewDir, float gloss, mat3 tbn) {
	float roughness = sqrt(1.0 - min(gloss, 1.0));
	vec2 direction = dAnisotropyRotation;
	vec3 anisotropicT = normalize(tbn * vec3(direction, 0.0));
	vec3 anisotropicB = normalize(cross(tbn[2], anisotropicT));
	float anisotropy = dAnisotropy;
	vec3 anisotropicDirection = anisotropicB;
	vec3 anisotropicTangent = cross(anisotropicDirection, viewDir);
	vec3 anisotropicNormal = cross(anisotropicTangent, anisotropicDirection);
	float bendFactor = 1.0 - anisotropy * (1.0 - roughness);
	float bendFactor4 = bendFactor * bendFactor * bendFactor * bendFactor;
	vec3 bentNormal = normalize(mix(normalize(anisotropicNormal), normalize(worldNormal), bendFactor4));
	dReflDirW = reflect(-viewDir, bentNormal);
}
`});var B4,V4=m(()=>{B4=`
#ifdef LIT_CLEARCOAT
void addReflectionCC(vec3 reflDir, float gloss) {
	ccReflection += calcReflection(reflDir, gloss);
}
#endif
`});var k4,G4=m(()=>{k4=`
uniform samplerCube texture_cubeMap;
uniform float material_reflectivity;
vec3 calcReflection(vec3 reflDir, float gloss) {
	vec3 lookupVec = cubeMapProject(reflDir);
	lookupVec.x *= -1.0;
	return {reflectionDecode}(textureCube(texture_cubeMap, lookupVec));
}
void addReflection(vec3 reflDir, float gloss) {   
	dReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);
}
`});var z4,H4=m(()=>{z4=`
#ifndef ENV_ATLAS
	#define ENV_ATLAS
	uniform sampler2D texture_envAtlas;
#endif
uniform samplerCube texture_cubeMap;
uniform float material_reflectivity;
vec3 calcReflection(vec3 reflDir, float gloss) {
	vec3 dir = cubeMapProject(reflDir) * vec3(-1.0, 1.0, 1.0);
	vec2 uv = toSphericalUv(dir);
	float level = saturate(1.0 - gloss) * 5.0;
	float ilevel = floor(level);
	float flevel = level - ilevel;
	vec3 sharp = {reflectionCubemapDecode}(textureCube(texture_cubeMap, dir));
	vec3 roughA = {reflectionDecode}(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel)));
	vec3 roughB = {reflectionDecode}(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel + 1.0)));
	return processEnvironment(mix(sharp, mix(roughA, roughB, flevel), min(level, 1.0)));
}
void addReflection(vec3 reflDir, float gloss) {   
	dReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);
}
`});var X4,W4=m(()=>{X4=`
#ifndef ENV_ATLAS
#define ENV_ATLAS
	uniform sampler2D texture_envAtlas;
#endif
uniform float material_reflectivity;
float shinyMipLevel(vec2 uv) {
	vec2 dx = dFdx(uv);
	vec2 dy = dFdy(uv);
	vec2 uv2 = vec2(fract(uv.x + 0.5), uv.y);
	vec2 dx2 = dFdx(uv2);
	vec2 dy2 = dFdy(uv2);
	float maxd = min(max(dot(dx, dx), dot(dy, dy)), max(dot(dx2, dx2), dot(dy2, dy2)));
	return clamp(0.5 * log2(maxd) - 1.0 + textureBias, 0.0, 5.0);
}
vec3 calcReflection(vec3 reflDir, float gloss) {
	vec3 dir = cubeMapProject(reflDir) * vec3(-1.0, 1.0, 1.0);
	vec2 uv = toSphericalUv(dir);
	float level = saturate(1.0 - gloss) * 5.0;
	float ilevel = floor(level);
	float level2 = shinyMipLevel(uv * atlasSize);
	float ilevel2 = floor(level2);
	vec2 uv0, uv1;
	float weight;
	if (ilevel == 0.0) {
		uv0 = mapShinyUv(uv, ilevel2);
		uv1 = mapShinyUv(uv, ilevel2 + 1.0);
		weight = level2 - ilevel2;
	} else {
		uv0 = uv1 = mapRoughnessUv(uv, ilevel);
		weight = 0.0;
	}
	vec3 linearA = {reflectionDecode}(texture2D(texture_envAtlas, uv0));
	vec3 linearB = {reflectionDecode}(texture2D(texture_envAtlas, uv1));
	vec3 linear0 = mix(linearA, linearB, weight);
	vec3 linear1 = {reflectionDecode}(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel + 1.0)));
	return processEnvironment(mix(linear0, linear1, level - ilevel));
}
void addReflection(vec3 reflDir, float gloss) {   
	dReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);
}
`});var Y4,K4=m(()=>{Y4=`
#ifndef VIEWMATRIX
	#define VIEWMATRIX
	uniform mat4 matrix_view;
#endif
uniform sampler2D texture_sphereMap;
uniform float material_reflectivity;
vec3 calcReflection(vec3 reflDir, float gloss) {
	vec3 reflDirV = (mat3(matrix_view) * reflDir);
	float m = 2.0 * sqrt(dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z + 1.0) * (reflDirV.z + 1.0));
	vec2 sphereMapUv = reflDirV.xy / m + 0.5;
	return {reflectionDecode}(texture2D(texture_sphereMap, sphereMapUv));
}
void addReflection(vec3 reflDir, float gloss) {   
	dReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);
}
`});var q4,j4=m(()=>{q4=`
void addReflectionSheen(vec3 worldNormal, vec3 viewDir, float gloss) {
	float NoV = dot(worldNormal, viewDir);
	float alphaG = gloss * gloss;
	float a = gloss < 0.25 ? -339.2 * alphaG + 161.4 * gloss - 25.9 : -8.48 * alphaG + 14.3 * gloss - 9.95;
	float b = gloss < 0.25 ? 44.0 * alphaG - 23.7 * gloss + 3.26 : 1.97 * alphaG - 3.27 * gloss + 0.72;
	float DG = exp( a * NoV + b ) + ( gloss < 0.25 ? 0.0 : 0.1 * ( gloss - 0.25 ) );
	sReflection += calcReflection(worldNormal, 0.0) * saturate(DG);
}
`});var $4,Z4=m(()=>{$4=`
vec3 refract2(vec3 viewVec, vec3 normal, float IOR) {
	float vn = dot(viewVec, normal);
	float k = 1.0 - IOR * IOR * (1.0 - vn * vn);
	vec3 refrVec = IOR * viewVec - (IOR * vn + sqrt(k)) * normal;
	return refrVec;
}
void addRefraction(
	vec3 worldNormal, 
	vec3 viewDir, 
	float thickness, 
	float gloss, 
	vec3 specularity, 
	vec3 albedo, 
	float transmission,
	float refractionIndex,
	float dispersion
#if defined(LIT_IRIDESCENCE)
	, vec3 iridescenceFresnel,
	float iridescenceIntensity
#endif 
) {
	vec4 tmpRefl = dReflection;
	vec3 reflectionDir = refract2(-viewDir, worldNormal, refractionIndex);
	dReflection = vec4(0);
	addReflection(reflectionDir, gloss);
	dDiffuseLight = mix(dDiffuseLight, dReflection.rgb * albedo, transmission);
	dReflection = tmpRefl;
}
`});var Q4,J4=m(()=>{Q4=`
uniform float material_invAttenuationDistance;
uniform vec3 material_attenuation;
vec3 evalRefractionColor(vec3 refractionVector, float gloss, float refractionIndex) {
	vec4 pointOfRefraction = vec4(vPositionW + refractionVector, 1.0);
	vec4 projectionPoint = matrix_viewProjection * pointOfRefraction;
	vec2 uv = getGrabScreenPos(projectionPoint);
	float iorToRoughness = (1.0 - gloss) * clamp((1.0 / refractionIndex) * 2.0 - 2.0, 0.0, 1.0);
	float refractionLod = log2(uScreenSize.x) * iorToRoughness;
	vec3 refraction = texture2DLod(uSceneColorMap, uv, refractionLod).rgb;
	return refraction;
}
void addRefraction(
	vec3 worldNormal, 
	vec3 viewDir, 
	float thickness, 
	float gloss, 
	vec3 specularity, 
	vec3 albedo, 
	float transmission,
	float refractionIndex,
	float dispersion
#if defined(LIT_IRIDESCENCE)
	, vec3 iridescenceFresnel,
	float iridescenceIntensity
#endif
) {
	vec3 modelScale;
	modelScale.x = length(vec3(matrix_model[0].xyz));
	modelScale.y = length(vec3(matrix_model[1].xyz));
	modelScale.z = length(vec3(matrix_model[2].xyz));
	vec3 scale = thickness * modelScale;
	vec3 refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndex)) * scale;
	vec3 refraction = evalRefractionColor(refractionVector, gloss, refractionIndex);
	#ifdef LIT_DISPERSION
		float halfSpread = (1.0 / refractionIndex - 1.0) * 0.025 * dispersion;
		float refractionIndexR = refractionIndex - halfSpread;
		refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndexR)) * scale;
		refraction.r = evalRefractionColor(refractionVector, gloss, refractionIndexR).r;
		float refractionIndexB = refractionIndex + halfSpread;
		refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndexB)) * scale;
		refraction.b = evalRefractionColor(refractionVector, gloss, refractionIndexB).b;
	#endif
	vec3 transmittance;
	if (material_invAttenuationDistance != 0.0)
	{
		vec3 attenuation = -log(material_attenuation) * material_invAttenuationDistance;
		transmittance = exp(-attenuation * length(refractionVector));
	}
	else
	{
		transmittance = refraction;
	}
	vec3 fresnel = vec3(1.0) - 
		getFresnel(
			dot(viewDir, worldNormal), 
			gloss, 
			specularity
		#if defined(LIT_IRIDESCENCE)
			, iridescenceFresnel,
			iridescenceIntensity
		#endif
		);
	dDiffuseLight = mix(dDiffuseLight, refraction * transmittance * fresnel, transmission);
}
`});var e5,t5=m(()=>{e5=`
varying vec2 vUv0;
#ifdef CUBEMAP_SOURCE
	uniform samplerCube sourceCube;
#else
	uniform sampler2D sourceTex;
#endif
#ifdef USE_SAMPLES_TEX
	uniform sampler2D samplesTex;
	uniform vec2 samplesTexInverseSize;
#endif
uniform vec3 params;
float targetFace() { return params.x; }
float targetTotalPixels() { return params.y; }
float sourceTotalPixels() { return params.z; }
float PI = 3.141592653589793;
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
#include "decodePS"
#include "encodePS"
vec3 modifySeams(vec3 dir, float scale) {
	vec3 adir = abs(dir);
	float M = max(max(adir.x, adir.y), adir.z);
	return dir / M * vec3(
		adir.x == M ? 1.0 : scale,
		adir.y == M ? 1.0 : scale,
		adir.z == M ? 1.0 : scale
	);
}
vec2 toSpherical(vec3 dir) {
	return vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));
}
vec3 fromSpherical(vec2 uv) {
	return vec3(cos(uv.y) * sin(uv.x),
				sin(uv.y),
				cos(uv.y) * cos(uv.x));
}
vec3 getDirectionEquirect() {
	return fromSpherical((vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0) * vec2(PI, PI * 0.5));
}
float signNotZero(float k){
	return(k >= 0.0) ? 1.0 : -1.0;
}
vec2 signNotZero(vec2 v) {
	return vec2(signNotZero(v.x), signNotZero(v.y));
}
vec3 octDecode(vec2 o) {
	vec3 v = vec3(o.x, 1.0 - abs(o.x) - abs(o.y), o.y);
	if (v.y < 0.0) {
		v.xz = (1.0 - abs(v.zx)) * signNotZero(v.xz);
	}
	return normalize(v);
}
vec3 getDirectionOctahedral() {
	return octDecode(vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0);
}
vec2 octEncode(in vec3 v) {
	float l1norm = abs(v.x) + abs(v.y) + abs(v.z);
	vec2 result = v.xz * (1.0 / l1norm);
	if (v.y < 0.0) {
		result = (1.0 - abs(result.yx)) * signNotZero(result.xy);
	}
	return result;
}
#ifdef CUBEMAP_SOURCE
	vec4 sampleCubemap(vec3 dir) {
		return textureCube(sourceCube, modifySeams(dir, 1.0));
	}
	vec4 sampleCubemap(vec2 sph) {
		return sampleCubemap(fromSpherical(sph));
	}
	vec4 sampleCubemap(vec3 dir, float mipLevel) {
		return textureCubeLod(sourceCube, modifySeams(dir, 1.0), mipLevel);
	}
	vec4 sampleCubemap(vec2 sph, float mipLevel) {
		return sampleCubemap(fromSpherical(sph), mipLevel);
	}
#else
	vec4 sampleEquirect(vec2 sph) {
		vec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;
		return texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));
	}
	vec4 sampleEquirect(vec3 dir) {
		return sampleEquirect(toSpherical(dir));
	}
	vec4 sampleEquirect(vec2 sph, float mipLevel) {
		vec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;
		return texture2DLod(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);
	}
	vec4 sampleEquirect(vec3 dir, float mipLevel) {
		return sampleEquirect(toSpherical(dir), mipLevel);
	}
	vec4 sampleOctahedral(vec3 dir) {
		vec2 uv = octEncode(dir) * 0.5 + 0.5;
		return texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));
	}
	vec4 sampleOctahedral(vec2 sph) {
		return sampleOctahedral(fromSpherical(sph));
	}
	vec4 sampleOctahedral(vec3 dir, float mipLevel) {
		vec2 uv = octEncode(dir) * 0.5 + 0.5;
		return texture2DLod(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);
	}
	vec4 sampleOctahedral(vec2 sph, float mipLevel) {
		return sampleOctahedral(fromSpherical(sph), mipLevel);
	}
#endif
vec3 getDirectionCubemap() {
	vec2 st = vUv0 * 2.0 - 1.0;
	float face = targetFace();
	vec3 vec;
	if (face == 0.0) {
		vec = vec3(1, -st.y, -st.x);
	} else if (face == 1.0) {
		vec = vec3(-1, -st.y, st.x);
	} else if (face == 2.0) {
		vec = vec3(st.x, 1, st.y);
	} else if (face == 3.0) {
		vec = vec3(st.x, -1, -st.y);
	} else if (face == 4.0) {
		vec = vec3(st.x, -st.y, 1);
	} else {
		vec = vec3(-st.x, -st.y, -1);
	}
	return normalize(modifySeams(vec, 1.0));
}
mat3 matrixFromVector(vec3 n) {
	float a = 1.0 / (1.0 + n.z);
	float b = -n.x * n.y * a;
	vec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);
	vec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);
	return mat3(b1, b2, n);
}
mat3 matrixFromVectorSlow(vec3 n) {
	vec3 up = (1.0 - abs(n.y) <= 0.0000001) ? vec3(0.0, 0.0, n.y > 0.0 ? 1.0 : -1.0) : vec3(0.0, 1.0, 0.0);
	vec3 x = normalize(cross(up, n));
	vec3 y = cross(n, x);
	return mat3(x, y, n);
}
vec4 reproject() {
	if ({NUM_SAMPLES} <= 1) {
		return {ENCODE_FUNC}({DECODE_FUNC}({SOURCE_FUNC}({TARGET_FUNC}())));
	} else {
		vec3 t = {TARGET_FUNC}();
		vec3 tu = dFdx(t);
		vec3 tv = dFdy(t);
		vec3 result = vec3(0.0);
		for (float u = 0.0; u < {NUM_SAMPLES_SQRT}; ++u) {
			for (float v = 0.0; v < {NUM_SAMPLES_SQRT}; ++v) {
				result += {DECODE_FUNC}({SOURCE_FUNC}(normalize(t +
															tu * (u / {NUM_SAMPLES_SQRT} - 0.5) +
															tv * (v / {NUM_SAMPLES_SQRT} - 0.5))));
			}
		}
		return {ENCODE_FUNC}(result / ({NUM_SAMPLES_SQRT} * {NUM_SAMPLES_SQRT}));
	}
}
vec4 unpackFloat = vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0);
#ifdef USE_SAMPLES_TEX
	void unpackSample(int i, out vec3 L, out float mipLevel) {
		float u = (float(i * 4) + 0.5) * samplesTexInverseSize.x;
		float v = (floor(u) + 0.5) * samplesTexInverseSize.y;
		vec4 raw;
		raw.x = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;
		raw.y = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;
		raw.z = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;
		raw.w = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat);
		L.xyz = raw.xyz * 2.0 - 1.0;
		mipLevel = raw.w * 8.0;
	}
	vec4 prefilterSamples() {
		mat3 vecSpace = matrixFromVectorSlow({TARGET_FUNC}());
		vec3 L;
		float mipLevel;
		vec3 result = vec3(0.0);
		float totalWeight = 0.0;
		for (int i = 0; i < {NUM_SAMPLES}; ++i) {
			unpackSample(i, L, mipLevel);
			result += {DECODE_FUNC}({SOURCE_FUNC}(vecSpace * L, mipLevel)) * L.z;
			totalWeight += L.z;
		}
		return {ENCODE_FUNC}(result / totalWeight);
	}
	vec4 prefilterSamplesUnweighted() {
		mat3 vecSpace = matrixFromVectorSlow({TARGET_FUNC}());
		vec3 L;
		float mipLevel;
		vec3 result = vec3(0.0);
		float totalWeight = 0.0;
		for (int i = 0; i < {NUM_SAMPLES}; ++i) {
			unpackSample(i, L, mipLevel);
			result += {DECODE_FUNC}({SOURCE_FUNC}(vecSpace * L, mipLevel));
		}
		return {ENCODE_FUNC}(result / float({NUM_SAMPLES}));
	}
#endif
void main(void) {
	gl_FragColor = {PROCESS_FUNC}();
}
`});var s5,i5=m(()=>{s5=`
attribute vec2 vertex_position;
uniform vec4 uvMod;
varying vec2 vUv0;
void main(void) {
	gl_Position = vec4(vertex_position, 0.5, 1.0);
	vUv0 = getImageEffectUV((vertex_position.xy * 0.5 + 0.5) * uvMod.xy + uvMod.zw);
}
`});var r5,a5=m(()=>{r5=`
uniform highp sampler2D uSceneDepthMap;
#ifndef SCREENSIZE
	#define SCREENSIZE
	uniform vec4 uScreenSize;
#endif
#ifndef VIEWMATRIX
	#define VIEWMATRIX
	uniform mat4 matrix_view;
#endif
#ifndef LINEARIZE_DEPTH
	#define LINEARIZE_DEPTH
	
	#ifndef CAMERAPLANES
		#define CAMERAPLANES
		uniform vec4 camera_params;
	#endif
	float linearizeDepth(float z) {
		if (camera_params.w == 0.0)
			return (camera_params.z * camera_params.y) / (camera_params.y + z * (camera_params.z - camera_params.y));
		else
			return camera_params.z + z * (camera_params.y - camera_params.z);
	}
#endif
float delinearizeDepth(float linearDepth) {
	if (camera_params.w == 0.0) {
		return (camera_params.y * (camera_params.z - linearDepth)) / (linearDepth * (camera_params.z - camera_params.y));
	} else {
		return (linearDepth - camera_params.z) / (camera_params.y - camera_params.z);
	}
}
float getLinearScreenDepth(vec2 uv) {
	#ifdef SCENE_DEPTHMAP_LINEAR
		#ifdef SCENE_DEPTHMAP_FLOAT
			return texture2D(uSceneDepthMap, uv).r;
		#else
			ivec2 textureSize = textureSize(uSceneDepthMap, 0);
			ivec2 texel = ivec2(uv * vec2(textureSize));
			vec4 data = texelFetch(uSceneDepthMap, texel, 0);
			uint intBits = 
				(uint(data.r * 255.0) << 24u) |
				(uint(data.g * 255.0) << 16u) |
				(uint(data.b * 255.0) << 8u) |
				uint(data.a * 255.0);
			return uintBitsToFloat(intBits);
		#endif
	#else
		return linearizeDepth(texture2D(uSceneDepthMap, uv).r);
	#endif
}
#ifndef VERTEXSHADER
	float getLinearScreenDepth() {
		vec2 uv = gl_FragCoord.xy * uScreenSize.zw;
		return getLinearScreenDepth(uv);
	}
#endif
float getLinearDepth(vec3 pos) {
	return -(matrix_view * vec4(pos, 1.0)).z;
}
`});var n5,o5=m(()=>{n5=`
int getShadowCascadeIndex(vec4 shadowCascadeDistances, int shadowCascadeCount) {
	float depth = 1.0 / gl_FragCoord.w;
	vec4 comparisons = step(shadowCascadeDistances, vec4(depth));
	int cascadeIndex = int(dot(comparisons, vec4(1.0)));
	return min(cascadeIndex, shadowCascadeCount - 1);
}
int ditherShadowCascadeIndex(int cascadeIndex, vec4 shadowCascadeDistances, int shadowCascadeCount, float blendFactor) {
 
	if (cascadeIndex < shadowCascadeCount - 1) {
		float currentRangeEnd = shadowCascadeDistances[cascadeIndex];
		float transitionStart = blendFactor * currentRangeEnd;
		float depth = 1.0 / gl_FragCoord.w;
		if (depth > transitionStart) {
			float transitionFactor = smoothstep(transitionStart, currentRangeEnd, depth);
			float dither = fract(sin(dot(gl_FragCoord.xy, vec2(12.9898, 78.233))) * 43758.5453);
			if (dither < transitionFactor) {
				cascadeIndex += 1;
			}
		}
	}
	return cascadeIndex;
}
vec3 fadeShadow(vec3 shadowCoord, vec4 shadowCascadeDistances) {				  
	float depth = 1.0 / gl_FragCoord.w;
	if (depth > shadowCascadeDistances.w) {
		shadowCoord.z = -9999999.0;
	}
	return shadowCoord;
}
`});var l5,h5=m(()=>{l5=`
float linstep(float a, float b, float v) {
	return saturate((v - a) / (b - a));
}
float reduceLightBleeding(float pMax, float amount) {
	 return linstep(amount, 1.0, pMax);
}
float chebyshevUpperBound(vec2 moments, float mean, float minVariance, float lightBleedingReduction) {
	float variance = moments.y - (moments.x * moments.x);
	variance = max(variance, minVariance);
	float d = mean - moments.x;
	float pMax = variance / (variance + (d * d));
	pMax = reduceLightBleeding(pMax, lightBleedingReduction);
	return (mean <= moments.x ? 1.0 : pMax);
}
float calculateEVSM(vec3 moments, float Z, float vsmBias, float exponent) {
	Z = 2.0 * Z - 1.0;
	float warpedDepth = exp(exponent * Z);
	moments.xy += vec2(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments.z);
	float VSMBias = vsmBias;
	float depthScale = VSMBias * exponent * warpedDepth;
	float minVariance1 = depthScale * depthScale;
	return chebyshevUpperBound(moments.xy, warpedDepth, minVariance1, 0.1);
}
float VSM16(TEXTURE_ACCEPT(tex), vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {
	vec3 moments = texture2DLod(tex, texCoords, 0.0).xyz;
	return calculateEVSM(moments, Z, vsmBias, exponent);
}
float getShadowVSM16(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent) {
	return VSM16(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);
}
float getShadowSpotVSM16(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {
	return VSM16(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, length(lightDir) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);
}
float VSM32(TEXTURE_ACCEPT(tex), vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {
	#ifdef CAPS_TEXTURE_FLOAT_FILTERABLE
		vec3 moments = texture2DLod(tex, texCoords, 0.0).xyz;
	#else
		float pixelSize = 1.0 / resolution;
		texCoords -= vec2(pixelSize);
		vec3 s00 = texture2DLod(tex, texCoords, 0.0).xyz;
		vec3 s10 = texture2DLod(tex, texCoords + vec2(pixelSize, 0), 0.0).xyz;
		vec3 s01 = texture2DLod(tex, texCoords + vec2(0, pixelSize), 0.0).xyz;
		vec3 s11 = texture2DLod(tex, texCoords + vec2(pixelSize), 0.0).xyz;
		vec2 fr = fract(texCoords * resolution);
		vec3 h0 = mix(s00, s10, fr.x);
		vec3 h1 = mix(s01, s11, fr.x);
		vec3 moments = mix(h0, h1, fr.y);
	#endif
	return calculateEVSM(moments, Z, vsmBias, exponent);
}
float getShadowVSM32(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent) {
	return VSM32(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);
}
float getShadowSpotVSM32(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {
	float Z = length(lightDir) * shadowParams.w + shadowParams.z;
	return VSM32(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, Z, shadowParams.y, exponent);
}
`});var c5,f5=m(()=>{c5=`
float getShadowPCF1x1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return textureShadow(shadowMap, shadowCoord);
}
float getShadowSpotPCF1x1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return textureShadow(shadowMap, shadowCoord);
}
#ifndef WEBGPU
float getShadowOmniPCF1x1(samplerCubeShadow shadowMap, vec3 shadowCoord, vec4 shadowParams, vec3 lightDir) {
	float shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;
	return texture(shadowMap, vec4(lightDir, shadowZ));
}
#endif
`});var d5,u5=m(()=>{d5=`
float _getShadowPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec3 shadowParams) {
	float z = shadowCoord.z;
	vec2 uv = shadowCoord.xy * shadowParams.x;
	float shadowMapSizeInv = 1.0 / shadowParams.x;
	vec2 base_uv = floor(uv + 0.5);
	float s = (uv.x + 0.5 - base_uv.x);
	float t = (uv.y + 0.5 - base_uv.y); 
	base_uv -= vec2(0.5);
	base_uv *= shadowMapSizeInv;
	float sum = 0.0;
	float uw0 = (3.0 - 2.0 * s);
	float uw1 = (1.0 + 2.0 * s);
	float u0 = (2.0 - s) / uw0 - 1.0;
	float u1 = s / uw1 + 1.0;
	float vw0 = (3.0 - 2.0 * t);
	float vw1 = (1.0 + 2.0 * t);
	float v0 = (2.0 - t) / vw0 - 1.0;
	float v1 = t / vw1 + 1.0;
	u0 = u0 * shadowMapSizeInv + base_uv.x;
	v0 = v0 * shadowMapSizeInv + base_uv.y;
	u1 = u1 * shadowMapSizeInv + base_uv.x;
	v1 = v1 * shadowMapSizeInv + base_uv.y;
	sum += uw0 * vw0 * textureShadow(shadowMap, vec3(u0, v0, z));
	sum += uw1 * vw0 * textureShadow(shadowMap, vec3(u1, v0, z));
	sum += uw0 * vw1 * textureShadow(shadowMap, vec3(u0, v1, z));
	sum += uw1 * vw1 * textureShadow(shadowMap, vec3(u1, v1, z));
	sum *= 1.0f / 16.0;
	return sum;
}
float getShadowPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return _getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);
}
float getShadowSpotPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return _getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);
}
#ifndef WEBGPU
float getShadowOmniPCF3x3(samplerCubeShadow shadowMap, vec4 shadowParams, vec3 dir) {
	
	float shadowZ = length(dir) * shadowParams.w + shadowParams.z;
	float z = 1.0 / float(textureSize(shadowMap, 0));
	vec3 tc = normalize(dir);
	mediump vec4 shadows;
	shadows.x = texture(shadowMap, vec4(tc + vec3( z, z, z), shadowZ));
	shadows.y = texture(shadowMap, vec4(tc + vec3(-z,-z, z), shadowZ));
	shadows.z = texture(shadowMap, vec4(tc + vec3(-z, z,-z), shadowZ));
	shadows.w = texture(shadowMap, vec4(tc + vec3( z,-z,-z), shadowZ));
	return dot(shadows, vec4(0.25));
}
float getShadowOmniPCF3x3(samplerCubeShadow shadowMap, vec3 shadowCoord, vec4 shadowParams, vec3 lightDir) {
	return getShadowOmniPCF3x3(shadowMap, shadowParams, lightDir);
}
#endif
`});var m5,p5=m(()=>{m5=`
float _getShadowPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec3 shadowParams) {
	float z = shadowCoord.z;
	vec2 uv = shadowCoord.xy * shadowParams.x;
	float shadowMapSizeInv = 1.0 / shadowParams.x;
	vec2 base_uv = floor(uv + 0.5);
	float s = (uv.x + 0.5 - base_uv.x);
	float t = (uv.y + 0.5 - base_uv.y);
	base_uv -= vec2(0.5);
	base_uv *= shadowMapSizeInv;
	float uw0 = (4.0 - 3.0 * s);
	float uw1 = 7.0;
	float uw2 = (1.0 + 3.0 * s);
	float u0 = (3.0 - 2.0 * s) / uw0 - 2.0;
	float u1 = (3.0 + s) / uw1;
	float u2 = s / uw2 + 2.0;
	float vw0 = (4.0 - 3.0 * t);
	float vw1 = 7.0;
	float vw2 = (1.0 + 3.0 * t);
	float v0 = (3.0 - 2.0 * t) / vw0 - 2.0;
	float v1 = (3.0 + t) / vw1;
	float v2 = t / vw2 + 2.0;
	float sum = 0.0;
	u0 = u0 * shadowMapSizeInv + base_uv.x;
	v0 = v0 * shadowMapSizeInv + base_uv.y;
	u1 = u1 * shadowMapSizeInv + base_uv.x;
	v1 = v1 * shadowMapSizeInv + base_uv.y;
	u2 = u2 * shadowMapSizeInv + base_uv.x;
	v2 = v2 * shadowMapSizeInv + base_uv.y;
	sum += uw0 * vw0 * textureShadow(shadowMap, vec3(u0, v0, z));
	sum += uw1 * vw0 * textureShadow(shadowMap, vec3(u1, v0, z));
	sum += uw2 * vw0 * textureShadow(shadowMap, vec3(u2, v0, z));
	sum += uw0 * vw1 * textureShadow(shadowMap, vec3(u0, v1, z));
	sum += uw1 * vw1 * textureShadow(shadowMap, vec3(u1, v1, z));
	sum += uw2 * vw1 * textureShadow(shadowMap, vec3(u2, v1, z));
	sum += uw0 * vw2 * textureShadow(shadowMap, vec3(u0, v2, z));
	sum += uw1 * vw2 * textureShadow(shadowMap, vec3(u1, v2, z));
	sum += uw2 * vw2 * textureShadow(shadowMap, vec3(u2, v2, z));
	sum *= 1.0f / 144.0;
	sum = saturate(sum);
	return sum;
}
float getShadowPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return _getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);
}
float getShadowSpotPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return _getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);
}
`});var _5,g5=m(()=>{_5=`
#define PCSS_SAMPLE_COUNT 16
uniform float pcssDiskSamples[PCSS_SAMPLE_COUNT];
uniform float pcssSphereSamples[PCSS_SAMPLE_COUNT];
vec2 vogelDisk(int sampleIndex, float count, float phi, float r) {
	const float GoldenAngle = 2.4;
	float theta = float(sampleIndex) * GoldenAngle + phi;
	float sine = sin(theta);
	float cosine = cos(theta);
	return vec2(r * cosine, r * sine);
}
vec3 vogelSphere(int sampleIndex, float count, float phi, float r) {
	const float GoldenAngle = 2.4;
	float theta = float(sampleIndex) * GoldenAngle + phi;
	float weight = float(sampleIndex) / count;
	return vec3(cos(theta) * r, weight, sin(theta) * r);
}
float noise(vec2 screenPos) {
	const float PHI = 1.61803398874989484820459;
	return fract(sin(dot(screenPos * PHI, screenPos)) * screenPos.x);
}
float viewSpaceDepth(float depth, mat4 invProjection) {
	float z = depth * 2.0 - 1.0;
	vec4 clipSpace = vec4(0.0, 0.0, z, 1.0);
	vec4 viewSpace = invProjection * clipSpace;
	return viewSpace.z;
}
float PCSSBlockerDistance(TEXTURE_ACCEPT(shadowMap), vec2 sampleCoords[PCSS_SAMPLE_COUNT], vec2 shadowCoords, vec2 searchSize, float z, vec4 cameraParams) {
	float blockers = 0.0;
	float averageBlocker = 0.0;
	for (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {
		vec2 offset = sampleCoords[i] * searchSize;
		vec2 sampleUV = shadowCoords + offset;
		float blocker = texture2DLod(shadowMap, sampleUV, 0.0).r;
		float isBlocking = step(blocker, z);
		blockers += isBlocking;
		averageBlocker += blocker * isBlocking;
	}
	if (blockers > 0.0)
		return averageBlocker / blockers;
	return -1.0;
}
float PCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoords, vec4 cameraParams, vec2 shadowSearchArea) {
	float receiverDepth = linearizeDepthWithParams(shadowCoords.z, cameraParams);
	vec2 samplePoints[PCSS_SAMPLE_COUNT];
	const float PI = 3.141592653589793;
	float noise = noise( gl_FragCoord.xy ) * 2.0 * PI;
	for (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {
		float pcssPresample = pcssDiskSamples[i];
		samplePoints[i] = vogelDisk(i, float(PCSS_SAMPLE_COUNT), noise, pcssPresample);
	}
	float averageBlocker = PCSSBlockerDistance(TEXTURE_PASS(shadowMap), samplePoints, shadowCoords.xy, shadowSearchArea, receiverDepth, cameraParams);
	if (averageBlocker == -1.0) {
		return 1.0;
	} else {
		float depthDifference = (receiverDepth - averageBlocker) / 3.0;
		vec2 filterRadius = depthDifference * shadowSearchArea;
		float shadow = 0.0;
		for (int i = 0; i < PCSS_SAMPLE_COUNT; i ++)
		{
			vec2 sampleUV = samplePoints[i] * filterRadius;
			sampleUV = shadowCoords.xy + sampleUV;
			float depth = texture2DLod(shadowMap, sampleUV, 0.0).r;
			shadow += step(receiverDepth, depth);
		}
		return shadow / float(PCSS_SAMPLE_COUNT);
	} 
}
#ifndef WEBGPU
float PCSSCubeBlockerDistance(samplerCube shadowMap, vec3 lightDirNorm, vec3 samplePoints[PCSS_SAMPLE_COUNT], float z, float shadowSearchArea) {
	float blockers = 0.0;
	float averageBlocker = 0.0;
	for (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {
		vec3 sampleDir = lightDirNorm + samplePoints[i] * shadowSearchArea;
		sampleDir = normalize(sampleDir);
		float blocker = textureCubeLod(shadowMap, sampleDir, 0.0).r;
		float isBlocking = step(blocker, z);
		blockers += isBlocking;
		averageBlocker += blocker * isBlocking;
	}
	if (blockers > 0.0)
		return averageBlocker / blockers;
	return -1.0;
}
float PCSSCube(samplerCube shadowMap, vec4 shadowParams, vec3 shadowCoords, vec4 cameraParams, float shadowSearchArea, vec3 lightDir) {
	
	vec3 samplePoints[PCSS_SAMPLE_COUNT];
	const float PI = 3.141592653589793;
	float noise = noise( gl_FragCoord.xy ) * 2.0 * PI;
	for (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {
		float r = pcssSphereSamples[i];
		samplePoints[i] = vogelSphere(i, float(PCSS_SAMPLE_COUNT), noise, r);
	}
	float receiverDepth = length(lightDir) * shadowParams.w + shadowParams.z;
	vec3 lightDirNorm = normalize(lightDir);
	
	float averageBlocker = PCSSCubeBlockerDistance(shadowMap, lightDirNorm, samplePoints, receiverDepth, shadowSearchArea);
	if (averageBlocker == -1.0) {
		return 1.0;
	} else {
		float filterRadius = ((receiverDepth - averageBlocker) / averageBlocker) * shadowSearchArea;
		float shadow = 0.0;
		for (int i = 0; i < PCSS_SAMPLE_COUNT; i++)
		{
			vec3 offset = samplePoints[i] * filterRadius;
			vec3 sampleDir = lightDirNorm + offset;
			sampleDir = normalize(sampleDir);
			float depth = textureCubeLod(shadowMap, sampleDir, 0.0).r;
			shadow += step(receiverDepth, depth);
		}
		return shadow / float(PCSS_SAMPLE_COUNT);
	}
}
float getShadowOmniPCSS(samplerCube shadowMap, vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec2 shadowSearchArea, vec3 lightDir) {
	return PCSSCube(shadowMap, shadowParams, shadowCoord, cameraParams, shadowSearchArea.x, lightDir);
}
#endif
float getShadowSpotPCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec2 shadowSearchArea, vec3 lightDir) {
	return PCSS(TEXTURE_PASS(shadowMap), shadowCoord, cameraParams, shadowSearchArea);
}
`});var S5,T5=m(()=>{S5=`
highp float fractSinRand(const in vec2 uv) {
	const float PI = 3.141592653589793;
	const highp float a = 12.9898, b = 78.233, c = 43758.5453;
	highp float dt = dot(uv.xy, vec2(a, b)), sn = mod(dt, PI);
	return fract(sin(sn) * c);
}
struct VogelDiskData {
	float invNumSamples;
	float initialAngle;
	float currentPointId;
};
void prepareDiskConstants(out VogelDiskData data, int sampleCount, float randomSeed) {
	const float pi2 = 6.28318530718;
	data.invNumSamples = 1.0 / float(sampleCount);
	data.initialAngle = randomSeed * pi2;
	data.currentPointId = 0.0;
}
vec2 generateDiskSample(inout VogelDiskData data) {
	const float GOLDEN_ANGLE = 2.399963;
	float r = sqrt((data.currentPointId + 0.5) * data.invNumSamples);
	float theta = data.currentPointId * GOLDEN_ANGLE + data.initialAngle;
	vec2 offset = vec2(cos(theta), sin(theta)) * pow(r, 1.33);
	data.currentPointId += 1.0;
	return offset;
}
void PCSSFindBlocker(TEXTURE_ACCEPT(shadowMap), out float avgBlockerDepth, out int numBlockers,
	vec2 shadowCoords, float z, int shadowBlockerSamples, float penumbraSize, float invShadowMapSize, float randomSeed) {
	VogelDiskData diskData;
	prepareDiskConstants(diskData, shadowBlockerSamples, randomSeed);
	float searchWidth = penumbraSize * invShadowMapSize;
	float blockerSum = 0.0;
	numBlockers = 0;
	for( int i = 0; i < shadowBlockerSamples; ++i ) {
		vec2 diskUV = generateDiskSample(diskData);
		vec2 sampleUV = shadowCoords + diskUV * searchWidth;
		float shadowMapDepth = texture2DLod(shadowMap, sampleUV, 0.0).r;
		if ( shadowMapDepth < z ) {
			blockerSum += shadowMapDepth;
			numBlockers++;
		}
	}
	avgBlockerDepth = blockerSum / float(numBlockers);
}
float PCSSFilter(TEXTURE_ACCEPT(shadowMap), vec2 uv, float receiverDepth, int shadowSamples, float filterRadius, float randomSeed) {
	VogelDiskData diskData;
	prepareDiskConstants(diskData, shadowSamples, randomSeed);
	float sum = 0.0;
	for (int i = 0; i < shadowSamples; i++) {
		vec2 offsetUV = generateDiskSample(diskData) * filterRadius;
		float depth = texture2DLod(shadowMap, uv + offsetUV, 0.0).r;
		sum += step(receiverDepth, depth);
	}
	return sum / float(shadowSamples);
}
float getPenumbra(float dblocker, float dreceiver, float penumbraSize, float penumbraFalloff) {
	float dist = dreceiver - dblocker;
	float penumbra = 1.0 - pow(1.0 - dist, penumbraFalloff);
	return penumbra * penumbraSize;
}
float PCSSDirectional(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoords, vec4 cameraParams, vec4 softShadowParams) {
	float receiverDepth = shadowCoords.z;
	float randomSeed = fractSinRand(gl_FragCoord.xy);
	int shadowSamples = int(softShadowParams.x);
	int shadowBlockerSamples = int(softShadowParams.y);
	float penumbraSize = softShadowParams.z;
	float penumbraFalloff = softShadowParams.w;
	int shadowMapSize = textureSize(shadowMap, 0).x;
	float invShadowMapSize = 1.0 / float(shadowMapSize);
	invShadowMapSize *= float(shadowMapSize) / 2048.0;
	float penumbra;
	if (shadowBlockerSamples > 0) {
		float avgBlockerDepth = 0.0;
		int numBlockers = 0;
		PCSSFindBlocker(TEXTURE_PASS(shadowMap), avgBlockerDepth, numBlockers, shadowCoords.xy, receiverDepth, shadowBlockerSamples, penumbraSize, invShadowMapSize, randomSeed);
		if (numBlockers < 1)
			return 1.0f;
		penumbra = getPenumbra(avgBlockerDepth, shadowCoords.z, penumbraSize, penumbraFalloff);
	} else {
		penumbra = penumbraSize;
	}
	float filterRadius = penumbra * invShadowMapSize;
	return PCSSFilter(TEXTURE_PASS(shadowMap), shadowCoords.xy, receiverDepth, shadowSamples, filterRadius, randomSeed);
}
float getShadowPCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec4 softShadowParams, vec3 lightDir) {
	return PCSSDirectional(TEXTURE_PASS(shadowMap), shadowCoord, cameraParams, softShadowParams);
}
`});var E5,v5=m(()=>{E5=`
attribute float vertex_boneIndices;
uniform highp sampler2D texture_poseMap;
mat4 getBoneMatrix(const in float indexFloat) {
	int width = textureSize(texture_poseMap, 0).x;
	int index = int(indexFloat + 0.5) * 3;
	int iy = index / width;
	int ix = index % width;
	vec4 v1 = texelFetch(texture_poseMap, ivec2(ix + 0, iy), 0);
	vec4 v2 = texelFetch(texture_poseMap, ivec2(ix + 1, iy), 0);
	vec4 v3 = texelFetch(texture_poseMap, ivec2(ix + 2, iy), 0);
	return mat4(
		v1.x, v2.x, v3.x, 0,
		v1.y, v2.y, v3.y, 0,
		v1.z, v2.z, v3.z, 0,
		v1.w, v2.w, v3.w, 1
	);
}
`});var x5,y5=m(()=>{x5=`
attribute vec4 vertex_boneWeights;
attribute vec4 vertex_boneIndices;
uniform highp sampler2D texture_poseMap;
void getBoneMatrix(const in int width, const in int index, out vec4 v1, out vec4 v2, out vec4 v3) {
	int v = index / width;
	int u = index % width;
	v1 = texelFetch(texture_poseMap, ivec2(u + 0, v), 0);
	v2 = texelFetch(texture_poseMap, ivec2(u + 1, v), 0);
	v3 = texelFetch(texture_poseMap, ivec2(u + 2, v), 0);
}
mat4 getSkinMatrix(const in vec4 indicesFloat, const in vec4 weights) {
	int width = textureSize(texture_poseMap, 0).x;
	ivec4 indices = ivec4(indicesFloat + 0.5) * 3;
	vec4 a1, a2, a3;
	getBoneMatrix(width, indices.x, a1, a2, a3);
	vec4 b1, b2, b3;
	getBoneMatrix(width, indices.y, b1, b2, b3);
	vec4 c1, c2, c3;
	getBoneMatrix(width, indices.z, c1, c2, c3);
	vec4 d1, d2, d3;
	getBoneMatrix(width, indices.w, d1, d2, d3);
	vec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;
	vec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;
	vec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;
	float one = dot(weights, vec4(1.0));
	return mat4(
		v1.x, v2.x, v3.x, 0,
		v1.y, v2.y, v3.y, 0,
		v1.z, v2.z, v3.z, 0,
		v1.w, v2.w, v3.w, one
	);
}
`});var A5,P5=m(()=>{A5=`
	#define LIT_SKYBOX_INTENSITY
	#include "envProcPS"
	#include "gammaPS"
	#include "tonemappingPS"
	#ifdef PREPASS_PASS
		varying float vLinearDepth;
		#include "floatAsUintPS"
	#endif
	varying vec3 vViewDir;
	uniform float skyboxHighlightMultiplier;
	#ifdef SKY_CUBEMAP
		uniform samplerCube texture_cubeMap;
		#ifdef SKYMESH
			varying vec3 vWorldPos;
			uniform mat3 cubeMapRotationMatrix;
			uniform vec3 projectedSkydomeCenter;
		#endif
	#else
		#include "sphericalPS"
		#include "envAtlasPS"
		uniform sampler2D texture_envAtlas;
		uniform float mipLevel;
	#endif
	void main(void) {
		#ifdef PREPASS_PASS
			gl_FragColor = float2vec4(vLinearDepth);
		#else
			#ifdef SKY_CUBEMAP
				#ifdef SKYMESH
					vec3 envDir = normalize(vWorldPos - projectedSkydomeCenter);
					vec3 dir = envDir * cubeMapRotationMatrix;
				#else
					vec3 dir = vViewDir;
				#endif
				dir.x *= -1.0;
				vec3 linear = {SKYBOX_DECODE_FNC}(textureCube(texture_cubeMap, dir));
			#else
				vec3 dir = vViewDir * vec3(-1.0, 1.0, 1.0);
				vec2 uv = toSphericalUv(normalize(dir));
				vec3 linear = {SKYBOX_DECODE_FNC}(texture2D(texture_envAtlas, mapRoughnessUv(uv, mipLevel)));
			#endif
			if (any(greaterThanEqual(linear, vec3(64.0)))) {
				linear *= skyboxHighlightMultiplier;
			}
			gl_FragColor = vec4(gammaCorrectOutput(toneMap(processEnvironment(linear))), 1.0);
		#endif
	}
`});var R5,C5=m(()=>{R5=`
attribute vec4 aPosition;
uniform mat4 matrix_view;
uniform mat4 matrix_projectionSkybox;
uniform mat3 cubeMapRotationMatrix;
varying vec3 vViewDir;
#ifdef PREPASS_PASS
	varying float vLinearDepth;
#endif
#ifdef SKYMESH
	uniform mat4 matrix_model;
	varying vec3 vWorldPos;
#endif
void main(void) {
	mat4 view = matrix_view;
	#ifdef SKYMESH
		vec4 worldPos = matrix_model * aPosition;
		vWorldPos = worldPos.xyz;
		gl_Position = matrix_projectionSkybox * (view * worldPos);
		#ifdef PREPASS_PASS
			vLinearDepth = -(matrix_view * vec4(vWorldPos, 1.0)).z;
		#endif
	#else
		view[3][0] = view[3][1] = view[3][2] = 0.0;
		gl_Position = matrix_projectionSkybox * (view * aPosition);
		vViewDir = aPosition.xyz * cubeMapRotationMatrix;
		#ifdef PREPASS_PASS
			vLinearDepth = -gl_Position.w;
		#endif
	#endif
	gl_Position.z = gl_Position.w - 1.0e-7;
}
`});var I5,w5=m(()=>{I5=`
#ifdef STD_SPECULAR_CONSTANT
uniform vec3 material_specular;
#endif
void getSpecularity() {
	vec3 specularColor = vec3(1,1,1);
	#ifdef STD_SPECULAR_CONSTANT
	specularColor *= material_specular;
	#endif
	#ifdef STD_SPECULAR_TEXTURE
	specularColor *= {STD_SPECULAR_TEXTURE_DECODE}(texture2DBias({STD_SPECULAR_TEXTURE_NAME}, {STD_SPECULAR_TEXTURE_UV}, textureBias)).{STD_SPECULAR_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_SPECULAR_VERTEX
	specularColor *= saturate(vVertexColor.{STD_SPECULAR_VERTEX_CHANNEL});
	#endif
	dSpecularity = specularColor;
}
`});var L5,b5=m(()=>{L5=`
vec2 toSpherical(vec3 dir) {
	return vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));
}
vec2 toSphericalUv(vec3 dir) {
	const float PI = 3.141592653589793;
	vec2 uv = toSpherical(dir) / vec2(PI * 2.0, PI) + 0.5;
	return vec2(uv.x, 1.0 - uv.y);
}
`});var M5,D5=m(()=>{M5=`
#ifdef STD_SPECULARITYFACTOR_CONSTANT
uniform float material_specularityFactor;
#endif
void getSpecularityFactor() {
	float specularityFactor = 1.0;
	#ifdef STD_SPECULARITYFACTOR_CONSTANT
	specularityFactor *= material_specularityFactor;
	#endif
	#ifdef STD_SPECULARITYFACTOR_TEXTURE
	specularityFactor *= texture2DBias({STD_SPECULARITYFACTOR_TEXTURE_NAME}, {STD_SPECULARITYFACTOR_TEXTURE_UV}, textureBias).{STD_SPECULARITYFACTOR_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_SPECULARITYFACTOR_VERTEX
	specularityFactor *= saturate(vVertexColor.{STD_SPECULARITYFACTOR_VERTEX_CHANNEL});
	#endif
	dSpecularityFactor = specularityFactor;
}
`});var O5,N5=m(()=>{O5=`
float getSpotEffect(vec3 lightSpotDir, float lightInnerConeAngle, float lightOuterConeAngle, vec3 lightDirNorm) {
	float cosAngle = dot(lightDirNorm, lightSpotDir);
	return smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);
}
`});var F5,U5=m(()=>{F5=`
	nineSlicedUv = vec2(vUv0.x, 1.0 - vUv0.y);
`});var B5,V5=m(()=>{B5=`
	vec2 tileMask = step(vMask, vec2(0.99999));
	vec2 tileSize = 0.5 * (innerOffset.xy + innerOffset.zw);
	vec2 tileScale = vec2(1.0) / (vec2(1.0) - tileSize);
	vec2 clampedUv = mix(innerOffset.xy * 0.5, vec2(1.0) - innerOffset.zw * 0.5, fract((vTiledUv - tileSize) * tileScale));
	clampedUv = clampedUv * atlasRect.zw + atlasRect.xy;
	nineSlicedUv = vUv0 * tileMask + clampedUv * (vec2(1.0) - tileMask);
	nineSlicedUv.y = 1.0 - nineSlicedUv.y;
	
`});var k5,G5=m(()=>{k5=`
	float dAlpha = 1.0;
	#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE
		#ifdef STD_OPACITY_TEXTURE_ALLOCATE
			uniform sampler2D texture_opacityMap;
		#endif
	#endif
	#ifdef FORWARD_PASS
		vec3 dAlbedo;
		vec3 dNormalW;
		vec3 dSpecularity = vec3(0.0);
		float dGlossiness = 0.0;
		#ifdef LIT_REFRACTION
			float dTransmission;
			float dThickness;
		#endif
		#ifdef LIT_SCENE_COLOR
			uniform sampler2D uSceneColorMap;
		#endif
		#ifdef LIT_SCREEN_SIZE
			uniform vec4 uScreenSize;
		#endif
		#ifdef LIT_TRANSFORMS
			uniform mat4 matrix_viewProjection;
			uniform mat4 matrix_model;
		#endif
		#ifdef STD_HEIGHT_MAP
			vec2 dUvOffset;
			#ifdef STD_DIFFUSE_TEXTURE_ALLOCATE
				uniform sampler2D texture_heightMap;
			#endif
		#endif
		#ifdef STD_DIFFUSE_TEXTURE_ALLOCATE
			uniform sampler2D texture_diffuseMap;
		#endif
		#ifdef STD_DIFFUSEDETAIL_TEXTURE_ALLOCATE
			uniform sampler2D texture_diffuseDetailMap;
		#endif
		#ifdef STD_NORMAL_TEXTURE_ALLOCATE
			uniform sampler2D texture_normalMap;
		#endif
		#ifdef STD_NORMALDETAIL_TEXTURE_ALLOCATE
			uniform sampler2D texture_normalDetailMap;
		#endif
		#ifdef STD_THICKNESS_TEXTURE_ALLOCATE
			uniform sampler2D texture_thicknessMap;
		#endif
		#ifdef STD_REFRACTION_TEXTURE_ALLOCATE
			uniform sampler2D texture_refractionMap;
		#endif
		#ifdef LIT_IRIDESCENCE
			float dIridescence;
			float dIridescenceThickness;
			#ifdef STD_IRIDESCENCE_THICKNESS_TEXTURE_ALLOCATE
				uniform sampler2D texture_iridescenceThicknessMap;
			#endif
			#ifdef STD_IRIDESCENCE_TEXTURE_ALLOCATE
				uniform sampler2D texture_iridescenceMap;
			#endif
		#endif
		#ifdef LIT_CLEARCOAT
			float ccSpecularity;
			float ccGlossiness;
			vec3 ccNormalW;
		#endif
		#ifdef LIT_GGX_SPECULAR
			float dAnisotropy;
			vec2 dAnisotropyRotation;
		#endif
		#ifdef LIT_SPECULAR_OR_REFLECTION
			#ifdef LIT_SHEEN
				vec3 sSpecularity;
				float sGlossiness;
				#ifdef STD_SHEEN_TEXTURE_ALLOCATE
					uniform sampler2D texture_sheenMap;
				#endif
				#ifdef STD_SHEENGLOSS_TEXTURE_ALLOCATE
					uniform sampler2D texture_sheenGlossMap;
				#endif
			#endif
			#ifdef LIT_METALNESS
				float dMetalness;
				float dIor;
				#ifdef STD_METALNESS_TEXTURE_ALLOCATE
					uniform sampler2D texture_metalnessMap;
				#endif
			#endif
			#ifdef LIT_SPECULARITY_FACTOR
				float dSpecularityFactor;
				#ifdef STD_SPECULARITYFACTOR_TEXTURE_ALLOCATE
					uniform sampler2D texture_specularityFactorMap;
				#endif
			#endif
			#ifdef STD_SPECULAR_COLOR
				#ifdef STD_SPECULAR_TEXTURE_ALLOCATE
					uniform sampler2D texture_specularMap;
				#endif
			#endif
			#ifdef STD_GLOSS_TEXTURE_ALLOCATE
				uniform sampler2D texture_glossMap;
			#endif
		#endif
		#ifdef STD_AO
			float dAo;
			#ifdef STD_AO_TEXTURE_ALLOCATE
				uniform sampler2D texture_aoMap;
			#endif
			#ifdef STD_AODETAIL_TEXTURE_ALLOCATE
				uniform sampler2D texture_aoDetailMap;
			#endif
		#endif
		vec3 dEmission;
		#ifdef STD_EMISSIVE_TEXTURE_ALLOCATE
			uniform sampler2D texture_emissiveMap;
		#endif
		#ifdef LIT_CLEARCOAT
			#ifdef STD_CLEARCOAT_TEXTURE_ALLOCATE
				uniform sampler2D texture_clearCoatMap;
			#endif
			#ifdef STD_CLEARCOATGLOSS_TEXTURE_ALLOCATE
				uniform sampler2D texture_clearCoatGlossMap;
			#endif
			#ifdef STD_CLEARCOATNORMAL_TEXTURE_ALLOCATE
				uniform sampler2D texture_clearCoatNormalMap;
			#endif
		#endif
		
		#ifdef LIT_GGX_SPECULAR
			#ifdef STD_ANISOTROPY_TEXTURE_ALLOCATE
				uniform sampler2D texture_anisotropyMap;
			#endif
		#endif
		#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)
			vec3 dLightmap;
			#ifdef STD_LIGHT_TEXTURE_ALLOCATE
				uniform sampler2D texture_lightMap;
			#endif
		#endif
	#endif
	#include "litShaderCorePS"
`});var z5,H5=m(()=>{z5=`
	#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE
		#include "opacityPS"
		#if defined(LIT_ALPHA_TEST)
			#include "alphaTestPS"
		#endif
		#if STD_OPACITY_DITHER != NONE
			#include "opacityDitherPS"
		#endif
	#endif
	#ifdef FORWARD_PASS
		#ifdef STD_HEIGHT_MAP
			#include "parallaxPS"
		#endif
		#include  "diffusePS"
		#ifdef LIT_NEEDS_NORMAL
			#include "normalMapPS"
		#endif
		#ifdef LIT_REFRACTION
			#include "transmissionPS"
			#include "thicknessPS"
		#endif
		#ifdef LIT_IRIDESCENCE
			#include "iridescencePS"
			#include "iridescenceThicknessPS"
		#endif
		#ifdef LIT_SPECULAR_OR_REFLECTION
			#ifdef LIT_SHEEN
				#include "sheenPS"
				#include "sheenGlossPS"
			#endif
			#ifdef LIT_METALNESS
				#include "metalnessPS"
				#include "iorPS"
			#endif
			#ifdef LIT_SPECULARITY_FACTOR
				#include "specularityFactorPS"
			#endif
			#ifdef STD_SPECULAR_COLOR
				#include "specularPS"
			#else
				void getSpecularity() { 
					dSpecularity = vec3(1);
				}
			#endif
			#include "glossPS"
		#endif
		#ifdef STD_AO
			#include "aoPS"
		#endif
		#include "emissivePS"
		#ifdef LIT_CLEARCOAT
			#include "clearCoatPS"
			#include "clearCoatGlossPS"
			#include "clearCoatNormalPS"
		#endif
		#if defined(LIT_SPECULAR) && defined(LIT_LIGHTING) && defined(LIT_GGX_SPECULAR)
			#include "anisotropyPS"
		#endif
		#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)
			#include "lightmapPS"
		#endif
	#endif
	void evaluateFrontend() {
		#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE
			getOpacity();
			#if defined(LIT_ALPHA_TEST)
				alphaTest(dAlpha);
			#endif
			#if STD_OPACITY_DITHER != NONE
				opacityDither(dAlpha, 0.0);
			#endif
			litArgs_opacity = dAlpha;
		#endif
		#ifdef FORWARD_PASS
			#ifdef STD_HEIGHT_MAP
				getParallax();
			#endif
			getAlbedo();
			litArgs_albedo = dAlbedo;
			#ifdef LIT_NEEDS_NORMAL
				getNormal();
				litArgs_worldNormal = dNormalW;
			#endif
			#ifdef LIT_REFRACTION
				getRefraction();
				litArgs_transmission = dTransmission;
				getThickness();
				litArgs_thickness = dThickness;
				#ifdef LIT_DISPERSION
					litArgs_dispersion = material_dispersion;
				#endif
			#endif
			#ifdef LIT_IRIDESCENCE
				getIridescence();
				getIridescenceThickness();
				litArgs_iridescence_intensity = dIridescence;
				litArgs_iridescence_thickness = dIridescenceThickness;
			#endif
			#ifdef LIT_SPECULAR_OR_REFLECTION
				#ifdef LIT_SHEEN
					getSheen();
					litArgs_sheen_specularity = sSpecularity;
					getSheenGlossiness();
					litArgs_sheen_gloss = sGlossiness;
				#endif
				#ifdef LIT_METALNESS
					getMetalness();
					litArgs_metalness = dMetalness;
					getIor();
					litArgs_ior = dIor;
				#endif
				#ifdef LIT_SPECULARITY_FACTOR
					getSpecularityFactor();
					litArgs_specularityFactor = dSpecularityFactor;
				#endif
				getGlossiness();
				getSpecularity();
				litArgs_specularity = dSpecularity;
				litArgs_gloss = dGlossiness;
			#endif
			#ifdef STD_AO
				getAO();
				litArgs_ao = dAo;
			#endif
			getEmission();
			litArgs_emission = dEmission;
			#ifdef LIT_CLEARCOAT
				getClearCoat();
				getClearCoatGlossiness();
				getClearCoatNormal();
				litArgs_clearcoat_specularity = ccSpecularity;
				litArgs_clearcoat_gloss = ccGlossiness;
				litArgs_clearcoat_worldNormal = ccNormalW;
			#endif
			#if defined(LIT_SPECULAR) && defined(LIT_LIGHTING) && defined(LIT_GGX_SPECULAR)
				getAnisotropy();
			#endif
			#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)
				getLightMap();
				litArgs_lightmap = dLightmap;
				#ifdef STD_LIGHTMAP_DIR
					litArgs_lightmapDir = dLightmapDir;
				#endif
			#endif
		#endif
	}
`});var X5,W5=m(()=>{X5=`
#ifdef LIT_TANGENTS
	#define TBN_TANGENTS
#else
	#if defined(LIT_USE_NORMALS) || defined(LIT_USE_CLEARCOAT_NORMALS)
		#define TBN_DERIVATIVES
	#endif
#endif
#if defined(TBN_DERIVATIVES)
	uniform float tbnBasis;
#endif
void getTBN(vec3 tangent, vec3 binormal, vec3 normal) {
	#ifdef TBN_TANGENTS
		dTBN = mat3(normalize(tangent), normalize(binormal), normalize(normal));
	#elif defined(TBN_DERIVATIVES)
		vec2 uv = {lightingUv};
		vec3 dp1 = dFdx( vPositionW );
		vec3 dp2 = dFdy( vPositionW );
		vec2 duv1 = dFdx( uv );
		vec2 duv2 = dFdy( uv );
		vec3 dp2perp = cross( dp2, normal );
		vec3 dp1perp = cross( normal, dp1 );
		vec3 T = dp2perp * duv1.x + dp1perp * duv2.x;
		vec3 B = dp2perp * duv1.y + dp1perp * duv2.y;
		float denom = max( dot(T,T), dot(B,B) );
		float invmax = (denom == 0.0) ? 0.0 : tbnBasis / sqrt( denom );
		dTBN = mat3(T * invmax, -B * invmax, normal );
	#else
		vec3 B = cross(normal, vObjectSpaceUpW);
		vec3 T = cross(normal, B);
		if (dot(B,B)==0.0)
		{
			float major=max(max(normal.x, normal.y), normal.z);
			if (normal.x == major)
			{
				B = cross(normal, vec3(0,1,0));
				T = cross(normal, B);
			}
			else if (normal.y == major)
			{
				B = cross(normal, vec3(0,0,1));
				T = cross(normal, B);
			}
			else if (normal.z == major)
			{
				B = cross(normal, vec3(1,0,0));
				T = cross(normal, B);
			}
		}
		dTBN = mat3(normalize(T), normalize(B), normalize(normal));
	#endif
}
`});var Y5,K5=m(()=>{Y5=`
#ifdef STD_THICKNESS_CONSTANT
uniform float material_thickness;
#endif
void getThickness() {
	dThickness = 1.0;
	#ifdef STD_THICKNESS_CONSTANT
	dThickness *= material_thickness;
	#endif
	#ifdef STD_THICKNESS_TEXTURE
	dThickness *= texture2DBias({STD_THICKNESS_TEXTURE_NAME}, {STD_THICKNESS_TEXTURE_UV}, textureBias).{STD_THICKNESS_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_THICKNESS_VERTEX
	dThickness *= saturate(vVertexColor.{STD_THICKNESS_VERTEX_CHANNEL});
	#endif
}
`});var q5,j5=m(()=>{q5=`
#if (TONEMAP == NONE)
	#include "tonemappingNonePS"
#elif TONEMAP == FILMIC
	#include "tonemappingFilmicPS"
#elif TONEMAP == LINEAR
	#include "tonemappingLinearPS"
#elif TONEMAP == HEJL
	#include "tonemappingHejlPS"
#elif TONEMAP == ACES
	#include "tonemappingAcesPS"
#elif TONEMAP == ACES2
	#include "tonemappingAces2PS"
#elif TONEMAP == NEUTRAL
	#include "tonemappingNeutralPS"
#endif
`});var $5,Z5=m(()=>{$5=`
uniform float exposure;
vec3 toneMap(vec3 color) {
	float tA = 2.51;
	float tB = 0.03;
	float tC = 2.43;
	float tD = 0.59;
	float tE = 0.14;
	vec3 x = color * exposure;
	return (x*(tA*x+tB))/(x*(tC*x+tD)+tE);
}
`});var Q5,J5=m(()=>{Q5=`
uniform float exposure;
const mat3 ACESInputMat = mat3(
	0.59719, 0.35458, 0.04823,
	0.07600, 0.90834, 0.01566,
	0.02840, 0.13383, 0.83777
);
const mat3 ACESOutputMat = mat3(
	 1.60475, -0.53108, -0.07367,
	-0.10208,  1.10813, -0.00605,
	-0.00327, -0.07276,  1.07602
);
vec3 RRTAndODTFit(vec3 v) {
	vec3 a = v * (v + 0.0245786) - 0.000090537;
	vec3 b = v * (0.983729 * v + 0.4329510) + 0.238081;
	return a / b;
}
vec3 toneMap(vec3 color) {
	color *= exposure / 0.6;
	color = color * ACESInputMat;
	color = RRTAndODTFit(color);
	color = color * ACESOutputMat;
	color = clamp(color, 0.0, 1.0);
	return color;
}
`});var eX,tX=m(()=>{eX=`
const float A =  0.15;
const float B =  0.50;
const float C =  0.10;
const float D =  0.20;
const float E =  0.02;
const float F =  0.30;
const float W =  11.2;
uniform float exposure;
vec3 uncharted2Tonemap(vec3 x) {
	 return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;
}
vec3 toneMap(vec3 color) {
	color = uncharted2Tonemap(color * exposure);
	vec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W,W,W));
	color = color * whiteScale;
	return color;
}
`});var sX,iX=m(()=>{sX=`
uniform float exposure;
vec3 toneMap(vec3 color) {
	color *= exposure;
	const float  A = 0.22, B = 0.3, C = .1, D = 0.2, E = .01, F = 0.3;
	const float Scl = 1.25;
	vec3 h = max( vec3(0.0), color - vec3(0.004) );
	return (h*((Scl*A)*h+Scl*vec3(C*B,C*B,C*B))+Scl*vec3(D*E,D*E,D*E)) / (h*(A*h+vec3(B,B,B))+vec3(D*F,D*F,D*F)) - Scl*vec3(E/F,E/F,E/F);
}
`});var rX,aX=m(()=>{rX=`
uniform float exposure;
vec3 toneMap(vec3 color) {
	return color * exposure;
}
`});var nX,oX=m(()=>{nX=`
uniform float exposure;
vec3 toneMap(vec3 color) {
	color *= exposure;
	float startCompression = 0.8 - 0.04;
	float desaturation = 0.15;
	float x = min(color.r, min(color.g, color.b));
	float offset = x < 0.08 ? x - 6.25 * x * x : 0.04;
	color -= offset;
	float peak = max(color.r, max(color.g, color.b));
	if (peak < startCompression) return color;
	float d = 1. - startCompression;
	float newPeak = 1. - d * d / (peak + d - startCompression);
	color *= newPeak / peak;
	float g = 1. - 1. / (desaturation * (peak - newPeak) + 1.);
	return mix(color, newPeak * vec3(1, 1, 1), g);
}
`});var lX,hX=m(()=>{lX=`
vec3 toneMap(vec3 color) {
	return color;
}
`});var cX,fX=m(()=>{cX=`
#ifdef PIXELSNAP
uniform vec4 uScreenSize;
#endif
#ifdef SCREENSPACE
uniform float projectionFlipY;
#endif
vec4 evalWorldPosition(vec3 vertexPosition, mat4 modelMatrix) {
	vec3 localPos = getLocalPosition(vertexPosition);
	#ifdef NINESLICED
		localPos.xz *= outerScale;
		vec2 positiveUnitOffset = clamp(vertexPosition.xz, vec2(0.0), vec2(1.0));
		vec2 negativeUnitOffset = clamp(-vertexPosition.xz, vec2(0.0), vec2(1.0));
		localPos.xz += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;
		vTiledUv = (localPos.xz - outerScale + innerOffset.xy) * -0.5 + 1.0;
		localPos.xz *= -0.5;
		localPos = localPos.xzy;
	#endif
	vec4 posW = modelMatrix * vec4(localPos, 1.0);
	#ifdef SCREENSPACE
		posW.zw = vec2(0.0, 1.0);
	#endif
	return posW;
}
vec4 getPosition() {
	dModelMatrix = getModelMatrix();
	vec4 posW = evalWorldPosition(vertex_position.xyz, dModelMatrix);
	dPositionW = posW.xyz;
	vec4 screenPos;
	#ifdef UV1LAYOUT
		screenPos = vec4(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1);
		#ifdef WEBGPU
			screenPos.y *= -1.0;
		#endif
	#else
		#ifdef SCREENSPACE
			screenPos = posW;
			screenPos.y *= projectionFlipY;
		#else
			screenPos = matrix_viewProjection * posW;
		#endif
		#ifdef PIXELSNAP
			screenPos.xy = (screenPos.xy * 0.5) + 0.5;
			screenPos.xy *= uScreenSize.xy;
			screenPos.xy = floor(screenPos.xy);
			screenPos.xy *= uScreenSize.zw;
			screenPos.xy = (screenPos.xy * 2.0) - 1.0;
		#endif
	#endif
	return screenPos;
}
vec3 getWorldPosition() {
	return dPositionW;
}
`});var dX,uX=m(()=>{dX=`
attribute vec4 vertex_position;
uniform mat4 matrix_viewProjection;
uniform mat4 matrix_model;
#ifdef MORPHING
	uniform vec2 morph_tex_params;
	attribute uint morph_vertex_id;
	ivec2 getTextureMorphCoords() {
		ivec2 textureSize = ivec2(morph_tex_params);
		int morphGridV = int(morph_vertex_id) / textureSize.x;
		int morphGridU = int(morph_vertex_id) - (morphGridV * textureSize.x);
		#ifdef WEBGPU
			morphGridV = textureSize.y - morphGridV - 1;
		#endif
		return ivec2(morphGridU, morphGridV);
	}
	#ifdef MORPHING_POSITION
		#ifdef MORPHING_INT
			uniform vec3 aabbSize;
			uniform vec3 aabbMin;
			uniform usampler2D morphPositionTex;
		#else
			uniform highp sampler2D morphPositionTex;
		#endif
	#endif
#endif
#ifdef defined(BATCH)
	#include "skinBatchVS"
	mat4 getModelMatrix() {
		return getBoneMatrix(vertex_boneIndices);
	}
#elif defined(SKIN)
	#include "skinVS"
	mat4 getModelMatrix() {
		return matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);
	}
#elif defined(INSTANCING)
	#include "transformInstancingVS"
#else
	mat4 getModelMatrix() {
		return matrix_model;
	}
#endif
vec3 getLocalPosition(vec3 vertexPosition) {
	vec3 localPos = vertexPosition;
	#ifdef MORPHING_POSITION
		ivec2 morphUV = getTextureMorphCoords();
		#ifdef MORPHING_INT
			vec3 morphPos = vec3(texelFetch(morphPositionTex, ivec2(morphUV), 0).xyz) / 65535.0 * aabbSize + aabbMin;
		#else
			vec3 morphPos = texelFetch(morphPositionTex, ivec2(morphUV), 0).xyz;
		#endif
		localPos += morphPos;
	#endif
	return localPos;
}
`});var mX,pX=m(()=>{mX=`
attribute vec4 instance_line1;
attribute vec4 instance_line2;
attribute vec4 instance_line3;
attribute vec4 instance_line4;
mat4 getModelMatrix() {
	return matrix_model * mat4(instance_line1, instance_line2, instance_line3, instance_line4);
}
`});var _X,gX=m(()=>{_X=`
#ifdef STD_REFRACTION_CONSTANT
uniform float material_refraction;
#endif
void getRefraction() {
	float refraction = 1.0;
	#ifdef STD_REFRACTION_CONSTANT
	refraction = material_refraction;
	#endif
	#ifdef STD_REFRACTION_TEXTURE
	refraction *= texture2DBias({STD_REFRACTION_TEXTURE_NAME}, {STD_REFRACTION_TEXTURE_UV}, textureBias).{STD_REFRACTION_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_REFRACTION_VERTEX
	refraction *= saturate(vVertexColor.{STD_REFRACTION_VERTEX_CHANNEL});
	#endif
	dTransmission = refraction;
}
`});var SX,TX=m(()=>{SX=`
uniform float twoSidedLightingNegScaleFactor;
void handleTwoSidedLighting() {
	dTBN[2] *= gl_FrontFacing ? twoSidedLightingNegScaleFactor : -twoSidedLightingNegScaleFactor;
}
`});var EX,vX=m(()=>{EX=`
#ifdef NINESLICED
	vec2 getUv0() {
		vec2 uv = vertex_position.xz;
		vec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));
		vec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));
		uv += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;
		uv = uv * -0.5 + 0.5;
		uv = uv * atlasRect.zw + atlasRect.xy;
		vMask = vertex_texCoord0.xy;
		return uv;
	}
#else
	vec2 getUv0() {
		return vertex_texCoord0;
	}
#endif
`});var xX,yX=m(()=>{xX=`
vec2 getUv1() {
	return vertex_texCoord1;
}
`});var AX,PX=m(()=>{AX=`
vUV{TRANSFORM_UV_{i}}_{TRANSFORM_ID_{i}} = vec2(
	dot(vec3(uv{TRANSFORM_UV_{i}}, 1), {TRANSFORM_NAME_{i}}0),
	dot(vec3(uv{TRANSFORM_UV_{i}}, 1), {TRANSFORM_NAME_{i}}1)
);
`});var RX,CX=m(()=>{RX=`
	uniform vec3 {TRANSFORM_NAME_{i}}0;
	uniform vec3 {TRANSFORM_NAME_{i}}1;
`});var IX,wX=m(()=>{IX=`
void getViewDir() {
	dViewDirW = normalize(view_position - vPositionW);
}
`});var LX,bX=m(()=>{Ck();wk();bk();Dk();Nk();Uk();Vk();Gk();Hk();Wk();Kk();jk();Zk();Jk();tG();iG();aG();oG();hG();fG();uG();pG();gG();TG();vG();yG();PG();CG();wG();bG();DG();NG();UG();VG();GG();HG();WG();KG();jG();ZG();JG();tz();iz();az();ZI();QI();oz();hz();fz();uz();pz();gz();Tz();vz();yz();Pz();Cz();wz();bz();Dz();Nz();Uz();Vz();Gz();Hz();Wz();Kz();jz();Zz();Jz();tH();iH();aH();oH();hH();fH();uH();pH();gH();TH();vH();yH();PH();CH();wH();bH();DH();NH();UH();VH();GH();HH();WH();KH();jH();ZH();JH();t4();i4();a4();o4();h4();f4();u4();p4();g4();T4();v4();y4();P4();C4();w4();b4();D4();N4();U4();V4();G4();H4();W4();K4();j4();Z4();J4();t5();i5();a5();o5();h5();f5();u5();p5();g5();T5();v5();y5();P5();C5();w5();b5();D5();N5();U5();V5();G5();H5();W5();K5();j5();Z5();J5();tX();iX();aX();oX();hX();fX();uX();pX();gX();TX();vX();yX();PX();CX();wX();JI();ew();LX={alphaTestPS:Rk,ambientPS:Ik,anisotropyPS:Lk,aoPS:Mk,aoDiffuseOccPS:Ok,aoSpecOccPS:Fk,bakeDirLmEndPS:Bk,bakeLmEndPS:kk,basePS:zk,baseNineSlicedPS:Xk,baseNineSlicedTiledPS:Yk,bayerPS:qk,blurVSMPS:$k,clearCoatPS:Qk,clearCoatGlossPS:eG,clearCoatNormalPS:sG,clusteredLightCookiesPS:nG,clusteredLightShadowsPS:lG,clusteredLightUtilsPS:rG,clusteredLightPS:cG,combinePS:dG,cookieBlit2DPS:mG,cookieBlitCubePS:_G,cookieBlitVS:SG,cookiePS:EG,cubeMapProjectPS:xG,cubeMapRotatePS:AG,debugOutputPS:RG,debugProcessFrontendPS:IG,detailModesPS:MG,diffusePS:OG,decodePS:LG,emissivePS:FG,encodePS:BG,endPS:kG,envAtlasPS:zG,envProcPS:XG,falloffInvSquaredPS:YG,falloffLinearPS:qG,floatAsUintPS:$G,fogPS:QG,fresnelSchlickPS:ez,frontendCodePS:"",frontendDeclPS:"",fullscreenQuadVS:sz,gammaPS:rz,gles3PS:cx,gles3VS:fx,glossPS:nz,gsplatCenterVS:lz,gsplatCornerVS:Iz,gsplatColorVS:cz,gsplatCommonVS:dz,gsplatCompressedDataVS:mz,gsplatCompressedSHVS:_z,gsplatEvalSHVS:Sz,gsplatQuatToMat3VS:Ez,gsplatSogsColorVS:xz,gsplatSogsDataVS:Az,gsplatSogsSHVS:Rz,gsplatDataVS:Lz,gsplatOutputVS:Mz,gsplatPS:Oz,gsplatSHVS:Fz,gsplatSourceVS:Bz,gsplatVS:kz,quadVS:zz,immediateLinePS:Xz,immediateLineVS:Yz,iridescenceDiffractionPS:qz,iridescencePS:$z,iridescenceThicknessPS:Qz,iorPS:eH,lightDeclarationPS:sH,lightDiffuseLambertPS:rH,lightDirPointPS:nH,lightEvaluationPS:lH,lightFunctionLightPS:cH,lightFunctionShadowPS:dH,lightingPS:mH,lightmapAddPS:_H,lightmapPS:SH,lightSpecularAnisoGGXPS:EH,lightSpecularBlinnPS:xH,lightSheenPS:AH,linearizeDepthPS:RH,litForwardBackendPS:IH,litForwardDeclarationPS:LH,litForwardMainPS:MH,litForwardPostCodePS:OH,litForwardPreCodePS:FH,litMainPS:BH,litMainVS:kH,litOtherMainPS:zH,litShaderArgsPS:XH,litShaderCorePS:YH,litShadowMainPS:qH,litUserDeclarationPS:"",litUserDeclarationVS:"",litUserCodePS:"",litUserCodeVS:"",litUserMainStartPS:"",litUserMainStartVS:"",litUserMainEndPS:"",litUserMainEndVS:"",ltcPS:$H,metalnessPS:QH,metalnessModulatePS:s4,morphPS:r4,morphVS:n4,msdfPS:e4,msdfVS:l4,normalVS:c4,normalCoreVS:d4,normalMapPS:m4,opacityPS:_4,opacityDitherPS:S4,outputPS:E4,outputAlphaPS:x4,outputTex2DPS:A4,sheenPS:R4,sheenGlossPS:I4,parallaxPS:L4,pickPS:M4,reflDirPS:O4,reflDirAnisoPS:F4,reflectionCCPS:B4,reflectionCubePS:k4,reflectionEnvHQPS:z4,reflectionEnvPS:X4,reflectionSpherePS:Y4,reflectionSheenPS:q4,refractionCubePS:$4,refractionDynamicPS:Q4,reprojectPS:e5,reprojectVS:s5,screenDepthPS:r5,shadowCascadesPS:n5,shadowEVSMPS:l5,shadowPCF1PS:c5,shadowPCF3PS:d5,shadowPCF5PS:m5,shadowPCSSPS:_5,shadowSoftPS:S5,skinBatchVS:E5,skinVS:x5,skyboxPS:A5,skyboxVS:R5,specularPS:I5,sphericalPS:L5,specularityFactorPS:M5,spotPS:O5,startNineSlicedPS:F5,startNineSlicedTiledPS:B5,stdDeclarationPS:k5,stdFrontEndPS:z5,TBNPS:X5,thicknessPS:Y5,tonemappingPS:q5,tonemappingAcesPS:$5,tonemappingAces2PS:Q5,tonemappingFilmicPS:eX,tonemappingHejlPS:sX,tonemappingLinearPS:rX,tonemappingNeutralPS:nX,tonemappingNonePS:lX,transformVS:cX,transformCoreVS:dX,transformInstancingVS:mX,transmissionPS:_X,twoSidedLightingPS:SX,uv0VS:EX,uv1VS:xX,uvTransformVS:AX,uvTransformUniformsPS:RX,viewDirPS:IX,webgpuPS:dx,webgpuVS:ux}});var MX,DX=m(()=>{MX=`
uniform alpha_ref: f32;
fn alphaTest(a: f32) {
	if (a < uniform.alpha_ref) {
		discard;
	}
}
`});var OX,NX=m(()=>{OX=`
#if LIT_AMBIENT_SOURCE == AMBIENTSH
	uniform ambientSH: array<vec3f, 9>;
#endif
#if LIT_AMBIENT_SOURCE == ENVALATLAS
	#include "envAtlasPS"
	#ifndef ENV_ATLAS
		#define ENV_ATLAS
		var texture_envAtlas: texture_2d<f32>;
		var texture_envAtlasSampler: sampler;
	#endif
#endif
fn addAmbient(worldNormal: vec3f) {
	#ifdef LIT_AMBIENT_SOURCE == AMBIENTSH
		let n: vec3f = cubeMapRotate(worldNormal);
		let color: vec3f =
			uniform.ambientSH[0] +
			uniform.ambientSH[1] * n.x +
			uniform.ambientSH[2] * n.y +
			uniform.ambientSH[3] * n.z +
			uniform.ambientSH[4] * n.x * n.z +
			uniform.ambientSH[5] * n.z * n.y +
			uniform.ambientSH[6] * n.y * n.x +
			uniform.ambientSH[7] * (3.0 * n.z * n.z - 1.0) +
			uniform.ambientSH[8] * (n.x * n.x - n.y * n.y);
		dDiffuseLight += processEnvironment(max(color, vec3f(0.0)));
	#endif
	#if LIT_AMBIENT_SOURCE == ENVALATLAS
		let dir: vec3f = normalize(cubeMapRotate(worldNormal) * vec3f(-1.0, 1.0, 1.0));
		let uv: vec2f = mapUv(toSphericalUv(dir), vec4f(128.0, 256.0 + 128.0, 64.0, 32.0) / atlasSize);
		let raw: vec4f = textureSample(texture_envAtlas, texture_envAtlasSampler, uv);
		let linear: vec3f = {ambientDecode}(raw);
		dDiffuseLight += processEnvironment(linear);
	#endif
	#if LIT_AMBIENT_SOURCE == CONSTANT
		dDiffuseLight += uniform.light_globalAmbient;
	#endif
}
`});var FX,UX=m(()=>{FX=`
#ifdef LIT_GGX_SPECULAR
	uniform material_anisotropyIntensity: f32;
	uniform material_anisotropyRotation: vec2f;
#endif
fn getAnisotropy() {
	dAnisotropy = 0.0;
	dAnisotropyRotation = vec2f(1.0, 0.0);
#ifdef LIT_GGX_SPECULAR
	dAnisotropy = uniform.material_anisotropyIntensity;
	dAnisotropyRotation = uniform.material_anisotropyRotation;
#endif
#ifdef STD_ANISOTROPY_TEXTURE
	let anisotropyTex: vec3f = textureSampleBias({STD_ANISOTROPY_TEXTURE_NAME}, {STD_ANISOTROPY_TEXTURE_NAME}Sampler, {STD_ANISOTROPY_TEXTURE_UV}, uniform.textureBias).rgb;
	dAnisotropy *= anisotropyTex.b;
	let anisotropyRotationFromTex: vec2f = anisotropyTex.rg * 2.0 - vec2f(1.0);
	let rotationMatrix: mat2x2f = mat2x2f(dAnisotropyRotation.x, dAnisotropyRotation.y, -dAnisotropyRotation.y, dAnisotropyRotation.x);
	dAnisotropyRotation = rotationMatrix * anisotropyRotationFromTex;
#endif
	dAnisotropy = clamp(dAnisotropy, 0.0, 1.0);
}
`});var BX,VX=m(()=>{BX=`
#if defined(STD_AO_TEXTURE) || defined(STD_AO_VERTEX)
	uniform material_aoIntensity: f32;
#endif
#ifdef STD_AODETAIL_TEXTURE
	#include "detailModesPS"
#endif
fn getAO() {
	dAo = 1.0;
	#ifdef STD_AO_TEXTURE
		var aoBase: f32 = textureSampleBias({STD_AO_TEXTURE_NAME}, {STD_AO_TEXTURE_NAME}Sampler, {STD_AO_TEXTURE_UV}, uniform.textureBias).{STD_AO_TEXTURE_CHANNEL};
		#ifdef STD_AODETAIL_TEXTURE
			var aoDetail: f32 = textureSampleBias({STD_AODETAIL_TEXTURE_NAME}, {STD_AODETAIL_TEXTURE_NAME}Sampler, {STD_AODETAIL_TEXTURE_UV}, uniform.textureBias).{STD_AODETAIL_TEXTURE_CHANNEL};
			aoBase = detailMode_{STD_AODETAIL_DETAILMODE}(vec3f(aoBase), vec3f(aoDetail)).r;
		#endif
		dAo = dAo * aoBase;
	#endif
	#ifdef STD_AO_VERTEX
		dAo = dAo * saturate(vVertexColor.{STD_AO_VERTEX_CHANNEL});
	#endif
	#if defined(STD_AO_TEXTURE) || defined(STD_AO_VERTEX)
		dAo = mix(1.0, dAo, uniform.material_aoIntensity);
	#endif
}
`});var kX,GX=m(()=>{kX=`
fn occludeDiffuse(ao: f32) {
	dDiffuseLight = dDiffuseLight * ao;
}
`});var zX,HX=m(()=>{zX=`
#if LIT_OCCLUDE_SPECULAR != NONE
	#ifdef LIT_OCCLUDE_SPECULAR_FLOAT
		uniform material_occludeSpecularIntensity: f32;
	#endif
#endif
fn occludeSpecular(gloss: f32, ao: f32, worldNormal: vec3f, viewDir: vec3f) {
	#if LIT_OCCLUDE_SPECULAR == AO
		#ifdef LIT_OCCLUDE_SPECULAR_FLOAT
			var specOcc: f32 = mix(1.0, ao, uniform.material_occludeSpecularIntensity);
		#else
			var specOcc: f32 = ao;
		#endif
	#endif
	#if LIT_OCCLUDE_SPECULAR == GLOSSDEPENDENT
		var specPow: f32 = exp2(gloss * 11.0);
		var specOcc: f32 = saturate(pow(dot(worldNormal, viewDir) + ao, 0.01 * specPow) - 1.0 + ao);
		#ifdef LIT_OCCLUDE_SPECULAR_FLOAT
			specOcc = mix(1.0, specOcc, uniform.material_occludeSpecularIntensity);
		#endif
	#endif
	#if LIT_OCCLUDE_SPECULAR != NONE
		dSpecularLight = dSpecularLight * specOcc;
		dReflection = dReflection * specOcc;
		#ifdef LIT_SHEEN
			sSpecularLight = sSpecularLight * specOcc;
			sReflection = sReflection * specOcc;
		#endif
	#endif
}
`});var XX,WX=m(()=>{XX=`
	let dirLm = textureSample(texture_dirLightMap, texture_dirLightMapSampler, vUv1);
	if (uniform.bakeDir > 0.5) {
		if (dAtten > 0.00001) {
			let unpacked_dir = dirLm.xyz * 2.0 - vec3f(1.0);
			dAtten = clamp(dAtten, 0.0, 1.0);
			let combined_dir = dLightDirNormW.xyz * dAtten + unpacked_dir * dirLm.w;
			let finalRgb = normalize(combined_dir) * 0.5 + vec3f(0.5);
			let finalA = max(dirLm.w + dAtten, 1.0 / 255.0);
			output.color = vec4f(finalRgb, finalA);
		} else {
			output.color = dirLm;
		}
	} else {
		let alpha_min = select(0.0, 1.0 / 255.0, dAtten > 0.00001);
		let finalA = max(dirLm.w, alpha_min);
		output.color = vec4f(dirLm.rgb, finalA);
	}
`});var YX,KX=m(()=>{YX=`
#ifdef LIT_LIGHTMAP_BAKING_ADD_AMBIENT
	dDiffuseLight = ((dDiffuseLight - 0.5) * max(uniform.ambientBakeOcclusionContrast + 1.0, 0.0)) + 0.5;
	dDiffuseLight = dDiffuseLight + vec3f(uniform.ambientBakeOcclusionBrightness);
	dDiffuseLight = saturate3(dDiffuseLight);
	dDiffuseLight = dDiffuseLight * dAmbientLight;
#endif
#ifdef LIGHTMAP_RGBM
	var temp_color_rgbm = vec4f(dDiffuseLight, 1.0);
	temp_color_rgbm = vec4f(pow(temp_color_rgbm.rgb, vec3f(0.5)), temp_color_rgbm.a);
	temp_color_rgbm = vec4f(temp_color_rgbm.rgb / 8.0, temp_color_rgbm.a);
	let max_g_b = max(temp_color_rgbm.g, max(temp_color_rgbm.b, 1.0 / 255.0));
	let max_rgb = max(temp_color_rgbm.r, max_g_b);
	temp_color_rgbm.a = clamp(max_rgb, 0.0, 1.0);
	temp_color_rgbm.a = ceil(temp_color_rgbm.a * 255.0) / 255.0;
	temp_color_rgbm = vec4f(temp_color_rgbm.rgb / temp_color_rgbm.a, temp_color_rgbm.a);
	output.color = temp_color_rgbm;
#else
	output.color = vec4f(dDiffuseLight, 1.0);
#endif
`});var qX,jX=m(()=>{qX=`
uniform view_position: vec3f;
uniform light_globalAmbient: vec3f;
fn square(x: f32) -> f32 {
	return x*x;
}
fn saturate(x: f32) -> f32 {
	return clamp(x, 0.0, 1.0);
}
fn saturate3(x: vec3f) -> vec3f {
	return clamp(x, vec3f(0.0), vec3f(1.0));
}
`});var $X,ZX=m(()=>{$X=`
#define NINESLICED
varying vMask: vec2f;
varying vTiledUv: vec2f;
uniform innerOffset: vec4f;
uniform outerScale: vec2f;
uniform atlasRect: vec4f;
var<private> nineSlicedUv: vec2f;
`});var QX,JX=m(()=>{QX=`
#define NINESLICED
#define NINESLICETILED
varying vMask: vec2f;
varying vTiledUv: vec2f;
uniform innerOffset: vec4f;
uniform outerScale: vec2f;
uniform atlasRect: vec4f;
var<private> nineSlicedUv: vec2f;
`});var eW,tW=m(()=>{eW=`
fn bayer2(p: vec2f) -> f32 {
	return (2.0 * p.y + p.x + 1.0) % 4.0;
}
fn bayer4(p: vec2f) -> f32 {
	let p1: vec2f = p % vec2f(2.0);
	let p2: vec2f = floor(0.5 * (p % vec2f(4.0)));
	return 4.0 * bayer2(p1) + bayer2(p2);
}
fn bayer8(p: vec2f) -> f32 {
	let p1: vec2f = p % vec2f(2.0);
	let p2: vec2f = floor(0.5 * (p % vec2f(4.0)));
	let p4: vec2f = floor(0.25 * (p % vec2f(8.0)));
	return 4.0 * (4.0 * bayer2(p1) + bayer2(p2)) + bayer2(p4);
}
`});var sW,iW=m(()=>{sW=`
varying vUv0: vec2f;
var source: texture_2d<f32>;
var sourceSampler: sampler;
#ifdef GAUSS
	uniform weight: array<f32, {SAMPLES}>;
#endif
uniform pixelOffset: vec2f;
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	var moments: vec3f = vec3f(0.0);
	let uv: vec2f = input.vUv0 - uniform.pixelOffset * (f32({SAMPLES}) * 0.5);
	for (var i: i32 = 0; i < {SAMPLES}; i = i + 1) {
		let c: vec4f = textureSample(source, sourceSampler, uv + uniform.pixelOffset * f32(i));
		#ifdef GAUSS
			moments = moments + c.xyz * uniform.weight[i].element;
		#else
			moments = moments + c.xyz;
		#endif
	}
	#ifndef GAUSS
		moments = moments * (1.0 / f32({SAMPLES}));
	#endif
	output.color = vec4f(moments, 1.0);
	return output;
}
`});var rW,aW=m(()=>{rW=`
uniform material_clearCoat: f32;
fn getClearCoat() {
	ccSpecularity = uniform.material_clearCoat;
	#ifdef STD_CLEARCOAT_TEXTURE
	ccSpecularity = ccSpecularity * textureSampleBias({STD_CLEARCOAT_TEXTURE_NAME}, {STD_CLEARCOAT_TEXTURE_NAME}Sampler, {STD_CLEARCOAT_TEXTURE_UV}, uniform.textureBias).{STD_CLEARCOAT_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_CLEARCOAT_VERTEX
	ccSpecularity = ccSpecularity * saturate(vVertexColor.{STD_CLEARCOAT_VERTEX_CHANNEL});
	#endif
}
`});var nW,oW=m(()=>{nW=`
	uniform material_clearCoatGloss: f32;
fn getClearCoatGlossiness() {
	ccGlossiness = uniform.material_clearCoatGloss;
	#ifdef STD_CLEARCOATGLOSS_TEXTURE
	ccGlossiness = ccGlossiness * textureSampleBias({STD_CLEARCOATGLOSS_TEXTURE_NAME}, {STD_CLEARCOATGLOSS_TEXTURE_NAME}Sampler, {STD_CLEARCOATGLOSS_TEXTURE_UV}, uniform.textureBias).{STD_CLEARCOATGLOSS_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_CLEARCOATGLOSS_VERTEX
	ccGlossiness = ccGlossiness * saturate(vVertexColor.{STD_CLEARCOATGLOSS_VERTEX_CHANNEL});
	#endif
	#ifdef STD_CLEARCOATGLOSS_INVERT
	ccGlossiness = 1.0 - ccGlossiness;
	#endif
	ccGlossiness += 0.0000001;
}
`});var lW,hW=m(()=>{lW=`
#ifdef STD_CLEARCOATNORMAL_TEXTURE
	uniform material_clearCoatBumpiness: f32;
#endif
fn getClearCoatNormal() {
#ifdef STD_CLEARCOATNORMAL_TEXTURE
	var normalMap: vec3f = {STD_CLEARCOATNORMAL_TEXTURE_DECODE}(textureSampleBias({STD_CLEARCOATNORMAL_TEXTURE_NAME}, {STD_CLEARCOATNORMAL_TEXTURE_NAME}Sampler, {STD_CLEARCOATNORMAL_TEXTURE_UV}, uniform.textureBias));
	normalMap = mix(vec3f(0.0, 0.0, 1.0), normalMap, uniform.material_clearCoatBumpiness);
	ccNormalW = normalize(dTBN * normalMap);
#else
	ccNormalW = dVertexNormalW;
#endif
}
`});var cW,fW=m(()=>{cW=`
struct FaceCoords {
	uv: vec2f,
	faceIndex: f32,
	tileOffset: vec2f,
}
fn getCubemapFaceCoordinates(dir: vec3f) -> FaceCoords {
	var faceIndex: f32;
	var tileOffset: vec2f;
	var uv: vec2f;
	let vAbs: vec3f = abs(dir);
	var ma: f32;
	if (vAbs.z >= vAbs.x && vAbs.z >= vAbs.y) {
		let is_neg_z = dir.z < 0.0;
		faceIndex = select(4.0, 5.0, is_neg_z);
		ma = 0.5 / vAbs.z;
		uv = vec2f(select(dir.x, -dir.x, is_neg_z), -dir.y);
		tileOffset = vec2f(2.0, select(0.0, 1.0, is_neg_z));
	} else if (vAbs.y >= vAbs.x) {
		let is_neg_y = dir.y < 0.0;
		faceIndex = select(2.0, 3.0, is_neg_y);
		ma = 0.5 / vAbs.y;
		uv = vec2f(dir.x, select(dir.z, -dir.z, is_neg_y));
		tileOffset = vec2f(1.0, select(0.0, 1.0, is_neg_y));
	} else {
		let is_neg_x = dir.x < 0.0;
		faceIndex = select(0.0, 1.0, is_neg_x);
		ma = 0.5 / vAbs.x;
		uv = vec2f(select(-dir.z, dir.z, is_neg_x), -dir.y);
		tileOffset = vec2f(0.0, select(0.0, 1.0, is_neg_x));
	}
	uv = uv * ma + 0.5;
	return FaceCoords(uv, faceIndex, tileOffset);
}
fn getCubemapAtlasCoordinates(omniAtlasViewport: vec3f, shadowEdgePixels: f32, shadowTextureResolution: f32, dir: vec3f) -> vec2f {
	let faceData: FaceCoords = getCubemapFaceCoordinates(dir);
	var uv: vec2f = faceData.uv;
	let tileOffset: vec2f = faceData.tileOffset;
	let atlasFaceSize: f32 = omniAtlasViewport.z;
	let tileSize: f32 = shadowTextureResolution * atlasFaceSize;
	var offset: f32 = shadowEdgePixels / tileSize;
	uv = uv * (1.0 - offset * 2.0) + offset;
	uv = uv * atlasFaceSize;
	uv = uv + tileOffset * atlasFaceSize;
	uv = uv + omniAtlasViewport.xy;
	return uv;
}
`});var dW,uW=m(()=>{dW=`
fn _getCookieClustered(tex: texture_2d<f32>, texSampler: sampler, uv: vec2f, intensity: f32, cookieChannel: vec4f) -> vec3f {
	let pixel: vec4f = mix(vec4f(1.0), textureSampleLevel(tex, texSampler, uv, 0.0), intensity);
	let isRgb: bool = dot(cookieChannel.rgb, vec3f(1.0)) == 3.0;
	return select(vec3f(dot(pixel, cookieChannel)), pixel.rgb, isRgb);
}
fn getCookie2DClustered(tex: texture_2d<f32>, texSampler: sampler, transform: mat4x4f, worldPosition: vec3f, intensity: f32, cookieChannel: vec4f) -> vec3f {
	let projPos: vec4f = transform * vec4f(worldPosition, 1.0);
	return _getCookieClustered(tex, texSampler, projPos.xy / projPos.w, intensity, cookieChannel);
}
fn getCookieCubeClustered(tex: texture_2d<f32>, texSampler: sampler, dir: vec3f, intensity: f32, cookieChannel: vec4f, shadowTextureResolution: f32, shadowEdgePixels: f32, omniAtlasViewport: vec3f) -> vec3f {
	let uv: vec2f = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);
	return _getCookieClustered(tex, texSampler, uv, intensity, cookieChannel);
}
`});var mW,pW=m(()=>{mW=`
fn _getShadowCoordPerspZbuffer(shadowMatrix: mat4x4f, shadowParams: vec4f, wPos: vec3f) -> vec3f {
	var projPos = shadowMatrix * vec4f(wPos, 1.0);
	return projPos.xyz / projPos.w;
}
fn getShadowCoordPerspZbufferNormalOffset(shadowMatrix: mat4x4f, shadowParams: vec4f, normal: vec3f) -> vec3f {
	let wPos: vec3f = vPositionW + normal * shadowParams.y;
	return _getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);
}
fn normalOffsetPointShadow(shadowParams: vec4f, lightPos: vec3f, lightDir: vec3f, lightDirNorm: vec3f, normal: vec3f) -> vec3f {
	let distScale: f32 = length(lightDir);
	let wPos: vec3f = vPositionW + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;
	let dir: vec3f = wPos - lightPos;
	return dir;
}
#if defined(CLUSTER_SHADOW_TYPE_PCF1)
	fn getShadowOmniClusteredPCF1(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowParams: vec4f, omniAtlasViewport: vec3f, shadowEdgePixels: f32, lightDir: vec3f) -> f32 {
		let shadowTextureResolution: f32 = shadowParams.x;
		let uv: vec2f = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);
		let shadowZ: f32 = length(lightDir) * shadowParams.w + shadowParams.z;
		return textureSampleCompareLevel(shadowMap, shadowMapSampler, uv, shadowZ);
	}
#endif
#if defined(CLUSTER_SHADOW_TYPE_PCF3)
	fn getShadowOmniClusteredPCF3(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowParams: vec4f, omniAtlasViewport: vec3f, shadowEdgePixels: f32, lightDir: vec3f) -> f32 {
		let shadowTextureResolution: f32 = shadowParams.x;
		let uv: vec2f = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);
		let shadowZ: f32 = length(lightDir) * shadowParams.w + shadowParams.z;
		let shadowCoord: vec3f = vec3f(uv, shadowZ);
		return getShadowPCF3x3(shadowMap, shadowMapSampler, shadowCoord, shadowParams);
	}
#endif
#if defined(CLUSTER_SHADOW_TYPE_PCF5)
	fn getShadowOmniClusteredPCF5(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowParams: vec4f, omniAtlasViewport: vec3f, shadowEdgePixels: f32, lightDir: vec3f) -> f32 {
		let shadowTextureResolution: f32 = shadowParams.x;
		let uv: vec2f = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);
		let shadowZ: f32 = length(lightDir) * shadowParams.w + shadowParams.z;
		let shadowCoord: vec3f = vec3f(uv, shadowZ);
		return getShadowPCF5x5(shadowMap, shadowMapSampler, shadowCoord, shadowParams);
	}
#endif
#if defined(CLUSTER_SHADOW_TYPE_PCF1)
	fn getShadowSpotClusteredPCF1(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {
		return textureSampleCompareLevel(shadowMap, shadowMapSampler, shadowCoord.xy, shadowCoord.z);
	}
#endif
	#if defined(CLUSTER_SHADOW_TYPE_PCF3)
	fn getShadowSpotClusteredPCF3(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {
		return getShadowSpotPCF3x3(shadowMap, shadowMapSampler, shadowCoord, shadowParams);
	}
#endif
	#if defined(CLUSTER_SHADOW_TYPE_PCF5)
	fn getShadowSpotClusteredPCF5(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {
		return getShadowPCF5x5(shadowMap, shadowMapSampler, shadowCoord, shadowParams);
	}
#endif
`});var _W,gW=m(()=>{_W=`
#include "lightBufferDefinesPS"
#include "clusteredLightUtilsPS"
#ifdef CLUSTER_COOKIES
	#include "clusteredLightCookiesPS"
#endif
#ifdef CLUSTER_SHADOWS
	#include "clusteredLightShadowsPS"
#endif
var clusterWorldTexture: texture_2d<f32>;
var lightsTexture: texture_2d<f32>;
#ifdef CLUSTER_SHADOWS
	var shadowAtlasTexture: texture_depth_2d;
	var shadowAtlasTextureSampler: sampler_comparison;
#endif
#ifdef CLUSTER_COOKIES
	var cookieAtlasTexture: texture_2d<f32>;
	var cookieAtlasTextureSampler: sampler;
#endif
uniform clusterMaxCells: i32;
uniform clusterSkip: f32;
uniform clusterCellsCountByBoundsSize: vec3f;
uniform clusterTextureSize: vec3f;
uniform clusterBoundsMin: vec3f;
uniform clusterBoundsDelta: vec3f;
uniform clusterCellsDot: vec3f;
uniform clusterCellsMax: vec3f;
uniform shadowAtlasParams: vec2f;
struct ClusterLightData {
	flags: u32,
	halfWidth: vec3f,
	isSpot: bool,
	halfHeight: vec3f,
	lightIndex: i32,
	position: vec3f,
	shape: u32,
	direction: vec3f,
	falloffModeLinear: bool,
	color: vec3f,
	shadowIntensity: f32,
	omniAtlasViewport: vec3f,
	range: f32,
	cookieChannelMask: vec4f,
	biasesData: f32,
	shadowBias: f32,
	shadowNormalBias: f32,
	anglesData: f32,
	innerConeAngleCos: f32,
	outerConeAngleCos: f32,
	cookieIntensity: f32,
	isDynamic: bool,
	isLightmapped: bool
}
var<private> lightProjectionMatrix: mat4x4f;
fn sampleLightTextureF(lightIndex: i32, index: i32) -> vec4f {
	return textureLoad(lightsTexture, vec2<i32>(index, lightIndex), 0);
}
fn decodeClusterLightCore(clusterLightData: ptr<function, ClusterLightData>, lightIndex: f32) {
	clusterLightData.lightIndex = i32(lightIndex);
	let halfData: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_COLOR_ANGLES_BIAS});
	clusterLightData.anglesData = halfData.z;
	clusterLightData.biasesData = halfData.w;
	let colorRG: vec2f = unpack2x16float(bitcast<u32>(halfData.x));
	let colorB_: vec2f = unpack2x16float(bitcast<u32>(halfData.y));
	clusterLightData.color = vec3f(colorRG, colorB_.x) * {LIGHT_COLOR_DIVIDER};
	let lightPosRange: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_POSITION_RANGE});
	clusterLightData.position = lightPosRange.xyz;
	clusterLightData.range = lightPosRange.w;
	let lightDir_Flags: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_DIRECTION_FLAGS});
	clusterLightData.direction = lightDir_Flags.xyz;
	let flags_uint: u32 = bitcast<u32>(lightDir_Flags.w);
	clusterLightData.flags = flags_uint;
	clusterLightData.isSpot = (flags_uint & (1u << 30u)) != 0u;
	clusterLightData.shape = (flags_uint >> 28u) & 0x3u;
	clusterLightData.falloffModeLinear = (flags_uint & (1u << 27u)) == 0u;
	clusterLightData.shadowIntensity = f32((flags_uint >> 0u) & 0xFFu) / 255.0;
	clusterLightData.cookieIntensity = f32((flags_uint >> 8u) & 0xFFu) / 255.0;
	clusterLightData.isDynamic = (flags_uint & (1u << 22u)) != 0u;
	clusterLightData.isLightmapped = (flags_uint & (1u << 21u)) != 0u;
}
fn decodeClusterLightSpot(clusterLightData: ptr<function, ClusterLightData>) {
	let angles: vec2f = unpack2x16float(bitcast<u32>(clusterLightData.anglesData));
	clusterLightData.innerConeAngleCos = angles.x;
	clusterLightData.outerConeAngleCos = angles.y;
}
fn decodeClusterLightOmniAtlasViewport(clusterLightData: ptr<function, ClusterLightData>) {
	clusterLightData.omniAtlasViewport = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_PROJ_MAT_0}).xyz;
}
fn decodeClusterLightAreaData(clusterLightData: ptr<function, ClusterLightData>) {
	clusterLightData.halfWidth = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_AREA_DATA_WIDTH}).xyz;
	clusterLightData.halfHeight = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_AREA_DATA_HEIGHT}).xyz;
}
fn decodeClusterLightProjectionMatrixData(clusterLightData: ptr<function, ClusterLightData>) {
	let m0: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_PROJ_MAT_0});
	let m1: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_PROJ_MAT_1});
	let m2: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_PROJ_MAT_2});
	let m3: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_PROJ_MAT_3});
	lightProjectionMatrix = mat4x4f(m0, m1, m2, m3);
}
fn decodeClusterLightShadowData(clusterLightData: ptr<function, ClusterLightData>) {
	let biases: vec2f = unpack2x16float(bitcast<u32>(clusterLightData.biasesData));
	clusterLightData.shadowBias = biases.x;
	clusterLightData.shadowNormalBias = biases.y;
}
fn decodeClusterLightCookieData(clusterLightData: ptr<function, ClusterLightData>) {
	let cookieFlags: u32 = (clusterLightData.flags >> 23u) & 0x0Fu;
	let mask_uvec: vec4<u32> = vec4<u32>(cookieFlags) & vec4<u32>(1u, 2u, 4u, 8u);
	clusterLightData.cookieChannelMask = step(vec4f(1.0), vec4f(mask_uvec));
}
fn evaluateLight(
	light: ptr<function, ClusterLightData>,
	worldNormal: vec3f,
	viewDir: vec3f,
	reflectionDir: vec3f,
#if defined(LIT_CLEARCOAT)
	clearcoatReflectionDir: vec3f,
#endif
	gloss: f32,
	specularity: vec3f,
	geometricNormal: vec3f,
	tbn: mat3x3f,
#if defined(LIT_IRIDESCENCE)
	iridescenceFresnel: vec3f,
#endif
	clearcoat_worldNormal: vec3f,
	clearcoat_gloss: f32,
	sheen_gloss: f32,
	iridescence_intensity: f32
) {
	var cookieAttenuation: vec3f = vec3f(1.0);
	var diffuseAttenuation: f32 = 1.0;
	var falloffAttenuation: f32 = 1.0;
	let lightDirW: vec3f = evalOmniLight(light.position);
	let lightDirNormW: vec3f = normalize(lightDirW);
	#ifdef CLUSTER_AREALIGHTS
	if (light.shape != {LIGHTSHAPE_PUNCTUAL}) {
		decodeClusterLightAreaData(light);
		if (light.shape == {LIGHTSHAPE_RECT}) {
			calcRectLightValues(light.position, light.halfWidth, light.halfHeight);
		} else if (light.shape == {LIGHTSHAPE_DISK}) {
			calcDiskLightValues(light.position, light.halfWidth, light.halfHeight);
		} else {
			calcSphereLightValues(light.position, light.halfWidth, light.halfHeight);
		}
		falloffAttenuation = getFalloffWindow(light.range, lightDirW);
	} else
	#endif
	{
		if (light.falloffModeLinear) {
			falloffAttenuation = getFalloffLinear(light.range, lightDirW);
		} else {
			falloffAttenuation = getFalloffInvSquared(light.range, lightDirW);
		}
	}
	if (falloffAttenuation > 0.00001) {
		#ifdef CLUSTER_AREALIGHTS
		if (light.shape != {LIGHTSHAPE_PUNCTUAL}) {
			if (light.shape == {LIGHTSHAPE_RECT}) {
				diffuseAttenuation = getRectLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;
			} else if (light.shape == {LIGHTSHAPE_DISK}) {
				diffuseAttenuation = getDiskLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;
			} else {
				diffuseAttenuation = getSphereLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;
			}
		} else
		#endif
		{
			falloffAttenuation = falloffAttenuation * getLightDiffuse(worldNormal, viewDir, lightDirNormW);
		}
		if (light.isSpot) {
			decodeClusterLightSpot(light);
			falloffAttenuation = falloffAttenuation * getSpotEffect(light.direction, light.innerConeAngleCos, light.outerConeAngleCos, lightDirNormW);
		}
		#if defined(CLUSTER_COOKIES) || defined(CLUSTER_SHADOWS)
		if (falloffAttenuation > 0.00001) {
			if (light.shadowIntensity > 0.0 || light.cookieIntensity > 0.0) {
				if (light.isSpot) {
					decodeClusterLightProjectionMatrixData(light);
				} else {
					decodeClusterLightOmniAtlasViewport(light);
				}
				let shadowTextureResolution: f32 = uniform.shadowAtlasParams.x;
				let shadowEdgePixels: f32 = uniform.shadowAtlasParams.y;
				#ifdef CLUSTER_COOKIES
				if (light.cookieIntensity > 0.0) {
					decodeClusterLightCookieData(light);
					if (light.isSpot) {
						cookieAttenuation = getCookie2DClustered(cookieAtlasTexture, cookieAtlasTextureSampler, lightProjectionMatrix, vPositionW, light.cookieIntensity, light.cookieChannelMask);
					} else {
						cookieAttenuation = getCookieCubeClustered(cookieAtlasTexture, cookieAtlasTextureSampler, lightDirW, light.cookieIntensity, light.cookieChannelMask, shadowTextureResolution, shadowEdgePixels, light.omniAtlasViewport);
					}
				}
				#endif
				#ifdef CLUSTER_SHADOWS
				if (light.shadowIntensity > 0.0) {
					decodeClusterLightShadowData(light);
					let shadowParams: vec4f = vec4f(shadowTextureResolution, light.shadowNormalBias, light.shadowBias, 1.0 / light.range);
					if (light.isSpot) {
						let shadowCoord: vec3f = getShadowCoordPerspZbufferNormalOffset(lightProjectionMatrix, shadowParams, geometricNormal);
						#if defined(CLUSTER_SHADOW_TYPE_PCF1)
							let shadow: f32 = getShadowSpotClusteredPCF1(shadowAtlasTexture, shadowAtlasTextureSampler, shadowCoord, shadowParams);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF3)
							let shadow: f32 = getShadowSpotClusteredPCF3(shadowAtlasTexture, shadowAtlasTextureSampler, shadowCoord, shadowParams);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF5)
							let shadow: f32 = getShadowSpotClusteredPCF5(shadowAtlasTexture, shadowAtlasTextureSampler, shadowCoord, shadowParams);
						#elif defined(CLUSTER_SHADOW_TYPE_PCSS)
							let shadow: f32 = getShadowSpotClusteredPCSS(shadowAtlasTexture, shadowAtlasTextureSampler, shadowCoord, shadowParams);
						#endif
						falloffAttenuation = falloffAttenuation * mix(1.0, shadow, light.shadowIntensity);
					} else {
						let dir: vec3f = normalOffsetPointShadow(shadowParams, light.position, lightDirW, lightDirNormW, geometricNormal);
						#if defined(CLUSTER_SHADOW_TYPE_PCF1)
							let shadow: f32 = getShadowOmniClusteredPCF1(shadowAtlasTexture, shadowAtlasTextureSampler, shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF3)
							let shadow: f32 = getShadowOmniClusteredPCF3(shadowAtlasTexture, shadowAtlasTextureSampler, shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF5)
							let shadow: f32 = getShadowOmniClusteredPCF5(shadowAtlasTexture, shadowAtlasTextureSampler, shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);
						#endif
						falloffAttenuation = falloffAttenuation * mix(1.0, shadow, light.shadowIntensity);
					}
				}
				#endif
			}
		}
		#endif
		#ifdef CLUSTER_AREALIGHTS
		if (light.shape != {LIGHTSHAPE_PUNCTUAL}) {
			{
				var areaDiffuse: vec3f = (diffuseAttenuation * falloffAttenuation) * light.color * cookieAttenuation;
				#if defined(LIT_SPECULAR)
					areaDiffuse = mix(areaDiffuse, vec3f(0.0), dLTCSpecFres);
				#endif
				dDiffuseLight = dDiffuseLight + areaDiffuse;
			}
			#ifdef LIT_SPECULAR
				var areaLightSpecular: f32;
				if (light.shape == {LIGHTSHAPE_RECT}) {
					areaLightSpecular = getRectLightSpecular(worldNormal, viewDir);
				} else if (light.shape == {LIGHTSHAPE_DISK}) {
					areaLightSpecular = getDiskLightSpecular(worldNormal, viewDir);
				} else {
					areaLightSpecular = getSphereLightSpecular(worldNormal, viewDir);
				}
				dSpecularLight = dSpecularLight + dLTCSpecFres * areaLightSpecular * falloffAttenuation * light.color * cookieAttenuation;
				#ifdef LIT_CLEARCOAT
					var areaLightSpecularCC: f32;
					if (light.shape == {LIGHTSHAPE_RECT}) {
						areaLightSpecularCC = getRectLightSpecular(clearcoat_worldNormal, viewDir);
					} else if (light.shape == {LIGHTSHAPE_DISK}) {
						areaLightSpecularCC = getDiskLightSpecular(clearcoat_worldNormal, viewDir);
					} else {
						areaLightSpecularCC = getSphereLightSpecular(clearcoat_worldNormal, viewDir);
					}
					ccSpecularLight = ccSpecularLight + ccLTCSpecFres * areaLightSpecularCC * falloffAttenuation * light.color  * cookieAttenuation;
				#endif
			#endif
		} else
		#endif
		{
			{
				var punctualDiffuse: vec3f = falloffAttenuation * light.color * cookieAttenuation;
				#if defined(CLUSTER_AREALIGHTS)
				#if defined(LIT_SPECULAR)
					punctualDiffuse = mix(punctualDiffuse, vec3f(0.0), specularity);
				#endif
				#endif
				dDiffuseLight = dDiffuseLight + punctualDiffuse;
			}
			#ifdef LIT_SPECULAR
				let halfDir: vec3f = normalize(-lightDirNormW + viewDir);
				#ifdef LIT_SPECULAR_FRESNEL
					dSpecularLight = dSpecularLight +
						getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, lightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation *
						getFresnel(
							dot(viewDir, halfDir),
							gloss,
							specularity
						#if defined(LIT_IRIDESCENCE)
							, iridescenceFresnel,
							iridescence_intensity
						#endif
							);
				#else
					dSpecularLight = dSpecularLight + getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, lightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * specularity;
				#endif
				#ifdef LIT_CLEARCOAT
					#ifdef LIT_SPECULAR_FRESNEL
						ccSpecularLight = ccSpecularLight + getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, lightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * getFresnelCC(dot(viewDir, halfDir));
					#else
						ccSpecularLight = ccSpecularLight + getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, lightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation;
					#endif
				#endif
				#ifdef LIT_SHEEN
					sSpecularLight = sSpecularLight + getLightSpecularSheen(halfDir, worldNormal, viewDir, lightDirNormW, sheen_gloss) * falloffAttenuation * light.color * cookieAttenuation;
				#endif
			#endif
		}
	}
	dAtten = falloffAttenuation;
	dLightDirNormW = lightDirNormW;
}
fn evaluateClusterLight(
	lightIndex: f32,
	worldNormal: vec3f,
	viewDir: vec3f,
	reflectionDir: vec3f,
#if defined(LIT_CLEARCOAT)
	clearcoatReflectionDir: vec3f,
#endif
	gloss: f32,
	specularity: vec3f,
	geometricNormal: vec3f,
	tbn: mat3x3f,
#if defined(LIT_IRIDESCENCE)
	iridescenceFresnel: vec3f,
#endif
	clearcoat_worldNormal: vec3f,
	clearcoat_gloss: f32,
	sheen_gloss: f32,
	iridescence_intensity: f32
) {
	var clusterLightData: ClusterLightData;
	decodeClusterLightCore(&clusterLightData, lightIndex);
	#ifdef CLUSTER_MESH_DYNAMIC_LIGHTS
		let acceptLightMask: bool = clusterLightData.isDynamic;
	#else
		let acceptLightMask: bool = clusterLightData.isLightmapped;
	#endif
	if (acceptLightMask) {
		evaluateLight(
			&clusterLightData,
			worldNormal,
			viewDir,
			reflectionDir,
#if defined(LIT_CLEARCOAT)
			clearcoatReflectionDir,
#endif
			gloss,
			specularity,
			geometricNormal,
			tbn,
#if defined(LIT_IRIDESCENCE)
			iridescenceFresnel,
#endif
			clearcoat_worldNormal,
			clearcoat_gloss,
			sheen_gloss,
			iridescence_intensity
		);
	}
}
fn addClusteredLights(
	worldNormal: vec3f,
	viewDir: vec3f,
	reflectionDir: vec3f,
#if defined(LIT_CLEARCOAT)
	clearcoatReflectionDir: vec3f,
#endif
	gloss: f32,
	specularity: vec3f,
	geometricNormal: vec3f,
	tbn: mat3x3f,
#if defined(LIT_IRIDESCENCE)
	iridescenceFresnel: vec3f,
#endif
	clearcoat_worldNormal: vec3f,
	clearcoat_gloss: f32,
	sheen_gloss: f32,
	iridescence_intensity: f32
) {
	if (uniform.clusterSkip > 0.5) {
		return;
	}
	let cellCoords: vec3f = floor((vPositionW - uniform.clusterBoundsMin) * uniform.clusterCellsCountByBoundsSize);
	if (!(any(cellCoords < vec3f(0.0)) || any(cellCoords >= uniform.clusterCellsMax))) {
		let cellIndex: f32 = dot(uniform.clusterCellsDot, cellCoords);
		let clusterV: f32 = floor(cellIndex * uniform.clusterTextureSize.y);
		let clusterU: f32 = cellIndex - (clusterV * uniform.clusterTextureSize.x);
		for (var lightCellIndex: i32 = 0; lightCellIndex < uniform.clusterMaxCells; lightCellIndex = lightCellIndex + 1) {
			let lightIndexPacked: f32 = textureLoad(clusterWorldTexture, vec2<i32>(i32(clusterU) + lightCellIndex, i32(clusterV)), 0).r;
			if (lightIndexPacked <= 0.0) {
				break;
			}
			evaluateClusterLight(
				lightIndexPacked * 255.0,
				worldNormal,
				viewDir,
				reflectionDir,
#if defined(LIT_CLEARCOAT)
				clearcoatReflectionDir,
#endif
				gloss,
				specularity,
				geometricNormal,
				tbn,
#if defined(LIT_IRIDESCENCE)
				iridescenceFresnel,
#endif
				clearcoat_worldNormal,
				clearcoat_gloss,
				sheen_gloss,
				iridescence_intensity
			);
		}
	}
}`});var SW,TW=m(()=>{SW=`
fn combineColor(albedo: vec3f, sheenSpecularity: vec3f, clearcoatSpecularity: f32) -> vec3f {
	var ret: vec3f = vec3f(0.0);
	#ifdef LIT_OLD_AMBIENT
		ret = ret + ((dDiffuseLight - uniform.light_globalAmbient) * albedo + uniform.material_ambient * uniform.light_globalAmbient);
	#else
		ret = ret + (albedo * dDiffuseLight);
	#endif
	#ifdef LIT_SPECULAR
		ret = ret + dSpecularLight;
	#endif
	#ifdef LIT_REFLECTIONS
		ret = ret + (dReflection.rgb * dReflection.a);
	#endif
	#ifdef LIT_SHEEN
		let sheenScaling: f32 = 1.0 - max(max(sheenSpecularity.r, sheenSpecularity.g), sheenSpecularity.b) * 0.157;
		ret = ret * sheenScaling + (sSpecularLight + sReflection.rgb) * sheenSpecularity;
	#endif
	#ifdef LIT_CLEARCOAT
		let clearCoatScaling: f32 = 1.0 - ccFresnel * clearcoatSpecularity;
		ret = ret * clearCoatScaling + (ccSpecularLight + ccReflection) * clearcoatSpecularity;
	#endif
	return ret;
}
`});var EW,vW=m(()=>{EW=`
	varying uv0: vec2f;
	var blitTexture: texture_2d<f32>;
	var blitTextureSampler : sampler;
	@fragment
	fn fragmentMain(input : FragmentInput) -> FragmentOutput {
		var output: FragmentOutput;
		output.color = textureSample(blitTexture, blitTextureSampler, input.uv0);
		return output;
	}
`});var xW,yW=m(()=>{xW=`
	varying uv0: vec2f;
	uniform invViewProj: mat4x4<f32>;
	var blitTexture: texture_cube<f32>;
	var blitTextureSampler : sampler;
	@fragment
	fn fragmentMain(input : FragmentInput) -> FragmentOutput {
		var output: FragmentOutput;
		var projPos = vec4f(input.uv0 * 2.0 - 1.0, 0.5, 1.0);
		var worldPos = uniform.invViewProj * projPos;
		output.color = textureSample(blitTexture, blitTextureSampler, worldPos.xyz);
		return output;
	}
`});var AW,PW=m(()=>{AW=`
	attribute vertex_position: vec2f;
	varying uv0: vec2f;
	@vertex
	fn vertexMain(input: VertexInput) -> VertexOutput {
		var output: VertexOutput;
		output.position = vec4f(input.vertex_position, 0.5, 1.0);
		output.uv0 = input.vertex_position * 0.5 + vec2f(0.5, 0.5);
		output.uv0.y = 1.0 - output.uv0.y;
		return output;
	}
`});var RW,CW=m(()=>{RW=`
#if LIT_CUBEMAP_PROJECTION == BOX
	uniform envBoxMin: vec3f;
	uniform envBoxMax: vec3f;
#endif
fn cubeMapProject(nrdir: vec3f) -> vec3f {
	#if LIT_CUBEMAP_PROJECTION == NONE
		return cubeMapRotate(nrdir);
	#endif
	#if LIT_CUBEMAP_PROJECTION == BOX
		let nrdir_rotated: vec3f = cubeMapRotate(nrdir);
		let rbmax: vec3f = (uniform.envBoxMax - vPositionW) / nrdir_rotated;
		let rbmin: vec3f = (uniform.envBoxMin - vPositionW) / nrdir_rotated;
		let rbminmax: vec3f = select(rbmin, rbmax, nrdir_rotated > vec3f(0.0));
		let fa: f32 = min(min(rbminmax.x, rbminmax.y), rbminmax.z);
		let posonbox: vec3f = vPositionW + nrdir_rotated * fa;
		let envBoxPos: vec3f = (uniform.envBoxMin + uniform.envBoxMax) * 0.5;
		return normalize(posonbox - envBoxPos);
	#endif
}
`});var IW,wW=m(()=>{IW=`
#ifdef CUBEMAP_ROTATION
uniform cubeMapRotationMatrix: mat3x3f;
#endif
fn cubeMapRotate(refDir: vec3f) -> vec3f {
#ifdef CUBEMAP_ROTATION
	return refDir * uniform.cubeMapRotationMatrix;
#else
	return refDir;
#endif
}
`});var LW,bW=m(()=>{LW=`
#ifdef DEBUG_ALBEDO_PASS
output.color = vec4(gammaCorrectOutput(dAlbedo), 1.0);
#endif
#ifdef DEBUG_UV0_PASS
output.color = vec4f(litArgs_albedo , 1.0);
#endif
#ifdef DEBUG_WORLD_NORMAL_PASS
output.color = vec4f(litArgs_worldNormal * 0.5 + 0.5, 1.0);
#endif
#ifdef DEBUG_OPACITY_PASS
output.color = vec4f(vec3f(litArgs_opacity) , 1.0);
#endif
#ifdef DEBUG_SPECULARITY_PASS
output.color = vec4f(litArgs_specularity, 1.0);
#endif
#ifdef DEBUG_GLOSS_PASS
output.color = vec4f(vec3f(litArgs_gloss) , 1.0);
#endif
#ifdef DEBUG_METALNESS_PASS
output.color = vec4f(vec3f(litArgs_metalness) , 1.0);
#endif
#ifdef DEBUG_AO_PASS
output.color = vec4f(vec3f(litArgs_ao) , 1.0);
#endif
#ifdef DEBUG_EMISSION_PASS
output.color = vec4f(gammaCorrectOutput(litArgs_emission), 1.0);
#endif
`});var MW,DW=m(()=>{MW=`
#ifdef DEBUG_LIGHTING_PASS
	litArgs_albedo = vec3f(0.5);
#endif
#ifdef DEBUG_UV0_PASS
#ifdef VARYING_VUV0
	litArgs_albedo = vec3f(vUv0, 0.0);
#else
	litArgs_albedo = vec3f(0.0);
#endif
#endif
`});var OW,NW=m(()=>{OW=`
#ifndef _DECODE_INCLUDED_
#define _DECODE_INCLUDED_
fn decodeLinear(raw: vec4f) -> vec3f {
	return raw.rgb;
}
fn decodeGammaFloat(raw: f32) -> f32 {
	return pow(raw, 2.2);
}
fn decodeGamma3(raw: vec3f) -> vec3f {
	return pow(raw, vec3f(2.2));
}
fn decodeGamma(raw: vec4f) -> vec3f {
	return pow(raw.xyz, vec3f(2.2));
}
fn decodeRGBM(raw: vec4f) -> vec3f {
	let color = (8.0 * raw.a) * raw.rgb;
	return color * color;
}
fn decodeRGBP(raw: vec4f) -> vec3f {
	let color = raw.rgb * (-raw.a * 7.0 + 8.0);
	return color * color;
}
fn decodeRGBE(raw: vec4f) -> vec3f {
	return select(vec3f(0.0), raw.xyz * pow(2.0, raw.w * 255.0 - 128.0), raw.a != 0.0);
}
fn passThrough(raw: vec4f) -> vec4f {
	return raw;
}
fn unpackNormalXYZ(nmap: vec4f) -> vec3f {
	return nmap.xyz * 2.0 - 1.0;
}
fn unpackNormalXY(nmap: vec4f) -> vec3f {
	var xy = nmap.wy * 2.0 - 1.0;
	return vec3f(xy, sqrt(1.0 - clamp(dot(xy, xy), 0.0, 1.0)));
}
#endif
`});var FW,UW=m(()=>{FW=`
#ifndef _DETAILMODES_INCLUDED_
#define _DETAILMODES_INCLUDED_
fn detailMode_mul(c1: vec3f, c2: vec3f) -> vec3f {
	return c1 * c2;
}
fn detailMode_add(c1: vec3f, c2: vec3f) -> vec3f {
	return c1 + c2;
}
fn detailMode_screen(c1: vec3f, c2: vec3f) -> vec3f {
	return 1.0 - (1.0 - c1)*(1.0 - c2);
}
fn detailMode_overlay(c1: vec3f, c2: vec3f) -> vec3f {
	return mix(1.0 - 2.0 * (1.0 - c1)*(1.0 - c2), 2.0 * c1 * c2, step(c1, vec3f(0.5)));
}
fn detailMode_min(c1: vec3f, c2: vec3f) -> vec3f {
	return min(c1, c2);
}
fn detailMode_max(c1: vec3f, c2: vec3f) -> vec3f {
	return max(c1, c2);
}
#endif
`});var BW,VW=m(()=>{BW=`
uniform material_diffuse: vec3f;
#ifdef STD_DIFFUSEDETAIL_TEXTURE
	#include "detailModesPS"
#endif
fn getAlbedo() {
	dAlbedo = uniform.material_diffuse.rgb;
	#ifdef STD_DIFFUSE_TEXTURE
		var albedoTexture: vec3f = {STD_DIFFUSE_TEXTURE_DECODE}(textureSampleBias({STD_DIFFUSE_TEXTURE_NAME}, {STD_DIFFUSE_TEXTURE_NAME}Sampler, {STD_DIFFUSE_TEXTURE_UV}, uniform.textureBias)).{STD_DIFFUSE_TEXTURE_CHANNEL};
		#ifdef STD_DIFFUSEDETAIL_TEXTURE
			var albedoDetail: vec3f = {STD_DIFFUSEDETAIL_TEXTURE_DECODE}(textureSampleBias({STD_DIFFUSEDETAIL_TEXTURE_NAME}, {STD_DIFFUSEDETAIL_TEXTURE_NAME}Sampler, {STD_DIFFUSEDETAIL_TEXTURE_UV}, uniform.textureBias)).{STD_DIFFUSEDETAIL_TEXTURE_CHANNEL};
			albedoTexture = detailMode_{STD_DIFFUSEDETAIL_DETAILMODE}(albedoTexture, albedoDetail);
		#endif
		dAlbedo = dAlbedo * albedoTexture;
	#endif
	#ifdef STD_DIFFUSE_VERTEX
		dAlbedo = dAlbedo * gammaCorrectInputVec3(saturate3(vVertexColor.{STD_DIFFUSE_VERTEX_CHANNEL}));
	#endif
}
`});var kW,GW=m(()=>{kW=`
uniform material_emissive: vec3f;
uniform material_emissiveIntensity: f32;
fn getEmission() {
	dEmission = uniform.material_emissive * uniform.material_emissiveIntensity;
	#ifdef STD_EMISSIVE_TEXTURE
	dEmission *= {STD_EMISSIVE_TEXTURE_DECODE}(textureSampleBias({STD_EMISSIVE_TEXTURE_NAME}, {STD_EMISSIVE_TEXTURE_NAME}Sampler, {STD_EMISSIVE_TEXTURE_UV}, uniform.textureBias)).{STD_EMISSIVE_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_EMISSIVE_VERTEX
	dEmission = dEmission * gammaCorrectInputVec3(saturate3(vVertexColor.{STD_EMISSIVE_VERTEX_CHANNEL}));
	#endif
}
`});var zW,HW=m(()=>{zW=`
fn encodeLinear(source: vec3f) -> vec4f {
	return vec4f(source, 1.0);
}
fn encodeGamma(source: vec3f) -> vec4f {
	return vec4f(pow(source + vec3f(0.0000001), vec3f(1.0 / 2.2)), 1.0);
}
fn encodeRGBM(source: vec3f) -> vec4f {
	var color: vec3f = pow(source, vec3f(0.5));
	color *= 1.0 / 8.0;
	var a: f32 = saturate(max(max(color.r, color.g), max(color.b, 1.0 / 255.0)));
	a = ceil(a * 255.0) / 255.0;
	color /= a;
	return vec4f(color, a);
}
fn encodeRGBP(source: vec3f) -> vec4f {
	var gamma: vec3f = pow(source, vec3f(0.5));
	var maxVal: f32 = min(8.0, max(1.0, max(gamma.x, max(gamma.y, gamma.z))));
	var v: f32 = 1.0 - ((maxVal - 1.0) / 7.0);
	v = ceil(v * 255.0) / 255.0;
	return vec4f(gamma / (-v * 7.0 + 8.0), v);
}
fn encodeRGBE(source: vec3f) -> vec4f {
	var maxVal: f32 = max(source.x, max(source.y, source.z));
	if (maxVal < 1e-32) {
		return vec4f(0.0, 0.0, 0.0, 0.0);
	} else {
		var e: f32 = ceil(log2(maxVal));
		return vec4f(source / pow(2.0, e), (e + 128.0) / 255.0);
	}
}
`});var XW,WW=m(()=>{XW=`
	var finalRgb: vec3f = combineColor(litArgs_albedo, litArgs_sheen_specularity, litArgs_clearcoat_specularity);
	finalRgb = finalRgb + litArgs_emission;
	finalRgb = addFog(finalRgb);
	finalRgb = toneMap(finalRgb);
	finalRgb = gammaCorrectOutput(finalRgb);
	output.color = vec4f(finalRgb, output.color.a);
`});var YW,KW=m(()=>{YW=`
#ifndef _ENVATLAS_INCLUDED_
#define _ENVATLAS_INCLUDED_
const atlasSize : f32 = 512.0;
const seamSize : f32 = 1.0 / atlasSize;
fn mapUv(uv : vec2f, rect : vec4f) -> vec2f {
	return vec2f(mix(rect.x + seamSize, rect.x + rect.z - seamSize, uv.x),
				 mix(rect.y + seamSize, rect.y + rect.w - seamSize, uv.y));
}
fn mapRoughnessUv(uv : vec2f, level : f32) -> vec2f {
	let t : f32 = 1.0 / exp2(level);
	return mapUv(uv, vec4f(0.0, 1.0 - t, t, t * 0.5));
}
fn mapShinyUv(uv : vec2f, level : f32) -> vec2f {
	let t : f32 = 1.0 / exp2(level);
	return mapUv(uv, vec4f(1.0 - t, 1.0 - t, t, t * 0.5));
}
#endif
`});var qW,jW=m(()=>{qW=`
#ifdef LIT_SKYBOX_INTENSITY
	uniform skyboxIntensity : f32;
#endif
fn processEnvironment(color : vec3f) -> vec3f {
	#ifdef LIT_SKYBOX_INTENSITY
		return color * uniform.skyboxIntensity;
	#else
		return color;
	#endif
}
`});var $W,ZW=m(()=>{$W=`
fn getFalloffWindow(lightRadius: f32, lightDir: vec3f) -> f32 {
	let sqrDist: f32 = dot(lightDir, lightDir);
	let invRadius: f32 = 1.0 / lightRadius;
	return square(saturate(1.0 - square(sqrDist * square(invRadius))));
}
fn getFalloffInvSquared(lightRadius: f32, lightDir: vec3f) -> f32 {
	let sqrDist: f32 = dot(lightDir, lightDir);
	var falloff: f32 = 1.0 / (sqrDist + 1.0);
	let invRadius: f32 = 1.0 / lightRadius;
	falloff = falloff * 16.0;
	falloff = falloff * square(saturate(1.0 - square(sqrDist * square(invRadius))));
	return falloff;
}
`});var QW,JW=m(()=>{QW=`
fn getFalloffLinear(lightRadius: f32, lightDir: vec3f) -> f32 {
	let d: f32 = length(lightDir);
	return max(((lightRadius - d) / lightRadius), 0.0);
}
`});var eY,tY=m(()=>{eY=`
#ifndef FLOAT_AS_UINT
#define FLOAT_AS_UINT
fn float2uint(value: f32) -> vec4f {
	let intBits = bitcast<u32>(value);
	return vec4f(
		f32((intBits >> 24u) & 0xffu),
		f32((intBits >> 16u) & 0xffu),
		f32((intBits >> 8u) & 0xffu),
		f32(intBits & 0xffu)
	) / 255.0;
}
fn uint2float(value: vec4f) -> f32 {
	let rgba_u32 = vec4<u32>(value * 255.0);
	let intBits: u32 =
		(rgba_u32.r << 24u) |
		(rgba_u32.g << 16u) |
		(rgba_u32.b << 8u)  |
		 rgba_u32.a;
	return bitcast<f32>(intBits);
}
fn float2vec4(value: f32) -> vec4f {
	#if defined(CAPS_TEXTURE_FLOAT_RENDERABLE)
		return vec4f(value, 1.0, 1.0, 1.0);
	#else
		return float2uint(value);
	#endif
}
#endif
`});var sY,iY=m(()=>{sY=`
var<private> dBlendModeFogFactor : f32 = 1.0;
#if (FOG != NONE)
	uniform fog_color : vec3f;
	
	#if (FOG == LINEAR)
		uniform fog_start : f32;
		uniform fog_end : f32;
	#else
		uniform fog_density : f32;
	#endif
#endif
fn getFogFactor() -> f32 {
	let depth = pcPosition.z / pcPosition.w;
	var fogFactor : f32 = 0.0;
	#if (FOG == LINEAR)
		fogFactor = (uniform.fog_end - depth) / (uniform.fog_end - uniform.fog_start);
	#elif (FOG == EXP)
		fogFactor = exp(-depth * uniform.fog_density);
	#elif (FOG == EXP2)
		fogFactor = exp(-depth * depth * uniform.fog_density * uniform.fog_density);
	#endif
	return clamp(fogFactor, 0.0, 1.0);
}
fn addFog(color : vec3f) -> vec3f {
	#if (FOG != NONE)
		return mix(uniform.fog_color * dBlendModeFogFactor, color, getFogFactor());
	#else
		return color;
	#endif
}
`});var rY,aY=m(()=>{rY=`
fn getFresnel(
		cosTheta: f32,
		gloss: f32,
		specularity: vec3f
	#if defined(LIT_IRIDESCENCE)
		, iridescenceFresnel: vec3f,
		iridescenceIntensity: f32
	#endif
) -> vec3f {
	let fresnel: f32 = pow(1.0 - saturate(cosTheta), 5.0);
	let glossSq: f32 = gloss * gloss;
	let ret: vec3f = specularity + (max(vec3f(glossSq), specularity) - specularity) * fresnel;
	#if defined(LIT_IRIDESCENCE)
		return mix(ret, iridescenceFresnel, iridescenceIntensity);
	#else
		return ret;
	#endif
}
fn getFresnelCC(cosTheta: f32) -> f32 {
	let fresnel: f32 = pow(1.0 - saturate(cosTheta), 5.0);
	return 0.04 + (1.0 - 0.04) * fresnel;
}`});var nY,oY=m(()=>{nY=`
attribute vertex_position: vec2f;
varying vUv0: vec2f;
@vertex
fn vertexMain(input: VertexInput) -> VertexOutput {
	var output: VertexOutput;
	output.position = vec4f(input.vertex_position, 0.5, 1.0);
	output.vUv0 = input.vertex_position.xy * 0.5 + vec2f(0.5);
	return output;
}
`});var lY,hY=m(()=>{lY=`
#include "decodePS"
#if (GAMMA == SRGB)
	fn gammaCorrectInput(color: f32) -> f32 {
		return decodeGammaFloat(color);
	}
	fn gammaCorrectInputVec3(color: vec3f) -> vec3f {
		return decodeGamma3(color);
	}
	fn gammaCorrectInputVec4(color: vec4f) -> vec4f {
		return vec4f(decodeGamma3(color.xyz), color.w);
	}
	fn gammaCorrectOutput(color: vec3f) -> vec3f {
		return pow(color + 0.0000001, vec3f(1.0 / 2.2));
	}
#else
	fn gammaCorrectInput(color: f32) -> f32 {
		return color;
	}
	fn gammaCorrectInputVec3(color: vec3f) -> vec3f {
		return color;
	}
	fn gammaCorrectInputVec4(color: vec4f) -> vec4f {
		return color;
	}
	fn gammaCorrectOutput(color: vec3f) -> vec3f {
		return color;
	}
#endif
`});var cY,fY=m(()=>{cY=`
#ifdef STD_GLOSS_CONSTANT
	uniform material_gloss: f32;
#endif
fn getGlossiness() {
	dGlossiness = 1.0;
	#ifdef STD_GLOSS_CONSTANT
	dGlossiness = dGlossiness * uniform.material_gloss;
	#endif
	#ifdef STD_GLOSS_TEXTURE
	dGlossiness = dGlossiness * textureSampleBias({STD_GLOSS_TEXTURE_NAME}, {STD_GLOSS_TEXTURE_NAME}Sampler, {STD_GLOSS_TEXTURE_UV}, uniform.textureBias).{STD_GLOSS_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_GLOSS_VERTEX
	dGlossiness = dGlossiness * saturate(vVertexColor.{STD_GLOSS_VERTEX_CHANNEL});
	#endif
	#ifdef STD_GLOSS_INVERT
	dGlossiness = 1.0 - dGlossiness;
	#endif
	dGlossiness = dGlossiness + 0.0000001;
}
`});var dY,uY=m(()=>{dY=`
uniform matrix_model: mat4x4f;
uniform matrix_view: mat4x4f;
uniform matrix_projection: mat4x4f;
fn initCenter(modelCenter: vec3f, center: ptr<function, SplatCenter>) -> bool {
	let modelView: mat4x4f = uniform.matrix_view * uniform.matrix_model;
	let centerView: vec4f = modelView * vec4f(modelCenter, 1.0);
	if (centerView.z > 0.0) {
		return false;
	}
	var centerProj: vec4f = uniform.matrix_projection * centerView;
	centerProj.z = clamp(centerProj.z, 0.0, abs(centerProj.w));
	center.view = centerView.xyz / centerView.w;
	center.proj = centerProj;
	center.projMat00 = uniform.matrix_projection[0][0];
	center.modelView = modelView;
	return true;
}
`});var mY,pY=m(()=>{mY=`
var splatColor: texture_2d<f32>;
fn readColor(source: ptr<function, SplatSource>) -> vec4f {
	return textureLoad(splatColor, source.uv, 0);
}
`});var _Y,gY=m(()=>{_Y=`
struct SplatSource {
	order: u32,
	id: u32,
	uv: vec2<i32>,
	cornerUV: vec2f,
}
struct SplatCenter {
	view: vec3f,
	proj: vec4f,
	modelView: mat4x4f,
	projMat00: f32,
}
struct SplatCorner {
	offset: vec2f,
	uv: vec2f,
	#if GSPLAT_AA
		aaFactor: f32,
	#endif
}
#include "gsplatEvalSHVS"
#include "gsplatQuatToMat3VS"
#if GSPLAT_COMPRESSED_DATA
	#include "gsplatCompressedDataVS"
	#if SH_BANDS > 0
		#include "gsplatCompressedSHVS"
	#endif
#elif GSPLAT_SOGS_DATA
	#include "gsplatSogsDataVS"
	#include "gsplatSogsColorVS"
	#if SH_BANDS > 0
		#include "gsplatSogsSHVS"
	#endif
#else
	#include "gsplatDataVS"
	#include "gsplatColorVS"
	#if SH_BANDS > 0
		#include "gsplatSHVS"
	#endif
#endif
#include "gsplatSourceVS"
#include "gsplatCenterVS"
#include "gsplatCornerVS"
#include "gsplatOutputVS"
fn clipCorner(corner: ptr<function, SplatCorner>, alpha: f32) {
	let clip: f32 = min(1.0, sqrt(-log(1.0 / (255.0 * alpha))) / 2.0);
	corner.offset = corner.offset * clip;
	corner.uv = corner.uv * clip;
}
`});var SY,TY=m(()=>{SY=`
var packedTexture: texture_2d<u32>;
var chunkTexture: texture_2d<f32>;
var<private> chunkDataA: vec4f;
var<private> chunkDataB: vec4f;
var<private> chunkDataC: vec4f;
var<private> chunkDataD: vec4f;
var<private> chunkDataE: vec4f;
var<private> packedData: vec4u;
fn unpack111011(bits: u32) -> vec3f {
	return (vec3f((vec3<u32>(bits) >> vec3<u32>(21u, 11u, 0u)) & vec3<u32>(0x7ffu, 0x3ffu, 0x7ffu))) / vec3f(2047.0, 1023.0, 2047.0);
}
fn unpack8888(bits: u32) -> vec4f {
	return vec4f(
		f32((bits >> 24u) & 0xffu),
		f32((bits >> 16u) & 0xffu),
		f32((bits >> 8u)  & 0xffu),
		f32(bits		 & 0xffu)
	) / 255.0;
}
const norm_const: f32 = 1.0 / (sqrt(2.0) * 0.5);
fn unpackRotation(bits: u32) -> vec4f {
	let a = (f32((bits >> 20u) & 0x3ffu) / 1023.0 - 0.5) * norm_const;
	let b = (f32((bits >> 10u) & 0x3ffu) / 1023.0 - 0.5) * norm_const;
	let c = (f32(bits & 0x3ffu) / 1023.0 - 0.5) * norm_const;
	let m = sqrt(1.0 - (a * a + b * b + c * c));
	let mode = bits >> 30u;
	if (mode == 0u) { return vec4f(m, a, b, c); }
	if (mode == 1u) { return vec4f(a, m, b, c); }
	if (mode == 2u) { return vec4f(a, b, m, c); }
	return vec4f(a, b, c, m);
}
fn readCenter(source: ptr<function, SplatSource>) -> vec3f {
	let tex_size_u = textureDimensions(chunkTexture, 0);
	let w: u32 = tex_size_u.x / 5u;
	let chunkId: u32 = source.id / 256u;
	let chunkUV: vec2<i32> = vec2<i32>(i32((chunkId % w) * 5u), i32(chunkId / w));
	chunkDataA = textureLoad(chunkTexture, chunkUV + vec2<i32>(0, 0), 0);
	chunkDataB = textureLoad(chunkTexture, chunkUV + vec2<i32>(1, 0), 0);
	chunkDataC = textureLoad(chunkTexture, chunkUV + vec2<i32>(2, 0), 0);
	chunkDataD = textureLoad(chunkTexture, chunkUV + vec2<i32>(3, 0), 0);
	chunkDataE = textureLoad(chunkTexture, chunkUV + vec2<i32>(4, 0), 0);
	packedData = textureLoad(packedTexture, source.uv, 0);
	return mix(chunkDataA.xyz, vec3f(chunkDataA.w, chunkDataB.xy), unpack111011(packedData.x));
}
fn readColor(source: ptr<function, SplatSource>) -> vec4f {
	let r = unpack8888(packedData.w);
	return vec4f(mix(chunkDataD.xyz, vec3f(chunkDataD.w, chunkDataE.xy), r.rgb), r.w);
}
fn getRotation() -> vec4f {
	return unpackRotation(packedData.y);
}
fn getScale() -> vec3f {
	return exp(mix(vec3f(chunkDataB.zw, chunkDataC.x), chunkDataC.yzw, unpack111011(packedData.z)));
}
fn readCovariance(source: ptr<function, SplatSource>, covA_ptr: ptr<function, vec3f>, covB_ptr: ptr<function, vec3f>) {
	let rot = quatToMat3(getRotation());
	let scale = getScale();
	let M = transpose(mat3x3f(
		scale.x * rot[0],
		scale.y * rot[1],
		scale.z * rot[2]
	));
	*covA_ptr = vec3f(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));
	*covB_ptr = vec3f(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));
}
`});var EY,vY=m(()=>{EY=`
#if SH_BANDS > 0
var shTexture0: texture_2d<u32>;
var shTexture1: texture_2d<u32>;
var shTexture2: texture_2d<u32>;
fn unpack8888s(bits: u32) -> vec4f {
	let unpacked_u = (vec4<u32>(bits) >> vec4<u32>(0u, 8u, 16u, 24u)) & vec4<u32>(0xffu);
	return vec4f(unpacked_u) * (8.0 / 255.0) - 4.0;
}
fn readSHData(source: ptr<function, SplatSource>, sh: ptr<function, array<vec3f, 15>>, scale: ptr<function, f32>) {
	let shData0: vec4<u32> = textureLoad(shTexture0, source.uv, 0);
	let shData1: vec4<u32> = textureLoad(shTexture1, source.uv, 0);
	let shData2: vec4<u32> = textureLoad(shTexture2, source.uv, 0);
	let r0 = unpack8888s(shData0.x);
	let r1 = unpack8888s(shData0.y);
	let r2 = unpack8888s(shData0.z);
	let r3 = unpack8888s(shData0.w);
	let g0 = unpack8888s(shData1.x);
	let g1 = unpack8888s(shData1.y);
	let g2 = unpack8888s(shData1.z);
	let g3 = unpack8888s(shData1.w);
	let b0 = unpack8888s(shData2.x);
	let b1 = unpack8888s(shData2.y);
	let b2 = unpack8888s(shData2.z);
	let b3 = unpack8888s(shData2.w);
	sh[0] =  vec3f(r0.x, g0.x, b0.x);
	sh[1] =  vec3f(r0.y, g0.y, b0.y);
	sh[2] =  vec3f(r0.z, g0.z, b0.z);
	sh[3] =  vec3f(r0.w, g0.w, b0.w);
	sh[4] =  vec3f(r1.x, g1.x, b1.x);
	sh[5] =  vec3f(r1.y, g1.y, b1.y);
	sh[6] =  vec3f(r1.z, g1.z, b1.z);
	sh[7] =  vec3f(r1.w, g1.w, b1.w);
	sh[8] =  vec3f(r2.x, g2.x, b2.x);
	sh[9] =  vec3f(r2.y, g2.y, b2.y);
	sh[10] = vec3f(r2.z, g2.z, b2.z);
	sh[11] = vec3f(r2.w, g2.w, b2.w);
	sh[12] = vec3f(r3.x, g3.x, b3.x);
	sh[13] = vec3f(r3.y, g3.y, b3.y);
	sh[14] = vec3f(r3.z, g3.z, b3.z);
	*scale = 1.0;
}
#endif
`});var xY,yY=m(()=>{xY=`
	#if SH_BANDS == 1
		const SH_COEFFS: i32 = 3;
	#elif SH_BANDS == 2
		const SH_COEFFS: i32 = 8;
	#elif SH_BANDS == 3
		const SH_COEFFS: i32 = 15;
	#else
		const SH_COEFFS: i32 = 0;
	#endif
	#if SH_BANDS > 0
	const SH_C1: f32 = 0.4886025119029199;
	#if SH_BANDS > 1
		const SH_C2_0: f32 = 1.0925484305920792;
		const SH_C2_1: f32 = -1.0925484305920792;
		const SH_C2_2: f32 = 0.31539156525252005;
		const SH_C2_3: f32 = -1.0925484305920792;
		const SH_C2_4: f32 = 0.5462742152960396;
	#endif
	#if SH_BANDS > 2
		const SH_C3_0: f32 = -0.5900435899266435;
		const SH_C3_1: f32 = 2.890611442640554;
		const SH_C3_2: f32 = -0.4570457994644658;
		const SH_C3_3: f32 = 0.3731763325901154;
		const SH_C3_4: f32 = -0.4570457994644658;
		const SH_C3_5: f32 = 1.445305721320277;
		const SH_C3_6: f32 = -0.5900435899266435;
	#endif
	fn evalSH(sh: ptr<function, array<vec3f, SH_COEFFS>>, dir: vec3f) -> vec3f {
		let x = dir.x;
		let y = dir.y;
		let z = dir.z;
		var result = SH_C1 * (-sh[0] * y + sh[1] * z - sh[2] * x);
		#if SH_BANDS > 1
			let xx = x * x;
			let yy = y * y;
			let zz = z * z;
			let xy = x * y;
			let yz = y * z;
			let xz = x * z;
			result = result + (
				sh[3] * (SH_C2_0 * xy) +
				sh[4] * (SH_C2_1 * yz) +
				sh[5] * (SH_C2_2 * (2.0 * zz - xx - yy)) +
				sh[6] * (SH_C2_3 * xz) +
				sh[7] * (SH_C2_4 * (xx - yy))
			);
		#endif
		#if SH_BANDS > 2
			result = result + (
				sh[8]  * (SH_C3_0 * y * (3.0 * xx - yy)) +
				sh[9]  * (SH_C3_1 * xy * z) +
				sh[10] * (SH_C3_2 * y * (4.0 * zz - xx - yy)) +
				sh[11] * (SH_C3_3 * z * (2.0 * zz - 3.0 * xx - 3.0 * yy)) +
				sh[12] * (SH_C3_4 * x * (4.0 * zz - xx - yy)) +
				sh[13] * (SH_C3_5 * z * (xx - yy)) +
				sh[14] * (SH_C3_6 * x * (xx - 3.0 * yy))
			);
		#endif
		return result;
	}
	#endif
`});var AY,PY=m(()=>{AY=`
fn quatToMat3(R: vec4<f32>) -> mat3x3<f32> {
	let R2: vec4<f32> = R + R;
	let X: f32	   = R2.x * R.w;
	let Y: vec4<f32> = R2.y * R;
	let Z: vec4<f32> = R2.z * R;
	let W: f32	   = R2.w * R.w;
	return mat3x3<f32>(
		1.0 - Z.z - W,  Y.z + X,	  Y.w - Z.x,
		Y.z - X,		1.0 - Y.y - W, Z.w + Y.x,
		Y.w + Z.x,	  Z.w - Y.x,	 1.0 - Y.y - Z.z
	);
}
`});var RY,CY=m(()=>{RY=`
var sh0: texture_2d<f32>;
uniform sh0_mins: vec4f;
uniform sh0_maxs: vec4f;
const SH_C0: f32 = 0.28209479177387814;
fn readColor(source: ptr<function, SplatSource>) -> vec4f {
	let clr: vec4f = mix(uniform.sh0_mins, uniform.sh0_maxs, textureLoad(sh0, source.uv, 0));
	return vec4f(vec3f(0.5) + clr.xyz * SH_C0, 1.0 / (1.0 + exp(-clr.w)));
}
`});var IY,wY=m(()=>{IY=`
var packedTexture: texture_2d<u32>;
uniform means_mins: vec3f;
uniform means_maxs: vec3f;
uniform scales_mins: vec3f;
uniform scales_maxs: vec3f;
fn unpackU32(u: u32) -> vec4f {
	return vec4f(
		f32((u >> 24u) & 0xFFu) / 255.0,
		f32((u >> 16u) & 0xFFu) / 255.0,
		f32((u >> 8u) & 0xFFu) / 255.0,
		f32(u & 0xFFu) / 255.0
	);
}
var<private> packedSample: vec4<u32>;
fn readCenter(source: ptr<function, SplatSource>) -> vec3f {
	packedSample = textureLoad(packedTexture, source.uv, 0);
	let l: vec3f = unpackU32(packedSample.x).xyz;
	let u: vec3f = unpackU32(packedSample.y).xyz;
	let n: vec3f = (l * 255.0 + u * 255.0 * 256.0) / 65535.0;
	let v: vec3f = mix(uniform.means_mins, uniform.means_maxs, n);
	return sign(v) * (exp(abs(v)) - 1.0);
}
const norm: f32 = 2.0 / sqrt(2.0);
fn readCovariance(source: ptr<function, SplatSource>, covA_ptr: ptr<function, vec3f>, covB_ptr: ptr<function, vec3f>) {
	let qdata: vec4f = unpackU32(packedSample.z);
	let sdata: vec3f = unpackU32(packedSample.w).xyz;
	let abc: vec3f = (qdata.xyz - 0.5) * norm;
	let d: f32 = sqrt(max(0.0, 1.0 - dot(abc, abc)));
	let mode: u32 = u32(qdata.w * 255.0 + 0.5) - 252u;
	var quat: vec4f;
	if (mode == 0u) {
		quat = vec4f(d, abc);
	} else if (mode == 1u) {
		quat = vec4f(abc.x, d, abc.y, abc.z);
	} else if (mode == 2u) {
		quat = vec4f(abc.x, abc.y, d, abc.z);
	} else {
		quat = vec4f(abc.x, abc.y, abc.z, d);
	}
	let rot: mat3x3f = quatToMat3(quat);
	let scale: vec3f = exp(mix(uniform.scales_mins, uniform.scales_maxs, sdata));
	let M: mat3x3f = transpose(mat3x3f(
		scale.x * rot[0],
		scale.y * rot[1],
		scale.z * rot[2]
	));
	*covA_ptr = vec3f(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));
	*covB_ptr = vec3f(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));
}
`});var LY,bY=m(()=>{LY=`
var sh_centroids: texture_2d<f32>;
uniform shN_mins: f32;
uniform shN_maxs: f32;
fn readSHData(source: ptr<function, SplatSource>, sh: ptr<function, array<vec3f, SH_COEFFS>>, scale: ptr<function, f32>) {
	let t: vec2<i32> = vec2<i32>(i32(packedSample.x & 255u), i32(packedSample.y & 255u));
	let n: i32 = t.x + t.y * 256;
	let u: i32 = (n % 64) * SH_COEFFS;
	let v: i32 = n / 64;
	for (var i: i32 = 0; i < SH_COEFFS; i = i + 1) {
		sh[i] = mix(vec3f(uniform.shN_mins), vec3f(uniform.shN_maxs), textureLoad(sh_centroids, vec2<i32>(u + i, v), 0).xyz);
	}
	*scale = 1.0;
}
`});var MY,DY=m(()=>{MY=`
uniform viewport: vec2f;
uniform camera_params: vec4f;
fn initCorner(source: ptr<function, SplatSource>, center: ptr<function, SplatCenter>, corner: ptr<function, SplatCorner>) -> bool {
	var covA: vec3f;
	var covB: vec3f;
	readCovariance(source, &covA, &covB);
	let Vrk = mat3x3f(
		vec3f(covA.x, covA.y, covA.z),
		vec3f(covA.y, covB.x, covB.y),
		vec3f(covA.z, covB.y, covB.z)
	);
	let focal = uniform.viewport.x * center.projMat00;
	let v = select(center.view.xyz, vec3f(0.0, 0.0, 1.0), uniform.camera_params.w == 1.0);
	let J1 = focal / v.z;
	let J2 = -J1 / v.z * v.xy;
	let J = mat3x3f(
		vec3f(J1, 0.0, J2.x),
		vec3f(0.0, J1, J2.y),
		vec3f(0.0, 0.0, 0.0)
	);
	let W = transpose(mat3x3f(center.modelView[0].xyz, center.modelView[1].xyz, center.modelView[2].xyz));
	let T = W * J;
	let cov = transpose(T) * Vrk * T;
	#if GSPLAT_AA
		let detOrig = cov[0][0] * cov[1][1] - cov[0][1] * cov[1][0];
		let detBlur = (cov[0][0] + 0.3) * (cov[1][1] + 0.3) - cov[0][1] * cov[1][0];
		corner.aaFactor = sqrt(detOrig / detBlur);
	#endif
	let diagonal1 = cov[0][0] + 0.3;
	let offDiagonal = cov[0][1];
	let diagonal2 = cov[1][1] + 0.3;
	let mid = 0.5 * (diagonal1 + diagonal2);
	let radius = length(vec2f((diagonal1 - diagonal2) / 2.0, offDiagonal));
	let lambda1 = mid + radius;
	let lambda2 = max(mid - radius, 0.1);
	let vmin = min(1024.0, min(uniform.viewport.x, uniform.viewport.y));
	let l1 = 2.0 * min(sqrt(2.0 * lambda1), vmin);
	let l2 = 2.0 * min(sqrt(2.0 * lambda2), vmin);
	if (l1 < 2.0 && l2 < 2.0) {
		return false;
	}
	let c = center.proj.ww / uniform.viewport;
	if (any((abs(center.proj.xy) - vec2f(max(l1, l2)) * c) > center.proj.ww)) {
		return false;
	}
	let diagonalVector = normalize(vec2f(offDiagonal, lambda1 - diagonal1));
	let v1 = l1 * diagonalVector;
	let v2 = l2 * vec2f(diagonalVector.y, -diagonalVector.x);
	corner.offset = (source.cornerUV.x * v1 + source.cornerUV.y * v2) * c;
	corner.uv = source.cornerUV;
	return true;
}
`});var OY,NY=m(()=>{OY=`
var transformA: texture_2d<u32>;
var transformB: texture_2d<f32>;
var<private> tAw: u32;
fn readCenter(source: ptr<function, SplatSource>) -> vec3f {
	let tA: vec4<u32> = textureLoad(transformA, source.uv, 0);
	tAw = tA.w;
	return bitcast<vec3f>(tA.xyz);
}
fn unpackRotation(packed: vec3f) -> vec4f {
	return vec4f(packed.xyz, sqrt(max(0.0, 1.0 - dot(packed, packed))));
}
fn readCovariance(source: ptr<function, SplatSource>, covA_ptr: ptr<function, vec3f>, covB_ptr: ptr<function, vec3f>) {
	let tB: vec4f = textureLoad(transformB, source.uv, 0);
	let rot: mat3x3f = quatToMat3(unpackRotation(vec3f(unpack2x16float(bitcast<u32>(tAw)), tB.w)).wxyz);
	let scale: vec3f = tB.xyz;
	let M = transpose(mat3x3f(
		scale.x * rot[0],
		scale.y * rot[1],
		scale.z * rot[2]
	));
	*covA_ptr = vec3f(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));
	*covB_ptr = vec3f(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));
}
`});var FY,UY=m(()=>{FY=`
#include "tonemappingPS"
#include "decodePS"
#include "gammaPS"
fn prepareOutputFromGamma(gammaColor: vec3f) -> vec3f {
	#if TONEMAP == NONE
		#if GAMMA == NONE
			return decodeGamma3(gammaColor);
		#else 
			return gammaColor;
		#endif
	#else
		return gammaCorrectOutput(toneMap(decodeGamma3(gammaColor)));
	#endif
}
`});var BY,VY=m(()=>{BY=`
#ifndef DITHER_NONE
	#include "bayerPS"
	#include "opacityDitherPS"
	varying id: f32;
#endif
#ifdef PICK_PASS
	#include "pickPS"
#endif
#if defined(SHADOW_PASS) || defined(PICK_PASS) || defined(PREPASS_PASS)
	uniform alphaClip: f32;
#endif
#ifdef PREPASS_PASS
	varying vLinearDepth: f32;
	#include "floatAsUintPS"
#endif
const EXP_A: f32	  = 12102203.0;
const EXP_BC_RMS: i32 = 1064866808;
fn fastExp(x: f32) -> f32 {
	var i: i32 = i32(EXP_A * x) + EXP_BC_RMS;
	return bitcast<f32>(i);
}
varying gaussianUV: vec2f;
varying gaussianColor: vec4f;
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	let A: f32 = dot(gaussianUV, gaussianUV);
	if (A > 1.0) {
		discard;
		return output;
	}
	var alpha: f32 = fastExp(-A * 4.0) * gaussianColor.a;
	#if defined(SHADOW_PASS) || defined(PICK_PASS) || defined(PREPASS_PASS)
		if (alpha < uniform.alphaClip) {
			discard;
			return output;
		}
	#endif
	#ifdef PICK_PASS
		output.color = getPickOutput();
	#elif SHADOW_PASS
		output.color = vec4f(0.0, 0.0, 0.0, 1.0);
	#elif PREPASS_PASS
		output.color = float2vec4(vLinearDepth);
	#else
		if (alpha < (1.0 / 255.0)) {
			discard;
			return output;
		}
		#ifndef DITHER_NONE
			opacityDither(&alpha, id * 0.013);
		#endif
		output.color = vec4f(input.gaussianColor.xyz * alpha, alpha);
	#endif
	return output;
}`});var kY,GY=m(()=>{kY=`
#if SH_BANDS > 0
fn unpack111011s(bits: u32) -> vec3f {
	return (vec3f((vec3<u32>(bits) >> vec3<u32>(21u, 11u, 0u)) & vec3<u32>(0x7ffu, 0x3ffu, 0x7ffu)) / vec3f(2047.0, 1023.0, 2047.0)) * 2.0 - 1.0;
}
struct ScaleAndSH {
	scale: f32,
	a: vec3f,
	b: vec3f,
	c: vec3f
};
fn fetchScale(t_in: vec4<u32>) -> ScaleAndSH {
	var result: ScaleAndSH;
	result.scale = bitcast<f32>(t_in.x);
	result.a = unpack111011s(t_in.y);
	result.b = unpack111011s(t_in.z);
	result.c = unpack111011s(t_in.w);
	return result;
}
struct SH {
	a: vec3f,
	b: vec3f,
	c: vec3f,
	d: vec3f
};
fn fetch4(t_in: vec4<u32>) -> SH {
	var result: SH;
	result.a = unpack111011s(t_in.x);
	result.b = unpack111011s(t_in.y);
	result.c = unpack111011s(t_in.z);
	result.d = unpack111011s(t_in.w);
	return result;
}
fn fetch1(t_in: u32) -> vec3f {
	return unpack111011s(t_in);
}
#if SH_BANDS == 1
	var splatSH_1to3: texture_2d<u32>;
	fn readSHData(source: ptr<function, SplatSource>, sh: ptr<function, array<vec3f, 3>>, scale: ptr<function, f32>) {
		let result = fetchScale(textureLoad(splatSH_1to3, source.uv, 0));
		*scale = result.scale;
		sh[0] = result.a;
		sh[1] = result.b;
		sh[2] = result.c;
	}
#elif SH_BANDS == 2
	var splatSH_1to3: texture_2d<u32>;
	var splatSH_4to7: texture_2d<u32>;
	var splatSH_8to11: texture_2d<u32>;
	fn readSHData(source: ptr<function, SplatSource>, sh: ptr<function, array<vec3f, 8>>, scale: ptr<function, f32>) {
		let first: ScaleAndSH = fetchScale(textureLoad(splatSH_1to3, source.uv, 0));
		*scale = first.scale;
		sh[0] = first.a;
		sh[1] = first.b;
		sh[2] = first.c;
		let second: SH = fetch4(textureLoad(splatSH_4to7, source.uv, 0));
		sh[3] = second.a;
		sh[4] = second.b;
		sh[5] = second.c;
		sh[6] = second.d;
		sh[7] = fetch1(textureLoad(splatSH_8to11, source.uv, 0).x);
	}
#else
	var splatSH_1to3: texture_2d<u32>;
	var splatSH_4to7: texture_2d<u32>;
	var splatSH_8to11: texture_2d<u32>;
	var splatSH_12to15: texture_2d<u32>;
	fn readSHData(source: ptr<function, SplatSource>, sh: ptr<function, array<vec3f, 15>>, scale: ptr<function, f32>) {
		let first: ScaleAndSH = fetchScale(textureLoad(splatSH_1to3, source.uv, 0));
		*scale = first.scale;
		sh[0] = first.a;
		sh[1] = first.b;
		sh[2] = first.c;
		let second: SH = fetch4(textureLoad(splatSH_4to7, source.uv, 0));
		sh[3] = second.a;
		sh[4] = second.b;
		sh[5] = second.c;
		sh[6] = second.d;
		let third: SH = fetch4(textureLoad(splatSH_8to11, source.uv, 0));
		sh[7] = third.a;
		sh[8] = third.b;
		sh[9] = third.c;
		sh[10] = third.d;
		let fourth: SH = fetch4(textureLoad(splatSH_12to15, source.uv, 0));
		sh[11] = fourth.a;
		sh[12] = fourth.b;
		sh[13] = fourth.c;
		sh[14] = fourth.d;
	}
#endif
#endif
`});var zY,HY=m(()=>{zY=`
attribute vertex_position: vec3f;
attribute vertex_id_attrib: u32;
uniform numSplats: u32;
var splatOrder: texture_2d<u32>;
fn initSource(source: ptr<function, SplatSource>) -> bool {
	let w: u32 = textureDimensions(splatOrder, 0).x;
	source.order = vertex_id_attrib + u32(vertex_position.z);
	if (source.order >= uniform.numSplats) {
		return false;
	}
	let orderUV = vec2i(vec2u(source.order % w, source.order / w));
	source.id = textureLoad(splatOrder, orderUV, 0).r;
	source.uv = vec2i(vec2u(source.id % w, source.id / w));
	source.cornerUV = vertex_position.xy;
	return true;
}
`});var XY,WY=m(()=>{XY=`
#include "gsplatCommonVS"
varying gaussianUV: vec2f;
varying gaussianColor: vec4f;
#ifndef DITHER_NONE
	varying id: f32;
#endif
const discardVec: vec4f = vec4f(0.0, 0.0, 2.0, 1.0);
#ifdef PREPASS_PASS
	varying vLinearDepth: f32;
#endif
@vertex
fn vertexMain(input: VertexInput) -> VertexOutput {
	var output: VertexOutput;
	var source: SplatSource;
	if (!initSource(&source)) {
		output.position = discardVec;
		return output;
	}
	let modelCenter: vec3f = readCenter(&source);
	var center: SplatCenter;
	if (!initCenter(modelCenter, &center)) {
		output.position = discardVec;
		return output;
	}
	var corner: SplatCorner;
	if (!initCorner(&source, &center, &corner)) {
		output.position = discardVec;
		return output;
	}
	var clr: vec4f = readColor(&source);
	#if GSPLAT_AA
		clr.a = clr.a * corner.aaFactor;
	#endif
	#if SH_BANDS > 0
		let modelView3x3 = mat3x3f(center.modelView[0].xyz, center.modelView[1].xyz, center.modelView[2].xyz);
		let dir = normalize(modelView3x3 * center.view);
		var sh: array<vec3f, SH_COEFFS>;
		var scale: f32;
		readSHData(&source, &sh, &scale);
		clr = vec4f(clr.xyz + evalSH(&sh, dir) * scale, clr.a);
	#endif
	clipCorner(&corner, clr.w);
	output.position = center.proj + vec4f(corner.offset, 0.0, 0.0);
	output.gaussianUV = corner.uv;
	output.gaussianColor = vec4f(prepareOutputFromGamma(max(clr.xyz, vec3f(0.0))), clr.w);
	#ifndef DITHER_NONE
		output.id = f32(source.id);
	#endif
	#ifdef PREPASS_PASS
		output.vLinearDepth = -center.view.z;
	#endif
	return output;
}
`});var YY,KY=m(()=>{YY=`
	attribute aPosition: vec2f;
	varying uv0: vec2f;
	@vertex fn vertexMain(input: VertexInput) -> VertexOutput {
		var output: VertexOutput;
		output.position = vec4f(input.aPosition, 0.0, 1.0);
		output.uv0 = getImageEffectUV((input.aPosition + 1.0) * 0.5);
		return output;
	}
`});var qY,jY=m(()=>{qY=`
struct DrawIndexedIndirectArgs {
	indexCount: u32,
	instanceCount: u32,
	firstIndex: u32,
	baseVertex: i32,
	firstInstance: u32
};
struct DrawIndirectArgs {
	vertexCount: u32,
	instanceCount: u32,
	firstVertex: u32,
	firstInstance: u32,
	_pad: u32
};
`});var $Y,ZY=m(()=>{$Y=`
	#include "gammaPS"
	varying color: vec4f;
	@fragment
	fn fragmentMain(input : FragmentInput) -> FragmentOutput {
		var output: FragmentOutput;
		output.color = vec4f(gammaCorrectOutput(decodeGamma3(input.color.rgb)), input.color.a);
		return output;
	}
`});var QY,JY=m(()=>{QY=`
	attribute vertex_position: vec4f;
	attribute vertex_color: vec4f;
	uniform matrix_model: mat4x4f;
	uniform matrix_viewProjection: mat4x4f;
	varying color: vec4f;
	@vertex
	fn vertexMain(input : VertexInput) -> VertexOutput {
		var output : VertexOutput;
		output.color = input.vertex_color;
		output.position = uniform.matrix_viewProjection * uniform.matrix_model * input.vertex_position;
		return output;
	}
`});var e8,t8=m(()=>{e8=`
uniform material_iridescenceRefractionIndex: f32;
fn iridescence_iorToFresnelScalar(transmittedIor: f32, incidentIor: f32) -> f32 {
	return pow((transmittedIor - incidentIor) / (transmittedIor + incidentIor), 2.0);
}
fn iridescence_iorToFresnelVec3(transmittedIor: vec3f, incidentIor: f32) -> vec3f {
	return pow((transmittedIor - vec3f(incidentIor)) / (transmittedIor + vec3f(incidentIor)), vec3f(2.0));
}
fn iridescence_fresnelToIor(f0: vec3f) -> vec3f {
	let sqrtF0: vec3f = sqrt(f0);
	return (vec3f(1.0) + sqrtF0) / (vec3f(1.0) - sqrtF0);
}
const XYZ_TO_REC709: mat3x3f = mat3x3f(
	vec3f(3.2404542, -1.5371385, -0.4985314),
	vec3f(-0.9692660,  1.8760108,  0.0415560),
	vec3f(0.0556434, -0.2040259,  1.0572252)
);
fn iridescence_sensitivity(opd: f32, shift: vec3f) -> vec3f {
	let PI: f32 = 3.141592653589793;
	let phase: f32 = 2.0 * PI * opd * 1.0e-9;
	const val: vec3f = vec3f(5.4856e-13, 4.4201e-13, 5.2481e-13);
	const pos: vec3f = vec3f(1.6810e+06, 1.7953e+06, 2.2084e+06);
	const var_: vec3f = vec3f(4.3278e+09, 9.3046e+09, 6.6121e+09);
	var xyz: vec3f = val * sqrt(2.0 * PI * var_) * cos(pos * phase + shift) * exp(-pow(phase, 2.0) * var_);
	xyz.x = xyz.x + 9.7470e-14 * sqrt(2.0 * PI * 4.5282e+09) * cos(2.2399e+06 * phase + shift[0]) * exp(-4.5282e+09 * pow(phase, 2.0));
	xyz = xyz / vec3f(1.0685e-07);
	return XYZ_TO_REC709 * xyz;
}
fn iridescence_fresnelScalar(cosTheta: f32, f0: f32) -> f32 {
	let x: f32 = clamp(1.0 - cosTheta, 0.0, 1.0);
	let x2: f32 = x * x;
	let x5: f32 = x * x2 * x2;
	return f0 + (1.0 - f0) * x5;
}
fn iridescence_fresnelVec3(cosTheta: f32, f0: vec3f) -> vec3f {
	let x: f32 = clamp(1.0 - cosTheta, 0.0, 1.0);
	let x2: f32 = x * x;
	let x5: f32 = x * x2 * x2;
	return f0 + (vec3f(1.0) - f0) * x5;
}
fn calcIridescence(outsideIor: f32, cosTheta: f32, base_f0: vec3f, iridescenceThickness: f32) -> vec3f {
	let PI: f32 = 3.141592653589793;
	let iridescenceIor: f32 = mix(outsideIor, uniform.material_iridescenceRefractionIndex, smoothstep(0.0, 0.03, iridescenceThickness));
	let sinTheta2Sq: f32 = pow(outsideIor / iridescenceIor, 2.0) * (1.0 - pow(cosTheta, 2.0));
	let cosTheta2Sq: f32 = 1.0 - sinTheta2Sq;
	if (cosTheta2Sq < 0.0) {
		return vec3f(1.0);
	}
	let cosTheta2: f32 = sqrt(cosTheta2Sq);
	let r0: f32 = iridescence_iorToFresnelScalar(iridescenceIor, outsideIor);
	let r12: f32 = iridescence_fresnelScalar(cosTheta, r0);
	let r21: f32 = r12;
	let t121: f32 = 1.0 - r12;
	let phi12: f32 = select(0.0, PI, iridescenceIor < outsideIor);
	let phi21: f32 = PI - phi12;
	let baseIor: vec3f = iridescence_fresnelToIor(base_f0 + vec3f(0.0001));
	let r1: vec3f = iridescence_iorToFresnelVec3(baseIor, iridescenceIor);
	let r23: vec3f = iridescence_fresnelVec3(cosTheta2, r1);
	let phi23: vec3f = select(vec3f(0.0), vec3f(PI), baseIor < vec3f(iridescenceIor));
	let opd: f32 = 2.0 * iridescenceIor * iridescenceThickness * cosTheta2;
	let phi: vec3f = vec3f(phi21) + phi23;
	let r123Sq: vec3f = clamp(vec3f(r12) * r23, vec3f(1e-5), vec3f(0.9999));
	let r123: vec3f = sqrt(r123Sq);
	let rs: vec3f = pow(vec3f(t121), vec3f(2.0)) * r23 / (vec3f(1.0) - r123Sq);
	let c0: vec3f = vec3f(r12) + rs;
	var i_irid: vec3f = c0;
	var cm: vec3f = rs - vec3f(t121);
	cm = cm * r123;
	let sm1: vec3f = 2.0 * iridescence_sensitivity(1.0 * opd, 1.0 * phi);
	i_irid = i_irid + cm * sm1;
	cm = cm * r123;
	let sm2: vec3f = 2.0 * iridescence_sensitivity(2.0 * opd, 2.0 * phi);
	i_irid = i_irid + cm * sm2;
	return max(i_irid, vec3f(0.0));
}
fn getIridescenceDiffraction(cosTheta: f32, specularity: vec3f, iridescenceThickness: f32) -> vec3f {
	return calcIridescence(1.0, cosTheta, specularity, iridescenceThickness);
}
`});var s8,i8=m(()=>{s8=`
#ifdef STD_IRIDESCENCE_CONSTANT
	uniform material_iridescence: f32;
#endif
fn getIridescence() {
	var iridescence = 1.0;
	#ifdef STD_IRIDESCENCE_CONSTANT
	iridescence = iridescence * uniform.material_iridescence;
	#endif
	#ifdef STD_IRIDESCENCE_TEXTURE
	iridescence = iridescence * textureSampleBias({STD_IRIDESCENCE_TEXTURE_NAME}, {STD_IRIDESCENCE_TEXTURE_NAME}Sampler, {STD_IRIDESCENCE_TEXTURE_UV}, uniform.textureBias).{STD_IRIDESCENCE_TEXTURE_CHANNEL};
	#endif
	dIridescence = iridescence; 
}
`});var r8,a8=m(()=>{r8=`
uniform material_iridescenceThicknessMax: f32;
#ifdef STD_IRIDESCENCETHICKNESS_TEXTURE
	uniform material_iridescenceThicknessMin: f32;
#endif
fn getIridescenceThickness() {
	#ifdef STD_IRIDESCENCETHICKNESS_TEXTURE
		var blend: f32 = textureSampleBias({STD_IRIDESCENCETHICKNESS_TEXTURE_NAME}, {STD_IRIDESCENCETHICKNESS_TEXTURE_NAME}Sampler, {STD_IRIDESCENCETHICKNESS_TEXTURE_UV}, uniform.textureBias).{STD_IRIDESCENCETHICKNESS_TEXTURE_CHANNEL};
		var iridescenceThickness: f32 = mix(uniform.material_iridescenceThicknessMin, uniform.material_iridescenceThicknessMax, blend);
	#else
		var iridescenceThickness: f32 = uniform.material_iridescenceThicknessMax;
	#endif
	dIridescenceThickness = iridescenceThickness; 
}
`});var n8,o8=m(()=>{n8=`
#ifdef STD_IOR_CONSTANT
	uniform material_refractionIndex: f32;
#endif
fn getIor() {
#ifdef STD_IOR_CONSTANT
	dIor = uniform.material_refractionIndex;
#else
	dIor = 1.0 / 1.5;
#endif
}
`});var l8,h8=m(()=>{l8=`
#if defined(LIGHT{i})
	uniform light{i}_color: vec3f;
	#if LIGHT{i}TYPE == DIRECTIONAL
		uniform light{i}_direction: vec3f;
	#else
		#define LIT_CODE_LIGHTS_POINT
		uniform light{i}_position: vec3f;
		uniform light{i}_radius: f32;
		#if LIGHT{i}TYPE == SPOT
			#define LIT_CODE_LIGHTS_SPOT
			uniform light{i}_direction: vec3f;
			uniform light{i}_innerConeAngle: f32;
			uniform light{i}_outerConeAngle: f32;
		#endif
	#endif
	#if LIGHT{i}SHAPE != PUNCTUAL
		#define LIT_CODE_FALLOFF_SQUARED
		#if LIGHT{i}TYPE == DIRECTIONAL
			uniform light{i}_position: vec3f;
		#endif
		uniform light{i}_halfWidth: vec3f;
		uniform light{i}_halfHeight: vec3f;
	#else
		#if LIGHT{i}FALLOFF == LINEAR
			#define LIT_CODE_FALLOFF_LINEAR
		#endif
		#if LIGHT{i}FALLOFF == INVERSESQUARED
			#define LIT_CODE_FALLOFF_SQUARED
		#endif
	#endif
	#if defined(LIGHT{i}CASTSHADOW)
		uniform light{i}_shadowMatrix: mat4x4f;
		uniform light{i}_shadowIntensity: f32;
		uniform light{i}_shadowParams: vec4f;
		#if LIGHT{i}SHADOWTYPE == PCSS_32F
			uniform light{i}_shadowSearchArea: f32;
			uniform light{i}_cameraParams: vec4f;
			#if LIGHT{i}TYPE == DIRECTIONAL
				uniform light{i}_softShadowParams: vec4f;
			#endif
		#endif
		#if LIGHT{i}TYPE == DIRECTIONAL
			uniform light{i}_shadowMatrixPalette: array<mat4x4f, 4>;
			uniform light{i}_shadowCascadeDistances: vec4f;
			uniform light{i}_shadowCascadeCount: i32;
			uniform light{i}_shadowCascadeBlend: f32;
		#endif
		#if LIGHT{i}TYPE == OMNI
			NOT SUPPORTED
			
		#else
			#if defined(LIGHT{i}SHADOW_PCF)
				var light{i}_shadowMap: texture_depth_2d;
				var light{i}_shadowMapSampler: sampler_comparison;
			#else
				var light{i}_shadowMap: texture_2d<f32>;
				var light{i}_shadowMapSampler: sampler;
			#endif
		#endif
	#endif
	#if defined(LIGHT{i}COOKIE)
		#define LIT_CODE_COOKIE
		#if LIGHT{i}TYPE == OMNI
			NOT SUPPORTED
		#endif
		#if LIGHT{i}TYPE == SPOT
			NOT SUPPORTED
		#endif
	#endif
#endif
`});var c8,f8=m(()=>{c8=`
fn getLightDiffuse(worldNormal: vec3f, viewDir: vec3f, lightDirNorm: vec3f) -> f32 {
	return max(dot(worldNormal, -lightDirNorm), 0.0);
}
`});var d8,u8=m(()=>{d8=`
fn evalOmniLight(lightPosW: vec3f) -> vec3f {
	return vPositionW - lightPosW;
}
`});var m8,p8=m(()=>{m8=`
#if defined(LIGHT{i})
	evaluateLight{i}(
		#if defined(LIT_IRIDESCENCE)
			iridescenceFresnel
		#endif
	);
#endif
`});var _8,g8=m(()=>{_8=`
#if defined(LIGHT{i})
fn evaluateLight{i}(
	#if defined(LIT_IRIDESCENCE)
		iridescenceFresnel: vec3f
	#endif
) {
	var lightColor: vec3f = uniform.light{i}_color;
	#if LIGHT{i}TYPE == DIRECTIONAL && !defined(LIT_SHADOW_CATCHER)
		if (all(lightColor == vec3f(0.0, 0.0, 0.0))) {
			return;
		}
	#endif
	#if LIGHT{i}TYPE == DIRECTIONAL
		dLightDirNormW = uniform.light{i}_direction;
		dAtten = 1.0;
	#else
		var lightDirW: vec3f = evalOmniLight(uniform.light{i}_position);
		dLightDirNormW = normalize(lightDirW);
		#if defined(LIGHT{i}COOKIE)
			#if LIGHT{i}TYPE == SPOT
				#ifdef LIGHT{i}COOKIE_FALLOFF
					#ifdef LIGHT{i}COOKIE_TRANSFORM
						var cookieAttenuation: vec3f = getCookie2DXform(uniform.light{i}_cookie, uniform.light{i}_shadowMatrix, uniform.light{i}_cookieIntensity, uniform.light{i}_cookieMatrix, uniform.light{i}_cookieOffset).{LIGHT{i}COOKIE_CHANNEL};
					#else
						var cookieAttenuation: vec3f = getCookie2D(uniform.light{i}_cookie, uniform.light{i}_shadowMatrix, uniform.light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};
					#endif
				#else
					#ifdef LIGHT{i}COOKIE_TRANSFORM
						var cookieAttenuation: vec3f = getCookie2DClipXform(uniform.light{i}_cookie, uniform.light{i}_shadowMatrix, uniform.light{i}_cookieIntensity, uniform.light{i}_cookieMatrix, uniform.light{i}_cookieOffset).{LIGHT{i}COOKIE_CHANNEL};
					#else
						var cookieAttenuation: vec3f = getCookie2DClip(uniform.light{i}_cookie, uniform.light{i}_shadowMatrix, uniform.light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};
					#endif
				#endif
			#endif
			#if LIGHT{i}TYPE == OMNI
				var cookieAttenuation: vec3f = getCookieCube(uniform.light{i}_cookie, uniform.light{i}_shadowMatrix, uniform.light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};
			#endif
			lightColor = lightColor * cookieAttenuation;
		#endif
		#if LIGHT{i}SHAPE == PUNCTUAL
			#if LIGHT{i}FALLOFF == LINEAR
				dAtten = getFalloffLinear(uniform.light{i}_radius, lightDirW);
			#else
				dAtten = getFalloffInvSquared(uniform.light{i}_radius, lightDirW);
			#endif
		#else
			dAtten = getFalloffWindow(uniform.light{i}_radius, lightDirW);
		#endif
		#if LIGHT{i}TYPE == SPOT
			#if !defined(LIGHT{i}COOKIE) || defined(LIGHT{i}COOKIE_FALLOFF)
				dAtten = dAtten * getSpotEffect(uniform.light{i}_direction, uniform.light{i}_innerConeAngle, uniform.light{i}_outerConeAngle, dLightDirNormW);
			#endif
		#endif
	#endif
	if (dAtten < 0.00001) {
		return;
	}
	#if LIGHT{i}SHAPE != PUNCTUAL
		#if LIGHT{i}SHAPE == RECT
			calcRectLightValues(uniform.light{i}_position, uniform.light{i}_halfWidth, uniform.light{i}_halfHeight);
		#elif LIGHT{i}SHAPE == DISK
			calcDiskLightValues(uniform.light{i}_position, uniform.light{i}_halfWidth, uniform.light{i}_halfHeight);
		#elif LIGHT{i}SHAPE == SPHERE
			calcSphereLightValues(uniform.light{i}_position, uniform.light{i}_halfWidth, uniform.light{i}_halfHeight);
		#endif
	#endif
	#if LIGHT{i}SHAPE != PUNCTUAL
		#if LIGHT{i}TYPE == DIRECTIONAL
			var attenDiffuse: f32 = getLightDiffuse(litArgs_worldNormal, dViewDirW, dLightDirNormW);
		#else
			#if LIGHT{i}SHAPE == RECT
				var attenDiffuse: f32 = getRectLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;
			#elif LIGHT{i}SHAPE == DISK
				var attenDiffuse: f32 = getDiskLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;
			#elif LIGHT{i}SHAPE == SPHERE
				var attenDiffuse: f32 = getSphereLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;
			#endif
		#endif
	#else
		dAtten = dAtten * getLightDiffuse(litArgs_worldNormal, vec3(0.0), dLightDirNormW);
	#endif
	#ifdef LIGHT{i}CASTSHADOW
		#if LIGHT{i}TYPE == DIRECTIONAL
			var shadow: f32 = getShadow{i}(vec3(0.0));
		#else
			var shadow: f32 = getShadow{i}(lightDirW);
		#endif
		shadow = mix(1.0, shadow, uniform.light{i}_shadowIntensity);
		dAtten = dAtten * shadow;
		#if defined(LIT_SHADOW_CATCHER) && LIGHT{i}TYPE == DIRECTIONAL
			dShadowCatcher = dShadowCatcher * shadow;
		#endif			
	#endif
	#if LIGHT{i}SHAPE != PUNCTUAL
		#ifdef LIT_SPECULAR
			dDiffuseLight = dDiffuseLight + (((attenDiffuse * dAtten) * lightColor) * (1.0 - dLTCSpecFres));
		#else
			dDiffuseLight = dDiffuseLight + ((attenDiffuse * dAtten) * lightColor);
		#endif						
	#else
		#if defined(AREA_LIGHTS) && defined(LIT_SPECULAR)
			dDiffuseLight = dDiffuseLight + ((dAtten * lightColor) * (1.0 - litArgs_specularity));
		#else
			dDiffuseLight = dDiffuseLight + (dAtten * lightColor);
		#endif
	#endif
	#ifdef LIGHT{i}AFFECT_SPECULARITY
		#if LIGHT{i}SHAPE != PUNCTUAL
			#ifdef LIT_CLEARCOAT
				#if LIGHT{i}SHAPE == RECT
					ccSpecularLight = ccSpecularLight + (ccLTCSpecFres * getRectLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor);
				#elif LIGHT{i}SHAPE == DISK
					ccSpecularLight = ccSpecularLight + (ccLTCSpecFres * getDiskLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor);
				#elif LIGHT{i}SHAPE == SPHERE
					ccSpecularLight = ccSpecularLight + (ccLTCSpecFres * getSphereLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor);
				#endif
			#endif
			#ifdef LIT_SPECULAR
				#if LIGHT{i}SHAPE == RECT
					dSpecularLight = dSpecularLight + (dLTCSpecFres * getRectLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor);
				#elif LIGHT{i}SHAPE == DISK
					dSpecularLight = dSpecularLight + (dLTCSpecFres * getDiskLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor);
				#elif LIGHT{i}SHAPE == SPHERE
					dSpecularLight = dSpecularLight + (dLTCSpecFres * getSphereLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor);
				#endif
			#endif
		#else
			#if LIGHT{i}TYPE == DIRECTIONAL && LIT_FRESNEL_MODEL != NONE
				#define LIGHT{i}FRESNEL
			#endif
			#ifdef LIT_SPECULAR
				var halfDirW: vec3f = normalize(-dLightDirNormW + dViewDirW);
			#endif
			#ifdef LIT_CLEARCOAT
				var lightspecularCC: vec3f = getLightSpecular(halfDirW, ccReflDirW, litArgs_clearcoat_worldNormal, dViewDirW, dLightDirNormW, litArgs_clearcoat_gloss, dTBN) * dAtten * lightColor;
				#ifdef LIGHT{i}FRESNEL
					lightspecularCC = lightspecularCC * getFresnelCC(dot(dViewDirW, halfDirW));
				#endif
				ccSpecularLight = ccSpecularLight + lightspecularCC;
			#endif
			#ifdef LIT_SHEEN
				sSpecularLight = sSpecularLight + (getLightSpecularSheen(halfDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_sheen_gloss) * dAtten * lightColor);
			#endif
			#ifdef LIT_SPECULAR
				var lightSpecular: vec3f = getLightSpecular(halfDirW, dReflDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_gloss, dTBN) * dAtten * lightColor;
				#ifdef LIGHT{i}FRESNEL
					#if defined(LIT_IRIDESCENCE)
						lightSpecular = lightSpecular * getFresnel(dot(dViewDirW, halfDirW), litArgs_gloss, litArgs_specularity, iridescenceFresnel, litArgs_iridescence_intensity);
					#else
						lightSpecular = lightSpecular * getFresnel(dot(dViewDirW, halfDirW), litArgs_gloss, litArgs_specularity);
					#endif
				#else
					lightSpecular = lightSpecular * litArgs_specularity;
				#endif
				
				dSpecularLight = dSpecularLight + lightSpecular;
			#endif
		#endif
	#endif
}
#endif
`});var S8,T8=m(()=>{S8=`
#ifdef LIGHT{i}CASTSHADOW
	fn getShadowSampleCoord{i}(shadowTransform: mat4x4f, shadowParams: vec4f, worldPosition: vec3f, lightPos: vec3f, lightDir: ptr<function, vec3f>, lightDirNorm: vec3f, normal: vec3f) -> vec3f {
		var surfacePosition = worldPosition;
		#ifdef LIGHT{i}_SHADOW_SAMPLE_POINT
			#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET
				let distScale: f32 = length(*lightDir);
				surfacePosition = surfacePosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;
				*lightDir = surfacePosition - lightPos;
				return *lightDir;
			#endif
		#else
			#ifdef LIGHT{i}_SHADOW_SAMPLE_SOURCE_ZBUFFER
				#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET
					surfacePosition = surfacePosition + normal * shadowParams.y;
				#endif
			#else
				#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET
					#ifdef LIGHT{i}_SHADOW_SAMPLE_ORTHO
						var distScale: f32 = 1.0;
					#else
						var distScale: f32 = abs(dot(vPositionW - lightPos, lightDirNorm));
					#endif
					surfacePosition = surfacePosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;
				#endif
			#endif
			var positionInShadowSpace: vec4f = shadowTransform * vec4f(surfacePosition, 1.0);
			#ifdef LIGHT{i}_SHADOW_SAMPLE_ORTHO
				positionInShadowSpace.z = saturate(positionInShadowSpace.z) - 0.0001;
			#else
				#ifdef LIGHT{i}_SHADOW_SAMPLE_SOURCE_ZBUFFER
					positionInShadowSpace.xyz = positionInShadowSpace.xyz / positionInShadowSpace.w;
				#else
					positionInShadowSpace.xy = positionInShadowSpace.xy / positionInShadowSpace.w;
					positionInShadowSpace.z = length(*lightDir) * shadowParams.w;
				#endif
			#endif
			#ifdef SHADOW_SAMPLE_Z_BIAS
			#endif
			surfacePosition = positionInShadowSpace.xyz;
		#endif
		return surfacePosition;
	}
	fn getShadow{i}(lightDirW_in: vec3f) -> f32 {
		#ifdef LIGHT{i}_SHADOW_CASCADES
			var cascadeIndex: i32 = getShadowCascadeIndex(uniform.light{i}_shadowCascadeDistances, uniform.light{i}_shadowCascadeCount);
			#ifdef LIGHT{i}_SHADOW_CASCADE_BLEND
				cascadeIndex = ditherShadowCascadeIndex(cascadeIndex, uniform.light{i}_shadowCascadeDistances, uniform.light{i}_shadowCascadeCount, uniform.light{i}_shadowCascadeBlend);
			#endif
			var shadowMatrix: mat4x4f = uniform.light{i}_shadowMatrixPalette[cascadeIndex];
		#else
			var shadowMatrix: mat4x4f = uniform.light{i}_shadowMatrix;
		#endif
		var lightDirArg = lightDirW_in;
		#if LIGHT{i}TYPE == DIRECTIONAL
			var shadowCoord: vec3f = getShadowSampleCoord{i}(shadowMatrix, uniform.light{i}_shadowParams, vPositionW, vec3f(0.0), &lightDirArg, dLightDirNormW, dVertexNormalW);
		#else
			 var shadowCoord: vec3f = getShadowSampleCoord{i}(shadowMatrix, uniform.light{i}_shadowParams, vPositionW, uniform.light{i}_position, &lightDirArg, dLightDirNormW, dVertexNormalW);
		#endif
		#if LIGHT{i}TYPE == DIRECTIONAL
			shadowCoord = fadeShadow(shadowCoord, uniform.light{i}_shadowCascadeDistances);
		#endif
		#if LIGHT{i}TYPE == DIRECTIONAL
			#if LIGHT{i}SHADOWTYPE == VSM_16F
				return getShadowVSM16(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, 5.54);
			#endif
			#if LIGHT{i}SHADOWTYPE == VSM_32F
				return getShadowVSM32(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, 15.0);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCSS_32F
				#if LIGHT{i}SHAPE != PUNCTUAL
					let shadowSearchArea = vec2f(length(uniform.light{i}_halfWidth), length(uniform.light{i}_halfHeight)) * uniform.light{i}_shadowSearchArea;
					return getShadowPCSS(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, uniform.light{i}_cameraParams, shadowSearchArea, lightDirW_in);
				#else
					return getShadowPCSS(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, uniform.light{i}_cameraParams, uniform.light{i}_softShadowParams, lightDirW_in);
				#endif
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F
				return getShadowPCF1x1(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F
				return getShadowPCF3x3(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF5_16F || LIGHT{i}SHADOWTYPE == PCF5_32F
				return getShadowPCF5x5(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams);
			#endif
		#endif
		#if LIGHT{i}TYPE == SPOT
			#if LIGHT{i}SHADOWTYPE == VSM_16F
				return getShadowSpotVSM16(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, 5.54, lightDirW_in);
			#endif
			#if LIGHT{i}SHADOWTYPE == VSM_32F
				return getShadowSpotVSM32(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, 15.0, lightDirW_in);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCSS_32F
				#if LIGHT{i}SHAPE != PUNCTUAL
					var shadowSearchArea: vec2f = vec2f(length(uniform.light{i}_halfWidth), length(uniform.light{i}_halfHeight)) * uniform.light{i}_shadowSearchArea;
				#else
					var shadowSearchArea: vec2f = vec2f(uniform.light{i}_shadowSearchArea);
				#endif
				return getShadowSpotPCSS(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, uniform.light{i}_cameraParams, shadowSearchArea, lightDirW_in);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F
				return getShadowSpotPCF1x1(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F
				return getShadowSpotPCF3x3(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF5_16F || LIGHT{i}SHADOWTYPE == PCF5_32F
				return getShadowSpotPCF5x5(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams);
			#endif
		#endif
		#if LIGHT{i}TYPE == OMNI
			#if LIGHT{i}SHADOWTYPE == PCSS_32F
				 var shadowSearchArea: vec2f;
				 #if LIGHT{i}SHAPE != PUNCTUAL
					var shadowSearchArea: vec2f = vec2f(length(uniform.light{i}_halfWidth), length(uniform.light{i}_halfHeight)) * uniform.light{i}_shadowSearchArea;
				#else
					var shadowSearchArea: vec2f = vec2f(uniform.light{i}_shadowSearchArea);
				#endif
				return getShadowOmniPCSS(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, uniform.light{i}_cameraParams, shadowSearchArea, lightDirW_in);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F
				return getShadowOmniPCF1x1(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, lightDirW_in);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F
				return getShadowOmniPCF3x3(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, lightDirW_in);
			#endif
		#endif
	}
#endif
`});var E8,v8=m(()=>{E8=`
#ifdef LIT_CLUSTERED_LIGHTS
	#define LIT_CODE_FALLOFF_LINEAR
	#define LIT_CODE_FALLOFF_SQUARED
	#define LIT_CODE_LIGHTS_POINT
	#define LIT_CODE_LIGHTS_SPOT
#endif
#ifdef AREA_LIGHTS
	var areaLightsLutTex1: texture_2d<f32>;
	var areaLightsLutTex1Sampler: sampler;
	var areaLightsLutTex2: texture_2d<f32>;
	var areaLightsLutTex2Sampler: sampler;
#endif
#ifdef LIT_LIGHTING
	#include "lightDiffuseLambertPS"
	#if defined(AREA_LIGHTS) || defined(LIT_CLUSTERED_AREA_LIGHTS)
		#include "ltcPS"
	#endif
#endif
#ifdef SHADOW_DIRECTIONAL
	#include "shadowCascadesPS"
#endif
#if defined(SHADOW_KIND_PCF1)
	#include "shadowPCF1PS"
#endif
#if defined(SHADOW_KIND_PCF3)
	#include "shadowPCF3PS"
#endif
#if defined(SHADOW_KIND_PCF5)
	#include "shadowPCF5PS"
#endif
#if defined(SHADOW_KIND_PCSS)
	#include "linearizeDepthPS"
	#include "shadowSoftPS"
#endif
#if defined(SHADOW_KIND_VSM)
	#include "shadowEVSMPS"
#endif
#ifdef LIT_CODE_FALLOFF_LINEAR
	#include "falloffLinearPS"
#endif
#ifdef LIT_CODE_FALLOFF_SQUARED
	#include "falloffInvSquaredPS"
#endif
#ifdef LIT_CODE_LIGHTS_POINT
	#include "lightDirPointPS"
#endif
#ifdef LIT_CODE_LIGHTS_SPOT
	#include "spotPS"
#endif
#ifdef LIT_CODE_COOKIE
	#include "cookiePS"
#endif
#ifdef LIT_CLUSTERED_LIGHTS
	#include "clusteredLightPS"
#endif
#ifdef LIGHT_COUNT > 0
	#include "lightFunctionShadowPS, LIGHT_COUNT"
	#include "lightFunctionLightPS, LIGHT_COUNT"
#endif
`});var x8,y8=m(()=>{x8=`
fn addLightMap(
	lightmap: vec3f,
	dir: vec3f,
	worldNormal: vec3f,
	viewDir: vec3f,
	reflectionDir: vec3f,
	gloss: f32,
	specularity: vec3f,
	vertexNormal: vec3f,
	tbn: mat3x3f
#if defined(LIT_IRIDESCENCE)
	, iridescenceFresnel: vec3f,
	iridescenceIntensity: f32
#endif
) {
	#if defined(LIT_SPECULAR) && defined(LIT_DIR_LIGHTMAP)
		if (dot(dir, dir) < 0.0001) {
				dDiffuseLight = dDiffuseLight + lightmap;
		} else {
			let vlight: f32 = saturate(dot(dir, -vertexNormal));
			let flight: f32 = saturate(dot(dir, -worldNormal));
			let nlight: f32 = (flight / max(vlight, 0.01)) * 0.5;
			dDiffuseLight = dDiffuseLight + lightmap * nlight * 2.0;
			let halfDir: vec3f = normalize(-dir + viewDir);
			var specularLight: vec3f = lightmap * getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, dir, gloss, tbn);
			#ifdef LIT_SPECULAR_FRESNEL
				specularLight = specularLight *
					getFresnel(dot(viewDir, halfDir),
					gloss,
					specularity
				#if defined(LIT_IRIDESCENCE)
					, iridescenceFresnel,
					iridescenceIntensity
				#endif
					);
			#endif
			dSpecularLight = dSpecularLight + specularLight;
		}
	#else
		dDiffuseLight = dDiffuseLight + lightmap;
	#endif
}
`});var A8,P8=m(()=>{A8=`
#ifdef STD_LIGHTMAP_DIR
	var<private> dLightmapDir: vec3f;
	var texture_dirLightMap: texture_2d<f32>;
	var texture_dirLightMapSampler: sampler;
#endif
fn getLightMap() {
	dLightmap = vec3f(1.0);
	#ifdef STD_LIGHT_TEXTURE
		dLightmap = dLightmap * {STD_LIGHT_TEXTURE_DECODE}(textureSampleBias({STD_LIGHT_TEXTURE_NAME}, {STD_LIGHT_TEXTURE_NAME}Sampler, {STD_LIGHT_TEXTURE_UV}, uniform.textureBias)).{STD_LIGHT_TEXTURE_CHANNEL};
		#ifdef STD_LIGHTMAP_DIR
			var dir: vec3f = textureSampleBias(texture_dirLightMap, texture_dirLightMapSampler, {STD_LIGHT_TEXTURE_UV}, uniform.textureBias).xyz * 2.0 - 1.0;
			var dirDot = dot(dir, dir);
			dLightmapDir = select(vec3(0.0), dir / sqrt(dirDot), dirDot > 0.001);
		#endif
	#endif
	#ifdef STD_LIGHT_VERTEX
		dLightmap = dLightmap * saturate(vVertexColor.{STD_LIGHT_VERTEX_CHANNEL});
	#endif
}
`});var R8,C8=m(()=>{R8=`
fn calcLightSpecular(gloss: f32, worldNormal: vec3f, viewDir: vec3f, h: vec3f, lightDirNorm: vec3f, tbn: mat3x3f) -> f32 {
	let PI: f32 = 3.141592653589793;
	let roughness: f32 = max((1.0 - gloss) * (1.0 - gloss), 0.001);
	let alphaRoughness: f32 = roughness * roughness;
	let anisotropy: f32 = dAnisotropy;
	let direction: vec2f = dAnisotropyRotation;
	let at: f32 = mix(alphaRoughness, 1.0, anisotropy * anisotropy);
	let ab: f32 = clamp(alphaRoughness, 0.001, 1.0);
	let anisotropicT: vec3f = normalize(tbn * vec3f(direction, 0.0));
	let anisotropicB: vec3f = normalize(cross(tbn[2], anisotropicT));
	let NoH: f32 = dot(worldNormal, h);
	let ToH: f32 = dot(anisotropicT, h);
	let BoH: f32 = dot(anisotropicB, h);
	let a2: f32 = at * ab;
	let v: vec3f = vec3f(ab * ToH, at * BoH, a2 * NoH);
	let v2: f32 = dot(v, v);
	let w2: f32 = a2 / v2;
	let D: f32 = a2 * w2 * w2 * (1.0 / PI);
	let ToV: f32 = dot(anisotropicT, viewDir);
	let BoV: f32 = dot(anisotropicB, viewDir);
	let ToL: f32 = dot(anisotropicT, -lightDirNorm);
	let BoL: f32 = dot(anisotropicB, -lightDirNorm);
	let NoV: f32 = dot(worldNormal, viewDir);
	let NoL: f32 = dot(worldNormal, -lightDirNorm);
	let lambdaV: f32 = NoL * length(vec3f(at * ToV, ab * BoV, NoV));
	let lambdaL: f32 = NoV * length(vec3f(at * ToL, ab * BoL, NoL));
	let G: f32 = 0.5 / (lambdaV + lambdaL);
	return D * G;
}
fn getLightSpecular(h: vec3f, reflDir: vec3f, worldNormal: vec3f, viewDir: vec3f, lightDirNorm: vec3f, gloss: f32, tbn: mat3x3f) -> f32 {
	return calcLightSpecular(gloss, worldNormal, viewDir, h, lightDirNorm, tbn);
}
`});var I8,w8=m(()=>{I8=`
fn calcLightSpecular(gloss: f32, worldNormal: vec3f, h: vec3f) -> f32 {
	let nh: f32 = max( dot( h, worldNormal ), 0.0 );
	var specPow: f32 = exp2(gloss * 11.0);
	specPow = max(specPow, 0.0001);
	return pow(nh, specPow) * (specPow + 2.0) / 8.0;
}
fn getLightSpecular(h: vec3f, reflDir: vec3f, worldNormal: vec3f, viewDir: vec3f, lightDirNorm: vec3f, gloss: f32, tbn: mat3x3f) -> f32 {
	return calcLightSpecular(gloss, worldNormal, h);
}
`});var L8,b8=m(()=>{L8=`
fn sheenD(normal: vec3f, h: vec3f, roughness: f32) -> f32 {
	let PI: f32 = 3.141592653589793;
	let invR: f32 = 1.0 / (roughness * roughness);
	var cos2h: f32 = max(dot(normal, h), 0.0);
	cos2h = cos2h * cos2h;
	let sin2h: f32 = max(1.0 - cos2h, 0.0078125);
	return (2.0 + invR) * pow(sin2h, invR * 0.5) / (2.0 * PI);
}
fn sheenV(normal: vec3f, viewDir: vec3f, light: vec3f) -> f32 {
	let NoV: f32 = max(dot(normal, viewDir), 0.000001);
	let NoL: f32 = max(dot(normal, light), 0.000001);
	return 1.0 / (4.0 * (NoL + NoV - NoL * NoV));
}
fn getLightSpecularSheen(h: vec3f, worldNormal: vec3f, viewDir: vec3f, lightDirNorm: vec3f, sheenGloss: f32) -> f32 {
	let D: f32 = sheenD(worldNormal, h, sheenGloss);
	let V: f32 = sheenV(worldNormal, viewDir, -lightDirNorm);
	return D * V;
}`});var M8,D8=m(()=>{M8=`
#ifndef LINEARIZE_DEPTH
#define LINEARIZE_DEPTH
fn linearizeDepthWithParams(z: f32, cameraParams: vec4f) -> f32 {
	if (cameraParams.w == 0.0) {
		return (cameraParams.z * cameraParams.y) / (cameraParams.y + z * (cameraParams.z - cameraParams.y));
	} else {
		return cameraParams.z + z * (cameraParams.y - cameraParams.z);
	}
}
#ifndef CAMERAPLANES
	#define CAMERAPLANES
	uniform camera_params: vec4f;
#endif
fn linearizeDepth(z: f32) -> f32 {
	return linearizeDepthWithParams(z, uniform.camera_params);
}
#endif
`});var O8,N8=m(()=>{O8=`
fn evaluateBackend() -> FragmentOutput {
	var output: FragmentOutput;
	#ifdef LIT_SSAO
		litArgs_ao = litArgs_ao * textureSampleLevel(ssaoTexture, ssaoTextureSampler, pcPosition.xy * uniform.ssaoTextureSizeInv, 0.0).r;
	#endif
	#ifdef LIT_NEEDS_NORMAL
		#ifdef LIT_SPECULAR
			getReflDir(litArgs_worldNormal, dViewDirW, litArgs_gloss, dTBN);
		#endif
		#ifdef LIT_CLEARCOAT
			ccReflDirW = normalize(-reflect(dViewDirW, litArgs_clearcoat_worldNormal));
		#endif
	#endif
	#ifdef LIT_SPECULAR_OR_REFLECTION
		#ifdef LIT_METALNESS
			var f0: f32 = 1.0 / litArgs_ior;
			f0 = (f0 - 1.0) / (f0 + 1.0);
			f0 = f0 * f0;
			litArgs_specularity = getSpecularModulate(litArgs_specularity, litArgs_albedo, litArgs_metalness, f0);
			litArgs_albedo = getAlbedoModulate(litArgs_albedo, litArgs_metalness);
		#endif
		#ifdef LIT_IRIDESCENCE
			var iridescenceFresnel: vec3f = getIridescenceDiffraction(saturate(dot(dViewDirW, litArgs_worldNormal)), litArgs_specularity, litArgs_iridescence_thickness);
		#endif
	#endif
	#ifdef LIT_ADD_AMBIENT
		addAmbient(litArgs_worldNormal);
		#ifdef LIT_SPECULAR
			dDiffuseLight = dDiffuseLight * (1.0 - litArgs_specularity);
		#endif
		#ifdef LIT_SEPARATE_AMBIENT
			var dAmbientLight: vec3f = dDiffuseLight;
			dDiffuseLight = vec3(0.0);
		#endif
	#endif
	#ifndef LIT_OLD_AMBIENT
		dDiffuseLight = dDiffuseLight * uniform.material_ambient;
	#endif
	#ifdef LIT_AO
		#ifndef LIT_OCCLUDE_DIRECT
			occludeDiffuse(litArgs_ao);
		#endif
	#endif
	#ifdef LIT_LIGHTMAP
		addLightMap(
			litArgs_lightmap, 
			litArgs_lightmapDir, 
			litArgs_worldNormal, 
			dViewDirW, 
			dReflDirW, 
			litArgs_gloss, 
			litArgs_specularity, 
			dVertexNormalW,
			dTBN
		#if defined(LIT_IRIDESCENCE)
			, iridescenceFresnel,
			litArgs_iridescence_intensity
		#endif
		);
	#endif
	#ifdef LIT_LIGHTING || LIT_REFLECTIONS
		#ifdef LIT_REFLECTIONS
			#ifdef LIT_CLEARCOAT
				addReflectionCC(ccReflDirW, litArgs_clearcoat_gloss);
			
				#ifdef LIT_SPECULAR_FRESNEL
					ccFresnel = getFresnelCC(dot(dViewDirW, litArgs_clearcoat_worldNormal));
					ccReflection = ccReflection * ccFresnel;
				#else
					ccFresnel = 0.0;
				#endif
			#endif
			#ifdef LIT_SPECULARITY_FACTOR
				ccReflection = ccReflection * litArgs_specularityFactor;
			#endif
			#ifdef LIT_SHEEN
				addReflectionSheen(litArgs_worldNormal, dViewDirW, litArgs_sheen_gloss);
			#endif
			addReflection(dReflDirW, litArgs_gloss);
			#ifdef LIT_FRESNEL_MODEL
				dReflection = vec4f(
					dReflection.rgb * getFresnel(
						dot(dViewDirW, litArgs_worldNormal),
						litArgs_gloss,
						litArgs_specularity
					#if defined(LIT_IRIDESCENCE)
						, iridescenceFresnel,
						litArgs_iridescence_intensity
					#endif
						),
					dReflection.a
				);
			#else
				dReflection = vec4f(dReflection.rgb * litArgs_specularity, dReflection.a);
			#endif
			#ifdef LIT_SPECULARITY_FACTOR
				dReflection = vec4f(dReflection.rgb * litArgs_specularityFactor, dReflection.a);
			#endif
		#endif
		#ifdef AREA_LIGHTS
			dSpecularLight = dSpecularLight * litArgs_specularity;
			#ifdef LIT_SPECULAR
				calcLTCLightValues(litArgs_gloss, litArgs_worldNormal, dViewDirW, litArgs_specularity, litArgs_clearcoat_gloss, litArgs_clearcoat_worldNormal, litArgs_clearcoat_specularity);
			#endif
		#endif
		
		#ifdef LIGHT_COUNT > 0
			#include "lightEvaluationPS, LIGHT_COUNT"
		#endif
		#ifdef LIT_CLUSTERED_LIGHTS
			addClusteredLights(litArgs_worldNormal, dViewDirW, dReflDirW,
				#if defined(LIT_CLEARCOAT)
						ccReflDirW,
				#endif
						litArgs_gloss, litArgs_specularity, dVertexNormalW, dTBN, 
				#if defined(LIT_IRIDESCENCE)
						iridescenceFresnel,
				#endif
						litArgs_clearcoat_worldNormal, litArgs_clearcoat_gloss, litArgs_sheen_gloss, litArgs_iridescence_intensity
			);
		#endif
		#ifdef AREA_LIGHTS
			#ifdef LIT_CLEARCOAT
				litArgs_clearcoat_specularity = 1.0;
			#endif
			#ifdef LIT_SPECULAR
				litArgs_specularity = vec3(1.0);
			#endif
		#endif
		#ifdef LIT_REFRACTION
			addRefraction(
				litArgs_worldNormal, 
				dViewDirW, 
				litArgs_thickness, 
				litArgs_gloss, 
				litArgs_specularity, 
				litArgs_albedo, 
				litArgs_transmission,
				litArgs_ior,
				litArgs_dispersion
				#if defined(LIT_IRIDESCENCE)
					, iridescenceFresnel, 
					litArgs_iridescence_intensity
				#endif
			);
		#endif
	#endif
	#ifdef LIT_AO
		#ifdef LIT_OCCLUDE_DIRECT
			occludeDiffuse(litArgs_ao);
		#endif
		#if LIT_OCCLUDE_SPECULAR != NONE
			occludeSpecular(litArgs_gloss, litArgs_ao, litArgs_worldNormal, dViewDirW);
		#endif
	#endif
	#ifdef LIT_SPECULARITY_FACTOR
		dSpecularLight = dSpecularLight * litArgs_specularityFactor;
	#endif
	#if !defined(LIT_OPACITY_FADES_SPECULAR)
		#if LIT_BLEND_TYPE == NORMAL || LIT_BLEND_TYPE == PREMULTIPLIED
			var specLum: f32 = dot((dSpecularLight + dReflection.rgb * dReflection.a), vec3f( 0.2126, 0.7152, 0.0722 ));
			#ifdef LIT_CLEARCOAT
				specLum = specLum + dot(ccSpecularLight * litArgs_clearcoat_specularity + ccReflection * litArgs_clearcoat_specularity, vec3f( 0.2126, 0.7152, 0.0722 ));
			#endif
			litArgs_opacity = clamp(litArgs_opacity + gammaCorrectInput(specLum), 0.0, 1.0);
		#endif
		litArgs_opacity = litArgs_opacity * uniform.material_alphaFade;
	#endif
	#ifdef LIT_LIGHTMAP_BAKING
		#ifdef LIT_LIGHTMAP_BAKING_COLOR
			#include "bakeLmEndPS"
		#endif
		#ifdef LIT_LIGHTMAP_BAKING_DIR
			#include "bakeDirLmEndPS"
		#endif
	#else
		#include "endPS"
		#include "outputAlphaPS"
	#endif
	#ifdef LIT_MSDF
		output.color = applyMsdf(output.color);
	#endif
	#include "outputPS"
	#include "debugOutputPS"
	#ifdef LIT_SHADOW_CATCHER
		output.color = vec4f(vec3f(dShadowCatcher), output.color.a);
	#endif
	return output;
}
`});var F8,U8=m(()=>{F8=`
var<private> sReflection: vec3f;
var<private> dVertexNormalW: vec3f;
var<private> dTangentW: vec3f;
var<private> dBinormalW: vec3f;
var<private> dViewDirW: vec3f;
var<private> dReflDirW: vec3f;
var<private> ccReflDirW: vec3f;
var<private> dLightDirNormW: vec3f;
var<private> dAtten: f32;
var<private> dTBN: mat3x3f;
var<private> dReflection: vec4f;
var<private> dDiffuseLight: vec3f;
var<private> dSpecularLight: vec3f;
var<private> ccFresnel: f32;
var<private> ccReflection: vec3f;
var<private> ccSpecularLight: vec3f;
var<private> ccSpecularityNoFres: f32;
var<private> sSpecularLight: vec3f;
#ifdef LIT_DISPERSION
	uniform material_dispersion: f32;
#endif
#ifndef LIT_OPACITY_FADES_SPECULAR
	uniform material_alphaFade: f32;
#endif
#ifdef LIT_SSAO
	var ssaoTexture : texture_2d<f32>;
	var ssaoTextureSampler : sampler;
	uniform ssaoTextureSizeInv: vec2f;
#endif
#ifdef LIT_SHADOW_CATCHER
	var<private> dShadowCatcher: f32 = 1.0;
#endif
#if LIGHT_COUNT > 0
	#include "lightDeclarationPS, LIGHT_COUNT"
#endif
#ifdef LIT_SPECULAR
	#if LIT_FRESNEL_MODEL == NONE && !defined(LIT_REFLECTIONS) && !defined(LIT_DIFFUSE_MAP) 
		#define LIT_OLD_AMBIENT
	#endif
#endif
#ifdef STD_LIGHTMAP_DIR
	uniform bakeDir: f32;
#endif
#ifdef LIT_LIGHTMAP_BAKING_ADD_AMBIENT
	uniform ambientBakeOcclusionContrast: f32;
	uniform ambientBakeOcclusionBrightness: f32;
#endif
`});var B8,V8=m(()=>{B8=`
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	#include "litUserMainStartPS"
	dReflection = vec4f(0.0);
	#ifdef LIT_CLEARCOAT
		ccSpecularLight = vec3f(0.0);
		ccReflection = vec3f(0.0);
	#endif
	#if LIT_NONE_SLICE_MODE == SLICED
		#include "startNineSlicedPS"
	#elif LIT_NONE_SLICE_MODE == TILED
		#include "startNineSlicedTiledPS"
	#endif
	#ifdef LIT_NEEDS_NORMAL
		dVertexNormalW = normalize(vNormalW);
		#ifdef LIT_TANGENTS
			#if defined(LIT_HEIGHTS) || defined(LIT_USE_NORMALS) || defined(LIT_USE_CLEARCOAT_NORMALS) || defined(LIT_GGX_SPECULAR)
				dTangentW = vTangentW;
				dBinormalW = vBinormalW;
			#endif
		#endif
		getViewDir();
		#ifdef LIT_TBN
			getTBN(dTangentW, dBinormalW, dVertexNormalW);
			#ifdef LIT_TWO_SIDED_LIGHTING
				handleTwoSidedLighting();
			#endif
		#endif
	#endif
	evaluateFrontend();
	#include "debugProcessFrontendPS"
	var output: FragmentOutput = evaluateBackend();
	#include "litUserMainEndPS"
	return output;
}
`});var k8,G8=m(()=>{k8=`
#ifdef LIT_NEEDS_NORMAL
	#include "cubeMapRotatePS"
	#include "cubeMapProjectPS"
	#include "envProcPS"
#endif
#ifdef LIT_SPECULAR_OR_REFLECTION
	#ifdef LIT_METALNESS
		#include "metalnessModulatePS"
	#endif
	#if LIT_FRESNEL_MODEL == SCHLICK
		#include "fresnelSchlickPS"
	#endif
	#ifdef LIT_IRIDESCENCE
		#include "iridescenceDiffractionPS"
	#endif
#endif
#ifdef LIT_AO
	#include "aoDiffuseOccPS"
	#include "aoSpecOccPS"
#endif
#if LIT_REFLECTION_SOURCE == ENVATLASHQ
	#include "envAtlasPS"
	#include "reflectionEnvHQPS"
#elif LIT_REFLECTION_SOURCE == ENVATLAS
	#include "envAtlasPS"
	#include "reflectionEnvPS"
#elif LIT_REFLECTION_SOURCE == CUBEMAP
	#include "reflectionCubePS"
#elif LIT_REFLECTION_SOURCE == SPHEREMAP
	#include "reflectionSpherePS"
#endif
#ifdef LIT_REFLECTIONS
	#ifdef LIT_CLEARCOAT
		#include "reflectionCCPS"
	#endif
	#ifdef LIT_SHEEN
		#include "reflectionSheenPS"
	#endif
#endif
#ifdef LIT_REFRACTION
	#if defined(LIT_DYNAMIC_REFRACTION)
		#include "refractionDynamicPS"
	#elif defined(LIT_REFLECTIONS)
		#include "refractionCubePS"
	#endif
#endif
#ifdef LIT_SHEEN
	#include "lightSheenPS"
#endif
uniform material_ambient: vec3f;
#ifdef LIT_SPECULAR
	#ifdef LIT_LIGHTING
		#ifdef LIT_GGX_SPECULAR
			#include "lightSpecularAnisoGGXPS"
		#else
			#include "lightSpecularBlinnPS"
		#endif
	#endif
#endif
#include "combinePS"
#ifdef LIT_LIGHTMAP
	#include "lightmapAddPS"
#endif
#ifdef LIT_ADD_AMBIENT
	#include "ambientPS"
#endif
#ifdef LIT_MSDF
	#include "msdfPS"
#endif
#ifdef LIT_NEEDS_NORMAL
	#include "viewDirPS"
	#ifdef LIT_SPECULAR
		#ifdef LIT_GGX_SPECULAR
			#include "reflDirAnisoPS"
		#else
			#include "reflDirPS"
		#endif
	#endif
#endif
#include "lightingPS"
`});var z8,H8=m(()=>{z8=`
#include "basePS"
#include "sphericalPS"
#include "decodePS"
#include "gammaPS"
#include "tonemappingPS"
#include "fogPS"
#if LIT_NONE_SLICE_MODE == SLICED
	#include "baseNineSlicedPS"
#elif LIT_NONE_SLICE_MODE == TILED
	#include "baseNineSlicedTiledPS"
#endif
#ifdef LIT_TBN
	#include "TBNPS"
	#ifdef LIT_TWO_SIDED_LIGHTING
		#include "twoSidedLightingPS"
	#endif
#endif
`});var X8,W8=m(()=>{X8=`
#include "varyingsPS"
#include "litUserDeclarationPS"
#include "frontendDeclPS"
#if defined(PICK_PASS) || defined(PREPASS_PASS)
	#include "frontendCodePS"
	#include "litUserCodePS"
	#include "litOtherMainPS"
#elif defined(SHADOW_PASS)
	#include "frontendCodePS"
	#include "litUserCodePS"
	#include "litShadowMainPS"
#else
	#include "litForwardDeclarationPS"
	#include "litForwardPreCodePS"
	#include "frontendCodePS"
	#include "litForwardPostCodePS"
	#include "litForwardBackendPS"
	#include "litUserCodePS"
	#include "litForwardMainPS"
#endif
`});var Y8,K8=m(()=>{Y8=`
#include "varyingsVS"
#include  "litUserDeclarationVS"
#ifdef VERTEX_COLOR
	attribute vertex_color: vec4f;
#endif
#ifdef NINESLICED
	varying vMask: vec2f;
	varying vTiledUv: vec2f;
	var<private> dMaskGlobal: vec2f;
	var<private> dTiledUvGlobal: vec2f;
	uniform innerOffset: vec4f;
	uniform outerScale: vec2f;
	uniform atlasRect: vec4f;
#endif
var<private> dPositionW: vec3f;
var<private> dModelMatrix: mat4x4f;
#include "transformCoreVS"
#ifdef UV0
	attribute vertex_texCoord0: vec2f;
	#include "uv0VS"
#endif
#ifdef UV1
	attribute vertex_texCoord1: vec2f;
	#include "uv1VS"
#endif
#ifdef LINEAR_DEPTH
	#ifndef VIEWMATRIX
	#define VIEWMATRIX
		uniform matrix_view: mat4x4f;
	#endif
#endif
#include "transformVS"
#ifdef NORMALS
	#include "normalCoreVS"
	#include "normalVS"
#endif
#ifdef TANGENTS
	attribute vertex_tangent: vec4f;
#endif
#include "uvTransformUniformsPS, UV_TRANSFORMS_COUNT"
#ifdef MSDF
	#include "msdfVS"
#endif
#include  "litUserCodeVS"
@vertex
fn vertexMain(input : VertexInput) -> VertexOutput {
	#include "litUserMainStartVS"
	var output : VertexOutput;
	output.position = getPosition();
	output.vPositionW = getWorldPosition();
	#ifdef NORMALS
		output.vNormalW = getNormal();
	#endif
	#ifdef TANGENTS
		output.vTangentW = normalize(dNormalMatrix * vertex_tangent.xyz);
		output.vBinormalW = cross(output.vNormalW, output.vTangentW) * vertex_tangent.w;
	#elif defined(GGX_SPECULAR)
		output.vObjectSpaceUpW = normalize(dNormalMatrix * vec3f(0.0, 1.0, 0.0));
	#endif
	#ifdef UV0
		var uv0: vec2f = getUv0();
		#ifdef UV0_UNMODIFIED
			output.vUv0 = uv0;
		#endif
	#endif
	#ifdef UV1
		var uv1: vec2f = getUv1();
		#ifdef UV1_UNMODIFIED
			output.vUv1 = uv1;
		#endif
	#endif
	#include "uvTransformVS, UV_TRANSFORMS_COUNT"
	#ifdef VERTEX_COLOR
		output.vVertexColor = vertex_color;
	#endif
	#ifdef LINEAR_DEPTH
		output.vLinearDepth = -(uniform.matrix_view * vec4f(output.vPositionW, 1.0)).z;
	#endif
	#ifdef MSDF
		unpackMsdfParams();
		output.outline_color = dOutlineColor;
		output.outline_thickness = dOutlineThickness;
		output.shadow_color = dShadowColor;
		output.shadow_offset = dShadowOffset;
	#endif
	#ifdef NINESLICED
		output.vMask = dMaskGlobal;
		output.vTiledUv = dTiledUvGlobal;
	#endif
	#include "litUserMainEndVS"
	return output;
}
`});var q8,j8=m(()=>{q8=`
#ifdef PICK_PASS
	#include "pickPS"
#endif
#ifdef PREPASS_PASS
	#include "floatAsUintPS"
#endif
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	#include "litUserMainStartPS"
	var output: FragmentOutput;
	
	evaluateFrontend();
	#ifdef PICK_PASS
		output.color = getPickOutput();
	#endif
	#ifdef PREPASS_PASS
		output.color = float2vec4(vLinearDepth);
	#endif
	#include "litUserMainEndPS"
	return output;
}
`});var $8,Z8=m(()=>{$8=`
var<private> litArgs_albedo: vec3f;
var<private> litArgs_opacity: f32;
var<private> litArgs_emission: vec3f;
var<private> litArgs_worldNormal: vec3f;
var<private> litArgs_ao: f32;
var<private> litArgs_lightmap: vec3f;
var<private> litArgs_lightmapDir: vec3f;
var<private> litArgs_metalness: f32;
var<private> litArgs_specularity: vec3f;
var<private> litArgs_specularityFactor: f32;
var<private> litArgs_gloss: f32;
var<private> litArgs_sheen_gloss: f32;
var<private> litArgs_sheen_specularity: vec3f;
var<private> litArgs_transmission: f32;
var<private> litArgs_thickness: f32;
var<private> litArgs_ior: f32;
var<private> litArgs_dispersion: f32;
var<private> litArgs_iridescence_intensity: f32;
var<private> litArgs_iridescence_thickness: f32;
var<private> litArgs_clearcoat_worldNormal: vec3f;
var<private> litArgs_clearcoat_specularity: f32;
var<private> litArgs_clearcoat_gloss: f32;
`});var Q8,J8=m(()=>{Q8=`
	#if LIT_NONE_SLICE_MODE == TILED
		var<private> textureBias: f32 = -1000.0;
	#else
		uniform textureBias: f32;
	#endif
	#include "litShaderArgsPS"
`});var e6,t6=m(()=>{e6=`
#if LIGHT_TYPE != DIRECTIONAL
	uniform view_position: vec3f;
	uniform light_radius: f32;
#endif
#if SHADOW_TYPE == PCSS_32F
	#include "linearizeDepthPS"
#endif
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	#include "litUserMainStartPS"
	var output: FragmentOutput;
	evaluateFrontend();
	#ifdef PERSPECTIVE_DEPTH
		var depth: f32 = input.position.z;
		#if SHADOW_TYPE == PCSS_32F
			#if LIGHT_TYPE != DIRECTIONAL
				depth = linearizeDepthWithParams(depth, camera_params);
			#endif
		#endif
	#else
		var depth: f32 = min(distance(uniform.view_position, input.vPositionW) / uniform.light_radius, 0.99999);
		#define MODIFIED_DEPTH
	#endif
	#if SHADOW_TYPE == VSM_16F || SHADOW_TYPE == VSM_32F
		#if SHADOW_TYPE == VSM_32F
			var exponent: f32 = 15.0;
		#else
			var exponent: f32 = 5.54;
		#endif
		var depth_vsm = 2.0 * depth - 1.0;
		depth_vsm = exp(exponent * depth_vsm);
		output.color = vec4f(depth_vsm, depth_vsm * depth_vsm, 1.0, 1.0);
	#else
		#if SHADOW_TYPE == PCSS_32F
			output.color = vec4f(depth, 0.0, 0.0, 1.0);
		#else
			#ifdef MODIFIED_DEPTH
				output.fragDepth = depth;
			#endif
			output.color = vec4f(1.0);
		#endif
	#endif
	#include "litUserMainEndPS"
	
	return output;
}
`});var s6,i6=m(()=>{s6=`
fn LTC_Uv(N: vec3f, V: vec3f, roughness: f32) -> vec2f {
	const LUT_SIZE: f32 = 64.0;
	const LUT_SCALE: f32 = (LUT_SIZE - 1.0) / LUT_SIZE;
	const LUT_BIAS: f32 = 0.5 / LUT_SIZE;
	let dotNV: f32 = saturate(dot( N, V ));
	let uv: vec2f = vec2f( roughness, sqrt( 1.0 - dotNV ) );
	return uv * LUT_SCALE + LUT_BIAS;
}
fn LTC_ClippedSphereFormFactor( f: vec3f ) -> f32 {
	let l: f32 = length( f );
	return max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );
}
fn LTC_EdgeVectorFormFactor( v1: vec3f, v2: vec3f ) -> vec3f {
	let x: f32 = dot( v1, v2 );
	let y: f32 = abs( x );
	let a: f32 = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;
	let b: f32 = 3.4175940 + ( 4.1616724 + y ) * y;
	let v: f32 = a / b;
	let inv_sqrt_term = inverseSqrt( max( 1.0 - x * x, 1e-7f ) );
	let theta_sintheta: f32 = select( (0.5 * inv_sqrt_term - v), v, x > 0.0 );
	return cross( v1, v2 ) * theta_sintheta;
}
struct Coords {
	coord0: vec3f,
	coord1: vec3f,
	coord2: vec3f,
	coord3: vec3f,
}
fn LTC_EvaluateRect( N: vec3f, V: vec3f, P: vec3f, mInv: mat3x3f, rectCoords: Coords) -> f32 {
	let v1: vec3f = rectCoords.coord1 - rectCoords.coord0;
	let v2: vec3f = rectCoords.coord3 - rectCoords.coord0;
	let lightNormal: vec3f = cross( v1, v2 );
	let factor: f32 = sign(-dot( lightNormal, P - rectCoords.coord0 ));
	let T1: vec3f = normalize( V - N * dot( V, N ) );
	let T2: vec3f = factor * cross( N, T1 );
	let mat: mat3x3f = mInv * transpose( mat3x3f( T1, T2, N ) );
	var coords: array<vec3f, 4>;
	coords[0] = mat * ( rectCoords.coord0 - P );
	coords[1] = mat * ( rectCoords.coord1 - P );
	coords[2] = mat * ( rectCoords.coord2 - P );
	coords[3] = mat * ( rectCoords.coord3 - P );
	coords[0] = normalize( coords[0] );
	coords[1] = normalize( coords[1] );
	coords[2] = normalize( coords[2] );
	coords[3] = normalize( coords[3] );
	var vectorFormFactor: vec3f = vec3f( 0.0 );
	vectorFormFactor = vectorFormFactor + LTC_EdgeVectorFormFactor( coords[0], coords[1] );
	vectorFormFactor = vectorFormFactor + LTC_EdgeVectorFormFactor( coords[1], coords[2] );
	vectorFormFactor = vectorFormFactor + LTC_EdgeVectorFormFactor( coords[2], coords[3] );
	vectorFormFactor = vectorFormFactor + LTC_EdgeVectorFormFactor( coords[3], coords[0] );
	let result: f32 = LTC_ClippedSphereFormFactor( vectorFormFactor );
	return result;
}
var<private> dLTCCoords: Coords;
fn getLTCLightCoords(lightPos: vec3f, halfWidth: vec3f, halfHeight: vec3f) -> Coords {
	var coords: Coords;
	coords.coord0 = lightPos + halfWidth - halfHeight;
	coords.coord1 = lightPos - halfWidth - halfHeight;
	coords.coord2 = lightPos - halfWidth + halfHeight;
	coords.coord3 = lightPos + halfWidth + halfHeight;
	return coords;
}
var<private> dSphereRadius: f32;
fn getSphereLightCoords(lightPos: vec3f, halfWidth: vec3f, halfHeight: vec3f) -> Coords {
	dSphereRadius = max(length(halfWidth), length(halfHeight));
	let f: vec3f = reflect(normalize(lightPos - uniform.view_position), vNormalW);
	let w: vec3f = normalize(cross(f, halfHeight));
	let h: vec3f = normalize(cross(f, w));
	return getLTCLightCoords(lightPos, w * dSphereRadius, h * dSphereRadius);
}
var<private> dLTCUV: vec2f;
#ifdef LIT_CLEARCOAT
	var<private> ccLTCUV: vec2f;
#endif
fn getLTCLightUV(gloss: f32, worldNormal: vec3f, viewDir: vec3f) -> vec2f {
	let roughness: f32 = max((1.0 - gloss) * (1.0 - gloss), 0.001);
	return LTC_Uv( worldNormal, viewDir, roughness );
}
var<private> dLTCSpecFres: vec3f;
#ifdef LIT_CLEARCOAT
	var<private> ccLTCSpecFres: vec3f;
#endif
fn getLTCLightSpecFres(uv: vec2f, specularity: vec3f) -> vec3f {
	let t2: vec4f = textureSampleLevel(areaLightsLutTex2, areaLightsLutTex2Sampler, uv, 0.0);
	return specularity * t2.x + ( vec3f( 1.0 ) - specularity) * t2.y;
}
fn calcLTCLightValues(gloss: f32, worldNormal: vec3f, viewDir: vec3f, specularity: vec3f, clearcoatGloss: f32, clearcoatWorldNormal: vec3f, clearcoatSpecularity: f32) {
	dLTCUV = getLTCLightUV(gloss, worldNormal, viewDir);
	dLTCSpecFres = getLTCLightSpecFres(dLTCUV, specularity);
	#ifdef LIT_CLEARCOAT
		ccLTCUV = getLTCLightUV(clearcoatGloss, clearcoatWorldNormal, viewDir);
		ccLTCSpecFres = getLTCLightSpecFres(ccLTCUV, vec3f(clearcoatSpecularity));
	#endif
}
fn calcRectLightValues(lightPos: vec3f, halfWidth: vec3f, halfHeight: vec3f) {
	dLTCCoords = getLTCLightCoords(lightPos, halfWidth, halfHeight);
}
fn calcDiskLightValues(lightPos: vec3f, halfWidth: vec3f, halfHeight: vec3f) {
	calcRectLightValues(lightPos, halfWidth, halfHeight);
}
fn calcSphereLightValues(lightPos: vec3f, halfWidth: vec3f, halfHeight: vec3f) {
	dLTCCoords = getSphereLightCoords(lightPos, halfWidth, halfHeight);
}
fn SolveCubic(Coefficient_in: vec4f) -> vec3f {
	let pi: f32 = 3.14159;
	var Coefficient = Coefficient_in;
	Coefficient = vec4f(Coefficient.xyz / Coefficient.w, Coefficient.w);
	let new_yz: vec2f = Coefficient.yz / 3.0;
	Coefficient = vec4f(Coefficient.x, new_yz.x, new_yz.y, Coefficient.w);
	
	let A: f32 = Coefficient.w;
	let B: f32 = Coefficient.z;
	let C: f32 = Coefficient.y;
	let D: f32 = Coefficient.x;
	let Delta: vec3f = vec3f(
		-Coefficient.z * Coefficient.z + Coefficient.y,
		-Coefficient.y * Coefficient.z + Coefficient.x,
		dot(vec2f(Coefficient.z, -Coefficient.y), Coefficient.xy)
	);
	let Discriminant: f32 = dot(vec2f(4.0 * Delta.x, -Delta.y), Delta.zy);
	var xlc: vec2f;
	var xsc: vec2f;
	{
		let A_a: f32 = 1.0;
		let C_a: f32 = Delta.x;
		let D_a: f32 = -2.0 * B * Delta.x + Delta.y;
		let Theta: f32 = atan2(sqrt(Discriminant), -D_a) / 3.0;
		let sqrt_neg_Ca = sqrt(-C_a);
		let x_1a: f32 = 2.0 * sqrt_neg_Ca * cos(Theta);
		let x_3a: f32 = 2.0 * sqrt_neg_Ca * cos(Theta + (2.0 / 3.0) * pi);
		let xl: f32 = select(x_3a, x_1a, (x_1a + x_3a) > 2.0 * B);
		xlc = vec2f(xl - B, A);
	}
	{
		let A_d: f32 = D;
		let C_d: f32 = Delta.z;
		let D_d: f32 = -D * Delta.y + 2.0 * C * Delta.z;
		let Theta: f32 = atan2(D * sqrt(Discriminant), -D_d) / 3.0;
		let sqrt_neg_Cd = sqrt(-C_d);
		let x_1d: f32 = 2.0 * sqrt_neg_Cd * cos(Theta);
		let x_3d: f32 = 2.0 * sqrt_neg_Cd * cos(Theta + (2.0 / 3.0) * pi);
		let xs: f32 = select(x_3d, x_1d, x_1d + x_3d < 2.0 * C);
		xsc = vec2f(-D, xs + C);
	}
	let E: f32 =  xlc.y * xsc.y;
	let F: f32 = -xlc.x * xsc.y - xlc.y * xsc.x;
	let G: f32 =  xlc.x * xsc.x;
	let xmc: vec2f = vec2f(C * F - B * G, -B * F + C * E);
	var Root: vec3f = vec3f(xsc.x / xsc.y, xmc.x / xmc.y, xlc.x / xlc.y);
	if (Root.x < Root.y && Root.x < Root.z) {
		Root = Root.yxz;
	} else if (Root.z < Root.x && Root.z < Root.y) {
		Root = Root.xzy;
	}
	return Root;
}
fn LTC_EvaluateDisk(N: vec3f, V: vec3f, P: vec3f, Minv: mat3x3f, points: Coords) -> f32 {
	let T1: vec3f = normalize(V - N * dot(V, N));
	let T2: vec3f = cross(N, T1);
	let R: mat3x3f = transpose( mat3x3f( T1, T2, N ) );
	var L_: array<vec3f, 3>;
	L_[0] = R * ( points.coord0 - P );
	L_[1] = R * ( points.coord1 - P );
	L_[2] = R * ( points.coord2 - P );
	let C: vec3f  = 0.5 * (L_[0] + L_[2]);
	var V1: vec3f = 0.5 * (L_[1] - L_[2]);
	var V2: vec3f = 0.5 * (L_[1] - L_[0]);
	let C_Minv: vec3f  = Minv * C;
	let V1_Minv: vec3f = Minv * V1;
	let V2_Minv: vec3f = Minv * V2;
	var a: f32;
	var b: f32;
	let d11: f32 = dot(V1_Minv, V1_Minv);
	let d22: f32 = dot(V2_Minv, V2_Minv);
	let d12: f32 = dot(V1_Minv, V2_Minv);
	if (abs(d12) / sqrt(d11 * d22) > 0.0001) {
		let tr: f32 = d11 + d22;
		let det_inner: f32 = -d12 * d12 + d11 * d22;
		let det: f32 = sqrt(det_inner);
		let u: f32 = 0.5 * sqrt(tr - 2.0 * det);
		let v: f32 = 0.5 * sqrt(tr + 2.0 * det);
		let e_max: f32 = (u + v) * (u + v);
		let e_min: f32 = (u - v) * (u - v);
		var V1_: vec3f;
		var V2_: vec3f;
		if (d11 > d22) {
			V1_ = d12 * V1_Minv + (e_max - d11) * V2_Minv;
			V2_ = d12 * V1_Minv + (e_min - d11) * V2_Minv;
		} else {
			V1_ = d12*V2_Minv + (e_max - d22)*V1_Minv;
			V2_ = d12*V2_Minv + (e_min - d22)*V1_Minv;
		}
		a = 1.0 / e_max;
		b = 1.0 / e_min;
		V1 = normalize(V1_);
		V2 = normalize(V2_);
	} else {
		a = 1.0 / dot(V1_Minv, V1_Minv);
		b = 1.0 / dot(V2_Minv, V2_Minv);
		V1 = V1_Minv * sqrt(a);
		V2 = V2_Minv * sqrt(b);
	}
	var V3: vec3f = normalize(cross(V1, V2));
	if (dot(C_Minv, V3) < 0.0) {
		V3 = V3 * -1.0;
	}
	let L: f32  = dot(V3, C_Minv);
	let x0: f32 = dot(V1, C_Minv) / L;
	let y0: f32 = dot(V2, C_Minv) / L;
	let E1: f32 = inverseSqrt(a);
	let E2: f32 = inverseSqrt(b);
	let a_scaled = a * L * L;
	let b_scaled = b * L * L;
	let c0: f32 = a_scaled * b_scaled;
	let c1: f32 = a_scaled * b_scaled * (1.0 + x0 * x0 + y0 * y0) - a_scaled - b_scaled;
	let c2: f32 = 1.0 - a_scaled * (1.0 + x0 * x0) - b_scaled * (1.0 + y0 * y0);
	let c3: f32 = 1.0;
	let roots: vec3f = SolveCubic(vec4f(c0, c1, c2, c3));
	let e1: f32 = roots.x;
	let e2: f32 = roots.y;
	let e3: f32 = roots.z;
	var avgDir: vec3f = vec3f(a_scaled * x0 / (a_scaled - e2), b_scaled * y0 / (b_scaled - e2), 1.0);
	let rotate: mat3x3f = mat3x3f(V1, V2, V3);
	avgDir = rotate * avgDir;
	avgDir = normalize(avgDir);
	let L1: f32 = sqrt(-e2 / e3);
	let L2: f32 = sqrt(-e2 / e1);
	let formFactor: f32 = max(0.0, L1 * L2 * inverseSqrt((1.0 + L1 * L1) * (1.0 + L2 * L2)));
	const LUT_SIZE_disk: f32 = 64.0;
	const LUT_SCALE_disk: f32 = ( LUT_SIZE_disk - 1.0 ) / LUT_SIZE_disk;
	const LUT_BIAS_disk: f32 = 0.5 / LUT_SIZE_disk;
	var uv: vec2f = vec2f(avgDir.z * 0.5 + 0.5, formFactor);
	uv = uv * LUT_SCALE_disk + LUT_BIAS_disk;
	let scale: f32 = textureSampleLevel(areaLightsLutTex2, areaLightsLutTex2Sampler, uv, 0.0).w;
	return formFactor * scale;
}
fn FixNan(value: f32) -> f32 {
	return select(value, 0.0, value != value);
}
fn getRectLightDiffuse(worldNormal: vec3f, viewDir: vec3f, lightDir: vec3f, lightDirNorm: vec3f) -> f32 {
	let identityMat = mat3x3f(vec3f(1.0, 0.0, 0.0), vec3f(0.0, 1.0, 0.0), vec3f(0.0, 0.0, 1.0));
	return LTC_EvaluateRect( worldNormal, viewDir, vPositionW, identityMat, dLTCCoords );
}
fn getDiskLightDiffuse(worldNormal: vec3f, viewDir: vec3f, lightDir: vec3f, lightDirNorm: vec3f) -> f32 {
	let identityMat = mat3x3f(vec3f(1.0, 0.0, 0.0), vec3f(0.0, 1.0, 0.0), vec3f(0.0, 0.0, 1.0));
	return FixNan(LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, identityMat, dLTCCoords ));
}
fn getSphereLightDiffuse(worldNormal: vec3f, viewDir: vec3f, lightDir: vec3f, lightDirNorm: vec3f) -> f32 {
	let falloff: f32 = dSphereRadius / (dot(lightDir, lightDir) + dSphereRadius);
	return FixNan(getLightDiffuse(worldNormal, viewDir, lightDirNorm) * falloff);
}
fn getLTCLightInvMat(uv: vec2f) -> mat3x3f {
	let t1: vec4f = textureSampleLevel(areaLightsLutTex1, areaLightsLutTex1Sampler, uv, 0.0);
	return mat3x3f(
		vec3f( t1.x, 0.0, t1.y ),
		vec3f( 0.0, 1.0, 0.0 ),
		vec3f( t1.z, 0.0, t1.w )
	);
}
fn calcRectLightSpecular(worldNormal: vec3f, viewDir: vec3f, uv: vec2f) -> f32 {
	let mInv: mat3x3f = getLTCLightInvMat(uv);
	return LTC_EvaluateRect( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );
}
fn getRectLightSpecular(worldNormal: vec3f, viewDir: vec3f) -> f32 {
	return calcRectLightSpecular(worldNormal, viewDir, dLTCUV);
}
fn calcDiskLightSpecular(worldNormal: vec3f, viewDir: vec3f, uv: vec2f) -> f32 {
	let mInv: mat3x3f = getLTCLightInvMat(uv);
	return LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );
}
fn getDiskLightSpecular(worldNormal: vec3f, viewDir: vec3f) -> f32 {
	return calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);
}
fn getSphereLightSpecular(worldNormal: vec3f, viewDir: vec3f) -> f32 {
	return calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);
}
`});var r6,a6=m(()=>{r6=`
#ifdef STD_METALNESS_CONSTANT
uniform material_metalness: f32;
#endif
fn getMetalness() {
	var metalness: f32 = 1.0;
	#ifdef STD_METALNESS_CONSTANT
		metalness = metalness * uniform.material_metalness;
	#endif
	#ifdef STD_METALNESS_TEXTURE
		metalness = metalness * textureSampleBias({STD_METALNESS_TEXTURE_NAME}, {STD_METALNESS_TEXTURE_NAME}Sampler, {STD_METALNESS_TEXTURE_UV}, uniform.textureBias).{STD_METALNESS_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_METALNESS_VERTEX
	metalness = metalness * saturate(vVertexColor.{STD_METALNESS_VERTEX_CHANNEL});
	#endif
	dMetalness = metalness;
}
`});var n6,o6=m(()=>{n6=`
var texture_msdfMap: texture_2d<f32>;
var texture_msdfMapSampler: sampler;
fn median(r: f32, g: f32, b: f32) -> f32 {
	return max(min(r, g), min(max(r, g), b));
}
fn map(min: f32, max: f32, v: f32) -> f32 {
	return (v - min) / (max - min);
}
uniform font_sdfIntensity: f32;
uniform font_pxrange: f32;
uniform font_textureWidth: f32;
#ifndef LIT_MSDF_TEXT_ATTRIBUTE
	uniform outline_color: vec4f;
	uniform outline_thickness: f32;
	uniform shadow_color: vec4f;
	uniform shadow_offset: vec2f;
#else
	varying outline_color: vec4f;
	varying outline_thickness: f32;
	varying shadow_color: vec4f;
	varying shadow_offset: vec2f;
#endif
fn applyMsdf(color_in: vec4f) -> vec4f {
	#ifndef LIT_MSDF_TEXT_ATTRIBUTE
		var outline_colorValue = uniform.outline_color;
		var outline_thicknessValue = uniform.outline_thickness;
		var shadow_colorValue = uniform.shadow_color;
		var shadow_offsetValue = uniform.shadow_offset;
	#else
		var outline_colorValue = outline_color;
		var outline_thicknessValue = outline_thickness;
		var shadow_colorValue = shadow_color;
		var shadow_offsetValue = shadow_offset;
	#endif
	var color = vec4f(gammaCorrectInputVec3(color_in.rgb), color_in.a);
	let tsample: vec3f = textureSample(texture_msdfMap, texture_msdfMapSampler, vUv0).rgb;
	let uvShdw: vec2f = vUv0 - shadow_offsetValue;
	let ssample: vec3f = textureSample(texture_msdfMap, texture_msdfMapSampler, uvShdw).rgb;
	let sigDist: f32 = median(tsample.r, tsample.g, tsample.b);
	var sigDistShdw: f32 = median(ssample.r, ssample.g, ssample.b);
	let smoothingMax: f32 = 0.2;
	let w: vec2f = abs(dpdx(vUv0)) + abs(dpdy(vUv0));
	let smoothing: f32 = clamp(w.x * uniform.font_textureWidth / uniform.font_pxrange, 0.0, smoothingMax);
	let mapMin: f32 = 0.05;
	let mapMax: f32 = clamp(1.0 - uniform.font_sdfIntensity, mapMin, 1.0);
	let sigDistInner: f32 = map(mapMin, mapMax, sigDist);
	let sigDistOutline: f32 = map(mapMin, mapMax, sigDist + outline_thicknessValue);
	sigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thicknessValue);
	let center: f32 = 0.5;
	let inside: f32 = smoothstep(center - smoothing, center + smoothing, sigDistInner);
	let outline: f32 = smoothstep(center - smoothing, center + smoothing, sigDistOutline);
	let shadow: f32 = smoothstep(center - smoothing, center + smoothing, sigDistShdw);
	let tcolor_outline: vec4f = outline * vec4f(outline_colorValue.a * outline_colorValue.rgb, outline_colorValue.a);
	var tcolor: vec4f = select(vec4f(0.0), tcolor_outline, outline > inside);
	tcolor = mix(tcolor, color, inside);
	let scolor_shadow: vec4f = shadow * vec4f(shadow_colorValue.a * shadow_colorValue.rgb, shadow_colorValue.a);
	let scolor: vec4f = select(tcolor, scolor_shadow, shadow > outline);
	tcolor = mix(scolor, tcolor, outline);
	tcolor = vec4f(gammaCorrectOutput(tcolor.rgb), tcolor.a);
	return tcolor;
}
`});var l6,h6=m(()=>{l6=`
fn getSpecularModulate(specularity: vec3f, albedo: vec3f, metalness: f32, f0: f32) -> vec3f {
	let dielectricF0: vec3f = f0 * specularity;
	return mix(dielectricF0, albedo, metalness);
}
fn getAlbedoModulate(albedo: vec3f, metalness: f32) -> vec3f {
	return albedo * (1.0 - metalness);
}
`});var c6,f6=m(()=>{c6=`
	varying uv0: vec2f;
	var morphTexture: texture_2d_array<f32>;
	uniform morphFactor: array<f32, {MORPH_TEXTURE_MAX_COUNT}>;
	uniform morphIndex: array<u32, {MORPH_TEXTURE_MAX_COUNT}>;
	uniform count: u32;
	@fragment
	fn fragmentMain(input : FragmentInput) -> FragmentOutput {
		var color = vec3f(0, 0, 0);
		let textureDims = textureDimensions(morphTexture);
		let pixelCoords = vec2i(input.uv0 * vec2f(textureDims));
		
		for (var i: u32 = 0; i < uniform.count; i = i + 1) {
			var textureIndex: u32 = uniform.morphIndex[i].element;
			var delta = textureLoad(morphTexture, pixelCoords, textureIndex, 0).xyz;
			color += uniform.morphFactor[i].element * delta;
		}
		var output: FragmentOutput;
		output.color = vec4f(color, 1.0);
		return output;
	}
`});var d6,u6=m(()=>{d6=`
	attribute vertex_position: vec2f;
	varying uv0: vec2f;
	@vertex
	fn vertexMain(input: VertexInput) -> VertexOutput {
		var output: VertexOutput;
		output.position = vec4f(input.vertex_position, 0.5, 1.0);
		output.uv0 = input.vertex_position * 0.5 + vec2f(0.5, 0.5);
		return output;
	}
`});var m6,p6=m(()=>{m6=`
attribute vertex_outlineParameters: vec3f;
attribute vertex_shadowParameters: vec3f;
varying outline_color: vec4f;
varying outline_thickness: f32;
varying shadow_color: vec4f;
varying shadow_offset: vec2f;
var<private> dOutlineColor: vec4f;
var<private> dOutlineThickness: f32;
var<private> dShadowColor: vec4f;
var<private> dShadowOffset: vec2f;
fn unpackMsdfParams() {
	let little: vec3f = vertex_outlineParameters % vec3f(256.0);
	let big: vec3f = (vertex_outlineParameters - little) / 256.0;
	dOutlineColor = vec4f(little.x, big.x, little.y, big.y) / 255.0;
	dOutlineThickness = little.z / 255.0 * 0.2;
	let little_shadow = vertex_shadowParameters % vec3f(256.0);
	let big_shadow = (vertex_shadowParameters - little_shadow) / 256.0;
	dShadowColor = vec4f(little_shadow.x, big_shadow.x, little_shadow.y, big_shadow.y) / 255.0;
	dShadowOffset = (vec2f(little_shadow.z, big_shadow.z) / 127.0 - 1.0) * 0.005;
}
`});var _6,g6=m(()=>{_6=`
var<private> dNormalMatrix: mat3x3f;
fn getNormal() -> vec3f {
	dNormalMatrix = getNormalMatrix(dModelMatrix);
	let localNormal: vec3f = getLocalNormal(vertex_normal);
	return normalize(dNormalMatrix * localNormal);
}`});var S6,T6=m(()=>{S6=`
attribute vertex_normal: vec3f;
uniform matrix_normal: mat3x3f;
#ifdef MORPHING_NORMAL
	#ifdef MORPHING_INT
		var morphNormalTex: texture_2d<u32>;
		var morphNormalTexSampler: sampler;
	#else
		var morphNormalTex: texture_2d<f32>;
		var morphNormalTexSampler: sampler;
	#endif
#endif
fn getLocalNormal(vertexNormal: vec3f) -> vec3f {
	var localNormal: vec3f = vertexNormal;
	#ifdef MORPHING_NORMAL
		let morphUV: vec2i = getTextureMorphCoords();
		#ifdef MORPHING_INT
			let morphNormalInt: vec4u = textureLoad(morphNormalTex, morphUV, 0);
			let morphNormalF: vec3f = vec3f(morphNormalInt.xyz) / 65535.0 * 2.0 - 1.0;
			localNormal = localNormal + morphNormalF;
		#else
			let morphNormal: vec3f = textureLoad(morphNormalTex, morphUV, 0).xyz;
			localNormal = localNormal + morphNormal;
		#endif
	#endif
	return localNormal;
}
#if defined(SKIN) || defined(BATCH)
	fn getNormalMatrix(modelMatrix: mat4x4f) -> mat3x3f {
		return mat3x3f(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);
	}
#elif defined(INSTANCING)
	fn getNormalMatrix(modelMatrix: mat4x4f) -> mat3x3f {
		return mat3x3f(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);
	}
#else
	fn getNormalMatrix(modelMatrix: mat4x4f) -> mat3x3f {
		return uniform.matrix_normal;
	}
#endif
`});var E6,v6=m(()=>{E6=`
#ifdef STD_NORMAL_TEXTURE
	uniform material_bumpiness: f32;
#endif
#ifdef STD_NORMALDETAIL_TEXTURE
	uniform material_normalDetailMapBumpiness: f32;
	fn blendNormals(inN1: vec3f, inN2: vec3f) -> vec3f {
		let n1: vec3f = inN1 + vec3f(0.0, 0.0, 1.0);
		let n2: vec3f = inN2 * vec3f(-1.0, -1.0, 1.0);
		return n1 * dot(n1, n2) / n1.z - n2;
	}
#endif
fn getNormal() {
#ifdef STD_NORMAL_TEXTURE
	var normalMap: vec3f = {STD_NORMAL_TEXTURE_DECODE}(textureSampleBias({STD_NORMAL_TEXTURE_NAME}, {STD_NORMAL_TEXTURE_NAME}Sampler, {STD_NORMAL_TEXTURE_UV}, uniform.textureBias));
	normalMap = mix(vec3f(0.0, 0.0, 1.0), normalMap, uniform.material_bumpiness);
	#ifdef STD_NORMALDETAIL_TEXTURE
		var normalDetailMap: vec3f = {STD_NORMALDETAIL_TEXTURE_DECODE}(textureSampleBias({STD_NORMALDETAIL_TEXTURE_NAME}, {STD_NORMALDETAIL_TEXTURE_NAME}Sampler, {STD_NORMALDETAIL_TEXTURE_UV}, uniform.textureBias));
		normalDetailMap = mix(vec3f(0.0, 0.0, 1.0), normalDetailMap, uniform.material_normalDetailMapBumpiness);
		normalMap = blendNormals(normalMap, normalDetailMap);
	#endif
	dNormalW = normalize(dTBN * normalMap);
#else
	dNormalW = dVertexNormalW;
#endif
}
`});var x6,y6=m(()=>{x6=`
uniform material_opacity: f32;
fn getOpacity() {
	dAlpha = uniform.material_opacity;
	#ifdef STD_OPACITY_TEXTURE
	dAlpha = dAlpha * textureSampleBias({STD_OPACITY_TEXTURE_NAME}, {STD_OPACITY_TEXTURE_NAME}Sampler, {STD_OPACITY_TEXTURE_UV}, uniform.textureBias).{STD_OPACITY_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_OPACITY_VERTEX
	dAlpha = dAlpha * clamp(vVertexColor.{STD_OPACITY_VERTEX_CHANNEL}, 0.0, 1.0);
	#endif
}
`});var A6,P6=m(()=>{A6=`
#if STD_OPACITY_DITHER == BAYER8
	#include "bayerPS"
#endif
uniform blueNoiseJitter: vec4f;
#if STD_OPACITY_DITHER == BLUENOISE
	var blueNoiseTex32 : texture_2d<f32>;
	var blueNoiseTex32Sampler : sampler;
#endif
fn opacityDither(alpha: f32, id: f32) {
	#if STD_OPACITY_DITHER == BAYER8
		var noise: f32 = bayer8(floor((pcPosition.xy + uniform.blueNoiseJitter.xy + id) % vec2f(8.0))) / 64.0;
	#else
		#if STD_OPACITY_DITHER == BLUENOISE
			var uv = fract(pcPosition.xy / 32.0 + uniform.blueNoiseJitter.xy + id);
			var noise: f32 = textureSampleLevel(blueNoiseTex32, blueNoiseTex32Sampler, uv, 0.0).y;
		#endif
		#if STD_OPACITY_DITHER == IGNNOISE
			var magic = vec3f(0.06711056, 0.00583715, 52.9829189);
			var noise: f32 = fract(magic.z * fract(dot(pcPosition.xy + uniform.blueNoiseJitter.xy + id, magic.xy)));
		#endif
	#endif
	noise = pow(noise, 2.2);
	if (alpha < noise) {
		discard;
	}
}
`});var R6,C6=m(()=>{R6=`
`});var I6,w6=m(()=>{I6=`
#if LIT_BLEND_TYPE == NORMAL || LIT_BLEND_TYPE == ADDITIVEALPHA || defined(LIT_ALPHA_TO_COVERAGE)
	output.color = vec4f(output.color.rgb, litArgs_opacity);
#elif LIT_BLEND_TYPE == PREMULTIPLIED
	output.color = vec4f(output.color.rgb * litArgs_opacity, litArgs_opacity);
#else
	output.color = vec4f(output.color.rgb, 1.0);
#endif
`});var L6,b6=m(()=>{L6=`
varying vUv0: vec2f;
var source: texture_2d<f32>;
var sourceSampler: sampler;
@fragment fn fragmentMain(input : FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	output.color = textureSample(source, sourceSampler, input.vUv0);
	return output;
}
`});var M6,D6=m(()=>{M6=`
uniform material_sheen: vec3f;
fn getSheen() {
	var sheenColor = uniform.material_sheen;
	#ifdef STD_SHEEN_TEXTURE
	sheenColor = sheenColor * {STD_SHEEN_TEXTURE_DECODE}(textureSampleBias({STD_SHEEN_TEXTURE_NAME}, {STD_SHEEN_TEXTURE_NAME}Sampler, {STD_SHEEN_TEXTURE_UV}, uniform.textureBias)).{STD_SHEEN_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_SHEEN_VERTEX
	sheenColor = sheenColor * saturate3(vVertexColor.{STD_SHEEN_VERTEX_CHANNEL});
	#endif
	sSpecularity = sheenColor;
}
`});var O6,N6=m(()=>{O6=`
uniform material_sheenGloss: f32;
fn getSheenGlossiness() {
	var sheenGlossiness = uniform.material_sheenGloss;
	#ifdef STD_SHEENGLOSS_TEXTURE
	sheenGlossiness = sheenGlossiness * textureSampleBias({STD_SHEENGLOSS_TEXTURE_NAME}, {STD_SHEENGLOSS_TEXTURE_NAME}Sampler, {STD_SHEENGLOSS_TEXTURE_UV}, uniform.textureBias).{STD_SHEENGLOSS_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_SHEENGLOSS_VERTEX
	sheenGlossiness = sheenGlossiness * saturate(vVertexColor.{STD_SHEENGLOSS_VERTEX_CHANNEL});
	#endif
	#ifdef STD_SHEENGLOSS_INVERT
	sheenGlossiness = 1.0 - sheenGlossiness;
	#endif
	sGlossiness = sheenGlossiness + 0.0000001;
}
`});var F6,U6=m(()=>{F6=`
uniform material_heightMapFactor: f32;
fn getParallax() {
	var parallaxScale = uniform.material_heightMapFactor;
	var height: f32 = textureSampleBias({STD_HEIGHT_TEXTURE_NAME}, {STD_HEIGHT_TEXTURE_NAME}Sampler, {STD_HEIGHT_TEXTURE_UV}, uniform.textureBias).{STD_HEIGHT_TEXTURE_CHANNEL};
	height = height * parallaxScale - parallaxScale * 0.5;
	var viewDirT: vec3f = dViewDirW * dTBN;
	viewDirT.z = viewDirT.z + 0.42;
	dUvOffset = height * (viewDirT.xy / viewDirT.z);
}
`});var B6,V6=m(()=>{B6=`
uniform meshInstanceId: u32;
fn getPickOutput() -> vec4f {
	let inv: vec4f = vec4f(1.0 / 255.0);
	let shifts: vec4u = vec4u(16u, 8u, 0u, 24u);
	let col: vec4u = (vec4u(uniform.meshInstanceId) >> shifts) & vec4u(0xffu);
	return vec4f(col) * inv;
}`});var k6,G6=m(()=>{k6=`
fn getReflDir(worldNormal: vec3f, viewDir: vec3f, gloss: f32, tbn: mat3x3f) {
	dReflDirW = normalize(-reflect(viewDir, worldNormal));
}
`});var z6,H6=m(()=>{z6=`
fn getReflDir(worldNormal: vec3f, viewDir: vec3f, gloss: f32, tbn: mat3x3f) {
	let roughness: f32 = sqrt(1.0 - min(gloss, 1.0));
	let direction: vec2f = dAnisotropyRotation;
	let anisotropicT: vec3f = normalize(tbn * vec3f(direction, 0.0));
	let anisotropicB: vec3f = normalize(cross(tbn[2], anisotropicT));
	let anisotropy: f32 = dAnisotropy;
	let anisotropicDirection: vec3f = anisotropicB;
	let anisotropicTangent: vec3f = cross(anisotropicDirection, viewDir);
	let anisotropicNormal: vec3f = cross(anisotropicTangent, anisotropicDirection);
	let bendFactor: f32 = 1.0 - anisotropy * (1.0 - roughness);
	let bendFactor4: f32 = bendFactor * bendFactor * bendFactor * bendFactor;
	let bentNormal: vec3f = normalize(mix(normalize(anisotropicNormal), normalize(worldNormal), bendFactor4));
	dReflDirW = reflect(-viewDir, bentNormal);
}`});var X6,W6=m(()=>{X6=`
#ifdef LIT_CLEARCOAT
fn addReflectionCC(reflDir: vec3f, gloss: f32) {
	ccReflection = ccReflection + calcReflection(reflDir, gloss);
}
#endif
`});var Y6,K6=m(()=>{Y6=`
var texture_cubeMap: texture_cube<f32>;
var texture_cubeMapSampler: sampler;
uniform material_reflectivity: f32;
fn calcReflection(reflDir: vec3f, gloss: f32) -> vec3f {
	var lookupVec: vec3f = cubeMapProject(reflDir);
	lookupVec.x = lookupVec.x * -1.0;
	return {reflectionDecode}(textureSample(texture_cubeMap, texture_cubeMapSampler, lookupVec));
}
fn addReflection(reflDir: vec3f, gloss: f32) {
	dReflection = dReflection + vec4f(calcReflection(reflDir, gloss), uniform.material_reflectivity);
}
`});var q6,j6=m(()=>{q6=`
#ifndef ENV_ATLAS
	#define ENV_ATLAS
	var texture_envAtlas: texture_2d<f32>;
	var texture_envAtlasSampler: sampler;
#endif
var texture_cubeMap: texture_cube<f32>;
var texture_cubeMapSampler: sampler;
uniform material_reflectivity: f32;
fn calcReflection(reflDir: vec3f, gloss: f32) -> vec3f {
	let dir: vec3f = cubeMapProject(reflDir) * vec3f(-1.0, 1.0, 1.0);
	let uv: vec2f = toSphericalUv(dir);
	let level: f32 = saturate(1.0 - gloss) * 5.0;
	let ilevel: f32 = floor(level);
	let flevel: f32 = level - ilevel;
	let sharp: vec3f = {reflectionCubemapDecode}(textureSample(texture_cubeMap, texture_cubeMapSampler, dir));
	let roughA: vec3f = {reflectionDecode}(textureSample(texture_envAtlas, texture_envAtlasSampler, mapRoughnessUv(uv, ilevel)));
	let roughB: vec3f = {reflectionDecode}(textureSample(texture_envAtlas, texture_envAtlasSampler, mapRoughnessUv(uv, ilevel + 1.0)));
	return processEnvironment(mix(sharp, mix(roughA, roughB, flevel), min(level, 1.0)));
}
fn addReflection(reflDir: vec3f, gloss: f32) {
	dReflection = dReflection + vec4f(calcReflection(reflDir, gloss), uniform.material_reflectivity);
}
`});var $6,Z6=m(()=>{$6=`
#ifndef ENV_ATLAS
#define ENV_ATLAS
	var texture_envAtlas: texture_2d<f32>;
	var texture_envAtlasSampler: sampler;
#endif
uniform material_reflectivity: f32;
fn shinyMipLevel(uv: vec2f) -> f32 {
	let dx: vec2f = dpdx(uv);
	let dy: vec2f = dpdy(uv);
	let uv2: vec2f = vec2f(fract(uv.x + 0.5), uv.y);
	let dx2: vec2f = dpdx(uv2);
	let dy2: vec2f = dpdy(uv2);
	let maxd: f32 = min(max(dot(dx, dx), dot(dy, dy)), max(dot(dx2, dx2), dot(dy2, dy2)));
	return clamp(0.5 * log2(maxd) - 1.0 + uniform.textureBias, 0.0, 5.0);
}
fn calcReflection(reflDir: vec3f, gloss: f32) -> vec3f {
	let dir: vec3f = cubeMapProject(reflDir) * vec3f(-1.0, 1.0, 1.0);
	let uv: vec2f = toSphericalUv(dir);
	let level: f32 = saturate(1.0 - gloss) * 5.0;
	let ilevel: f32 = floor(level);
	let level2: f32 = shinyMipLevel(uv * atlasSize);
	let ilevel2: f32 = floor(level2);
	var uv0: vec2f;
	var uv1: vec2f;
	var weight: f32;
	if (ilevel == 0.0) {
		uv0 = mapShinyUv(uv, ilevel2);
		uv1 = mapShinyUv(uv, ilevel2 + 1.0);
		weight = level2 - ilevel2;
	} else {
		uv0 = mapRoughnessUv(uv, ilevel);
		uv1 = uv0;
		weight = 0.0;
	}
	let linearA: vec3f = {reflectionDecode}(textureSample(texture_envAtlas, texture_envAtlasSampler, uv0));
	let linearB: vec3f = {reflectionDecode}(textureSample(texture_envAtlas, texture_envAtlasSampler, uv1));
	let linear0: vec3f = mix(linearA, linearB, weight);
	let linear1: vec3f = {reflectionDecode}(textureSample(texture_envAtlas, texture_envAtlasSampler, mapRoughnessUv(uv, ilevel + 1.0)));
	return processEnvironment(mix(linear0, linear1, level - ilevel));
}
fn addReflection(reflDir: vec3f, gloss: f32) {
	dReflection = dReflection + vec4f(calcReflection(reflDir, gloss), uniform.material_reflectivity);
}
`});var Q6,J6=m(()=>{Q6=`
#ifndef VIEWMATRIX
	#define VIEWMATRIX
	uniform matrix_view: mat4x4f;
#endif
var texture_sphereMap: texture_2d<f32>;
var texture_sphereMapSampler: sampler;
uniform material_reflectivity: f32;
fn calcReflection(reflDir: vec3f, gloss: f32) -> vec3f {
	let viewRotationMatrix = mat3x3f(uniform.matrix_view[0].xyz, uniform.matrix_view[1].xyz, uniform.matrix_view[2].xyz);
	let reflDirV: vec3f = viewRotationMatrix * reflDir;
	let m: f32 = 2.0 * sqrt(dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z + 1.0) * (reflDirV.z + 1.0));
	let sphereMapUv: vec2f = reflDirV.xy / m + 0.5;
	return {reflectionDecode}(textureSample(texture_sphereMap, texture_sphereMapSampler, sphereMapUv));
}
fn addReflection(reflDir: vec3f, gloss: f32) {
	dReflection = dReflection + vec4f(calcReflection(reflDir, gloss), uniform.material_reflectivity);
}
`});var eK,tK=m(()=>{eK=`
fn addReflectionSheen(worldNormal: vec3f, viewDir: vec3f, gloss: f32) {
	let NoV: f32 = dot(worldNormal, viewDir);
	let alphaG: f32 = gloss * gloss;
	let a: f32 = select(
		-8.48 * alphaG + 14.3 * gloss - 9.95,
		-339.2 * alphaG + 161.4 * gloss - 25.9,
		gloss < 0.25
	);
	let b: f32 = select(
		1.97 * alphaG - 3.27 * gloss + 0.72,
		44.0 * alphaG - 23.7 * gloss + 3.26,
		gloss < 0.25
	);
	let dg_add: f32 = select(
		0.1 * ( gloss - 0.25 ),
		0.0,
		gloss < 0.25
	);
	let dg: f32 = exp( a * NoV + b ) + dg_add;
	sReflection = sReflection + (calcReflection(worldNormal, 0.0) * saturate(dg));
}`});var sK,iK=m(()=>{sK=`
fn refract2(viewVec: vec3f, normal: vec3f, IOR: f32) -> vec3f {
	let vn: f32 = dot(viewVec, normal);
	let k: f32 = 1.0 - IOR * IOR * (1.0 - vn * vn);
	let refrVec: vec3f = IOR * viewVec - (IOR * vn + sqrt(k)) * normal;
	return refrVec;
}
fn addRefraction(
	worldNormal: vec3f,
	viewDir: vec3f,
	thickness: f32,
	gloss: f32,
	specularity: vec3f,
	albedo: vec3f,
	transmission: f32,
	refractionIndex: f32,
	dispersion: f32
#if defined(LIT_IRIDESCENCE)
	, iridescenceFresnel: vec3f,
	iridescenceIntensity: f32
#endif
) {
	let tmpRefl: vec4f = dReflection;
	let reflectionDir: vec3f = refract2(-viewDir, worldNormal, refractionIndex);
	dReflection = vec4f(0.0);
	addReflection(reflectionDir, gloss);
	dDiffuseLight = mix(dDiffuseLight, dReflection.rgb * albedo, transmission);
	dReflection = tmpRefl;
}
`});var rK,aK=m(()=>{rK=`
uniform material_invAttenuationDistance: f32;
uniform material_attenuation: vec3f;
fn evalRefractionColor(refractionVector: vec3f, gloss: f32, refractionIndex: f32) -> vec3f {
	let pointOfRefraction: vec4f = vec4f(vPositionW + refractionVector, 1.0);
	let projectionPoint: vec4f = uniform.matrix_viewProjection * pointOfRefraction;
	let uv: vec2f = getGrabScreenPos(projectionPoint);
	let iorToRoughness: f32 = (1.0 - gloss) * clamp((1.0 / refractionIndex) * 2.0 - 2.0, 0.0, 1.0);
	let refractionLod: f32 = log2(uniform.uScreenSize.x) * iorToRoughness;
	let refraction: vec3f = textureSampleLevel(uSceneColorMap, uSceneColorMapSampler, uv, refractionLod).rgb;
	return refraction;
}
fn addRefraction(
	worldNormal: vec3f,
	viewDir: vec3f,
	thickness: f32,
	gloss: f32,
	specularity: vec3f,
	albedo: vec3f,
	transmission: f32,
	refractionIndex: f32,
	dispersion: f32,
#if defined(LIT_IRIDESCENCE)
	iridescenceFresnel: vec3f,
	iridescenceIntensity: f32
#endif
) {
	var modelScale: vec3f;
	modelScale.x = length(uniform.matrix_model[0].xyz);
	modelScale.y = length(uniform.matrix_model[1].xyz);
	modelScale.z = length(uniform.matrix_model[2].xyz);
	let scale: vec3f = thickness * modelScale;
	var refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndex)) * scale;
	var refraction = evalRefractionColor(refractionVector, gloss, refractionIndex);
	#ifdef LIT_DISPERSION
		let halfSpread: f32 = (1.0 / refractionIndex - 1.0) * 0.025 * dispersion;
		let refractionIndexR: f32 = refractionIndex - halfSpread;
		refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndexR)) * scale;
		refraction.r = evalRefractionColor(refractionVector, gloss, refractionIndexR).r;
		let refractionIndexB: f32 = refractionIndex + halfSpread;
		refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndexB)) * scale;
		refraction.b = evalRefractionColor(refractionVector, gloss, refractionIndexB).b;
	#endif
	var transmittance: vec3f;
	if (uniform.material_invAttenuationDistance != 0.0)
	{
		let attenuation: vec3f = -log(uniform.material_attenuation) * uniform.material_invAttenuationDistance;
		transmittance = exp(-attenuation * length(refractionVector));
	}
	else
	{
		transmittance = refraction;
	}
	let fresnel: vec3f = vec3f(1.0) -
		getFresnel(
			dot(viewDir, worldNormal),
			gloss,
			specularity
		#if defined(LIT_IRIDESCENCE)
			, iridescenceFresnel,
			iridescenceIntensity
		#endif
		);
	dDiffuseLight = mix(dDiffuseLight, refraction * transmittance * fresnel, transmission);
}
`});var nK,oK=m(()=>{nK=`
varying vUv0: vec2f;
#ifdef CUBEMAP_SOURCE
	var sourceCube: texture_cube<f32>;
	var sourceCubeSampler : sampler;
#else
	var sourceTex: texture_2d<f32>;
	var sourceTexSampler : sampler;
#endif
#ifdef USE_SAMPLES_TEX
	var samplesTex: texture_2d<f32>;
	var samplesTexSampler : sampler;
	uniform samplesTexInverseSize: vec2f;
#endif
uniform params: vec3f;
fn targetFace() -> f32 { return uniform.params.x; }
fn targetTotalPixels() -> f32 { return uniform.params.y; }
fn sourceTotalPixels() -> f32 { return uniform.params.z; }
const PI: f32 = 3.141592653589793;
fn saturate(x: f32) -> f32 {
	return clamp(x, 0.0, 1.0);
}
#include "decodePS"
#include "encodePS"
fn modifySeams(dir: vec3f, scale: f32) -> vec3f {
	let adir = abs(dir);
	let M = max(max(adir.x, adir.y), adir.z);
	return dir / M * vec3f(
		select(scale, 1.0, adir.x == M),
		select(scale, 1.0, adir.y == M),
		select(scale, 1.0, adir.z == M)
	);
}
fn toSpherical(dir: vec3f) -> vec2f {
	let nonZeroXZ = any(dir.xz != vec2f(0.0, 0.0));
	return vec2f(select(0.0, atan2(dir.x, dir.z), nonZeroXZ), asin(dir.y));
}
fn fromSpherical(uv: vec2f) -> vec3f {
	return vec3f(cos(uv.y) * sin(uv.x),
				sin(uv.y),
				cos(uv.y) * cos(uv.x));
}
fn getDirectionEquirect(uv: vec2f) -> vec3f {
	return fromSpherical((vec2f(uv.x, 1.0 - uv.y) * 2.0 - 1.0) * vec2f(PI, PI * 0.5));
}
fn signNotZero(k: f32) -> f32 {
	return select(-1.0, 1.0, k >= 0.0);
}
fn signNotZeroVec2(v: vec2f) -> vec2f {
	return vec2f(signNotZero(v.x), signNotZero(v.y));
}
fn octDecode(o: vec2f) -> vec3f {
	var v = vec3f(o.x, 1.0 - abs(o.x) - abs(o.y), o.y);
	if (v.y < 0.0) {
		var temp: vec2f = (1.0 - abs(v.zx)) * signNotZeroVec2(v.xz);
		v = vec3f(temp.x, v.y, temp.y);
	}
	return normalize(v);
}
fn getDirectionOctahedral(uv: vec2f) -> vec3f {
	return octDecode(vec2f(uv.x, 1.0 - uv.y) * 2.0 - 1.0);
}
fn octEncode(v: vec3f) -> vec2f {
	let l1norm = abs(v.x) + abs(v.y) + abs(v.z);
	var result = v.xz * (1.0 / l1norm);
	if (v.y < 0.0) {
		result = (1.0 - abs(result.yx)) * signNotZeroVec2(result.xy);
	}
	return result;
}
#ifdef CUBEMAP_SOURCE
	fn sampleCubemapDir(dir: vec3f) -> vec4f {
		return textureSample(sourceCube, sourceCubeSampler, modifySeams(dir, 1.0));
	}
	fn sampleCubemapSph(sph: vec2f) -> vec4f {
		return sampleCubemapDir(fromSpherical(sph));
	}
	fn sampleCubemapDirLod(dir: vec3f, mipLevel: f32) -> vec4f {
		return textureSampleLevel(sourceCube, sourceCubeSampler, modifySeams(dir, 1.0), mipLevel);
	}
	fn sampleCubemapSphLod(sph: vec2f, mipLevel: f32) -> vec4f {
		return sampleCubemapDirLod(fromSpherical(sph), mipLevel);
	}
#else
	fn sampleEquirectSph(sph: vec2f) -> vec4f {
		let uv = sph / vec2f(PI * 2.0, PI) + 0.5;
		return textureSample(sourceTex, sourceTexSampler, vec2f(uv.x, 1.0 - uv.y));
	}
	fn sampleEquirectDir(dir: vec3f) -> vec4f {
		return sampleEquirectSph(toSpherical(dir));
	}
	fn sampleEquirectSphLod(sph: vec2f, mipLevel: f32) -> vec4f {
		let uv = sph / vec2f(PI * 2.0, PI) + 0.5;
		return textureSampleLevel(sourceTex, sourceTexSampler, vec2f(uv.x, 1.0 - uv.y), mipLevel);
	}
	fn sampleEquirectDirLod(dir: vec3f, mipLevel: f32) -> vec4f {
		return sampleEquirectSphLod(toSpherical(dir), mipLevel);
	}
	fn sampleOctahedralDir(dir: vec3f) -> vec4f {
		let uv = octEncode(dir) * 0.5 + 0.5;
		return textureSample(sourceTex, sourceTexSampler, vec2f(uv.x, 1.0 - uv.y));
	}
	fn sampleOctahedralSph(sph: vec2f) -> vec4f {
		return sampleOctahedralDir(fromSpherical(sph));
	}
	fn sampleOctahedralDirLod(dir: vec3f, mipLevel: f32) -> vec4f {
		let uv = octEncode(dir) * 0.5 + 0.5;
		return textureSampleLevel(sourceTex, sourceTexSampler, vec2f(uv.x, 1.0 - uv.y), mipLevel);
	}
	fn sampleOctahedralSphLod(sph: vec2f, mipLevel: f32) -> vec4f {
		return sampleOctahedralDirLod(fromSpherical(sph), mipLevel);
	}
#endif
fn getDirectionCubemap(uv: vec2f) -> vec3f {
	let st = uv * 2.0 - 1.0;
	let face = targetFace();
	var vec: vec3f;
	if (face == 0.0) {
		vec = vec3f(1, -st.y, -st.x);
	} else if (face == 1.0) {
		vec = vec3f(-1, -st.y, st.x);
	} else if (face == 2.0) {
		vec = vec3f(st.x, 1, st.y);
	} else if (face == 3.0) {
		vec = vec3f(st.x, -1, -st.y);
	} else if (face == 4.0) {
		vec = vec3f(st.x, -st.y, 1);
	} else {
		vec = vec3f(-st.x, -st.y, -1);
	}
	return normalize(modifySeams(vec, 1.0));
}
fn matrixFromVector(n: vec3f) -> mat3x3f {
	let a = 1.0 / (1.0 + n.z);
	let b = -n.x * n.y * a;
	let b1 = vec3f(1.0 - n.x * n.x * a, b, -n.x);
	let b2 = vec3f(b, 1.0 - n.y * n.y * a, -n.y);
	return mat3x3f(b1, b2, n);
}
fn matrixFromVectorSlow(n: vec3f) -> mat3x3f {
	let up = select(vec3f(0.0, 0.0, select(-1.0, 1.0, n.y > 0.0)), vec3f(0.0, 1.0, 0.0), abs(n.y) > 0.0000001);
	let x = normalize(cross(up, n));
	let y = cross(n, x);
	return mat3x3f(x, y, n);
}
fn reproject(uv: vec2f) -> vec4f {
	if ({NUM_SAMPLES} <= 1) {
		return {ENCODE_FUNC}({DECODE_FUNC}({SOURCE_FUNC}Dir({TARGET_FUNC}(uv))));
	} else {
		let t = {TARGET_FUNC}(uv);
		let tu = dpdx(t);
		let tv = dpdy(t);
		var result = vec3f(0.0);
		for (var u = 0.0; u < {NUM_SAMPLES_SQRT}; u += 1.0) {
			for (var v = 0.0; v < {NUM_SAMPLES_SQRT}; v += 1.0) {
				result += {DECODE_FUNC}({SOURCE_FUNC}Dir(normalize(t +
															tu * (u / {NUM_SAMPLES_SQRT} - 0.5) +
															tv * (v / {NUM_SAMPLES_SQRT} - 0.5))));
			}
		}
		return {ENCODE_FUNC}(result / ({NUM_SAMPLES_SQRT} * {NUM_SAMPLES_SQRT}));
	}
}
const unpackFloat: vec4f = vec4f(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0);
#ifdef USE_SAMPLES_TEX
	fn unpackSample(i: i32, L: ptr<function, vec3f>, mipLevel: ptr<function, f32>) {
		var u = (f32(i * 4) + 0.5) * uniform.samplesTexInverseSize.x;
		var v = (floor(u) + 0.5) * uniform.samplesTexInverseSize.y;
		var raw: vec4f;
		raw.x = dot(textureSample(samplesTex, samplesTexSampler, vec2f(u, v)), unpackFloat); u += uniform.samplesTexInverseSize.x;
		raw.y = dot(textureSample(samplesTex, samplesTexSampler, vec2f(u, v)), unpackFloat); u += uniform.samplesTexInverseSize.x;
		raw.z = dot(textureSample(samplesTex, samplesTexSampler, vec2f(u, v)), unpackFloat); u += uniform.samplesTexInverseSize.x;
		raw.w = dot(textureSample(samplesTex, samplesTexSampler, vec2f(u, v)), unpackFloat);
		*L = raw.xyz * 2.0 - 1.0;
		*mipLevel = raw.w * 8.0;
	}
	fn prefilterSamples(uv: vec2f) -> vec4f {
		let vecSpace = matrixFromVectorSlow({TARGET_FUNC}(uv));
		var L: vec3f;
		var mipLevel: f32;
		var result = vec3f(0.0);
		var totalWeight = 0.0;
		for (var i = 0; i < {NUM_SAMPLES}; i += 1) {
			unpackSample(i, &L, &mipLevel);
			result += {DECODE_FUNC}({SOURCE_FUNC}DirLod(vecSpace * L, mipLevel)) * L.z;
			totalWeight += L.z;
		}
		return {ENCODE_FUNC}(result / totalWeight);
	}
	fn prefilterSamplesUnweighted(uv: vec2f) -> vec4f {
		let vecSpace = matrixFromVectorSlow({TARGET_FUNC}(uv));
		var L: vec3f;
		var mipLevel: f32;
		var result = vec3f(0.0);
		for (var i = 0; i < {NUM_SAMPLES}; i += 1) {
			unpackSample(i, &L, &mipLevel);
			result += {DECODE_FUNC}({SOURCE_FUNC}DirLod(vecSpace * L, mipLevel));
		}
		return {ENCODE_FUNC}(result / f32({NUM_SAMPLES}));
	}
#endif
@fragment
fn fragmentMain(input : FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	output.color = {PROCESS_FUNC}(input.vUv0);
	return output;
}
`});var lK,hK=m(()=>{lK=`
attribute vertex_position: vec2f;
uniform uvMod: vec4f;
varying vUv0: vec2f;
@vertex
fn vertexMain(input: VertexInput) -> VertexOutput {
	var output: VertexOutput;
	output.position = vec4f(input.vertex_position, 0.5, 1.0);
	output.vUv0 = getImageEffectUV((input.vertex_position * 0.5 + vec2f(0.5, 0.5)) * uniform.uvMod.xy + uniform.uvMod.zw);
	return output;
}
`});var cK,fK=m(()=>{cK=`
var uSceneDepthMap: texture_2d<f32>;
var uSceneDepthMapSampler: sampler;
#ifndef SCREENSIZE
	#define SCREENSIZE
	uniform uScreenSize: vec4f;
#endif
#ifndef VIEWMATRIX
	#define VIEWMATRIX
	uniform matrix_view: mat4x4f;
#endif
#ifndef LINEARIZE_DEPTH
	#define LINEARIZE_DEPTH
	#ifndef CAMERAPLANES
		#define CAMERAPLANES
		uniform camera_params: vec4f;
	#endif
	fn linearizeDepth(z: f32) -> f32 {
		if (uniform.camera_params.w == 0.0) {
			return (uniform.camera_params.z * uniform.camera_params.y) / (uniform.camera_params.y + z * (uniform.camera_params.z - uniform.camera_params.y));
		} else {
			return uniform.camera_params.z + z * (uniform.camera_params.y - uniform.camera_params.z);
		}
	}
#endif
fn delinearizeDepth(linearDepth: f32) -> f32 {
	if (uniform.camera_params.w == 0.0) {
		return (uniform.camera_params.y * (uniform.camera_params.z - linearDepth)) / (linearDepth * (uniform.camera_params.z - uniform.camera_params.y));
	} else {
		return (linearDepth - uniform.camera_params.z) / (uniform.camera_params.y - uniform.camera_params.z);
	}
}
fn getLinearScreenDepth(uv: vec2f) -> f32 {
	#ifdef SCENE_DEPTHMAP_LINEAR
		#ifdef SCENE_DEPTHMAP_FLOAT
			return textureSample(uSceneDepthMap, uSceneDepthMapSampler, uv).r;
		#else
			let textureSize = textureDimensions(uSceneDepthMap, 0);
			let texel: vec2i = vec2i(uv * vec2f(textureSize));
			let data: vec4f = textureLoad(uSceneDepthMap, texel, 0);
			let data_u32: vec4u = vec4u(data * 255.0);
			let intBits: u32 = (data_u32.r << 24u) | (data_u32.g << 16u) | (data_u32.b << 8u) | data_u32.a;
			return bitcast<f32>(intBits);
		#endif
	#else
		return linearizeDepth(textureSample(uSceneDepthMap, uSceneDepthMapSampler, uv).r);
	#endif
}
#ifndef VERTEXSHADER
	fn getLinearScreenDepthFrag() -> f32 {
		let uv: vec2f = pcPosition.xy * uniform.uScreenSize.zw;
		return getLinearScreenDepth(uv);
	}
#endif
fn getLinearDepth(pos: vec3f) -> f32 {
	return -(uniform.matrix_view * vec4f(pos, 1.0)).z;
}
`});var dK,uK=m(()=>{dK=`
fn getShadowCascadeIndex(shadowCascadeDistances: vec4f, shadowCascadeCount: i32) -> i32 {
	let depth: f32 = 1.0 / pcPosition.w;
	let comparisons: vec4f = step(shadowCascadeDistances, vec4f(depth));
	let cascadeIndex: i32 = i32(dot(comparisons, vec4f(1.0)));
	return min(cascadeIndex, shadowCascadeCount - 1);
}
fn ditherShadowCascadeIndex(cascadeIndex_in: i32, shadowCascadeDistances: vec4f, shadowCascadeCount: i32, blendFactor: f32) -> i32 {
	var cascadeIndex: i32 = cascadeIndex_in;
	if (cascadeIndex < shadowCascadeCount - 1) {
		let currentRangeEnd: f32 = shadowCascadeDistances[cascadeIndex];
		let transitionStart: f32 = blendFactor * currentRangeEnd;
		let depth: f32 = 1.0 / pcPosition.w;
		if (depth > transitionStart) {
			let transitionFactor: f32 = smoothstep(transitionStart, currentRangeEnd, depth);
			let dither: f32 = fract(sin(dot(pcPosition.xy, vec2f(12.9898, 78.233))) * 43758.5453);
			if (dither < transitionFactor) {
				cascadeIndex = cascadeIndex + 1;
			}
		}
	}
	return cascadeIndex;
}
fn fadeShadow(shadowCoord_in: vec3f, shadowCascadeDistances: vec4f) -> vec3f {
	var shadowCoord: vec3f = shadowCoord_in;
	let depth: f32 = 1.0 / pcPosition.w;
	if (depth > shadowCascadeDistances.w) {
		shadowCoord.z = -9999999.0;
	}
	return shadowCoord;
}
`});var mK,pK=m(()=>{mK=`
fn linstep(a: f32, b: f32, v: f32) -> f32 {
	return clamp((v - a) / (b - a), 0.0, 1.0);
}
fn reduceLightBleeding(pMax: f32, amount: f32) -> f32 {
	 return linstep(amount, 1.0, pMax);
}
fn chebyshevUpperBound(moments: vec2f, mean: f32, minVariance: f32, lightBleedingReduction: f32) -> f32 {
	var variance: f32 = moments.y - (moments.x * moments.x);
	variance = max(variance, minVariance);
	let d: f32 = mean - moments.x;
	var pMax: f32 = variance / (variance + (d * d));
	pMax = reduceLightBleeding(pMax, lightBleedingReduction);
	return select(pMax, 1.0, mean <= moments.x);
}
fn calculateEVSM(moments_in: vec3f, Z_in: f32, vsmBias: f32, exponent: f32) -> f32 {
	let Z: f32 = 2.0 * Z_in - 1.0;
	let warpedDepth: f32 = exp(exponent * Z);
	let moments: vec2f = moments_in.xy + vec2f(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments_in.z);
	let VSMBias: f32 = vsmBias;
	let depthScale: f32 = VSMBias * exponent * warpedDepth;
	let minVariance1: f32 = depthScale * depthScale;
	return chebyshevUpperBound(moments, warpedDepth, minVariance1, 0.1);
}
fn VSM16(tex: texture_2d<f32>, texSampler: sampler, texCoords: vec2f, resolution: f32, Z: f32, vsmBias: f32, exponent: f32) -> f32 {
	let moments: vec3f = textureSampleLevel(tex, texSampler, texCoords, 0.0).xyz;
	return calculateEVSM(moments, Z, vsmBias, exponent);
}
fn getShadowVSM16(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, shadowCoord: vec3f, shadowParams: vec4f, exponent: f32) -> f32 {
	return VSM16(shadowMap, shadowMapSampler, shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);
}
fn getShadowSpotVSM16(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, shadowCoord: vec3f, shadowParams: vec4f, exponent: f32, lightDir: vec3f) -> f32 {
	let Z: f32 = length(lightDir) * shadowParams.w + shadowParams.z;
	return VSM16(shadowMap, shadowMapSampler, shadowCoord.xy, shadowParams.x, Z, shadowParams.y, exponent);
}
fn VSM32(tex: texture_2d<f32>, texSampler: sampler, texCoords_in: vec2f, resolution: f32, Z: f32, vsmBias: f32, exponent: f32) -> f32 {
	#ifdef CAPS_TEXTURE_FLOAT_FILTERABLE
		var moments: vec3f = textureSampleLevel(tex, texSampler, texCoords_in, 0.0).xyz;
	#else
		var pixelSize : f32 = 1.0 / resolution;
		let texCoords: vec2f = texCoords_in - vec2f(pixelSize);
		let s00: vec3f = textureSampleLevel(tex, texSampler, texCoords, 0.0).xyz;
		let s10: vec3f = textureSampleLevel(tex, texSampler, texCoords + vec2f(pixelSize, 0.0), 0.0).xyz;
		let s01: vec3f = textureSampleLevel(tex, texSampler, texCoords + vec2f(0.0, pixelSize), 0.0).xyz;
		let s11: vec3f = textureSampleLevel(tex, texSampler, texCoords + vec2f(pixelSize), 0.0).xyz;
		let fr: vec2f = fract(texCoords * resolution);
		let h0: vec3f = mix(s00, s10, fr.x);
		let h1: vec3f = mix(s01, s11, fr.x);
		var moments: vec3f = mix(h0, h1, fr.y);
	#endif
	return calculateEVSM(moments, Z, vsmBias, exponent);
}
fn getShadowVSM32(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, shadowCoord: vec3f, shadowParams: vec4f, exponent: f32) -> f32 {
	return VSM32(shadowMap, shadowMapSampler, shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);
}
fn getShadowSpotVSM32(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, shadowCoord: vec3f, shadowParams: vec4f, exponent: f32, lightDir: vec3f) -> f32 {
	let Z: f32 = length(lightDir) * shadowParams.w + shadowParams.z;
	return VSM32(shadowMap, shadowMapSampler, shadowCoord.xy, shadowParams.x, Z, shadowParams.y, exponent);
}
`});var _K,gK=m(()=>{_K=`
fn getShadowPCF1x1(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {
	return textureSampleCompareLevel(shadowMap, shadowMapSampler, shadowCoord.xy, shadowCoord.z);
}
fn getShadowSpotPCF1x1(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {
	return textureSampleCompareLevel(shadowMap, shadowMapSampler, shadowCoord.xy, shadowCoord.z);
}
`});var SK,TK=m(()=>{SK=`
fn _getShadowPCF3x3(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec3f) -> f32 {
	let z: f32 = shadowCoord.z;
	let uv: vec2f = shadowCoord.xy * shadowParams.x;
	let shadowMapSizeInv: f32 = 1.0 / shadowParams.x;
	let base_uv_temp: vec2f = floor(uv + 0.5);
	let s: f32 = (uv.x + 0.5 - base_uv_temp.x);
	let t: f32 = (uv.y + 0.5 - base_uv_temp.y);
	let base_uv: vec2f = (base_uv_temp - vec2f(0.5)) * shadowMapSizeInv;
	var sum: f32 = 0.0;
	let uw0: f32 = (3.0 - 2.0 * s);
	let uw1: f32 = (1.0 + 2.0 * s);
	let u0_offset: f32 = (2.0 - s) / uw0 - 1.0;
	let u1_offset: f32 = s / uw1 + 1.0;
	let vw0: f32 = (3.0 - 2.0 * t);
	let vw1: f32 = (1.0 + 2.0 * t);
	let v0_offset: f32 = (2.0 - t) / vw0 - 1.0;
	let v1_offset: f32 = t / vw1 + 1.0;
	let u0: f32 = u0_offset * shadowMapSizeInv + base_uv.x;
	let v0: f32 = v0_offset * shadowMapSizeInv + base_uv.y;
	let u1: f32 = u1_offset * shadowMapSizeInv + base_uv.x;
	let v1: f32 = v1_offset * shadowMapSizeInv + base_uv.y;
	sum = sum + uw0 * vw0 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u0, v0), z);
	sum = sum + uw1 * vw0 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u1, v0), z);
	sum = sum + uw0 * vw1 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u0, v1), z);
	sum = sum + uw1 * vw1 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u1, v1), z);
	sum = sum * (1.0 / 16.0);
	return sum;
}
fn getShadowPCF3x3(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {
	return _getShadowPCF3x3(shadowMap, shadowMapSampler, shadowCoord, shadowParams.xyz);
}
fn getShadowSpotPCF3x3(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {
	return _getShadowPCF3x3(shadowMap, shadowMapSampler, shadowCoord, shadowParams.xyz);
}
`});var EK,vK=m(()=>{EK=`
fn _getShadowPCF5x5(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec3f) -> f32 {
	let z: f32 = shadowCoord.z;
	let uv: vec2f = shadowCoord.xy * shadowParams.x;
	let shadowMapSizeInv: f32 = 1.0 / shadowParams.x;
	let base_uv_temp: vec2f = floor(uv + 0.5);
	let s: f32 = (uv.x + 0.5 - base_uv_temp.x);
	let t: f32 = (uv.y + 0.5 - base_uv_temp.y);
	let base_uv: vec2f = (base_uv_temp - vec2f(0.5)) * shadowMapSizeInv;
	let uw0: f32 = (4.0 - 3.0 * s);
	let uw1: f32 = 7.0;
	let uw2: f32 = (1.0 + 3.0 * s);
	let u0_offset: f32 = (3.0 - 2.0 * s) / uw0 - 2.0;
	let u1_offset: f32 = (3.0 + s) / uw1;
	let u2_offset: f32 = s / uw2 + 2.0;
	let vw0: f32 = (4.0 - 3.0 * t);
	let vw1: f32 = 7.0;
	let vw2: f32 = (1.0 + 3.0 * t);
	let v0_offset: f32 = (3.0 - 2.0 * t) / vw0 - 2.0;
	let v1_offset: f32 = (3.0 + t) / vw1;
	let v2_offset: f32 = t / vw2 + 2.0;
	var sum: f32 = 0.0;
	let u0: f32 = u0_offset * shadowMapSizeInv + base_uv.x;
	let v0: f32 = v0_offset * shadowMapSizeInv + base_uv.y;
	let u1: f32 = u1_offset * shadowMapSizeInv + base_uv.x;
	let v1: f32 = v1_offset * shadowMapSizeInv + base_uv.y;
	let u2: f32 = u2_offset * shadowMapSizeInv + base_uv.x;
	let v2: f32 = v2_offset * shadowMapSizeInv + base_uv.y;
	sum = sum + uw0 * vw0 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u0, v0), z);
	sum = sum + uw1 * vw0 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u1, v0), z);
	sum = sum + uw2 * vw0 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u2, v0), z);
	sum = sum + uw0 * vw1 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u0, v1), z);
	sum = sum + uw1 * vw1 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u1, v1), z);
	sum = sum + uw2 * vw1 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u2, v1), z);
	sum = sum + uw0 * vw2 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u0, v2), z);
	sum = sum + uw1 * vw2 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u1, v2), z);
	sum = sum + uw2 * vw2 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u2, v2), z);
	sum = sum * (1.0 / 144.0);
	sum = saturate(sum);
	return sum;
}
fn getShadowPCF5x5(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {
	return _getShadowPCF5x5(shadowMap, shadowMapSampler, shadowCoord, shadowParams.xyz);
}
fn getShadowSpotPCF5x5(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {
	return _getShadowPCF5x5(shadowMap, shadowMapSampler, shadowCoord, shadowParams.xyz);
}
`});var xK,yK=m(()=>{xK=`
fn fractSinRand(uv: vec2f) -> f32 {
	let PI: f32 = 3.141592653589793;
	let a: f32 = 12.9898; let b: f32 = 78.233; let c: f32 = 43758.5453;
	let dt: f32 = dot(uv.xy, vec2f(a, b));
	let sn: f32 = dt % PI;
	return fract(sin(sn) * c);
}
struct VogelDiskData {
	invNumSamples: f32,
	initialAngle: f32,
	currentPointId: f32,
}
fn prepareDiskConstants(data: ptr<function, VogelDiskData>, sampleCount: i32, randomSeed: f32) {
	let pi2: f32 = 6.28318530718;
	data.invNumSamples = 1.0 / f32(sampleCount);
	data.initialAngle = randomSeed * pi2;
	data.currentPointId = 0.0;
}
fn generateDiskSample(data: ptr<function, VogelDiskData>) -> vec2f {
	let GOLDEN_ANGLE: f32 = 2.399963;
	let r: f32 = sqrt((data.currentPointId + 0.5) * data.invNumSamples);
	let theta: f32 = data.currentPointId * GOLDEN_ANGLE + data.initialAngle;
	let offset: vec2f = vec2f(cos(theta), sin(theta)) * pow(r, 1.33);
	data.currentPointId = data.currentPointId + 1.0;
	return offset;
}
fn PCSSFindBlocker(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, avgBlockerDepth: ptr<function, f32>, numBlockers: ptr<function, i32>,
	shadowCoords: vec2f, z: f32, shadowBlockerSamples: i32, penumbraSize: f32, invShadowMapSize: f32, randomSeed: f32) {
	var diskData: VogelDiskData;
	prepareDiskConstants(&diskData, shadowBlockerSamples, randomSeed);
	let searchWidth: f32 = penumbraSize * invShadowMapSize;
	var blockerSum: f32 = 0.0;
	var numBlockers_local: i32 = 0;
	for( var i: i32 = 0; i < shadowBlockerSamples; i = i + 1 ) {
		let diskUV: vec2f = generateDiskSample(&diskData);
		let sampleUV: vec2f = shadowCoords + diskUV * searchWidth;
		let shadowMapDepth: f32 = textureSampleLevel(shadowMap, shadowMapSampler, sampleUV, 0.0).r;
		if ( shadowMapDepth < z ) {
			blockerSum = blockerSum + shadowMapDepth;
			numBlockers_local = numBlockers_local + 1;
		}
	}
	*avgBlockerDepth = blockerSum / f32(numBlockers_local);
	*numBlockers = numBlockers_local;
}
fn PCSSFilter(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, uv: vec2f, receiverDepth: f32, shadowSamples: i32, filterRadius: f32, randomSeed: f32) -> f32 {
	var diskData: VogelDiskData;
	prepareDiskConstants(&diskData, shadowSamples, randomSeed);
	var sum: f32 = 0.0;
	for (var i: i32 = 0; i < shadowSamples; i = i + 1) {
		let offsetUV: vec2f = generateDiskSample(&diskData) * filterRadius;
		let depth: f32 = textureSampleLevel(shadowMap, shadowMapSampler, uv + offsetUV, 0.0).r;
		sum = sum + step(receiverDepth, depth);
	}
	return sum / f32(shadowSamples);
}
fn getPenumbra(dblocker: f32, dreceiver: f32, penumbraSize: f32, penumbraFalloff: f32) -> f32 {
	let dist: f32 = dreceiver - dblocker;
	let penumbra: f32 = 1.0 - pow(1.0 - dist, penumbraFalloff);
	return penumbra * penumbraSize;
}
fn PCSSDirectional(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, shadowCoords: vec3f, cameraParams: vec4f, softShadowParams: vec4f) -> f32 {
	let receiverDepth: f32 = shadowCoords.z;
	let randomSeed: f32 = fractSinRand(pcPosition.xy);
	let shadowSamples: i32 = i32(softShadowParams.x);
	let shadowBlockerSamples: i32 = i32(softShadowParams.y);
	let penumbraSize: f32 = softShadowParams.z;
	let penumbraFalloff: f32 = softShadowParams.w;
	let shadowMapSize: i32 = i32(textureDimensions(shadowMap, 0).x);
	var invShadowMapSize: f32 = 1.0 / f32(shadowMapSize);
	invShadowMapSize = invShadowMapSize * (f32(shadowMapSize) / 2048.0);
	var penumbra: f32;
	if (shadowBlockerSamples > 0) {
		var avgBlockerDepth: f32 = 0.0;
		var numBlockers: i32 = 0;
		PCSSFindBlocker(shadowMap, shadowMapSampler, &avgBlockerDepth, &numBlockers, shadowCoords.xy, receiverDepth, shadowBlockerSamples, penumbraSize, invShadowMapSize, randomSeed);
		if (numBlockers < 1) {
			return 1.0;
		}
		penumbra = getPenumbra(avgBlockerDepth, shadowCoords.z, penumbraSize, penumbraFalloff);
	} else {
		penumbra = penumbraSize;
	}
	let filterRadius: f32 = penumbra * invShadowMapSize;
	return PCSSFilter(shadowMap, shadowMapSampler, shadowCoords.xy, receiverDepth, shadowSamples, filterRadius, randomSeed);
}
fn getShadowPCSS(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, shadowCoord: vec3f, shadowParams: vec4f, cameraParams: vec4f, softShadowParams: vec4f, lightDir: vec3f) -> f32 {
	return PCSSDirectional(shadowMap, shadowMapSampler, shadowCoord, cameraParams, softShadowParams);
}
`});var AK,PK=m(()=>{AK=`
attribute vertex_boneIndices: f32;
var texture_poseMap: texture_2d<f32>;
fn getBoneMatrix(indexFloat: f32) -> mat4x4f {
	let width = i32(textureDimensions(texture_poseMap).x);
	let index: i32 = i32(indexFloat + 0.5) * 3;
	let iy: i32 = index / width;
	let ix: i32 = index % width;
	let v1: vec4f = textureLoad(texture_poseMap, vec2i(ix + 0, iy), 0);
	let v2: vec4f = textureLoad(texture_poseMap, vec2i(ix + 1, iy), 0);
	let v3: vec4f = textureLoad(texture_poseMap, vec2i(ix + 2, iy), 0);
	return mat4x4f(
		v1.x, v2.x, v3.x, 0,
		v1.y, v2.y, v3.y, 0,
		v1.z, v2.z, v3.z, 0,
		v1.w, v2.w, v3.w, 1.0
	);
}
`});var RK,CK=m(()=>{RK=`
attribute vertex_boneWeights: vec4f;
attribute vertex_boneIndices: vec4f;
var texture_poseMap: texture_2d<f32>;
struct BoneMatrix {
	v1: vec4f,
	v2: vec4f,
	v3: vec4f,
}
fn getBoneMatrix(width: i32, index: i32) -> BoneMatrix {
	let v = index / width;
	let u = index % width;
	var result: BoneMatrix;
	result.v1 = textureLoad(texture_poseMap, vec2i(u + 0, v), 0);
	result.v2 = textureLoad(texture_poseMap, vec2i(u + 1, v), 0);
	result.v3 = textureLoad(texture_poseMap, vec2i(u + 2, v), 0);
	return result;
}
fn getSkinMatrix(indicesFloat: vec4f, weights: vec4f) -> mat4x4f {
	let width = i32(textureDimensions(texture_poseMap).x);
	var indices = vec4i(indicesFloat + 0.5) * 3;
	let boneA = getBoneMatrix(width, indices.x);
	let boneB = getBoneMatrix(width, indices.y);
	let boneC = getBoneMatrix(width, indices.z);
	let boneD = getBoneMatrix(width, indices.w);
	let v1 = boneA.v1 * weights.x + boneB.v1 * weights.y + boneC.v1 * weights.z + boneD.v1 * weights.w;
	let v2 = boneA.v2 * weights.x + boneB.v2 * weights.y + boneC.v2 * weights.z + boneD.v2 * weights.w;
	let v3 = boneA.v3 * weights.x + boneB.v3 * weights.y + boneC.v3 * weights.z + boneD.v3 * weights.w;
	let one = dot(weights, vec4f(1.0, 1.0, 1.0, 1.0));
	return mat4x4f(
		v1.x, v2.x, v3.x, 0,
		v1.y, v2.y, v3.y, 0,
		v1.z, v2.z, v3.z, 0,
		v1.w, v2.w, v3.w, one
	);
}
`});var IK,wK=m(()=>{IK=`
	#define LIT_SKYBOX_INTENSITY
	#include "envProcPS"
	#include "gammaPS"
	#include "tonemappingPS"
	#ifdef PREPASS_PASS
		varying vLinearDepth: f32;
		#include "floatAsUintPS"
	#endif
	varying vViewDir : vec3f;
	uniform skyboxHighlightMultiplier : f32;
	#ifdef SKY_CUBEMAP
		var texture_cubeMap : texture_cube<f32>;
		var texture_cubeMap_sampler : sampler;
		#ifdef SKYMESH
			varying vWorldPos : vec3f;
			uniform cubeMapRotationMatrix : mat3x3f;
			uniform projectedSkydomeCenter : vec3f;
		#endif
	#else
		#include "sphericalPS"
		#include "envAtlasPS"
		var texture_envAtlas : texture_2d<f32>;
		var texture_envAtlas_sampler : sampler;
		uniform mipLevel : f32;
	#endif
	@fragment
	fn fragmentMain(input : FragmentInput) -> FragmentOutput {
		var output: FragmentOutput;
		#ifdef PREPASS_PASS
			output.color = float2vec4(vLinearDepth);
		#else
			var linear : vec3f;
			var dir : vec3f;
			#ifdef SKY_CUBEMAP
				#ifdef SKYMESH
					var envDir : vec3f = normalize(input.vWorldPos - uniform.projectedSkydomeCenter);
					dir = envDir * uniform.cubeMapRotationMatrix;
				#else
					dir = input.vViewDir;
				#endif
				dir.x *= -1.0;
				linear = {SKYBOX_DECODE_FNC}(textureSample(texture_cubeMap, texture_cubeMap_sampler, dir));
			#else
				dir = input.vViewDir * vec3f(-1.0, 1.0, 1.0);
				let uv : vec2f = toSphericalUv(normalize(dir));
				linear = {SKYBOX_DECODE_FNC}(textureSample(texture_envAtlas, texture_envAtlas_sampler, mapRoughnessUv(uv, uniform.mipLevel)));
			#endif
			if (any(linear >= vec3f(64.0))) {
				linear *= uniform.skyboxHighlightMultiplier;
			}
			
			output.color = vec4f(gammaCorrectOutput(toneMap(processEnvironment(linear))), 1.0);
		#endif
		return output;
	}
`});var LK,bK=m(()=>{LK=`
	attribute aPosition : vec4f;
	uniform matrix_view : mat4x4f;
	uniform matrix_projectionSkybox : mat4x4f;
	uniform cubeMapRotationMatrix : mat3x3f;
	varying vViewDir : vec3f;
	#ifdef PREPASS_PASS
		varying vLinearDepth: f32;
	#endif
	#ifdef SKYMESH
		uniform matrix_model : mat4x4f;
		varying vWorldPos : vec3f;
	#endif
	@vertex
	fn vertexMain(input : VertexInput) -> VertexOutput {
		var output : VertexOutput;
		var view : mat4x4f = uniform.matrix_view;
		#ifdef SKYMESH
			var worldPos : vec4f = uniform.matrix_model * input.aPosition;
			output.vWorldPos = worldPos.xyz;
			output.position = uniform.matrix_projectionSkybox * (view * worldPos);
			#ifdef PREPASS_PASS
				output.vLinearDepth = -(uniform.matrix_view * vec4f(worldPos.xyz, 1.0)).z;
			#endif
		#else
			view[3][0] = 0.0;
			view[3][1] = 0.0;
			view[3][2] = 0.0;
			output.position = uniform.matrix_projectionSkybox * (view * input.aPosition);
			output.vViewDir = input.aPosition.xyz * uniform.cubeMapRotationMatrix;
			#ifdef PREPASS_PASS
				output.vLinearDepth = -pcPosition.w;
			#endif
		#endif
		output.position.z = output.position.w - 1.0e-7;
		return output;
	}
`});var MK,DK=m(()=>{MK=`
#ifdef STD_SPECULAR_CONSTANT
	uniform material_specular: vec3f;
#endif
fn getSpecularity() {
	var specularColor = vec3f(1.0, 1.0, 1.0);
	#ifdef STD_SPECULAR_CONSTANT
	specularColor = specularColor * uniform.material_specular;
	#endif
	#ifdef STD_SPECULAR_TEXTURE
	specularColor = specularColor * {STD_SPECULAR_TEXTURE_DECODE}(textureSampleBias({STD_SPECULAR_TEXTURE_NAME}, {STD_SPECULAR_TEXTURE_NAME}Sampler, {STD_SPECULAR_TEXTURE_UV}, uniform.textureBias)).{STD_SPECULAR_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_SPECULAR_VERTEX
	specularColor = specularColor * saturate3(vVertexColor.{STD_SPECULAR_VERTEX_CHANNEL});
	#endif
	dSpecularity = specularColor;
}
`});var OK,NK=m(()=>{OK=`
fn toSpherical(dir: vec3f) -> vec2f {
	let angle_xz = select(0.0, atan2(dir.x, dir.z), any(dir.xz != vec2f(0.0)));
	return vec2f(angle_xz, asin(dir.y));
}
fn toSphericalUv(dir : vec3f) -> vec2f {
	const PI : f32 = 3.141592653589793;
	let uv : vec2f = toSpherical(dir) / vec2f(PI * 2.0, PI) + vec2f(0.5, 0.5);
	return vec2f(uv.x, 1.0 - uv.y);
}
`});var FK,UK=m(()=>{FK=`
#ifdef STD_SPECULARITYFACTOR_CONSTANT
	uniform material_specularityFactor: f32;
#endif
fn getSpecularityFactor() {
	var specularityFactor = 1.0;
	#ifdef STD_SPECULARITYFACTOR_CONSTANT
	specularityFactor = specularityFactor * uniform.material_specularityFactor;
	#endif
	#ifdef STD_SPECULARITYFACTOR_TEXTURE
	specularityFactor = specularityFactor * textureSampleBias({STD_SPECULARITYFACTOR_TEXTURE_NAME}, {STD_SPECULARITYFACTOR_TEXTURE_NAME}Sampler, {STD_SPECULARITYFACTOR_TEXTURE_UV}, uniform.textureBias).{STD_SPECULARITYFACTOR_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_SPECULARITYFACTOR_VERTEX
	specularityFactor = specularityFactor * saturate(vVertexColor.{STD_SPECULARITYFACTOR_VERTEX_CHANNEL});
	#endif
	dSpecularityFactor = specularityFactor;
}
`});var BK,VK=m(()=>{BK=`
fn getSpotEffect(lightSpotDir: vec3f, lightInnerConeAngle: f32, lightOuterConeAngle: f32, lightDirNorm: vec3f) -> f32 {
	let cosAngle: f32 = dot(lightDirNorm, lightSpotDir);
	return smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);
}`});var kK,GK=m(()=>{kK=`
	nineSlicedUv = vec2f(vUv0.x, 1.0 - vUv0.y);
`});var zK,HK=m(()=>{zK=`
	let tileMask: vec2f = step(vMask, vec2f(0.99999));
	let tileSize: vec2f = 0.5 * (innerOffset.xy + innerOffset.zw);
	let tileScale: vec2f = vec2f(1.0) / (vec2f(1.0) - tileSize);
	var clampedUv: vec2f = mix(innerOffset.xy * 0.5, vec2f(1.0) - innerOffset.zw * 0.5, fract((vTiledUv - tileSize) * tileScale));
	clampedUv = clampedUv * atlasRect.zw + atlasRect.xy;
	var nineSlicedUv: vec2f = vUv0 * tileMask + clampedUv * (vec2f(1.0) - tileMask);
	nineSlicedUv.y = 1.0 - nineSlicedUv.y;
`});var XK,WK=m(()=>{XK=`
	var<private> dAlpha: f32 = 1.0;
	#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE
		#ifdef STD_OPACITY_TEXTURE_ALLOCATE
			var texture_opacityMap : texture_2d<f32>;
			var texture_opacityMapSampler : sampler;
		#endif
	#endif
	#ifdef FORWARD_PASS
		var<private> dAlbedo: vec3f;
		var<private> dNormalW: vec3f;
		var<private> dSpecularity: vec3f = vec3f(0.0, 0.0, 0.0);
		var<private> dGlossiness: f32 = 0.0;
		#ifdef LIT_REFRACTION
			var<private> dTransmission: f32;
			var<private> dThickness: f32;
		#endif
		#ifdef LIT_SCENE_COLOR
			var uSceneColorMap : texture_2d<f32>;
			var uSceneColorMapSampler : sampler;
		#endif
		#ifdef LIT_SCREEN_SIZE
			uniform uScreenSize: vec4f;
		#endif
		#ifdef LIT_TRANSFORMS
			var<private> matrix_viewProjection: mat4x4f;
			var<private> matrix_model: mat4x4f;
		#endif
		#ifdef STD_HEIGHT_MAP
			var<private> dUvOffset: vec2f;
			#ifdef STD_DIFFUSE_TEXTURE_ALLOCATE
				var texture_heightMap : texture_2d<f32>;
				var texture_heightMapSampler : sampler;
			#endif
		#endif
		#ifdef STD_DIFFUSE_TEXTURE_ALLOCATE
			var texture_diffuseMap : texture_2d<f32>;
			var texture_diffuseMapSampler : sampler;
		#endif
		#ifdef STD_DIFFUSEDETAIL_TEXTURE_ALLOCATE
			var texture_diffuseDetailMap : texture_2d<f32>;
			var texture_diffuseDetailMapSampler : sampler;
		#endif
		#ifdef STD_NORMAL_TEXTURE_ALLOCATE
			var texture_normalMap : texture_2d<f32>;
			var texture_normalMapSampler : sampler;
		#endif
		#ifdef STD_NORMALDETAIL_TEXTURE_ALLOCATE
			var texture_normalDetailMap : texture_2d<f32>;
			var texture_normalDetailMapSampler : sampler;
		#endif
		#ifdef STD_THICKNESS_TEXTURE_ALLOCATE
			var texture_thicknessMap : texture_2d<f32>;
			var texture_thicknessMapSampler : sampler;
		#endif
		#ifdef STD_REFRACTION_TEXTURE_ALLOCATE
			var texture_refractionMap : texture_2d<f32>;
			var texture_refractionMapSampler : sampler;
		#endif
		#ifdef LIT_IRIDESCENCE
			var<private> dIridescence: f32;
			var<private> dIridescenceThickness: f32;
			#ifdef STD_IRIDESCENCE_THICKNESS_TEXTURE_ALLOCATE
				var texture_iridescenceThicknessMap : texture_2d<f32>;
				var texture_iridescenceThicknessMapSampler : sampler;
			#endif
			#ifdef STD_IRIDESCENCE_TEXTURE_ALLOCATE
				var texture_iridescenceMap : texture_2d<f32>;
				var texture_iridescenceMapSampler : sampler;
			#endif
		#endif
		#ifdef LIT_CLEARCOAT
			var<private> ccSpecularity: f32;
			var<private> ccGlossiness: f32;
			var<private> ccNormalW: vec3f;
		#endif
		#ifdef LIT_GGX_SPECULAR
			var<private> dAnisotropy: f32;
			var<private> dAnisotropyRotation: vec2f;
		#endif
		#ifdef LIT_SPECULAR_OR_REFLECTION
			#ifdef LIT_SHEEN
				var<private> sSpecularity: vec3f;
				var<private> sGlossiness: f32;
				#ifdef STD_SHEEN_TEXTURE_ALLOCATE
					var texture_sheenMap : texture_2d<f32>;
					var texture_sheenMapSampler : sampler;
				#endif
				#ifdef STD_SHEENGLOSS_TEXTURE_ALLOCATE
					var texture_sheenGlossMap : texture_2d<f32>;
					var texture_sheenGlossMapSampler : sampler;
				#endif
			#endif
			#ifdef LIT_METALNESS
				var<private> dMetalness: f32;
				var<private> dIor: f32;
				#ifdef STD_METALNESS_TEXTURE_ALLOCATE
					var texture_metalnessMap : texture_2d<f32>;
					var texture_metalnessMapSampler : sampler;
				#endif
			#endif
			#ifdef LIT_SPECULARITY_FACTOR
				var<private> dSpecularityFactor: f32;
				#ifdef STD_SPECULARITYFACTOR_TEXTURE_ALLOCATE
					var texture_specularityFactorMap : texture_2d<f32>;
					var texture_specularityFactorMapSampler : sampler;
				#endif
			#endif
			#ifdef STD_SPECULAR_COLOR
				#ifdef STD_SPECULAR_TEXTURE_ALLOCATE
					var texture_specularMap : texture_2d<f32>;
					var texture_specularMapSampler : sampler;
				#endif
			#endif
			#ifdef STD_GLOSS_TEXTURE_ALLOCATE
				var texture_glossMap : texture_2d<f32>;
				var texture_glossMapSampler : sampler;
			#endif
		#endif
		#ifdef STD_AO
			var <private> dAo: f32;
			#ifdef STD_AO_TEXTURE_ALLOCATE
				var texture_aoMap : texture_2d<f32>;
				var texture_aoMapSampler : sampler;
			#endif
			#ifdef STD_AODETAIL_TEXTURE_ALLOCATE
				var texture_aoDetailMap : texture_2d<f32>;
				var texture_aoDetailMapSampler : sampler;
			#endif
		#endif
		var <private> dEmission: vec3f;
		#ifdef STD_EMISSIVE_TEXTURE_ALLOCATE
			var texture_emissiveMap : texture_2d<f32>;
			var texture_emissiveMapSampler : sampler;
		#endif
		#ifdef LIT_CLEARCOAT
			#ifdef STD_CLEARCOAT_TEXTURE_ALLOCATE
				var texture_clearCoatMap : texture_2d<f32>;
				var texture_clearCoatMapSampler : sampler;
			#endif
			#ifdef STD_CLEARCOATGLOSS_TEXTURE_ALLOCATE
				var texture_clearCoatGlossMap : texture_2d<f32>;
				var texture_clearCoatGlossMapSampler : sampler;
			#endif
			#ifdef STD_CLEARCOATNORMAL_TEXTURE_ALLOCATE
				var texture_clearCoatNormalMap : texture_2d<f32>;
				var texture_clearCoatNormalMapSampler : sampler;
			#endif
		#endif
		#ifdef LIT_GGX_SPECULAR
			#ifdef STD_ANISOTROPY_TEXTURE_ALLOCATE
				var texture_anisotropyMap : texture_2d<f32>;
				var texture_anisotropyMapSampler : sampler;
			#endif
		#endif
		#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)
			var<private> dLightmap: vec3f;
			#ifdef STD_LIGHT_TEXTURE_ALLOCATE
				var texture_lightMap : texture_2d<f32>;
				var texture_lightMapSampler : sampler;
			#endif
		#endif
	#endif
	#include "litShaderCorePS"
`});var YK,KK=m(()=>{YK=`
	#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE
		#include "opacityPS"
		#if defined(LIT_ALPHA_TEST)
			#include "alphaTestPS"
		#endif
		#if STD_OPACITY_DITHER != NONE
			#include "opacityDitherPS"
		#endif
	#endif
	#ifdef FORWARD_PASS
		#ifdef STD_HEIGHT_MAP
			#include "parallaxPS"
		#endif
		#include  "diffusePS"
		#ifdef LIT_NEEDS_NORMAL
			#include "normalMapPS"
		#endif
		#ifdef LIT_REFRACTION
			#include "transmissionPS"
			#include "thicknessPS"
		#endif
		#ifdef LIT_IRIDESCENCE
			#include "iridescencePS"
			#include "iridescenceThicknessPS"
		#endif
		#ifdef LIT_SPECULAR_OR_REFLECTION
			#ifdef LIT_SHEEN
				#include "sheenPS"
				#include "sheenGlossPS"
			#endif
			#ifdef LIT_METALNESS
				#include "metalnessPS"
				#include "iorPS"
			#endif
			#ifdef LIT_SPECULARITY_FACTOR
				#include "specularityFactorPS"
			#endif
			#ifdef STD_SPECULAR_COLOR
				#include "specularPS"
			#else
				fn getSpecularity() { 
					dSpecularity = vec3f(1.0, 1.0, 1.0);
				}
			#endif
			#include "glossPS"
		#endif
		#ifdef STD_AO
			#include "aoPS"
		#endif
		#include "emissivePS"
		#ifdef LIT_CLEARCOAT
			#include "clearCoatPS"
			#include "clearCoatGlossPS"
			#include "clearCoatNormalPS"
		#endif
		#if defined(LIT_SPECULAR) && defined(LIT_LIGHTING) && defined(LIT_GGX_SPECULAR)
			#include "anisotropyPS"
		#endif
		#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)
			#include "lightmapPS"
		#endif
	#endif
	fn evaluateFrontend() {
		#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE
			getOpacity();
			#if defined(LIT_ALPHA_TEST)
				alphaTest(dAlpha);
			#endif
			#if STD_OPACITY_DITHER != NONE
				opacityDither(dAlpha, 0.0);
			#endif
			litArgs_opacity = dAlpha;
		#endif
		#ifdef FORWARD_PASS
			#ifdef STD_HEIGHT_MAP
				getParallax();
			#endif
			getAlbedo();
			litArgs_albedo = dAlbedo;
			#ifdef LIT_NEEDS_NORMAL
				getNormal();
				litArgs_worldNormal = dNormalW;
			#endif
			#ifdef LIT_REFRACTION
				getRefraction();
				litArgs_transmission = dTransmission;
				getThickness();
				litArgs_thickness = dThickness;
				#ifdef LIT_DISPERSION
					litArgs_dispersion = uniform.material_dispersion;
				#endif
			#endif
			#ifdef LIT_IRIDESCENCE
				getIridescence();
				getIridescenceThickness();
				litArgs_iridescence_intensity = dIridescence;
				litArgs_iridescence_thickness = dIridescenceThickness;
			#endif
			#ifdef LIT_SPECULAR_OR_REFLECTION
				#ifdef LIT_SHEEN
					getSheen();
					litArgs_sheen_specularity = sSpecularity;
					getSheenGlossiness();
					litArgs_sheen_gloss = sGlossiness;
				#endif
				#ifdef LIT_METALNESS
					getMetalness();
					litArgs_metalness = dMetalness;
					getIor();
					litArgs_ior = dIor;
				#endif
				#ifdef LIT_SPECULARITY_FACTOR
					getSpecularityFactor();
					litArgs_specularityFactor = dSpecularityFactor;
				#endif
				getGlossiness();
				getSpecularity();
				litArgs_specularity = dSpecularity;
				litArgs_gloss = dGlossiness;
			#endif
			#ifdef STD_AO
				getAO();
				litArgs_ao = dAo;
			#endif
			getEmission();
			litArgs_emission = dEmission;
			#ifdef LIT_CLEARCOAT
				getClearCoat();
				getClearCoatGlossiness();
				getClearCoatNormal();
				litArgs_clearcoat_specularity = ccSpecularity;
				litArgs_clearcoat_gloss = ccGlossiness;
				litArgs_clearcoat_worldNormal = ccNormalW;
			#endif
			#if defined(LIT_SPECULAR) && defined(LIT_LIGHTING) && defined(LIT_GGX_SPECULAR)
				getAnisotropy();
			#endif
			#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)
				getLightMap();
				litArgs_lightmap = dLightmap;
				#ifdef STD_LIGHTMAP_DIR
					litArgs_lightmapDir = dLightmapDir;
				#endif
			#endif
		#endif
	}
`});var qK,jK=m(()=>{qK=`
#ifdef LIT_TANGENTS
	#define TBN_TANGENTS
#else
	#if defined(LIT_USE_NORMALS) || defined(LIT_USE_CLEARCOAT_NORMALS)
		#define TBN_DERIVATIVES
	#endif
#endif
#if defined(TBN_DERIVATIVES)
	uniform tbnBasis: f32;
#endif
fn getTBN(tangent: vec3f, binormal: vec3f, normal: vec3f) {
	#ifdef TBN_TANGENTS
		dTBN = mat3x3f(normalize(tangent), normalize(binormal), normalize(normal));
	#elif defined(TBN_DERIVATIVES)
		let uv: vec2f = {lightingUv};
		let dp1: vec3f = dpdx( vPositionW );
		let dp2: vec3f = dpdy( vPositionW );
		let duv1: vec2f = dpdx( uv );
		let duv2: vec2f = dpdy( uv );
		let dp2perp: vec3f = cross( dp2, normal );
		let dp1perp: vec3f = cross( normal, dp1 );
		let T: vec3f = dp2perp * duv1.x + dp1perp * duv2.x;
		let B: vec3f = dp2perp * duv1.y + dp1perp * duv2.y;
		let denom: f32 = max( dot(T, T), dot(B, B) );
		let invmax: f32 = select(uniform.tbnBasis / sqrt( denom ), 0.0, denom == 0.0);
		dTBN = mat3x3f(T * invmax, -B * invmax, normal );
	#else
		var B: vec3f = cross(normal, vObjectSpaceUpW);
		var T: vec3f = cross(normal, B);
		if (dot(B,B) == 0.0)
		{
			let major: f32 = max(max(normal.x, normal.y), normal.z);
			if (normal.x == major)
			{
				B = cross(normal, vec3f(0.0, 1.0, 0.0));
				T = cross(normal, B);
			}
			else if (normal.y == major)
			{
				B = cross(normal, vec3f(0.0, 0.0, 1.0));
				T = cross(normal, B);
			}
			else
			{
				B = cross(normal, vec3f(1.0, 0.0, 0.0));
				T = cross(normal, B);
			}
		}
		dTBN = mat3x3f(normalize(T), normalize(B), normalize(normal));
	#endif
}`});var $K,ZK=m(()=>{$K=`
#ifdef STD_THICKNESS_CONSTANT
uniform material_thickness: f32;
#endif
fn getThickness() {
	dThickness = 1.0;
	#ifdef STD_THICKNESS_CONSTANT
	dThickness = dThickness * uniform.material_thickness;
	#endif
	#ifdef STD_THICKNESS_TEXTURE
	dThickness = dThickness * textureSampleBias({STD_THICKNESS_TEXTURE_NAME}, {STD_THICKNESS_TEXTURE_NAME}Sampler, {STD_THICKNESS_TEXTURE_UV}, uniform.textureBias).{STD_THICKNESS_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_THICKNESS_VERTEX
	dThickness = dThickness * saturate(vVertexColor.{STD_THICKNESS_VERTEX_CHANNEL});
	#endif
}
`});var QK,JK=m(()=>{QK=`
#if (TONEMAP == NONE)
	#include "tonemappingNonePS"
#elif TONEMAP == FILMIC
	#include "tonemappingFilmicPS"
#elif TONEMAP == LINEAR
	#include "tonemappingLinearPS"
#elif TONEMAP == HEJL
	#include "tonemappingHejlPS"
#elif TONEMAP == ACES
	#include "tonemappingAcesPS"
#elif TONEMAP == ACES2
	#include "tonemappingAces2PS"
#elif TONEMAP == NEUTRAL
	#include "tonemappingNeutralPS"
#endif
`});var eq,tq=m(()=>{eq=`
uniform exposure: f32;
fn toneMap(color: vec3f) -> vec3f {
	let tA: f32 = 2.51;
	let tB: f32 = 0.03;
	let tC: f32 = 2.43;
	let tD: f32 = 0.59;
	let tE: f32 = 0.14;
	let x: vec3f = color * uniform.exposure;
	return (x * (tA * x + tB)) / (x * (tC * x + tD) + tE);
}
`});var sq,iq=m(()=>{sq=`
uniform exposure: f32;
const ACESInputMat: mat3x3f = mat3x3f(
	vec3f(0.59719, 0.35458, 0.04823),
	vec3f(0.07600, 0.90834, 0.01566),
	vec3f(0.02840, 0.13383, 0.83777)
);
const ACESOutputMat: mat3x3f = mat3x3f(
	vec3f( 1.60475, -0.53108, -0.07367),
	vec3f(-0.10208,  1.10813, -0.00605),
	vec3f(-0.00327, -0.07276,  1.07602)
);
fn RRTAndODTFit(v: vec3f) -> vec3f {
	let a: vec3f = v * (v + vec3f(0.0245786)) - vec3f(0.000090537);
	let b: vec3f = v * (vec3f(0.983729) * v + vec3f(0.4329510)) + vec3f(0.238081);
	return a / b;
}
fn toneMap(color: vec3f) -> vec3f {
	var c: vec3f = color * (uniform.exposure / 0.6);
	c = c * ACESInputMat;
	c = RRTAndODTFit(c);
	c = c * ACESOutputMat;
	return clamp(c, vec3f(0.0), vec3f(1.0));
}
`});var rq,aq=m(()=>{rq=`
const A: f32 = 0.15;
const B: f32 = 0.50;
const C: f32 = 0.10;
const D: f32 = 0.20;
const E: f32 = 0.02;
const F: f32 = 0.30;
const W: f32 = 11.2;
uniform exposure: f32;
fn uncharted2Tonemap(x: vec3f) -> vec3f {
	return ((x * (A * x + C * B) + D * E) / (x * (A * x + B) + D * F)) - vec3f(E / F);
}
fn toneMap(color: vec3f) -> vec3f {
	var c: vec3f = uncharted2Tonemap(color * uniform.exposure);
	let whiteScale: vec3f = vec3f(1.0) / uncharted2Tonemap(vec3f(W, W, W));
	c *= whiteScale;
	return c;
}
`});var nq,oq=m(()=>{nq=`
uniform exposure: f32;
fn toneMap(color: vec3f) -> vec3f {
	let A: f32 = 0.22;
	let B: f32 = 0.3;
	let C: f32 = 0.1;
	let D: f32 = 0.2;
	let E: f32 = 0.01;
	let F: f32 = 0.3;
	let Scl: f32 = 1.25;
	let adjusted_color = color * uniform.exposure;
	let h = max(vec3f(0.0), adjusted_color - vec3f(0.004));
	return (h * ((Scl * A) * h + Scl * vec3f(C * B)) + Scl * vec3f(D * E)) /
		   (h * (A * h + vec3f(B)) + vec3f(D * F)) -
		   Scl * vec3f(E / F);
}
`});var lq,hq=m(()=>{lq=`
uniform exposure: f32;
fn toneMap(color: vec3f) -> vec3f {
	return color * uniform.exposure;
}
`});var cq,fq=m(()=>{cq=`
uniform exposure: f32;
fn toneMap(col: vec3f) -> vec3f {
	var color = col * uniform.exposure;
	let startCompression = 0.8 - 0.04;
	let desaturation = 0.15;
	let x = min(color.r, min(color.g, color.b));
	let offset = select(0.04, x - 6.25 * x * x, x < 0.08);
	color -= vec3f(offset);
	let peak = max(color.r, max(color.g, color.b));
	if (peak < startCompression) {
		return color;
	}
	let d = 1.0 - startCompression;
	let newPeak = 1.0 - d * d / (peak + d - startCompression);
	color *= newPeak / peak;
	let g = 1.0 - 1.0 / (desaturation * (peak - newPeak) + 1.0);
	return mix(color, vec3f(newPeak), vec3f(g));
}
`});var dq,uq=m(()=>{dq=`
fn toneMap(color: vec3f) -> vec3f {
	return color;
}
`});var mq,pq=m(()=>{mq=`
#ifdef PIXELSNAP
	uniform uScreenSize: vec4f;
#endif
#ifdef SCREENSPACE
	uniform projectionFlipY: f32;
#endif
fn evalWorldPosition(vertexPosition: vec3f, modelMatrix: mat4x4f) -> vec4f {
	var localPos: vec3f = getLocalPosition(vertexPosition);
	#ifdef NINESLICED
		var localPosXZ: vec2f = localPos.xz;
		localPosXZ = localPosXZ * uniform.outerScale;
		let positiveUnitOffset: vec2f = clamp(vertexPosition.xz, vec2f(0.0), vec2f(1.0));
		let negativeUnitOffset: vec2f = clamp(-vertexPosition.xz, vec2f(0.0), vec2f(1.0));
		localPosXZ = localPosXZ + (-positiveUnitOffset * uniform.innerOffset.xy + negativeUnitOffset * uniform.innerOffset.zw) * vertex_texCoord0.xy;
		dTiledUvGlobal = (localPosXZ - uniform.outerScale + uniform.innerOffset.xy) * -0.5 + 1.0;
		localPosXZ = localPosXZ * -0.5;
		localPos = vec3f(localPosXZ.x, localPosXZ.y, localPos.y);
	#endif
	var posW: vec4f = modelMatrix * vec4f(localPos, 1.0);
	#ifdef SCREENSPACE
		posW = vec4f(posW.xy, 0.0, 1.0);
	#endif
	return posW;
}
fn getPosition() -> vec4f {
	dModelMatrix = getModelMatrix();
	let posW: vec4f = evalWorldPosition(vertex_position.xyz, dModelMatrix);
	dPositionW = posW.xyz;
	var screenPos: vec4f;
	#ifdef UV1LAYOUT
		screenPos = vec4f(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1.0);
		screenPos.y *= -1.0;
	#else
		#ifdef SCREENSPACE
			screenPos = posW;
			screenPos.y *= uniform.projectionFlipY;
		#else
			screenPos = uniform.matrix_viewProjection * posW;
		#endif
		#ifdef PIXELSNAP
			screenPos.xy = (screenPos.xy * 0.5) + 0.5;
			screenPos.xy *= uniforms.uScreenSize.xy;
			screenPos.xy = floor(screenPos.xy);
			screenPos.xy *= uniforms.uScreenSize.zw;
			screenPos.xy = (screenPos.xy * 2.0) - 1.0;
		#endif
	#endif
	return screenPos;
}
fn getWorldPosition() -> vec3f {
	return dPositionW;
}
`});var _q,gq=m(()=>{_q=`
	attribute vertex_position: vec4f;
	uniform matrix_viewProjection: mat4x4f;
	uniform matrix_model: mat4x4f;
	
	#ifdef MORPHING
		uniform morph_tex_params: vec2f;
		attribute morph_vertex_id: u32;
		fn getTextureMorphCoords() -> vec2i {
			var textureSize: vec2i = vec2i(uniform.morph_tex_params);
			var morphGridV: i32 = i32(morph_vertex_id) / textureSize.x;
			var morphGridU: i32 = i32(morph_vertex_id) - (morphGridV * textureSize.x);
			morphGridV = textureSize.y - morphGridV - 1;
			return vec2i(morphGridU, morphGridV);
		}
		#ifdef MORPHING_POSITION
			#ifdef MORPHING_INT
				uniform aabbSize: vec3f;
				uniform aabbMin: vec3f;
				var morphPositionTex: texture_2d<u32>;
			#else
				var morphPositionTex: texture_2d<f32>;
			#endif
		#endif
	#endif
	#ifdef defined(BATCH)
		#include "skinBatchVS"
		fn getModelMatrix() -> mat4x4f {
			return getBoneMatrix(vertex_boneIndices);
		}
	#elif defined(SKIN)
		#include "skinVS"
		fn getModelMatrix() -> mat4x4f {
			return uniform.matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);
		}
	#elif defined(INSTANCING)
		#include "transformInstancingVS"
	#else
		fn getModelMatrix() -> mat4x4f {
			return uniform.matrix_model;
		}
	#endif
	fn getLocalPosition(vertexPosition: vec3f) -> vec3f {
		var localPos: vec3f = vertexPosition;
		#ifdef MORPHING_POSITION
			var morphUV: vec2i = getTextureMorphCoords();
			#ifdef MORPHING_INT
				var morphPos: vec3f = vec3f(textureLoad(morphPositionTex, morphUV, 0).xyz) / 65535.0 * uniform.aabbSize + uniform.aabbMin;
			#else
				var morphPos: vec3f = textureLoad(morphPositionTex, morphUV, 0).xyz;
			#endif
			localPos += morphPos;
		#endif
		return localPos;
	}
`});var Sq,Tq=m(()=>{Sq=`
attribute instance_line1: vec4f;
attribute instance_line2: vec4f;
attribute instance_line3: vec4f;
attribute instance_line4: vec4f;
fn getModelMatrix() -> mat4x4f {
	return uniform.matrix_model * mat4x4f(instance_line1, instance_line2, instance_line3, instance_line4);
}
`});var Eq,vq=m(()=>{Eq=`
#ifdef STD_REFRACTION_CONSTANT
	uniform material_refraction: f32;
#endif
fn getRefraction() {
	var refraction: f32 = 1.0;
	#ifdef STD_REFRACTION_CONSTANT
	refraction = uniform.material_refraction;
	#endif
	#ifdef STD_REFRACTION_TEXTURE
	refraction = refraction * textureSampleBias({STD_REFRACTION_TEXTURE_NAME}, {STD_REFRACTION_TEXTURE_NAME}Sampler, {STD_REFRACTION_TEXTURE_UV}, uniform.textureBias).{STD_REFRACTION_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_REFRACTION_VERTEX
	refraction = refraction * saturate(vVertexColor.{STD_REFRACTION_VERTEX_CHANNEL});
	#endif
	dTransmission = refraction;
}
`});var xq,yq=m(()=>{xq=`
uniform twoSidedLightingNegScaleFactor: f32;
fn handleTwoSidedLighting() {
	dTBN[2] = dTBN[2] * select(-uniform.twoSidedLightingNegScaleFactor, uniform.twoSidedLightingNegScaleFactor, pcFrontFacing);
}
`});var Aq,Pq=m(()=>{Aq=`
#ifdef NINESLICED
	fn getUv0() -> vec2f {
		var uv = vertex_position.xz;
		let positiveUnitOffset = clamp(vertex_position.xz, vec2f(0.0, 0.0), vec2f(1.0, 1.0));
		let negativeUnitOffset = clamp(-vertex_position.xz, vec2f(0.0, 0.0), vec2f(1.0, 1.0));
		uv = uv + ((-positiveUnitOffset * uniform.innerOffset.xy) + (negativeUnitOffset * uniform.innerOffset.zw)) * vertex_texCoord0.xy;
		uv = uv * -0.5 + vec2f(0.5, 0.5);
		uv = uv * uniform.atlasRect.zw + uniform.atlasRect.xy;
		dMaskGlobal = vertex_texCoord0.xy;
		return uv;
	}
#else
	fn getUv0() -> vec2f {
		return vertex_texCoord0;
	}
#endif
`});var Rq,Cq=m(()=>{Rq=`
fn getUv1() -> vec2f {
	return vertex_texCoord1;
}
`});var Iq,wq=m(()=>{Iq=`
output.vUV{TRANSFORM_UV_{i}}_{TRANSFORM_ID_{i}} = vec2f(
	dot(vec3f(uv{TRANSFORM_UV_{i}}, 1), uniform.{TRANSFORM_NAME_{i}}0),
	dot(vec3f(uv{TRANSFORM_UV_{i}}, 1), uniform.{TRANSFORM_NAME_{i}}1)
);
`});var Lq,bq=m(()=>{Lq=`
	uniform {TRANSFORM_NAME_{i}}0: vec3f;
	uniform {TRANSFORM_NAME_{i}}1: vec3f;
`});var Mq,Dq=m(()=>{Mq=`
fn getViewDir() {
	dViewDirW = normalize(uniform.view_position - vPositionW);
}
`});var Oq,Nq=m(()=>{DX();NX();UX();VX();GX();HX();WX();KX();jX();ZX();JX();tW();iW();aW();oW();hW();fW();uW();pW();gW();TW();vW();yW();PW();CW();wW();bW();DW();NW();UW();VW();GW();HW();WW();KW();jW();ZW();JW();tY();iY();aY();oY();hY();fY();uY();pY();gY();TY();vY();yY();PY();CY();wY();bY();DY();NY();UY();VY();GY();HY();WY();KY();jY();ZY();JY();t8();i8();a8();o8();h8();f8();u8();p8();g8();T8();v8();y8();P8();C8();w8();b8();D8();N8();U8();V8();G8();H8();W8();K8();j8();Z8();J8();t6();i6();a6();o6();h6();f6();u6();p6();g6();T6();v6();y6();P6();C6();w6();b6();D6();N6();U6();V6();G6();H6();W6();K6();j6();Z6();J6();tK();iK();aK();oK();hK();fK();uK();pK();gK();TK();vK();yK();PK();CK();wK();bK();DK();NK();UK();VK();GK();HK();WK();KK();jK();ZK();JK();tq();iq();aq();oq();hq();fq();uq();pq();gq();Tq();vq();yq();Pq();Cq();wq();bq();Dq();tw();sw();Oq={alphaTestPS:MX,ambientPS:OX,anisotropyPS:FX,aoPS:BX,aoDiffuseOccPS:kX,aoSpecOccPS:zX,bakeDirLmEndPS:XX,bakeLmEndPS:YX,basePS:qX,baseNineSlicedPS:$X,baseNineSlicedTiledPS:QX,bayerPS:eW,blurVSMPS:sW,clearCoatPS:rW,clearCoatGlossPS:nW,clearCoatNormalPS:lW,clusteredLightCookiesPS:dW,clusteredLightShadowsPS:mW,clusteredLightUtilsPS:cW,clusteredLightPS:_W,combinePS:SW,cookieBlit2DPS:EW,cookieBlitCubePS:xW,cookieBlitVS:AW,cubeMapProjectPS:RW,cubeMapRotatePS:IW,debugOutputPS:LW,debugProcessFrontendPS:MW,detailModesPS:FW,diffusePS:BW,decodePS:OW,emissivePS:kW,encodePS:zW,endPS:XW,envAtlasPS:YW,envProcPS:qW,falloffInvSquaredPS:$W,falloffLinearPS:QW,floatAsUintPS:eY,fogPS:sY,fresnelSchlickPS:rY,frontendCodePS:"",frontendDeclPS:"",fullscreenQuadVS:nY,gammaPS:lY,glossPS:cY,gsplatCenterVS:dY,gsplatCornerVS:MY,gsplatColorVS:mY,gsplatCommonVS:_Y,gsplatCompressedDataVS:SY,gsplatCompressedSHVS:EY,gsplatEvalSHVS:xY,gsplatQuatToMat3VS:AY,gsplatSogsColorVS:RY,gsplatSogsDataVS:IY,gsplatSogsSHVS:LY,gsplatDataVS:OY,gsplatOutputVS:FY,gsplatPS:BY,gsplatSHVS:kY,gsplatSourceVS:zY,gsplatVS:XY,quadVS:YY,indirectCoreCS:qY,immediateLinePS:$Y,immediateLineVS:QY,iridescenceDiffractionPS:e8,iridescencePS:s8,iridescenceThicknessPS:r8,iorPS:n8,lightDeclarationPS:l8,lightDiffuseLambertPS:c8,lightDirPointPS:d8,lightEvaluationPS:m8,lightFunctionLightPS:_8,lightFunctionShadowPS:S8,lightingPS:E8,lightmapAddPS:x8,lightmapPS:A8,lightSpecularAnisoGGXPS:R8,lightSpecularBlinnPS:I8,lightSheenPS:L8,linearizeDepthPS:M8,litForwardBackendPS:O8,litForwardDeclarationPS:F8,litForwardMainPS:B8,litForwardPostCodePS:k8,litForwardPreCodePS:z8,litMainPS:X8,litMainVS:Y8,litOtherMainPS:q8,litShaderArgsPS:$8,litShaderCorePS:Q8,litShadowMainPS:e6,litUserDeclarationPS:"",litUserDeclarationVS:"",litUserCodePS:"",litUserCodeVS:"",litUserMainStartPS:"",litUserMainStartVS:"",litUserMainEndPS:"",litUserMainEndVS:"",ltcPS:s6,metalnessPS:r6,metalnessModulatePS:l6,morphPS:c6,morphVS:d6,msdfPS:n6,msdfVS:m6,normalVS:_6,normalCoreVS:S6,normalMapPS:E6,opacityPS:x6,opacityDitherPS:A6,outputPS:R6,outputAlphaPS:I6,outputTex2DPS:L6,sheenPS:M6,sheenGlossPS:O6,parallaxPS:F6,pickPS:B6,reflDirPS:k6,reflDirAnisoPS:z6,reflectionCCPS:X6,reflectionCubePS:Y6,reflectionEnvHQPS:q6,reflectionEnvPS:$6,reflectionSpherePS:Q6,reflectionSheenPS:eK,refractionCubePS:sK,refractionDynamicPS:rK,reprojectPS:nK,reprojectVS:lK,screenDepthPS:cK,shadowCascadesPS:dK,shadowEVSMPS:mK,shadowPCF1PS:_K,shadowPCF3PS:SK,shadowPCF5PS:EK,shadowSoftPS:xK,skinBatchVS:AK,skinVS:RK,skyboxPS:IK,skyboxVS:LK,specularPS:MK,sphericalPS:OK,specularityFactorPS:FK,spotPS:BK,startNineSlicedPS:kK,startNineSlicedTiledPS:zK,stdDeclarationPS:XK,stdFrontEndPS:YK,TBNPS:qK,thicknessPS:$K,tonemappingPS:QK,tonemappingAcesPS:eq,tonemappingAces2PS:sq,tonemappingFilmicPS:rq,tonemappingHejlPS:nq,tonemappingLinearPS:lq,tonemappingNeutralPS:cq,tonemappingNonePS:dq,transformVS:mq,transformCoreVS:_q,transformInstancingVS:Sq,transmissionPS:Eq,twoSidedLightingPS:xq,uv0VS:Aq,uv1VS:Rq,uvTransformVS:Iq,uvTransformUniformsPS:Lq,viewDirPS:Mq,webgpuPS:mx,webgpuVS:px}});var u0,js,jne,mT=m(()=>{bt();ql();Fs();Pe();De();Ke();me();Ve();Q();j();Ct();J();Uh();Tb();oA();QV();ek();Ym();cA();OA();$h();ln();Vh();Cb();rt();l0();Mb();Db();Nb();c0();dT();Fb();ci();Bb();s0();Pk();hc();bX();Nq();It();u0=null,js=class o extends K{constructor(e){super(),this._batcher=null,this._destroyRequested=!1,this._inFrameUpdate=!1,this._librariesLoaded=!1,this._fillMode=cT,this._resolutionMode=e0,this._allowResize=!0,this._skyboxAsset=null,this._entityIndex={},this._inTools=!1,this._scriptPrefix="",this._time=0,this.enableBundles=typeof TextDecoder<"u",this.timeScale=1,this.maxDeltaTime=.1,this.frame=0,this.frameGraph=new i0,this.scriptsOrder=[],this.autoRender=!0,this.renderNextFrame=!1,this.lightmapper=null,this.loader=new dc(this),this.scenes=new Lp(this),this.scripts=new wp(this),this.systems=new Rp,this.i18n=new ba(this),this.keyboard=null,this.mouse=null,this.touch=null,this.gamepads=null,this.elementInput=null,this.xr=null,o._applications[e.id]=this,t0(this),u0=this,this.root=new be,this.root._enabledInHierarchy=!0}init(e){let{assetPrefix:t,batchManager:s,componentSystems:i,elementInput:r,gamepads:a,graphicsDevice:n,keyboard:l,lightmapper:h,mouse:c,resourceHandlers:f,scriptsOrder:d,scriptPrefix:u,soundManager:p,touch:_,xr:S}=e;this.graphicsDevice=n,ie.get(n,oe).add(LX),ie.get(n,le).add(Oq),this._initDefaultMaterial(),this._initProgramLibrary(),this.stats=new d0(n),this._soundManager=p,this.scene=new qs(n),this._registerSceneImmediate(this.scene),this.assets=new fc(this.loader),t&&(this.assets.prefix=t),this.bundles=new Pp(this.assets),this.scriptsOrder=d||[],this.defaultLayerWorld=new At({name:"World",id:ms}),this.defaultLayerDepth=new At({name:"Depth",id:Xt,enabled:!1,opaqueSortMode:tn}),this.defaultLayerSkybox=new At({name:"Skybox",id:to,opaqueSortMode:tn}),this.defaultLayerUi=new At({name:"UI",id:pa,transparentSortMode:Ey}),this.defaultLayerImmediate=new At({name:"Immediate",id:so,opaqueSortMode:tn});let T=new nl("default");T.pushOpaque(this.defaultLayerWorld),T.pushOpaque(this.defaultLayerDepth),T.pushOpaque(this.defaultLayerSkybox),T.pushTransparent(this.defaultLayerWorld),T.pushOpaque(this.defaultLayerImmediate),T.pushTransparent(this.defaultLayerImmediate),T.pushTransparent(this.defaultLayerUi),this.scene.layers=T,fT.createPlaceholder(n),this.renderer=new Wh(n),this.renderer.scene=this.scene,h&&(this.lightmapper=new h(n,this.root,this.scene,this.renderer,this.assets),this.once("prerender",this._firstBake,this)),s&&(this._batcher=new s(n,this.root,this.scene),this.once("prerender",this._firstBatch,this)),this.keyboard=l||null,this.mouse=c||null,this.touch=_||null,this.gamepads=a||null,r&&(this.elementInput=r,this.elementInput.app=this),this.xr=S?new S(this):null,this.elementInput&&this.elementInput.attachSelectEvents(),this._scriptPrefix=u||"",this.enableBundles&&this.loader.addHandler("bundle",new Ip(this)),f.forEach(x=>{let A=new x(this);this.loader.addHandler(A.handlerType,A)}),i.forEach(x=>{this.systems.add(new x(this))}),this._visibilityChangeHandler=this.onVisibilityChange.bind(this),typeof document<"u"&&(document.hidden!==void 0?(this._hiddenAttr="hidden",document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1)):document.mozHidden!==void 0?(this._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1)):document.msHidden!==void 0?(this._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",this._visibilityChangeHandler,!1)):document.webkitHidden!==void 0&&(this._hiddenAttr="webkitHidden",document.addEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1))),this.tick=jne(this)}static{this._applications={}}static getApplication(e){return e?o._applications[e]:Ss()}_initDefaultMaterial(){let e=new ct;e.name="Default Material",oB(this.graphicsDevice,e)}_initProgramLibrary(){let e=new mp(this.graphicsDevice,new ct);eB(this.graphicsDevice,e)}get soundManager(){return this._soundManager}get batcher(){return this._batcher}get fillMode(){return this._fillMode}get resolutionMode(){return this._resolutionMode}configure(e,t){Le.get(e,(s,i)=>{if(s){t(s);return}let r=i.application_properties,a=i.scenes,n=i.assets;this._parseApplicationProperties(r,l=>{this._parseScenes(a),this._parseAssets(n),t(l||null)})})}preload(e){this.fire("preload:start");let t=this.assets.list({preload:!0});if(t.length===0){this.fire("preload:end"),e();return}let s=0,i=()=>{s++,this.fire("preload:progress",s/t.length),s===t.length&&(this.fire("preload:end"),e())};t.forEach(r=>{r.loaded?i():(r.once("load",i),r.once("error",i),this.assets.load(r))})}_preloadScripts(e,t){t()}_parseApplicationProperties(e,t){if(typeof e.maxAssetRetries=="number"&&e.maxAssetRetries>0&&this.loader.enableRetry(e.maxAssetRetries),e.useDevicePixelRatio||(e.useDevicePixelRatio=e.use_device_pixel_ratio),e.resolutionMode||(e.resolutionMode=e.resolution_mode),e.fillMode||(e.fillMode=e.fill_mode),this._width=e.width,this._height=e.height,e.useDevicePixelRatio&&(this.graphicsDevice.maxPixelRatio=window.devicePixelRatio),this.setCanvasResolution(e.resolutionMode,this._width,this._height),this.setCanvasFillMode(e.fillMode,this._width,this._height),e.layers&&e.layerOrder){let s=new nl("application"),i={};for(let r in e.layers){let a=e.layers[r];a.id=parseInt(r,10),a.enabled=a.id!==Xt,i[r]=new At(a)}for(let r=0,a=e.layerOrder.length;r<a;r++){let n=e.layerOrder[r],l=i[n.layer];l&&(n.transparent?s.pushTransparent(l):s.pushOpaque(l),s.subLayerEnabled[r]=n.enabled)}this.scene.layers=s}if(e.batchGroups){let s=this.batcher;if(s)for(let i=0,r=e.batchGroups.length;i<r;i++){let a=e.batchGroups[i];s.addGroup(a.name,a.dynamic,a.maxAabbSize,a.id,a.layers)}}e.i18nAssets&&(this.i18n.assets=e.i18nAssets),this._loadLibraries(e.libraries,t)}_loadLibraries(e,t){let s=e.length,i=s,r=/^https?:\/\//;if(s){let a=(n,l)=>{i--,n?t(n):i===0&&(this.onLibrariesLoaded(),t(null))};for(let n=0;n<s;++n){let l=e[n];!r.test(l.toLowerCase())&&this._scriptPrefix&&(l=ve.join(this._scriptPrefix,l)),this.loader.load(l,"script",a)}}else this.onLibrariesLoaded(),t(null)}_parseScenes(e){if(e)for(let t=0;t<e.length;t++)this.scenes.add(e[t].name,e[t].url)}_parseAssets(e){let t=[],s={},i={};for(let r=0;r<this.scriptsOrder.length;r++){let a=this.scriptsOrder[r];e[a]&&(s[a]=!0,t.push(e[a]))}if(this.enableBundles)for(let r in e)e[r].type==="bundle"&&(i[r]=!0,t.push(e[r]));for(let r in e)s[r]||i[r]||t.push(e[r]);for(let r=0;r<t.length;r++){let a=t[r],n=new re(a.name,a.type,a.file,a.data);if(n.id=parseInt(a.id,10),n.preload=a.preload?a.preload:!1,n.loaded=a.type==="script"&&a.data&&a.data.loadingType>0,n.tags.add(a.tags),a.i18n)for(let l in a.i18n)n.addLocalizedAssetId(l,a.i18n[l]);this.assets.add(n)}}start(){this.frame=0,this.fire("start",{timestamp:Us(),target:this}),this._librariesLoaded||this.onLibrariesLoaded(),this.systems.fire("initialize",this.root),this.fire("initialize"),this.systems.fire("postInitialize",this.root),this.systems.fire("postPostInitialize",this.root),this.fire("postinitialize"),this.tick()}inputUpdate(e){this.controller&&this.controller.update(e),this.mouse&&this.mouse.update(),this.keyboard&&this.keyboard.update(),this.gamepads&&this.gamepads.update()}update(e){this.frame++,this.graphicsDevice.update(),this.systems.fire(this._inTools?"toolsUpdate":"update",e),this.systems.fire("animationUpdate",e),this.systems.fire("postUpdate",e),this.fire("update",e),this.inputUpdate(e)}render(){this.updateCanvasSize(),this.graphicsDevice.frameStart(),this.fire("prerender"),this.root.syncHierarchy(),this._batcher&&this._batcher.updateAll(),this.renderComposition(this.scene.layers),this.fire("postrender"),this.graphicsDevice.frameEnd()}renderComposition(e){this.renderer.update(e),this.renderer.buildFrameGraph(this.frameGraph,e),this.frameGraph.render(this.graphicsDevice)}_fillFrameStatsBasic(e,t,s){let i=this.stats.frame;i.dt=t,i.ms=s,e>i._timeToCountFrames?(i.fps=i._fpsAccum,i._fpsAccum=0,i._timeToCountFrames=e+1e3):i._fpsAccum++,this.stats.drawCalls.total=this.graphicsDevice._drawCallsPerFrame,this.graphicsDevice._drawCallsPerFrame=0}_fillFrameStats(){let e=this.stats.frame;e.cameras=this.renderer._camerasRendered,e.materials=this.renderer._materialSwitches,e.shaders=this.graphicsDevice._shaderSwitchesPerFrame,e.shadowMapUpdates=this.renderer._shadowMapUpdates,e.shadowMapTime=this.renderer._shadowMapTime,e.depthMapTime=this.renderer._depthMapTime,e.forwardTime=this.renderer._forwardTime;let t=this.graphicsDevice._primsPerFrame;e.triangles=t[As]/3+Math.max(t[rs]-2,0)+Math.max(t[Wi]-2,0),e.cullTime=this.renderer._cullTime,e.sortTime=this.renderer._sortTime,e.skinTime=this.renderer._skinTime,e.morphTime=this.renderer._morphTime,e.lightClusters=this.renderer._lightClusters,e.lightClustersTime=this.renderer._lightClustersTime,e.otherPrimitives=0;for(let s=0;s<t.length;s++)s<As&&(e.otherPrimitives+=t[s]),t[s]=0;this.renderer._camerasRendered=0,this.renderer._materialSwitches=0,this.renderer._shadowMapUpdates=0,this.graphicsDevice._shaderSwitchesPerFrame=0,this.renderer._cullTime=0,this.renderer._layerCompositionUpdateTime=0,this.renderer._lightClustersTime=0,this.renderer._sortTime=0,this.renderer._skinTime=0,this.renderer._morphTime=0,this.renderer._shadowMapTime=0,this.renderer._depthMapTime=0,this.renderer._forwardTime=0,e=this.stats.drawCalls,e.forward=this.renderer._forwardDrawCalls,e.culled=this.renderer._numDrawCallsCulled,e.depth=0,e.shadow=this.renderer._shadowDrawCalls,e.skinned=this.renderer._skinDrawCalls,e.immediate=0,e.instanced=0,e.removedByInstancing=0,e.misc=e.total-(e.forward+e.shadow),this.renderer._depthDrawCalls=0,this.renderer._shadowDrawCalls=0,this.renderer._forwardDrawCalls=0,this.renderer._numDrawCallsCulled=0,this.renderer._skinDrawCalls=0,this.renderer._immediateRendered=0,this.renderer._instancedDrawCalls=0,this.stats.misc.renderTargetCreationTime=this.graphicsDevice.renderTargetCreationTime,e=this.stats.particles,e.updatesPerFrame=e._updatesPerFrame,e.frameTime=e._frameTime,e._updatesPerFrame=0,e._frameTime=0}setCanvasFillMode(e,t,s){this._fillMode=e,this.resizeCanvas(t,s)}setCanvasResolution(e,t,s){this._resolutionMode=e,e===ad&&t===void 0&&(t=this.graphicsDevice.canvas.clientWidth,s=this.graphicsDevice.canvas.clientHeight),this.graphicsDevice.resizeCanvas(t,s)}isHidden(){return document[this._hiddenAttr]}onVisibilityChange(){this.isHidden()?this._soundManager&&this._soundManager.suspend():this._soundManager&&this._soundManager.resume()}resizeCanvas(e,t){if(!this._allowResize||this.xr&&this.xr.session)return;let s=window.innerWidth,i=window.innerHeight;if(this._fillMode===cT){let r=this.graphicsDevice.canvas.width/this.graphicsDevice.canvas.height,a=s/i;r>a?(e=s,t=e/r):(t=i,e=t*r)}else this._fillMode===JA&&(e=s,t=i);return this.graphicsDevice.canvas.style.width=`${e}px`,this.graphicsDevice.canvas.style.height=`${t}px`,this.updateCanvasSize(),{width:e,height:t}}updateCanvasSize(){if(!(!this._allowResize||this.xr?.active)&&this._resolutionMode===ad){let e=this.graphicsDevice.canvas;this.graphicsDevice.resizeCanvas(e.clientWidth,e.clientHeight)}}onLibrariesLoaded(){this._librariesLoaded=!0,this.systems.rigidbody&&this.systems.rigidbody.onLibraryLoaded()}applySceneSettings(e){let t;if(this.systems.rigidbody&&typeof Ammo<"u"){let[s,i,r]=e.physics.gravity;this.systems.rigidbody.gravity.set(s,i,r)}this.scene.applySettings(e),e.render.hasOwnProperty("skybox")&&(e.render.skybox?(t=this.assets.get(e.render.skybox),t?this.setSkybox(t):this.assets.once(`add:${e.render.skybox}`,this.setSkybox,this)):this.setSkybox(null))}setAreaLightLuts(e,t){e&&t&&fT.set(this.graphicsDevice,e,t)}setSkybox(e){if(e!==this._skyboxAsset){let t=()=>{this.setSkybox(null)},s=()=>{this.scene.setSkybox(this._skyboxAsset?this._skyboxAsset.resources:null)};this._skyboxAsset&&(this.assets.off(`load:${this._skyboxAsset.id}`,s,this),this.assets.off(`remove:${this._skyboxAsset.id}`,t,this),this._skyboxAsset.off("change",s,this)),this._skyboxAsset=e,this._skyboxAsset&&(this.assets.on(`load:${this._skyboxAsset.id}`,s,this),this.assets.once(`remove:${this._skyboxAsset.id}`,t,this),this._skyboxAsset.on("change",s,this),this.scene.skyboxMip===0&&!this._skyboxAsset.loadFaces&&(this._skyboxAsset.loadFaces=!0),this.assets.load(this._skyboxAsset)),s()}}_firstBake(){this.lightmapper?.bake(null,this.scene.lightmapMode)}_firstBatch(){this.batcher?.generate()}_processTimestamp(e){return e}drawLine(e,t,s,i,r){this.scene.drawLine(e,t,s,i,r)}drawLines(e,t,s=!0,i=this.scene.defaultDrawLayer){this.scene.drawLines(e,t,s,i)}drawLineArrays(e,t,s=!0,i=this.scene.defaultDrawLayer){this.scene.drawLineArrays(e,t,s,i)}drawWireSphere(e,t,s=N.WHITE,i=20,r=!0,a=this.scene.defaultDrawLayer){this.scene.immediate.drawWireSphere(e,t,s,i,r,a)}drawWireAlignedBox(e,t,s=N.WHITE,i=!0,r=this.scene.defaultDrawLayer,a){this.scene.immediate.drawWireAlignedBox(e,t,s,i,r,a)}drawMeshInstance(e,t=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(null,null,null,e,t)}drawMesh(e,t,s,i=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(t,s,e,null,i)}drawQuad(e,t,s=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(t,e,this.scene.immediate.getQuadMesh(),null,s)}drawTexture(e,t,s,i,r,a,n=this.scene.defaultDrawLayer,l=!0){if(l===!1&&!this.graphicsDevice.isWebGPU)return;let h=new k;h.setTRS(new g(e,t,0),H.IDENTITY,new g(s,-i,0)),a||(a=new oi,a.cull=0,a.setParameter("colorMap",r),a.shaderDesc=l?this.scene.immediate.getTextureShaderDesc(r.encoding):this.scene.immediate.getUnfilterableTextureShaderDesc(),a.update()),this.drawQuad(h,a,n)}drawDepthTexture(e,t,s,i,r=this.scene.defaultDrawLayer){let a=new oi;a.cull=0,a.shaderDesc=this.scene.immediate.getDepthTextureShaderDesc(),a.update(),this.drawTexture(e,t,s,i,null,a,r)}destroy(){if(this._inFrameUpdate){this._destroyRequested=!0;return}let e=this.graphicsDevice.canvas.id;this.fire("destroy",this),this.off("librariesloaded"),typeof document<"u"&&(document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("msvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1)),this._visibilityChangeHandler=null,this.root.destroy(),this.root=null,this.mouse&&(this.mouse.off(),this.mouse.detach(),this.mouse=null),this.keyboard&&(this.keyboard.off(),this.keyboard.detach(),this.keyboard=null),this.touch&&(this.touch.off(),this.touch.detach(),this.touch=null),this.elementInput&&(this.elementInput.detach(),this.elementInput=null),this.gamepads&&(this.gamepads.destroy(),this.gamepads=null),this.controller&&(this.controller=null),this.systems.destroy(),this.scene.layers&&this.scene.layers.destroy();let t=this.assets.list();for(let i=0;i<t.length;i++)t[i].unload(),t[i].off();this.assets.off(),this.bundles.destroy(),this.bundles=null,this.i18n.destroy(),this.i18n=null,this.loader.getHandler("script")?.clearCache(),this.loader.destroy(),this.loader=null,this.scene.destroy(),this.scene=null,this.systems=null,this.context=null,this.scripts.destroy(),this.scripts=null,this.scenes.destroy(),this.scenes=null,this.lightmapper?.destroy(),this.lightmapper=null,this._batcher&&(this._batcher.destroy(),this._batcher=null),this._entityIndex={},this.defaultLayerDepth.onDisable=null,this.defaultLayerDepth.onEnable=null,this.defaultLayerDepth=null,this.defaultLayerWorld=null,this.xr?.end(),this.xr?.destroy(),this.renderer.destroy(),this.renderer=null,this.graphicsDevice.destroy(),this.graphicsDevice=null,this.tick=null,this.off(),this._soundManager?.destroy(),this._soundManager=null,vp.app=null,o._applications[e]=null,Ss()===this&&t0(null),o.cancelTick(this)}static cancelTick(e){e.frameRequestId&&(window.cancelAnimationFrame(e.frameRequestId),e.frameRequestId=void 0)}getEntityFromIndex(e){return this._entityIndex[e]}_registerSceneImmediate(e){this.on("postrender",e.immediate.onPostRender,e.immediate)}},jne=function(o){let e=o;return function(t,s){if(!e.graphicsDevice)return;e.frameRequestId&&(e.xr?.session?.cancelAnimationFrame(e.frameRequestId),cancelAnimationFrame(e.frameRequestId),e.frameRequestId=null),e._inFrameUpdate=!0,t0(e),u0=e;let i=e._processTimestamp(t)||Us(),r=i-(e._time||i),a=r/1e3;if(a=w.clamp(a,0,e.maxDeltaTime),a*=e.timeScale,e._time=i,e.xr?.session?e.frameRequestId=e.xr.session.requestAnimationFrame(e.tick):e.frameRequestId=ue.browser||ue.worker?requestAnimationFrame(e.tick):null,e.graphicsDevice.contextLost)return;e._fillFrameStatsBasic(i,a,r),e.fire("frameupdate",r);let n=!1;s?(n=!e.xr?.update(s),e.graphicsDevice.defaultFramebuffer=s.session.renderState.baseLayer.framebuffer):e.graphicsDevice.defaultFramebuffer=null,n||(e.update(a),e.fire("framerender"),(e.autoRender||e.renderNextFrame)&&(e.render(),e.renderNextFrame=!1),e.fire("frameend")),e._inFrameUpdate=!1,e._destroyRequested&&e.destroy()}}});var uc,Vb=m(()=>{uc=class{constructor(){this.componentSystems=[],this.resourceHandlers=[]}}});var pT,bp,kb=m(()=>{Vt();fu();J();pT=new Hr,bp=class{constructor(e,t,s){this.scene=e,this.light=t,this.store(),t.numCascades=1,this.scene.clusteredLightingEnabled&&!s.shadowsEnabled&&(t.castShadows=!1),t.type!==ge&&(t._node.getWorldTransform(),t.getBoundingSphere(pT),this.lightBounds=new _e,this.lightBounds.center.copy(pT.center),this.lightBounds.halfExtents.set(pT.radius,pT.radius,pT.radius))}store(){this.mask=this.light.mask,this.shadowUpdateMode=this.light.shadowUpdateMode,this.enabled=this.light.enabled,this.intensity=this.light.intensity,this.rotation=this.light._node.getLocalRotation().clone(),this.numCascades=this.light.numCascades,this.castShadows=this.light._castShadows}restore(){let e=this.light;e.mask=this.mask,e.shadowUpdateMode=this.shadowUpdateMode,e.enabled=this.enabled,e.intensity=this.intensity,e._node.setLocalRotation(this.rotation),e.numCascades=this.numCascades,e._castShadows=this.castShadows}startBake(){this.light.enabled=!0,this.light._destroyShadowMap(),this.light.beginFrame()}endBake(e){let t=this.light;t.enabled=!1,t.shadowMap&&(t.shadowMap.cached&&e.add(t,t.shadowMap),t.shadowMap=null)}}});var m0,p0,Fq=m(()=>{Ne();LA();J();kb();m0=new D,p0=class extends bp{constructor(e,t){super(e.scene,t,e.lightingParams)}get numVirtualLights(){return this.light.type===ge?this.light.bakeNumSamples:1}prepareVirtualLight(e,t){let s=this.light;if(s._node.setLocalRotation(this.rotation),e>0){let a=s.bakeArea;Qh.circlePointDeterministic(m0,e,t),m0.mulScalar(a*.5),s._node.rotateLocal(m0.x,0,m0.y)}s._node.getWorldTransform();let i=2.2,r=Math.pow(this.intensity,i);s.intensity=Math.pow(r/t,1/i)}}});var Uq,_T,Bq=m(()=>{Q();LA();De();ci();J();kb();Uq=new g,_T=class extends bp{constructor(e){let t=e.scene,s=new be("AmbientLight");s.addComponent("light",{type:"directional",affectDynamic:!0,affectLightmapped:!1,bake:!0,bakeNumSamples:t.ambientBakeNumSamples,castShadows:!0,normalOffsetBias:.05,shadowBias:.2,shadowDistance:1,shadowResolution:2048,shadowType:Hs,color:N.WHITE,intensity:1,bakeDir:!1}),super(t,s.light.light,e.lightingParams)}get numVirtualLights(){return this.light.bakeNumSamples}prepareVirtualLight(e,t){Qh.spherePointDeterministic(Uq,e,t,0,this.scene.ambientBakeSpherePart),this.light._node.lookAt(Uq.mulScalar(-1)),this.light._node.rotateLocal(90,0,0);let s=2.2,i=2*Math.PI*this.scene.ambientBakeSpherePart,r=Math.pow(i,s);this.light.intensity=Math.pow(r/t,1/s)}}});var od,Vq=m(()=>{od=class{constructor(e,t=null){this.node=e,this.component=e.render||e.model,t=t||this.component.meshInstances,this.store(),this.meshInstances=t,this.bounds=null,this.renderTargets=[]}store(){this.castShadows=this.component.castShadows}restore(){this.component.castShadows=this.castShadows}}});var kq,Gq=m(()=>{kq=`
float normpdf3(in vec3 v, in float sigma) {
	return 0.39894 * exp(-0.5 * dot(v, v) / (sigma * sigma)) / sigma;
}
vec3 decodeRGBM(vec4 rgbm) {
	vec3 color = (8.0 * rgbm.a) * rgbm.rgb;
	return color * color;
}
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
vec4 encodeRGBM(vec3 color) {
	vec4 encoded;
	encoded.rgb = pow(color.rgb, vec3(0.5));
	encoded.rgb *= 1.0 / 8.0;
	encoded.a = saturate( max( max( encoded.r, encoded.g ), max( encoded.b, 1.0 / 255.0 ) ) );
	encoded.a = ceil(encoded.a * 255.0) / 255.0;
	encoded.rgb /= encoded.a;
	return encoded;
}
vec3 decode(vec4 pixel) {
	#if HDR
		return pixel.rgb;
	#else
		return decodeRGBM(pixel);
	#endif
}
bool isUsed(vec4 pixel) {
	#if HDR
		return any(greaterThan(pixel.rgb, vec3(0.0)));
	#else
		return pixel.a > 0.0;
	#endif
}
varying vec2 vUv0;
uniform sampler2D source;
uniform vec2 pixelOffset;
uniform vec2 sigmas;
uniform float bZnorm;
uniform float kernel[{MSIZE}];
void main(void) {
	
	vec4 pixel = texture2DLod(source, vUv0, 0.0);
	if (!isUsed(pixel)) {
		gl_FragColor = pixel;
		return ;
	}
	float sigma = sigmas.x;
	float bSigma = sigmas.y;
	vec3 pixelHdr = decode(pixel);
	vec3 accumulatedHdr = vec3(0.0);
	float accumulatedFactor = 0.000001;
	const int kSize = ({MSIZE} - 1) / 2;
	for (int i = -kSize; i <= kSize; ++i) {
		for (int j = -kSize; j <= kSize; ++j) {
			
			vec2 coord = vUv0 + vec2(float(i), float(j)) * pixelOffset;
			vec4 pix = texture2DLod(source, coord, 0.0);
			if (isUsed(pix)) {
				vec3 hdr = decode(pix);
				float factor = kernel[kSize + j] * kernel[kSize + i];
				factor *= normpdf3(hdr - pixelHdr, bSigma) * bZnorm;
				accumulatedHdr += factor * hdr;
				accumulatedFactor += factor;
			}
		}
	}
	vec3 finalHDR = accumulatedHdr / accumulatedFactor;
	#if HDR
		gl_FragColor = vec4(finalHDR, 1.0);
	#else
		gl_FragColor = encodeRGBM(finalHDR);
	#endif
}
`});var zq,Hq=m(()=>{zq=`
varying vec2 vUv0;
uniform sampler2D source;
uniform vec2 pixelOffset;
bool isUsed(vec4 pixel) {
	#if HDR
		return any(greaterThan(pixel.rgb, vec3(0.0)));
	#else
		return pixel.a > 0.0;
	#endif
}
void main(void) {
	vec4 c = texture2DLod(source, vUv0, 0.0);
	c = isUsed(c) ? c : texture2DLod(source, vUv0 - pixelOffset, 0.0);
	c = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(0, -pixelOffset.y), 0.0);
	c = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(pixelOffset.x, -pixelOffset.y), 0.0);
	c = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(-pixelOffset.x, 0), 0.0);
	c = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(pixelOffset.x, 0), 0.0);
	c = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(-pixelOffset.x, pixelOffset.y), 0.0);
	c = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(0, pixelOffset.y), 0.0);
	c = isUsed(c) ? c : texture2DLod(source, vUv0 + pixelOffset, 0.0);
	gl_FragColor = c;
}
`});var Xq,Wq=m(()=>{Xq=`
fn normpdf3(v: vec3f, sigma: f32) -> f32 {
	return 0.39894 * exp(-0.5 * dot(v, v) / (sigma * sigma)) / sigma;
}
fn decodeRGBM(rgbm: vec4f) -> vec3f {
	let color = (8.0 * rgbm.a) * rgbm.rgb;
	return color * color;
}
fn saturate(x: f32) -> f32 {
	return clamp(x, 0.0, 1.0);
}
fn encodeRGBM(color: vec3f) -> vec4f {
	var encoded: vec4f;
	let rgb_processed = pow(color.rgb, vec3f(0.5)) * (1.0 / 8.0);
	encoded = vec4f(rgb_processed, 0.0);
	let max_g_b = max( encoded.g, max( encoded.b, 1.0 / 255.0 ) );
	let max_rgb = max( encoded.r, max_g_b );
	encoded.a = clamp(max_rgb, 0.0, 1.0);
	encoded.a = ceil(encoded.a * 255.0) / 255.0;
	encoded = vec4f(encoded.rgb / encoded.a, encoded.a);
	return encoded;
}
fn decode(pixel: vec4f) -> vec3f {
	#if HDR
		return pixel.rgb;
	#else
		return decodeRGBM(pixel);
	#endif
}
fn isUsed(pixel: vec4f) -> bool {
	#if HDR
		return any(pixel.rgb > vec3f(0.0));
	#else
		return pixel.a > 0.0;
	#endif
}
varying vUv0: vec2f;
var source: texture_2d<f32>;
var sourceSampler: sampler;
uniform kernel: array<f32, {MSIZE}>;
uniform pixelOffset: vec2f;
uniform sigmas: vec2f;
uniform bZnorm: f32;
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	let pixel = textureSampleLevel(source, sourceSampler, input.vUv0, 0.0);
	if (!isUsed(pixel)) {
		output.color = pixel;
		return output;
	}
	let sigma = uniform.sigmas.x;
	let bSigma = uniform.sigmas.y;
	let pixelHdr = decode(pixel);
	var accumulatedHdr = vec3f(0.0);
	var accumulatedFactor = 0.000001;
	const kSize = ({MSIZE} - 1) / 2;
	for (var i: i32 = -kSize; i <= kSize; i = i + 1) {
		for (var j: i32 = -kSize; j <= kSize; j = j + 1) {
			let coord = input.vUv0 + vec2f(f32(i), f32(j)) * uniform.pixelOffset;
			let pix = textureSampleLevel(source, sourceSampler, coord, 0.0);
			if (isUsed(pix)) {
				let hdr = decode(pix);
				var factor = uniform.kernel[u32(kSize + j)].element * uniform.kernel[u32(kSize + i)].element;
				factor = factor * normpdf3(hdr - pixelHdr, bSigma) * uniform.bZnorm;
				accumulatedHdr = accumulatedHdr + factor * hdr;
				accumulatedFactor = accumulatedFactor + factor;
			}
		}
	}
	let finalHDR = accumulatedHdr / accumulatedFactor;
	#if HDR
		output.color = vec4f(finalHDR, 1.0);
	#else
		output.color = encodeRGBM(finalHDR);
	#endif
	return output;
}
`});var Yq,Kq=m(()=>{Yq=`
varying vUv0: vec2f;
var source: texture_2d<f32>;
var sourceSampler: sampler;
uniform pixelOffset: vec2f;
fn isUsed(pixel: vec4f) -> bool {
	#ifdef HDR
		return any(pixel.rgb > vec3f(0.0));
	#else
		return pixel.a > 0.0;
	#endif
}
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	var c: vec4f = textureSampleLevel(source, sourceSampler, input.vUv0, 0.0);
	c = select(textureSampleLevel(source, sourceSampler, input.vUv0 - uniform.pixelOffset, 0.0), c, isUsed(c));
	c = select(textureSampleLevel(source, sourceSampler, input.vUv0 + vec2f(0.0, -uniform.pixelOffset.y), 0.0), c, isUsed(c));
	c = select(textureSampleLevel(source, sourceSampler, input.vUv0 + vec2f(uniform.pixelOffset.x, -uniform.pixelOffset.y), 0.0), c, isUsed(c));
	c = select(textureSampleLevel(source, sourceSampler, input.vUv0 + vec2f(-uniform.pixelOffset.x, 0.0), 0.0), c, isUsed(c));
	c = select(textureSampleLevel(source, sourceSampler, input.vUv0 + vec2f(uniform.pixelOffset.x, 0.0), 0.0), c, isUsed(c));
	c = select(textureSampleLevel(source, sourceSampler, input.vUv0 + vec2f(-uniform.pixelOffset.x, uniform.pixelOffset.y), 0.0), c, isUsed(c));
	c = select(textureSampleLevel(source, sourceSampler, input.vUv0 + vec2f(0.0, uniform.pixelOffset.y), 0.0), c, isUsed(c));
	c = select(textureSampleLevel(source, sourceSampler, input.vUv0 + uniform.pixelOffset, 0.0), c, isUsed(c));
	var output: FragmentOutput;
	output.color = c;
	return output;
}
`});var qq,$ne,Zne,_0,jq=m(()=>{Dt();j();Gq();Hq();Wq();Kq();It();qq=15,$ne={glslBilateralDeNoisePS:kq,glslDilatePS:zq},Zne={wgslBilateralDeNoisePS:Xq,wgslDilatePS:Yq},_0=class{constructor(e){this.shaderDilate=[],this.shaderDenoise=[],this.device=e,ie.get(this.device,oe).add($ne),ie.get(this.device,le).add(Zne),this.constantTexSource=e.scope.resolve("source"),this.constantPixelOffset=e.scope.resolve("pixelOffset"),this.pixelOffset=new Float32Array(2),this.sigmas=null,this.constantSigmas=null,this.kernel=null}setSourceTexture(e){this.constantTexSource.setValue(e)}prepare(e,t){this.pixelOffset[0]=1/e,this.pixelOffset[1]=1/t,this.constantPixelOffset.setValue(this.pixelOffset)}prepareDenoise(e,t,s){let i=s?0:1;if(!this.shaderDenoise[i]){let r=new Map;r.set("{MSIZE}",15),s&&r.set("HDR",""),this.shaderDenoise[i]=Te.createShader(this.device,{uniqueName:`lmBilateralDeNoise-${s?"hdr":"rgbm"}`,attributes:{vertex_position:te},vertexGLSL:ie.get(this.device,oe).get("fullscreenQuadVS"),vertexWGSL:ie.get(this.device,le).get("fullscreenQuadVS"),fragmentGLSL:ie.get(this.device,oe).get("glslBilateralDeNoisePS"),fragmentWGSL:ie.get(this.device,le).get("wgslBilateralDeNoisePS"),fragmentDefines:r}),this.sigmas=new Float32Array(2),this.constantSigmas=this.device.scope.resolve("sigmas"),this.constantKernel=this.device.scope.resolve("kernel[0]"),this.bZnorm=this.device.scope.resolve("bZnorm")}this.sigmas[0]=e,this.sigmas[1]=t,this.constantSigmas.setValue(this.sigmas),this.evaluateDenoiseUniforms(e,t)}getDenoise(e){let t=e?0:1;return this.shaderDenoise[t]}getDilate(e,t){let s=t?0:1;if(!this.shaderDilate[s]){let i=t?`#define HDR
`:"";this.shaderDilate[s]=Te.createShader(e,{uniqueName:`lmDilate-${t?"hdr":"rgbm"}`,attributes:{vertex_position:te},vertexGLSL:ie.get(this.device,oe).get("fullscreenQuadVS"),vertexWGSL:ie.get(this.device,le).get("fullscreenQuadVS"),fragmentGLSL:i+ie.get(this.device,oe).get("glslDilatePS"),fragmentWGSL:i+ie.get(this.device,le).get("wgslDilatePS")})}return this.shaderDilate[s]}evaluateDenoiseUniforms(e,t){function s(n,l){return .39894*Math.exp(-.5*n*n/(l*l))/l}this.kernel=this.kernel||new Float32Array(qq);let i=this.kernel,r=Math.floor((qq-1)/2);for(let n=0;n<=r;++n){let l=s(n,e);i[r+n]=l,i[r-n]=l}this.constantKernel.setValue(this.kernel);let a=1/s(0,t);this.bZnorm.setValue(a)}}});var g0,$q=m(()=>{us();J();g0=class extends Xe{constructor(e,t,s,i,r,a){super(e),this.viewBindGroups=[],this.renderer=t,this.camera=s,this.worldClusters=i,this.receivers=r,this.lightArray=a}destroy(){this.viewBindGroups.forEach(e=>{e.defaultUniformBuffer.destroy(),e.destroy()}),this.viewBindGroups.length=0}execute(){this.device;let{renderer:e,camera:t,receivers:s,renderTarget:i,worldClusters:r,lightArray:a}=this;e.renderForwardLayer(t,i,null,void 0,Ti,this.viewBindGroups,{meshInstances:s,splitLights:a,lightClusters:r})}}});var Qne,Jne,eoe,S0,Mp,Gb=m(()=>{ql();De();me();Q();Vt();j();Rt();Ea();Fe();J();_s();uA();Hy();WS();Zt();ln();Fq();Bq();Vq();_L();jq();qt();ii();$q();Qne=2048,Jne=0,eoe=1,S0=new g,Mp=class{constructor(e,t,s,i,r){this.device=e,this.root=t,this.scene=s,this.renderer=i,this.assets=r,this.shadowMapCache=i.shadowMapCache,this._tempSet=new Set,this._initCalled=!1,this.passMaterials=[],this.ambientAOMaterial=null,this.fog="",this.ambientLight=new N,this.renderTargets=new Map,this.stats={renderPasses:0,lightmapCount:0,totalRenderTime:0,forwardTime:0,fboTime:0,shadowMapTime:0,compileTime:0,shadersLinked:0}}destroy(){xa.decRef(this.blackTex),this.blackTex=null,xa.destroy(),this.device=null,this.root=null,this.scene=null,this.renderer=null,this.assets=null,this.camera?.destroy(),this.camera=null}initBake(e){if(this.bakeHDR=this.scene.lightmapPixelFormat!==7,!this._initCalled){this._initCalled=!0,this.lightmapFilters=new _0(e),this.constantBakeDir=e.scope.resolve("bakeDir"),this.materials=[],this.blackTex=new q(this.device,{width:4,height:4,format:7,type:ti,name:"lightmapBlack"}),xa.incRef(this.blackTex);let t=new co;t.clearColor.set(0,0,0,0),t.clearColorBuffer=!0,t.clearDepthBuffer=!1,t.clearStencilBuffer=!1,t.frustumCulling=!1,t.projection=Xs,t.aspectRatio=1,t.node=new Ae,this.camera=t,this.camera.shaderParams.gammaCorrection=Mi,this.camera.shaderParams.toneMapping=ro}if(this.scene.clusteredLightingEnabled){let t=new qh(e.supportsAreaLights,e.maxTextureSize,()=>{});this.lightingParams=t;let s=this.scene.lighting;t.shadowsEnabled=s.shadowsEnabled,t.shadowAtlasResolution=s.shadowAtlasResolution,t.cookiesEnabled=s.cookiesEnabled,t.cookieAtlasResolution=s.cookieAtlasResolution,t.areaLightsEnabled=s.areaLightsEnabled,t.cells=new g(3,3,3),t.maxLightsPerCell=4,this.worldClusters=new tl(e),this.worldClusters.name="ClusterLightmapper"}}finishBake(e){this.materials=[];function t(s){xa.decRef(s.colorBuffer),s.destroy()}this.renderTargets.forEach(s=>{t(s)}),this.renderTargets.clear(),e.forEach(s=>{s.renderTargets.forEach(i=>{t(i)}),s.renderTargets.length=0}),this.ambientAOMaterial=null,this.worldClusters&&(this.worldClusters.destroy(),this.worldClusters=null)}createMaterialForPass(e,t,s){let i=new ct;return i.name=`lmMaterial-pass:${t}-ambient:${s}`,i.setDefine("UV1LAYOUT",""),i.setDefine("LIT_LIGHTMAP_BAKING",""),t===Jne?(i.setDefine("LIT_LIGHTMAP_BAKING_COLOR",""),s?i.setDefine("LIT_LIGHTMAP_BAKING_ADD_AMBIENT",""):i.ambient=new N(0,0,0),this.bakeHDR||i.setDefine("LIGHTMAP_RGBM",""),i.lightMap=this.blackTex):(i.setDefine("LIT_LIGHTMAP_BAKING_DIR",""),i.setDefine("STD_LIGHTMAP_DIR","")),i.cull=0,i.forceUv1=!0,i.update(),i}createMaterials(e,t,s){for(let i=0;i<s;i++)this.passMaterials[i]||(this.passMaterials[i]=this.createMaterialForPass(t,i,!1));this.ambientAOMaterial||(this.ambientAOMaterial=this.createMaterialForPass(t,0,!0),this.ambientAOMaterial.onUpdateShader=function(i){return i.litOptions.lightMapWithoutAmbient=!0,i.litOptions.separateAmbient=!0,i})}createTexture(e,t){return new q(this.device,{width:e,height:e,format:this.scene.lightmapPixelFormat,mipmaps:!1,type:this.bakeHDR?zt:ti,minFilter:0,magFilter:0,addressU:1,addressV:1,name:t})}collectModels(e,t,s){if(!e.enabled)return;let i;if(e.model?.model&&e.model?.enabled&&(s&&s.push(new od(e)),e.model.lightmapped&&t&&(i=e.model.model.meshInstances)),e.render?.enabled&&(s&&s.push(new od(e)),e.render.lightmapped&&t&&(i=e.render.meshInstances)),i){let r=!0;for(let a=0;a<i.length;a++)if(!i[a].mesh.vertexBuffer.format.hasUv1){r=!1;break}if(r){let a=[];for(let n=0;n<i.length;n++){let l=i[n].mesh;this._tempSet.has(l)?t.push(new od(e,[i[n]])):a.push(i[n]),this._tempSet.add(l)}this._tempSet.clear(),a.length>0&&t.push(new od(e,a))}}for(let r=0;r<e._children.length;r++)this.collectModels(e._children[r],t,s)}prepareShadowCasters(e){let t=[];for(let s=0;s<e.length;s++){let i=e[s].component;if(i.castShadows=i.castShadowsLightmap,i.castShadowsLightmap){let r=e[s].meshInstances;for(let a=0;a<r.length;a++)r[a].visibleThisFrame=!0,t.push(r[a])}}return t}updateTransforms(e){for(let t=0;t<e.length;t++){let s=e[t].meshInstances;for(let i=0;i<s.length;i++)s[i].node.getWorldTransform()}}calculateLightmapSize(e){let t,s=this.scene.lightmapSizeMultiplier||16,i=S0,r,a;e.model?(a=e.model.lightmapSizeMultiplier,e.model.asset?(t=this.assets.get(e.model.asset).data,t.area&&(r=t.area)):e.model._area&&(t=e.model,t._area&&(r=t._area))):e.render&&(a=e.render.lightmapSizeMultiplier,e.render.type!=="asset"&&e.render._area&&(t=e.render,t._area&&(r=t._area)));let n={x:1,y:1,z:1,uv:1};r&&(n.x=r.x,n.y=r.y,n.z=r.z,n.uv=r.uv);let l=a||1;n.x*=l,n.y*=l,n.z*=l;let h=e.render||e.model,c=this.computeNodeBounds(h.meshInstances);i.copy(c.halfExtents);let f=n.x*i.y*i.z+n.y*i.x*i.z+n.z*i.x*i.y;return f/=n.uv,f=Math.sqrt(f),Math.min(w.nextPowerOfTwo(f*s),this.scene.lightmapMaxResolution||Qne)}setLightmapping(e,t,s,i){for(let r=0;r<e.length;r++){let a=e[r],n=a.meshInstances;for(let l=0;l<n.length;l++){let h=n[l];if(h.setLightmapped(t),t){i&&(h._shaderDefs|=i),h.mask=ir;for(let c=0;c<s;c++){let f=a.renderTargets[c].colorBuffer;f.minFilter=1,f.magFilter=1,h.setRealtimeLightmap(Oe.lightmapParamNames[c],f)}}}}}bake(e,t=Oh){let s=this.device,i=Us();this.scene._updateSkyMesh(),this.stats.renderPasses=0,this.stats.shadowMapTime=0,this.stats.forwardTime=0;let r=s._shaderStats.linked,a=s._renderTargetCreationTime,n=s._shaderStats.compileTime,l=[],h=[];if(e){for(let f=0;f<e.length;f++)this.collectModels(e[f],l,null);this.collectModels(this.root,null,h)}else this.collectModels(this.root,l,h);if(l.length>0){this.renderer.shadowRenderer.frameUpdate();let f=t===Oh?2:1;this.setLightmapping(l,!1,f),this.initBake(s),this.bakeInternal(f,l,h);let d=Bf;t===Oh&&(d|=wm),this.scene.ambientBake&&(d|=Lm),this.setLightmapping(l,!0,f,d),this.finishBake(l)}let c=Us();this.stats.totalRenderTime=c-i,this.stats.shadersLinked=s._shaderStats.linked-r,this.stats.compileTime=s._shaderStats.compileTime-n,this.stats.fboTime=s._renderTargetCreationTime-a,this.stats.lightmapCount=l.length}allocateTextures(e,t){for(let s=0;s<e.length;s++){let i=e[s],r=this.calculateLightmapSize(i.node);for(let a=0;a<t;a++){let n=this.createTexture(r,`lightmapper_lightmap_${s}`);xa.incRef(n),i.renderTargets[a]=new xe({colorBuffer:n,depth:!1})}if(!this.renderTargets.has(r)){let a=this.createTexture(r,`lightmapper_temp_lightmap_${r}`);xa.incRef(a),this.renderTargets.set(r,new xe({colorBuffer:a,depth:!1}))}}}prepareLightsToBake(e,t){if(this.scene.ambientBake){let i=new _T(this);t.push(i)}let s=this.renderer.lights;for(let i=0;i<s.length;i++){let r=s[i],a=new p0(this,r);e.push(a),r.enabled&&(r.mask&_a)!==0&&(r.mask=_a|ir|ps,r.shadowUpdateMode=r.type===ge?Dh:Di,t.push(a))}t.sort()}restoreLights(e){for(let t=0;t<e.length;t++)e[t].restore()}setupScene(){this.ambientLight.copy(this.scene.ambientLight),this.scene.ambientBake||this.scene.ambientLight.set(0,0,0),this.renderer.setSceneConstants(),this.device.scope.resolve("ambientBakeOcclusionContrast").setValue(this.scene.ambientBakeOcclusionContrast),this.device.scope.resolve("ambientBakeOcclusionBrightness").setValue(this.scene.ambientBakeOcclusionBrightness)}restoreScene(){this.scene.ambientLight.copy(this.ambientLight)}computeNodeBounds(e){let t=new _e;if(e.length>0){t.copy(e[0].aabb);for(let s=1;s<e.length;s++)t.add(e[s].aabb)}return t}computeNodesBounds(e){for(let t=0;t<e.length;t++){let s=e[t].meshInstances;e[t].bounds=this.computeNodeBounds(s)}}computeBounds(e){let t=new _e;for(let s=0;s<e.length;s++){t.copy(e[0].aabb);for(let i=1;i<e.length;i++)t.add(e[i].aabb)}return t}backupMaterials(e){for(let t=0;t<e.length;t++)this.materials[t]=e[t].material}restoreMaterials(e){for(let t=0;t<e.length;t++)e[t].material=this.materials[t]}lightCameraPrepare(e,t){let s=t.light,i;return s.type===Ye&&(i=s.getRenderData(null,0).shadowCamera,i._node.setPosition(s._node.getPosition()),i._node.setRotation(s._node.getRotation()),i._node.rotateLocal(-90,0,0),i.projection=Mt,i.nearClip=s.attenuationEnd/1e3,i.farClip=s.attenuationEnd,i.aspectRatio=1,i.fov=s._outerConeAngle*2,this.renderer.updateCameraFrustum(i)),i}lightCameraPrepareAndCull(e,t,s,i){let r=e.light,a=!0;if(r.type===ge){S0.copy(i.center),S0.y+=i.halfExtents.y,this.camera.node.setPosition(S0),this.camera.node.setEulerAngles(-90,0,0),this.camera.nearClip=0,this.camera.farClip=i.halfExtents.y*2;let n=Math.max(i.halfExtents.x,i.halfExtents.z);this.camera.orthoHeight=n}else e.lightBounds.intersects(t.bounds)||(a=!1);if(r.type===Ye){let n=!1,l=t.meshInstances;for(let h=0;h<l.length;h++)if(l[h]._isVisible(s)){n=!0;break}n||(a=!1)}return a}setupLightArray(e,t){e[ge].length=0,e[Ge].length=0,e[Ye].length=0,e[t.type][0]=t,t.visibleThisFrame=!0}renderShadowMap(e,t,s,i){let r=i.light,a=this.scene.clusteredLightingEnabled,n=r.castShadows&&(!a||this.scene.lighting.shadowsEnabled);if(!t&&n)if(!r.shadowMap&&!a&&(r.shadowMap=this.shadowMapCache.get(this.device,r)),r.type===ge)this.renderer._shadowRendererDirectional.cull(r,e,this.camera,s),this.renderer._shadowRendererDirectional.getLightRenderPass(r,this.camera)?.render();else{if(this.device.isWebGPU)return!0;this.renderer._shadowRendererLocal.cull(r,e,s),this.renderer.shadowRenderer.render(r,this.camera,!1)}return!0}postprocessTextures(e,t,s){let r=this.lightmapFilters.getDilate(e,this.bakeHDR),a,n=this.scene.lightmapFilterEnabled;n&&(this.lightmapFilters.prepareDenoise(this.scene.lightmapFilterRange,this.scene.lightmapFilterSmoothness,this.bakeHDR),a=this.lightmapFilters.getDenoise(this.bakeHDR)),e.setBlendState(Ie.NOBLEND),e.setDepthState($e.NODEPTH),e.setStencilState(null,null);for(let l=0;l<t.length;l++){let h=t[l];for(let c=0;c<s;c++){let f=h.renderTargets[c],d=f.colorBuffer,u=this.renderTargets.get(d.width),p=u.colorBuffer;this.lightmapFilters.prepare(d.width,d.height);for(let _=0;_<1;_++)this.lightmapFilters.setSourceTexture(d),Ot(e,u,n&&c===0&&_===0?a:r),this.lightmapFilters.setSourceTexture(p),Ot(e,f,r)}}}bakeInternal(e,t,s){let i=this.scene,r=i.layers,a=this.device,n=i.clusteredLightingEnabled;this.createMaterials(a,i,e),this.setupScene(),r._update(),this.computeNodesBounds(t),this.allocateTextures(t,e),this.renderer.collectLights(r);let l=[],h=[];this.prepareLightsToBake(l,h),this.updateTransforms(s);let c=this.prepareShadowCasters(s);this.renderer.updateCpuSkinMatrices(c),this.renderer.gpuUpdate(c);let f=this.computeBounds(c),d,u,p,_;for(d=0;d<t.length;d++)for(p=t[d].meshInstances,u=0;u<p.length;u++)_=p[u],_.setLightmapped(!1),_.mask=_a,_.setRealtimeLightmap(Oe.lightmapParamNames[0],this.blackTex),_.setRealtimeLightmap(Oe.lightmapParamNames[1],this.blackTex);for(u=0;u<h.length;u++)h[u].light.enabled=!1;let S=[[],[],[]],T,x,A=!1;for(d=0;d<h.length;d++){let E=h[d],v=E instanceof _T,R=E.light.type===ge,P=E.numVirtualLights;e>1&&P>1&&E.light.bakeDir&&(P=1);for(let y=0;y<P;y++){P>1&&E.prepareVirtualLight(y,P),E.startBake();let C=!1,L=this.lightCameraPrepare(a,E);for(x=0;x<t.length;x++){let O=t[x];if(p=O.meshInstances,!this.lightCameraPrepareAndCull(E,O,L,f))continue;this.setupLightArray(S,E.light);let U=R?[]:[E.light];for(n&&this.renderer.lightTextureAtlas.update(U,this.lightingParams),C=this.renderShadowMap(r,C,c,E),n&&this.worldClusters.update(U,this.lightingParams),this.backupMaterials(p),T=0;T<e&&!(T>0&&y>0||v&&T>0);T++){let G=O.renderTargets[T],$=O.renderTargets[T].colorBuffer.width,X=this.renderTargets.get($),I=X.colorBuffer;T===0?A=i.updateShaders:A&&(i.updateShaders=!0);let b=this.passMaterials[T];for(v&&y+1===P&&T===0&&(b=this.ambientAOMaterial),u=0;u<p.length;u++)p[u].material=b;if(this.renderer.updateShaders(p),T===eoe&&this.constantBakeDir.setValue(E.light.bakeDir?1:0),a.isWebGPU){let F=new g0(a,this.renderer,this.camera,n?this.worldClusters:null,p,S);F.init(X),F.render(),F.destroy()}else this.renderer.setCamera(this.camera,X,!0),n&&this.worldClusters.activate(),this.renderer._forwardTime=0,this.renderer._shadowMapTime=0,this.renderer.renderForward(this.camera,X,p,S,Ti),a.updateEnd();for(O.renderTargets[T]=X,this.renderTargets.set($,G),u=0;u<p.length;u++)_=p[u],_.setRealtimeLightmap(Oe.lightmapParamNames[T],I),_._shaderDefs|=Bf}this.restoreMaterials(p)}E.endBake(this.shadowMapCache)}}for(this.postprocessTextures(a,t,e),x=0;x<s.length;x++)s[x].restore();this.restoreLights(l),this.restoreScene(),n||this.shadowMapCache.clear()}}});var ae,We=m(()=>{Pe();ae=class o extends K{static{this.order=0}constructor(e,t){super(),this.system=e,this.entity=t,this.system.schema&&!this._accessorsBuilt&&this.buildAccessors(this.system.schema),this.on("set",function(s,i,r){this.fire(`set_${s}`,s,i,r)}),this.on("set_enabled",this.onSetEnabled,this)}static _buildAccessors(e,t){t.forEach(s=>{let i=typeof s=="object"?s.name:s;Object.defineProperty(e,i,{get:function(){return this.data[i]},set:function(r){let a=this.data,n=a[i];a[i]=r,this.fire("set",i,n,r)},configurable:!0})}),e._accessorsBuilt=!0}buildAccessors(e){o._buildAccessors(this,e)}onSetEnabled(e,t,s){t!==s&&this.entity.enabled&&(s?this.onEnable():this.onDisable())}onEnable(){}onDisable(){}onPostStateChange(){}get data(){let e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){}get enabled(){return!0}}});function toe(o,e){if(!o)return o;switch(e){case"rgb":return o instanceof N?o.clone():new N(o[0],o[1],o[2]);case"rgba":return o instanceof N?o.clone():new N(o[0],o[1],o[2],o[3]);case"vec2":return o instanceof D?o.clone():new D(o[0],o[1]);case"vec3":return o instanceof g?o.clone():new g(o[0],o[1],o[2]);case"vec4":return o instanceof W?o.clone():new W(o[0],o[1],o[2],o[3]);case"boolean":case"number":case"string":return o;case"entity":return o;default:throw new Error(`Could not convert unhandled type: ${e}`)}}var Me,Ut=m(()=>{Pe();De();Ne();Q();Ze();Me=class extends K{constructor(e){super(),this.app=e,this.store={},this.schema=[]}addComponent(e,t={}){let s=new this.ComponentType(this,e),i=new this.DataType;return this.store[e.getGuid()]={entity:e,data:i},e[this.id]=s,e.c[this.id]=s,this.initializeComponentData(s,t,[]),this.fire("add",e,s),s}removeComponent(e){let t=this.id,s=this.store[e.getGuid()],i=e.c[t];i.fire("beforeremove"),this.fire("beforeremove",e,i),delete this.store[e.getGuid()],e[t]=void 0,delete e.c[t],this.fire("remove",e,s.data)}cloneComponent(e,t){let s=this.store[e.getGuid()];return this.addComponent(t,s.data)}initializeComponentData(e,t={},s){for(let i=0,r=s.length;i<r;i++){let a=s[i],n,l;typeof a=="object"?(n=a.name,l=a.type):(n=a,l=void 0);let h=t[n];h!==void 0?(l!==void 0&&(h=toe(h,l)),e[n]=h):e[n]=e.data[n]}e.enabled&&e.entity.enabled&&e.onEnable()}getPropertiesOfType(e){let t=[];return(this.schema||[]).forEach(i=>{i&&typeof i=="object"&&i.type===e&&t.push(i)}),t}destroy(){this.off()}}});var T0,gT,ST,Zq=m(()=>{T0=0,gT=1,ST=2});var E0,Qq=m(()=>{me();E0=class{constructor(){this._left=1/0,this._right=-1/0,this._len=0,this._recip=0,this._p0=0,this._p1=0,this._t=0,this._hermite={valid:!1,p0:0,m0:0,p1:0,m1:0}}update(e,t){if(e<this._left||e>=this._right){let s=t.length;if(!s)this._left=-1/0,this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=0;else if(e<t[0])this._left=-1/0,this._right=t[0],this._len=0,this._recip=0,this._p0=this._p1=0;else if(e>=t[s-1])this._left=t[s-1],this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=s-1;else{let i=this._findKey(e,t);this._left=t[i],this._right=t[i+1],this._len=this._right-this._left;let r=1/this._len;this._recip=isFinite(r)?r:0,this._p0=i,this._p1=i+1}}this._t=this._recip===0?0:(e-this._left)*this._recip,this._hermite.valid=!1}_findKey(e,t){let s=0;for(;e>=t[s+1];)s++;return s}eval(e,t,s){let i=s._data,r=s._components,a=this._p0*r;if(t===0)for(let n=0;n<r;++n)e[n]=i[a+n];else{let n=this._t,l=this._p1*r;switch(t){case 1:for(let h=0;h<r;++h)e[h]=w.lerp(i[a+h],i[l+h],n);break;case 2:{let h=this._hermite;if(!h.valid){let p=n*n,_=n+n,S=1-n,T=S*S;h.valid=!0,h.p0=(1+_)*T,h.m0=n*T,h.p1=p*(3-_),h.m1=p*(n-1)}let c=(this._p0*3+1)*r,f=(this._p0*3+2)*r,d=(this._p1*3+1)*r,u=(this._p1*3+0)*r;for(let p=0;p<r;++p)e[p]=h.p0*i[c+p]+h.m0*i[f+p]*this._len+h.p1*i[d+p]+h.m1*i[u+p]*this._len;break}}}}}});var ld,zb=m(()=>{Qq();ld=class{constructor(e){this._name=`${e.name}Snapshot`,this._time=-1,this._cache=[],this._results=[];for(let i=0;i<e._inputs.length;++i)this._cache[i]=new E0;let t=e._curves,s=e._outputs;for(let i=0;i<t.length;++i){let r=t[i],a=s[r._output],n=[];for(let l=0;l<a._components;++l)n[l]=0;this._results[i]=n}}}});var mc,v0=m(()=>{zb();mc=class o{static{this.eventFrame={start:0,end:0,residual:0}}constructor(e,t,s,i,r,a){this._name=e.name,this._track=e,this._snapshot=new ld(e),this._playing=i,this._time=t,this._speed=s,this._loop=r,this._blendWeight=1,this._blendOrder=0,this._eventHandler=a,this.alignCursorToCurrentTime()}set name(e){this._name=e}get name(){return this._name}set track(e){this._track=e,this._snapshot=new ld(e)}get track(){return this._track}get snapshot(){return this._snapshot}set time(e){this._time=e,this.alignCursorToCurrentTime()}get time(){return this._time}set speed(e){let t=Math.sign(e)!==Math.sign(this._speed);this._speed=e,t&&this.alignCursorToCurrentTime()}get speed(){return this._speed}set loop(e){this._loop=e}get loop(){return this._loop}set blendWeight(e){this._blendWeight=e}get blendWeight(){return this._blendWeight}set blendOrder(e){this._blendOrder=e}get blendOrder(){return this._blendOrder}set eventCursor(e){this._eventCursor=e}get eventCursor(){return this._eventCursor}get eventCursorEnd(){return this.isReverse?0:this._track.events.length-1}get nextEvent(){return this._track.events[this._eventCursor]}get isReverse(){return this._speed<0}nextEventAheadOfTime(e){return this.nextEvent?this.isReverse?this.nextEvent.time<=e:this.nextEvent.time>=e:!1}nextEventBehindTime(e){return this.nextEvent?e===this.track.duration?this.isReverse?this.nextEvent.time>=e:this.nextEvent.time<=e:this.isReverse?this.nextEvent.time>e:this.nextEvent.time<e:!1}resetEventCursor(){this._eventCursor=this.isReverse?this._track.events.length-1:0}moveEventCursor(){this._eventCursor+=this.isReverse?-1:1,this._eventCursor>=this.track.events.length?this._eventCursor=0:this._eventCursor<0&&(this._eventCursor=this.track.events.length-1)}clipFrameTime(e){let t=o.eventFrame;t.start=0,t.end=e,t.residual=0,this.isReverse?e<0&&(t.start=this.track.duration,t.end=0,t.residual=e+this.track.duration):e>this.track.duration&&(t.start=0,t.end=this.track.duration,t.residual=e-this.track.duration)}alignCursorToCurrentTime(){for(this.resetEventCursor();this.nextEventBehindTime(this._time)&&this._eventCursor!==this.eventCursorEnd;)this.moveEventCursor()}fireNextEvent(){this._eventHandler.fire(this.nextEvent.name,{track:this.track,...this.nextEvent}),this.moveEventCursor()}fireNextEventInFrame(e,t){return this.nextEventAheadOfTime(e)&&this.nextEventBehindTime(t)?(this.fireNextEvent(),!0):!1}activeEventsForFrame(e,t){let s=o.eventFrame;this.clipFrameTime(t);let i=this.eventCursor;for(;this.fireNextEventInFrame(e,s.end)&&i!==this.eventCursor;);this.loop&&Math.abs(s.residual)>0&&this.activeEventsForFrame(s.start,s.residual)}progressForTime(e){return e*this._speed/this._track.duration}_update(e){if(this._playing){let t=this._time,s=this._track.duration,i=this._speed,r=this._loop;this._track.events.length>0&&s>0&&this.activeEventsForFrame(t,t+i*e),t+=i*e,i>=0?t>s&&(r?t=t%s||0:(t=this._track.duration,this.pause())):t<0&&(r?t=s+(t%s||0):(t=0,this.pause())),this._time=t}this._time!==this._snapshot._time&&this._track.eval(this._time,this._snapshot)}play(){this._playing=!0,this._time=0}stop(){this._playing=!1,this._time=0}pause(){this._playing=!1}resume(){this._playing=!0}reset(){this._time=0}}});var Dp,x0,y0,A0,P0,R0,C0,I0,w0,L0,b0,TT,ET,vT,_c,M0,D0,O0,N0,gc,xT,pl,_l,Op,F0,Sc=m(()=>{Dp="NONE",x0="PREV_STATE",y0="NEXT_STATE",A0="PREV_STATE_NEXT_STATE",P0="NEXT_STATE_PREV_STATE",R0="GREATER_THAN",C0="LESS_THAN",I0="GREATER_THAN_EQUAL_TO",w0="LESS_THAN_EQUAL_TO",L0="EQUAL_TO",b0="NOT_EQUAL_TO",TT="INTEGER",ET="FLOAT",vT="BOOLEAN",_c="TRIGGER",M0="1D",D0="2D_DIRECTIONAL",O0="2D_CARTESIAN",N0="DIRECT",gc="START",xT="END",pl="ANY",_l=[gc,"END","ANY"],Op="OVERWRITE",F0="ADDITIVE"});var Or,Hb=m(()=>{Or=class o{static dot(e,t){let s=e.length,i=0;for(let r=0;r<s;++r)i+=e[r]*t[r];return i}static normalize(e){let t=o.dot(e,e);if(t>0){t=1/Math.sqrt(t);let s=e.length;for(let i=0;i<s;++i)e[i]*=t}}static set(e,t,s){let i=e.length;if(s==="quaternion"){let r=o.dot(t,t);r>0&&(r=1/Math.sqrt(r));for(let a=0;a<i;++a)e[a]=t[a]*r}else for(let r=0;r<i;++r)e[r]=t[r]}static blendVec(e,t,s,i){let r=i?1:1-s,a=e.length;for(let n=0;n<a;++n)e[n]=e[n]*r+t[n]*s}static blendQuat(e,t,s,i){let r=e.length,a=i?1:1-s;o.dot(e,t)<0&&(s=-s);for(let n=0;n<r;++n)e[n]=e[n]*a+t[n]*s;i||o.normalize(e)}static blend(e,t,s,i,r){i==="quaternion"?o.blendQuat(e,t,s,r):o.blendVec(e,t,s,r)}static stableSort(e,t){let s=e.length;for(let i=0;i<s-1;++i)for(let r=i+1;r<s;++r)if(t(e[r],e[i])){let a=e[i];e[i]=e[r],e[r]=a}}}});var Np,Jq=m(()=>{Ve();Sc();Hb();me();Np=class o{static{this.TYPE_QUAT="quaternion"}static{this.TYPE_VEC3="vector3"}static{this.q1=new H}static{this.q2=new H}static{this.q3=new H}static{this.quatArr=[0,0,0,1]}static{this.vecArr=[0,0,0]}static{this.IDENTITY_QUAT_ARR=[0,0,0,1]}constructor(e,t){this._component=e,this.mask=new Int8Array(e.layers.length),this.weights=new Float32Array(e.layers.length),this.totalWeight=0,this.counter=0,this.layerCounter=0,this.valueType=t,this.dirty=!0,this.value=t===o.TYPE_QUAT?[0,0,0,1]:[0,0,0],this.baseValue=null,this.setter=null}get _normalizeWeights(){return this._component.normalizeWeights}getWeight(e){return this.dirty&&this.updateWeights(),this._normalizeWeights&&this.totalWeight===0||!this.mask[e]?0:this._normalizeWeights?this.weights[e]/this.totalWeight:w.clamp(this.weights[e],0,1)}_layerBlendType(e){return this._component.layers[e].blendType}setMask(e,t){this.mask[e]=t,this._normalizeWeights&&(this._component.layers[e].blendType===Op&&(this.mask=this.mask.fill(0,0,e)),this.dirty=!0)}updateWeights(){this.totalWeight=0;for(let e=0;e<this.weights.length;e++)this.weights[e]=this._component.layers[e].weight,this.totalWeight+=this.mask[e]*this.weights[e];this.dirty=!1}updateValue(e,t){if(this.counter===0&&(Or.set(this.value,o.IDENTITY_QUAT_ARR,this.valueType),this._normalizeWeights||Or.blend(this.value,this.baseValue,1,this.valueType)),!(!this.mask[e]||this.getWeight(e)===0)){if(this._layerBlendType(e)===F0&&!this._normalizeWeights)if(this.valueType===o.TYPE_QUAT){let s=o.q1.set(this.value[0],this.value[1],this.value[2],this.value[3]),i=o.q2.set(this.baseValue[0],this.baseValue[1],this.baseValue[2],this.baseValue[3]),r=o.q3.set(t[0],t[1],t[2],t[3]),a=i.invert().mul(r);a.slerp(H.IDENTITY,a,this.getWeight(e)),s.mul(a),o.quatArr[0]=s.x,o.quatArr[1]=s.y,o.quatArr[2]=s.z,o.quatArr[3]=s.w,Or.set(this.value,o.quatArr,this.valueType)}else o.vecArr[0]=t[0]-this.baseValue[0],o.vecArr[1]=t[1]-this.baseValue[1],o.vecArr[2]=t[2]-this.baseValue[2],Or.blend(this.value,o.vecArr,this.getWeight(e),this.valueType,!0);else Or.blend(this.value,t,this.getWeight(e),this.valueType);this.setter&&this.setter(this.value)}}unbind(){this.setter&&this.setter(this.baseValue)}}});var Tc,U0=m(()=>{Jq();Hb();Tc=class{constructor(e){this._binder=e,this._clips=[],this._inputs=[],this._outputs=[],this._targets={}}get clips(){return this._clips}addClip(e){let t=this._targets,s=this._binder,i=e.track.curves,r=e.snapshot,a=[],n=[];for(let l=0;l<i.length;++l){let c=i[l].paths;for(let f=0;f<c.length;++f){let d=c[f],u=s.resolve(d),p=t[u&&u.targetPath||null];if(!p&&u){p={target:u,value:[],curves:0,blendCounter:0};for(let _=0;_<p.target.components;++_)p.value.push(0);if(t[u.targetPath]=p,s.animComponent){if(!s.animComponent.targets[u.targetPath]){let _;u.targetPath.substring(u.targetPath.length-13)==="localRotation"?_=Np.TYPE_QUAT:_=Np.TYPE_VEC3,s.animComponent.targets[u.targetPath]=new Np(s.animComponent,_)}s.animComponent.targets[u.targetPath].layerCounter++,s.animComponent.targets[u.targetPath].setMask(s.layerIndex,1)}}p&&(p.curves++,a.push(r._results[l]),n.push(p))}}this._clips.push(e),this._inputs.push(a),this._outputs.push(n)}removeClip(e){let t=this._targets,s=this._binder,i=this._clips,a=i[e].track.curves;for(let n=0;n<a.length;++n){let h=a[n].paths;for(let c=0;c<h.length;++c){let f=h[c],d=this._binder.resolve(f);d&&(d.curves--,d.curves===0&&(s.unresolve(f),delete t[d.targetPath],s.animComponent&&s.animComponent.targets[d.targetPath].layerCounter--))}}i.splice(e,1),this._inputs.splice(e,1),this._outputs.splice(e,1)}removeClips(){for(;this._clips.length>0;)this.removeClip(0)}updateClipTrack(e,t){this._clips.forEach(s=>{s.name.includes(e)&&(s.track=t)}),this.rebind()}findClip(e){let t=this._clips;for(let s=0;s<t.length;++s){let i=t[s];if(i.name===e)return i}return null}rebind(){this._binder.rebind(),this._targets={};let e=[...this.clips];this.removeClips(),e.forEach(t=>{this.addClip(t)})}assignMask(e){return this._binder.assignMask(e)}update(e,t=!0){let s=this._clips,i=s.map((n,l)=>l);Or.stableSort(i,(n,l)=>s[n].blendOrder<s[l].blendOrder);for(let n=0;n<i.length;++n){let l=i[n],h=s[l],c=this._inputs[l],f=this._outputs[l],d=h.blendWeight;if(d>0&&h._update(e),!t)break;let u,p,_;if(d>=1)for(let S=0;S<c.length;++S)u=c[S],p=f[S],_=p.value,Or.set(_,u,p.target.type),p.blendCounter++;else if(d>0)for(let S=0;S<c.length;++S)u=c[S],p=f[S],_=p.value,p.blendCounter===0?Or.set(_,u,p.target.type):Or.blend(_,u,d,p.target.type),p.blendCounter++}let r=this._targets,a=this._binder;for(let n in r)if(r.hasOwnProperty(n)){let l=r[n];if(a.animComponent&&l.target.isTransform){let h=a.animComponent.targets[n];h.counter===h.layerCounter&&(h.counter=0),h.path||(h.path=n,h.baseValue=l.target.get(),h.setter=l.target.set),h.updateValue(a.layerIndex,l.value),h.counter++}else l.target.set(l.value);l.blendCounter=0}this._binder.update(e)}}});var Ec,B0=m(()=>{Ec=class{constructor(e){this._events=[...e],this._events.sort((t,s)=>t.time-s.time)}get events(){return this._events}}});var $s,gl=m(()=>{B0();$s=class o{static{this.EMPTY=Object.freeze(new o("empty",Number.MAX_VALUE,[],[],[]))}constructor(e,t,s,i,r,a=new Ec([])){this._name=e,this._duration=t,this._inputs=s,this._outputs=i,this._curves=r,this._animEvents=a}get name(){return this._name}get duration(){return this._duration}get inputs(){return this._inputs}get outputs(){return this._outputs}get curves(){return this._curves}set events(e){this._animEvents=e}get events(){return this._animEvents.events}eval(e,t){t._time=e;let s=this._inputs,i=this._outputs,r=this._curves,a=t._cache,n=t._results;for(let l=0;l<s.length;++l)a[l].update(e,s[l]._data);for(let l=0;l<r.length;++l){let h=r[l],c=i[h._output],f=n[l];a[h._input].eval(f,h._interpolation,c)}}}});var Ma,V0=m(()=>{Ma=class{static joinPath(e,t){t=t||".";let s=function(i){return i.replace(/\\/g,"\\\\").replace(new RegExp(`\\${t}`,"g"),`\\${t}`)};return e.map(s).join(t)}static splitPath(e,t){t=t||".";let s=[],i="",r=0;for(;r<e.length;){let a=e[r++];a==="\\"&&r<e.length?(a=e[r++],a==="\\"||a===t?i+=a:i+=`\\${a}`):a===t?(s.push(i),i=""):i+=a}return i.length>0&&s.push(i),s}static encode(e,t,s){return`${Array.isArray(e)?e.join("/"):e}/${t}/${Array.isArray(s)?s.join("/"):s}`}resolve(e){return null}unresolve(e){}update(e){}}});var Sl,k0=m(()=>{Sl=class{constructor(e,t,s,i){e.set?(this._set=e.set,this._get=e.get):this._set=e,this._type=t,this._components=s,this._targetPath=i,this._isTransform=this._targetPath.substring(this._targetPath.length-13)==="localRotation"||this._targetPath.substring(this._targetPath.length-13)==="localPosition"||this._targetPath.substring(this._targetPath.length-10)==="localScale"}get set(){return this._set}get get(){return this._get}get type(){return this._type}get components(){return this._components}get targetPath(){return this._targetPath}get isTransform(){return this._isTransform}}});var vc,G0=m(()=>{V0();k0();ci();vc=class o{constructor(e){if(this._isPathInMask=(r,a)=>{let n=this._mask[r];if(n){if(n.children||a&&n.value!==!1)return!0}else return!1;return!1},this.graph=e,!e)return;this._mask=null;let t={},s=function(r){t[r.name]=r;for(let a=0;a<r.children.length;++a)s(r.children[a])};s(e),this.nodes=t,this.targetCache={};let i=function(r){let a=r;for(;a&&!(a instanceof be);)a=a.parent;let n;return a&&(a.render?n=a.render.meshInstances:a.model&&(n=a.model.meshInstances)),n};this.nodeCounts={},this.activeNodes=[],this.handlers={localPosition:function(r){let a=r.localPosition,n=function(l){a.set(...l)};return o.createAnimTarget(n,"vector",3,r,"localPosition")},localRotation:function(r){let a=r.localRotation,n=function(l){a.set(...l)};return o.createAnimTarget(n,"quaternion",4,r,"localRotation")},localScale:function(r){let a=r.localScale,n=function(l){a.set(...l)};return o.createAnimTarget(n,"vector",3,r,"localScale")},weight:function(r,a){a.indexOf("name.")===0?a=a.replace("name.",""):a=Number(a);let n=i(r),l;if(n){for(let h=0;h<n.length;++h)if(n[h].node.name===r.name&&n[h].morphInstance){let c=n[h].morphInstance,f=d=>{c.setWeight(a,d[0])};l||(l=[]),l.push(f)}}if(l){let h=c=>{for(let f=0;f<l.length;++f)l[f](c)};return o.createAnimTarget(h,"number",1,r,`weight.${a}`)}return null},materialTexture:(r,a)=>{let n=i(r);if(n){let l;for(let h=0;h<n.length;++h)if(n[h].node.name===r.name){l=n[h];break}if(l){let h=c=>{let f=this.animComponent.system.app.assets.get(c[0]);f&&f.resource&&f.type==="texture"&&(l.material[a]=f.resource,l.material.update())};return o.createAnimTarget(h,"vector",1,r,"materialTexture","material")}}return null}}}_isPathActive(e){if(!this._mask)return!0;let t=[e.entityPath[0],this.graph.name];for(let s=0;s<t.length;++s){let i=t[s];if(this._isPathInMask(i,e.entityPath.length===1))return!0;for(let r=1;r<e.entityPath.length;r++)if(i+=`/${e.entityPath[r]}`,this._isPathInMask(i,r===e.entityPath.length-1))return!0}return!1}findNode(e){if(!this._isPathActive(e))return null;let t;return this.graph&&(t=this.graph.findByPath(e.entityPath),t||(t=this.graph.findByPath(e.entityPath.slice(1)))),t||(t=this.nodes[e.entityPath[e.entityPath.length-1]||""]),t}static createAnimTarget(e,t,s,i,r,a){let n=Ma.encode(i.path,a||"entity",r);return new Sl(e,t,s,n)}resolve(e){let t=Ma.encode(e.entityPath,e.component,e.propertyPath),s=this.targetCache[t];if(s)return s;let i=this.findNode(e);if(!i)return null;let r=this.handlers[e.propertyPath];return!r||(s=r(i),!s)?null:(this.targetCache[t]=s,this.nodeCounts[i.path]?this.nodeCounts[i.path]++:(this.activeNodes.push(i),this.nodeCounts[i.path]=1),s)}unresolve(e){if(e.component!=="graph")return;let t=this.nodes[e.entityPath[e.entityPath.length-1]||""];if(this.nodeCounts[t.path]--,this.nodeCounts[t.path]===0){let s=this.activeNodes,i=s.indexOf(t.node),r=s.length;i<r-1&&(s[i]=s[r-1]),s.pop()}}update(e){let t=this.activeNodes;for(let s=0;s<t.length;++s)t[s]._dirtifyLocal()}assignMask(e){return e!==this._mask?(this._mask=e,!0):!1}}});var hd,Xb=m(()=>{v0();U0();gl();G0();hb();rt();We();hd=class extends ae{set animations(e){this._animations=e,this.onSetAnimations()}get animations(){return this._animations}set assets(e){let t=this._assets;if(t&&t.length){for(let i=0;i<t.length;i++)if(t[i]){let r=this.system.app.assets.get(t[i]);if(r){r.off("change",this.onAssetChanged,this),r.off("remove",this.onAssetRemoved,this);let a=this.animationsIndex[r.id];this.currAnim===a&&this._stopCurrentAnimation(),delete this.animations[a],delete this.animationsIndex[r.id]}}}this._assets=e;let s=e.map(i=>i instanceof re?i.id:i);this.loadAnimationAssets(s)}get assets(){return this._assets}set currentTime(e){if(this.skeleton&&(this.skeleton.currentTime=e,this.skeleton.addTime(0),this.skeleton.updateGraph()),this.animEvaluator){let t=this.animEvaluator.clips;for(let s=0;s<t.length;++s)t[s].time=e}}get currentTime(){if(this.skeleton)return this.skeleton._time;if(this.animEvaluator){let e=this.animEvaluator.clips;if(e.length>0)return e[e.length-1].time}return 0}get duration(){return this.currAnim?this.animations[this.currAnim].duration:0}set loop(e){if(this._loop=e,this.skeleton&&(this.skeleton.looping=e),this.animEvaluator)for(let t=0;t<this.animEvaluator.clips.length;++t)this.animEvaluator.clips[t].loop=e}get loop(){return this._loop}play(e,t=0){if(!(!this.enabled||!this.entity.enabled)&&this.animations[e]){if(this.prevAnim=this.currAnim,this.currAnim=e,this.model){!this.skeleton&&!this.animEvaluator&&this._createAnimationController();let s=this.animations[this.prevAnim],i=this.animations[this.currAnim];if(this.blending=t>0&&!!this.prevAnim,this.blending&&(this.blend=0,this.blendSpeed=1/t),this.skeleton&&(this.blending?(this.fromSkel.animation=s,this.fromSkel.addTime(this.skeleton._time),this.toSkel.animation=i):this.skeleton.animation=i),this.animEvaluator){let r=this.animEvaluator;if(this.blending)for(;r.clips.length>1;)r.removeClip(0);else this.animEvaluator.removeClips();let a=new mc(this.animations[this.currAnim],0,1,!0,this.loop);a.name=this.currAnim,a.blendWeight=this.blending?0:1,a.reset(),this.animEvaluator.addClip(a)}}this.playing=!0}}getAnimation(e){return this.animations[e]}setModel(e){e!==this.model&&(this._resetAnimationController(),this.model=e,this.animations&&this.currAnim&&this.animations[this.currAnim]&&this.play(this.currAnim))}onSetAnimations(){let e=this.entity.model;if(e){let t=e.model;t&&t!==this.model&&this.setModel(t)}if(!this.currAnim&&this.activate&&this.enabled&&this.entity.enabled){let t=Object.keys(this._animations);t.length>0&&this.play(t[0])}}_resetAnimationController(){this.skeleton=null,this.fromSkel=null,this.toSkel=null,this.animEvaluator=null}_createAnimationController(){let e=this.model,t=this.animations,s=!1,i=!1;for(let a in t)t.hasOwnProperty(a)&&(t[a].constructor===$s?i=!0:s=!0);let r=e.getGraph();s?(this.fromSkel=new tc(r),this.toSkel=new tc(r),this.skeleton=new tc(r),this.skeleton.looping=this.loop,this.skeleton.setGraph(r)):i&&(this.animEvaluator=new Tc(new vc(this.entity)))}loadAnimationAssets(e){if(!e||!e.length)return;let t=this.system.app.assets,s=r=>{if(r.resources.length>1)for(let a=0;a<r.resources.length;a++)this.animations[r.resources[a].name]=r.resources[a],this.animationsIndex[r.id]=r.resources[a].name;else this.animations[r.name]=r.resource,this.animationsIndex[r.id]=r.name;this.animations=this.animations},i=r=>{r.off("change",this.onAssetChanged,this),r.on("change",this.onAssetChanged,this),r.off("remove",this.onAssetRemoved,this),r.on("remove",this.onAssetRemoved,this),r.resource?s(r):(r.once("load",s,this),this.enabled&&this.entity.enabled&&t.load(r))};for(let r=0,a=e.length;r<a;r++){let n=t.get(e[r]);n?i(n):t.on(`add:${e[r]}`,i)}}onAssetChanged(e,t,s,i){if(t==="resource"||t==="resources")if(t==="resources"&&s&&s.length===0&&(s=null),s){let r=!1;if(s.length>1){if(i&&i.length>1)for(let a=0;a<i.length;a++)delete this.animations[i[a].name];else delete this.animations[e.name];r=!1;for(let a=0;a<s.length;a++)this.animations[s[a].name]=s[a],!r&&this.currAnim===s[a].name&&this.playing&&this.enabled&&this.entity.enabled&&(r=!0,this.play(s[a].name));r||(this._stopCurrentAnimation(),this.onSetAnimations())}else{if(i&&i.length>1)for(let a=0;a<i.length;a++)delete this.animations[i[a].name];this.animations[e.name]=s[0]||s,r=!1,this.currAnim===e.name&&this.playing&&this.enabled&&this.entity.enabled&&(r=!0,this.play(e.name)),r||(this._stopCurrentAnimation(),this.onSetAnimations())}this.animationsIndex[e.id]=e.name}else{if(i.length>1)for(let r=0;r<i.length;r++)delete this.animations[i[r].name],this.currAnim===i[r].name&&this._stopCurrentAnimation();else delete this.animations[e.name],this.currAnim===e.name&&this._stopCurrentAnimation();delete this.animationsIndex[e.id]}}onAssetRemoved(e){if(e.off("remove",this.onAssetRemoved,this),this.animations){if(e.resources.length>1)for(let t=0;t<e.resources.length;t++)delete this.animations[e.resources[t].name],this.currAnim===e.resources[t].name&&this._stopCurrentAnimation();else delete this.animations[e.name],this.currAnim===e.name&&this._stopCurrentAnimation();delete this.animationsIndex[e.id]}}_stopCurrentAnimation(){if(this.currAnim=null,this.playing=!1,this.skeleton&&(this.skeleton.currentTime=0,this.skeleton.animation=null),this.animEvaluator){for(let e=0;e<this.animEvaluator.clips.length;++e)this.animEvaluator.clips[e].stop();this.animEvaluator.update(0),this.animEvaluator.removeClips()}}onEnable(){super.onEnable();let e=this.assets,t=this.system.app.assets;if(e)for(let s=0,i=e.length;s<i;s++){let r=e[s];r instanceof re||(r=t.get(r)),r&&!r.resource&&t.load(r)}if(this.activate&&!this.currAnim){let s=Object.keys(this.animations);s.length>0&&this.play(s[0])}}onBeforeRemove(){for(let e=0;e<this.assets.length;e++){let t=this.assets[e];typeof t=="number"&&(t=this.system.app.assets.get(t)),t&&(t.off("change",this.onAssetChanged,this),t.off("remove",this.onAssetRemoved,this))}this.skeleton=null,this.fromSkel=null,this.toSkel=null,this.animEvaluator=null}update(e){if(this.blending&&(this.blend+=e*this.blendSpeed,this.blend>=1&&(this.blend=1)),this.playing){let s=this.skeleton;if(s!==null&&this.model!==null){if(this.blending)s.blend(this.fromSkel,this.toSkel,this.blend);else{let i=e*this.speed;s.addTime(i),this.speed>0&&s._time===s.animation.duration&&!this.loop?this.playing=!1:this.speed<0&&s._time===0&&!this.loop&&(this.playing=!1)}this.blending&&this.blend===1&&(s.animation=this.toSkel.animation),s.updateGraph()}}let t=this.animEvaluator;if(t){for(let s=0;s<t.clips.length;++s){let i=t.clips[s];i.speed=this.speed,this.playing?i.resume():i.pause()}this.blending&&t.clips.length>1&&(t.clips[1].blendWeight=this.blend),t.update(e)}this.blending&&this.blend===1&&(this.blending=!1)}constructor(...e){super(...e),this._animations={},this._assets=[],this._loop=!0,this.animEvaluator=null,this.model=null,this.skeleton=null,this.fromSkel=null,this.toSkel=null,this.animationsIndex={},this.prevAnim=null,this.currAnim=null,this.blend=0,this.blending=!1,this.blendSpeed=0,this.activate=!0,this.speed=1}}});var z0,ej=m(()=>{z0=class{constructor(){this.enabled=!0}}});var Wb,Fp,Yb=m(()=>{We();Ut();Xb();ej();Wb=["enabled"],Fp=class extends Me{constructor(e){super(e),this.id="animation",this.ComponentType=hd,this.DataType=z0,this.schema=Wb,this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(e,t,s){s=["activate","enabled","loop","speed","assets"];for(let i of s)t.hasOwnProperty(i)&&(e[i]=t[i]);super.initializeComponentData(e,t,Wb)}cloneComponent(e,t){this.addComponent(t,{}),t.animation.assets=e.animation.assets.slice(),t.animation.speed=e.animation.speed,t.animation.loop=e.animation.loop,t.animation.activate=e.animation.activate,t.animation.enabled=e.animation.enabled;let s={},i=e.animation.animations;for(let n in i)i.hasOwnProperty(n)&&(s[n]=i[n]);t.animation.animations=s;let r={},a=e.animation.animationsIndex;for(let n in a)a.hasOwnProperty(n)&&(r[n]=a[n]);return t.animation.animationsIndex=r,t.animation}onBeforeRemove(e,t){t.onBeforeRemove()}onUpdate(e){let t=this.store;for(let s in t)if(t.hasOwnProperty(s)){let i=t[s];i.data.enabled&&i.entity.enabled&&i.entity.animation.update(e)}}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}};ae._buildAccessors(hd.prototype,Wb)});var vo,H0=m(()=>{Ne();vo=class{constructor(e,t,s,i,r=1){this._state=e,this._parent=t,this._name=s,Array.isArray(i)?(this._point=new D(i[0],i[1]),this._pointLength=this._point.length()):(this._point=i,this._pointLength=i),this._speed=r,this._weightedSpeed=1,this._weight=1,this._animTrack=null}get parent(){return this._parent}get name(){return this._name}get path(){return this._parent?`${this._parent.path}.${this._name}`:this._name}get point(){return this._point}get pointLength(){return this._pointLength}set weight(e){this._weight=e}get weight(){return this._parent?this._parent.weight*this._weight:this._weight}get normalizedWeight(){let e=this._state.totalWeight;return e===0?0:this.weight/e}get speed(){return this._weightedSpeed*this._speed}get absoluteSpeed(){return Math.abs(this._speed)}set weightedSpeed(e){this._weightedSpeed=e}get weightedSpeed(){return this._weightedSpeed}set animTrack(e){this._animTrack=e}get animTrack(){return this._animTrack}}});var xo,yT=m(()=>{H0();xo=class o extends vo{constructor(e,t,s,i,r,a,n,l,h){super(e,t,s,i),this._parameters=r,this._parameterValues=new Array(r.length),this._children=[],this._findParameter=h,this._syncAnimations=n!==!1,this._pointCache={};for(let c=0;c<a.length;c++){let f=a[c];f.children?this._children.push(l(f.type,e,this,f.name,1,f.parameter?[f.parameter]:f.parameters,f.children,f.syncAnimations,l,h)):this._children.push(new vo(e,this,f.name,f.point,f.speed))}}get weight(){return this.calculateWeights(),this._parent?this._parent.weight*this._weight:this._weight}get syncAnimations(){return this._syncAnimations}getChild(e){for(let t=0;t<this._children.length;t++)if(this._children[t].name===e)return this._children[t];return null}updateParameterValues(){let e=!0;for(let t=0;t<this._parameterValues.length;t++){let s=this._findParameter(this._parameters[t]).value;this._parameterValues[t]!==s&&(this._parameterValues[t]=s,e=!1)}return e}getNodeWeightedDuration(e){return this._children[e].animTrack.duration/this._children[e].speedMultiplier*this._children[e].weight}getNodeCount(){let e=0;for(let t=0;t<this._children.length;t++)this._children[t].constructor===o?e+=this._children[t].getNodeCount():e++;return e}}});var X0,tj=m(()=>{me();yT();X0=class extends xo{constructor(e,t,s,i,r,a,n,l,h){a.sort((c,f)=>c.point-f.point),super(e,t,s,i,r,a,n,l,h)}calculateWeights(){if(this.updateParameterValues())return;let e=0;this._children[0].weight=0;for(let t=0;t<this._children.length;t++){let s=this._children[t];if(t!==this._children.length-1){let i=this._children[t+1];if(s.point===i.point)s.weight=.5,i.weight=.5;else if(w.between(this._parameterValues[0],s.point,i.point,!0)){let r=Math.abs(s.point-i.point),a=Math.abs(s.point-this._parameterValues[0]),n=(r-a)/r;s.weight=n,i.weight=1-n}else i.weight=0}this._syncAnimations&&(e+=s.animTrack.duration/s.absoluteSpeed*s.weight)}if(this._syncAnimations)for(let t=0;t<this._children.length;t++){let s=this._children[t];s.weightedSpeed=s.animTrack.duration/s.absoluteSpeed/e}}}});var W0,sj=m(()=>{Ne();me();yT();W0=class o extends xo{static{this._p=new D}static{this._pip=new D}pointDistanceCache(e,t){let s=`${e}${t}`;return this._pointCache[s]||(this._pointCache[s]=this._children[t].point.clone().sub(this._children[e].point)),this._pointCache[s]}calculateWeights(){if(this.updateParameterValues())return;let e,t;o._p.set(...this._parameterValues),e=0,t=0;for(let s=0;s<this._children.length;s++){let i=this._children[s],r=i.point;o._pip.set(o._p.x,o._p.y).sub(r);let a=Number.MAX_VALUE;for(let n=0;n<this._children.length;n++){if(s===n)continue;let l=this.pointDistanceCache(s,n),h=w.clamp(1-o._pip.dot(l)/l.lengthSq(),0,1);h<a&&(a=h)}i.weight=a,e+=a,this._syncAnimations&&(t+=i.animTrack.duration/i.absoluteSpeed*i.weight)}for(let s=0;s<this._children.length;s++){let i=this._children[s];i.weight=i._weight/e,this._syncAnimations&&(i.weightedSpeed=i.animTrack.duration/i.absoluteSpeed/t)}}}});var Y0,ij=m(()=>{Ne();me();yT();Y0=class o extends xo{static{this._p=new D}static{this._pip=new D}pointCache(e,t){let s=`${e}${t}`;return this._pointCache[s]||(this._pointCache[s]=new D((this._children[t].pointLength-this._children[e].pointLength)/((this._children[t].pointLength+this._children[e].pointLength)/2),D.angleRad(this._children[e].point,this._children[t].point)*2)),this._pointCache[s]}calculateWeights(){if(this.updateParameterValues())return;let e,t;o._p.set(...this._parameterValues);let s=o._p.length();e=0,t=0;for(let i=0;i<this._children.length;i++){let r=this._children[i],a=r.point,n=r.pointLength,l=Number.MAX_VALUE;for(let h=0;h<this._children.length;h++){if(i===h)continue;let c=this.pointCache(i,h),f=this._children[h].pointLength;o._pip.set((s-n)/((f+n)/2),D.angleRad(a,o._p)*2);let d=w.clamp(1-Math.abs(o._pip.dot(c)/c.lengthSq()),0,1);d<l&&(l=d)}r.weight=l,e+=l,this._syncAnimations&&(t+=r.animTrack.duration/r.absoluteSpeed*r.weight)}for(let i=0;i<this._children.length;i++){let r=this._children[i];if(r.weight=r._weight/e,this._syncAnimations){let a=r.animTrack.duration/t*e;r.weightedSpeed=r.absoluteSpeed*a}}}}});var K0,rj=m(()=>{yT();K0=class extends xo{calculateWeights(){if(this.updateParameterValues())return;let e=0,t=0;for(let s=0;s<this._children.length;s++)if(e+=Math.max(this._parameterValues[s],0),this._syncAnimations){let i=this._children[s];t+=i.animTrack.duration/i.absoluteSpeed*i.weight}for(let s=0;s<this._children.length;s++){let i=this._children[s],r=Math.max(this._parameterValues[s],0);e?(i.weight=r/e,this._syncAnimations&&(i.weightedSpeed=i.animTrack.duration/i.absoluteSpeed/t)):(i.weight=0,this._syncAnimations&&(i.weightedSpeed=0))}}}});var AT,aj=m(()=>{gl();Sc();tj();sj();ij();rj();H0();AT=class{constructor(e,t,s=1,i=!0,r){this._animations={},this._animationList=[],this._controller=e,this._name=t,this._speed=s,this._loop=i,this._hasAnimations=!1,r?this._blendTree=this._createTree(r.type,this,null,t,1,r.parameter?[r.parameter]:r.parameters,r.children,r.syncAnimations,this._createTree,this._controller.findParameter):this._blendTree=new vo(this,null,t,1,s)}_createTree(e,t,s,i,r,a,n,l,h,c){switch(e){case"1D":return new X0(t,s,i,r,a,n,l,h,c);case O0:return new W0(t,s,i,r,a,n,l,h,c);case D0:return new Y0(t,s,i,r,a,n,l,h,c);case N0:return new K0(t,s,i,r,a,n,l,h,c)}}_getNodeFromPath(e){let t=this._blendTree;for(let s=1;s<e.length;s++)t=t.getChild(e[s]);return t}addAnimation(e,t){let s=e.join("."),i=this._animationList.findIndex(r=>r.path===s);if(i>=0)this._animationList[i].animTrack=t;else{let r=this._getNodeFromPath(e);r.animTrack=t,this._animationList.push(r)}this._updateHasAnimations()}_updateHasAnimations(){this._hasAnimations=this._animationList.length>0&&this._animationList.every(e=>e.animTrack&&e.animTrack!==$s.EMPTY)}get name(){return this._name}set animations(e){this._animationList=e,this._updateHasAnimations()}get animations(){return this._animationList}get hasAnimations(){return this._hasAnimations}set speed(e){this._speed=e}get speed(){return this._speed}set loop(e){this._loop=e}get loop(){return this._loop}get nodeCount(){return!this._blendTree||this._blendTree.constructor===vo?1:this._blendTree.getNodeCount()}get playable(){return _l.indexOf(this.name)!==-1||this.animations.length===this.nodeCount}get looping(){if(this.animations.length>0){let e=`${this.name}.${this.animations[0].animTrack.name}`,t=this._controller.animEvaluator.findClip(e);if(t)return t.loop}return!1}get totalWeight(){let e=0;for(let t=0;t<this.animations.length;t++)e+=this.animations[t].weight;return e}get timelineDuration(){let e=0;for(let t=0;t<this.animations.length;t++){let s=this.animations[t];s.animTrack.duration>e&&(e=s.animTrack.duration)}return e}}});var xc,Kb=m(()=>{Sc();xc=class{constructor({from:e,to:t,time:s=0,priority:i=0,conditions:r=[],exitTime:a=null,transitionOffset:n=null,interruptionSource:l=Dp}){this._from=e,this._to=t,this._time=s,this._priority=i,this._conditions=r,this._exitTime=a,this._transitionOffset=n,this._interruptionSource=l}get from(){return this._from}set to(e){this._to=e}get to(){return this._to}get time(){return this._time}get priority(){return this._priority}get conditions(){return this._conditions}get exitTime(){return this._exitTime}get transitionOffset(){return this._transitionOffset}get interruptionSource(){return this._interruptionSource}get hasExitTime(){return!!this.exitTime}}});var Up,qb=m(()=>{hA();v0();Sc();aj();H0();Kb();Up=class{constructor(e,t,s,i,r,a,n){this._states={},this._stateNames=[],this._findTransitionsFromStateCache={},this._findTransitionsBetweenStatesCache={},this._previousStateName=null,this._activeStateName=gc,this._activeStateDuration=0,this._activeStateDurationDirty=!0,this._playing=!1,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._transitionInterruptionSource=Dp,this._transitionPreviousStates=[],this._timeInState=0,this._timeInStateBefore=0,this.findParameter=l=>this._findParameter(l),this._animEvaluator=e,this._eventHandler=r,this._findParameter=a,this._consumeTrigger=n;for(let l=0;l<t.length;l++)this._states[t[l].name]=new AT(this,t[l].name,t[l].speed,t[l].loop,t[l].blendTree),this._stateNames.push(t[l].name);this._transitions=s.map(l=>new xc({...l})),this._activate=i}get animEvaluator(){return this._animEvaluator}set activeState(e){this._activeStateName=e}get activeState(){return this._findState(this._activeStateName)}get activeStateName(){return this._activeStateName}get activeStateAnimations(){return this.activeState.animations}set previousState(e){this._previousStateName=e}get previousState(){return this._findState(this._previousStateName)}get previousStateName(){return this._previousStateName}get playable(){let e=!0;for(let t=0;t<this._stateNames.length;t++)this._states[this._stateNames[t]].playable||(e=!1);return e}set playing(e){this._playing=e}get playing(){return this._playing}get activeStateProgress(){return this._getActiveStateProgressForTime(this._timeInState)}get activeStateDuration(){if(this._activeStateDurationDirty){let e=0;for(let t=0;t<this.activeStateAnimations.length;t++){let s=this._animEvaluator.findClip(this.activeStateAnimations[t].name);s&&(e=Math.max(e,s.track.duration))}this._activeStateDuration=e,this._activeStateDurationDirty=!1}return this._activeStateDuration}set activeStateCurrentTime(e){this._timeInStateBefore=e,this._timeInState=e;for(let t=0;t<this.activeStateAnimations.length;t++){let s=this.animEvaluator.findClip(this.activeStateAnimations[t].name);s&&(s.time=e)}}get activeStateCurrentTime(){return this._timeInState}get transitioning(){return this._isTransitioning}get transitionProgress(){return this._currTransitionTime/this._totalTransitionTime}get states(){return this._stateNames}assignMask(e){return this._animEvaluator.assignMask(e)}_findState(e){return this._states[e]}_getActiveStateProgressForTime(e){if(this.activeStateName===gc||this.activeStateName==="END"||this.activeStateName==="ANY")return 1;let t=this._animEvaluator.findClip(this.activeStateAnimations[0].name);return t?t.progressForTime(e):null}_findTransitionsFromState(e){let t=this._findTransitionsFromStateCache[e];return t||(t=this._transitions.filter(s=>s.from===e),Yh(t),this._findTransitionsFromStateCache[e]=t),t}_findTransitionsBetweenStates(e,t){let s=this._findTransitionsBetweenStatesCache[`${e}->${t}`];return s||(s=this._transitions.filter(i=>i.from===e&&i.to===t),Yh(s),this._findTransitionsBetweenStatesCache[`${e}->${t}`]=s),s}_transitionHasConditionsMet(e){let t=e.conditions;for(let s=0;s<t.length;s++){let i=t[s],r=this._findParameter(i.parameterName);switch(i.predicate){case R0:if(!(r.value>i.value))return!1;break;case C0:if(!(r.value<i.value))return!1;break;case I0:if(!(r.value>=i.value))return!1;break;case w0:if(!(r.value<=i.value))return!1;break;case L0:if(r.value!==i.value)return!1;break;case b0:if(r.value===i.value)return!1;break}}return!0}_findTransition(e,t){let s=[];if(e&&t)s=s.concat(this._findTransitionsBetweenStates(e,t));else if(!this._isTransitioning)s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState("ANY"));else switch(this._transitionInterruptionSource){case x0:s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState("ANY"));break;case y0:s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState("ANY"));break;case A0:s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState("ANY"));break;case P0:s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState("ANY"));break}if(s=s.filter(i=>{if(i.to===this.activeStateName)return!1;if(i.hasExitTime){let r=this._getActiveStateProgressForTime(this._timeInStateBefore),a=this._getActiveStateProgressForTime(this._timeInState);if(i.exitTime<1&&this.activeState.loop&&(r-=Math.floor(r),a-=Math.floor(a)),a===r){if(a!==i.exitTime)return null}else if(!(i.exitTime>r&&i.exitTime<=a))return null}return this._transitionHasConditionsMet(i)}),s.length>0){let i=s[0];if(i.to==="END"){let r=this._findTransitionsFromState(gc)[0];i.to=r.to}return i}return null}updateStateFromTransition(e){let t,s,i;this.previousState=e.from?this.activeStateName:null,this.activeState=e.to,this._activeStateDurationDirty=!0;for(let h=0;h<e.conditions.length;h++){let c=e.conditions[h];this._findParameter(c.parameterName).type===_c&&this._consumeTrigger(c.parameterName)}if(this.previousState){this._isTransitioning||(this._transitionPreviousStates=[]),this._transitionPreviousStates.push({name:this._previousStateName,weight:1});let h=Math.min(this._totalTransitionTime!==0?this._currTransitionTime/this._totalTransitionTime:1,1);for(let c=0;c<this._transitionPreviousStates.length;c++){this._isTransitioning?c!==this._transitionPreviousStates.length-1?this._transitionPreviousStates[c].weight*=1-h:this._transitionPreviousStates[c].weight=h:this._transitionPreviousStates[c].weight=1,t=this._findState(this._transitionPreviousStates[c].name);for(let f=0;f<t.animations.length;f++)s=t.animations[f],i=this._animEvaluator.findClip(`${s.name}.previous.${c}`),i||(i=this._animEvaluator.findClip(s.name),i.name=`${s.name}.previous.${c}`),c!==this._transitionPreviousStates.length-1&&i.pause()}}this._isTransitioning=!0,this._totalTransitionTime=e.time,this._currTransitionTime=0,this._transitionInterruptionSource=e.interruptionSource;let r=this.activeState,a=e.transitionOffset&&e.transitionOffset>0&&e.transitionOffset<1,n=0,l=0;if(a){let h=r.timelineDuration*e.transitionOffset;n=h,l=h}this._timeInState=n,this._timeInStateBefore=l;for(let h=0;h<r.animations.length;h++){if(i=this._animEvaluator.findClip(r.animations[h].name),i)i.reset();else{let c=Number.isFinite(r.animations[h].speed)?r.animations[h].speed:r.speed;i=new mc(r.animations[h].animTrack,this._timeInState,c,!0,r.loop,this._eventHandler),i.name=r.animations[h].name,this._animEvaluator.addClip(i)}if(e.time>0?i.blendWeight=0:i.blendWeight=r.animations[h].normalizedWeight,i.play(),a)i.time=r.timelineDuration*e.transitionOffset;else{let c=r.speed>=0?0:this.activeStateDuration;i.time=c}}}_transitionToState(e){if(!this._findState(e))return;let t=this._findTransition(this._activeStateName,e);t||(this._animEvaluator.removeClips(),t=new xc({from:null,to:e})),this.updateStateFromTransition(t)}assignAnimation(e,t,s,i){let r=e.split("."),a=this._findState(r[0]);a||(a=new AT(this,r[0],s),this._states[r[0]]=a,this._stateNames.push(r[0])),a.addAnimation(r,t),this._animEvaluator.updateClipTrack(a.name,t),s!==void 0&&(a.speed=s),i!==void 0&&(a.loop=i),!this._playing&&this._activate&&this.playable&&this.play(),this._activeStateDurationDirty=!0}removeNodeAnimations(e){if(_l.indexOf(e)!==-1)return!1;let t=this._findState(e);return t?(t.animations=[],!0):!1}play(e){e&&this._transitionToState(e),this._playing=!0}pause(){this._playing=!1}reset(){this._previousStateName=null,this._activeStateName=gc,this._playing=!1,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._timeInState=0,this._timeInStateBefore=0,this._animEvaluator.removeClips()}rebind(){this._animEvaluator.rebind()}update(e){if(!this._playing)return;let t,s,i;(this.activeState.loop||this._timeInState<this.activeStateDuration)&&(this._timeInStateBefore=this._timeInState,this._timeInState+=e*this.activeState.speed,!this.activeState.loop&&this._timeInState>this.activeStateDuration&&(this._timeInState=this.activeStateDuration,e=this.activeStateDuration-this._timeInStateBefore));let r=this._findTransition(this._activeStateName);if(r&&this.updateStateFromTransition(r),this._isTransitioning)if(this._currTransitionTime+=e,this._currTransitionTime<=this._totalTransitionTime){let a=this._totalTransitionTime!==0?this._currTransitionTime/this._totalTransitionTime:1;for(let n=0;n<this._transitionPreviousStates.length;n++){t=this._findState(this._transitionPreviousStates[n].name);let l=this._transitionPreviousStates[n].weight;for(let h=0;h<t.animations.length;h++)s=t.animations[h],i=this._animEvaluator.findClip(`${s.name}.previous.${n}`),i&&(i.blendWeight=(1-a)*s.normalizedWeight*l)}t=this.activeState;for(let n=0;n<t.animations.length;n++)s=t.animations[n],this._animEvaluator.findClip(s.name).blendWeight=a*s.normalizedWeight}else{this._isTransitioning=!1;let a=this.activeStateAnimations.length,n=this._animEvaluator.clips.length;for(let l=0;l<n-a;l++)this._animEvaluator.removeClip(0);this._transitionPreviousStates=[],t=this.activeState;for(let l=0;l<t.animations.length;l++)s=t.animations[l],i=this._animEvaluator.findClip(s.name),i&&(i.blendWeight=s.normalizedWeight)}else if(this.activeState._blendTree.constructor!==vo){t=this.activeState;for(let a=0;a<t.animations.length;a++)s=t.animations[a],i=this._animEvaluator.findClip(s.name),i&&(i.blendWeight=s.normalizedWeight,s.parent.syncAnimations&&(i.speed=s.speed))}this._animEvaluator.update(e,this.activeState.hasAnimations)}}});var jb,q0,PT,RT,CT,j0,nj=m(()=>{k0();G0();V0();De();Ve();Ne();Q();Ze();jb=new D,q0=new g,PT=new W,RT=new N,CT=new H,j0=class o extends vc{constructor(e,t,s,i,r){super(t),this.animComponent=e,this._mask=i,this.layerName=s,this.layerIndex=r}static _packFloat(e){return e[0]}static _packBoolean(e){return!!e[0]}static _packVec2(e){return jb.x=e[0],jb.y=e[1],jb}static _packVec3(e){return q0.x=e[0],q0.y=e[1],q0.z=e[2],q0}static _packVec4(e){return PT.x=e[0],PT.y=e[1],PT.z=e[2],PT.w=e[3],PT}static _packColor(e){return RT.r=e[0],RT.g=e[1],RT.b=e[2],RT.a=e[3],RT}static _packQuat(e){return CT.x=e[0],CT.y=e[1],CT.z=e[2],CT.w=e[3],CT}resolve(e){let t=Ma.encode(e.entityPath,e.component,e.propertyPath),s=this.targetCache[t];if(s)return s;let i,r,a;switch(e.component){case"entity":i=this._getEntityFromHierarchy(e.entityPath),a=Ma.encode(i.path,"entity",e.propertyPath),r=i;break;case"graph":if(r=this.findNode(e),!r)return null;a=Ma.encode(r.path,"graph",e.propertyPath);break;default:if(i=this._getEntityFromHierarchy(e.entityPath),r=i.findComponent(e.component),!r)return null;a=Ma.encode(i.path,e.component,e.propertyPath);break}return s=this._createAnimTargetForProperty(r,e.propertyPath,a),this.targetCache[t]=s,s}update(e){let t=this.activeNodes;if(t)for(let s=0;s<t.length;s++)t[s]._dirtifyLocal()}_getEntityFromHierarchy(e){if(!this.animComponent.entity.name===e[0])return null;let t=this.animComponent.entity;return e.length===1?t:t._parent.findByPath(e)}_resolvePath(e,t,s){let i=t.length-(s?0:1);for(let r=0;r<i;r++)e=e[t[r]];return e}_setter(e,t,s){let i=this._resolvePath(e,t),r=t[t.length-1],a=`set${r.substring(0,1).toUpperCase()}${r.substring(1)}`;if(i[a]){let h=i[`get${r.substring(0,1).toUpperCase()}${r.substring(1)}`].bind(i)();h=[h.x,h.y,h.z,h.w];let c=i[a].bind(i);return{set:f=>{c(s(f))},get:()=>h}}let n=i[r];if(typeof n=="object"&&n.hasOwnProperty("copy"))return function(l){n.copy(s(l))};if([D,g,W,N,H].indexOf(i.constructor)!==-1&&t.length>1){let l=t.length>2?this._resolvePath(e,t.slice(0,-1)):e,h=t[t.length-2];return function(c){i[r]=s(c),l[h]=i}}return function(l){i[r]=s(l)}}_createAnimTargetForProperty(e,t,s){if(this.handlers&&t[0].startsWith("weight."))return this.handlers.weight(e,t[0].replace("weight.",""));if(this.handlers&&t[0]==="material"&&t.length===2){let l=t[1];if(l.endsWith("Map"))return this.handlers.materialTexture(e,l)}let i=this._resolvePath(e,t,!0);if(typeof i>"u")return null;let r,a,n;if(typeof i=="number")r=this._setter(e,t,o._packFloat),a="vector",n=1;else if(typeof i=="boolean")r=this._setter(e,t,o._packBoolean),a="vector",n=1;else if(typeof i=="object")switch(i.constructor){case D:r=this._setter(e,t,o._packVec2),a="vector",n=2;break;case g:r=this._setter(e,t,o._packVec3),a="vector",n=3;break;case W:r=this._setter(e,t,o._packVec4),a="vector",n=4;break;case N:r=this._setter(e,t,o._packColor),a="vector",n=4;break;case H:r=this._setter(e,t,o._packQuat),a="quaternion",n=4;break;default:return null}return t.indexOf("material")!==-1?new Sl(l=>{r(l),e.material.update()},a,n,s):new Sl(r,a,n,s)}rebind(){this.targetCache={},this.animComponent.rootBone?this.graph=this.animComponent.rootBone:this.graph=this.animComponent.entity;let e={},t=function(s){e[s.name]=s;for(let i=0;i<s.children.length;++i)t(s.children[i])};t(this.graph),this.nodes=e}}});var Bp,$b=m(()=>{me();gl();Kb();Sc();Bp=class{constructor(e,t,s,i=1,r=Op){this._mask=null,this._blendTime=0,this._blendTimeElapsed=0,this._startingWeight=0,this._targetWeight=0,this._name=e,this._controller=t,this._component=s,this._weight=i,this._blendType=r}get name(){return this._name}set playing(e){this._controller.playing=e}get playing(){return this._controller.playing}get playable(){return this._controller.playable}get activeState(){return this._controller.activeStateName}get previousState(){return this._controller.previousStateName}get activeStateProgress(){return this._controller.activeStateProgress}get activeStateDuration(){return this._controller.activeStateDuration}set activeStateCurrentTime(e){let t=this._controller,s=t.playing;t.playing=!0,t.activeStateCurrentTime=e,s||t.update(0),t.playing=s}get activeStateCurrentTime(){return this._controller.activeStateCurrentTime}get transitioning(){return this._controller.transitioning}get transitionProgress(){return this.transitioning?this._controller.transitionProgress:null}get states(){return this._controller.states}set weight(e){this._weight=e,this._component.dirtifyTargets()}get weight(){return this._weight}set blendType(e){e!==this._blendType&&(this._blendType=e,this._controller.normalizeWeights&&this._component.rebind())}get blendType(){return this._blendType}set mask(e){this._controller.assignMask(e)&&this._component.rebind(),this._mask=e}get mask(){return this._mask}play(e){this._controller.play(e)}pause(){this._controller.pause()}reset(){this._controller.reset()}rebind(){this._controller.rebind()}update(e){this._blendTime&&(this._blendTimeElapsed<this._blendTime?(this.weight=w.lerp(this._startingWeight,this._targetWeight,this._blendTimeElapsed/this._blendTime),this._blendTimeElapsed+=e):(this.weight=this._targetWeight,this._blendTime=0,this._blendTimeElapsed=0,this._startingWeight=0,this._targetWeight=0)),this._controller.update(e)}blendToWeight(e,t){this._startingWeight=this.weight,this._targetWeight=e,this._blendTime=Math.max(0,t),this._blendTimeElapsed=0}assignAnimation(e,t,s,i){t instanceof $s&&(this._controller.assignAnimation(e,t,s,i),this._controller._transitions.length===0&&this._controller._transitions.push(new xc({from:"START",to:e})),this._component.activate&&this._component.playable&&(this._component.playing=!0))}removeNodeAnimations(e){this._controller.removeNodeAnimations(e)&&(this._component.playing=!1)}getAnimationAsset(e){return this._component.animationAssets[`${this.name}:${e}`]}transition(e,t=0,s=null){this._controller.updateStateFromTransition(new xc({from:this._controller.activeStateName,to:e,time:t,transitionOffset:s}))}}});var yo,$0=m(()=>{yo=class{constructor(e){if(this._layers=[],this._parameters={},Array.isArray(e.layers))this._layers=e.layers;else for(let t in e.layers){let s=e.layers[t],i={name:s.name,blendType:s.blendType,weight:s.weight,states:[],transitions:[]};for(let r=0;r<s.states.length;r++)i.states.push(e.states[s.states[r]]);for(let r=0;r<s.transitions.length;r++){let a=e.transitions[s.transitions[r]];if(a.conditions&&!Array.isArray(a.conditions)){let n=Object.keys(a.conditions),l=[];for(let h=0;h<n.length;h++){let c=a.conditions[n[h]];c.parameterName&&l.push(c)}a.conditions=l}Number.isInteger(a.from)&&(a.from=e.states[a.from].name),Number.isInteger(a.to)&&(a.to=e.states[a.to].name),i.transitions.push(a)}this._layers.push(i)}for(let t in e.parameters){let s=e.parameters[t];this._parameters[s.name]={type:s.type,value:s.value}}}get parameters(){return Object.assign({},this._parameters)}get layers(){return this._layers}}});var cd,Zb=m(()=>{rt();U0();qb();We();nj();$b();$0();ci();Sc();gl();cd=class extends ae{set stateGraphAsset(e){if(e===null){this.removeStateGraph();return}this._stateGraphAsset&&this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this);let t,s;e instanceof re?(t=e.id,s=this.system.app.assets.get(t),s||(this.system.app.assets.add(e),s=this.system.app.assets.get(t))):(t=e,s=this.system.app.assets.get(t)),!(!s||this._stateGraphAsset===t)&&(s.resource?(this._stateGraph=s.resource,this.loadStateGraph(this._stateGraph),s.on("change",this._onStateGraphAssetChangeEvent,this)):(s.once("load",i=>{this._stateGraph=i.resource,this.loadStateGraph(this._stateGraph)}),s.on("change",this._onStateGraphAssetChangeEvent,this),this.system.app.assets.load(s)),this._stateGraphAsset=t)}get stateGraphAsset(){return this._stateGraphAsset}set normalizeWeights(e){this._normalizeWeights=e,this.unbind()}get normalizeWeights(){return this._normalizeWeights}set animationAssets(e){this._animationAssets=e,this.loadAnimationAssets()}get animationAssets(){return this._animationAssets}set speed(e){this._speed=e}get speed(){return this._speed}set activate(e){this._activate=e}get activate(){return this._activate}set playing(e){this._playing=e}get playing(){return this._playing}set rootBone(e){if(typeof e=="string"){let t=this.entity.root.findByGuid(e);this._rootBone=t}else e instanceof be?this._rootBone=e:this._rootBone=null;this.rebind()}get rootBone(){return this._rootBone}set stateGraph(e){this._stateGraph=e}get stateGraph(){return this._stateGraph}get layers(){return this._layers}set layerIndices(e){this._layerIndices=e}get layerIndices(){return this._layerIndices}set parameters(e){this._parameters=e}get parameters(){return this._parameters}set targets(e){this._targets=e}get targets(){return this._targets}get playable(){for(let e=0;e<this._layers.length;e++)if(!this._layers[e].playable)return!1;return!0}get baseLayer(){return this._layers.length>0?this._layers[0]:null}_onStateGraphAssetChangeEvent(e){let t=this.animationAssets,s=this.layers.map(i=>i.mask);this.removeStateGraph(),this._stateGraph=new yo(e._data),this.loadStateGraph(this._stateGraph),this.animationAssets=t,this.loadAnimationAssets(),this.layers.forEach((i,r)=>{i.mask=s[r]}),this.rebind()}dirtifyTargets(){let e=Object.values(this._targets);for(let t=0;t<e.length;t++)e[t].dirty=!0}_addLayer({name:e,states:t,transitions:s,weight:i,mask:r,blendType:a}){let n;this.rootBone?n=this.rootBone:n=this.entity;let l=this._layers.length,h=new j0(this,n,e,r,l),c=new Tc(h),f=new Up(c,t,s,this._activate,this,this.findParameter,this.consumeTrigger);return this._layers.push(new Bp(e,f,this,i,a)),this._layerIndices[e]=l,this._layers[l]}addLayer(e,t,s,i){let r=this.findAnimationLayer(e);if(r)return r;let a=[{name:"START",speed:1}],n=[];return this._addLayer({name:e,states:a,transitions:n,weight:t,mask:s,blendType:i})}_assignParameters(e){this._parameters={};let t=Object.keys(e.parameters);for(let s=0;s<t.length;s++){let i=t[s];this._parameters[i]={type:e.parameters[i].type,value:e.parameters[i].value}}}loadStateGraph(e){this._stateGraph=e,this._assignParameters(e),this._layers=[];let t=!1;for(let s=0;s<e.layers.length;s++){let i=e.layers[s];this._addLayer({...i}),i.states.some(r=>r.blendTree)&&(t=!0)}t||this.setupAnimationAssets()}setupAnimationAssets(){for(let e=0;e<this._layers.length;e++){let t=this._layers[e],s=t.name;for(let i=0;i<t.states.length;i++){let r=t.states[i];if(_l.indexOf(r)===-1){let a=`${s}:${r}`;this._animationAssets[a]||(this._animationAssets[a]={asset:null})}}}this.loadAnimationAssets()}loadAnimationAssets(){for(let e=0;e<this._layers.length;e++){let t=this._layers[e];for(let s=0;s<t.states.length;s++){let i=t.states[s];if(_l.indexOf(i)!==-1)continue;let r=this._animationAssets[`${t.name}:${i}`];if(!r||!r.asset){this.findAnimationLayer(t.name).assignAnimation(i,$s.EMPTY);continue}let a=r.asset,n=this.system.app.assets.get(a);n&&(n.resource?this.onAnimationAssetLoaded(t.name,i,n):(n.once("load",function(l,h){return function(c){this.onAnimationAssetLoaded(l,h,c)}.bind(this)}.bind(this)(t.name,i)),this.system.app.assets.load(n)))}}}onAnimationAssetLoaded(e,t,s){this.findAnimationLayer(e).assignAnimation(t,s.resource)}removeStateGraph(){this._stateGraph=null,this._stateGraphAsset=null,this._animationAssets={},this._layers=[],this._layerIndices={},this._parameters={},this._playing=!1,this.unbind(),this._targets={}}reset(){this._assignParameters(this._stateGraph);for(let e=0;e<this._layers.length;e++){let t=this._layers[e].playing;this._layers[e].reset(),this._layers[e].playing=t}}unbind(){this._normalizeWeights||Object.keys(this._targets).forEach(e=>{this._targets[e].unbind()})}rebind(){this._targets={};for(let e=0;e<this._layers.length;e++)this._layers[e].rebind()}findAnimationLayer(e){let t=this._layerIndices[e];return this._layers[t]||null}addAnimationState(e,t,s=1,i=!0,r="Base"){this._stateGraph||this.loadStateGraph(new yo({layers:[{name:r,states:[{name:"START",speed:1},{name:e,speed:s,loop:i,defaultState:!0}],transitions:[{from:"START",to:e}]}],parameters:{}}));let a=this.findAnimationLayer(r);a?a.assignAnimation(e,t,s,i):this.addLayer(r)?.assignAnimation(e,t,s,i)}assignAnimation(e,t,s,i=1,r=!0){if(!this._stateGraph&&e.indexOf(".")===-1){this.loadStateGraph(new yo({layers:[{name:"Base",states:[{name:"START",speed:1},{name:e,speed:i,loop:r,defaultState:!0}],transitions:[{from:"START",to:e}]}],parameters:{}})),this.baseLayer.assignAnimation(e,t);return}let a=s?this.findAnimationLayer(s):this.baseLayer;a&&a.assignAnimation(e,t,i,r)}removeNodeAnimations(e,t){let s=t?this.findAnimationLayer(t):this.baseLayer;s&&s.removeNodeAnimations(e)}getParameterValue(e,t){let s=this._parameters[e];if(s&&s.type===t)return s.value}setParameterValue(e,t,s){let i=this._parameters[e];if(i&&i.type===t){i.value=s;return}}getFloat(e){return this.getParameterValue(e,ET)}setFloat(e,t){this.setParameterValue(e,ET,t)}getInteger(e){return this.getParameterValue(e,TT)}setInteger(e,t){typeof t=="number"&&t%1===0&&this.setParameterValue(e,TT,t)}getBoolean(e){return this.getParameterValue(e,vT)}setBoolean(e,t){this.setParameterValue(e,vT,!!t)}getTrigger(e){return this.getParameterValue(e,_c)}setTrigger(e,t=!1){this.setParameterValue(e,_c,!0),t&&this._consumedTriggers.add(e)}resetTrigger(e){this.setParameterValue(e,_c,!1)}onBeforeRemove(){Number.isFinite(this._stateGraphAsset)&&this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this)}update(e){for(let t=0;t<this.layers.length;t++)this.layers[t].update(e*this.speed);this._consumedTriggers.forEach(t=>{this.parameters[t].value=!1}),this._consumedTriggers.clear()}resolveDuplicatedEntityReferenceProperties(e,t){e.rootBone&&t[e.rootBone.getGuid()]?this.rootBone=t[e.rootBone.getGuid()]:this.rebind()}constructor(...e){super(...e),this._stateGraphAsset=null,this._animationAssets={},this._speed=1,this._activate=!0,this._playing=!1,this._rootBone=null,this._stateGraph=null,this._layers=[],this._layerIndices={},this._parameters={},this._targets={},this._consumedTriggers=new Set,this._normalizeWeights=!1,this.findParameter=t=>this._parameters[t],this.consumeTrigger=t=>{this._consumedTriggers.add(t)}}}});var Z0,oj=m(()=>{Z0=class{constructor(){this.enabled=!0}}});var Qb,Vp,Jb=m(()=>{gl();We();Ut();Zb();oj();Qb=["enabled"],Vp=class extends Me{constructor(e){super(e),this.id="anim",this.ComponentType=cd,this.DataType=Z0,this.schema=Qb,this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("animationUpdate",this.onAnimationUpdate,this)}initializeComponentData(e,t,s){super.initializeComponentData(e,t,Qb);let i=["animationAssets","stateGraph","layers","masks"];Object.keys(t).forEach(r=>{i.includes(r)||(e[r]=t[r])}),t.stateGraph&&(e.stateGraph=t.stateGraph,e.loadStateGraph(e.stateGraph)),t.layers&&t.layers.forEach((r,a)=>{r._controller.states.forEach(n=>{r._controller._states[n]._animationList.forEach(l=>{if(!l.animTrack||l.animTrack===$s.EMPTY){let h=this.app.assets.get(r._component._animationAssets[`${r.name}:${l.name}`].asset);h&&!h.loaded&&h.once("load",()=>{e.layers[a].assignAnimation(l.name,h.resource)})}else e.layers[a].assignAnimation(l.name,l.animTrack)})})}),t.animationAssets&&(e.animationAssets=Object.assign(e.animationAssets,t.animationAssets)),t.masks&&Object.keys(t.masks).forEach(r=>{if(e.layers[r]){let a=t.masks[r].mask,n={};Object.keys(a).forEach(l=>{n[decodeURI(l)]=a[l]}),e.layers[r].mask=n}})}onAnimationUpdate(e){let t=this.store;for(let s in t)if(t.hasOwnProperty(s)){let i=t[s].entity.anim;i.data.enabled&&i.entity.enabled&&i.playing&&i.update(e)}}cloneComponent(e,t){let s;(!e.anim.rootBone||e.anim.rootBone===e)&&(s={},e.anim.layers.forEach((r,a)=>{if(r.mask){let n={};Object.keys(r.mask).forEach(l=>{let h=l.split("/");h.shift();let c=[t.name,...h].join("/");n[c]=r.mask[l]}),s[a]={mask:n}}}));let i={enabled:e.anim.enabled,stateGraphAsset:e.anim.stateGraphAsset,animationAssets:e.anim.animationAssets,speed:e.anim.speed,activate:e.anim.activate,playing:e.anim.playing,rootBone:e.anim.rootBone,stateGraph:e.anim.stateGraph,layers:e.anim.layers,layerIndices:e.anim.layerIndices,parameters:e.anim.parameters,normalizeWeights:e.anim.normalizeWeights,masks:s};return this.addComponent(t,i)}onBeforeRemove(e,t){t.onBeforeRemove()}destroy(){super.destroy(),this.app.systems.off("animationUpdate",this.onAnimationUpdate,this)}};ae._buildAccessors(cd.prototype,Qb)});var fd,eM=m(()=>{We();fd=class extends ae{setCurrentListener(){if(this.enabled&&this.entity.audiolistener&&this.entity.enabled){this.system.current=this.entity;let e=this.system.current.getPosition();this.system.manager.listener.setPosition(e)}}onEnable(){this.setCurrentListener()}onDisable(){this.system.current===this.entity&&(this.system.current=null)}}});var Q0,lj=m(()=>{Q0=class{constructor(){this.enabled=!0}}});var hj,kp,tM=m(()=>{We();Ut();eM();lj();hj=["enabled"],kp=class extends Me{constructor(e){super(e),this.id="audiolistener",this.ComponentType=fd,this.DataType=Q0,this.schema=hj,this.manager=e.soundManager,this.current=null,this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(e,t,s){s=["enabled"],super.initializeComponentData(e,t,s)}onUpdate(e){if(this.current){let t=this.current.getPosition();this.manager.listener.setPosition(t);let s=this.current.getWorldTransform();this.manager.listener.setOrientation(s)}}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}};ae._buildAccessors(fd.prototype,hj)});var IT,J0,cj=m(()=>{IT=0,J0=1});var yc,dd,Gp,Ac,eP,tP,zp=m(()=>{yc="group",dd="image",Gp="text",Ac="stretch",eP="contain",tP="cover"});function fj(o){return new N(o.r,o.g,o.b)}var ts,wT,LT,bT,Hp,sM=m(()=>{ql();me();De();Zt();We();zp();ts={DEFAULT:"DEFAULT",HOVER:"HOVER",PRESSED:"PRESSED",INACTIVE:"INACTIVE"},wT={};wT[ts.DEFAULT]="_defaultTint";wT[ts.HOVER]="hoverTint";wT[ts.PRESSED]="pressedTint";wT[ts.INACTIVE]="inactiveTint";LT={};LT[ts.DEFAULT]="_defaultSpriteAsset";LT[ts.HOVER]="hoverSpriteAsset";LT[ts.PRESSED]="pressedSpriteAsset";LT[ts.INACTIVE]="inactiveSpriteAsset";bT={};bT[ts.DEFAULT]="_defaultSpriteFrame";bT[ts.HOVER]="hoverSpriteFrame";bT[ts.PRESSED]="pressedSpriteFrame";bT[ts.INACTIVE]="inactiveSpriteFrame";Hp=class extends ae{static{this.EVENT_MOUSEDOWN="mousedown"}static{this.EVENT_MOUSEUP="mouseup"}static{this.EVENT_MOUSEENTER="mouseenter"}static{this.EVENT_MOUSELEAVE="mouseleave"}static{this.EVENT_CLICK="click"}static{this.EVENT_TOUCHSTART="touchstart"}static{this.EVENT_TOUCHEND="touchend"}static{this.EVENT_TOUCHCANCEL="touchcancel"}static{this.EVENT_TOUCHLEAVE="touchleave"}static{this.EVENT_SELECTSTART="selectstart"}static{this.EVENT_SELECTEND="selectend"}static{this.EVENT_SELECTENTER="selectenter"}static{this.EVENT_SELECTLEAVE="selectleave"}static{this.EVENT_HOVERSTART="hoverstart"}static{this.EVENT_HOVEREND="hoverend"}static{this.EVENT_PRESSEDSTART="pressedstart"}static{this.EVENT_PRESSEDEND="pressedend"}constructor(e,t){super(e,t),this._visualState=ts.DEFAULT,this._isHovering=!1,this._hoveringCounter=0,this._isPressed=!1,this._defaultTint=new N(1,1,1,1),this._defaultSpriteAsset=null,this._defaultSpriteFrame=0,this._imageEntity=null,this._evtElementAdd=null,this._evtImageEntityElementAdd=null,this._evtImageEntityElementRemove=null,this._evtImageEntityElementColor=null,this._evtImageEntityElementOpacity=null,this._evtImageEntityElementSpriteAsset=null,this._evtImageEntityElementSpriteFrame=null,this._visualState=ts.DEFAULT,this._isHovering=!1,this._hoveringCounter=0,this._isPressed=!1,this._defaultTint=new N(1,1,1,1),this._defaultSpriteAsset=null,this._defaultSpriteFrame=0,this._toggleLifecycleListeners("on",e)}get data(){let e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){this._setValue("enabled",e)}get enabled(){return this.data.enabled}set active(e){this._setValue("active",e)}get active(){return this.data.active}set imageEntity(e){if(this._imageEntity!==e){let t=typeof e=="string";if(this._imageEntity&&t&&this._imageEntity.getGuid()===e)return;this._imageEntity&&this._imageEntityUnsubscribe(),e instanceof Ae?this._imageEntity=e:t?this._imageEntity=this.system.app.getEntityFromIndex(e)||null:this._imageEntity=null,this._imageEntity&&this._imageEntitySubscribe(),this._imageEntity?this.data.imageEntity=this._imageEntity.getGuid():t&&e&&(this.data.imageEntity=e)}}get imageEntity(){return this._imageEntity}set hitPadding(e){this._setValue("hitPadding",e)}get hitPadding(){return this.data.hitPadding}set transitionMode(e){this._setValue("transitionMode",e)}get transitionMode(){return this.data.transitionMode}set hoverTint(e){this._setValue("hoverTint",e)}get hoverTint(){return this.data.hoverTint}set pressedTint(e){this._setValue("pressedTint",e)}get pressedTint(){return this.data.pressedTint}set inactiveTint(e){this._setValue("inactiveTint",e)}get inactiveTint(){return this.data.inactiveTint}set fadeDuration(e){this._setValue("fadeDuration",e)}get fadeDuration(){return this.data.fadeDuration}set hoverSpriteAsset(e){this._setValue("hoverSpriteAsset",e)}get hoverSpriteAsset(){return this.data.hoverSpriteAsset}set hoverSpriteFrame(e){this._setValue("hoverSpriteFrame",e)}get hoverSpriteFrame(){return this.data.hoverSpriteFrame}set pressedSpriteAsset(e){this._setValue("pressedSpriteAsset",e)}get pressedSpriteAsset(){return this.data.pressedSpriteAsset}set pressedSpriteFrame(e){this._setValue("pressedSpriteFrame",e)}get pressedSpriteFrame(){return this.data.pressedSpriteFrame}set inactiveSpriteAsset(e){this._setValue("inactiveSpriteAsset",e)}get inactiveSpriteAsset(){return this.data.inactiveSpriteAsset}set inactiveSpriteFrame(e){this._setValue("inactiveSpriteFrame",e)}get inactiveSpriteFrame(){return this.data.inactiveSpriteFrame}_setValue(e,t){let s=this.data,i=s[e];s[e]=t,this.fire("set",e,i,t)}_toggleLifecycleListeners(e,t){this[e]("set_active",this._onSetActive,this),this[e]("set_transitionMode",this._onSetTransitionMode,this),this[e]("set_hoverTint",this._onSetTransitionValue,this),this[e]("set_pressedTint",this._onSetTransitionValue,this),this[e]("set_inactiveTint",this._onSetTransitionValue,this),this[e]("set_hoverSpriteAsset",this._onSetTransitionValue,this),this[e]("set_hoverSpriteFrame",this._onSetTransitionValue,this),this[e]("set_pressedSpriteAsset",this._onSetTransitionValue,this),this[e]("set_pressedSpriteFrame",this._onSetTransitionValue,this),this[e]("set_inactiveSpriteAsset",this._onSetTransitionValue,this),this[e]("set_inactiveSpriteFrame",this._onSetTransitionValue,this),e==="on"?this._evtElementAdd=this.entity.on("element:add",this._onElementComponentAdd,this):(this._evtElementAdd?.off(),this._evtElementAdd=null)}_onSetActive(e,t,s){t!==s&&this._updateVisualState()}_onSetTransitionMode(e,t,s){t!==s&&(this._cancelTween(),this._resetToDefaultVisualState(t),this._forceReapplyVisualState())}_onSetTransitionValue(e,t,s){t!==s&&this._forceReapplyVisualState()}_imageEntitySubscribe(){this._evtImageEntityElementAdd=this._imageEntity.on("element:add",this._onImageElementGain,this),this._imageEntity.element&&this._onImageElementGain()}_imageEntityUnsubscribe(){this._evtImageEntityElementAdd?.off(),this._evtImageEntityElementAdd=null,this._imageEntity?.element&&this._onImageElementLose()}_imageEntityElementSubscribe(){let e=this._imageEntity.element;this._evtImageEntityElementRemove=e.once("beforeremove",this._onImageElementLose,this),this._evtImageEntityElementColor=e.on("set:color",this._onSetColor,this),this._evtImageEntityElementOpacity=e.on("set:opacity",this._onSetOpacity,this),this._evtImageEntityElementSpriteAsset=e.on("set:spriteAsset",this._onSetSpriteAsset,this),this._evtImageEntityElementSpriteFrame=e.on("set:spriteFrame",this._onSetSpriteFrame,this)}_imageEntityElementUnsubscribe(){this._evtImageEntityElementRemove?.off(),this._evtImageEntityElementRemove=null,this._evtImageEntityElementColor?.off(),this._evtImageEntityElementColor=null,this._evtImageEntityElementOpacity?.off(),this._evtImageEntityElementOpacity=null,this._evtImageEntityElementSpriteAsset?.off(),this._evtImageEntityElementSpriteAsset=null,this._evtImageEntityElementSpriteFrame?.off(),this._evtImageEntityElementSpriteFrame=null}_onElementComponentRemove(){this._toggleHitElementListeners("off")}_onElementComponentAdd(){this._toggleHitElementListeners("on")}_onImageElementLose(){this._imageEntityElementUnsubscribe(),this._cancelTween(),this._resetToDefaultVisualState(this.transitionMode)}_onImageElementGain(){this._imageEntityElementSubscribe(),this._storeDefaultVisualState(),this._forceReapplyVisualState()}_toggleHitElementListeners(e){if(this.entity.element){let t=e==="on";if(t&&this._hasHitElementListeners)return;this.entity.element[e]("beforeremove",this._onElementComponentRemove,this),this.entity.element[e]("mouseenter",this._onMouseEnter,this),this.entity.element[e]("mouseleave",this._onMouseLeave,this),this.entity.element[e]("mousedown",this._onMouseDown,this),this.entity.element[e]("mouseup",this._onMouseUp,this),this.entity.element[e]("touchstart",this._onTouchStart,this),this.entity.element[e]("touchend",this._onTouchEnd,this),this.entity.element[e]("touchleave",this._onTouchLeave,this),this.entity.element[e]("touchcancel",this._onTouchCancel,this),this.entity.element[e]("selectstart",this._onSelectStart,this),this.entity.element[e]("selectend",this._onSelectEnd,this),this.entity.element[e]("selectenter",this._onSelectEnter,this),this.entity.element[e]("selectleave",this._onSelectLeave,this),this.entity.element[e]("click",this._onClick,this),this._hasHitElementListeners=t}}_storeDefaultVisualState(){let e=this._imageEntity?.element;!e||e.type===yc||(this._storeDefaultColor(e.color),this._storeDefaultOpacity(e.opacity),this._storeDefaultSpriteAsset(e.spriteAsset),this._storeDefaultSpriteFrame(e.spriteFrame))}_storeDefaultColor(e){this._defaultTint.r=e.r,this._defaultTint.g=e.g,this._defaultTint.b=e.b}_storeDefaultOpacity(e){this._defaultTint.a=e}_storeDefaultSpriteAsset(e){this._defaultSpriteAsset=e}_storeDefaultSpriteFrame(e){this._defaultSpriteFrame=e}_onSetColor(e){this._isApplyingTint||(this._storeDefaultColor(e),this._forceReapplyVisualState())}_onSetOpacity(e){this._isApplyingTint||(this._storeDefaultOpacity(e),this._forceReapplyVisualState())}_onSetSpriteAsset(e){this._isApplyingSprite||(this._storeDefaultSpriteAsset(e),this._forceReapplyVisualState())}_onSetSpriteFrame(e){this._isApplyingSprite||(this._storeDefaultSpriteFrame(e),this._forceReapplyVisualState())}_onMouseEnter(e){this._isHovering=!0,this._updateVisualState(),this._fireIfActive("mouseenter",e)}_onMouseLeave(e){this._isHovering=!1,this._isPressed=!1,this._updateVisualState(),this._fireIfActive("mouseleave",e)}_onMouseDown(e){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("mousedown",e)}_onMouseUp(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("mouseup",e)}_onTouchStart(e){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("touchstart",e)}_onTouchEnd(e){e.event.preventDefault(),this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchend",e)}_onTouchLeave(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchleave",e)}_onTouchCancel(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchcancel",e)}_onSelectStart(e){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("selectstart",e)}_onSelectEnd(e){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("selectend",e)}_onSelectEnter(e){this._hoveringCounter++,this._hoveringCounter===1&&(this._isHovering=!0,this._updateVisualState()),this._fireIfActive("selectenter",e)}_onSelectLeave(e){this._hoveringCounter--,this._hoveringCounter===0&&(this._isHovering=!1,this._isPressed=!1,this._updateVisualState()),this._fireIfActive("selectleave",e)}_onClick(e){this._fireIfActive("click",e)}_fireIfActive(e,t){this.data.active&&this.fire(e,t)}_updateVisualState(e){let t=this._visualState,s=this._determineVisualState();if((t!==s||e)&&this.enabled)switch(this._visualState=s,t===ts.HOVER&&this._fireIfActive("hoverend"),t===ts.PRESSED&&this._fireIfActive("pressedend"),s===ts.HOVER&&this._fireIfActive("hoverstart"),s===ts.PRESSED&&this._fireIfActive("pressedstart"),this.transitionMode){case 0:{let i=wT[this._visualState],r=this[i];this._applyTint(r);break}case 1:{let i=LT[this._visualState],r=bT[this._visualState],a=this[i],n=this[r];this._applySprite(a,n);break}}}_forceReapplyVisualState(){this._updateVisualState(!0)}_resetToDefaultVisualState(e){if(this._imageEntity?.element)switch(e){case 0:this._cancelTween(),this._applyTintImmediately(this._defaultTint);break;case 1:this._applySprite(this._defaultSpriteAsset,this._defaultSpriteFrame);break}}_determineVisualState(){if(this.active){if(this._isPressed)return ts.PRESSED;if(this._isHovering)return ts.HOVER}else return ts.INACTIVE;return ts.DEFAULT}_applySprite(e,t){let s=this._imageEntity?.element;s&&(t=t||0,this._isApplyingSprite=!0,s.spriteAsset!==e&&(s.spriteAsset=e),s.spriteFrame!==t&&(s.spriteFrame=t),this._isApplyingSprite=!1)}_applyTint(e){this._cancelTween(),this.fadeDuration===0?this._applyTintImmediately(e):this._applyTintWithTween(e)}_applyTintImmediately(e){let t=this._imageEntity?.element;if(!e||!t||t.type===yc)return;let s=fj(e);this._isApplyingTint=!0,s.equals(t.color)||(t.color=s),t.opacity!==e.a&&(t.opacity=e.a),this._isApplyingTint=!1}_applyTintWithTween(e){let t=this._imageEntity?.element;if(!e||!t||t.type===yc)return;let s=fj(e),i=t.color,r=t.opacity;s.equals(i)&&e.a===r||(this._tweenInfo={startTime:Us(),from:new N(i.r,i.g,i.b,r),to:e.clone(),lerpColor:new N})}_updateTintTween(){let e=Us()-this._tweenInfo.startTime,t=this.fadeDuration===0?1:e/this.fadeDuration;if(t=w.clamp(t,0,1),Math.abs(t-1)>1e-5){let s=this._tweenInfo.lerpColor;s.lerp(this._tweenInfo.from,this._tweenInfo.to,t),this._applyTintImmediately(new N(s.r,s.g,s.b,s.a))}else this._applyTintImmediately(this._tweenInfo.to),this._cancelTween()}_cancelTween(){delete this._tweenInfo}onUpdate(){this._tweenInfo&&this._updateTintTween()}onEnable(){this._isHovering=!1,this._hoveringCounter=0,this._isPressed=!1,this._toggleHitElementListeners("on"),this._forceReapplyVisualState()}onDisable(){this._toggleHitElementListeners("off"),this._resetToDefaultVisualState(this.transitionMode)}onRemove(){this._imageEntityUnsubscribe(),this._toggleLifecycleListeners("off",this.system),this.onDisable()}resolveDuplicatedEntityReferenceProperties(e,t){e.imageEntity&&(this.imageEntity=t[e.imageEntity.getGuid()])}}});var sP,dj=m(()=>{De();Ze();sP=class{constructor(){this.enabled=!0,this.active=!0,this.imageEntity=null,this.hitPadding=new W,this.transitionMode=0,this.hoverTint=new N(.75,.75,.75),this.pressedTint=new N(.5,.5,.5),this.inactiveTint=new N(.25,.25,.25),this.fadeDuration=0,this.hoverSpriteAsset=null,this.hoverSpriteFrame=0,this.pressedSpriteAsset=null,this.pressedSpriteFrame=0,this.inactiveSpriteAsset=null,this.inactiveSpriteFrame=0}}});var uj,Xp,iM=m(()=>{Ut();sM();dj();uj=["enabled","active",{name:"hitPadding",type:"vec4"},"transitionMode",{name:"hoverTint",type:"rgba"},{name:"pressedTint",type:"rgba"},{name:"inactiveTint",type:"rgba"},"fadeDuration","hoverSpriteAsset","hoverSpriteFrame","pressedSpriteAsset","pressedSpriteFrame","inactiveSpriteAsset","inactiveSpriteFrame"],Xp=class extends Me{constructor(e){super(e),this.id="button",this.ComponentType=Hp,this.DataType=sP,this.schema=uj,this.on("beforeremove",this._onRemoveComponent,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(e,t,s){e.imageEntity=t.imageEntity,super.initializeComponentData(e,t,uj)}onUpdate(e){let t=this.store;for(let s in t){let i=t[s].entity,r=i.button;r.enabled&&i.enabled&&r.onUpdate()}}_onRemoveComponent(e,t){t.onRemove()}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}});var mj,pj,Wp,rM=m(()=>{Ve();Q();rt();We();mj=new g,pj=new H,Wp=class extends ae{static{this.EVENT_CONTACT="contact"}static{this.EVENT_COLLISIONSTART="collisionstart"}static{this.EVENT_COLLISIONEND="collisionend"}static{this.EVENT_TRIGGERENTER="triggerenter"}static{this.EVENT_TRIGGERLEAVE="triggerleave"}constructor(e,t){super(e,t),this._compoundParent=null,this._hasOffset=!1,this.entity.on("insert",this._onInsert,this),this.on("set_type",this.onSetType,this),this.on("set_convexHull",this.onSetModel,this),this.on("set_halfExtents",this.onSetHalfExtents,this),this.on("set_linearOffset",this.onSetOffset,this),this.on("set_angularOffset",this.onSetOffset,this),this.on("set_radius",this.onSetRadius,this),this.on("set_height",this.onSetHeight,this),this.on("set_axis",this.onSetAxis,this),this.on("set_asset",this.onSetAsset,this),this.on("set_renderAsset",this.onSetRenderAsset,this),this.on("set_model",this.onSetModel,this),this.on("set_render",this.onSetRender,this)}get data(){let e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){this._setValue("enabled",e)}get enabled(){return this.data.enabled}set type(e){this._setValue("type",e)}get type(){return this.data.type}set halfExtents(e){this._setValue("halfExtents",e)}get halfExtents(){return this.data.halfExtents}set linearOffset(e){this._setValue("linearOffset",e)}get linearOffset(){return this.data.linearOffset}set angularOffset(e){this._setValue("angularOffset",e)}get angularOffset(){return this.data.angularOffset}set radius(e){this._setValue("radius",e)}get radius(){return this.data.radius}set axis(e){this._setValue("axis",e)}get axis(){return this.data.axis}set height(e){this._setValue("height",e)}get height(){return this.data.height}set asset(e){this._setValue("asset",e)}get asset(){return this.data.asset}set renderAsset(e){this._setValue("renderAsset",e)}get renderAsset(){return this.data.renderAsset}set convexHull(e){this._setValue("convexHull",e)}get convexHull(){return this.data.convexHull}set shape(e){this._setValue("shape",e)}get shape(){return this.data.shape}set model(e){this._setValue("model",e)}get model(){return this.data.model}set render(e){this._setValue("render",e)}get render(){return this.data.render}set checkVertexDuplicates(e){this._setValue("checkVertexDuplicates",e)}get checkVertexDuplicates(){return this.data.checkVertexDuplicates}_setValue(e,t){let s=this.data,i=s[e];s[e]=t,this.fire("set",e,i,t)}onSetType(e,t,s){t!==s&&this.system.changeType(this,t,s)}onSetHalfExtents(e,t,s){let i=this.data.type;this.data.initialized&&i==="box"&&this.system.recreatePhysicalShapes(this)}onSetOffset(e,t,s){this._hasOffset=!this.data.linearOffset.equals(g.ZERO)||!this.data.angularOffset.equals(H.IDENTITY),this.data.initialized&&this.system.recreatePhysicalShapes(this)}onSetRadius(e,t,s){let i=this.data.type;this.data.initialized&&(i==="sphere"||i==="capsule"||i==="cylinder"||i==="cone")&&this.system.recreatePhysicalShapes(this)}onSetHeight(e,t,s){let i=this.data.type;this.data.initialized&&(i==="capsule"||i==="cylinder"||i==="cone")&&this.system.recreatePhysicalShapes(this)}onSetAxis(e,t,s){let i=this.data.type;this.data.initialized&&(i==="capsule"||i==="cylinder"||i==="cone")&&this.system.recreatePhysicalShapes(this)}onSetAsset(e,t,s){let i=this.system.app.assets;if(t){let r=i.get(t);r&&r.off("remove",this.onAssetRemoved,this)}if(s){s instanceof re&&(this.data.asset=s.id);let r=i.get(this.data.asset);r&&(r.off("remove",this.onAssetRemoved,this),r.on("remove",this.onAssetRemoved,this))}this.data.initialized&&this.data.type==="mesh"&&(s||(this.data.model=null),this.system.recreatePhysicalShapes(this))}onSetRenderAsset(e,t,s){let i=this.system.app.assets;if(t){let r=i.get(t);r&&r.off("remove",this.onRenderAssetRemoved,this)}if(s){s instanceof re&&(this.data.renderAsset=s.id);let r=i.get(this.data.renderAsset);r&&(r.off("remove",this.onRenderAssetRemoved,this),r.on("remove",this.onRenderAssetRemoved,this))}this.data.initialized&&this.data.type==="mesh"&&(s||(this.data.render=null),this.system.recreatePhysicalShapes(this))}onSetModel(e,t,s){this.data.initialized&&this.data.type==="mesh"&&this.system.implementations.mesh.doRecreatePhysicalShape(this)}onSetRender(e,t,s){this.onSetModel(e,t,s)}onAssetRemoved(e){e.off("remove",this.onAssetRemoved,this),this.data.asset===e.id&&(this.asset=null)}onRenderAssetRemoved(e){e.off("remove",this.onRenderAssetRemoved,this),this.data.renderAsset===e.id&&(this.renderAsset=null)}getCompoundChildShapeIndex(e){let t=this.data.shape,s=t.getNumChildShapes();for(let i=0;i<s;i++){let r=t.getChildShape(i);if(Ammo.getPointer(r)===Ammo.getPointer(e))return i}return null}_onInsert(e){if(!(typeof Ammo>"u")){if(this._compoundParent)this.system.recreatePhysicalShapes(this);else if(!this.entity.rigidbody){let t=this.entity.parent;for(;t;){if(t.collision&&t.collision.type==="compound"){t.collision.shape.getNumChildShapes()===0?this.system.recreatePhysicalShapes(t.collision):this.system.recreatePhysicalShapes(this);break}t=t.parent}}}}_updateCompound(){let e=this.entity;if(e._dirtyWorld){let t=e._dirtyLocal,s=e;for(;s&&!t&&!(s.collision&&s.collision===this._compoundParent);)s._dirtyLocal&&(t=!0),s=s.parent;if(t){e.forEach(this.system.implementations.compound._updateEachDescendantTransform,e);let i=this._compoundParent.entity.rigidbody;i&&i.activate()}}}getShapePosition(){let e=this.entity.getPosition();if(this._hasOffset){let t=this.entity.getRotation(),s=this.data.linearOffset;return pj.copy(t).transformVector(s,mj),mj.add(e)}return e}getShapeRotation(){let e=this.entity.getRotation();return this._hasOffset?pj.copy(e).mul(this.data.angularOffset):e}onEnable(){if(this.data.type==="mesh"&&(this.data.asset||this.data.renderAsset)&&this.data.initialized){let e=this.system.app.assets.get(this.data.asset||this.data.renderAsset);if(e&&(!e.resource||!this.data.shape)){this.system.recreatePhysicalShapes(this);return}}if(this.entity.rigidbody)this.entity.rigidbody.enabled&&this.entity.rigidbody.enableSimulation();else if(this._compoundParent&&this!==this._compoundParent)if(this._compoundParent.shape.getNumChildShapes()===0)this.system.recreatePhysicalShapes(this._compoundParent);else{let e=this.system._getNodeTransform(this.entity,this._compoundParent.entity);this._compoundParent.shape.addChildShape(e,this.data.shape),Ammo.destroy(e),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()}else this.entity.trigger&&this.entity.trigger.enable()}onDisable(){this.entity.rigidbody?this.entity.rigidbody.disableSimulation():this._compoundParent&&this!==this._compoundParent?this._compoundParent.entity._destroying||(this.system._removeCompoundChild(this._compoundParent,this.data.shape),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()):this.entity.trigger&&this.entity.trigger.disable()}onBeforeRemove(){this.asset&&(this.asset=null),this.renderAsset&&(this.renderAsset=null),this.entity.off("insert",this._onInsert,this),this.off()}}});var iP,_j=m(()=>{Ve();Q();iP=class{constructor(){this.enabled=!0,this.type="box",this.halfExtents=new g(.5,.5,.5),this.linearOffset=new g,this.angularOffset=new H,this.radius=.5,this.axis=1,this.height=2,this.convexHull=!1,this.asset=null,this.renderAsset=null,this.checkVertexDuplicates=!0,this.shape=null,this.model=null,this.render=null,this.initialized=!1}}});var Ao,yi,fn,rP,Yp,Tl,Pc,aP,nP,ud,md,gj,Sj,oP,MT,lP,Tj,hP,Ej,vj,xj,yj,Aj,Pj,Rj,Cj,Ij,wj,Lj,DT,bj,Kp,Mj,cP=m(()=>{Ao="static",yi="dynamic",fn="kinematic",rP=1,Yp=2,Tl=4,Pc=1,aP=2,nP=3,ud=4,md=5,gj=0,Sj=1,oP=1,MT=2,lP=4,Tj=8,hP=16,Ej=32,vj=64,xj=128,yj=256,Aj=512,Pj=1024,Rj=2048,Cj=4096,Ij=8192,wj=16384,Lj=0,DT=65535,bj=2,Kp=65533,Mj=65529});var dn,pd,qp,OT,Dj=m(()=>{OT=class{constructor(e,t,s){this.entity=t.entity,this.component=t,this.app=e,typeof Ammo<"u"&&!dn&&(dn=new Ammo.btVector3,pd=new Ammo.btQuaternion,qp=new Ammo.btTransform),this.initialize(s)}initialize(e){let t=this.entity,s=e.shape;if(s&&typeof Ammo<"u"){t.trigger&&t.trigger.destroy();let i=1,r=this.component;if(r){let n=r.getShapePosition(),l=r.getShapeRotation();dn.setValue(n.x,n.y,n.z),pd.setValue(l.x,l.y,l.z,l.w)}else{let n=t.getPosition(),l=t.getRotation();dn.setValue(n.x,n.y,n.z),pd.setValue(l.x,l.y,l.z,l.w)}qp.setOrigin(dn),qp.setRotation(pd);let a=this.app.systems.rigidbody.createBody(i,s,qp);a.setRestitution(0),a.setFriction(0),a.setDamping(0,0),dn.setValue(0,0,0),a.setLinearFactor(dn),a.setAngularFactor(dn),a.setCollisionFlags(a.getCollisionFlags()|4),a.entity=t,this.body=a,this.component.enabled&&t.enabled&&this.enable()}}destroy(){this.body&&(this.disable(),this.app.systems.rigidbody.destroyBody(this.body),this.body=null)}_getEntityTransform(e){let t=this.component;if(t){let s=t.getShapePosition(),i=t.getShapeRotation();dn.setValue(s.x,s.y,s.z),pd.setValue(i.x,i.y,i.z,i.w)}else{let s=this.entity.getPosition(),i=this.entity.getRotation();dn.setValue(s.x,s.y,s.z),pd.setValue(i.x,i.y,i.z,i.w)}e.setOrigin(dn),e.setRotation(pd)}updateTransform(){this._getEntityTransform(qp);let e=this.body;e.setWorldTransform(qp),e.activate()}enable(){let e=this.body;if(!e)return;let t=this.app.systems.rigidbody;t._triggers.indexOf(this)<0&&(t.addBody(e,16,65517),t._triggers.push(this)),e.forceActivationState(1),this.updateTransform()}disable(){let e=this.body;if(!e)return;let t=this.app.systems.rigidbody,s=t._triggers.indexOf(this);s>-1&&(t.removeBody(e),t._triggers.splice(s,1)),e.forceActivationState(5)}}});var fP,soe,ioe,_d,Oj,roe,El,aM,nM,oM,lM,hM,cM,fM,jp,dM=m(()=>{Ke();Ve();Q();j();Zt();ll();Ut();rM();_j();Dj();fP=new k,soe=new g,ioe=new g,_d=new H,Oj=new Ae,roe=["enabled","type","halfExtents","linearOffset","angularOffset","radius","axis","height","convexHull","asset","renderAsset","shape","model","render","checkVertexDuplicates"],El=class{constructor(e){this.system=e}beforeInitialize(e,t){t.shape=null,t.model=new Ys,t.model.graph=new Ae}afterInitialize(e,t){this.recreatePhysicalShapes(e),e.data.initialized=!0}reset(e,t){this.beforeInitialize(e,t),this.afterInitialize(e,t)}recreatePhysicalShapes(e){let t=e.entity,s=e.data;if(typeof Ammo<"u"){t.trigger&&(t.trigger.destroy(),delete t.trigger),s.shape&&(e._compoundParent&&(e!==e._compoundParent&&this.system._removeCompoundChild(e._compoundParent,s.shape),e._compoundParent.entity.rigidbody&&e._compoundParent.entity.rigidbody.activate()),this.destroyShape(s)),s.shape=this.createPhysicalShape(e.entity,s);let i=!e._compoundParent;if(s.type==="compound"&&(!e._compoundParent||e===e._compoundParent))e._compoundParent=e,t.forEach(this._addEachDescendant,e);else if(s.type!=="compound"&&!e.rigidbody){e._compoundParent=null;let r=t.parent;for(;r;){if(r.collision&&r.collision.type==="compound"){e._compoundParent=r.collision;break}r=r.parent}}e._compoundParent&&e!==e._compoundParent&&(i&&e._compoundParent.shape.getNumChildShapes()===0?this.system.recreatePhysicalShapes(e._compoundParent):(this.system.updateCompoundChildTransform(t,!0),e._compoundParent.entity.rigidbody&&e._compoundParent.entity.rigidbody.activate())),t.rigidbody?(t.rigidbody.disableSimulation(),t.rigidbody.createBody(),t.enabled&&t.rigidbody.enabled&&t.rigidbody.enableSimulation()):e._compoundParent||(t.trigger?t.trigger.initialize(s):t.trigger=new OT(this.system.app,e,s))}}createPhysicalShape(e,t){}updateTransform(e,t,s,i){e.entity.trigger&&e.entity.trigger.updateTransform()}destroyShape(e){e.shape&&(Ammo.destroy(e.shape),e.shape=null)}beforeRemove(e,t){t.data.shape&&(t._compoundParent&&!t._compoundParent.entity._destroying&&(this.system._removeCompoundChild(t._compoundParent,t.data.shape),t._compoundParent.entity.rigidbody&&t._compoundParent.entity.rigidbody.activate()),t._compoundParent=null,this.destroyShape(t.data))}remove(e,t){e.rigidbody&&e.rigidbody.body&&e.rigidbody.disableSimulation(),e.trigger&&(e.trigger.destroy(),delete e.trigger)}clone(e,t){let s=this.system.store[e.getGuid()],i={enabled:s.data.enabled,type:s.data.type,halfExtents:[s.data.halfExtents.x,s.data.halfExtents.y,s.data.halfExtents.z],linearOffset:[s.data.linearOffset.x,s.data.linearOffset.y,s.data.linearOffset.z],angularOffset:[s.data.angularOffset.x,s.data.angularOffset.y,s.data.angularOffset.z,s.data.angularOffset.w],radius:s.data.radius,axis:s.data.axis,height:s.data.height,convexHull:s.data.convexHull,asset:s.data.asset,renderAsset:s.data.renderAsset,model:s.data.model,render:s.data.render,checkVertexDuplicates:s.data.checkVertexDuplicates};return this.system.addComponent(t,i)}},aM=class extends El{createPhysicalShape(e,t){if(typeof Ammo<"u"){let s=t.halfExtents,i=new Ammo.btVector3(s?s.x:.5,s?s.y:.5,s?s.z:.5),r=new Ammo.btBoxShape(i);return Ammo.destroy(i),r}}},nM=class extends El{createPhysicalShape(e,t){if(typeof Ammo<"u")return new Ammo.btSphereShape(t.radius)}},oM=class extends El{createPhysicalShape(e,t){let s=t.axis??1,i=t.radius??.5,r=Math.max((t.height??2)-2*i,0),a=null;if(typeof Ammo<"u")switch(s){case 0:a=new Ammo.btCapsuleShapeX(i,r);break;case 1:a=new Ammo.btCapsuleShape(i,r);break;case 2:a=new Ammo.btCapsuleShapeZ(i,r);break}return a}},lM=class extends El{createPhysicalShape(e,t){let s=t.axis??1,i=t.radius??.5,r=t.height??1,a=null,n=null;if(typeof Ammo<"u")switch(s){case 0:a=new Ammo.btVector3(r*.5,i,i),n=new Ammo.btCylinderShapeX(a);break;case 1:a=new Ammo.btVector3(i,r*.5,i),n=new Ammo.btCylinderShape(a);break;case 2:a=new Ammo.btVector3(i,i,r*.5),n=new Ammo.btCylinderShapeZ(a);break}return a&&Ammo.destroy(a),n}},hM=class extends El{createPhysicalShape(e,t){let s=t.axis??1,i=t.radius??.5,r=t.height??1,a=null;if(typeof Ammo<"u")switch(s){case 0:a=new Ammo.btConeShapeX(i,r);break;case 1:a=new Ammo.btConeShape(i,r);break;case 2:a=new Ammo.btConeShapeZ(i,r);break}return a}},cM=class extends El{beforeInitialize(e,t){}createAmmoHull(e,t,s,i){let r=new Ammo.btConvexHullShape,a=new Ammo.btVector3,n=[];e.getPositions(n);for(let h=0;h<n.length;h+=3)a.setValue(n[h]*i.x,n[h+1]*i.y,n[h+2]*i.z),r.addPoint(a,!1);Ammo.destroy(a),r.recalcLocalAabb(),r.setMargin(.01);let l=this.system._getNodeTransform(t);s.addChildShape(l,r),Ammo.destroy(l)}createAmmoMesh(e,t,s,i,r=!0){let a=this.system,n;if(a._triMeshCache[e.id])n=a._triMeshCache[e.id];else{let c=e.vertexBuffer,f=c.getFormat(),d,u;for(let O=0;O<f.elements.length;O++){let M=f.elements[O];if(M.name===te){u=new Float32Array(c.lock(),M.offset),d=M.stride/4;break}}let p=[];e.getIndices(p);let _=e.primitive[0].count/3,S=new Ammo.btVector3,T,x,A,E=e.primitive[0].base;n=new Ammo.btTriangleMesh,a._triMeshCache[e.id]=n;let v=new Map,R=n.getIndexedMeshArray();R.at(0).m_numTriangles=_;let P=i?i.x:1,y=i?i.y:1,C=i?i.z:1,L=O=>{let M=u[O*d]*P,U=u[O*d+1]*y,G=u[O*d+2]*C,$;if(r){let X=`${M}:${U}:${G}`;if($=v.get(X),$!==void 0)return $;S.setValue(M,U,G),$=n.findOrAddVertex(S,!1),v.set(X,$)}else S.setValue(M,U,G),$=n.findOrAddVertex(S,!1);return $};for(let O=0;O<_;O++)T=L(p[E+O*3]),x=L(p[E+O*3+1]),A=L(p[E+O*3+2]),n.addIndex(T),n.addIndex(x),n.addIndex(A);Ammo.destroy(S)}let l=new Ammo.btBvhTriangleMeshShape(n,!0);if(!i){let c=a._getNodeScaling(t);l.setLocalScaling(c),Ammo.destroy(c)}let h=a._getNodeTransform(t);s.addChildShape(h,l),Ammo.destroy(h)}createPhysicalShape(e,t){if(!(typeof Ammo>"u")&&(t.model||t.render)){let s=new Ammo.btCompoundShape,r=e.getWorldTransform().getScale();if(t.render){let a=t.render.meshes;for(let n=0;n<a.length;n++)t.convexHull?this.createAmmoHull(a[n],Oj,s,r):this.createAmmoMesh(a[n],Oj,s,r,t.checkVertexDuplicates)}else if(t.model){let a=t.model.meshInstances;for(let l=0;l<a.length;l++)this.createAmmoMesh(a[l].mesh,a[l].node,s,null,t.checkVertexDuplicates);let n=new Ammo.btVector3(r.x,r.y,r.z);s.setLocalScaling(n),Ammo.destroy(n)}return s}}recreatePhysicalShapes(e){let t=e.data;if((t.renderAsset||t.asset)&&e.enabled&&e.entity.enabled){this.loadAsset(e,t.renderAsset||t.asset,t.renderAsset?"render":"model");return}this.doRecreatePhysicalShape(e)}loadAsset(e,t,s){let i=e.data,r=this.system.app.assets,a=i[s],n=c=>{i[s]===a&&(i[s]=c.resource,this.doRecreatePhysicalShape(e))},l=c=>{c.ready(f=>{if(f.data.containerAsset){let d=r.get(f.data.containerAsset);d.loaded?n(f):(d.ready(()=>{n(f)}),r.load(d))}else n(f)}),r.load(c)},h=r.get(t);h?l(h):r.once(`add:${t}`,l)}doRecreatePhysicalShape(e){let t=e.entity,s=e.data;s.model||s.render?(this.destroyShape(s),s.shape=this.createPhysicalShape(t,s),t.rigidbody?(t.rigidbody.disableSimulation(),t.rigidbody.createBody(),t.enabled&&t.rigidbody.enabled&&t.rigidbody.enableSimulation()):t.trigger?t.trigger.initialize(s):t.trigger=new OT(this.system.app,e,s)):(this.beforeRemove(t,e),this.remove(t,s))}updateTransform(e,t,s,i){if(e.shape){let a=e.entity.getWorldTransform().getScale(),n=e.shape.getLocalScaling();(a.x!==n.x()||a.y!==n.y()||a.z!==n.z())&&this.doRecreatePhysicalShape(e)}super.updateTransform(e,t,s,i)}destroyShape(e){if(!e.shape)return;let t=e.shape.getNumChildShapes();for(let s=0;s<t;s++){let i=e.shape.getChildShape(s);Ammo.destroy(i)}Ammo.destroy(e.shape),e.shape=null}},fM=class extends El{createPhysicalShape(e,t){if(typeof Ammo<"u")return new Ammo.btCompoundShape}_addEachDescendant(e){!e.collision||e.rigidbody||(e.collision._compoundParent=this,e!==this.entity&&e.collision.system.recreatePhysicalShapes(e.collision))}_updateEachDescendant(e){e.collision&&e.collision._compoundParent===this&&(e.collision._compoundParent=null,e!==this.entity&&!e.rigidbody&&e.collision.system.recreatePhysicalShapes(e.collision))}_updateEachDescendantTransform(e){!e.collision||e.collision._compoundParent!==this.collision._compoundParent||this.collision.system.updateCompoundChildTransform(e,!1)}},jp=class extends Me{constructor(e){super(e),this.id="collision",this.ComponentType=Wp,this.DataType=iP,this.schema=roe,this.implementations={},this._triMeshCache={},this.on("beforeremove",this.onBeforeRemove,this),this.on("remove",this.onRemove,this)}initializeComponentData(e,t,s){s=["type","halfExtents","radius","axis","height","convexHull","shape","model","asset","render","renderAsset","enabled","linearOffset","angularOffset","checkVertexDuplicates"];let i={};for(let n=0,l=s.length;n<l;n++){let h=s[n];i[h]=t[h]}let r;if(t.hasOwnProperty("asset")?(r=s.indexOf("model"),r!==-1&&s.splice(r,1),r=s.indexOf("render"),r!==-1&&s.splice(r,1)):t.hasOwnProperty("model")&&(r=s.indexOf("asset"),r!==-1&&s.splice(r,1)),i.type||(i.type=e.data.type),e.data.type=i.type,Array.isArray(i.halfExtents)&&(i.halfExtents=new g(i.halfExtents)),Array.isArray(i.linearOffset)&&(i.linearOffset=new g(i.linearOffset)),Array.isArray(i.angularOffset)){let n=i.angularOffset;n.length===3?i.angularOffset=new H().setFromEulerAngles(n[0],n[1],n[2]):i.angularOffset=new H(i.angularOffset)}let a=this._createImplementation(i.type);a.beforeInitialize(e,i),super.initializeComponentData(e,i,s),a.afterInitialize(e,i)}_createImplementation(e){if(this.implementations[e]===void 0){let t;switch(e){case"box":t=new aM(this);break;case"sphere":t=new nM(this);break;case"capsule":t=new oM(this);break;case"cylinder":t=new lM(this);break;case"cone":t=new hM(this);break;case"mesh":t=new cM(this);break;case"compound":t=new fM(this);break}this.implementations[e]=t}return this.implementations[e]}_getImplementation(e){return this.implementations[e.collision.data.type]}cloneComponent(e,t){return this._getImplementation(e).clone(e,t)}onBeforeRemove(e,t){this.implementations[t.data.type].beforeRemove(e,t),t.onBeforeRemove()}onRemove(e,t){this.implementations[t.type].remove(e,t)}updateCompoundChildTransform(e,t){let s=e.collision._compoundParent;if(s!==e.collision&&e.enabled&&e.collision.enabled&&(e._dirtyLocal||t)){let i=this._getNodeTransform(e,s.entity),r=s.getCompoundChildShapeIndex(e.collision.shape);r===null?s.shape.addChildShape(i,e.collision.data.shape):s.shape.updateChildTransform(r,i,!0),Ammo.destroy(i)}}_removeCompoundChild(e,t){if(e.shape.getNumChildShapes()!==0)if(e.shape.removeChildShape)e.shape.removeChildShape(t);else{let s=e.getCompoundChildShapeIndex(t);s!==null&&e.shape.removeChildShapeByIndex(s)}}onTransformChanged(e,t,s,i){this.implementations[e.data.type].updateTransform(e,t,s,i)}changeType(e,t,s){this.implementations[t].beforeRemove(e.entity,e),this.implementations[t].remove(e.entity,e.data),this._createImplementation(s).reset(e,e.data)}recreatePhysicalShapes(e){this.implementations[e.data.type].recreatePhysicalShapes(e)}_calculateNodeRelativeTransform(e,t){if(e===t){let s=e.getWorldTransform().getScale();fP.setScale(s.x,s.y,s.z)}else this._calculateNodeRelativeTransform(e.parent,t),fP.mul(e.getLocalTransform())}_getNodeScaling(e){let s=e.getWorldTransform().getScale();return new Ammo.btVector3(s.x,s.y,s.z)}_getNodeTransform(e,t){let s,i;t?(this._calculateNodeRelativeTransform(e,t),s=soe,i=_d,fP.getTranslation(s),i.setFromMat4(fP)):(s=e.getPosition(),i=e.getRotation());let r=new Ammo.btQuaternion,a=new Ammo.btTransform;a.setIdentity();let n=a.getOrigin(),l=e.collision;if(l&&l._hasOffset){let h=l.data.linearOffset,c=l.data.angularOffset,f=ioe;_d.copy(i).transformVector(h,f),f.add(s),_d.copy(i).mul(c),n.setValue(f.x,f.y,f.z),r.setValue(_d.x,_d.y,_d.z,_d.w)}else n.setValue(s.x,s.y,s.z),r.setValue(i.x,i.y,i.z,i.w);return a.setRotation(r),Ammo.destroy(r),a}destroy(){for(let e in this._triMeshCache)Ammo.destroy(this._triMeshCache[e]);this._triMeshCache=null,super.destroy()}}});var dP,aoe,uM,$p,mM=m(()=>{me();De();Ne();Q();Ze();j();$i();Cr();bi();J();Zt();Ws();_s();ll();gf();zp();rt();dP=new N,aoe=new st,uM=class{constructor(e,t,s){this._entity=e,this._element=e.element,this.model=new Ys,this.node=new Ae,this.model.graph=this.node,this.mesh=t,this.meshInstance=new Oe(this.mesh,s,this.node),this.meshInstance.name=`ImageElement: ${e.name}`,this.meshInstance.castShadow=!1,this.meshInstance.receiveShadow=!1,this._meshDirty=!1,this.model.meshInstances.push(this.meshInstance),this._entity.addChild(this.model.graph),this.model._entity=this._entity,this.unmaskMeshInstance=null}destroy(){this.setMaterial(null),this._element.removeModelFromLayers(this.model),this.model.destroy(),this.model=null,this.node=null,this.mesh=null,this.meshInstance?.destroy(),this.meshInstance=null,this.unmaskMeshInstance?.destroy(),this.unmaskMeshInstance=null,this._entity=null,this._element=null}setMesh(e){this.meshInstance&&(this.mesh=e,this.meshInstance.mesh=e,this.meshInstance.visible=!!e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.mesh=e),this.forceUpdateAabb())}setMask(e){if(this.meshInstance){if(this._entity.enabled&&this._element.enabled&&this._element.removeModelFromLayers(this.model),e){this.unmaskMeshInstance=new Oe(this.mesh,this.meshInstance.material,this.node),this.unmaskMeshInstance.name=`Unmask: ${this._entity.name}`,this.unmaskMeshInstance.castShadow=!1,this.unmaskMeshInstance.receiveShadow=!1,this.unmaskMeshInstance.pick=!1,this.model.meshInstances.push(this.unmaskMeshInstance);for(let t in this.meshInstance.parameters)this.unmaskMeshInstance.setParameter(t,this.meshInstance.parameters[t].data)}else{let t=this.model.meshInstances.indexOf(this.unmaskMeshInstance);t>=0&&this.model.meshInstances.splice(t,1)}this._entity.enabled&&this._element.enabled&&this._element.addModelToLayers(this.model),e||(this.unmaskMeshInstance?.destroy(),this.unmaskMeshInstance=null)}}setMaterial(e){this.meshInstance&&(this.meshInstance.material=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.material=e))}setParameter(e,t){this.meshInstance&&(this.meshInstance.setParameter(e,t),this.unmaskMeshInstance&&this.unmaskMeshInstance.setParameter(e,t))}deleteParameter(e){this.meshInstance&&(this.meshInstance.deleteParameter(e),this.unmaskMeshInstance&&this.unmaskMeshInstance.deleteParameter(e))}setUnmaskDrawOrder(){if(!this.meshInstance)return;let e=function(t){let s,i=t.children,r=i.length;if(r){for(let n=0;n<r;n++)i[n].element&&(s=i[n]);if(!s)return null;let a=e(s);return a||s}return null};if(this.unmaskMeshInstance){let t=e(this._entity);t&&t.element?this.unmaskMeshInstance.drawOrder=t.element.drawOrder+t.element.getMaskOffset():this.unmaskMeshInstance.drawOrder=this.meshInstance.drawOrder+this._element.getMaskOffset()}}setDrawOrder(e){this.meshInstance&&(this.meshInstance.drawOrder=e)}setCull(e){if(!this.meshInstance)return;let t=this._element,s=null;e&&t._isScreenSpace()&&(s=function(i){return t.isVisibleForCamera(i)}),this.meshInstance.cull=e,this.meshInstance.isVisibleFunc=s,this.unmaskMeshInstance&&(this.unmaskMeshInstance.cull=e,this.unmaskMeshInstance.isVisibleFunc=s)}setScreenSpace(e){this.meshInstance&&(this.meshInstance.screenSpace=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.screenSpace=e))}setLayer(e){this.meshInstance&&(this.meshInstance.layer=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.layer=e))}forceUpdateAabb(e){this.meshInstance&&(this.meshInstance._aabbVer=-1,this.unmaskMeshInstance&&(this.unmaskMeshInstance._aabbVer=-1))}setAabbFunc(e){this.meshInstance&&(this.meshInstance._updateAabbFunc=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance._updateAabbFunc=e))}},$p=class{constructor(e){this._evtSetMeshes=null,this._element=e,this._entity=e.entity,this._system=e.system,this._textureAsset=null,this._texture=null,this._materialAsset=null,this._material=null,this._spriteAsset=null,this._sprite=null,this._spriteFrame=0,this._pixelsPerUnit=null,this._targetAspectRatio=-1,this._rect=new W(0,0,1,1),this._mask=!1,this._maskRef=0,this._outerScale=new D,this._outerScaleUniform=new Float32Array(2),this._innerOffset=new W,this._innerOffsetUniform=new Float32Array(4),this._atlasRect=new W,this._atlasRectUniform=new Float32Array(4),this._defaultMesh=this._createMesh(),this._renderable=new uM(this._entity,this._defaultMesh,this._material),this._color=new N(1,1,1,1),this._colorUniform=new Float32Array([1,1,1]),this._updateRenderableEmissive(),this._renderable.setParameter("material_opacity",1),this._updateAabbFunc=this._updateAabb.bind(this),this._onScreenChange(this._element.screen),this._element.on("resize",this._onParentResizeOrPivotChange,this),this._element.on("set:pivot",this._onParentResizeOrPivotChange,this),this._element.on("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.on("set:screen",this._onScreenChange,this),this._element.on("set:draworder",this._onDrawOrderChange,this),this._element.on("screen:set:resolution",this._onResolutionChange,this)}destroy(){this.textureAsset=null,this.spriteAsset=null,this.materialAsset=null,this._renderable.setMesh(this._defaultMesh),this._renderable.destroy(),this._defaultMesh=null,this._element.off("resize",this._onParentResizeOrPivotChange,this),this._element.off("set:pivot",this._onParentResizeOrPivotChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("screen:set:resolution",this._onResolutionChange,this)}_onResolutionChange(e){}_onParentResizeOrPivotChange(){this._renderable.mesh&&this._updateMesh(this._renderable.mesh)}_onScreenSpaceChange(e){this._updateMaterial(e)}_onScreenChange(e,t){e?this._updateMaterial(e.screen.screenSpace):this._updateMaterial(!1)}_onDrawOrderChange(e){this._renderable.setDrawOrder(e),this.mask&&this._element.screen&&this._element.screen.screen.once("syncdraworder",function(){this._renderable.setUnmaskDrawOrder()},this)}_hasUserMaterial(){return!!this._materialAsset||!!this._material&&this._system.defaultImageMaterials.indexOf(this._material)===-1}_use9Slicing(){return this.sprite&&(this.sprite.renderMode===Et||this.sprite.renderMode===vt)}_updateMaterial(e){let t=!!this._mask,s=!!(this.sprite&&this.sprite.renderMode===Et),i=!!(this.sprite&&this.sprite.renderMode===vt);this._hasUserMaterial()||(this._material=this._system.getImageElementMaterial(e,t,s,i)),this._renderable&&(this._renderable.setCull(!this._element._isScreenSpace()||this._element._isScreenCulled()),this._renderable.setMaterial(this._material),this._renderable.setScreenSpace(e),this._renderable.setLayer(e?ly:ym))}_createMesh(){let e=this._element,t=e.calculatedWidth,s=e.calculatedHeight,i=this._rect,r=this._system.app.graphicsDevice,a=new Float32Array([t,0,0,0,0,1,i.x+i.z,1-i.y,t,s,0,0,0,1,i.x+i.z,1-(i.y+i.w),0,0,0,0,0,1,i.x,1-i.y,0,s,0,0,0,1,i.x,1-(i.y+i.w)]),n=aoe.get(r,()=>new Tt(r,[{semantic:te,components:3,type:pe},{semantic:Pt,components:3,type:pe},{semantic:ot,components:2,type:pe}])),l=new mt(r,n,4,{data:a.buffer}),h=new Ce(r);return h.vertexBuffer=l,h.primitive[0].type=rs,h.primitive[0].base=0,h.primitive[0].count=4,h.primitive[0].indexed=!1,h.aabb.setMinMax(g.ZERO,new g(t,s,0)),this._updateMesh(h),h}_updateMesh(e){let t=this._element,s=t.calculatedWidth,i=t.calculatedHeight;if(t.fitMode!==Ac&&this._targetAspectRatio>0){let a=t.calculatedWidth/t.calculatedHeight;t.fitMode===eP&&a>this._targetAspectRatio||t.fitMode===tP&&a<this._targetAspectRatio?s=t.calculatedHeight*this._targetAspectRatio:i=t.calculatedWidth/this._targetAspectRatio}let r=t._isScreenSpace();if(this._updateMaterial(r),this._renderable&&this._renderable.forceUpdateAabb(),this.sprite&&(this.sprite.renderMode===Et||this.sprite.renderMode===vt)){let a=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]],n=2/a.rect.z,l=2/a.rect.w;this._innerOffset.set(a.border.x*n,a.border.y*l,a.border.z*n,a.border.w*l);let h=this.sprite.atlas.texture;this._atlasRect.set(a.rect.x/h.width,a.rect.y/h.height,a.rect.z/h.width,a.rect.w/h.height);let c=this._pixelsPerUnit!==null?this._pixelsPerUnit:this.sprite.pixelsPerUnit,f=a.rect.z/c,d=a.rect.w/c;this._outerScale.set(Math.max(s,this._innerOffset.x*f),Math.max(i,this._innerOffset.y*d));let u=f,p=d;this._outerScale.x/=f,this._outerScale.y/=d,u*=w.clamp(s/(this._innerOffset.x*f),1e-4,1),p*=w.clamp(i/(this._innerOffset.y*d),1e-4,1),this._renderable&&(this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._renderable.setParameter("innerOffset",this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._renderable.setParameter("atlasRect",this._atlasRectUniform),this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._renderable.setParameter("outerScale",this._outerScaleUniform),this._renderable.setAabbFunc(this._updateAabbFunc),this._renderable.node.setLocalScale(u,p,1),this._renderable.node.setLocalPosition((.5-t.pivot.x)*s,(.5-t.pivot.y)*i,0))}else{let a=e.vertexBuffer,n=new Float32Array(a.lock()),l=t.pivot.x,h=t.pivot.y;n[0]=s-l*s,n[1]=0-h*i,n[8]=s-l*s,n[9]=i-h*i,n[16]=0-l*s,n[17]=0-h*i,n[24]=0-l*s,n[25]=i-h*i;let c=1,f=1,d=this._rect;if(this._sprite&&this._sprite.frameKeys[this._spriteFrame]&&this._sprite.atlas){let _=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]];_&&(d=_.rect,c=this._sprite.atlas.texture.width,f=this._sprite.atlas.texture.height)}n[6]=(d.x+d.z)/c,n[7]=1-d.y/f,n[14]=(d.x+d.z)/c,n[15]=1-(d.y+d.w)/f,n[22]=d.x/c,n[23]=1-d.y/f,n[30]=d.x/c,n[31]=1-(d.y+d.w)/f,a.unlock();let u=new g(0-l*s,0-h*i,0),p=new g(s-l*s,i-h*i,0);e.aabb.setMinMax(u,p),this._renderable&&(this._renderable.node.setLocalScale(1,1,1),this._renderable.node.setLocalPosition(0,0,0),this._renderable.setAabbFunc(null))}this._meshDirty=!1}_updateSprite(){let e=!1,t=null;if(this._targetAspectRatio=-1,this._sprite&&this._sprite.atlas){t=this._sprite.meshes[this.spriteFrame],e=this._sprite.renderMode===Et||this._sprite.renderMode===vt;let s=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]];s?.rect.w>0&&(this._targetAspectRatio=s.rect.z/s.rect.w)}this.mesh=e?t:this._defaultMesh,this.refreshMesh()}refreshMesh(){this.mesh&&(this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this.mesh))}_updateAabb(e){return e.center.set(0,0,0),e.halfExtents.set(this._outerScale.x*.5,this._outerScale.y*.5,.001),e.setFromTransformedAabb(e,this._renderable.node.getWorldTransform()),e}_toggleMask(){this._element._dirtifyMask();let e=this._element._isScreenSpace();this._updateMaterial(e),this._renderable.setMask(!!this._mask)}_onMaterialLoad(e){this.material=e.resource}_onMaterialAdded(e){this._system.app.assets.off(`add:${e.id}`,this._onMaterialAdded,this),this._materialAsset===e.id&&this._bindMaterialAsset(e)}_bindMaterialAsset(e){this._entity.enabled&&(e.on("load",this._onMaterialLoad,this),e.on("change",this._onMaterialChange,this),e.on("remove",this._onMaterialRemove,this),e.resource?this._onMaterialLoad(e):this._system.app.assets.load(e))}_unbindMaterialAsset(e){e.off("load",this._onMaterialLoad,this),e.off("change",this._onMaterialChange,this),e.off("remove",this._onMaterialRemove,this)}_onMaterialChange(){}_onMaterialRemove(){}_onTextureAdded(e){this._system.app.assets.off(`add:${e.id}`,this._onTextureAdded,this),this._textureAsset===e.id&&this._bindTextureAsset(e)}_bindTextureAsset(e){this._entity.enabled&&(e.on("load",this._onTextureLoad,this),e.on("change",this._onTextureChange,this),e.on("remove",this._onTextureRemove,this),e.resource?this._onTextureLoad(e):this._system.app.assets.load(e))}_unbindTextureAsset(e){e.off("load",this._onTextureLoad,this),e.off("change",this._onTextureChange,this),e.off("remove",this._onTextureRemove,this)}_onTextureLoad(e){this.texture=e.resource}_onTextureChange(e){}_onTextureRemove(e){}_onSpriteAssetAdded(e){this._system.app.assets.off(`add:${e.id}`,this._onSpriteAssetAdded,this),this._spriteAsset===e.id&&this._bindSpriteAsset(e)}_bindSpriteAsset(e){this._entity.enabled&&(e.on("load",this._onSpriteAssetLoad,this),e.on("change",this._onSpriteAssetChange,this),e.on("remove",this._onSpriteAssetRemove,this),e.resource?this._onSpriteAssetLoad(e):this._system.app.assets.load(e))}_unbindSpriteAsset(e){e.off("load",this._onSpriteAssetLoad,this),e.off("change",this._onSpriteAssetChange,this),e.off("remove",this._onSpriteAssetRemove,this),e.data.textureAtlasAsset&&this._system.app.assets.off(`load:${e.data.textureAtlasAsset}`,this._onTextureAtlasLoad,this)}_onSpriteAssetLoad(e){if(!e||!e.resource)this.sprite=null;else if(e.resource.atlas)this.sprite=e.resource;else{let t=e.data.textureAtlasAsset;if(t){let s=this._system.app.assets;s.off(`load:${t}`,this._onTextureAtlasLoad,this),s.once(`load:${t}`,this._onTextureAtlasLoad,this)}}}_onSpriteAssetChange(e){this._onSpriteAssetLoad(e)}_onSpriteAssetRemove(e){}_bindSprite(e){this._evtSetMeshes=e.on("set:meshes",this._onSpriteMeshesChange,this),e.on("set:pixelsPerUnit",this._onSpritePpuChange,this),e.on("set:atlas",this._onAtlasTextureChange,this),e.atlas&&e.atlas.on("set:texture",this._onAtlasTextureChange,this)}_unbindSprite(e){this._evtSetMeshes?.off(),this._evtSetMeshes=null,e.off("set:pixelsPerUnit",this._onSpritePpuChange,this),e.off("set:atlas",this._onAtlasTextureChange,this),e.atlas&&e.atlas.off("set:texture",this._onAtlasTextureChange,this)}_onSpriteMeshesChange(){this._sprite&&(this._spriteFrame=w.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite()}_onSpritePpuChange(){this.sprite.renderMode!==ni&&this._pixelsPerUnit===null&&this._updateSprite()}_onAtlasTextureChange(){this.sprite&&this.sprite.atlas&&this.sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"))}_onTextureAtlasLoad(e){let t=this._spriteAsset;t instanceof re?this._onSpriteAssetLoad(t):this._onSpriteAssetLoad(this._system.app.assets.get(t))}onEnable(){if(this._materialAsset){let e=this._system.app.assets.get(this._materialAsset);e&&e.resource!==this._material&&this._bindMaterialAsset(e)}if(this._textureAsset){let e=this._system.app.assets.get(this._textureAsset);e&&e.resource!==this._texture&&this._bindTextureAsset(e)}if(this._spriteAsset){let e=this._system.app.assets.get(this._spriteAsset);e&&e.resource!==this._sprite&&this._bindSpriteAsset(e)}this._element.addModelToLayers(this._renderable.model)}onDisable(){this._element.removeModelFromLayers(this._renderable.model)}_setStencil(e){this._renderable.meshInstance.stencilFront=e,this._renderable.meshInstance.stencilBack=e;let t=0;if(this._element.maskedBy&&(t=this._element.maskedBy.element._image._maskRef),this._renderable.unmaskMeshInstance){let s=new ws({ref:t+1,func:2,zpass:yv});this._renderable.unmaskMeshInstance.stencilFront=s,this._renderable.unmaskMeshInstance.stencilBack=s}}_updateRenderableEmissive(){dP.linear(this._color),this._colorUniform[0]=dP.r,this._colorUniform[1]=dP.g,this._colorUniform[2]=dP.b,this._renderable.setParameter("material_emissive",this._colorUniform)}set color(e){let{r:t,g:s,b:i}=e;(this._color.r!==t||this._color.g!==s||this._color.b!==i)&&(this._color.r=t,this._color.g=s,this._color.b=i,this._updateRenderableEmissive()),this._element&&this._element.fire("set:color",this._color)}get color(){return this._color}set opacity(e){e!==this._color.a&&(this._color.a=e,this._renderable.setParameter("material_opacity",e)),this._element&&this._element.fire("set:opacity",e)}get opacity(){return this._color.a}set rect(e){let t,s,i,r;e instanceof W?(t=e.x,s=e.y,i=e.z,r=e.w):(t=e[0],s=e[1],i=e[2],r=e[3]),!(t===this._rect.x&&s===this._rect.y&&i===this._rect.z&&r===this._rect.w)&&(this._rect.set(t,s,i,r),this._renderable.mesh&&(this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this._renderable.mesh)))}get rect(){return this._rect}_removeMaterialAssetEvents(){if(this._materialAsset){let e=this._system.app.assets;e.off(`add:${this._materialAsset}`,this._onMaterialAdded,this);let t=e.get(this._materialAsset);t&&(t.off("load",this._onMaterialLoad,this),t.off("change",this._onMaterialChange,this),t.off("remove",this._onMaterialRemove,this))}}set material(e){if(this._material!==e){if(!e){let t=this._element._isScreenSpace();this.mask?e=t?this._system.defaultScreenSpaceImageMaskMaterial:this._system.defaultImageMaskMaterial:e=t?this._system.defaultScreenSpaceImageMaterial:this._system.defaultImageMaterial}if(this._material=e,this._materialAsset){let t=this._system.app.assets.get(this._materialAsset);(!t||t.resource!==e)&&(this._removeMaterialAssetEvents(),this._materialAsset=null)}e&&(this._renderable.setMaterial(e),this._hasUserMaterial()?(this._renderable.deleteParameter("material_opacity"),this._renderable.deleteParameter("material_emissive")):(this._updateRenderableEmissive(),this._renderable.setParameter("material_opacity",this._color.a)))}}get material(){return this._material}set materialAsset(e){let t=this._system.app.assets,s=e;if(e instanceof re&&(s=e.id),this._materialAsset!==s)if(this._removeMaterialAssetEvents(),this._materialAsset=s,this._materialAsset){let i=t.get(this._materialAsset);i?this._bindMaterialAsset(i):(this._materialAsset=null,this.material=null,this._materialAsset=s,t.on(`add:${this._materialAsset}`,this._onMaterialAdded,this))}else this._materialAsset=null,this.material=null,this._materialAsset=s}get materialAsset(){return this._materialAsset}set texture(e){if(this._texture!==e){if(this._textureAsset){let t=this._system.app.assets.get(this._textureAsset);t&&t.resource!==e&&(this.textureAsset=null)}if(this._texture=e,e){this._spriteAsset&&(this.spriteAsset=null),this._renderable.setParameter("texture_emissiveMap",this._texture),this._renderable.setParameter("texture_opacityMap",this._texture),this._updateRenderableEmissive(),this._renderable.setParameter("material_opacity",this._color.a);let t=this._texture.width/this._texture.height;t!==this._targetAspectRatio&&(this._targetAspectRatio=t,this._element.fitMode!==Ac&&this.refreshMesh())}else this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"),this._targetAspectRatio=-1,this._element.fitMode!==Ac&&this.refreshMesh()}}get texture(){return this._texture}set textureAsset(e){let t=this._system.app.assets,s=e;if(e instanceof re&&(s=e.id),this._textureAsset!==s){if(this._textureAsset){t.off(`add:${this._textureAsset}`,this._onTextureAdded,this);let i=t.get(this._textureAsset);i&&(i.off("load",this._onTextureLoad,this),i.off("change",this._onTextureChange,this),i.off("remove",this._onTextureRemove,this))}if(this._textureAsset=s,this._textureAsset){let i=t.get(this._textureAsset);i?this._bindTextureAsset(i):(this.texture=null,t.on(`add:${this._textureAsset}`,this._onTextureAdded,this))}else this.texture=null}}get textureAsset(){return this._textureAsset}set spriteAsset(e){let t=this._system.app.assets,s=e;if(e instanceof re&&(s=e.id),this._spriteAsset!==s){if(this._spriteAsset){t.off(`add:${this._spriteAsset}`,this._onSpriteAssetAdded,this);let i=t.get(this._spriteAsset);i&&this._unbindSpriteAsset(i)}if(this._spriteAsset=s,this._spriteAsset){let i=t.get(this._spriteAsset);i?this._bindSpriteAsset(i):(this.sprite=null,t.on(`add:${this._spriteAsset}`,this._onSpriteAssetAdded,this))}else this.sprite=null}this._element&&this._element.fire("set:spriteAsset",s)}get spriteAsset(){return this._spriteAsset}set sprite(e){if(this._sprite!==e){if(this._sprite&&this._unbindSprite(this._sprite),this._spriteAsset){let t=this._system.app.assets.get(this._spriteAsset);t&&t.resource!==e&&(this.spriteAsset=null)}this._sprite=e,this._sprite&&(this._bindSprite(this._sprite),this._textureAsset&&(this.textureAsset=null)),this._sprite&&this._sprite.atlas&&this._sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap")),this._sprite&&(this._spriteFrame=w.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite()}}get sprite(){return this._sprite}set spriteFrame(e){let t=this._spriteFrame;this._sprite?this._spriteFrame=w.clamp(e,0,this._sprite.frameKeys.length-1):this._spriteFrame=e,this._spriteFrame!==t&&this._updateSprite(),this._element&&this._element.fire("set:spriteFrame",e)}get spriteFrame(){return this._spriteFrame}set mesh(e){this._renderable.setMesh(e),this._defaultMesh===e?this._renderable.setAabbFunc(null):this._renderable.setAabbFunc(this._updateAabbFunc)}get mesh(){return this._renderable.mesh}set mask(e){this._mask!==e&&(this._mask=e,this._toggleMask())}get mask(){return this._mask}set pixelsPerUnit(e){this._pixelsPerUnit!==e&&(this._pixelsPerUnit=e,this._sprite&&(this._sprite.renderMode===Et||this._sprite.renderMode===vt)&&this._updateSprite())}get pixelsPerUnit(){return this._pixelsPerUnit}get aabb(){return this._renderable.meshInstance?this._renderable.meshInstance.aabb:null}}});var Zp,pM=m(()=>{Pe();dT();rt();Zp=class extends K{constructor(e){super(),this._app=e,e.i18n.on(ba.EVENT_CHANGE,this._onSetLocale,this),this._autoLoad=!1,this._disableLocalization=!1,this._defaultAsset=null,this._localizedAsset=null}set defaultAsset(e){let t=e instanceof re?e.id:e;this._defaultAsset!==t&&(this._defaultAsset&&this._unbindDefaultAsset(),this._defaultAsset=t,this._defaultAsset&&this._bindDefaultAsset(),this._onSetLocale(this._app.i18n.locale))}get defaultAsset(){return this._defaultAsset}set localizedAsset(e){let t=e instanceof re?e.id:e;this._localizedAsset!==t&&(this._localizedAsset&&(this._app.assets.off(`add:${this._localizedAsset}`,this._onLocalizedAssetAdd,this),this._unbindLocalizedAsset()),this._localizedAsset=t,this._localizedAsset&&(this._app.assets.get(this._localizedAsset)?this._bindLocalizedAsset():this._app.assets.once(`add:${this._localizedAsset}`,this._onLocalizedAssetAdd,this)))}get localizedAsset(){return this._localizedAsset}set autoLoad(e){this._autoLoad!==e&&(this._autoLoad=e,this._autoLoad&&this._localizedAsset&&(this._unbindLocalizedAsset(),this._bindLocalizedAsset()))}get autoLoad(){return this._autoLoad}set disableLocalization(e){this._disableLocalization!==e&&(this._disableLocalization=e,this._onSetLocale(this._app.i18n.locale))}get disableLocalization(){return this._disableLocalization}_bindDefaultAsset(){let e=this._app.assets.get(this._defaultAsset);e?this._onDefaultAssetAdd(e):this._app.assets.once(`add:${this._defaultAsset}`,this._onDefaultAssetAdd,this)}_unbindDefaultAsset(){if(!this._defaultAsset)return;this._app.assets.off(`add:${this._defaultAsset}`,this._onDefaultAssetAdd,this);let e=this._app.assets.get(this._defaultAsset);e&&(e.off("add:localized",this._onLocaleAdd,this),e.off("remove:localized",this._onLocaleRemove,this),e.off("remove",this._onDefaultAssetRemove,this))}_onDefaultAssetAdd(e){this._defaultAsset===e.id&&(e.on("add:localized",this._onLocaleAdd,this),e.on("remove:localized",this._onLocaleRemove,this),e.once("remove",this._onDefaultAssetRemove,this))}_onDefaultAssetRemove(e){this._defaultAsset===e.id&&(e.off("add:localized",this._onLocaleAdd,this),e.off("remove:localized",this._onLocaleAdd,this),this._app.assets.once(`add:${this._defaultAsset}`,this._onDefaultAssetAdd,this))}_bindLocalizedAsset(){if(!this._autoLoad)return;let e=this._app.assets.get(this._localizedAsset);e&&(e.on("load",this._onLocalizedAssetLoad,this),e.on("change",this._onLocalizedAssetChange,this),e.on("remove",this._onLocalizedAssetRemove,this),e.resource?this._onLocalizedAssetLoad(e):this._app.assets.load(e))}_unbindLocalizedAsset(){let e=this._app.assets.get(this._localizedAsset);e&&(e.off("load",this._onLocalizedAssetLoad,this),e.off("change",this._onLocalizedAssetChange,this),e.off("remove",this._onLocalizedAssetRemove,this))}_onLocalizedAssetAdd(e){this._localizedAsset===e.id&&this._bindLocalizedAsset()}_onLocalizedAssetLoad(e){this.fire("load",e)}_onLocalizedAssetChange(e,t,s,i){this.fire("change",e,t,s,i)}_onLocalizedAssetRemove(e){this._localizedAsset===e.id&&(this.localizedAsset=this._defaultAsset),this.fire("remove",e)}_onLocaleAdd(e,t){this._app.i18n.locale===e&&this._onSetLocale(e)}_onLocaleRemove(e,t){this._app.i18n.locale===e&&this._onSetLocale(e)}_onSetLocale(e){if(!this._defaultAsset){this.localizedAsset=null;return}let t=this._app.assets.get(this._defaultAsset);if(!t||this._disableLocalization){this.localizedAsset=this._defaultAsset;return}let s=t.getLocalizedAssetId(e);if(!s){this.localizedAsset=this._defaultAsset;return}this.localizedAsset=s}destroy(){this.defaultAsset=null,this._app.i18n.off(ba.EVENT_CHANGE,this._onSetLocale,this),this.off()}}});var Rc,uP,mP=m(()=>{Rc="msdf",uP="bitmap"});function Nj(o,e){for(let t in e){if(!e.hasOwnProperty(t))continue;let s=e[t];s instanceof Object?(o.hasOwnProperty(t)||(o[t]={}),Nj(o[t],e[t])):o[t]=s}}function loe(o){if(o.length===0)return null;let e={};for(let t=0;t<o.length;++t){let s=o[t],i={};i[s.name]={value:s.value,attributes:s.attributes},Nj(e,i)}return e}function hoe(o,e){if(o.length===0)return null;let t={};for(let c=0;c<o.length;++c){let f=o[c];t.hasOwnProperty(f.start)?t[f.start].open===null?t[f.start].open=[f]:t[f.start].open.push(f):t[f.start]={open:[f],close:null},t.hasOwnProperty(f.end)?t[f.end].close===null?t[f.end].close=[f]:t[f.end].close.push(f):t[f.end]={open:null,close:[f]}}let s=[];function i(c){s=s.filter(f=>c.find(d=>d===f)===void 0)}function r(c){for(let f=0;f<c.length;++f)s.push(c[f])}let a=Object.keys(t).sort((c,f)=>c-f),n=[];for(let c=0;c<a.length;++c){let f=t[a[c]];f.close!==null&&i(f.close),f.open!==null&&r(f.open),n.push({start:a[c],tags:loe(s)})}let l=[],h=null;for(let c=0;c<n.length;++c){let f=n[c];for(;l.length<f.start;)l.push(h?h.tags:null);h=f}for(;l.length<e;)l.push(null);return l}function coe(o){let e=new gM(o),t=[],s=[];if(!e.parse(t,s))return console.warn(e.error()),{symbols:o,tags:null};let i=s.find(a=>a.end===null);if(i)return console.warn(`Markup error: found unclosed tag='${i.name}'`),{symbols:o,tags:null};let r=hoe(s,t.length);return{symbols:t,tags:r}}var noe,ooe,_M,gM,pP,Fj=m(()=>{noe=` 	
\r\v\f`,ooe=/[\w|/]/,_M=class{constructor(e){this._symbols=e,this._index=0,this._last=0,this._cur=this._symbols.length>0?this._symbols[0]:null,this._buf=[],this._mode="text",this._error=null}read(){let e=this._read();for(;e===8;)e=this._read();return e!==0&&e!==1&&(this._last=this._index),e}buf(){return this._buf}last(){return this._last}error(){return this._error}debugPrint(){let e=["EOF","ERROR","TEXT","OPEN_BRACKET","CLOSE_BRACKET","EQUALS","STRING","IDENTIFIER","WHITESPACE"],t=this.read(),s="";for(;s+=`${(s.length>0?`
`:"")+e[t]} '${this.buf().join("")}'`,!(t===0||t===1);)t=this.read();return s}_read(){return this._buf=[],this._eof()?0:this._mode==="text"?this._text():this._tag()}_text(){for(;;)switch(this._cur){case null:return this._buf.length>0?2:0;case"[":return this._mode="tag",this._buf.length>0?2:this._tag();case"\\":switch(this._next(),this._cur){case"[":this._store();break;default:this._output("\\");break}break;default:this._store();break}}_tag(){switch(this._cur){case null:return this._error="unexpected end of input reading tag",1;case"[":return this._store(),3;case"]":return this._store(),this._mode="text",4;case"=":return this._store(),5;case" ":case"	":case`
`:case"\r":case"\v":case"\f":return this._whitespace();case'"':return this._string();default:return this._isIdentifierSymbol(this._cur)?this._identifier():(this._error="unrecognized character",1)}}_whitespace(){for(this._store();noe.indexOf(this._cur)!==-1;)this._store();return 8}_string(){for(this._next();;)switch(this._cur){case null:return this._error="unexpected end of input reading string",1;case'"':return this._next(),6;default:this._store();break}}_identifier(){for(this._store();this._cur!==null&&this._isIdentifierSymbol(this._cur);)this._store();return 7}_isIdentifierSymbol(e){return e.length===1&&e.match(ooe)!==null}_eof(){return this._cur===null}_next(){return this._eof()||(this._index++,this._cur=this._index<this._symbols.length?this._symbols[this._index]:null),this._cur}_store(){return this._buf.push(this._cur),this._next()}_output(e){this._buf.push(e)}},gM=class{constructor(e){this._scanner=new _M(e),this._error=null}parse(e,t){for(;;)switch(this._scanner.read()){case 0:return!0;case 1:return!1;case 2:Array.prototype.push.apply(e,this._scanner.buf());break;case 3:if(!this._parseTag(e,t))return!1;break;default:return!1}}error(){return`Error evaluating markup at #${this._scanner.last().toString()} (${this._scanner.error()||this._error})`}_parseTag(e,t){let s=this._scanner.read();if(s!==7)return this._error="expected identifier",!1;let i=this._scanner.buf().join("");if(i[0]==="/"){for(let a=t.length-1;a>=0;--a)if(i===`/${t[a].name}`&&t[a].end===null)return t[a].end=e.length,s=this._scanner.read(),s!==4?(this._error="expected close bracket",!1):!0;return this._error="failed to find matching tag",!1}let r={name:i,value:null,attributes:{},start:e.length,end:null};if(s=this._scanner.read(),s===5){if(s=this._scanner.read(),s!==6)return this._error="expected string",!1;r.value=this._scanner.buf().join(""),s=this._scanner.read()}for(;;){switch(s){case 4:return t.push(r),!0;case 7:{let a=this._scanner.buf().join("");if(s=this._scanner.read(),s!==5)return this._error="expected equals",!1;if(s=this._scanner.read(),s!==6)return this._error="expected string",!1;let n=this._scanner.buf().join("");r.attributes[a]=n;break}default:return this._error="expected close bracket or identifier",!1}s=this._scanner.read()}}};pP=class{static evaluate(e){return coe(e)}}});function foe(o,e){let t=new Ce(o);return t.setPositions(e.positions),t.setNormals(e.normals),t.setColors32(e.colors),t.setUvs(0,e.uvs),t.setIndices(e.indices),t.setVertexStream(ko,e.outlines,3,void 0,pe,!1),t.setVertexStream(Go,e.shadows,3,void 0,pe,!1),t.update(),t}var SM,Uj,doe,Bj,uoe,Vj,moe,poe,_oe,kj,goe,xt,Qp,TM=m(()=>{Kg();me();De();Ne();Vt();j();pS();Zt();_s();ll();Ws();pM();dT();mP();Fj();SM=class{constructor(){this.count=0,this.quad=0,this.lines={},this.positions=[],this.normals=[],this.uvs=[],this.colors=[],this.indices=[],this.outlines=[],this.shadows=[],this.meshInstance=null}};Uj=/^[\r\n]$/,doe=/^[ \t]$/,Bj=/^[ \t\-]|\u200b$/,uoe=/^[a-z0-9]$/i,Vj=/^[\u1100-\u11ff]|[\u3000-\u9fff\ua960-\ua97f]|[\uac00-\ud7ff]$/,moe=/^[〕〉》」』】〙〗〟ヽヾーァィゥェォッャュョヮヵヶぁぃぅぇぉっゃゅょゎゕゖㇰㇱㇲㇳㇴㇵㇶㇷㇸㇹㇺㇻㇼㇽㇾㇿ々〻]$/,poe=["\u200B","\u061C","\u200E","\u200F","\u202A","\u202B","\u202C","\u202D","\u202E","\u2066","\u2067","\u2068","\u2069"],_oe={width:0,height:0,xadvance:0,xoffset:0,yoffset:0},kj=new N,goe=new D,xt=new N,Qp=class{constructor(e){this._element=e,this._system=e.system,this._entity=e.entity,this._text="",this._symbols=[],this._colorPalette=[],this._outlinePalette=[],this._shadowPalette=[],this._symbolColors=null,this._symbolOutlineParams=null,this._symbolShadowParams=null,this._i18nKey=null,this._fontAsset=new Zp(this._system.app),this._fontAsset.disableLocalization=!0,this._fontAsset.on("load",this._onFontLoad,this),this._fontAsset.on("change",this._onFontChange,this),this._fontAsset.on("remove",this._onFontRemove,this),this._font=null,this._color=new N(1,1,1,1),this._colorUniform=new Float32Array(3),this._spacing=1,this._fontSize=32,this._fontMinY=0,this._fontMaxY=0,this._originalFontSize=32,this._maxFontSize=32,this._minFontSize=8,this._autoFitWidth=!1,this._autoFitHeight=!1,this._maxLines=-1,this._lineHeight=32,this._scaledLineHeight=32,this._wrapLines=!1,this._drawOrder=0,this._alignment=new D(.5,.5),this._autoWidth=!0,this._autoHeight=!0,this.width=0,this.height=0,this._node=new Ae,this._model=new Ys,this._model.graph=this._node,this._entity.addChild(this._node),this._meshInfo=[],this._material=null,this._aabbDirty=!0,this._aabb=new _e,this._noResize=!1,this._currentMaterialType=null,this._maskedMaterialSrc=null,this._rtlReorder=!1,this._unicodeConverter=!1,this._rtl=!1,this._outlineColor=new N(0,0,0,1),this._outlineColorUniform=new Float32Array(4),this._outlineThicknessScale=.2,this._outlineThickness=0,this._shadowColor=new N(0,0,0,1),this._shadowColorUniform=new Float32Array(4),this._shadowOffsetScale=.005,this._shadowOffset=new D(0,0),this._shadowOffsetUniform=new Float32Array(2),this._enableMarkup=!1,this._onScreenChange(this._element.screen),e.on("resize",this._onParentResize,this),e.on("set:screen",this._onScreenChange,this),e.on("screen:set:screenspace",this._onScreenSpaceChange,this),e.on("set:draworder",this._onDrawOrderChange,this),e.on("set:pivot",this._onPivotChange,this),this._system.app.i18n.on(ba.EVENT_CHANGE,this._onLocaleSet,this),this._system.app.i18n.on("data:add",this._onLocalizationData,this),this._system.app.i18n.on("data:remove",this._onLocalizationData,this),this._rangeStart=0,this._rangeEnd=0}destroy(){this._setMaterial(null),this._model&&(this._element.removeModelFromLayers(this._model),this._model.destroy(),this._model=null),this._fontAsset.destroy(),this.font=null,this._element.off("resize",this._onParentResize,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("set:pivot",this._onPivotChange,this),this._system.app.i18n.off(ba.EVENT_CHANGE,this._onLocaleSet,this),this._system.app.i18n.off("data:add",this._onLocalizationData,this),this._system.app.i18n.off("data:remove",this._onLocalizationData,this)}_onParentResize(e,t){this._noResize||this._font&&this._updateText()}_onScreenChange(e){e?this._updateMaterial(e.screen.screenSpace):this._updateMaterial(!1)}_onScreenSpaceChange(e){this._updateMaterial(e)}_onDrawOrderChange(e){if(this._drawOrder=e,this._model)for(let t=0,s=this._model.meshInstances.length;t<s;t++)this._model.meshInstances[t].drawOrder=e}_onPivotChange(e){this._font&&this._updateText()}_onLocaleSet(e){if(this._i18nKey){if(this.fontAsset){let t=this._system.app.assets.get(this.fontAsset);(!t||!t.resource||t.resource!==this._font)&&(this.font=null)}this._resetLocalizedText()}}_onLocalizationData(e,t){this._i18nKey&&t[this._i18nKey]&&this._resetLocalizedText()}_resetLocalizedText(){this._setText(this._system.app.i18n.getText(this._i18nKey))}_setText(e){if(this.unicodeConverter){let t=this._system.getUnicodeConverter();t?e=t(e):console.warn("Element created with unicodeConverter option but no unicodeConverter function registered")}this._text!==e&&(this._font&&this._updateText(e),this._text=e)}_updateText(e){let t;if(e===void 0&&(e=this._text),this._symbols=zr.getSymbols(e.normalize?e.normalize("NFC"):e),this._symbols.length===0&&(this._symbols=[" "]),this._enableMarkup){let f=pP.evaluate(this._symbols);this._symbols=f.symbols,t=f.tags||[]}if(this._rtlReorder){let f=this._system.app.systems.element.getRtlReorder();if(f){let d=f(this._symbols);this._rtl=d.rtl,this._symbols=d.mapping.map(function(u){return this._symbols[u]},this),t&&(t=d.mapping.map(u=>t[u]))}else console.warn("Element created with rtlReorder option but no rtlReorder function registered")}else this._rtl=!1;let s=(f,d)=>`${f.toString(!0).toLowerCase()}:${d.toFixed(2)}`,i=(f,d)=>`${f.toString(!0).toLowerCase()}:${d.x.toFixed(2)}:${d.y.toFixed(2)}`;if(t){let f={},d={},u={};this._colorPalette=[Math.round(this._color.r*255),Math.round(this._color.g*255),Math.round(this._color.b*255)],this._outlinePalette=[Math.round(this._outlineColor.r*255),Math.round(this._outlineColor.g*255),Math.round(this._outlineColor.b*255),Math.round(this._outlineColor.a*255),Math.round(this._outlineThickness*255)],this._shadowPalette=[Math.round(this._shadowColor.r*255),Math.round(this._shadowColor.g*255),Math.round(this._shadowColor.b*255),Math.round(this._shadowColor.a*255),Math.round(this._shadowOffset.x*127),Math.round(this._shadowOffset.y*127)],this._symbolColors=[],this._symbolOutlineParams=[],this._symbolShadowParams=[],f[this._color.toString(!1).toLowerCase()]=0,d[s(this._outlineColor,this._outlineThickness)]=0,u[i(this._shadowColor,this._shadowOffset)]=0;for(let p=0,_=this._symbols.length;p<_;++p){let S=t[p],T=0;if(S&&S.color&&S.color.value){let E=S.color.value;if(E.length===7&&E[0]==="#"){let v=E.substring(1).toLowerCase();f.hasOwnProperty(v)?T=f[v]:/^[0-9a-f]{6}$/.test(v)&&(T=this._colorPalette.length/3,f[v]=T,this._colorPalette.push(parseInt(v.substring(0,2),16)),this._colorPalette.push(parseInt(v.substring(2,4),16)),this._colorPalette.push(parseInt(v.substring(4,6),16)))}}this._symbolColors.push(T);let x=0;if(S&&S.outline&&(S.outline.attributes.color||S.outline.attributes.thickness)){let E=S.outline.attributes.color?kj.fromString(S.outline.attributes.color):this._outlineColor,v=Number(S.outline.attributes.thickness);(Number.isNaN(E.r)||Number.isNaN(E.g)||Number.isNaN(E.b)||Number.isNaN(E.a))&&(E=this._outlineColor),Number.isNaN(v)&&(v=this._outlineThickness);let R=s(E,v);d.hasOwnProperty(R)?x=d[R]:(x=this._outlinePalette.length/5,d[R]=x,this._outlinePalette.push(Math.round(E.r*255),Math.round(E.g*255),Math.round(E.b*255),Math.round(E.a*255),Math.round(v*255)))}this._symbolOutlineParams.push(x);let A=0;if(S&&S.shadow&&(S.shadow.attributes.color||S.shadow.attributes.offset||S.shadow.attributes.offsetX||S.shadow.attributes.offsetY)){let E=S.shadow.attributes.color?kj.fromString(S.shadow.attributes.color):this._shadowColor,v=Number(S.shadow.attributes.offset),R=Number(S.shadow.attributes.offsetX),P=Number(S.shadow.attributes.offsetY);(Number.isNaN(E.r)||Number.isNaN(E.g)||Number.isNaN(E.b)||Number.isNaN(E.a))&&(E=this._shadowColor);let y=goe.set(Number.isNaN(R)?Number.isNaN(v)?this._shadowOffset.x:v:R,Number.isNaN(P)?Number.isNaN(v)?this._shadowOffset.y:v:P),C=i(E,y);u.hasOwnProperty(C)?A=u[C]:(A=this._shadowPalette.length/6,u[C]=A,this._shadowPalette.push(Math.round(E.r*255),Math.round(E.g*255),Math.round(E.b*255),Math.round(E.a*255),Math.round(y.x*127),Math.round(y.y*127)))}this._symbolShadowParams.push(A)}}else this._colorPalette=[],this._symbolColors=null,this._symbolOutlineParams=null,this._symbolShadowParams=null;this._updateMaterialEmissive(),this._updateMaterialOutline(),this._updateMaterialShadow();let r=this._calculateCharsPerTexture(),a=!1,n=this._element,l=n._isScreenSpace(),h=n._isScreenCulled(),c=function(f){return n.isVisibleForCamera(f)};for(let f=0,d=this._meshInfo.length;f<d;f++){let u=r[f]||0,p=this._meshInfo[f];if(p.count!==u){if(a||(n.removeModelFromLayers(this._model),a=!0),p.count=u,p.positions.length=p.normals.length=u*3*4,p.indices.length=u*3*2,p.uvs.length=u*2*4,p.colors.length=u*4*4,p.outlines.length=u*4*3,p.shadows.length=u*4*3,p.meshInstance&&this._removeMeshInstance(p.meshInstance),u===0){p.meshInstance=null;continue}for(let T=0;T<u;T++)p.indices[T*3*2+0]=T*4,p.indices[T*3*2+1]=T*4+1,p.indices[T*3*2+2]=T*4+3,p.indices[T*3*2+3]=T*4+2,p.indices[T*3*2+4]=T*4+3,p.indices[T*3*2+5]=T*4+1,p.normals[T*4*3+0]=0,p.normals[T*4*3+1]=0,p.normals[T*4*3+2]=-1,p.normals[T*4*3+3]=0,p.normals[T*4*3+4]=0,p.normals[T*4*3+5]=-1,p.normals[T*4*3+6]=0,p.normals[T*4*3+7]=0,p.normals[T*4*3+8]=-1,p.normals[T*4*3+9]=0,p.normals[T*4*3+10]=0,p.normals[T*4*3+11]=-1;let _=foe(this._system.app.graphicsDevice,p),S=new Oe(_,this._material,this._node);if(S.name=`Text Element: ${this._entity.name}`,S.castShadow=!1,S.receiveShadow=!1,S.cull=!l,S.screenSpace=l,S.drawOrder=this._drawOrder,h&&(S.cull=!0,S.isVisibleFunc=c),this._setTextureParams(S,this._font.textures[f]),S.setParameter("material_emissive",this._colorUniform),S.setParameter("material_opacity",this._color.a),S.setParameter("font_sdfIntensity",this._font.intensity),S.setParameter("font_pxrange",this._getPxRange(this._font)),S.setParameter("font_textureWidth",this._font.data.info.maps[f].width),S.setParameter("outline_color",this._outlineColorUniform),S.setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness),S.setParameter("shadow_color",this._shadowColorUniform),this._symbolShadowParams)this._shadowOffsetUniform[0]=0,this._shadowOffsetUniform[1]=0;else{let T=-this._font.data.info.maps[f].width/this._font.data.info.maps[f].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=T*this._shadowOffsetScale*this._shadowOffset.y}S.setParameter("shadow_offset",this._shadowOffsetUniform),p.meshInstance=S,this._model.meshInstances.push(S)}}this._element.maskedBy&&this._element._setMaskedBy(this._element.maskedBy),a&&this._element.enabled&&this._entity.enabled&&this._element.addModelToLayers(this._model),this._updateMeshes(),this._rangeStart=0,this._rangeEnd=this._symbols.length,this._updateRenderRange()}_removeMeshInstance(e){e.destroy();let t=this._model.meshInstances.indexOf(e);t!==-1&&this._model.meshInstances.splice(t,1)}_setMaterial(e){if(this._material=e,this._model)for(let t=0,s=this._model.meshInstances.length;t<s;t++){let i=this._model.meshInstances[t];i.material=e}}_updateMaterial(e){let t=this._element,s=t._isScreenCulled(),i=function(a){return t.isVisibleForCamera(a)},r=this._font&&this._font.type===Rc;if(this._material=this._system.getTextElementMaterial(e,r,this._enableMarkup),this._model)for(let a=0,n=this._model.meshInstances.length;a<n;a++){let l=this._model.meshInstances[a];l.cull=!e,l.material=this._material,l.screenSpace=e,s?(l.cull=!0,l.isVisibleFunc=i):l.isVisibleFunc=null}}_updateMaterialEmissive(){this._symbolColors?(this._colorUniform[0]=1,this._colorUniform[1]=1,this._colorUniform[2]=1):(xt.linear(this._color),this._colorUniform[0]=xt.r,this._colorUniform[1]=xt.g,this._colorUniform[2]=xt.b)}_updateMaterialOutline(){this._symbolOutlineParams?(this._outlineColorUniform[0]=0,this._outlineColorUniform[1]=0,this._outlineColorUniform[2]=0,this._outlineColorUniform[3]=1):(xt.linear(this._outlineColor),this._outlineColorUniform[0]=xt.r,this._outlineColorUniform[1]=xt.g,this._outlineColorUniform[2]=xt.b,this._outlineColorUniform[3]=xt.a)}_updateMaterialShadow(){this._symbolOutlineParams?(this._shadowColorUniform[0]=0,this._shadowColorUniform[1]=0,this._shadowColorUniform[2]=0,this._shadowColorUniform[3]=0):(xt.linear(this._shadowColor),this._shadowColorUniform[0]=xt.r,this._shadowColorUniform[1]=xt.g,this._shadowColorUniform[2]=xt.b,this._shadowColorUniform[3]=xt.a)}_isWordBoundary(e){return Bj.test(e)}_isValidNextChar(e){return e!==null&&!moe.test(e)}_isNextCJKBoundary(e,t){return Vj.test(e)&&(Bj.test(t)||uoe.test(t))}_isNextCJKWholeWord(e){return Vj.test(e)}_updateMeshes(){let e=this._font.data,t=this,s=Math.min(this._minFontSize,this._maxFontSize),i=this._maxFontSize,r=this._shouldAutoFit();r&&(this._fontSize=this._maxFontSize);let a=32,n=this._symbols.length,l=0,h=0,c=0,f=0,d=1,u=0,p=0,_=0,S=0,T=0,x=0,A=Math.abs(this._element.anchor.x-this._element.anchor.z)>=1e-4,E=this._element.calculatedWidth;(this.autoWidth&&!A||!this._wrapLines)&&(E=Number.POSITIVE_INFINITY);let v=0,R=0,P,y,C,L;function O(I,b,F){t._lineWidths.push(Math.abs(F));let B=_>b?b+1:_,V=_>b?_+1:b,z=I.slice(B,V);if(x){let ee=z.length;for(;ee--&&x>0;)Uj.test(z[ee])&&(z.splice(ee,1),x--)}t._lineContents.push(z.join("")),l=0,h-=t._scaledLineHeight,d++,S=0,T=0,x=0,u=0,_=b}let M=!0;for(;M;){M=!1,r?this._scaledLineHeight=this._lineHeight*this._fontSize/(this._maxFontSize||1e-4):this._scaledLineHeight=this._lineHeight,this.width=0,this.height=0,this._lineWidths=[],this._lineContents=[],l=0,h=0,c=0,f=0,d=1,u=0,p=0,_=0,S=0,T=0,x=0;let I=this._fontSize/a;v=this._fontMinY*I,R=this._fontMaxY*I;for(let ce=0;ce<this._meshInfo.length;ce++)this._meshInfo[ce].quad=0,this._meshInfo[ce].lines={};let b=255,F=255,B=255,V=255+255*256,z=255+255*256,ee=0,se=255+255*256,Y=255+255*256,ne=127+127*256;for(let ce=0;ce<n;ce++){if(P=this._symbols[ce],L=ce+1>=n?null:this._symbols[ce+1],Uj.test(P)){x++,(!this._wrapLines||this._maxLines<0||d<this._maxLines)&&(O(this._symbols,ce,f),p=ce+1,_=ce+1);continue}let Bt=0,Lt=0,Kt=0,Va=1,vn,eu;if(y=e.chars[P],!y)if(poe.indexOf(P)!==-1)y=_oe;else if(e.chars[" "])y=e.chars[" "];else for(let dt in e.chars){y=e.chars[dt];break}if(y){let dt=0;if(T>0){let vE=this._font.data.kerning;if(vE){let xE=vE[zr.getCodePoint(this._symbols[ce-1])||0];xE&&(dt=xE[zr.getCodePoint(this._symbols[ce])||0]||0)}}vn=y.scale||1,eu=(y.width+y.height)/2,Va=I*eu/vn,Kt=(y.xadvance+dt)*I,Bt=(y.xoffset-dt)*I,Lt=y.yoffset*I}else console.error(`Couldn't substitute missing character: '${P}'`);let MO=doe.test(P),kC=y&&y.map||0,_ie=-this._font.data.info.maps[kC].width/this._font.data.info.maps[kC].height,de=this._meshInfo[kC],DO=l+this._spacing*Kt;if(DO>E&&T>0&&!MO&&(this._maxLines<0||d<this._maxLines))if(S===0)p=ce,O(this._symbols,ce,f);else{let dt=Math.max(ce-p,0);if(this._meshInfo.length<=1)de.lines[d-1]-=dt,de.quad-=dt;else{let vE=p,xE=ce;for(let HC=vE;HC<xE;HC++){let gie=this._symbols[HC],NO=e.chars[gie],FO=this._meshInfo[NO&&NO.map||0];FO.lines[d-1]-=1,FO.quad-=1}}ce-=dt+1,O(this._symbols,p,u);continue}C=de.quad,de.lines[d-1]=C;let EE=l-Bt,GC=EE+Va,zC=h-Lt,OO=zC+Va;if(this._rtl){let dt=Va-Bt-this._spacing*Kt-Bt;EE-=dt,GC-=dt}de.positions[C*4*3+0]=EE,de.positions[C*4*3+1]=zC,de.positions[C*4*3+2]=c,de.positions[C*4*3+3]=GC,de.positions[C*4*3+4]=zC,de.positions[C*4*3+5]=c,de.positions[C*4*3+6]=GC,de.positions[C*4*3+7]=OO,de.positions[C*4*3+8]=c,de.positions[C*4*3+9]=EE,de.positions[C*4*3+10]=OO,de.positions[C*4*3+11]=c,this.width=Math.max(this.width,DO);let Gl;if(this._shouldAutoFitWidth()&&this.width>this._element.calculatedWidth&&(Gl=Math.floor(this._element.fontSize*this._element.calculatedWidth/(this.width||1e-4)),Gl=w.clamp(Gl,s,i),Gl!==this._element.fontSize)){this._fontSize=Gl,M=!0;break}if(this.height=Math.max(this.height,R-(h+v)),this._shouldAutoFitHeight()&&this.height>this._element.calculatedHeight&&(Gl=w.clamp(this._fontSize-1,s,i),Gl!==this._element.fontSize)){this._fontSize=Gl,M=!0;break}l+=this._spacing*Kt,MO||(f=l),(this._isWordBoundary(P)||this._isValidNextChar(L)&&(this._isNextCJKBoundary(P,L)||this._isNextCJKWholeWord(L)))&&(S++,u=f,p=ce+1),T++;let zl=this._getUv(P);if(de.uvs[C*4*2+0]=zl[0],de.uvs[C*4*2+1]=1-zl[1],de.uvs[C*4*2+2]=zl[2],de.uvs[C*4*2+3]=1-zl[1],de.uvs[C*4*2+4]=zl[2],de.uvs[C*4*2+5]=1-zl[3],de.uvs[C*4*2+6]=zl[0],de.uvs[C*4*2+7]=1-zl[3],this._symbolColors){let dt=this._symbolColors[ce]*3;b=this._colorPalette[dt],F=this._colorPalette[dt+1],B=this._colorPalette[dt+2]}if(de.colors[C*4*4+0]=b,de.colors[C*4*4+1]=F,de.colors[C*4*4+2]=B,de.colors[C*4*4+3]=255,de.colors[C*4*4+4]=b,de.colors[C*4*4+5]=F,de.colors[C*4*4+6]=B,de.colors[C*4*4+7]=255,de.colors[C*4*4+8]=b,de.colors[C*4*4+9]=F,de.colors[C*4*4+10]=B,de.colors[C*4*4+11]=255,de.colors[C*4*4+12]=b,de.colors[C*4*4+13]=F,de.colors[C*4*4+14]=B,de.colors[C*4*4+15]=255,this._symbolOutlineParams){let dt=this._symbolOutlineParams[ce]*5;V=this._outlinePalette[dt]+this._outlinePalette[dt+1]*256,z=this._outlinePalette[dt+2]+this._outlinePalette[dt+3]*256,ee=this._outlinePalette[dt+4]}if(de.outlines[C*4*3+0]=V,de.outlines[C*4*3+1]=z,de.outlines[C*4*3+2]=ee,de.outlines[C*4*3+3]=V,de.outlines[C*4*3+4]=z,de.outlines[C*4*3+5]=ee,de.outlines[C*4*3+6]=V,de.outlines[C*4*3+7]=z,de.outlines[C*4*3+8]=ee,de.outlines[C*4*3+9]=V,de.outlines[C*4*3+10]=z,de.outlines[C*4*3+11]=ee,this._symbolShadowParams){let dt=this._symbolShadowParams[ce]*6;se=this._shadowPalette[dt]+this._shadowPalette[dt+1]*256,Y=this._shadowPalette[dt+2]+this._shadowPalette[dt+3]*256,ne=this._shadowPalette[dt+4]+127+Math.round(_ie*this._shadowPalette[dt+5]+127)*256}de.shadows[C*4*3+0]=se,de.shadows[C*4*3+1]=Y,de.shadows[C*4*3+2]=ne,de.shadows[C*4*3+3]=se,de.shadows[C*4*3+4]=Y,de.shadows[C*4*3+5]=ne,de.shadows[C*4*3+6]=se,de.shadows[C*4*3+7]=Y,de.shadows[C*4*3+8]=ne,de.shadows[C*4*3+9]=se,de.shadows[C*4*3+10]=Y,de.shadows[C*4*3+11]=ne,de.quad++}M||_<n&&O(this._symbols,n,l)}this._noResize=!0,this.autoWidth=this._autoWidth,this.autoHeight=this._autoHeight,this._noResize=!1;let U=this._element.pivot.x,G=this._element.pivot.y,$=this._alignment.x,X=this._alignment.y;for(let I=0;I<this._meshInfo.length;I++){if(this._meshInfo[I].count===0)continue;let b=0;for(let z in this._meshInfo[I].lines){let ee=this._meshInfo[I].lines[z],se=this._lineWidths[parseInt(z,10)],Y=-U*this._element.calculatedWidth+$*(this._element.calculatedWidth-se)*(this._rtl?-1:1),ne=(1-G)*this._element.calculatedHeight-R-(1-X)*(this._element.calculatedHeight-this.height);for(let ce=b;ce<=ee;ce++)this._meshInfo[I].positions[ce*4*3]+=Y,this._meshInfo[I].positions[ce*4*3+3]+=Y,this._meshInfo[I].positions[ce*4*3+6]+=Y,this._meshInfo[I].positions[ce*4*3+9]+=Y,this._meshInfo[I].positions[ce*4*3+1]+=ne,this._meshInfo[I].positions[ce*4*3+4]+=ne,this._meshInfo[I].positions[ce*4*3+7]+=ne,this._meshInfo[I].positions[ce*4*3+10]+=ne;if(this._rtl)for(let ce=b;ce<=ee;ce++){let ze=ce*4*3;for(let Kt=0;Kt<4;++Kt)this._meshInfo[I].positions[ze+Kt*3]=this._element.calculatedWidth-this._meshInfo[I].positions[ze+Kt*3]+Y*2;let Bt=this._meshInfo[I].positions[ze+3],Lt=this._meshInfo[I].positions[ze+6];this._meshInfo[I].positions[ze+3]=this._meshInfo[I].positions[ze+0],this._meshInfo[I].positions[ze+6]=this._meshInfo[I].positions[ze+9],this._meshInfo[I].positions[ze+0]=Bt,this._meshInfo[I].positions[ze+9]=Lt}b=ee+1}let F=this._meshInfo[I].count*4,B=this._meshInfo[I].quad*4,V=new ua(this._meshInfo[I].meshInstance.mesh.vertexBuffer);for(let z=0;z<F;z++)z>=B?(V.element[te].set(0,0,0),V.element[ot].set(0,0),V.element[nt].set(0,0,0,0),V.element[ko].set(0,0,0,0),V.element[Go].set(0,0,0,0)):(V.element[te].set(this._meshInfo[I].positions[z*3+0],this._meshInfo[I].positions[z*3+1],this._meshInfo[I].positions[z*3+2]),V.element[ot].set(this._meshInfo[I].uvs[z*2+0],this._meshInfo[I].uvs[z*2+1]),V.element[nt].set(this._meshInfo[I].colors[z*4+0],this._meshInfo[I].colors[z*4+1],this._meshInfo[I].colors[z*4+2],this._meshInfo[I].colors[z*4+3]),V.element[ko].set(this._meshInfo[I].outlines[z*3+0],this._meshInfo[I].outlines[z*3+1],this._meshInfo[I].outlines[z*3+2]),V.element[Go].set(this._meshInfo[I].shadows[z*3+0],this._meshInfo[I].shadows[z*3+1],this._meshInfo[I].shadows[z*3+2])),V.next();V.end(),this._meshInfo[I].meshInstance.mesh.aabb.compute(this._meshInfo[I].positions),this._meshInfo[I].meshInstance._aabbVer=-1}this._aabbDirty=!0}_onFontRender(){this.font=this._font}_onFontLoad(e){this.font!==e.resource&&(this.font=e.resource)}_onFontChange(e,t,s,i){if(t==="data"){this._font.data=s;let r=this._font.data.info.maps.length;for(let a=0;a<r;a++){if(!this._meshInfo[a])continue;let n=this._meshInfo[a].meshInstance;n&&(n.setParameter("font_sdfIntensity",this._font.intensity),n.setParameter("font_pxrange",this._getPxRange(this._font)),n.setParameter("font_textureWidth",this._font.data.info.maps[a].width))}}}_onFontRemove(e){}_setTextureParams(e,t){this._font&&(this._font.type===Rc?(e.deleteParameter("texture_emissiveMap"),e.deleteParameter("texture_opacityMap"),e.setParameter("texture_msdfMap",t)):this._font.type===uP&&(e.deleteParameter("texture_msdfMap"),e.setParameter("texture_emissiveMap",t),e.setParameter("texture_opacityMap",t)))}_getPxRange(e){let t=Object.keys(this._font.data.chars);for(let s=0;s<t.length;s++){let i=this._font.data.chars[t[s]];if(i.range)return(i.scale||1)*i.range}return 2}_getUv(e){let t=this._font.data;if(!t.chars[e])return t.chars[" "]?this._getUv(" "):[0,0,0,0];let s=t.chars[e].map,i=t.info.maps[s].width,r=t.info.maps[s].height,a=t.chars[e].x,n=t.chars[e].y,l=a,h=n,c=a+t.chars[e].width,f=n-t.chars[e].height,d=1-t.chars[e].height/r;return[l/i,d-h/r,c/i,d-f/r]}onEnable(){this._fontAsset.autoLoad=!0,this._model&&this._element.addModelToLayers(this._model)}onDisable(){this._fontAsset.autoLoad=!1,this._model&&this._element.removeModelFromLayers(this._model)}_setStencil(e){if(this._model){let t=this._model.meshInstances;for(let s=0;s<t.length;s++)t[s].stencilFront=e,t[s].stencilBack=e}}_shouldAutoFitWidth(){return this._autoFitWidth&&!this._autoWidth}_shouldAutoFitHeight(){return this._autoFitHeight&&!this._autoHeight}_shouldAutoFit(){return this._autoFitWidth&&!this._autoWidth||this._autoFitHeight&&!this._autoHeight}_calculateCharsPerTexture(e){let t={};e===void 0&&(e=this._symbols.length);for(let s=0,i=e;s<i;s++){let r=this._symbols[s],a=this._font.data.chars[r];a||(a=this._font.data.chars[" "],a||(a=this._font.data.chars[Object.keys(this._font.data.chars)[0]]));let n=a.map;t[n]?t[n]++:t[n]=1}return t}_updateRenderRange(){let e=this._rangeStart===0?0:this._calculateCharsPerTexture(this._rangeStart),t=this._rangeEnd===0?0:this._calculateCharsPerTexture(this._rangeEnd);for(let s=0,i=this._meshInfo.length;s<i;s++){let r=e[s]||0,a=t[s]||0,n=this._meshInfo[s].meshInstance;if(n){let l=n.mesh;l&&(l.primitive[0].base=r*3*2,l.primitive[0].count=(a-r)*3*2)}}}set text(e){this._i18nKey=null;let t=e!=null&&e.toString()||"";this._setText(t)}get text(){return this._text}set key(e){let t=e!==null?e.toString():null;this._i18nKey!==t&&(this._i18nKey=t,t?(this._fontAsset.disableLocalization=!1,this._resetLocalizedText()):this._fontAsset.disableLocalization=!0)}get key(){return this._i18nKey}set color(e){let t=e.r,s=e.g,i=e.b;if(!(this._color.r===t&&this._color.g===s&&this._color.b===i)&&(this._color.r=t,this._color.g=s,this._color.b=i,!!this._model)){if(this._symbolColors)this._font&&this._updateText();else{xt.linear(this._color),this._colorUniform[0]=xt.r,this._colorUniform[1]=xt.g,this._colorUniform[2]=xt.b;for(let r=0,a=this._model.meshInstances.length;r<a;r++)this._model.meshInstances[r].setParameter("material_emissive",this._colorUniform)}this._element&&this._element.fire("set:color",this._color)}}get color(){return this._color}set opacity(e){if(this._color.a!==e&&(this._color.a=e,this._model))for(let t=0,s=this._model.meshInstances.length;t<s;t++)this._model.meshInstances[t].setParameter("material_opacity",e);this._element&&this._element.fire("set:opacity",e)}get opacity(){return this._color.a}set lineHeight(e){let t=this._lineHeight;this._lineHeight=e,this._scaledLineHeight=e,t!==e&&this._font&&this._updateText()}get lineHeight(){return this._lineHeight}set wrapLines(e){let t=this._wrapLines;this._wrapLines=e,t!==e&&this._font&&this._updateText()}get wrapLines(){return this._wrapLines}get lines(){return this._lineContents}set spacing(e){let t=this._spacing;this._spacing=e,t!==e&&this._font&&this._updateText()}get spacing(){return this._spacing}set fontSize(e){let t=this._fontSize;this._fontSize=e,this._originalFontSize=e,t!==e&&this._font&&this._updateText()}get fontSize(){return this._fontSize}set fontAsset(e){this._fontAsset.defaultAsset=e}get fontAsset(){return this._fontAsset.localizedAsset}set font(e){let t;if(this._font&&(t=this._font.type,this._font.off&&this._font.off("render",this._onFontRender,this)),this._font=e,this._fontMinY=0,this._fontMaxY=0,!e)return;let s=this._font.data;for(let r in s.chars){let a=s.chars[r];a.bounds&&(this._fontMinY=Math.min(this._fontMinY,a.bounds[1]),this._fontMaxY=Math.max(this._fontMaxY,a.bounds[3]))}if(this._font.on&&this._font.on("render",this._onFontRender,this),this._fontAsset.localizedAsset&&this._system.app.assets.get(this._fontAsset.localizedAsset).resource!==this._font&&(this._fontAsset.defaultAsset=null),e.type!==t){let r=this._element._isScreenSpace();this._updateMaterial(r)}for(let r=0,a=this._font.textures.length;r<a;r++)if(!this._meshInfo[r])this._meshInfo[r]=new SM;else{let n=this._meshInfo[r].meshInstance;n&&(n.setParameter("font_sdfIntensity",this._font.intensity),n.setParameter("font_pxrange",this._getPxRange(this._font)),n.setParameter("font_textureWidth",this._font.data.info.maps[r].width),this._setTextureParams(n,this._font.textures[r]))}let i=!1;for(let r=this._font.textures.length;r<this._meshInfo.length;r++)this._meshInfo[r].meshInstance&&(i||(this._element.removeModelFromLayers(this._model),i=!0),this._removeMeshInstance(this._meshInfo[r].meshInstance));this._meshInfo.length>this._font.textures.length&&(this._meshInfo.length=this._font.textures.length),this._updateText()}get font(){return this._font}set alignment(e){e instanceof D?this._alignment.set(e.x,e.y):this._alignment.set(e[0],e[1]),this._font&&this._updateText()}get alignment(){return this._alignment}set autoWidth(e){let t=this._autoWidth;if(this._autoWidth=e,e&&Math.abs(this._element.anchor.x-this._element.anchor.z)<1e-4&&(this._element.width=this.width),t!==e){let s=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize;s!==this._fontSize&&(this._fontSize=s,this._font&&this._updateText())}}get autoWidth(){return this._autoWidth}set autoHeight(e){let t=this._autoHeight;if(this._autoHeight=e,e&&Math.abs(this._element.anchor.y-this._element.anchor.w)<1e-4&&(this._element.height=this.height),t!==e){let s=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize;s!==this._fontSize&&(this._fontSize=s,this._font&&this._updateText())}}get autoHeight(){return this._autoHeight}set rtlReorder(e){this._rtlReorder!==e&&(this._rtlReorder=e,this._font&&this._updateText())}get rtlReorder(){return this._rtlReorder}set unicodeConverter(e){this._unicodeConverter!==e&&(this._unicodeConverter=e,this._setText(this._text))}get unicodeConverter(){return this._unicodeConverter}get aabb(){if(this._aabbDirty){let e=!1;for(let t=0;t<this._meshInfo.length;t++)this._meshInfo[t].meshInstance&&(e?this._aabb.add(this._meshInfo[t].meshInstance.aabb):(this._aabb.copy(this._meshInfo[t].meshInstance.aabb),e=!0));this._aabbDirty=!1}return this._aabb}set outlineColor(e){let t=e instanceof N?e.r:e[0],s=e instanceof N?e.g:e[1],i=e instanceof N?e.b:e[2],r=e instanceof N?e.a:e[3];if(!(this._outlineColor.r===t&&this._outlineColor.g===s&&this._outlineColor.b===i&&this._outlineColor.a===r)&&(this._outlineColor.r=t,this._outlineColor.g=s,this._outlineColor.b=i,this._outlineColor.a=r,!!this._model)){if(this._symbolOutlineParams)this._font&&this._updateText();else{xt.linear(this._outlineColor),this._outlineColorUniform[0]=xt.r,this._outlineColorUniform[1]=xt.g,this._outlineColorUniform[2]=xt.b,this._outlineColorUniform[3]=xt.a;for(let a=0,n=this._model.meshInstances.length;a<n;a++)this._model.meshInstances[a].setParameter("outline_color",this._outlineColorUniform)}this._element&&this._element.fire("set:outline",this._color)}}get outlineColor(){return this._outlineColor}set outlineThickness(e){let t=this._outlineThickness;if(this._outlineThickness=e,t!==e&&this._font){if(!this._model)return;if(this._symbolOutlineParams)this._font&&this._updateText();else for(let s=0,i=this._model.meshInstances.length;s<i;s++)this._model.meshInstances[s].setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness)}}get outlineThickness(){return this._outlineThickness}set shadowColor(e){let t=e instanceof N?e.r:e[0],s=e instanceof N?e.g:e[1],i=e instanceof N?e.b:e[2],r=e instanceof N?e.a:e[3];if(!(this._shadowColor.r===t&&this._shadowColor.g===s&&this._shadowColor.b===i&&this._shadowColor.a===r)&&(this._shadowColor.r=t,this._shadowColor.g=s,this._shadowColor.b=i,this._shadowColor.a=r,!!this._model))if(this._symbolShadowParams)this._font&&this._updateText();else{xt.linear(this._shadowColor),this._shadowColorUniform[0]=xt.r,this._shadowColorUniform[1]=xt.g,this._shadowColorUniform[2]=xt.b,this._shadowColorUniform[3]=xt.a;for(let a=0,n=this._model.meshInstances.length;a<n;a++)this._model.meshInstances[a].setParameter("shadow_color",this._shadowColorUniform)}}get shadowColor(){return this._shadowColor}set shadowOffset(e){let t=e instanceof D?e.x:e[0],s=e instanceof D?e.y:e[1];if(!(this._shadowOffset.x===t&&this._shadowOffset.y===s)&&(this._shadowOffset.set(t,s),this._font&&this._model))if(this._symbolShadowParams)this._updateText();else for(let i=0,r=this._model.meshInstances.length;i<r;i++){let a=-this._font.data.info.maps[i].width/this._font.data.info.maps[i].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=a*this._shadowOffsetScale*this._shadowOffset.y,this._model.meshInstances[i].setParameter("shadow_offset",this._shadowOffsetUniform)}}get shadowOffset(){return this._shadowOffset}set minFontSize(e){this._minFontSize!==e&&(this._minFontSize=e,this.font&&this._shouldAutoFit()&&this._updateText())}get minFontSize(){return this._minFontSize}set maxFontSize(e){this._maxFontSize!==e&&(this._maxFontSize=e,this.font&&this._shouldAutoFit()&&this._updateText())}get maxFontSize(){return this._maxFontSize}set autoFitWidth(e){this._autoFitWidth!==e&&(this._autoFitWidth=e,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}get autoFitWidth(){return this._autoFitWidth}set autoFitHeight(e){this._autoFitHeight!==e&&(this._autoFitHeight=e,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}get autoFitHeight(){return this._autoFitHeight}set maxLines(e){this._maxLines!==e&&(e===null&&this._maxLines===-1||(this._maxLines=e===null?-1:e,this.font&&this._wrapLines&&this._updateText()))}get maxLines(){return this._maxLines}set enableMarkup(e){if(e=!!e,this._enableMarkup===e)return;this._enableMarkup=e,this.font&&this._updateText();let t=this._element._isScreenSpace();this._updateMaterial(t)}get enableMarkup(){return this._enableMarkup}get symbols(){return this._symbols}get symbolColors(){return this._symbolColors===null?null:this._symbolColors.map(function(e){return this._colorPalette.slice(e*3,e*3+3)},this)}get symbolOutlineParams(){return this._symbolOutlineParams===null?null:this._symbolOutlineParams.map(function(e){return this._outlinePalette.slice(e*5,e*5+5)},this)}get symbolShadowParams(){return this._symbolShadowParams===null?null:this._symbolShadowParams.map(function(e){return this._shadowPalette.slice(e*6,e*6+6)},this)}get rtl(){return this._rtl}set rangeStart(e){e=Math.max(0,Math.min(e,this._symbols.length)),e!==this._rangeStart&&(this._rangeStart=e,this._updateRenderRange())}get rangeStart(){return this._rangeStart}set rangeEnd(e){e=Math.max(this._rangeStart,Math.min(e,this._symbols.length)),e!==this._rangeEnd&&(this._rangeEnd=e,this._updateRenderRange())}get rangeEnd(){return this._rangeEnd}}});var EM,Gj,vl,Soe,Da,_P,gP,Jp,Cc,SP=m(()=>{Ke();Ne();Q();Ze();j();J();Xf();gf();ci();We();zp();mM();TM();EM=new g,Gj=new k,vl=new g,Soe=new g,Da=new k,_P=new k,gP=new k,Jp=new k,Cc=class extends ae{static{this.EVENT_MOUSEDOWN="mousedown"}static{this.EVENT_MOUSEUP="mouseup"}static{this.EVENT_MOUSEENTER="mouseenter"}static{this.EVENT_MOUSELEAVE="mouseleave"}static{this.EVENT_MOUSEMOVE="mousemove"}static{this.EVENT_MOUSEWHEEL="mousewheel"}static{this.EVENT_CLICK="click"}static{this.EVENT_TOUCHSTART="touchstart"}static{this.EVENT_TOUCHEND="touchend"}static{this.EVENT_TOUCHMOVE="touchmove"}static{this.EVENT_TOUCHCANCEL="touchcancel"}constructor(e,t){super(e,t),this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._beingInitialized=!1,this._anchor=new W,this._localAnchor=new W,this._pivot=new D,this._width=this._calculatedWidth=32,this._height=this._calculatedHeight=32,this._margin=new W(0,0,-32,-32),this._modelTransform=new k,this._screenToWorld=new k,this._anchorTransform=new k,this._anchorDirty=!0,this._parentWorldTransform=new k,this._screenTransform=new k,this._screenCorners=[new g,new g,new g,new g],this._canvasCorners=[new D,new D,new D,new D],this._worldCorners=[new g,new g,new g,new g],this._cornersDirty=!0,this._canvasCornersDirty=!0,this._worldCornersDirty=!0,this.entity.on("insert",this._onInsert,this),this._patch(),this.screen=null,this._type=yc,this._image=null,this._text=null,this._group=null,this._drawOrder=0,this._fitMode=Ac,this._useInput=!1,this._layers=[pa],this._addedModels=[],this._batchGroupId=-1,this._offsetReadAt=0,this._maskOffset=.5,this._maskedBy=null}get data(){let e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){let t=this.data,s=t.enabled;t.enabled=e,this.fire("set","enabled",s,e)}get enabled(){return this.data.enabled}get _absLeft(){return this._localAnchor.x+this._margin.x}get _absRight(){return this._localAnchor.z-this._margin.z}get _absTop(){return this._localAnchor.w-this._margin.w}get _absBottom(){return this._localAnchor.y+this._margin.y}get _hasSplitAnchorsX(){return Math.abs(this._anchor.x-this._anchor.z)>.001}get _hasSplitAnchorsY(){return Math.abs(this._anchor.y-this._anchor.w)>.001}get aabb(){return this._image?this._image.aabb:this._text?this._text.aabb:null}set anchor(e){e instanceof W?this._anchor.copy(e):this._anchor.set(...e),!this.entity._parent&&!this.screen?this._calculateLocalAnchors():this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this._anchorDirty=!0,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:anchor",this._anchor)}get anchor(){return this._anchor}set batchGroupId(e){this._batchGroupId!==e&&(this.entity.enabled&&this._batchGroupId>=0&&this.system.app.batcher?.remove(wt.ELEMENT,this.batchGroupId,this.entity),this.entity.enabled&&e>=0&&this.system.app.batcher?.insert(wt.ELEMENT,e,this.entity),e<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&(this._image&&this._image._renderable.model?this.addModelToLayers(this._image._renderable.model):this._text&&this._text._model&&this.addModelToLayers(this._text._model)),this._batchGroupId=e)}get batchGroupId(){return this._batchGroupId}set bottom(e){this._margin.y=e;let t=this.entity.getLocalPosition(),s=this._absTop,i=this._localAnchor.y+e;this._setHeight(s-i),t.y=e+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(t)}get bottom(){return this._margin.y}set calculatedWidth(e){this._setCalculatedWidth(e,!0)}get calculatedWidth(){return this._calculatedWidth}set calculatedHeight(e){this._setCalculatedHeight(e,!0)}get calculatedHeight(){return this._calculatedHeight}get canvasCorners(){if(!this._canvasCornersDirty||!this.screen||!this.screen.screen.screenSpace)return this._canvasCorners;let e=this.system.app.graphicsDevice,t=this.screenCorners,s=e.canvas.clientWidth/e.width,i=e.canvas.clientHeight/e.height;for(let r=0;r<4;r++)this._canvasCorners[r].set(t[r].x*s,(e.height-t[r].y)*i);return this._canvasCornersDirty=!1,this._canvasCorners}set drawOrder(e){let t=0;this.screen&&(t=this.screen.screen.priority),e>16777215&&(e=16777215),this._drawOrder=(t<<24)+e,this.fire("set:draworder",this._drawOrder)}get drawOrder(){return this._drawOrder}set height(e){this._height=e,this._hasSplitAnchorsY||this._setCalculatedHeight(e,!0),this.fire("set:height",this._height)}get height(){return this._height}set layers(e){if(this._addedModels.length)for(let t=0;t<this._layers.length;t++){let s=this.system.app.scene.layers.getLayerById(this._layers[t]);if(s)for(let i=0;i<this._addedModels.length;i++)s.removeMeshInstances(this._addedModels[i].meshInstances)}if(this._layers=e,!(!this.enabled||!this.entity.enabled||!this._addedModels.length))for(let t=0;t<this._layers.length;t++){let s=this.system.app.scene.layers.getLayerById(this._layers[t]);if(s)for(let i=0;i<this._addedModels.length;i++)s.addMeshInstances(this._addedModels[i].meshInstances)}}get layers(){return this._layers}set left(e){this._margin.x=e;let t=this.entity.getLocalPosition(),s=this._absRight,i=this._localAnchor.x+e;this._setWidth(s-i),t.x=e+this._calculatedWidth*this._pivot.x,this.entity.setLocalPosition(t)}get left(){return this._margin.x}set margin(e){this._margin.copy(e),this._calculateSize(!0,!0),this.fire("set:margin",this._margin)}get margin(){return this._margin}get maskedBy(){return this._maskedBy}set pivot(e){let{pivot:t,margin:s}=this,i=t.x,r=t.y;e instanceof D?t.copy(e):t.set(...e);let a=s.x+s.z,n=t.x-i;s.x+=a*n,s.z-=a*n;let l=s.y+s.w,h=t.y-r;s.y+=l*h,s.w-=l*h,this._anchorDirty=!0,this._cornersDirty=!0,this._worldCornersDirty=!0,this._calculateSize(!1,!1),this._flagChildrenAsDirty(),this.fire("set:pivot",t)}get pivot(){return this._pivot}set right(e){this._margin.z=e;let t=this.entity.getLocalPosition(),s=this._absLeft,i=this._localAnchor.z-e;this._setWidth(i-s),t.x=this._localAnchor.z-this._localAnchor.x-e-this._calculatedWidth*(1-this._pivot.x),this.entity.setLocalPosition(t)}get right(){return this._margin.z}get screenCorners(){if(!this._cornersDirty||!this.screen)return this._screenCorners;let e=this.entity.parent&&this.entity.parent.element&&this.entity.parent.element.screenCorners[0];this._screenCorners[0].set(this._absLeft,this._absBottom,0),this._screenCorners[1].set(this._absRight,this._absBottom,0),this._screenCorners[2].set(this._absRight,this._absTop,0),this._screenCorners[3].set(this._absLeft,this._absTop,0);let t=this.screen.screen.screenSpace;for(let s=0;s<4;s++)this._screenTransform.transformPoint(this._screenCorners[s],this._screenCorners[s]),t&&this._screenCorners[s].mulScalar(this.screen.screen.scale),e&&this._screenCorners[s].add(e);return this._cornersDirty=!1,this._canvasCornersDirty=!0,this._worldCornersDirty=!0,this._screenCorners}get textWidth(){return this._text?this._text.width:0}get textHeight(){return this._text?this._text.height:0}set top(e){this._margin.w=e;let t=this.entity.getLocalPosition(),s=this._absBottom,i=this._localAnchor.w-e;this._setHeight(i-s),t.y=this._localAnchor.w-this._localAnchor.y-e-this._calculatedHeight*(1-this._pivot.y),this.entity.setLocalPosition(t)}get top(){return this._margin.w}set type(e){e!==this._type&&(this._type=e,this._image&&(this._image.destroy(),this._image=null),this._text&&(this._text.destroy(),this._text=null),e===dd?this._image=new $p(this):e===Gp&&(this._text=new Qp(this)))}get type(){return this._type}set useInput(e){this._useInput!==e&&(this._useInput=e,this.system.app.elementInput?e?this.enabled&&this.entity.enabled&&this.system.app.elementInput.addElement(this):this.system.app.elementInput.removeElement(this):this._useInput,this.fire("set:useInput",e))}get useInput(){return this._useInput}set fitMode(e){this._fitMode=e,this._calculateSize(!0,!0),this._image&&this._image.refreshMesh()}get fitMode(){return this._fitMode}set width(e){this._width=e,this._hasSplitAnchorsX||this._setCalculatedWidth(e,!0),this.fire("set:width",this._width)}get width(){return this._width}get worldCorners(){if(!this._worldCornersDirty)return this._worldCorners;if(this.screen){let e=this.screenCorners;if(!this.screen.screen.screenSpace){Da.copy(this.screen.screen._screenMatrix),Da.data[13]=-Da.data[13],Da.mul2(this.screen.getWorldTransform(),Da);for(let t=0;t<4;t++)Da.transformPoint(e[t],this._worldCorners[t])}}else{let e=this.entity.getLocalPosition();Da.setTranslate(-e.x,-e.y,-e.z),_P.setTRS(g.ZERO,this.entity.getLocalRotation(),this.entity.getLocalScale()),gP.setTranslate(e.x,e.y,e.z);let t=this.entity.parent?this.entity.parent:this.entity;Jp.copy(t.getWorldTransform()),Jp.mul(gP).mul(_P).mul(Da),vl.set(e.x-this.pivot.x*this.calculatedWidth,e.y-this.pivot.y*this.calculatedHeight,e.z),Jp.transformPoint(vl,this._worldCorners[0]),vl.set(e.x+(1-this.pivot.x)*this.calculatedWidth,e.y-this.pivot.y*this.calculatedHeight,e.z),Jp.transformPoint(vl,this._worldCorners[1]),vl.set(e.x+(1-this.pivot.x)*this.calculatedWidth,e.y+(1-this.pivot.y)*this.calculatedHeight,e.z),Jp.transformPoint(vl,this._worldCorners[2]),vl.set(e.x-this.pivot.x*this.calculatedWidth,e.y+(1-this.pivot.y)*this.calculatedHeight,e.z),Jp.transformPoint(vl,this._worldCorners[3])}return this._worldCornersDirty=!1,this._worldCorners}set fontSize(e){this._setValue("fontSize",e)}get fontSize(){return this._text?this._text.fontSize:null}set minFontSize(e){this._setValue("minFontSize",e)}get minFontSize(){return this._text?this._text.minFontSize:null}set maxFontSize(e){this._setValue("maxFontSize",e)}get maxFontSize(){return this._text?this._text.maxFontSize:null}set maxLines(e){this._setValue("maxLines",e)}get maxLines(){return this._text?this._text.maxLines:null}set autoFitWidth(e){this._setValue("autoFitWidth",e)}get autoFitWidth(){return this._text?this._text.autoFitWidth:null}set autoFitHeight(e){this._setValue("autoFitHeight",e)}get autoFitHeight(){return this._text?this._text.autoFitHeight:null}set color(e){this._setValue("color",e)}get color(){return this._text?this._text.color:this._image?this._image.color:null}set font(e){this._setValue("font",e)}get font(){return this._text?this._text.font:null}set fontAsset(e){this._setValue("fontAsset",e)}get fontAsset(){return this._text&&typeof this._text.fontAsset=="number"?this._text.fontAsset:null}set spacing(e){this._setValue("spacing",e)}get spacing(){return this._text?this._text.spacing:null}set lineHeight(e){this._setValue("lineHeight",e)}get lineHeight(){return this._text?this._text.lineHeight:null}set wrapLines(e){this._setValue("wrapLines",e)}get wrapLines(){return this._text?this._text.wrapLines:null}set lines(e){this._setValue("lines",e)}get lines(){return this._text?this._text.lines:null}set alignment(e){this._setValue("alignment",e)}get alignment(){return this._text?this._text.alignment:null}set autoWidth(e){this._setValue("autoWidth",e)}get autoWidth(){return this._text?this._text.autoWidth:null}set autoHeight(e){this._setValue("autoHeight",e)}get autoHeight(){return this._text?this._text.autoHeight:null}set rtlReorder(e){this._setValue("rtlReorder",e)}get rtlReorder(){return this._text?this._text.rtlReorder:null}set unicodeConverter(e){this._setValue("unicodeConverter",e)}get unicodeConverter(){return this._text?this._text.unicodeConverter:null}set text(e){this._setValue("text",e)}get text(){return this._text?this._text.text:null}set key(e){this._setValue("key",e)}get key(){return this._text?this._text.key:null}set texture(e){this._setValue("texture",e)}get texture(){return this._image?this._image.texture:null}set textureAsset(e){this._setValue("textureAsset",e)}get textureAsset(){return this._image?this._image.textureAsset:null}set material(e){this._setValue("material",e)}get material(){return this._image?this._image.material:null}set materialAsset(e){this._setValue("materialAsset",e)}get materialAsset(){return this._image?this._image.materialAsset:null}set sprite(e){this._setValue("sprite",e)}get sprite(){return this._image?this._image.sprite:null}set spriteAsset(e){this._setValue("spriteAsset",e)}get spriteAsset(){return this._image?this._image.spriteAsset:null}set spriteFrame(e){this._setValue("spriteFrame",e)}get spriteFrame(){return this._image?this._image.spriteFrame:null}set pixelsPerUnit(e){this._setValue("pixelsPerUnit",e)}get pixelsPerUnit(){return this._image?this._image.pixelsPerUnit:null}set opacity(e){this._setValue("opacity",e)}get opacity(){return this._text?this._text.opacity:this._image?this._image.opacity:null}set rect(e){this._setValue("rect",e)}get rect(){return this._image?this._image.rect:null}set mask(e){this._setValue("mask",e)}get mask(){return this._image?this._image.mask:null}set outlineColor(e){this._setValue("outlineColor",e)}get outlineColor(){return this._text?this._text.outlineColor:null}set outlineThickness(e){this._setValue("outlineThickness",e)}get outlineThickness(){return this._text?this._text.outlineThickness:null}set shadowColor(e){this._setValue("shadowColor",e)}get shadowColor(){return this._text?this._text.shadowColor:null}set shadowOffset(e){this._setValue("shadowOffset",e)}get shadowOffset(){return this._text?this._text.shadowOffset:null}set enableMarkup(e){this._setValue("enableMarkup",e)}get enableMarkup(){return this._text?this._text.enableMarkup:null}set rangeStart(e){this._setValue("rangeStart",e)}get rangeStart(){return this._text?this._text.rangeStart:null}set rangeEnd(e){this._setValue("rangeEnd",e)}get rangeEnd(){return this._text?this._text.rangeEnd:null}_setValue(e,t){this._text?(this._text[e]!==t&&this._dirtyBatch(),this._text[e]=t):this._image&&(this._image[e]!==t&&this._dirtyBatch(),this._image[e]=t)}_patch(){this.entity._sync=this._sync,this.entity.setPosition=this._setPosition,this.entity.setLocalPosition=this._setLocalPosition}_unpatch(){this.entity._sync=be.prototype._sync,this.entity.setPosition=be.prototype.setPosition,this.entity.setLocalPosition=be.prototype.setLocalPosition}_setPosition(e,t,s){if(!this.element.screen){be.prototype.setPosition.call(this,e,t,s);return}e instanceof g?EM.copy(e):EM.set(e,t,s),this.getWorldTransform(),Gj.copy(this.element._screenToWorld).invert(),Gj.transformPoint(EM,this.localPosition),this._dirtyLocal||this._dirtifyLocal()}_setLocalPosition(e,t,s){e instanceof g?this.localPosition.copy(e):this.localPosition.set(e,t,s);let i=this.element,r=this.localPosition,a=i._pivot;i._margin.x=r.x-i._calculatedWidth*a.x,i._margin.z=i._localAnchor.z-i._localAnchor.x-i._calculatedWidth-i._margin.x,i._margin.y=r.y-i._calculatedHeight*a.y,i._margin.w=i._localAnchor.w-i._localAnchor.y-i._calculatedHeight-i._margin.y,this._dirtyLocal||this._dirtifyLocal()}_sync(){let e=this.element,t=e.screen;if(t){if(e._anchorDirty){let s=0,i=0,r=0,a=1;if(this._parent&&this._parent.element)s=this._parent.element.calculatedWidth,i=this._parent.element.calculatedHeight,r=this._parent.element.pivot.x,a=this._parent.element.pivot.y;else{let n=t.screen.resolution;s=n.x/t.screen.scale,i=n.y/t.screen.scale}e._anchorTransform.setTranslate(s*(e.anchor.x-r),-(i*(a-e.anchor.y)),0),e._anchorDirty=!1,e._calculateLocalAnchors()}e._sizeDirty&&e._calculateSize(!1,!1)}if(this._dirtyLocal){this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale);let s=this.localPosition,i=e._pivot;e._margin.x=s.x-e._calculatedWidth*i.x,e._margin.z=e._localAnchor.z-e._localAnchor.x-e._calculatedWidth-e._margin.x,e._margin.y=s.y-e._calculatedHeight*i.y,e._margin.w=e._localAnchor.w-e._localAnchor.y-e._calculatedHeight-e._margin.y,this._dirtyLocal=!1}if(!t){this._dirtyWorld&&(e._cornersDirty=!0,e._canvasCornersDirty=!0,e._worldCornersDirty=!0),be.prototype._sync.call(this);return}if(this._dirtyWorld){if(this._parent===null)this.worldTransform.copy(this.localTransform);else if(this._parent.element?e._screenToWorld.mul2(this._parent.element._modelTransform,e._anchorTransform):e._screenToWorld.copy(e._anchorTransform),e._modelTransform.mul2(e._screenToWorld,this.localTransform),t){e._screenToWorld.mul2(t.screen._screenMatrix,e._screenToWorld),t.screen.screenSpace||e._screenToWorld.mul2(t.worldTransform,e._screenToWorld),this.worldTransform.mul2(e._screenToWorld,this.localTransform);let s=e._parentWorldTransform;s.setIdentity();let i=this._parent;i&&i.element&&i!==t&&(Da.setTRS(g.ZERO,i.getLocalRotation(),i.getLocalScale()),s.mul2(i.element._parentWorldTransform,Da));let r=vl;r.set(0,0,this.localPosition.z);let a=Soe;a.set(e._absLeft+e._pivot.x*e.calculatedWidth,e._absBottom+e._pivot.y*e.calculatedHeight,0),Da.setTranslate(-a.x,-a.y,-a.z),_P.setTRS(r,this.getLocalRotation(),this.getLocalScale()),gP.setTranslate(a.x,a.y,a.z),e._screenTransform.mul2(e._parentWorldTransform,gP).mul(_P).mul(Da),e._cornersDirty=!0,e._canvasCornersDirty=!0,e._worldCornersDirty=!0}else this.worldTransform.copy(e._modelTransform);this._dirtyWorld=!1}}_onInsert(e){let t=this._parseUpToScreen();this.entity._dirtifyWorld(),this._updateScreen(t.screen),this._dirtifyMask()}_dirtifyMask(){let e=this.entity;for(;e;){let t=e.parent;if((t===null||t.screen)&&e.element){(!this.system._prerender||!this.system._prerender.length)&&(this.system._prerender=[],this.system.app.once("prerender",this._onPrerender,this));let s=this.system._prerender.indexOf(this.entity);s>=0&&this.system._prerender.splice(s,1),this.system._prerender.indexOf(e)<0&&this.system._prerender.push(e)}e=t}}_onPrerender(){for(let e=0;e<this.system._prerender.length;e++){let t=this.system._prerender[e];t.element&&t.element.syncMask(1)}this.system._prerender.length=0}_bindScreen(e){e._bindElement(this)}_unbindScreen(e){e._unbindElement(this)}_updateScreen(e){this.screen&&this.screen!==e&&this._unbindScreen(this.screen.screen);let t=this.screen;this.screen=e,this.screen&&this._bindScreen(this.screen.screen),this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("set:screen",this.screen,t),this._anchorDirty=!0;let s=this.entity.children;for(let i=0,r=s.length;i<r;i++)s[i].element&&s[i].element._updateScreen(e);this.screen&&this.screen.screen.syncDrawOrder()}syncMask(e){let t=this._parseUpToScreen();this._updateMask(t.mask,e)}_setMaskedBy(e){let t=this._image||this._text;if(e){let s=e.element._image._maskRef;t?._setStencil(new ws({ref:s,func:2})),this._maskedBy=e}else t?._setStencil(null),this._maskedBy=null}_updateMask(e,t){if(e){if(this._setMaskedBy(e),this.mask){let i=e.element._image._maskRef,r=new ws({ref:i,func:2,zpass:xv});this._image._setStencil(r),this._image._maskRef=t,t++,e=this.entity}let s=this.entity.children;for(let i=0,r=s.length;i<r;i++)s[i].element?._updateMask(e,t);this.mask&&t--}else{if(this._setMaskedBy(null),this.mask){let i=new ws({ref:t,func:7,zpass:vv});this._image._setStencil(i),this._image._maskRef=t,t++,e=this.entity}let s=this.entity.children;for(let i=0,r=s.length;i<r;i++)s[i].element?._updateMask(e,t);this.mask&&t--}}_parseUpToScreen(){let e={screen:null,mask:null},t=this.entity._parent;for(;t&&!t.screen;)t.element&&t.element.mask&&(e.mask||(e.mask=t)),t=t.parent;return t&&t.screen&&(e.screen=t),e}_onScreenResize(e){this._anchorDirty=!0,this._cornersDirty=!0,this._worldCornersDirty=!0,this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("screen:set:resolution",e)}_onScreenSpaceChange(){this.fire("screen:set:screenspace",this.screen.screen.screenSpace)}_onScreenRemove(){this.screen&&(this.screen._destroying?this.screen=null:this._updateScreen(null))}_calculateLocalAnchors(){let e=1e3,t=1e3,s=this.entity._parent;if(s&&s.element)e=s.element.calculatedWidth,t=s.element.calculatedHeight;else if(this.screen){let i=this.screen.screen.resolution,r=this.screen.screen.scale;e=i.x/r,t=i.y/r}this._localAnchor.set(this._anchor.x*e,this._anchor.y*t,this._anchor.z*e,this._anchor.w*t)}getOffsetPosition(e,t){let s=this.entity.getLocalPosition().clone();return s.x+=e,s.y+=t,this._screenToWorld.transformPoint(s,s),s}onLayersChanged(e,t){this.addModelToLayers(this._image?this._image._renderable.model:this._text._model),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||(this._image?e.addMeshInstances(this._image._renderable.model.meshInstances):this._text&&e.addMeshInstances(this._text._model.meshInstances))}onLayerRemoved(e){this.layers.indexOf(e.id)<0||(this._image?e.removeMeshInstances(this._image._renderable.model.meshInstances):this._text&&e.removeMeshInstances(this._text._model.meshInstances))}onEnable(){let e=this.system.app.scene,t=e.layers;this._image&&this._image.onEnable(),this._text&&this._text.onEnable(),this._group&&this._group.onEnable(),this.useInput&&this.system.app.elementInput&&this.system.app.elementInput.addElement(this),this._evtLayersChanged=e.on("set:layers",this.onLayersChanged,this),t&&(this._evtLayerAdded=t.on("add",this.onLayerAdded,this),this._evtLayerRemoved=t.on("remove",this.onLayerRemoved,this)),this._batchGroupId>=0&&this.system.app.batcher?.insert(wt.ELEMENT,this.batchGroupId,this.entity),this.fire("enableelement")}onDisable(){let t=this.system.app.scene.layers;this._evtLayersChanged?.off(),this._evtLayersChanged=null,t&&(this._evtLayerAdded?.off(),this._evtLayerAdded=null,this._evtLayerRemoved?.off(),this._evtLayerRemoved=null),this._image&&this._image.onDisable(),this._text&&this._text.onDisable(),this._group&&this._group.onDisable(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),this._batchGroupId>=0&&this.system.app.batcher?.remove(wt.ELEMENT,this.batchGroupId,this.entity),this.fire("disableelement")}onRemove(){this.entity.off("insert",this._onInsert,this),this._unpatch(),this._image&&this._image.destroy(),this._text&&this._text.destroy(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),this.screen&&this.screen.screen&&(this._unbindScreen(this.screen.screen),this.screen.screen.syncDrawOrder()),this.off()}_calculateSize(e,t){if(!this.entity._parent&&!this.screen)return;this._calculateLocalAnchors();let s=this._absRight-this._absLeft,i=this._absTop-this._absBottom;e?this._setWidth(s):this._setCalculatedWidth(s,!1),t?this._setHeight(i):this._setCalculatedHeight(i,!1);let r=this.entity.getLocalPosition();r.x=this._margin.x+this._calculatedWidth*this._pivot.x,r.y=this._margin.y+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(r),this._sizeDirty=!1}_setWidth(e){this._width=e,this._setCalculatedWidth(e,!1),this.fire("set:width",this._width)}_setHeight(e){this._height=e,this._setCalculatedHeight(e,!1),this.fire("set:height",this._height)}_setCalculatedWidth(e,t){if(!(Math.abs(e-this._calculatedWidth)<=1e-4)){if(this._calculatedWidth=e,this.entity._dirtifyLocal(),t){let s=this.entity.getLocalPosition(),i=this._pivot;this._margin.x=s.x-this._calculatedWidth*i.x,this._margin.z=this._localAnchor.z-this._localAnchor.x-this._calculatedWidth-this._margin.x}this._flagChildrenAsDirty(),this.fire("set:calculatedWidth",this._calculatedWidth),this.fire("resize",this._calculatedWidth,this._calculatedHeight)}}_setCalculatedHeight(e,t){if(!(Math.abs(e-this._calculatedHeight)<=1e-4)){if(this._calculatedHeight=e,this.entity._dirtifyLocal(),t){let s=this.entity.getLocalPosition(),i=this._pivot;this._margin.y=s.y-this._calculatedHeight*i.y,this._margin.w=this._localAnchor.w-this._localAnchor.y-this._calculatedHeight-this._margin.y}this._flagChildrenAsDirty(),this.fire("set:calculatedHeight",this._calculatedHeight),this.fire("resize",this._calculatedWidth,this._calculatedHeight)}}_flagChildrenAsDirty(){let e=this.entity._children;for(let t=0,s=e.length;t<s;t++)e[t].element&&(e[t].element._anchorDirty=!0,e[t].element._sizeDirty=!0)}addModelToLayers(e){this._addedModels.push(e);for(let t=0;t<this.layers.length;t++){let s=this.system.app.scene.layers.getLayerById(this.layers[t]);s&&s.addMeshInstances(e.meshInstances)}}removeModelFromLayers(e){let t=this._addedModels.indexOf(e);t>=0&&this._addedModels.splice(t,1);for(let s=0;s<this.layers.length;s++){let i=this.system.app.scene.layers.getLayerById(this.layers[s]);i&&i.removeMeshInstances(e.meshInstances)}}getMaskOffset(){let e=this.system.app.frame;this._offsetReadAt!==e&&(this._maskOffset=.5,this._offsetReadAt=e);let t=this._maskOffset;return this._maskOffset-=.001,t}isVisibleForCamera(e){let t,s,i,r;if(this.maskedBy){let f=this.maskedBy.element.screenCorners;t=Math.min(Math.min(f[0].x,f[1].x),Math.min(f[2].x,f[3].x)),s=Math.max(Math.max(f[0].x,f[1].x),Math.max(f[2].x,f[3].x)),r=Math.min(Math.min(f[0].y,f[1].y),Math.min(f[2].y,f[3].y)),i=Math.max(Math.max(f[0].y,f[1].y),Math.max(f[2].y,f[3].y))}else{let f=this.system.app.graphicsDevice.width,d=this.system.app.graphicsDevice.height,u=e._rect.z*f,p=e._rect.w*d;t=e._rect.x*f,s=t+u,i=(1-e._rect.y)*d,r=i-p}let a=this.screenCorners,n=Math.min(Math.min(a[0].x,a[1].x),Math.min(a[2].x,a[3].x)),l=Math.max(Math.max(a[0].x,a[1].x),Math.max(a[2].x,a[3].x)),h=Math.min(Math.min(a[0].y,a[1].y),Math.min(a[2].y,a[3].y)),c=Math.max(Math.max(a[0].y,a[1].y),Math.max(a[2].y,a[3].y));return!(l<t||n>s||h>i||c<r)}_isScreenSpace(){return this.screen&&this.screen.screen?this.screen.screen.screenSpace:!1}_isScreenCulled(){return this.screen&&this.screen.screen?this.screen.screen.cull:!1}_dirtyBatch(){this.batchGroupId!==-1&&this.system.app.batcher?.markGroupDirty(this.batchGroupId)}}});var TP,zj=m(()=>{TP=class{constructor(){this.enabled=!0}}});var Toe,e_,vM=m(()=>{De();Ne();Ze();Fe();J();ln();Ut();zp();SP();zj();Toe=["enabled"],e_=class extends Me{constructor(e){super(e),this.id="element",this.ComponentType=Cc,this.DataType=TP,this.schema=Toe,this._unicodeConverter=null,this._rtlReorder=null,this._defaultTexture=new q(e.graphicsDevice,{width:1,height:1,format:20,name:"element-system"});let t=this._defaultTexture.lock(),s=new Uint8Array(4);s[0]=255,s[1]=255,s[2]=255,s[3]=255,t.set(s),this._defaultTexture.unlock(),this.defaultImageMaterial=null,this.defaultImage9SlicedMaterial=null,this.defaultImage9TiledMaterial=null,this.defaultImageMaskMaterial=null,this.defaultImage9SlicedMaskMaterial=null,this.defaultImage9TiledMaskMaterial=null,this.defaultScreenSpaceImageMaterial=null,this.defaultScreenSpaceImage9SlicedMaterial=null,this.defaultScreenSpaceImage9TiledMaterial=null,this.defaultScreenSpaceImageMask9SlicedMaterial=null,this.defaultScreenSpaceImageMask9TiledMaterial=null,this.defaultScreenSpaceImageMaskMaterial=null,this._defaultTextMaterials={},this.defaultImageMaterials=[],this.on("add",this.onAddComponent,this),this.on("beforeremove",this.onRemoveComponent,this)}destroy(){super.destroy(),this._defaultTexture.destroy()}initializeComponentData(e,t,s){e._beingInitialized=!0,t.anchor!==void 0&&(t.anchor instanceof W?e.anchor.copy(t.anchor):e.anchor.set(t.anchor[0],t.anchor[1],t.anchor[2],t.anchor[3])),t.pivot!==void 0&&(t.pivot instanceof D?e.pivot.copy(t.pivot):e.pivot.set(t.pivot[0],t.pivot[1]));let i=Math.abs(e.anchor.x-e.anchor.z)>.001,r=Math.abs(e.anchor.y-e.anchor.w)>.001,a=!1,n;t.margin!==void 0&&(t.margin instanceof W?e.margin.copy(t.margin):e._margin.set(t.margin[0],t.margin[1],t.margin[2],t.margin[3]),a=!0),t.left!==void 0&&(e._margin.x=t.left,a=!0),t.bottom!==void 0&&(e._margin.y=t.bottom,a=!0),t.right!==void 0&&(e._margin.z=t.right,a=!0),t.top!==void 0&&(e._margin.w=t.top,a=!0),a&&(e.margin=e._margin);let l=!1;t.width!==void 0&&!i?e.width=t.width:i&&(l=!0),t.height!==void 0&&!r?e.height=t.height:r&&(l=!0),l&&(e.anchor=e.anchor),t.enabled!==void 0&&(e.enabled=t.enabled),t.useInput!==void 0&&(e.useInput=t.useInput),t.fitMode!==void 0&&(e.fitMode=t.fitMode),e.batchGroupId=t.batchGroupId===void 0||t.batchGroupId===null?-1:t.batchGroupId,t.layers&&Array.isArray(t.layers)&&(e.layers=t.layers.slice(0)),t.type!==void 0&&(e.type=t.type),e.type===dd?(t.rect!==void 0&&(e.rect=t.rect),t.color!==void 0&&(n=t.color,n instanceof N||(n=new N(t.color[0],t.color[1],t.color[2])),e.color=n),t.opacity!==void 0&&(e.opacity=t.opacity),t.textureAsset!==void 0&&(e.textureAsset=t.textureAsset),t.texture&&(e.texture=t.texture),t.spriteAsset!==void 0&&(e.spriteAsset=t.spriteAsset),t.sprite&&(e.sprite=t.sprite),t.spriteFrame!==void 0&&(e.spriteFrame=t.spriteFrame),t.pixelsPerUnit!==void 0&&t.pixelsPerUnit!==null&&(e.pixelsPerUnit=t.pixelsPerUnit),t.materialAsset!==void 0&&(e.materialAsset=t.materialAsset),t.material&&(e.material=t.material),t.mask!==void 0&&(e.mask=t.mask)):e.type===Gp&&(t.autoWidth!==void 0&&(e.autoWidth=t.autoWidth),t.autoHeight!==void 0&&(e.autoHeight=t.autoHeight),t.rtlReorder!==void 0&&(e.rtlReorder=t.rtlReorder),t.unicodeConverter!==void 0&&(e.unicodeConverter=t.unicodeConverter),t.text!==null&&t.text!==void 0?e.text=t.text:t.key!==null&&t.key!==void 0&&(e.key=t.key),t.color!==void 0&&(n=t.color,n instanceof N||(n=new N(n[0],n[1],n[2])),e.color=n),t.opacity!==void 0&&(e.opacity=t.opacity),t.spacing!==void 0&&(e.spacing=t.spacing),t.fontSize!==void 0&&(e.fontSize=t.fontSize,t.lineHeight||(e.lineHeight=t.fontSize)),t.lineHeight!==void 0&&(e.lineHeight=t.lineHeight),t.maxLines!==void 0&&(e.maxLines=t.maxLines),t.wrapLines!==void 0&&(e.wrapLines=t.wrapLines),t.minFontSize!==void 0&&(e.minFontSize=t.minFontSize),t.maxFontSize!==void 0&&(e.maxFontSize=t.maxFontSize),t.autoFitWidth&&(e.autoFitWidth=t.autoFitWidth),t.autoFitHeight&&(e.autoFitHeight=t.autoFitHeight),t.fontAsset!==void 0&&(e.fontAsset=t.fontAsset),t.font!==void 0&&(e.font=t.font),t.alignment!==void 0&&(e.alignment=t.alignment),t.outlineColor!==void 0&&(e.outlineColor=t.outlineColor),t.outlineThickness!==void 0&&(e.outlineThickness=t.outlineThickness),t.shadowColor!==void 0&&(e.shadowColor=t.shadowColor),t.shadowOffset!==void 0&&(e.shadowOffset=t.shadowOffset),t.enableMarkup!==void 0&&(e.enableMarkup=t.enableMarkup));let h=e._parseUpToScreen();h.screen&&e._updateScreen(h.screen),super.initializeComponentData(e,t,s),e._beingInitialized=!1,e.type===dd&&e._image._meshDirty&&e._image._updateMesh(e._image.mesh)}onAddComponent(e,t){e.fire("element:add")}onRemoveComponent(e,t){t.onRemove()}cloneComponent(e,t){let s=e.element,i={enabled:s.enabled,width:s.width,height:s.height,anchor:s.anchor.clone(),pivot:s.pivot.clone(),margin:s.margin.clone(),alignment:s.alignment&&s.alignment.clone()||s.alignment,autoWidth:s.autoWidth,autoHeight:s.autoHeight,type:s.type,rect:s.rect&&s.rect.clone()||s.rect,rtlReorder:s.rtlReorder,unicodeConverter:s.unicodeConverter,materialAsset:s.materialAsset,material:s.material,color:s.color&&s.color.clone()||s.color,opacity:s.opacity,textureAsset:s.textureAsset,texture:s.texture,spriteAsset:s.spriteAsset,sprite:s.sprite,spriteFrame:s.spriteFrame,pixelsPerUnit:s.pixelsPerUnit,spacing:s.spacing,lineHeight:s.lineHeight,wrapLines:s.wrapLines,layers:s.layers,fontSize:s.fontSize,minFontSize:s.minFontSize,maxFontSize:s.maxFontSize,autoFitWidth:s.autoFitWidth,autoFitHeight:s.autoFitHeight,maxLines:s.maxLines,fontAsset:s.fontAsset,font:s.font,useInput:s.useInput,fitMode:s.fitMode,batchGroupId:s.batchGroupId,mask:s.mask,outlineColor:s.outlineColor&&s.outlineColor.clone()||s.outlineColor,outlineThickness:s.outlineThickness,shadowColor:s.shadowColor&&s.shadowColor.clone()||s.shadowColor,shadowOffset:s.shadowOffset&&s.shadowOffset.clone()||s.shadowOffset,enableMarkup:s.enableMarkup};return s.key!==void 0&&s.key!==null?i.key=s.key:i.text=s.text,this.addComponent(t,i)}getTextElementMaterial(e,t,s){let i=(e&&1)|(t&&2)|(s&&4),r=this._defaultTextMaterials[i];if(r)return r;let a="TextMaterial";return r=new ct,t?(r.msdfMap=this._defaultTexture,r.msdfTextAttribute=s,r.emissive.set(1,1,1)):(a=`Bitmap${a}`,r.emissive.set(1,1,1),r.emissiveMap=this._defaultTexture,r.opacityMap=this._defaultTexture,r.opacityMapChannel="a"),e&&(a=`ScreenSpace${a}`,r.depthTest=!1),r.name=`default${a}`,r.useLighting=!1,r.useTonemap=!1,r.useFog=!1,r.useSkybox=!1,r.diffuse.set(0,0,0),r.opacity=.5,r.blendType=er,r.depthWrite=!1,r.emissiveVertexColor=!0,r.update(),this._defaultTextMaterials[i]=r,r}_createBaseImageMaterial(){let e=new ct;return e.diffuse.set(0,0,0),e.emissive.set(1,1,1),e.emissiveMap=this._defaultTexture,e.opacityMap=this._defaultTexture,e.opacityMapChannel="a",e.useLighting=!1,e.useTonemap=!1,e.useFog=!1,e.useSkybox=!1,e.blendType=er,e.depthWrite=!1,e}getImageElementMaterial(e,t,s,i){return e?t?s?(this.defaultScreenSpaceImageMask9SlicedMaterial||(this.defaultScreenSpaceImageMask9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMask9SlicedMaterial.name="defaultScreenSpaceImageMask9SlicedMaterial",this.defaultScreenSpaceImageMask9SlicedMaterial.nineSlicedMode=Et,this.defaultScreenSpaceImageMask9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9SlicedMaterial.redWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9SlicedMaterial)),this.defaultScreenSpaceImageMask9SlicedMaterial):i?(this.defaultScreenSpaceImageMask9TiledMaterial||(this.defaultScreenSpaceImageMask9TiledMaterial=this.defaultScreenSpaceImage9TiledMaterial.clone(),this.defaultScreenSpaceImageMask9TiledMaterial.name="defaultScreenSpaceImageMask9TiledMaterial",this.defaultScreenSpaceImageMask9TiledMaterial.nineSlicedMode=vt,this.defaultScreenSpaceImageMask9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9TiledMaterial.redWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9TiledMaterial)),this.defaultScreenSpaceImageMask9TiledMaterial):(this.defaultScreenSpaceImageMaskMaterial||(this.defaultScreenSpaceImageMaskMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaskMaterial.name="defaultScreenSpaceImageMaskMaterial",this.defaultScreenSpaceImageMaskMaterial.depthTest=!1,this.defaultScreenSpaceImageMaskMaterial.alphaTest=1,this.defaultScreenSpaceImageMaskMaterial.redWrite=!1,this.defaultScreenSpaceImageMaskMaterial.greenWrite=!1,this.defaultScreenSpaceImageMaskMaterial.blueWrite=!1,this.defaultScreenSpaceImageMaskMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaskMaterial)),this.defaultScreenSpaceImageMaskMaterial):s?(this.defaultScreenSpaceImage9SlicedMaterial||(this.defaultScreenSpaceImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9SlicedMaterial.name="defaultScreenSpaceImage9SlicedMaterial",this.defaultScreenSpaceImage9SlicedMaterial.nineSlicedMode=Et,this.defaultScreenSpaceImage9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9SlicedMaterial)),this.defaultScreenSpaceImage9SlicedMaterial):i?(this.defaultScreenSpaceImage9TiledMaterial||(this.defaultScreenSpaceImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9TiledMaterial.name="defaultScreenSpaceImage9TiledMaterial",this.defaultScreenSpaceImage9TiledMaterial.nineSlicedMode=vt,this.defaultScreenSpaceImage9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9TiledMaterial)),this.defaultScreenSpaceImage9TiledMaterial):(this.defaultScreenSpaceImageMaterial||(this.defaultScreenSpaceImageMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaterial.name="defaultScreenSpaceImageMaterial",this.defaultScreenSpaceImageMaterial.depthTest=!1,this.defaultScreenSpaceImageMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaterial)),this.defaultScreenSpaceImageMaterial):t?s?(this.defaultImage9SlicedMaskMaterial||(this.defaultImage9SlicedMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaskMaterial.name="defaultImage9SlicedMaskMaterial",this.defaultImage9SlicedMaskMaterial.nineSlicedMode=Et,this.defaultImage9SlicedMaskMaterial.alphaTest=1,this.defaultImage9SlicedMaskMaterial.redWrite=!1,this.defaultImage9SlicedMaskMaterial.greenWrite=!1,this.defaultImage9SlicedMaskMaterial.blueWrite=!1,this.defaultImage9SlicedMaskMaterial.alphaWrite=!1,this.defaultImage9SlicedMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaskMaterial)),this.defaultImage9SlicedMaskMaterial):i?(this.defaultImage9TiledMaskMaterial||(this.defaultImage9TiledMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaskMaterial.name="defaultImage9TiledMaskMaterial",this.defaultImage9TiledMaskMaterial.nineSlicedMode=vt,this.defaultImage9TiledMaskMaterial.alphaTest=1,this.defaultImage9TiledMaskMaterial.redWrite=!1,this.defaultImage9TiledMaskMaterial.greenWrite=!1,this.defaultImage9TiledMaskMaterial.blueWrite=!1,this.defaultImage9TiledMaskMaterial.alphaWrite=!1,this.defaultImage9TiledMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaskMaterial)),this.defaultImage9TiledMaskMaterial):(this.defaultImageMaskMaterial||(this.defaultImageMaskMaterial=this._createBaseImageMaterial(),this.defaultImageMaskMaterial.name="defaultImageMaskMaterial",this.defaultImageMaskMaterial.alphaTest=1,this.defaultImageMaskMaterial.redWrite=!1,this.defaultImageMaskMaterial.greenWrite=!1,this.defaultImageMaskMaterial.blueWrite=!1,this.defaultImageMaskMaterial.alphaWrite=!1,this.defaultImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaskMaterial)),this.defaultImageMaskMaterial):s?(this.defaultImage9SlicedMaterial||(this.defaultImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaterial.name="defaultImage9SlicedMaterial",this.defaultImage9SlicedMaterial.nineSlicedMode=Et,this.defaultImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaterial)),this.defaultImage9SlicedMaterial):i?(this.defaultImage9TiledMaterial||(this.defaultImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaterial.name="defaultImage9TiledMaterial",this.defaultImage9TiledMaterial.nineSlicedMode=vt,this.defaultImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaterial)),this.defaultImage9TiledMaterial):(this.defaultImageMaterial||(this.defaultImageMaterial=this._createBaseImageMaterial(),this.defaultImageMaterial.name="defaultImageMaterial",this.defaultImageMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaterial)),this.defaultImageMaterial)}registerUnicodeConverter(e){this._unicodeConverter=e}registerRtlReorder(e){this._rtlReorder=e}getUnicodeConverter(){return this._unicodeConverter}getRtlReorder(){return this._rtlReorder}}});var xl,yl,Al,xM=m(()=>{xl="free",yl="limited",Al="locked"});var Eoe,Ic,voe,yM=m(()=>{me();Ke();Ve();Ne();We();xM();Eoe=["angularDampingX","angularDampingY","angularDampingZ","angularEquilibriumX","angularEquilibriumY","angularEquilibriumZ","angularLimitsX","angularLimitsY","angularLimitsZ","angularMotionX","angularMotionY","angularMotionZ","angularSpringX","angularSpringY","angularSpringZ","angularStiffnessX","angularStiffnessY","angularStiffnessZ","breakForce","enableCollision","enabled","entityA","entityB","linearDampingX","linearDampingY","linearDampingZ","linearEquilibriumX","linearEquilibriumY","linearEquilibriumZ","linearLimitsX","linearLimitsY","linearLimitsZ","linearMotionX","linearMotionY","linearMotionZ","linearSpringX","linearSpringY","linearSpringZ","linearStiffnessX","linearStiffnessY","linearStiffnessZ"],Ic=class extends ae{constructor(e,t){super(e,t),this._constraint=null,this._entityA=null,this._entityB=null,this._breakForce=34e37,this._enableCollision=!0,this._linearMotionX=Al,this._linearLimitsX=new D(0,0),this._linearSpringX=!1,this._linearStiffnessX=0,this._linearDampingX=1,this._linearEquilibriumX=0,this._linearMotionY=Al,this._linearLimitsY=new D(0,0),this._linearSpringY=!1,this._linearStiffnessY=0,this._linearDampingY=1,this._linearEquilibriumY=0,this._linearMotionZ=Al,this._linearLimitsZ=new D(0,0),this._linearSpringZ=!1,this._linearStiffnessZ=0,this._linearDampingZ=1,this._linearEquilibriumZ=0,this._angularMotionX=Al,this._angularLimitsX=new D(0,0),this._angularSpringX=!1,this._angularStiffnessX=0,this._angularDampingX=1,this._angularEquilibriumX=0,this._angularMotionY=Al,this._angularLimitsY=new D(0,0),this._angularSpringY=!1,this._angularStiffnessY=0,this._angularDampingY=1,this._angularEquilibriumY=0,this._angularMotionZ=Al,this._angularLimitsZ=new D(0,0),this._angularSpringZ=!1,this._angularEquilibriumZ=0,this._angularDampingZ=1,this._angularStiffnessZ=0,this.on("set_enabled",this._onSetEnabled,this)}set entityA(e){this._destroyConstraint(),this._entityA=e,this._createConstraint()}get entityA(){return this._entityA}set entityB(e){this._destroyConstraint(),this._entityB=e,this._createConstraint()}get entityB(){return this._entityB}set breakForce(e){this._constraint&&this._breakForce!==e&&(this._constraint.setBreakingImpulseThreshold(e),this._breakForce=e)}get breakForce(){return this._breakForce}set enableCollision(e){this._destroyConstraint(),this._enableCollision=e,this._createConstraint()}get enableCollision(){return this._enableCollision}set angularLimitsX(e){this._angularLimitsX.equals(e)||(this._angularLimitsX.copy(e),this._updateAngularLimits())}get angularLimitsX(){return this._angularLimitsX}set angularMotionX(e){this._angularMotionX!==e&&(this._angularMotionX=e,this._updateAngularLimits())}get angularMotionX(){return this._angularMotionX}set angularLimitsY(e){this._angularLimitsY.equals(e)||(this._angularLimitsY.copy(e),this._updateAngularLimits())}get angularLimitsY(){return this._angularLimitsY}set angularMotionY(e){this._angularMotionY!==e&&(this._angularMotionY=e,this._updateAngularLimits())}get angularMotionY(){return this._angularMotionY}set angularLimitsZ(e){this._angularLimitsZ.equals(e)||(this._angularLimitsZ.copy(e),this._updateAngularLimits())}get angularLimitsZ(){return this._angularLimitsZ}set angularMotionZ(e){this._angularMotionZ!==e&&(this._angularMotionZ=e,this._updateAngularLimits())}get angularMotionZ(){return this._angularMotionZ}set linearLimitsX(e){this._linearLimitsX.equals(e)||(this._linearLimitsX.copy(e),this._updateLinearLimits())}get linearLimitsX(){return this._linearLimitsX}set linearMotionX(e){this._linearMotionX!==e&&(this._linearMotionX=e,this._updateLinearLimits())}get linearMotionX(){return this._linearMotionX}set linearLimitsY(e){this._linearLimitsY.equals(e)||(this._linearLimitsY.copy(e),this._updateLinearLimits())}get linearLimitsY(){return this._linearLimitsY}set linearMotionY(e){this._linearMotionY!==e&&(this._linearMotionY=e,this._updateLinearLimits())}get linearMotionY(){return this._linearMotionY}set linearLimitsZ(e){this._linearLimitsZ.equals(e)||(this._linearLimitsZ.copy(e),this._updateLinearLimits())}get linearLimitsZ(){return this._linearLimitsZ}set linearMotionZ(e){this._linearMotionZ!==e&&(this._linearMotionZ=e,this._updateLinearLimits())}get linearMotionZ(){return this._linearMotionZ}_convertTransform(e,t){let s=e.getTranslation(),i=new H;i.setFromMat4(e);let r=new Ammo.btVector3(s.x,s.y,s.z),a=new Ammo.btQuaternion(i.x,i.y,i.z,i.w);t.setOrigin(r),t.setRotation(a),Ammo.destroy(r),Ammo.destroy(a)}_updateAngularLimits(){let e=this._constraint;if(e){let t,s,i,r,a,n;this._angularMotionX===yl?(t=this._angularLimitsX.x*w.DEG_TO_RAD,r=this._angularLimitsX.y*w.DEG_TO_RAD):this._angularMotionX===xl?(t=1,r=0):t=r=0,this._angularMotionY===yl?(s=this._angularLimitsY.x*w.DEG_TO_RAD,a=this._angularLimitsY.y*w.DEG_TO_RAD):this._angularMotionY===xl?(s=1,a=0):s=a=0,this._angularMotionZ===yl?(i=this._angularLimitsZ.x*w.DEG_TO_RAD,n=this._angularLimitsZ.y*w.DEG_TO_RAD):this._angularMotionZ===xl?(i=1,n=0):i=n=0;let l=new Ammo.btVector3(t,s,i);e.setAngularLowerLimit(l),l.setValue(r,a,n),e.setAngularUpperLimit(l),Ammo.destroy(l)}}_updateLinearLimits(){let e=this._constraint;if(e){let t,s,i,r,a,n;this._linearMotionX===yl?(t=this._linearLimitsX.x,r=this._linearLimitsX.y):this._linearMotionX===xl?(t=1,r=0):t=r=0,this._linearMotionY===yl?(s=this._linearLimitsY.x,a=this._linearLimitsY.y):this._linearMotionY===xl?(s=1,a=0):s=a=0,this._linearMotionZ===yl?(i=this._linearLimitsZ.x,n=this._linearLimitsZ.y):this._linearMotionZ===xl?(i=1,n=0):i=n=0;let l=new Ammo.btVector3(t,s,i);e.setLinearLowerLimit(l),l.setValue(r,a,n),e.setLinearUpperLimit(l),Ammo.destroy(l)}}_createConstraint(){if(this._entityA&&this._entityA.rigidbody){this._destroyConstraint();let e=new k,t=this._entityA.rigidbody.body;t.activate();let s=this.entity.getWorldTransform(),r=this._entityA.getWorldTransform().clone().invert();e.mul2(r,s);let a=new Ammo.btTransform;if(this._convertTransform(e,a),this._entityB&&this._entityB.rigidbody){let c=this._entityB.rigidbody.body;c.activate();let d=this._entityB.getWorldTransform().clone().invert();e.mul2(d,s);let u=new Ammo.btTransform;this._convertTransform(e,u),this._constraint=new Ammo.btGeneric6DofSpringConstraint(t,c,a,u,!this._enableCollision),Ammo.destroy(u)}else this._constraint=new Ammo.btGeneric6DofSpringConstraint(t,a,!this._enableCollision);Ammo.destroy(a);let n=["X","Y","Z","X","Y","Z"];for(let c=0;c<6;c++){let f=c<3?"_linear":"_angular";this._constraint.enableSpring(c,this[`${f}Spring${n[c]}`]),this._constraint.setDamping(c,this[`${f}Damping${n[c]}`]),this._constraint.setEquilibriumPoint(c,this[`${f}Equilibrium${n[c]}`]),this._constraint.setStiffness(c,this[`${f}Stiffness${n[c]}`])}this._constraint.setBreakingImpulseThreshold(this._breakForce),this._updateLinearLimits(),this._updateAngularLimits(),this.system.app.systems.rigidbody.dynamicsWorld.addConstraint(this._constraint,!this._enableCollision)}}_destroyConstraint(){this._constraint&&(this.system.app.systems.rigidbody.dynamicsWorld.removeConstraint(this._constraint),Ammo.destroy(this._constraint),this._constraint=null)}initFromData(e){for(let t of Eoe)e.hasOwnProperty(t)&&(e[t]instanceof D?this[`_${t}`].copy(e[t]):this[`_${t}`]=e[t]);this._createConstraint()}onEnable(){this._createConstraint()}onDisable(){this._destroyConstraint()}_onSetEnabled(e,t,s){}_onBeforeRemove(){this.fire("remove")}},voe={Damping:"setDamping",Equilibrium:"setEquilibriumPoint",Spring:"enableSpring",Stiffness:"setStiffness"};["linear","angular"].forEach(o=>{["Damping","Equilibrium","Spring","Stiffness"].forEach(e=>{["X","Y","Z"].forEach(t=>{let s=o+e+t,i=`_${s}`,r=o==="linear"?0:3;t==="Y"&&(r+=1),t==="Z"&&(r+=2),Object.defineProperty(Ic.prototype,s,{get:function(){return this[i]},set:function(a){this[i]!==a&&(this[i]=a,this._constraint[voe[e]](r,a))}})})})})});var EP,Hj=m(()=>{EP=class{constructor(){this.enabled=!0}}});var AM,t_,PM=m(()=>{We();Ut();yM();Hj();AM=["enabled"],t_=class extends Me{constructor(e){super(e),this.id="joint",this.app=e,this.ComponentType=Ic,this.DataType=EP,this.schema=AM}initializeComponentData(e,t,s){e.initFromData(t),super.initializeComponentData(e,t,AM)}};ae._buildAccessors(Ic.prototype,AM)});var gd,RM=m(()=>{We();gd=class extends ae{set minWidth(e){e!==this._minWidth&&(this._minWidth=e,this.fire("resize"))}get minWidth(){return this._minWidth}set minHeight(e){e!==this._minHeight&&(this._minHeight=e,this.fire("resize"))}get minHeight(){return this._minHeight}set maxWidth(e){e!==this._maxWidth&&(this._maxWidth=e,this.fire("resize"))}get maxWidth(){return this._maxWidth}set maxHeight(e){e!==this._maxHeight&&(this._maxHeight=e,this.fire("resize"))}get maxHeight(){return this._maxHeight}set fitWidthProportion(e){e!==this._fitWidthProportion&&(this._fitWidthProportion=e,this.fire("resize"))}get fitWidthProportion(){return this._fitWidthProportion}set fitHeightProportion(e){e!==this._fitHeightProportion&&(this._fitHeightProportion=e,this.fire("resize"))}get fitHeightProportion(){return this._fitHeightProportion}set excludeFromLayout(e){e!==this._excludeFromLayout&&(this._excludeFromLayout=e,this.fire("resize"))}get excludeFromLayout(){return this._excludeFromLayout}constructor(...e){super(...e),this._minWidth=0,this._minHeight=0,this._maxWidth=null,this._maxHeight=null,this._fitWidthProportion=0,this._fitHeightProportion=0,this._excludeFromLayout=!1}}});var vP,Xj=m(()=>{vP=class{constructor(){this.enabled=!0}}});var Wj,s_,CM=m(()=>{We();Ut();RM();Xj();Wj=["enabled"],s_=class extends Me{constructor(e){super(e),this.id="layoutchild",this.ComponentType=gd,this.DataType=vP,this.schema=Wj}initializeComponentData(e,t,s){t.enabled!==void 0&&(e.enabled=t.enabled),t.minWidth!==void 0&&(e.minWidth=t.minWidth),t.minHeight!==void 0&&(e.minHeight=t.minHeight),t.maxWidth!==void 0&&(e.maxWidth=t.maxWidth),t.maxHeight!==void 0&&(e.maxHeight=t.maxHeight),t.fitWidthProportion!==void 0&&(e.fitWidthProportion=t.fitWidthProportion),t.fitHeightProportion!==void 0&&(e.fitHeightProportion=t.fitHeightProportion),t.excludeFromLayout!==void 0&&(e.excludeFromLayout=t.excludeFromLayout),super.initializeComponentData(e,t,s)}cloneComponent(e,t){let s=e.layoutchild;return this.addComponent(t,{enabled:s.enabled,minWidth:s.minWidth,minHeight:s.minHeight,maxWidth:s.maxWidth,maxHeight:s.maxHeight,fitWidthProportion:s.fitWidthProportion,fitHeightProportion:s.fitHeightProportion,excludeFromLayout:s.excludeFromLayout})}};ae._buildAccessors(gd.prototype,Wj)});var NT,IM,xP,wM,Yj=m(()=>{NT=0,IM=1,xP=2,wM=3});function Kj(o){let e,t=yP[o],s=yP[LM[o]];function i(I,b){return-b[t.size]*I.pivot[t.axis]}function r(I,b){return-b[s.size]*I.pivot[s.axis]}function a(I,b){return b[t.size]*(1-I.pivot[t.axis])}function n(I,b){I=I.filter(l),e=b,Fr.x=e.containerSize.x-e.padding.x-e.padding.z,Fr.y=e.containerSize.y-e.padding.y-e.padding.w,h(I);let F=f(c(I)),B=u(F,d(F)),V=A(F,B);return E(F,B,V),v(F,B,V),R(F)}function l(I){let b=I.entity.layoutchild;return!b||!b.enabled||!b.excludeFromLayout}function h(I){for(let b=0;b<I.length;++b){let F=I[b],B=F.anchor;(B.x!==0||B.y!==0||B.z!==0||B.w!==0)&&(F.anchor=W.ZERO)}}function c(I){if(!e.wrap)return[I];let b=[[]],F=P(I),B=0,V=e[t.fitting]===2;for(let z=0;z<I.length;++z){b[b.length-1].length>0&&(B+=e.spacing[t.axis]);let ee=F[z][t.size];B+=ee,!V&&B>Fr[t.axis]&&b[b.length-1].length!==0&&(B=ee,b.push([])),b[b.length-1].push(I[z]),V&&B>Fr[t.axis]&&z!==I.length-1&&(B=0,b.push([]))}return b}function f(I){let b=e.orientation===Ue&&e.reverseX||e.orientation===it&&e.reverseY,F=e.orientation===Ue&&e.reverseY||e.orientation===it&&e.reverseX;if(b)for(let B=0;B<I.length;++B)b&&I[B].reverse();return F&&I.reverse(),I}function d(I){let b=[];for(let F=0;F<I.length;++F){let B=I[F],V=P(B),z=_(V,t),ee=p(e[t.fitting],z,Fr[t.axis]);ee===Nr.APPLY_STRETCHING?S(V,z,t):ee===Nr.APPLY_SHRINKING&&T(V,z,t),b.push(V)}return b}function u(I,b){let F=[],B=[];for(let ee=0;ee<I.length;++ee){let se=I[ee];se.largestElement=null,se.largestSize={width:Number.NEGATIVE_INFINITY,height:Number.NEGATIVE_INFINITY};for(let Y=0;Y<se.length;++Y){let ne=b[ee][Y];ne[s.size]>se.largestSize[s.size]&&(se.largestElement=se[Y],se.largestSize=ne)}F.push(se.largestElement),B.push(se.largestSize)}let V=_(B,s),z=p(e[s.fitting],V,Fr[s.axis]);z===Nr.APPLY_STRETCHING?S(B,V,s):z===Nr.APPLY_SHRINKING&&T(B,V,s);for(let ee=0;ee<I.length;++ee){let se=I[ee];for(let Y=0;Y<se.length;++Y){let ne=b[ee][Y],ce=ne[s.size],ze=I.length===1?Fr[s.axis]:se.largestSize[s.size],Bt=p(e[s.fitting],ce,ze);Bt===Nr.APPLY_STRETCHING?ne[s.size]=Math.min(ze,ne[s.maxSize]):Bt===Nr.APPLY_SHRINKING&&(ne[s.size]=Math.max(ze,ne[s.minSize]))}}return b}function p(I,b,F){switch(I){case 0:return Nr.NONE;case 1:return b<F?Nr.APPLY_STRETCHING:Nr.NONE;case 2:return b>=F?Nr.APPLY_SHRINKING:Nr.NONE;case 3:return b<F?Nr.APPLY_STRETCHING:Nr.APPLY_SHRINKING;default:throw new Error(`Unrecognized fitting mode: ${I}`)}}function _(I,b){let F=L(I,b.size),B=(I.length-1)*e.spacing[b.axis];return F+B}function S(I,b,F){let B=U(I,F.maxSize),V=O(I,F.fittingProportion),z=X(V,B),ee=Fr[F.axis]-b;for(let se=0;se<I.length;++se){let Y=B[se],ne=x(Y,ee,V,z),ce=I[Y][F.size]+ne,ze=I[Y][F.maxSize],Bt=Math.min(ce,ze);I[Y][F.size]=Bt;let Lt=Math.max(ce-Bt,0),Kt=ne-Lt;ee-=Kt}}function T(I,b,F){let B=U(I,F.minSize,!0),V=O(I,F.fittingProportion),z=M(V),ee=X(z,B),se=b-Fr[F.axis];for(let Y=0;Y<I.length;++Y){let ne=B[Y],ce=x(ne,se,z,ee),ze=I[ne][F.size]-ce,Bt=I[ne][F.minSize],Lt=Math.max(ze,Bt);I[ne][F.size]=Lt;let Kt=Math.max(Lt-ze,0),Va=ce-Kt;se-=Va}}function x(I,b,F,B){let V=F[I],z=B[I];return Math.abs(V)<1e-5&&Math.abs(z)<1e-5?b:b*V/z}function A(I,b){let F={};F[t.axis]=0,F[s.axis]=0,I[t.size]=Number.NEGATIVE_INFINITY;let B=[];for(let V=0;V<I.length;++V){let z=I[V];if(z.length===0){B.push([]);continue}let ee=[],se=b[V];for(let Y=0;Y<z.length;++Y){let ne=z[Y],ce=se[Y];F[s.axis]-=r(ne,ce),F[t.axis]-=i(ne,ce),ee[Y]={},ee[Y][t.axis]=F[t.axis],ee[Y][s.axis]=F[s.axis],F[s.axis]+=r(ne,ce),F[t.axis]+=a(ne,ce)+e.spacing[t.axis]}z[t.size]=F[t.axis]-e.spacing[t.axis],z[s.size]=z.largestSize[s.size],I[t.size]=Math.max(I[t.size],z[t.size]),F[t.axis]=0,F[s.axis]+=z[s.size]+e.spacing[s.axis],B.push(ee)}return I[s.size]=F[s.axis]-e.spacing[s.axis],B}function E(I,b,F){let B=e.alignment[t.axis],V=e.alignment[s.axis],z=e.padding[t.axis],ee=e.padding[s.axis];for(let se=0;se<I.length;++se){let Y=I[se],ne=b[se],ce=F[se],ze=(Fr[t.axis]-Y[t.size])*B+z,Bt=(Fr[s.axis]-I[s.size])*V+ee;for(let Lt=0;Lt<Y.length;++Lt){let Kt=(Y[s.size]-ne[Lt][s.size])*e.alignment[s.axis];ce[Lt][t.axis]+=ze,ce[Lt][s.axis]+=Bt+Kt}}}function v(I,b,F){for(let B=0;B<I.length;++B){let V=I[B],z=b[B],ee=F[B];for(let se=0;se<V.length;++se){let Y=V[se];Y[t.calculatedSize]=z[se][t.size],Y[s.calculatedSize]=z[se][s.size],e.orientation===Ue?Y.entity.setLocalPosition(ee[se][t.axis],ee[se][s.axis],Y.entity.getLocalPosition().z):Y.entity.setLocalPosition(ee[se][s.axis],ee[se][t.axis],Y.entity.getLocalPosition().z)}}}function R(I){let b=I.width,F=I.height,B=(Fr.x-b)*e.alignment.x+e.padding.x,V=(Fr.y-F)*e.alignment.y+e.padding.y;return{bounds:new W(B,V,b,F)}}function P(I){let b=[];for(let F=0;F<I.length;++F){let B=I[F],V=Math.max(y(B,"minWidth"),0),z=Math.max(y(B,"minHeight"),0),ee=Math.max(y(B,"maxWidth"),V),se=Math.max(y(B,"maxHeight"),z),Y=C(y(B,"width"),V,ee),ne=C(y(B,"height"),z,se),ce=y(B,"fitWidthProportion"),ze=y(B,"fitHeightProportion");b.push({minWidth:V,minHeight:z,maxWidth:ee,maxHeight:se,width:Y,height:ne,fitWidthProportion:ce,fitHeightProportion:ze})}return b}function y(I,b){let F=I.entity.layoutchild;return F&&F.enabled&&F[b]!==void 0&&F[b]!==null?F[b]:I[b]!==void 0?I[b]:xoe[b]}function C(I,b,F){return Math.min(Math.max(I,b),F)}function L(I,b){return I.reduce((F,B)=>F+B[b],0)}function O(I,b){let F=L(I,b),B=[],V=I.length;if(F===0)for(let z=0;z<V;++z)B.push(1/V);else for(let z=0;z<V;++z)B.push(I[z][b]/F);return B}function M(I){if(I.length===1)return[1];let b=[],F=I.length;for(let B=0;B<F;++B)b.push((1-I[B])/(F-1));return b}function U(I,b,F){return I.forEach(G),I.slice().sort((B,V)=>F?V[b]-B[b]:B[b]-V[b]).map($)}function G(I,b){I.index=b}function $(I){return I.index}function X(I,b){let F=[];F[b[I.length-1]]=I[b[I.length-1]];for(let B=I.length-2;B>=0;--B)F[b[B]]=F[b[B+1]]+I[b[B]];return F}return n}var yP,LM,xoe,Nr,Fr,bM,i_,MM=m(()=>{Ne();Ze();J();yP={};yP[Ue]={axis:"x",size:"width",calculatedSize:"calculatedWidth",minSize:"minWidth",maxSize:"maxWidth",fitting:"widthFitting",fittingProportion:"fitWidthProportion"};yP[it]={axis:"y",size:"height",calculatedSize:"calculatedHeight",minSize:"minHeight",maxSize:"maxHeight",fitting:"heightFitting",fittingProportion:"fitHeightProportion"};LM={};LM[Ue]=it;LM[it]=Ue;xoe={minWidth:0,minHeight:0,maxWidth:Number.POSITIVE_INFINITY,maxHeight:Number.POSITIVE_INFINITY,width:null,height:null,fitWidthProportion:0,fitHeightProportion:0},Nr={NONE:"NONE",APPLY_STRETCHING:"APPLY_STRETCHING",APPLY_SHRINKING:"APPLY_SHRINKING"},Fr=new D;bM={};bM[Ue]=Kj(Ue);bM[it]=Kj(it);i_=class{calculateLayout(e,t){let s=bM[t.orientation];if(s)return s(e,t);throw new Error(`Unrecognized orientation value: ${t.orientation}`)}}});function qj(o){return o.element}function yoe(o){return o.enabled&&o.element&&o.element.enabled}var Sd,DM=m(()=>{Ne();Ze();J();We();MM();Sd=class extends ae{constructor(e,t){super(e,t),this._orientation=Ue,this._reverseX=!1,this._reverseY=!0,this._alignment=new D(0,1),this._padding=new W,this._spacing=new D,this._widthFitting=0,this._heightFitting=0,this._wrap=!1,this._layoutCalculator=new i_,this._listenForReflowEvents(this.entity,"on"),this.entity.children.forEach(s=>{this._listenForReflowEvents(s,"on")}),this.entity.on("childinsert",this._onChildInsert,this),this.entity.on("childremove",this._onChildRemove,this),e.app.systems.element.on("add",this._onElementOrLayoutComponentAdd,this),e.app.systems.element.on("beforeremove",this._onElementOrLayoutComponentRemove,this),e.app.systems.layoutchild.on("add",this._onElementOrLayoutComponentAdd,this),e.app.systems.layoutchild.on("beforeremove",this._onElementOrLayoutComponentRemove,this)}set orientation(e){e!==this._orientation&&(this._orientation=e,this._scheduleReflow())}get orientation(){return this._orientation}set reverseX(e){e!==this._reverseX&&(this._reverseX=e,this._scheduleReflow())}get reverseX(){return this._reverseX}set reverseY(e){e!==this._reverseY&&(this._reverseY=e,this._scheduleReflow())}get reverseY(){return this._reverseY}set alignment(e){e.equals(this._alignment)||(this._alignment.copy(e),this._scheduleReflow())}get alignment(){return this._alignment}set padding(e){e.equals(this._padding)||(this._padding.copy(e),this._scheduleReflow())}get padding(){return this._padding}set spacing(e){e.equals(this._spacing)||(this._spacing.copy(e),this._scheduleReflow())}get spacing(){return this._spacing}set widthFitting(e){e!==this._widthFitting&&(this._widthFitting=e,this._scheduleReflow())}get widthFitting(){return this._widthFitting}set heightFitting(e){e!==this._heightFitting&&(this._heightFitting=e,this._scheduleReflow())}get heightFitting(){return this._heightFitting}set wrap(e){e!==this._wrap&&(this._wrap=e,this._scheduleReflow())}get wrap(){return this._wrap}_isSelfOrChild(e){return e===this.entity||this.entity.children.indexOf(e)!==-1}_listenForReflowEvents(e,t){e.element&&(e.element[t]("enableelement",this._scheduleReflow,this),e.element[t]("disableelement",this._scheduleReflow,this),e.element[t]("resize",this._scheduleReflow,this),e.element[t]("set:pivot",this._scheduleReflow,this)),e.layoutchild&&(e.layoutchild[t]("set_enabled",this._scheduleReflow,this),e.layoutchild[t]("resize",this._scheduleReflow,this))}_onElementOrLayoutComponentAdd(e){this._isSelfOrChild(e)&&(this._listenForReflowEvents(e,"on"),this._scheduleReflow())}_onElementOrLayoutComponentRemove(e){this._isSelfOrChild(e)&&(this._listenForReflowEvents(e,"off"),this._scheduleReflow())}_onChildInsert(e){this._listenForReflowEvents(e,"on"),this._scheduleReflow()}_onChildRemove(e){this._listenForReflowEvents(e,"off"),this._scheduleReflow()}_scheduleReflow(){this.enabled&&this.entity&&this.entity.enabled&&!this._isPerformingReflow&&this.system.scheduleReflow(this)}reflow(){let e=qj(this.entity),t=this.entity.children.filter(yoe).map(qj);if(!e||t.length===0)return;let s=Math.max(e.calculatedWidth,0),i=Math.max(e.calculatedHeight,0),r={orientation:this._orientation,reverseX:this._reverseX,reverseY:this._reverseY,alignment:this._alignment,padding:this._padding,spacing:this._spacing,widthFitting:this._widthFitting,heightFitting:this._heightFitting,wrap:this._wrap,containerSize:new D(s,i)};this._isPerformingReflow=!0;let a=this._layoutCalculator.calculateLayout(t,r);this._isPerformingReflow=!1,this.fire("reflow",a)}onEnable(){this._scheduleReflow()}onRemove(){this.entity.off("childinsert",this._onChildInsert,this),this.entity.off("childremove",this._onChildRemove,this),this._listenForReflowEvents(this.entity,"off"),this.entity.children.forEach(e=>{this._listenForReflowEvents(e,"off")}),this.system.app.systems.element.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.element.off("beforeremove",this._onElementOrLayoutComponentRemove,this),this.system.app.systems.layoutchild.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.layoutchild.off("beforeremove",this._onElementOrLayoutComponentRemove,this)}}});var AP,jj=m(()=>{AP=class{constructor(){this.enabled=!0}}});var $j,Aoe,r_,OM=m(()=>{Ne();Ze();We();Ut();DM();jj();$j=["enabled"],Aoe=100,r_=class extends Me{constructor(e){super(e),this.id="layoutgroup",this.ComponentType=Sd,this.DataType=AP,this.schema=$j,this._reflowQueue=[],this.on("beforeremove",this._onRemoveComponent,this),this.app.systems.on("postUpdate",this._onPostUpdate,this)}initializeComponentData(e,t,s){t.enabled!==void 0&&(e.enabled=t.enabled),t.orientation!==void 0&&(e.orientation=t.orientation),t.reverseX!==void 0&&(e.reverseX=t.reverseX),t.reverseY!==void 0&&(e.reverseY=t.reverseY),t.alignment!==void 0&&(e.alignment=Array.isArray(t.alignment)?new D(t.alignment):t.alignment),t.padding!==void 0&&(e.padding=Array.isArray(t.padding)?new W(t.padding):t.padding),t.spacing!==void 0&&(e.spacing=Array.isArray(t.spacing)?new D(t.spacing):t.spacing),t.widthFitting!==void 0&&(e.widthFitting=t.widthFitting),t.heightFitting!==void 0&&(e.heightFitting=t.heightFitting),t.wrap!==void 0&&(e.wrap=t.wrap),super.initializeComponentData(e,t,s)}cloneComponent(e,t){let s=e.layoutgroup;return this.addComponent(t,{enabled:s.enabled,orientation:s.orientation,reverseX:s.reverseX,reverseY:s.reverseY,alignment:s.alignment,padding:s.padding,spacing:s.spacing,widthFitting:s.widthFitting,heightFitting:s.heightFitting,wrap:s.wrap})}scheduleReflow(e){this._reflowQueue.indexOf(e)===-1&&this._reflowQueue.push(e)}_onPostUpdate(){this._processReflowQueue()}_processReflowQueue(){if(this._reflowQueue.length===0)return;let e=0;for(;this._reflowQueue.length>0;){let t=this._reflowQueue.slice();this._reflowQueue.length=0,t.sort((s,i)=>s.entity.graphDepth-i.entity.graphDepth);for(let s=0;s<t.length;++s)t[s].reflow();if(++e>=Aoe){console.warn("Max reflow iterations limit reached, bailing.");break}}}_onRemoveComponent(e,t){t.onRemove()}destroy(){super.destroy(),this.app.systems.off("postUpdate",this._onPostUpdate,this)}};ae._buildAccessors(Sd.prototype,$j)});var NM,Poe,PP,FM=m(()=>{Ne();YA();fp();rd();up();Ws();Zh();td();dp();bi();NM=class{destroy(e){this.map.forEach(t=>t.mesh.destroy())}constructor(){this.map=new Map}},Poe=new st,PP=(o,e)=>{let t=Poe.get(o,()=>new NM),s=t.map.get(e);if(!s){let i,r;switch(e){case"box":i=Ce.fromGeometry(o,new hi),r={x:2,y:2,z:2,uv:2/3};break;case"capsule":i=Ce.fromGeometry(o,new nc({radius:.5,height:2})),r={x:Math.PI*2,y:Math.PI,z:Math.PI*2,uv:1/3+1/3/3*2};break;case"cone":i=Ce.fromGeometry(o,new Ia({baseRadius:.5,peakRadius:0,height:1})),r={x:2.54,y:2.54,z:2.54,uv:1/3+1/3/3};break;case"cylinder":i=Ce.fromGeometry(o,new hr({radius:.5,height:1})),r={x:Math.PI,y:.79*2,z:Math.PI,uv:1/3+1/3/3*2};break;case"plane":i=Ce.fromGeometry(o,new wa({halfExtents:new D(.5,.5),widthSegments:1,lengthSegments:1})),r={x:0,y:1,z:0,uv:1};break;case"sphere":i=Ce.fromGeometry(o,new or({radius:.5})),r={x:Math.PI,y:Math.PI,z:Math.PI,uv:1};break;case"torus":i=Ce.fromGeometry(o,new Dr({tubeRadius:.2,ringRadius:.3})),r={x:Math.PI*.5*.5-Math.PI*.1*.1,y:.4,z:.4,uv:1};break;default:throw new Error(`Invalid primitive type: ${e}`)}i.incRefCount(),s={mesh:i,area:r},t.map.set(e,s)}return s}});var Pl,RP=m(()=>{J();Xf();Zt();_s();ll();FM();rt();We();Pl=class extends ae{constructor(e,t){super(e,t),this._type="asset",this._asset=null,this._model=null,this._mapping={},this._castShadows=!0,this._receiveShadows=!0,this._materialAsset=null,this._castShadowsLightmap=!0,this._lightmapped=!1,this._lightmapSizeMultiplier=1,this.isStatic=!1,this._layers=[ms],this._batchGroupId=-1,this._customAabb=null,this._area=null,this._materialEvents=null,this._clonedModel=!1,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._material=e.defaultMaterial,t.on("remove",this.onRemoveChild,this),t.on("removehierarchy",this.onRemoveChild,this),t.on("insert",this.onInsertChild,this),t.on("inserthierarchy",this.onInsertChild,this)}set meshInstances(e){this._model&&(this._model.meshInstances=e)}get meshInstances(){return this._model?this._model.meshInstances:null}set customAabb(e){if(this._customAabb=e,this._model){let t=this._model.meshInstances;if(t)for(let s=0;s<t.length;s++)t[s].setCustomAabb(this._customAabb)}}get customAabb(){return this._customAabb}set type(e){if(this._type!==e)if(this._area=null,this._type=e,e==="asset")this._asset!==null?this._bindModelAsset(this._asset):this.model=null;else{let t=PP(this.system.app.graphicsDevice,e);this._area=t.area;let s=t.mesh,i=new Ae,r=new Ys;r.graph=i,r.meshInstances=[new Oe(s,this._material,i)],this.model=r,this._asset=null}}get type(){return this._type}set asset(e){let t=this.system.app.assets,s=e;if(e instanceof re&&(s=e.id),this._asset!==s){if(this._asset){t.off(`add:${this._asset}`,this._onModelAssetAdded,this);let i=t.get(this._asset);i&&this._unbindModelAsset(i)}if(this._asset=s,this._asset){let i=t.get(this._asset);i?this._bindModelAsset(i):(this.model=null,t.on(`add:${this._asset}`,this._onModelAssetAdded,this))}else this.model=null}}get asset(){return this._asset}set model(e){if(this._model!==e&&!(e&&e._immutable)&&(this._model&&(this._model._immutable=!1,this.removeModelFromLayers(),this._model.getGraph().destroy(),delete this._model._entity,this._clonedModel&&(this._model.destroy(),this._clonedModel=!1)),this._model=e,this._model)){this._model._immutable=!0;let t=this._model.meshInstances;for(let s=0;s<t.length;s++)t[s].castShadow=this._castShadows,t[s].receiveShadow=this._receiveShadows,t[s].setCustomAabb(this._customAabb);this.lightmapped=this._lightmapped,this.entity.addChild(this._model.graph),this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._model._entity=this.entity,this.entity.animation&&this.entity.animation.setModel(this._model),this.entity.anim&&this.entity.anim.rebind(),this.type==="asset"?this.mapping=this._mapping:this._unsetMaterialEvents()}}get model(){return this._model}set lightmapped(e){if(e!==this._lightmapped&&(this._lightmapped=e,this._model)){let t=this._model.meshInstances;for(let s=0;s<t.length;s++)t[s].setLightmapped(e)}}get lightmapped(){return this._lightmapped}set castShadows(e){if(this._castShadows===e)return;let t=this._model;if(t){let s=this.layers,i=this.system.app.scene;if(this._castShadows&&!e)for(let a=0;a<s.length;a++){let n=this.system.app.scene.layers.getLayerById(this.layers[a]);n&&n.removeShadowCasters(t.meshInstances)}let r=t.meshInstances;for(let a=0;a<r.length;a++)r[a].castShadow=e;if(!this._castShadows&&e)for(let a=0;a<s.length;a++){let n=i.layers.getLayerById(s[a]);n&&n.addShadowCasters(t.meshInstances)}}this._castShadows=e}get castShadows(){return this._castShadows}set receiveShadows(e){if(this._receiveShadows!==e&&(this._receiveShadows=e,this._model)){let t=this._model.meshInstances;for(let s=0,i=t.length;s<i;s++)t[s].receiveShadow=e}}get receiveShadows(){return this._receiveShadows}set castShadowsLightmap(e){this._castShadowsLightmap=e}get castShadowsLightmap(){return this._castShadowsLightmap}set lightmapSizeMultiplier(e){this._lightmapSizeMultiplier=e}get lightmapSizeMultiplier(){return this._lightmapSizeMultiplier}set layers(e){let t=this.system.app.scene.layers;if(this.meshInstances)for(let s=0;s<this._layers.length;s++){let i=t.getLayerById(this._layers[s]);i&&i.removeMeshInstances(this.meshInstances)}this._layers.length=0;for(let s=0;s<e.length;s++)this._layers[s]=e[s];if(!(!this.enabled||!this.entity.enabled||!this.meshInstances))for(let s=0;s<this._layers.length;s++){let i=t.getLayerById(this._layers[s]);i&&i.addMeshInstances(this.meshInstances)}}get layers(){return this._layers}set batchGroupId(e){this._batchGroupId!==e&&(this.entity.enabled&&this._batchGroupId>=0&&this.system.app.batcher?.remove(wt.MODEL,this.batchGroupId,this.entity),this.entity.enabled&&e>=0&&this.system.app.batcher?.insert(wt.MODEL,e,this.entity),e<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._batchGroupId=e)}get batchGroupId(){return this._batchGroupId}set materialAsset(e){let t=e;e instanceof re&&(t=e.id);let s=this.system.app.assets;if(t!==this._materialAsset){if(this._materialAsset){s.off(`add:${this._materialAsset}`,this._onMaterialAssetAdd,this);let i=s.get(this._materialAsset);i&&this._unbindMaterialAsset(i)}if(this._materialAsset=t,this._materialAsset){let i=s.get(this._materialAsset);i?this._bindMaterialAsset(i):(this._setMaterial(this.system.defaultMaterial),s.on(`add:${this._materialAsset}`,this._onMaterialAssetAdd,this))}else this._setMaterial(this.system.defaultMaterial)}}get materialAsset(){return this._materialAsset}set material(e){this._material!==e&&(this.materialAsset=null,this._setMaterial(e))}get material(){return this._material}set mapping(e){if(this._type!=="asset"||(this._unsetMaterialEvents(),e||(e={}),this._mapping=e,!this._model))return;let t=this._model.meshInstances,s=this.asset?this.system.app.assets.get(this.asset):null,i=s?s.data.mapping:null,r=null;for(let a=0,n=t.length;a<n;a++)if(e[a]!==void 0)e[a]?(r=this.system.app.assets.get(e[a]),this._loadAndSetMeshInstanceMaterial(r,t[a],a)):t[a].material=this.system.defaultMaterial;else if(i)if(i[a]&&(i[a].material||i[a].path)){if(i[a].material!==void 0)r=this.system.app.assets.get(i[a].material);else if(i[a].path!==void 0){let l=this._getMaterialAssetUrl(i[a].path);l&&(r=this.system.app.assets.getByUrl(l))}this._loadAndSetMeshInstanceMaterial(r,t[a],a)}else t[a].material=this.system.defaultMaterial}get mapping(){return this._mapping}addModelToLayers(){let e=this.system.app.scene.layers;for(let t=0;t<this._layers.length;t++){let s=e.getLayerById(this._layers[t]);s&&s.addMeshInstances(this.meshInstances)}}removeModelFromLayers(){let e=this.system.app.scene.layers;for(let t=0;t<this._layers.length;t++){let s=e.getLayerById(this._layers[t]);s&&s.removeMeshInstances(this.meshInstances)}}onRemoveChild(){this._model&&this.removeModelFromLayers()}onInsertChild(){this._model&&this.enabled&&this.entity.enabled&&this.addModelToLayers()}onRemove(){this.asset=null,this.model=null,this.materialAsset=null,this._unsetMaterialEvents(),this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(e,t){this.addModelToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||e.addMeshInstances(this.meshInstances)}onLayerRemoved(e){this.layers.indexOf(e.id)<0||e.removeMeshInstances(this.meshInstances)}_setMaterialEvent(e,t,s,i){let r=`${t}:${s}`;this.system.app.assets.on(r,i,this),this._materialEvents||(this._materialEvents=[]),this._materialEvents[e]||(this._materialEvents[e]={}),this._materialEvents[e][r]={id:s,handler:i}}_unsetMaterialEvents(){let e=this.system.app.assets,t=this._materialEvents;if(t){for(let s=0,i=t.length;s<i;s++){if(!t[s])continue;let r=t[s];for(let a in r)e.off(a,r[a].handler,this)}this._materialEvents=null}}_getAssetByIdOrPath(e){let t=null;if(!isNaN(parseInt(e,10)))t=this.system.app.assets.get(e);else if(this.asset){let i=this._getMaterialAssetUrl(e);i&&(t=this.system.app.assets.getByUrl(i))}return t}_getMaterialAssetUrl(e){if(!this.asset)return null;let t=this.system.app.assets.get(this.asset);return t?t.getAbsoluteUrl(e):null}_loadAndSetMeshInstanceMaterial(e,t,s){let i=this.system.app.assets;e&&(e.resource?(t.material=e.resource,this._setMaterialEvent(s,"remove",e.id,function(){t.material=this.system.defaultMaterial})):(this._setMaterialEvent(s,"load",e.id,function(r){t.material=r.resource,this._setMaterialEvent(s,"remove",e.id,function(){t.material=this.system.defaultMaterial})}),this.enabled&&this.entity.enabled&&i.load(e)))}onEnable(){let e=this.system.app,t=e.scene,s=t?.layers;this._evtLayersChanged=t.on("set:layers",this.onLayersChanged,this),s&&(this._evtLayerAdded=s.on("add",this.onLayerAdded,this),this._evtLayerRemoved=s.on("remove",this.onLayerRemoved,this));let i=this._type==="asset",r;if(this._model?this.addModelToLayers():i&&this._asset&&(r=e.assets.get(this._asset),r&&r.resource!==this._model&&this._bindModelAsset(r)),this._materialAsset&&(r=e.assets.get(this._materialAsset),r&&r.resource!==this._material&&this._bindMaterialAsset(r)),i&&this._mapping)for(let a in this._mapping)this._mapping[a]&&(r=this._getAssetByIdOrPath(this._mapping[a]),r&&!r.resource&&e.assets.load(r));this._batchGroupId>=0&&e.batcher?.insert(wt.MODEL,this.batchGroupId,this.entity)}onDisable(){let e=this.system.app,s=e.scene.layers;this._evtLayersChanged?.off(),this._evtLayersChanged=null,s&&(this._evtLayerAdded?.off(),this._evtLayerAdded=null,this._evtLayerRemoved?.off(),this._evtLayerRemoved=null),this._batchGroupId>=0&&e.batcher?.remove(wt.MODEL,this.batchGroupId,this.entity),this._model&&this.removeModelFromLayers()}hide(){if(this._model){let e=this._model.meshInstances;for(let t=0,s=e.length;t<s;t++)e[t].visible=!1}}show(){if(this._model){let e=this._model.meshInstances;for(let t=0,s=e.length;t<s;t++)e[t].visible=!0}}_bindMaterialAsset(e){if(e.on("load",this._onMaterialAssetLoad,this),e.on("unload",this._onMaterialAssetUnload,this),e.on("remove",this._onMaterialAssetRemove,this),e.on("change",this._onMaterialAssetChange,this),e.resource)this._onMaterialAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindMaterialAsset(e){e.off("load",this._onMaterialAssetLoad,this),e.off("unload",this._onMaterialAssetUnload,this),e.off("remove",this._onMaterialAssetRemove,this),e.off("change",this._onMaterialAssetChange,this)}_onMaterialAssetAdd(e){this.system.app.assets.off(`add:${e.id}`,this._onMaterialAssetAdd,this),this._materialAsset===e.id&&this._bindMaterialAsset(e)}_onMaterialAssetLoad(e){this._setMaterial(e.resource)}_onMaterialAssetUnload(e){this._setMaterial(this.system.defaultMaterial)}_onMaterialAssetRemove(e){this._onMaterialAssetUnload(e)}_onMaterialAssetChange(e){}_bindModelAsset(e){if(this._unbindModelAsset(e),e.on("load",this._onModelAssetLoad,this),e.on("unload",this._onModelAssetUnload,this),e.on("change",this._onModelAssetChange,this),e.on("remove",this._onModelAssetRemove,this),e.resource)this._onModelAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindModelAsset(e){e.off("load",this._onModelAssetLoad,this),e.off("unload",this._onModelAssetUnload,this),e.off("change",this._onModelAssetChange,this),e.off("remove",this._onModelAssetRemove,this)}_onModelAssetAdded(e){this.system.app.assets.off(`add:${e.id}`,this._onModelAssetAdded,this),e.id===this._asset&&this._bindModelAsset(e)}_onModelAssetLoad(e){this.model=e.resource.clone(),this._clonedModel=!0}_onModelAssetUnload(e){this.model=null}_onModelAssetChange(e,t,s,i){t==="data"&&(this.mapping=this._mapping)}_onModelAssetRemove(e){this.model=null}_setMaterial(e){if(this._material===e)return;this._material=e;let t=this._model;if(t&&this._type!=="asset"){let s=t.meshInstances;for(let i=0,r=s.length;i<r;i++)s[i].material=e}}}});var CP,Zj=m(()=>{CP=class{constructor(){this.enabled=!0}}});var Qj,a_,UM=m(()=>{su();Q();Vt();Vh();rt();We();Ut();RP();Zj();Qj=["enabled"],a_=class extends Me{constructor(e){super(e),this.id="model",this.ComponentType=Pl,this.DataType=CP,this.schema=Qj,this.defaultMaterial=va(e.graphicsDevice),this.on("beforeremove",this.onRemove,this)}initializeComponentData(e,t,s){s=["material","materialAsset","asset","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","type","mapping","layers","isStatic","batchGroupId"],(t.batchGroupId===null||t.batchGroupId===void 0)&&(t.batchGroupId=-1),t.layers&&t.layers.length&&(t.layers=t.layers.slice(0));for(let i=0;i<s.length;i++)t.hasOwnProperty(s[i])&&(e[s[i]]=t[s[i]]);t.aabbCenter&&t.aabbHalfExtents&&(e.customAabb=new _e(new g(t.aabbCenter),new g(t.aabbHalfExtents))),super.initializeComponentData(e,t,["enabled"])}cloneComponent(e,t){let s={type:e.model.type,asset:e.model.asset,castShadows:e.model.castShadows,receiveShadows:e.model.receiveShadows,castShadowsLightmap:e.model.castShadowsLightmap,lightmapped:e.model.lightmapped,lightmapSizeMultiplier:e.model.lightmapSizeMultiplier,isStatic:e.model.isStatic,enabled:e.model.enabled,layers:e.model.layers,batchGroupId:e.model.batchGroupId,mapping:Hl({},e.model.mapping)},i=e.model.materialAsset;!(i instanceof re)&&i!=null&&(i=this.app.assets.get(i));let r=e.model.material;(!r||r===this.defaultMaterial||!i||r===i.resource)&&(s.materialAsset=i);let a=this.addComponent(t,s);if(e.model.model&&e.model.type==="asset"&&!e.model.asset&&(a.model=e.model.model.clone(),a._clonedModel=!0),s.materialAsset||(a.material=r),e.model.model){let n=e.model.model.meshInstances,l=a.model.meshInstances;for(let h=0;h<n.length;h++)l[h].mask=n[h].mask,l[h].material=n[h].material,l[h].layer=n[h].layer,l[h].receiveShadow=n[h].receiveShadow}return e.model.customAabb&&(a.customAabb=e.model.customAabb.clone()),a}onRemove(e,t){t.onRemove()}};ae._buildAccessors(Pl.prototype,Qj)});var Roe,Coe,Ioe,IP,n_,o_,BM=m(()=>{J();Ws();ZL();rt();We();Roe=["emitterExtents","emitterRadius","emitterExtentsInner","emitterRadiusInner","loop","initialVelocity","animSpeed","normalMap","particleNormal"],Coe=["numParticles","lifetime","rate","rate2","startAngle","startAngle2","lighting","halfLambert","intensity","wrap","wrapBounds","depthWrite","noFog","sort","stretch","alignToMotion","preWarm","emitterShape","animTilesX","animTilesY","animStartFrame","animNumFrames","animNumAnimations","animIndex","randomizeAnimIndex","animLoop","colorMap","localSpace","screenSpace","orientation"],Ioe=["scaleGraph","scaleGraph2","colorGraph","colorGraph2","alphaGraph","alphaGraph2","velocityGraph","velocityGraph2","localVelocityGraph","localVelocityGraph2","rotationSpeedGraph","rotationSpeedGraph2","radialSpeedGraph","radialSpeedGraph2"],IP=["colorMapAsset","normalMapAsset","meshAsset","renderAsset"],o_=class extends ae{constructor(e,t){super(e,t),this._requestedDepth=!1,this._drawOrder=0,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._evtSetMeshes=null,this.on("set_colorMapAsset",this.onSetColorMapAsset,this),this.on("set_normalMapAsset",this.onSetNormalMapAsset,this),this.on("set_meshAsset",this.onSetMeshAsset,this),this.on("set_mesh",this.onSetMesh,this),this.on("set_renderAsset",this.onSetRenderAsset,this),this.on("set_loop",this.onSetLoop,this),this.on("set_blendType",this.onSetBlendType,this),this.on("set_depthSoftening",this.onSetDepthSoftening,this),this.on("set_layers",this.onSetLayers,this),Roe.forEach(s=>{this.on(`set_${s}`,this.onSetSimpleProperty,this)}),Coe.forEach(s=>{this.on(`set_${s}`,this.onSetComplexProperty,this)}),Ioe.forEach(s=>{this.on(`set_${s}`,this.onSetGraphProperty,this)})}get data(){let e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){this._setValue("enabled",e)}get enabled(){return this.data.enabled}set autoPlay(e){this._setValue("autoPlay",e)}get autoPlay(){return this.data.autoPlay}set numParticles(e){this._setValue("numParticles",e)}get numParticles(){return this.data.numParticles}set lifetime(e){this._setValue("lifetime",e)}get lifetime(){return this.data.lifetime}set rate(e){this._setValue("rate",e)}get rate(){return this.data.rate}set rate2(e){this._setValue("rate2",e)}get rate2(){return this.data.rate2}set startAngle(e){this._setValue("startAngle",e)}get startAngle(){return this.data.startAngle}set startAngle2(e){this._setValue("startAngle2",e)}get startAngle2(){return this.data.startAngle2}set loop(e){this._setValue("loop",e)}get loop(){return this.data.loop}set preWarm(e){this._setValue("preWarm",e)}get preWarm(){return this.data.preWarm}set lighting(e){this._setValue("lighting",e)}get lighting(){return this.data.lighting}set halfLambert(e){this._setValue("halfLambert",e)}get halfLambert(){return this.data.halfLambert}set intensity(e){this._setValue("intensity",e)}get intensity(){return this.data.intensity}set depthWrite(e){this._setValue("depthWrite",e)}get depthWrite(){return this.data.depthWrite}set noFog(e){this._setValue("noFog",e)}get noFog(){return this.data.noFog}set depthSoftening(e){this._setValue("depthSoftening",e)}get depthSoftening(){return this.data.depthSoftening}set sort(e){this._setValue("sort",e)}get sort(){return this.data.sort}set blendType(e){this._setValue("blendType",e)}get blendType(){return this.data.blendType}set stretch(e){this._setValue("stretch",e)}get stretch(){return this.data.stretch}set alignToMotion(e){this._setValue("alignToMotion",e)}get alignToMotion(){return this.data.alignToMotion}set emitterShape(e){this._setValue("emitterShape",e)}get emitterShape(){return this.data.emitterShape}set emitterExtents(e){this._setValue("emitterExtents",e)}get emitterExtents(){return this.data.emitterExtents}set emitterExtentsInner(e){this._setValue("emitterExtentsInner",e)}get emitterExtentsInner(){return this.data.emitterExtentsInner}set emitterRadius(e){this._setValue("emitterRadius",e)}get emitterRadius(){return this.data.emitterRadius}set emitterRadiusInner(e){this._setValue("emitterRadiusInner",e)}get emitterRadiusInner(){return this.data.emitterRadiusInner}set initialVelocity(e){this._setValue("initialVelocity",e)}get initialVelocity(){return this.data.initialVelocity}set wrap(e){this._setValue("wrap",e)}get wrap(){return this.data.wrap}set wrapBounds(e){this._setValue("wrapBounds",e)}get wrapBounds(){return this.data.wrapBounds}set localSpace(e){this._setValue("localSpace",e)}get localSpace(){return this.data.localSpace}set screenSpace(e){this._setValue("screenSpace",e)}get screenSpace(){return this.data.screenSpace}set colorMapAsset(e){this._setValue("colorMapAsset",e)}get colorMapAsset(){return this.data.colorMapAsset}set normalMapAsset(e){this._setValue("normalMapAsset",e)}get normalMapAsset(){return this.data.normalMapAsset}set mesh(e){this._setValue("mesh",e)}get mesh(){return this.data.mesh}set meshAsset(e){this._setValue("meshAsset",e)}get meshAsset(){return this.data.meshAsset}set renderAsset(e){this._setValue("renderAsset",e)}get renderAsset(){return this.data.renderAsset}set orientation(e){this._setValue("orientation",e)}get orientation(){return this.data.orientation}set particleNormal(e){this._setValue("particleNormal",e)}get particleNormal(){return this.data.particleNormal}set localVelocityGraph(e){this._setValue("localVelocityGraph",e)}get localVelocityGraph(){return this.data.localVelocityGraph}set localVelocityGraph2(e){this._setValue("localVelocityGraph2",e)}get localVelocityGraph2(){return this.data.localVelocityGraph2}set velocityGraph(e){this._setValue("velocityGraph",e)}get velocityGraph(){return this.data.velocityGraph}set velocityGraph2(e){this._setValue("velocityGraph2",e)}get velocityGraph2(){return this.data.velocityGraph2}set rotationSpeedGraph(e){this._setValue("rotationSpeedGraph",e)}get rotationSpeedGraph(){return this.data.rotationSpeedGraph}set rotationSpeedGraph2(e){this._setValue("rotationSpeedGraph2",e)}get rotationSpeedGraph2(){return this.data.rotationSpeedGraph2}set radialSpeedGraph(e){this._setValue("radialSpeedGraph",e)}get radialSpeedGraph(){return this.data.radialSpeedGraph}set radialSpeedGraph2(e){this._setValue("radialSpeedGraph2",e)}get radialSpeedGraph2(){return this.data.radialSpeedGraph2}set scaleGraph(e){this._setValue("scaleGraph",e)}get scaleGraph(){return this.data.scaleGraph}set scaleGraph2(e){this._setValue("scaleGraph2",e)}get scaleGraph2(){return this.data.scaleGraph2}set colorGraph(e){this._setValue("colorGraph",e)}get colorGraph(){return this.data.colorGraph}set colorGraph2(e){this._setValue("colorGraph2",e)}get colorGraph2(){return this.data.colorGraph2}set alphaGraph(e){this._setValue("alphaGraph",e)}get alphaGraph(){return this.data.alphaGraph}set alphaGraph2(e){this._setValue("alphaGraph2",e)}get alphaGraph2(){return this.data.alphaGraph2}set colorMap(e){this._setValue("colorMap",e)}get colorMap(){return this.data.colorMap}set normalMap(e){this._setValue("normalMap",e)}get normalMap(){return this.data.normalMap}set animTilesX(e){this._setValue("animTilesX",e)}get animTilesX(){return this.data.animTilesX}set animTilesY(e){this._setValue("animTilesY",e)}get animTilesY(){return this.data.animTilesY}set animStartFrame(e){this._setValue("animStartFrame",e)}get animStartFrame(){return this.data.animStartFrame}set animNumFrames(e){this._setValue("animNumFrames",e)}get animNumFrames(){return this.data.animNumFrames}set animNumAnimations(e){this._setValue("animNumAnimations",e)}get animNumAnimations(){return this.data.animNumAnimations}set animIndex(e){this._setValue("animIndex",e)}get animIndex(){return this.data.animIndex}set randomizeAnimIndex(e){this._setValue("randomizeAnimIndex",e)}get randomizeAnimIndex(){return this.data.randomizeAnimIndex}set animSpeed(e){this._setValue("animSpeed",e)}get animSpeed(){return this.data.animSpeed}set animLoop(e){this._setValue("animLoop",e)}get animLoop(){return this.data.animLoop}set layers(e){this._setValue("layers",e)}get layers(){return this.data.layers}set drawOrder(e){this._drawOrder=e,this.emitter&&(this.emitter.drawOrder=e)}get drawOrder(){return this._drawOrder}_setValue(e,t){let s=this.data,i=s[e];s[e]=t,this.fire("set",e,i,t)}addMeshInstanceToLayers(){if(this.emitter)for(let e=0;e<this.layers.length;e++){let t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&(t.addMeshInstances([this.emitter.meshInstance]),this.emitter._layer=t)}}removeMeshInstanceFromLayers(){if(this.emitter)for(let e=0;e<this.layers.length;e++){let t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&t.removeMeshInstances([this.emitter.meshInstance])}}onSetLayers(e,t,s){if(this.emitter){for(let i=0;i<t.length;i++){let r=this.system.app.scene.layers.getLayerById(t[i]);r&&r.removeMeshInstances([this.emitter.meshInstance])}if(!(!this.enabled||!this.entity.enabled))for(let i=0;i<s.length;i++){let r=this.system.app.scene.layers.getLayerById(s[i]);r&&r.addMeshInstances([this.emitter.meshInstance])}}}onLayersChanged(e,t){this.addMeshInstanceToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){!this.emitter||this.layers.indexOf(e.id)<0||e.addMeshInstances([this.emitter.meshInstance])}onLayerRemoved(e){!this.emitter||this.layers.indexOf(e.id)<0||e.removeMeshInstances([this.emitter.meshInstance])}_bindColorMapAsset(e){if(e.on("load",this._onColorMapAssetLoad,this),e.on("unload",this._onColorMapAssetUnload,this),e.on("remove",this._onColorMapAssetRemove,this),e.on("change",this._onColorMapAssetChange,this),e.resource)this._onColorMapAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindColorMapAsset(e){e.off("load",this._onColorMapAssetLoad,this),e.off("unload",this._onColorMapAssetUnload,this),e.off("remove",this._onColorMapAssetRemove,this),e.off("change",this._onColorMapAssetChange,this)}_onColorMapAssetLoad(e){this.colorMap=e.resource}_onColorMapAssetUnload(e){this.colorMap=null}_onColorMapAssetRemove(e){this._onColorMapAssetUnload(e)}_onColorMapAssetChange(e){}onSetColorMapAsset(e,t,s){let i=this.system.app.assets;if(t){let r=i.get(t);r&&this._unbindColorMapAsset(r)}if(s){s instanceof re&&(this.data.colorMapAsset=s.id,s=s.id);let r=i.get(s);r?this._bindColorMapAsset(r):i.once(`add:${s}`,a=>{this._bindColorMapAsset(a)})}else this.colorMap=null}_bindNormalMapAsset(e){if(e.on("load",this._onNormalMapAssetLoad,this),e.on("unload",this._onNormalMapAssetUnload,this),e.on("remove",this._onNormalMapAssetRemove,this),e.on("change",this._onNormalMapAssetChange,this),e.resource)this._onNormalMapAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindNormalMapAsset(e){e.off("load",this._onNormalMapAssetLoad,this),e.off("unload",this._onNormalMapAssetUnload,this),e.off("remove",this._onNormalMapAssetRemove,this),e.off("change",this._onNormalMapAssetChange,this)}_onNormalMapAssetLoad(e){this.normalMap=e.resource}_onNormalMapAssetUnload(e){this.normalMap=null}_onNormalMapAssetRemove(e){this._onNormalMapAssetUnload(e)}_onNormalMapAssetChange(e){}onSetNormalMapAsset(e,t,s){let i=this.system.app.assets;if(t){let r=i.get(t);r&&this._unbindNormalMapAsset(r)}if(s){s instanceof re&&(this.data.normalMapAsset=s.id,s=s.id);let r=i.get(s);r?this._bindNormalMapAsset(r):i.once(`add:${s}`,a=>{this._bindNormalMapAsset(a)})}else this.normalMap=null}_bindMeshAsset(e){if(e.on("load",this._onMeshAssetLoad,this),e.on("unload",this._onMeshAssetUnload,this),e.on("remove",this._onMeshAssetRemove,this),e.on("change",this._onMeshAssetChange,this),e.resource)this._onMeshAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindMeshAsset(e){e.off("load",this._onMeshAssetLoad,this),e.off("unload",this._onMeshAssetUnload,this),e.off("remove",this._onMeshAssetRemove,this),e.off("change",this._onMeshAssetChange,this)}_onMeshAssetLoad(e){this._onMeshChanged(e.resource)}_onMeshAssetUnload(e){this.mesh=null}_onMeshAssetRemove(e){this._onMeshAssetUnload(e)}_onMeshAssetChange(e){}onSetMeshAsset(e,t,s){let i=this.system.app.assets;if(t){let r=i.get(t);r&&this._unbindMeshAsset(r)}if(s){s instanceof re&&(this.data.meshAsset=s.id,s=s.id);let r=i.get(s);r&&this._bindMeshAsset(r)}else this._onMeshChanged(null)}onSetMesh(e,t,s){!s||s instanceof re||typeof s=="number"?this.meshAsset=s:this._onMeshChanged(s)}_onMeshChanged(e){e&&!(e instanceof Ce)&&(e.meshInstances[0]?e=e.meshInstances[0].mesh:e=null),this.data.mesh=e,this.emitter&&(this.emitter.mesh=e,this.emitter.resetMaterial(),this.rebuild())}onSetRenderAsset(e,t,s){let i=this.system.app.assets;if(t){let r=i.get(t);r&&this._unbindRenderAsset(r)}if(s){s instanceof re&&(this.data.renderAsset=s.id,s=s.id);let r=i.get(s);r&&this._bindRenderAsset(r)}else this._onRenderChanged(null)}_bindRenderAsset(e){if(e.on("load",this._onRenderAssetLoad,this),e.on("unload",this._onRenderAssetUnload,this),e.on("remove",this._onRenderAssetRemove,this),e.resource)this._onRenderAssetLoad(e);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e)}}_unbindRenderAsset(e){e.off("load",this._onRenderAssetLoad,this),e.off("unload",this._onRenderAssetUnload,this),e.off("remove",this._onRenderAssetRemove,this),this._evtSetMeshes?.off(),this._evtSetMeshes=null}_onRenderAssetLoad(e){this._onRenderChanged(e.resource)}_onRenderAssetUnload(e){this._onRenderChanged(null)}_onRenderAssetRemove(e){this._onRenderAssetUnload(e)}_onRenderChanged(e){if(!e){this._onMeshChanged(null);return}this._evtSetMeshes?.off(),this._evtSetMeshes=e.on("set:meshes",this._onRenderSetMeshes,this),e.meshes&&this._onRenderSetMeshes(e.meshes)}_onRenderSetMeshes(e){this._onMeshChanged(e&&e[0])}onSetLoop(e,t,s){this.emitter&&(this.emitter[e]=s,this.emitter.resetTime())}onSetBlendType(e,t,s){this.emitter&&(this.emitter[e]=s,this.emitter.material.blendType=s,this.emitter.resetMaterial(),this.rebuild())}_requestDepth(){this._requestedDepth||(n_||(n_=this.system.app.scene.layers.getLayerById(Xt)),n_&&(n_.incrementCounter(),this._requestedDepth=!0))}_releaseDepth(){this._requestedDepth&&n_&&(n_.decrementCounter(),this._requestedDepth=!1)}onSetDepthSoftening(e,t,s){t!==s&&(s?(this.enabled&&this.entity.enabled&&this._requestDepth(),this.emitter&&(this.emitter[e]=s)):(this.enabled&&this.entity.enabled&&this._releaseDepth(),this.emitter&&(this.emitter[e]=s)),this.emitter&&(this.reset(),this.emitter.resetMaterial(),this.rebuild()))}onSetSimpleProperty(e,t,s){this.emitter&&(this.emitter[e]=s,this.emitter.resetMaterial())}onSetComplexProperty(e,t,s){this.emitter&&(this.emitter[e]=s,this.emitter.resetMaterial(),this.rebuild(),this.reset())}onSetGraphProperty(e,t,s){this.emitter&&(this.emitter[e]=s,this.emitter.rebuildGraphs(),this.emitter.resetMaterial())}onEnable(){let e=this.system.app.scene,t=e.layers,s=this.data;for(let i=0,r=IP.length;i<r;i++){let a=s[IP[i]];if(a){if(!(a instanceof re))if(parseInt(a,10)>=0)a=this.system.app.assets.get(a);else continue;a&&!a.resource&&this.system.app.assets.load(a)}}if(!this.system.app.graphicsDevice.disableParticleSystem){if(!this.emitter){let i=s.mesh;i instanceof Ce||(i=null),this.emitter=new Qm(this.system.app.graphicsDevice,{numParticles:s.numParticles,emitterExtents:s.emitterExtents,emitterExtentsInner:s.emitterExtentsInner,emitterRadius:s.emitterRadius,emitterRadiusInner:s.emitterRadiusInner,emitterShape:s.emitterShape,initialVelocity:s.initialVelocity,wrap:s.wrap,localSpace:s.localSpace,screenSpace:s.screenSpace,wrapBounds:s.wrapBounds,lifetime:s.lifetime,rate:s.rate,rate2:s.rate2,orientation:s.orientation,particleNormal:s.particleNormal,animTilesX:s.animTilesX,animTilesY:s.animTilesY,animStartFrame:s.animStartFrame,animNumFrames:s.animNumFrames,animNumAnimations:s.animNumAnimations,animIndex:s.animIndex,randomizeAnimIndex:s.randomizeAnimIndex,animSpeed:s.animSpeed,animLoop:s.animLoop,startAngle:s.startAngle,startAngle2:s.startAngle2,scaleGraph:s.scaleGraph,scaleGraph2:s.scaleGraph2,colorGraph:s.colorGraph,colorGraph2:s.colorGraph2,alphaGraph:s.alphaGraph,alphaGraph2:s.alphaGraph2,localVelocityGraph:s.localVelocityGraph,localVelocityGraph2:s.localVelocityGraph2,velocityGraph:s.velocityGraph,velocityGraph2:s.velocityGraph2,rotationSpeedGraph:s.rotationSpeedGraph,rotationSpeedGraph2:s.rotationSpeedGraph2,radialSpeedGraph:s.radialSpeedGraph,radialSpeedGraph2:s.radialSpeedGraph2,colorMap:s.colorMap,normalMap:s.normalMap,loop:s.loop,preWarm:s.preWarm,sort:s.sort,stretch:s.stretch,alignToMotion:s.alignToMotion,lighting:s.lighting,halfLambert:s.halfLambert,intensity:s.intensity,depthSoftening:s.depthSoftening,scene:this.system.app.scene,mesh:i,depthWrite:s.depthWrite,noFog:s.noFog,node:this.entity,blendType:s.blendType}),this.emitter.meshInstance.node=this.entity,this.emitter.drawOrder=this.drawOrder,s.autoPlay||(this.pause(),this.emitter.meshInstance.visible=!1)}this.emitter.colorMap&&this.addMeshInstanceToLayers(),this._evtLayersChanged=e.on("set:layers",this.onLayersChanged,this),t&&(this._evtLayerAdded=t.on("add",this.onLayerAdded,this),this._evtLayerRemoved=t.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&s.depthSoftening&&this._requestDepth()}}onDisable(){let t=this.system.app.scene.layers;this._evtLayersChanged?.off(),this._evtLayersChanged=null,t&&(this._evtLayerAdded?.off(),this._evtLayerAdded=null,this._evtLayerRemoved?.off(),this._evtLayerRemoved=null),this.emitter&&(this.removeMeshInstanceFromLayers(),this.data.depthSoftening&&this._releaseDepth(),this.emitter.camera=null)}onBeforeRemove(){this.enabled&&(this.enabled=!1),this.emitter&&(this.emitter.destroy(),this.emitter=null);for(let e=0;e<IP.length;e++){let t=IP[e];this.data[t]&&(this[t]=null)}this.off()}reset(){this.emitter&&this.emitter.reset()}stop(){this.emitter&&(this.emitter.loop=!1,this.emitter.resetTime(),this.emitter.addTime(0,!0))}pause(){this.data.paused=!0}unpause(){this.data.paused=!1}play(){this.data.paused=!1,this.emitter&&(this.emitter.meshInstance.visible=!0,this.emitter.loop=this.data.loop,this.emitter.resetTime())}isPlaying(){return this.data.paused?!1:this.emitter&&this.emitter.loop?!0:Date.now()<=this.emitter.endTime}setInTools(){let{emitter:e}=this;e&&!e.inTools&&(e.inTools=!0,this.rebuild())}rebuild(){let e=this.enabled;this.enabled=!1,this.emitter&&this.emitter.rebuild(),this.enabled=e}}});var wP,Jj=m(()=>{Q();J();wP=class{constructor(){this.numParticles=1,this.rate=1,this.rate2=null,this.startAngle=0,this.startAngle2=null,this.lifetime=50,this.emitterExtents=new g,this.emitterExtentsInner=new g,this.emitterRadius=0,this.emitterRadiusInner=0,this.emitterShape=Si,this.initialVelocity=0,this.wrap=!1,this.wrapBounds=new g,this.localSpace=!1,this.screenSpace=!1,this.colorMap=null,this.colorMapAsset=null,this.normalMap=null,this.normalMapAsset=null,this.loop=!0,this.preWarm=!1,this.sort=0,this.mode=Pm,this.scene=null,this.lighting=!1,this.halfLambert=!1,this.intensity=1,this.stretch=0,this.alignToMotion=!1,this.depthSoftening=0,this.renderAsset=null,this.meshAsset=null,this.mesh=null,this.depthWrite=!1,this.noFog=!1,this.orientation=Jo,this.particleNormal=new g(0,1,0),this.animTilesX=1,this.animTilesY=1,this.animStartFrame=0,this.animNumFrames=1,this.animNumAnimations=1,this.animIndex=0,this.randomizeAnimIndex=!1,this.animSpeed=1,this.animLoop=!0,this.scaleGraph=null,this.scaleGraph2=null,this.colorGraph=null,this.colorGraph2=null,this.alphaGraph=null,this.alphaGraph2=null,this.localVelocityGraph=null,this.localVelocityGraph2=null,this.velocityGraph=null,this.velocityGraph2=null,this.rotationSpeedGraph=null,this.rotationSpeedGraph2=null,this.radialSpeedGraph=null,this.radialSpeedGraph2=null,this.blendType=es,this.enabled=!0,this.paused=!1,this.autoPlay=!0,this.layers=[ms]}}});var e$,t$=m(()=>{e$=`
varying vec4 texCoordsAlphaLife;
uniform sampler2D colorMap;
uniform sampler2D colorParam;
uniform float graphSampleSize;
uniform float graphNumSamples;
#ifndef CAMERAPLANES
	#define CAMERAPLANES
	uniform vec4 camera_params;
#endif
uniform float softening;
uniform float colorMult;
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
void main(void) {
	vec4 tex  = texture2D(colorMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y));
	vec4 ramp = texture2D(colorParam, vec2(texCoordsAlphaLife.w, 0.0));
	ramp.rgb *= colorMult;
	ramp.a += texCoordsAlphaLife.z;
	vec3 rgb = tex.rgb * ramp.rgb;
	float a  = tex.a * ramp.a;
`});var s$,i$=m(()=>{s$=`
vec3 unpack3NFloats(float src) {
	float r = fract(src);
	float g = fract(src * 256.0);
	float b = fract(src * 65536.0);
	return vec3(r, g, b);
}
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
vec4 tex1Dlod_lerp(TEXTURE_ACCEPT_HIGHP(tex), vec2 tc) {
	return mix( texture2D(tex,tc), texture2D(tex,tc + graphSampleSize), fract(tc.x*graphNumSamples) );
}
vec4 tex1Dlod_lerp(TEXTURE_ACCEPT_HIGHP(tex), vec2 tc, out vec3 w) {
	vec4 a = texture2D(tex,tc);
	vec4 b = texture2D(tex,tc + graphSampleSize);
	float c = fract(tc.x*graphNumSamples);
	vec3 unpackedA = unpack3NFloats(a.w);
	vec3 unpackedB = unpack3NFloats(b.w);
	w = mix(unpackedA, unpackedB, c);
	return mix(a, b, c);
}
vec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix) {
	float c = cos(pRotation);
	float s = sin(pRotation);
	mat2 m = mat2(c, -s, s, c);
	rotMatrix = m;
	return m * quadXY;
}
vec3 billboard(vec3 InstanceCoords, vec2 quadXY) {
	#ifdef SCREEN_SPACE
		vec3 pos = vec3(-1, 0, 0) * quadXY.x + vec3(0, -1, 0) * quadXY.y;
	#else
		vec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;
	#endif
	return pos;
}
vec3 customFace(vec3 InstanceCoords, vec2 quadXY) {
	vec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;
	return pos;
}
vec2 safeNormalize(vec2 v) {
	float l = length(v);
	return (l > 1e-06) ? v / l : v;
}
void main(void) {
	vec3 meshLocalPos = particle_vertexData.xyz;
	float id = floor(particle_vertexData.w);
	float rndFactor = fract(sin(id + 1.0 + seed));
	vec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));
	float uv = id / numParticlesPot;
	readInput(uv);
#ifdef LOCAL_SPACE
	inVel = mat3(matrix_model) * inVel;
#endif
	vec2 velocityV = safeNormalize((mat3(matrix_view) * inVel).xy);
	float particleLifetime = lifetime;
	if (inLife <= 0.0 || inLife > particleLifetime || !inShow)
		meshLocalPos = vec3(0.0);
	vec2 quadXY = meshLocalPos.xy;
	float nlife = clamp(inLife / particleLifetime, 0.0, 1.0);
	vec3 paramDiv;
	vec4 params = tex1Dlod_lerp(TEXTURE_PASS(internalTex2), vec2(nlife, 0), paramDiv);
	float scale = params.y;
	float scaleDiv = paramDiv.x;
	float alphaDiv = paramDiv.z;
	scale += (scaleDiv * 2.0 - 1.0) * scaleDivMult * fract(rndFactor*10000.0);
#ifndef USE_MESH
	texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);
#else
	texCoordsAlphaLife = vec4(particle_uv, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);
#endif
	vec3 particlePos = inPos;
	vec3 particlePosMoved = vec3(0.0);
	mat2 rotMatrix;
`});var r$,a$=m(()=>{r$=`
	float animFrame = min(floor(texCoordsAlphaLife.w * animTexParams.y) + animTexParams.x, animTexParams.z);
`});var n$,o$=m(()=>{n$=`
	float animFrame = floor(mod(texCoordsAlphaLife.w * animTexParams.y + animTexParams.x, animTexParams.z + 1.0));
`});var l$,h$=m(()=>{l$=`
	float animationIndex;
	if (animTexIndexParams.y == 1.0) {
		animationIndex = floor((animTexParams.w + 1.0) * rndFactor3.z) * (animTexParams.z + 1.0);
	} else {
		animationIndex = animTexIndexParams.x * (animTexParams.z + 1.0);
	}
	float atlasX = (animationIndex + animFrame) * animTexTilesParams.x;
	float atlasY = 1.0 - floor(atlasX + 1.0) * animTexTilesParams.y;
	atlasX = fract(atlasX);
	texCoordsAlphaLife.xy *= animTexTilesParams.xy;
	texCoordsAlphaLife.xy += vec2(atlasX, atlasY);
`});var c$,f$=m(()=>{c$=`
void readInput(float uv) {
	vec4 tex = texture2D(particleTexIN, vec2(uv, 0.25));
	vec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.75));
	inPos = tex.xyz;
	inVel = tex2.xyz;
	inAngle = (tex.w < 0.0? -tex.w : tex.w) - 1000.0;
	inShow = tex.w >= 0.0;
	inLife = tex2.w;
}
`});var d$,u$=m(()=>{d$=`
#define PI2 6.283185307179586
uniform vec3 inBoundsSize;
uniform vec3 inBoundsCenter;
uniform float maxVel;
float decodeFloatRG(vec2 rg) {
	return rg.y * (1.0 / 255.0) + rg.x;
}
float decodeFloatRGBA( vec4 rgba ) {
	return dot(rgba, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));
}
void readInput(float uv) {
	vec4 tex0 = texture2D(particleTexIN, vec2(uv, 0.125));
	vec4 tex1 = texture2D(particleTexIN, vec2(uv, 0.375));
	vec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.625));
	vec4 tex3 = texture2D(particleTexIN, vec2(uv, 0.875));
	inPos = vec3(decodeFloatRG(tex0.rg), decodeFloatRG(tex0.ba), decodeFloatRG(tex1.rg));
	inPos = (inPos - vec3(0.5)) * inBoundsSize + inBoundsCenter;
	inVel = tex2.xyz;
	inVel = (inVel - vec3(0.5)) * maxVel;
	inAngle = decodeFloatRG(tex1.ba) * PI2;
	inShow = tex2.a > 0.5;
	inLife = decodeFloatRGBA(tex3);
	float maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));
	float maxPosLife = lifetime+1.0;
	inLife = inLife * (maxNegLife + maxPosLife) - maxNegLife;
}
`});var m$,p$=m(()=>{m$=`
void writeOutput() {
	if (gl_FragCoord.y<1.0) {
		gl_FragColor = vec4(outPos, (outAngle + 1000.0) * visMode);
	} else {
		gl_FragColor = vec4(outVel, outLife);
	}
}
`});var _$,g$=m(()=>{_$=`
uniform vec3 outBoundsMul;
uniform vec3 outBoundsAdd;
vec2 encodeFloatRG( float v ) {
	vec2 enc = vec2(1.0, 255.0) * v;
	enc = fract(enc);
	enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);
	return enc;
}
vec4 encodeFloatRGBA( float v ) {
	vec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * v;
	enc = fract(enc);
	enc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);
	return enc;
}
void writeOutput() {
	outPos = outPos * outBoundsMul + outBoundsAdd;
	outAngle = fract(outAngle / PI2);
	outVel = (outVel / maxVel) + vec3(0.5);
	float maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));
	float maxPosLife = lifetime+1.0;
	outLife = (outLife + maxNegLife) / (maxNegLife + maxPosLife);
	if (gl_FragCoord.y < 1.0) {
		gl_FragColor = vec4(encodeFloatRG(outPos.x), encodeFloatRG(outPos.y));
	} else if (gl_FragCoord.y < 2.0) {
		gl_FragColor = vec4(encodeFloatRG(outPos.z), encodeFloatRG(outAngle));
	} else if (gl_FragCoord.y < 3.0) {
		gl_FragColor = vec4(outVel, visMode*0.5+0.5);
	} else {
		gl_FragColor = encodeFloatRGBA(outLife);
	}
}
`});var S$,T$=m(()=>{S$=`
uniform mat3 spawnBounds;
uniform vec3 spawnPosInnerRatio;
vec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {
	vec3 pos = inBounds - vec3(0.5);
	vec3 posAbs = abs(pos);
	vec3 maxPos = vec3(max(posAbs.x, max(posAbs.y, posAbs.z)));
	vec3 edge = maxPos + (vec3(0.5) - maxPos) * spawnPosInnerRatio;
	pos.x = edge.x * (maxPos.x == posAbs.x ? sign(pos.x) : 2.0 * pos.x);
	pos.y = edge.y * (maxPos.y == posAbs.y ? sign(pos.y) : 2.0 * pos.y);
	pos.z = edge.z * (maxPos.z == posAbs.z ? sign(pos.z) : 2.0 * pos.z);
#ifndef LOCAL_SPACE
	return emitterPos + spawnBounds * pos;
#else
	return spawnBounds * pos;
#endif
}
void addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {
	localVelocity -= vec3(0, 0, initialVelocity);
}
`});var E$,v$=m(()=>{E$=`
	writeOutput();
}
`});var x$,y$=m(()=>{x$=`
varying vec2 vUv0;
uniform highp sampler2D particleTexIN;
uniform highp sampler2D internalTex0;
uniform highp sampler2D internalTex1;
uniform highp sampler2D internalTex2;
uniform highp sampler2D internalTex3;
uniform mat3 emitterMatrix;
uniform mat3 emitterMatrixInv;
uniform vec3 emitterScale;
uniform vec3 emitterPos;
uniform vec3 frameRandom;
uniform vec3 localVelocityDivMult;
uniform vec3 velocityDivMult;
uniform float delta;
uniform float rate;
uniform float rateDiv;
uniform float lifetime;
uniform float numParticles;
uniform float rotSpeedDivMult;
uniform float radialSpeedDivMult;
uniform float seed;
uniform float startAngle;
uniform float startAngle2;
uniform float initialVelocity;
uniform float graphSampleSize;
uniform float graphNumSamples;
vec3 inPos;
vec3 inVel;
float inAngle;
bool inShow;
float inLife;
float visMode;
vec3 outPos;
vec3 outVel;
float outAngle;
bool outShow;
float outLife;
`});var A$,P$=m(()=>{A$=`
	if (outLife >= lifetime) {
		outLife -= max(lifetime, (numParticles - 1.0) * particleRate);
		visMode = -1.0;
	}
`});var R$,C$=m(()=>{R$=`
	visMode = outLife < 0.0? -1.0: visMode;
`});var I$,w$=m(()=>{I$=`
	if (outLife >= lifetime) {
		outLife -= max(lifetime, (numParticles - 1.0) * particleRate);
		visMode = 1.0;
	}
	visMode = outLife < 0.0? 1.0: visMode;
`});var L$,b$=m(()=>{L$=`
uniform float spawnBoundsSphere;
uniform float spawnBoundsSphereInnerRatio;
vec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {
	float rnd4 = fract(rndFactor * 1000.0);
	vec3 norm = normalize(inBounds.xyz - vec3(0.5));
	float r = rnd4 * (1.0 - spawnBoundsSphereInnerRatio) + spawnBoundsSphereInnerRatio;
#ifndef LOCAL_SPACE
	return emitterPos + norm * r * spawnBoundsSphere;
#else
	return norm * r * spawnBoundsSphere;
#endif
}
void addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {
	localVelocity += normalize(inBounds - vec3(0.5)) * initialVelocity;
}
`});var M$,D$=m(()=>{M$=`
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
vec3 unpack3NFloats(float src) {
	float r = fract(src);
	float g = fract(src * 256.0);
	float b = fract(src * 65536.0);
	return vec3(r, g, b);
}
vec3 tex1Dlod_lerp(TEXTURE_ACCEPT_HIGHP(tex), vec2 tc, out vec3 w) {
	vec4 a = texture2D(tex, tc);
	vec4 b = texture2D(tex, tc + graphSampleSize);
	float c = fract(tc.x * graphNumSamples);
	vec3 unpackedA = unpack3NFloats(a.w);
	vec3 unpackedB = unpack3NFloats(b.w);
	w = mix(unpackedA, unpackedB, c);
	return mix(a.xyz, b.xyz, c);
}
#define HASHSCALE4 vec4(1031, .1030, .0973, .1099)
vec4 hash41(float p) {
	vec4 p4 = fract(vec4(p) * HASHSCALE4);
	p4 += dot(p4, p4.wzxy+19.19);
	return fract(vec4((p4.x + p4.y)*p4.z, (p4.x + p4.z)*p4.y, (p4.y + p4.z)*p4.w, (p4.z + p4.w)*p4.x));
}
void main(void) {
	if (gl_FragCoord.x > numParticles) discard;
	readInput(vUv0.x);
	visMode = inShow? 1.0 : -1.0;
	vec4 rndFactor = hash41(gl_FragCoord.x + seed);
	float particleRate = rate + rateDiv * rndFactor.x;
	outLife = inLife + delta;
	float nlife = clamp(outLife / lifetime, 0.0, 1.0);
	vec3 localVelocityDiv;
	vec3 velocityDiv;
	vec3 paramDiv;
	vec3 localVelocity = tex1Dlod_lerp(TEXTURE_PASS(internalTex0), vec2(nlife, 0), localVelocityDiv);
	vec3 velocity =	  tex1Dlod_lerp(TEXTURE_PASS(internalTex1), vec2(nlife, 0), velocityDiv);
	vec3 params =		tex1Dlod_lerp(TEXTURE_PASS(internalTex2), vec2(nlife, 0), paramDiv);
	float rotSpeed = params.x;
	float rotSpeedDiv = paramDiv.y;
	vec3 radialParams = tex1Dlod_lerp(TEXTURE_PASS(internalTex3), vec2(nlife, 0), paramDiv);
	float radialSpeed = radialParams.x;
	float radialSpeedDiv = radialParams.y;
	bool respawn = inLife <= 0.0 || outLife >= lifetime;
	inPos = respawn ? calcSpawnPosition(rndFactor.xyz, rndFactor.x) : inPos;
	inAngle = respawn ? mix(startAngle, startAngle2, rndFactor.x) : inAngle;
#ifndef LOCAL_SPACE
	vec3 radialVel = inPos - emitterPos;
#else
	vec3 radialVel = inPos;
#endif
	radialVel = (dot(radialVel, radialVel) > 1.0E-8) ? radialSpeed * normalize(radialVel) : vec3(0.0);
	radialVel += (radialSpeedDiv * vec3(2.0) - vec3(1.0)) * radialSpeedDivMult * rndFactor.xyz;
	localVelocity +=	(localVelocityDiv * vec3(2.0) - vec3(1.0)) * localVelocityDivMult * rndFactor.xyz;
	velocity +=		 (velocityDiv * vec3(2.0) - vec3(1.0)) * velocityDivMult * rndFactor.xyz;
	rotSpeed +=		 (rotSpeedDiv * 2.0 - 1.0) * rotSpeedDivMult * rndFactor.y;
	addInitialVelocity(localVelocity, rndFactor.xyz);
#ifndef LOCAL_SPACE
	outVel = emitterMatrix * localVelocity + (radialVel + velocity) * emitterScale;
#else
	outVel = (localVelocity + radialVel) / emitterScale + emitterMatrixInv * velocity;
#endif
	outPos = inPos + outVel * delta;
	outAngle = inAngle + rotSpeed * delta;
`});var O$,N$=m(()=>{O$=`
	quadXY = rotate(quadXY, inAngle, rotMatrix);
	vec3 localPos = billboard(particlePos, quadXY);
`});var F$,U$=m(()=>{F$=`
	dBlendModeFogFactor = 0.0;
	rgb *= saturate(gammaCorrectInput(max(a, 0.0)));
	if ((rgb.r + rgb.g + rgb.b) < 0.000001) discard;
`});var B$,V$=m(()=>{B$=`
	rgb = mix(vec3(1.0), rgb, vec3(a));
	if (rgb.r + rgb.g + rgb.b > 2.99) discard;
`});var k$,G$=m(()=>{k$=`
	if (a < 0.01) discard;
`});var z$,H$=m(()=>{z$=`
attribute vec4 particle_vertexData;
attribute vec4 particle_vertexData2;
attribute vec4 particle_vertexData3;
attribute float particle_vertexData4;
#ifndef USE_MESH
	attribute vec2 particle_vertexData5;
#else
	attribute vec4 particle_vertexData5;
#endif
uniform mat4 matrix_viewProjection;
uniform mat4 matrix_model;
#ifndef VIEWMATRIX
	#define VIEWMATRIX
	uniform mat4 matrix_view;
#endif
uniform mat3 matrix_normal;
uniform mat4 matrix_viewInverse;
uniform float numParticles;
uniform float lifetime;
uniform float stretch;
uniform float seed;
uniform vec3 wrapBounds;
uniform vec3 emitterScale;
uniform vec3 faceTangent;
uniform vec3 faceBinorm;
#ifdef PARTICLE_GPU
	uniform highp sampler2D internalTex0;
	uniform highp sampler2D internalTex1;
	uniform highp sampler2D internalTex2;
#endif
uniform vec3 emitterPos;
varying vec4 texCoordsAlphaLife;
vec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix)
{
	float c = cos(pRotation);
	float s = sin(pRotation);
	mat2 m = mat2(c, -s, s, c);
	rotMatrix = m;
	return m * quadXY;
}
vec3 billboard(vec3 InstanceCoords, vec2 quadXY)
{
	vec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;
	return pos;
}
vec3 customFace(vec3 InstanceCoords, vec2 quadXY)
{
	vec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;
	return pos;
}
void main(void)
{
	vec3 particlePos = particle_vertexData.xyz;
	vec3 inPos = particlePos;
	vec3 vertPos = particle_vertexData3.xyz;
	vec3 inVel = vec3(particle_vertexData2.w, particle_vertexData3.w, particle_vertexData5.x);
	float id = floor(particle_vertexData4);
	float rndFactor = fract(sin(id + 1.0 + seed));
	vec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));
#ifdef LOCAL_SPACE
	inVel = mat3(matrix_model) * inVel;
#endif
	vec2 velocityV = normalize((mat3(matrix_view) * inVel).xy);
	vec2 quadXY = vertPos.xy;
#ifdef USE_MESH
	texCoordsAlphaLife = vec4(particle_vertexData5.zw, particle_vertexData2.z, particle_vertexData.w);
#else
	texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, particle_vertexData2.z, particle_vertexData.w);
#endif
	mat2 rotMatrix;
	float inAngle = particle_vertexData2.x;
	vec3 particlePosMoved = vec3(0.0);
	vec3 meshLocalPos = particle_vertexData3.xyz;
`});var X$,W$=m(()=>{X$=`
	localPos *= particle_vertexData2.y * emitterScale;
	localPos += particlePos;
	gl_Position = matrix_viewProjection * vec4(localPos, 1.0);
`});var Y$,K$=m(()=>{Y$=`
	quadXY = rotate(quadXY, inAngle, rotMatrix);
	vec3 localPos = customFace(particlePos, quadXY);
`});var q$,j$=m(()=>{q$=`
	rgb = addFog(rgb);
	rgb = toneMap(rgb);
	rgb = gammaCorrectOutput(rgb);
	gl_FragColor = vec4(rgb, a);
}
`});var $$,Z$=m(()=>{$$=`
	localPos *= scale * emitterScale;
	localPos += particlePos;
	#ifdef SCREEN_SPACE
	gl_Position = vec4(localPos.x, localPos.y, 0.0, 1.0);
	#else
	gl_Position = matrix_viewProjection * vec4(localPos.xyz, 1.0);
	#endif
`});var Q$,J$=m(()=>{Q$=`
	vec3 negNormal = normal * 0.5 + 0.5;
	vec3 posNormal = -normal * 0.5 + 0.5;
	negNormal *= negNormal;
	posNormal *= posNormal;
`});var e9,t9=m(()=>{e9=`
attribute vec4 particle_vertexData;
#if defined(USE_MESH)
	#if defined(USE_MESH_UV)
		attribute vec2 particle_uv;
	#else
		vec2 particle_uv = vec2(0.0, 0.0);
	#endif
#endif
uniform mat4 matrix_viewProjection;
uniform mat4 matrix_model;
uniform mat3 matrix_normal;
uniform mat4 matrix_viewInverse;
#ifndef VIEWMATRIX
	#define VIEWMATRIX
	uniform mat4 matrix_view;
#endif
uniform float numParticles;
uniform float numParticlesPot;
uniform float graphSampleSize;
uniform float graphNumSamples;
uniform float stretch;
uniform vec3 wrapBounds;
uniform vec3 emitterScale;
uniform vec3 emitterPos;
uniform vec3 faceTangent;
uniform vec3 faceBinorm;
uniform float rate;
uniform float rateDiv;
uniform float lifetime;
uniform float deltaRandomnessStatic;
uniform float scaleDivMult;
uniform float alphaDivMult;
uniform float seed;
uniform float delta;
uniform sampler2D particleTexOUT;
uniform sampler2D particleTexIN;
#ifdef PARTICLE_GPU
	uniform highp sampler2D internalTex0;
	uniform highp sampler2D internalTex1;
	uniform highp sampler2D internalTex2;
#endif
#ifndef CAMERAPLANES
	#define CAMERAPLANES
	uniform vec4 camera_params;
#endif
varying vec4 texCoordsAlphaLife;
vec3 inPos;
vec3 inVel;
float inAngle;
bool inShow;
float inLife;
`});var s9,i9=m(()=>{s9=`
	vec3 negNormal = max(normal, vec3(0.0));
	vec3 posNormal = max(-normal, vec3(0.0));
`});var r9,a9=m(()=>{r9=`
	vec3 light = negNormal.x*lightCube[0] + posNormal.x*lightCube[1] +
						negNormal.y*lightCube[2] + posNormal.y*lightCube[3] +
						negNormal.z*lightCube[4] + posNormal.z*lightCube[5];
	rgb *= light;
`});var n9,o9=m(()=>{n9=`
	particlePos = (matrix_model * vec4(particlePos, 1.0)).xyz;
`});var l9,h9=m(()=>{l9=`
	vec3 localPos = meshLocalPos;
	localPos.xy = rotate(localPos.xy, inAngle, rotMatrix);
	localPos.yz = rotate(localPos.yz, inAngle, rotMatrix);
	billboard(particlePos, quadXY);
`});var c9,f9=m(()=>{c9=`
	Normal = normalize(localPos + matrix_viewInverse[2].xyz);
`});var d9,u9=m(()=>{d9=`
	vec3 normalMap = normalize(texture2D(normalMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y)).xyz * 2.0 - 1.0);
	vec3 normal = ParticleMat * normalMap;
`});var m9,p9=m(()=>{m9=`
	inAngle = atan(velocityV.x, velocityV.y);
`});var _9,g9=m(()=>{_9=`
	#include "particleUpdaterInitPS"
	#ifdef PACK8
		#include "particleInputRgba8PS"
		#include "particleOutputRgba8PS"
	#else
		#include "particleInputFloatPS"
		#include "particleOutputFloatPS"
	#endif
	#ifdef EMITTERSHAPE_BOX
		#include "particleUpdaterAABBPS"
	#else
		#include "particleUpdaterSpherePS"
	#endif
	#include "particleUpdaterStartPS"
	#ifdef RESPAWN
		#include "particleUpdaterRespawnPS"
	#endif
	#ifdef NO_RESPAWN
		#include "particleUpdaterNoRespawnPS"
	#endif
	#ifdef ON_STOP
		#include "particleUpdaterOnStopPS"
	#endif
	#include "particleUpdaterEndPS"
`});var S9,T9=m(()=>{S9=`
	#if NORMAL != NONE
		#if NORMAL == VERTEX
			varying vec3 Normal;
		#endif
		#if NORMAL == MAP
			varying mat3 ParticleMat;
		#endif
		uniform vec3 lightCube[6];
	#endif
	#ifdef SOFT
		varying float vDepth;
		#include "screenDepthPS"
	#endif
	#include "gammaPS"
	#include "tonemappingPS"
	#include "fogPS"
	#if NORMAL == MAP
		uniform sampler2D normalMap;
	#endif
	#include "particlePS"
	#ifdef SOFT
		#include "particle_softPS"
	#endif
	#if NORMAL == VERTEX
		vec3 normal = Normal;
	#endif
	#if NORMAL == MAP
		#include "particle_normalMapPS"
	#endif
	#if NORMAL != NONE
		#ifdef HALF_LAMBERT
			#include "particle_halflambertPS"
		#else
			#include "particle_lambertPS"
		#endif
		#include "particle_lightingPS"
	#endif
	#if BLEND == NORMAL
		#include "particle_blendNormalPS"
	#elif BLEND == ADDITIVE
		#include "particle_blendAddPS"
	#elif BLEND == MULTIPLICATIVE
		#include "particle_blendMultiplyPS"
	#endif
	#include "particle_endPS"
`});var E9,v9=m(()=>{E9=`
	#ifdef ANIMTEX
		uniform vec2 animTexTilesParams;
		uniform vec4 animTexParams;
		uniform vec2 animTexIndexParams;
	#endif
	#if NORMAL == MAP
		varying mat3 ParticleMat;
	#endif
	#if NORMAL == VERTEX
		varying vec3 Normal;
	#endif
	#ifdef SOFT
		varying float vDepth;
	#endif
	#ifdef PARTICLE_GPU
		#include "particle_initVS"
		#ifdef PACK8
			#include "particleInputRgba8PS"
		#else
			#include  "particleInputFloatPS"
		#endif
		#ifdef SOFT
			#include "screenDepthPS"
		#endif
		#include "particleVS"
	#else
		#ifdef SOFT
			#include "screenDepthPS"
		#endif
		#include "particle_cpuVS"
	#endif
	#ifdef LOCAL_SPACE
		#include "particle_localShiftVS"
	#endif
	#ifdef ANIMTEX
		#ifdef ANIMTEX_LOOP
			#include "particleAnimFrameLoopVS"
		#else
			#include "particleAnimFrameClampVS"
		#endif
		#include "particleAnimTexVS"
	#endif
	#ifdef PARTICLE_GPU
		#ifdef WRAP
			#include "particle_wrapVS"
		#endif
	#endif
	#ifdef ALIGN_TO_MOTION
		#include "particle_pointAlongVS"
	#endif
	#ifdef USE_MESH
		#include "particle_meshVS"
	#else
		#ifdef CUSTOM_FACE
			#include "particle_customFaceVS"
		#else
			#include "particle_billboardVS"
		#endif
	#endif
	#if NORMAL == VERTEX
		#include "particle_normalVS"
	#endif
	#if NORMAL == MAP
		#include "particle_TBNVS"
	#endif
	#ifdef STRETCH
		#include "particle_stretchVS"
	#endif
	#ifdef PARTICLE_GPU
		#include "particle_endVS"
	#else
		#include "particle_cpu_endVS"
	#endif
	#ifdef SOFT
		#include "particle_softVS"
	#endif
	}
`});var x9,y9=m(()=>{x9=`
	float depth = getLinearScreenDepth();
	float particleDepth = vDepth;
	float depthDiff = saturate(abs(particleDepth - depth) * softening);
	a *= depthDiff;
`});var A9,P9=m(()=>{A9=`
	vDepth = getLinearDepth(localPos);
`});var R9,C9=m(()=>{R9=`
	vec3 moveDir = inVel * stretch;
	vec3 posPrev = particlePos - moveDir;
	posPrev += particlePosMoved;
	vec2 centerToVertexV = normalize((mat3(matrix_view) * localPos).xy);
	float interpolation = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;
	particlePos = mix(particlePos, posPrev, interpolation);
`});var I9,w9=m(()=>{I9=`
	mat3 rot3 = mat3(rotMatrix[0][0], rotMatrix[0][1], 0.0, rotMatrix[1][0], rotMatrix[1][1], 0.0, 0.0, 0.0, 1.0);
	ParticleMat = mat3(-matrix_viewInverse[0].xyz, -matrix_viewInverse[1].xyz, matrix_viewInverse[2].xyz) * rot3;
`});var L9,b9=m(()=>{L9=`
	vec3 origParticlePos = particlePos;
	particlePos -= matrix_model[3].xyz;
	particlePos = mod(particlePos, wrapBounds) - wrapBounds * 0.5;
	particlePos += matrix_model[3].xyz;
	particlePosMoved = particlePos - origParticlePos;
`});var M9,D9=m(()=>{t$();i$();a$();o$();h$();f$();u$();p$();g$();T$();v$();y$();P$();C$();w$();b$();D$();N$();U$();V$();G$();H$();W$();K$();j$();Z$();J$();t9();i9();a9();o9();h9();f9();u9();p9();g9();T9();v9();y9();P9();C9();w9();b9();M9={particlePS:e$,particleVS:s$,particleAnimFrameClampVS:r$,particleAnimFrameLoopVS:n$,particleAnimTexVS:l$,particleInputFloatPS:c$,particleInputRgba8PS:d$,particleOutputFloatPS:m$,particleOutputRgba8PS:_$,particleUpdaterAABBPS:S$,particleUpdaterEndPS:E$,particleUpdaterInitPS:x$,particleUpdaterNoRespawnPS:A$,particleUpdaterOnStopPS:R$,particleUpdaterRespawnPS:I$,particleUpdaterSpherePS:L$,particleUpdaterStartPS:M$,particle_billboardVS:O$,particle_blendAddPS:F$,particle_blendMultiplyPS:B$,particle_blendNormalPS:k$,particle_cpuVS:z$,particle_cpu_endVS:X$,particle_customFaceVS:Y$,particle_endPS:q$,particle_endVS:$$,particle_halflambertPS:Q$,particle_initVS:e9,particle_lambertPS:s9,particle_lightingPS:r9,particle_localShiftVS:n9,particle_meshVS:l9,particle_normalVS:c9,particle_normalMapPS:d9,particle_pointAlongVS:m9,particle_simulationPS:_9,particle_shaderPS:S9,particle_shaderVS:E9,particle_softPS:x9,particle_softVS:A9,particle_stretchVS:R9,particle_TBNVS:I9,particle_wrapVS:L9}});var O9,N9=m(()=>{O9=`
varying texCoordsAlphaLife: vec4f;
var colorMap: texture_2d<f32>;
var colorMapSampler: sampler;
var colorParam: texture_2d<f32>;
var colorParamSampler: sampler;
uniform graphSampleSize: f32;
uniform graphNumSamples: f32;
#ifndef CAMERAPLANES
	#define CAMERAPLANES
	uniform camera_params: vec4f;
#endif
uniform softening: f32;
uniform colorMult: f32;
fn saturate(x: f32) -> f32 {
	return clamp(x, 0.0, 1.0);
}
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	let tex: vec4f  = textureSample(colorMap, colorMapSampler, vec2f(input.texCoordsAlphaLife.x, 1.0 - input.texCoordsAlphaLife.y));
	var ramp: vec4f = textureSample(colorParam, colorParamSampler, vec2f(input.texCoordsAlphaLife.w, 0.0));
	ramp = vec4f(ramp.rgb * uniform.colorMult, ramp.a);
	ramp.a = ramp.a + input.texCoordsAlphaLife.z;
	var rgb: vec3f = tex.rgb * ramp.rgb;
	var a: f32 = tex.a * ramp.a;
`});var F9,U9=m(()=>{F9=`
fn unpack3NFloats(src: f32) -> vec3f {
	let r = fract(src);
	let g = fract(src * 256.0);
	let b = fract(src * 65536.0);
	return vec3f(r, g, b);
}
fn saturate(x: f32) -> f32 {
	return clamp(x, 0.0, 1.0);
}
struct TexLerpUnpackResult {
	result: vec4f,
	unpacked: vec3f
}
fn tex1Dlod_lerp_simple(tex: texture_2d<f32>, texSampler: sampler, tc: vec2f) -> vec4f {
	let tc_next = tc + vec2f(uniform.graphSampleSize);
	return mix( textureSample(tex, texSampler, tc), textureSample(tex, texSampler, tc_next), fract(tc.x * uniform.graphNumSamples) );
}
fn tex1Dlod_lerp_unpack(tex: texture_2d<f32>, texSampler: sampler, tc: vec2f) -> TexLerpUnpackResult {
	let tc_next = tc + vec2f(uniform.graphSampleSize);
	let a = textureSampleLevel(tex, texSampler, tc, 0.0);
	let b = textureSampleLevel(tex, texSampler, tc_next, 0.0);
	let c = fract(tc.x * uniform.graphNumSamples);
	let unpackedA = unpack3NFloats(a.w);
	let unpackedB = unpack3NFloats(b.w);
	let w_out = mix(unpackedA, unpackedB, c);
	return TexLerpUnpackResult(mix(a, b, c), w_out);
}
struct RotateResult {
	rotatedVec: vec2f,
	matrix: mat2x2f
}
fn rotateWithMatrix(quadXY: vec2f, pRotation: f32) -> RotateResult {
	let c = cos(pRotation);
	let s = sin(pRotation);
	let m = mat2x2f(vec2f(c, s), vec2f(-s, c));
	return RotateResult(m * quadXY, m);
}
fn billboard(InstanceCoords: vec3f, quadXY: vec2f) -> vec3f {
	var pos: vec3f;
	#ifdef SCREEN_SPACE
		pos = vec3f(-1.0, 0.0, 0.0) * quadXY.x + vec3f(0.0, -1.0, 0.0) * quadXY.y;
	#else
		pos = -uniform.matrix_viewInverse[0].xyz * quadXY.x + -uniform.matrix_viewInverse[1].xyz * quadXY.y;
	#endif
	return pos;
}
fn customFace(InstanceCoords: vec3f, quadXY: vec2f) -> vec3f {
	let pos = uniform.faceTangent * quadXY.x + uniform.faceBinorm * quadXY.y;
	return pos;
}
fn safeNormalize(v: vec2f) -> vec2f {
	let l = length(v);
	return select(v, v / l, l > 1e-06);
}
@vertex
fn vertexMain(input: VertexInput) -> VertexOutput {
	var output: VertexOutput;
	let meshLocalPos_in = input.particle_vertexData.xyz;
	let id = floor(input.particle_vertexData.w);
	let rndFactor = fract(sin(id + 1.0 + uniform.seed));
	let rndFactor3 = vec3f(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));
	let uv = id / uniform.numParticlesPot;
	readInput(uv);
	#ifdef LOCAL_SPACE
		let modelRotation = mat3x3f(uniform.matrix_model[0].xyz, uniform.matrix_model[1].xyz, uniform.matrix_model[2].xyz);
		inVel = modelRotation * inVel;
	#endif
	let viewRotation = mat3x3f(uniform.matrix_view[0].xyz, uniform.matrix_view[1].xyz, uniform.matrix_view[2].xyz);
	let velocityV = safeNormalize((viewRotation * inVel).xy);
	let particleLifetime = uniform.lifetime;
	var meshLocalPos = meshLocalPos_in;
	if (inLife <= 0.0 || inLife > particleLifetime || !inShow) {
		 meshLocalPos = vec3f(0.0);
	}
	let quadXY = meshLocalPos.xy;
	let nlife = clamp(inLife / particleLifetime, 0.0, 1.0);
	let lerp_result = tex1Dlod_lerp_unpack(internalTex2, internalTex2Sampler, vec2f(nlife, 0.0));
	let params = lerp_result.result;
	let paramDiv = lerp_result.unpacked;
	var scale = params.y;
	let scaleDiv = paramDiv.x;
	let alphaDiv = paramDiv.z;
	scale = scale + (scaleDiv * 2.0 - 1.0) * uniform.scaleDivMult * fract(rndFactor*10000.0);
	#ifndef USE_MESH
		output.texCoordsAlphaLife = vec4f(quadXY * -0.5 + 0.5, (alphaDiv * 2.0 - 1.0) * uniform.alphaDivMult * fract(rndFactor*1000.0), nlife);
	#else
		output.texCoordsAlphaLife = vec4f(particle_uv, (alphaDiv * 2.0 - 1.0) * uniform.alphaDivMult * fract(rndFactor*1000.0), nlife);
	#endif
	var particlePos = inPos;
	var particlePosMoved = vec3f(0.0);
	var rotMatrix: mat2x2f;
`});var B9,V9=m(()=>{B9=`
	let animFrame: f32 = min(floor(input.texCoordsAlphaLife.w * uniform.animTexParams.y) + uniform.animTexParams.x, uniform.animTexParams.z);
`});var k9,G9=m(()=>{k9=`
	let animFrame: f32 = floor((output.texCoordsAlphaLife.w * uniform.animTexParams.y + uniform.animTexParams.x) % (uniform.animTexParams.z + 1.0));	
`});var z9,H9=m(()=>{z9=`
	var animationIndex: f32;
	if (uniform.animTexIndexParams.y == 1.0) {
		animationIndex = floor((uniform.animTexParams.w + 1.0) * rndFactor3.z) * (uniform.animTexParams.z + 1.0);
	} else {
		animationIndex = uniform.animTexIndexParams.x * (uniform.animTexParams.z + 1.0);
	}
	var atlasX: f32 = (animationIndex + animFrame) * uniform.animTexTilesParams.x;
	let atlasY: f32 = 1.0 - floor(atlasX + 1.0) * uniform.animTexTilesParams.y;
	atlasX = fract(atlasX);
	let current_tcal_xy = output.texCoordsAlphaLife.xy;
	let scaled_tcal_xy = current_tcal_xy * uniform.animTexTilesParams.xy;
	let final_tcal_xy = scaled_tcal_xy + vec2f(atlasX, atlasY);
	output.texCoordsAlphaLife = vec4f(final_tcal_xy, output.texCoordsAlphaLife.z, output.texCoordsAlphaLife.w);
`});var X9,W9=m(()=>{X9=`
fn readInput(uv: f32) {
	let tex: vec4f = textureSampleLevel(particleTexIN, particleTexINSampler, vec2f(uv, 0.25), 0.0);
	let tex2: vec4f = textureSampleLevel(particleTexIN, particleTexINSampler, vec2f(uv, 0.75), 0.0);
	inPos = tex.xyz;
	inVel = tex2.xyz;
	inAngle = abs(tex.w) - 1000.0;
	inShow = tex.w >= 0.0;
	inLife = tex2.w;
}
`});var Y9,K9=m(()=>{Y9=`
const PI2: f32 = 6.283185307179586;
uniform inBoundsSize: vec3f;
uniform inBoundsCenter: vec3f;
uniform maxVel: f32;
fn decodeFloatRG(rg: vec2f) -> f32 {
	return rg.y * (1.0 / 255.0) + rg.x;
}
fn decodeFloatRGBA( rgba: vec4f ) -> f32 {
	return dot(rgba, vec4f(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));
}
fn readInput(uv: f32) {
	let tex0 = textureSampleLevel(particleTexIN, particleTexINSampler, vec2f(uv, 0.125), 0.0);
	let tex1 = textureSampleLevel(particleTexIN, particleTexINSampler, vec2f(uv, 0.375), 0.0);
	let tex2 = textureSampleLevel(particleTexIN, particleTexINSampler, vec2f(uv, 0.625), 0.0);
	let tex3 = textureSampleLevel(particleTexIN, particleTexINSampler, vec2f(uv, 0.875), 0.0);
	inPos = vec3f(decodeFloatRG(tex0.rg), decodeFloatRG(tex0.ba), decodeFloatRG(tex1.rg));
	inPos = (inPos - vec3f(0.5)) * uniform.inBoundsSize + uniform.inBoundsCenter;
	inVel = tex2.xyz;
	inVel = (inVel - vec3f(0.5)) * uniform.maxVel;
	inAngle = decodeFloatRG(tex1.ba) * PI2;
	inShow = tex2.a > 0.5;
	let life_decoded = decodeFloatRGBA(tex3);
	let maxNegLife = max(uniform.lifetime, (uniform.numParticles - 1.0) * (uniform.rate + uniform.rateDiv));
	let maxPosLife = uniform.lifetime + 1.0;
	inLife = life_decoded * (maxNegLife + maxPosLife) - maxNegLife;
}`});var q9,j9=m(()=>{q9=`
fn getOutput() -> vec4f {
	if (pcPosition.y < 1.0) {
		return vec4f(outPos, (outAngle + 1000.0) * visMode);
	} else {
		return vec4f(outVel, outLife);
	}
}
`});var $9,Z9=m(()=>{$9=`
uniform outBoundsMul: vec3f;
uniform outBoundsAdd: vec3f;
fn encodeFloatRG( v: f32 ) -> vec2f {
	var enc: vec2f = vec2f(1.0, 255.0) * v;
	enc = fract(enc);
	enc = enc - enc.yy * (1.0 / 255.0);
	return enc;
}
fn encodeFloatRGBA( v: f32 ) -> vec4f {
	let factors = vec4f(1.0, 255.0, 65025.0, 160581375.0);
	var enc: vec4f = factors * v;
	enc = fract(enc);
	enc = enc - enc.yzww * vec4f(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);
	return enc;
}
fn getOutput() -> vec4f {
	outPos = outPos * uniform.outBoundsMul + uniform.outBoundsAdd;
	outAngle = fract(outAngle / PI2);
	outVel = (outVel / uniform.maxVel) + vec3f(0.5);
	let maxNegLife = max(uniform.lifetime, (uniform.numParticles - 1.0) * (uniform.rate + uniform.rateDiv));
	let maxPosLife = uniform.lifetime + 1.0;
	outLife = (outLife + maxNegLife) / (maxNegLife + maxPosLife);
	if (pcPosition.y < 1.0) {
		return vec4f(encodeFloatRG(outPos.x), encodeFloatRG(outPos.y));
	} else if (pcPosition.y < 2.0) {
		return vec4f(encodeFloatRG(outPos.z), encodeFloatRG(outAngle));
	} else if (pcPosition.y < 3.0) {
		return vec4f(outVel, visMode * 0.5 + 0.5);
	} else {
		return encodeFloatRGBA(outLife);
	}
}
`});var Q9,J9=m(()=>{Q9=`
uniform spawnBounds: mat3x3f;
uniform spawnPosInnerRatio: vec3f;
fn calcSpawnPosition(inBounds: vec3f, rndFactor: f32) -> vec3f {
	var pos = inBounds - vec3f(0.5);
	let posAbs = abs(pos);
	let maxComp = max(posAbs.x, max(posAbs.y, posAbs.z));
	let maxPos = vec3f(maxComp);
	let edge = maxPos + (vec3f(0.5) - maxPos) * uniform.spawnPosInnerRatio;
	pos.x = edge.x * select(2.0 * pos.x, sign(pos.x), maxPos.x == posAbs.x);
	pos.y = edge.y * select(2.0 * pos.y, sign(pos.y), maxPos.y == posAbs.y);
	pos.z = edge.z * select(2.0 * pos.z, sign(pos.z), maxPos.z == posAbs.z);
	#ifndef LOCAL_SPACE
		return uniform.emitterPos + uniform.spawnBounds * pos;
	#else
		return uniform.spawnBounds * pos;
	#endif
}
fn addInitialVelocity(localVelocity: ptr<function, vec3f>, inBounds: vec3f) {
	*localVelocity = *localVelocity - vec3f(0.0, 0.0, uniform.initialVelocity);
}
`});var e7,t7=m(()=>{e7=`
	output.color = getOutput();
	return output;
}
`});var s7,i7=m(()=>{s7=`
varying vUv0: vec2f;
var particleTexIN: texture_2d<f32>;
var particleTexINSampler: sampler;
var internalTex0: texture_2d<f32>;
var internalTex0Sampler: sampler;
var internalTex1: texture_2d<f32>;
var internalTex1Sampler: sampler;
var internalTex2: texture_2d<f32>;
var internalTex2Sampler: sampler;
var internalTex3: texture_2d<f32>;
var internalTex3Sampler: sampler;
uniform emitterMatrix: mat3x3f;
uniform emitterMatrixInv: mat3x3f;
uniform emitterScale: vec3f;
uniform emitterPos: vec3f;
uniform frameRandom: vec3f;
uniform localVelocityDivMult: vec3f;
uniform velocityDivMult: vec3f;
uniform delta: f32;
uniform rate: f32;
uniform rateDiv: f32;
uniform lifetime: f32;
uniform numParticles: f32;
uniform rotSpeedDivMult: f32;
uniform radialSpeedDivMult: f32;
uniform seed: f32;
uniform startAngle: f32;
uniform startAngle2: f32;
uniform initialVelocity: f32;
uniform graphSampleSize: f32;
uniform graphNumSamples: f32;
var<private> inPos: vec3f;
var<private> inVel: vec3f;
var<private> inAngle: f32;
var<private> inShow: bool;
var<private> inLife: f32;
var<private> visMode: f32;
var<private> outPos: vec3f;
var<private> outVel: vec3f;
var<private> outAngle: f32;
var<private> outShow: bool;
var<private> outLife: f32;
`});var r7,a7=m(()=>{r7=`
	if (outLife >= uniform.lifetime) {
		outLife = outLife - max(uniform.lifetime, (uniform.numParticles - 1.0) * particleRate);
		visMode = -1.0;
	}
`});var n7,o7=m(()=>{n7=`
	visMode = select(visMode, -1.0, outLife < 0.0);
`});var l7,h7=m(()=>{l7=`
	if (outLife >= uniform.lifetime) {
		let subtractAmount = max(uniform.lifetime, (uniform.numParticles - 1.0) * particleRate);
		outLife = outLife - subtractAmount;
		visMode = 1.0;
	}
	visMode = select(visMode, 1.0, outLife < 0.0);
`});var c7,f7=m(()=>{c7=`
uniform spawnBoundsSphere: f32;
uniform spawnBoundsSphereInnerRatio: f32;
fn calcSpawnPosition(inBounds: vec3f, rndFactor: f32) -> vec3f {
	let rnd4: f32 = fract(rndFactor * 1000.0);
	let norm: vec3f = normalize(inBounds.xyz - vec3f(0.5));
	let r: f32 = rnd4 * (1.0 - uniform.spawnBoundsSphereInnerRatio) + uniform.spawnBoundsSphereInnerRatio;
	#ifndef LOCAL_SPACE
		return uniform.emitterPos + norm * r * uniform.spawnBoundsSphere;
	#else
		return norm * r * uniform.spawnBoundsSphere;
	#endif
}
fn addInitialVelocity(localVelocity: ptr<function, vec3f>, inBounds: vec3f) {
	let initialVelOffset: vec3f = normalize(inBounds - vec3f(0.5)) * uniform.initialVelocity;
	*localVelocity = *localVelocity + initialVelOffset;
}
`});var d7,u7=m(()=>{d7=`
fn saturate(x: f32) -> f32 {
	return clamp(x, 0.0, 1.0);
}
fn unpack3NFloats(src: f32) -> vec3f {
	let r = fract(src);
	let g = fract(src * 256.0);
	let b = fract(src * 65536.0);
	return vec3f(r, g, b);
}
struct TexLerpUnpackResult {
	result: vec3f,
	unpacked: vec3f
}
fn tex1Dlod_lerp(tex: texture_2d<f32>, texSampler: sampler, tc: vec2f) -> TexLerpUnpackResult {
	let tc_next = tc + vec2f(uniform.graphSampleSize);
	let a = textureSampleLevel(tex, texSampler, tc, 0.0);
	let b = textureSampleLevel(tex, texSampler, tc_next, 0.0);
	let c = fract(tc.x * uniform.graphNumSamples);
	let unpackedA = unpack3NFloats(a.w);
	let unpackedB = unpack3NFloats(b.w);
	let w_out = mix(unpackedA, unpackedB, c);
	return TexLerpUnpackResult(mix(a.xyz, b.xyz, c), w_out);
}
const HASHSCALE4: vec4f = vec4f(1031.0, 0.1030, 0.0973, 0.1099);
fn hash41(p: f32) -> vec4f {
	var p4 = fract(vec4f(p) * HASHSCALE4);
	p4 = p4 + dot(p4, p4.wzxy + 19.19);
	return fract(vec4f((p4.x + p4.y)*p4.z, (p4.x + p4.z)*p4.y, (p4.y + p4.z)*p4.w, (p4.z + p4.w)*p4.x));
}
@fragment
fn fragmentMain(input : FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	if (pcPosition.x > uniform.numParticles) {
		discard;
		return output;
	}
	readInput(input.vUv0.x);
	visMode = select(-1.0, 1.0, inShow);
	let rndFactor = hash41(pcPosition.x + uniform.seed);
	let particleRate = uniform.rate + uniform.rateDiv * rndFactor.x;
	outLife = inLife + uniform.delta;
	let nlife = clamp(outLife / uniform.lifetime, 0.0, 1.0);
	let lerpResult0 = tex1Dlod_lerp(internalTex0, internalTex0Sampler, vec2f(nlife, 0.0));
	var localVelocity = lerpResult0.result;
	let localVelocityDiv = lerpResult0.unpacked;
	let lerpResult1 = tex1Dlod_lerp(internalTex1, internalTex1Sampler, vec2f(nlife, 0.0));
	var velocity = lerpResult1.result;
	let velocityDiv = lerpResult1.unpacked;
	let lerpResult2 = tex1Dlod_lerp(internalTex2, internalTex2Sampler, vec2f(nlife, 0.0));
	let params = lerpResult2.result;
	let paramDiv = lerpResult2.unpacked;
	var rotSpeed = params.x;
	let rotSpeedDiv = paramDiv.y;
	let lerpResult3 = tex1Dlod_lerp(internalTex3, internalTex3Sampler, vec2f(nlife, 0.0));
	let radialParams = lerpResult3.result;
	let radialParamDiv = lerpResult3.unpacked;
	let radialSpeed = radialParams.x;
	let radialSpeedDiv = radialParamDiv.y;
	let respawn = inLife <= 0.0 || outLife >= uniform.lifetime;
	inPos = select(inPos, calcSpawnPosition(rndFactor.xyz, rndFactor.x), respawn);
	inAngle = select(inAngle, mix(uniform.startAngle, uniform.startAngle2, rndFactor.x), respawn);
	#ifndef LOCAL_SPACE
		var radialVel: vec3f = inPos - uniform.emitterPos;
	#else
		var radialVel: vec3f = inPos;
	#endif
	radialVel = select(vec3f(0.0), radialSpeed * normalize(radialVel), dot(radialVel, radialVel) > 1.0E-8);
	radialVel = radialVel + (radialSpeedDiv * vec3f(2.0) - vec3f(1.0)) * uniform.radialSpeedDivMult * rndFactor.xyz;
	localVelocity = localVelocity + (localVelocityDiv * vec3f(2.0) - vec3f(1.0)) * uniform.localVelocityDivMult * rndFactor.xyz;
	velocity = velocity + (velocityDiv * vec3f(2.0) - vec3f(1.0)) * uniform.velocityDivMult * rndFactor.xyz;
	rotSpeed = rotSpeed + (rotSpeedDiv * 2.0 - 1.0) * uniform.rotSpeedDivMult * rndFactor.y;
	addInitialVelocity(&localVelocity, rndFactor.xyz);
	#ifndef LOCAL_SPACE
		outVel = uniform.emitterMatrix * localVelocity + (radialVel + velocity) * uniform.emitterScale;
	#else
		outVel = (localVelocity + radialVel) / uniform.emitterScale + uniform.emitterMatrixInv * velocity;
	#endif
	outPos = inPos + outVel * uniform.delta;
	outAngle = inAngle + rotSpeed * uniform.delta;
`});var m7,p7=m(()=>{m7=`
	let rotationResult = rotateWithMatrix(quadXY, inAngle);
	let rotatedQuadXY = rotationResult.rotatedVec;
	rotMatrix = rotationResult.matrix;
	var localPos = billboard(particlePos, rotatedQuadXY);
`});var _7,g7=m(()=>{_7=`
	dBlendModeFogFactor = 0.0;
	rgb = rgb * saturate(gammaCorrectInput(max(a, 0.0)));
	if ((rgb.r + rgb.g + rgb.b) < 0.000001) {
		discard;
	}	
`});var S7,T7=m(()=>{S7=`
	rgb = mix(vec3f(1.0), rgb, a);
	if ((rgb.r + rgb.g + rgb.b) > 2.99) {
		discard;
	}
`});var E7,v7=m(()=>{E7=`
	if (a < 0.01) {
		discard;
	}
`});var x7,y7=m(()=>{x7=`
attribute particle_vertexData: vec4f;
attribute particle_vertexData2: vec4f;
attribute particle_vertexData3: vec4f;
attribute particle_vertexData4: f32;
#ifndef USE_MESH
	attribute particle_vertexData5: vec2f;
#else
	attribute particle_vertexData5: vec4f;
#endif
uniform matrix_viewProjection: mat4x4f;
uniform matrix_model: mat4x4f;
#ifndef VIEWMATRIX
	#define VIEWMATRIX
	uniform matrix_view: mat4x4f;
#endif
uniform matrix_normal: mat3x3f;
uniform matrix_viewInverse: mat4x4f;
uniform numParticles: f32;
uniform lifetime: f32;
uniform stretch: f32;
uniform seed: f32;
uniform wrapBounds: vec3f;
uniform emitterScale: vec3f;
uniform faceTangent: vec3f;
uniform faceBinorm: vec3f;
#ifdef PARTICLE_GPU
	var internalTex0: texture_2d<f32>;
	var internalTex0Sampler: sampler;
	var internalTex1: texture_2d<f32>;
	var internalTex1Sampler: sampler;
	var internalTex2: texture_2d<f32>;
	var internalTex2Sampler: sampler;
#endif
uniform emitterPos: vec3f;
varying texCoordsAlphaLife: vec4f;
struct RotateResult {
	rotatedVec: vec2f,
	matrix: mat2x2f
}
fn rotateWithMatrix(quadXY: vec2f, pRotation: f32) -> RotateResult {
	let c = cos(pRotation);
	let s = sin(pRotation);
	let m = mat2x2f(vec2f(c, s), vec2f(-s, c));
	return RotateResult(m * quadXY, m);
}
fn billboard(InstanceCoords: vec3f, quadXY: vec2f) -> vec3f {
	let pos = -uniform.matrix_viewInverse[0].xyz * quadXY.x + -uniform.matrix_viewInverse[1].xyz * quadXY.y;
	return pos;
}
fn customFace(InstanceCoords: vec3f, quadXY: vec2f) -> vec3f {
	let pos = uniform.faceTangent * quadXY.x + uniform.faceBinorm * quadXY.y;
	return pos;
}
fn safeNormalize(v: vec2f) -> vec2f {
	let l = length(v);
	return select(v, v / l, l > 1e-06);
}
@vertex
fn vertexMain(input: VertexInput) -> VertexOutput {
	var output: VertexOutput;
	var particlePos = input.particle_vertexData.xyz;
	let inPos = particlePos;
	let vertPos = input.particle_vertexData3.xyz;
	var inVel = vec3f(input.particle_vertexData2.w, input.particle_vertexData3.w, input.particle_vertexData5.x);
	let id = floor(input.particle_vertexData4);
	let rndFactor = fract(sin(id + 1.0 + uniform.seed));
	let rndFactor3 = vec3f(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));
	#ifdef LOCAL_SPACE
		let modelRotation = mat3x3f(uniform.matrix_model[0].xyz, uniform.matrix_model[1].xyz, uniform.matrix_model[2].xyz);
		inVel = modelRotation * inVel;
	#endif
	let velocityV = safeNormalize((mat3x3f(uniform.matrix_view[0].xyz, uniform.matrix_view[1].xyz, uniform.matrix_view[2].xyz) * inVel).xy);
	let quadXY = vertPos.xy;
	#ifdef USE_MESH
		output.texCoordsAlphaLife = vec4f(input.particle_vertexData5.zw, input.particle_vertexData2.z, input.particle_vertexData.w);
	#else
		output.texCoordsAlphaLife = vec4f(quadXY * -0.5 + 0.5, input.particle_vertexData2.z, input.particle_vertexData.w);
	#endif
	var rotMatrix: mat2x2f;
	var inAngle = input.particle_vertexData2.x;
	var particlePosMoved = vec3f(0.0);
	let meshLocalPos = input.particle_vertexData3.xyz;
`});var A7,P7=m(()=>{A7=`
	localPos = localPos * input.particle_vertexData2.y * uniform.emitterScale;
	localPos = localPos + particlePos;
	output.position = uniform.matrix_viewProjection * vec4f(localPos, 1.0);
`});var R7,C7=m(()=>{R7=`
	let rotationResult = rotateWithMatrix(quadXY, inAngle);
	let rotatedQuadXY = rotationResult.rotatedVec;
	rotMatrix = rotationResult.matrix;
	var localPos = customFace(particlePos, rotatedQuadXY);
`});var I7,w7=m(()=>{I7=`
	rgb = addFog(rgb);
	rgb = toneMap(rgb);
	rgb = gammaCorrectOutput(rgb);
	output.color = vec4f(rgb, a);
	return output;
}
`});var L7,b7=m(()=>{L7=`
	localPos = localPos * scale * uniform.emitterScale;
	localPos = localPos + particlePos;
	#ifdef SCREEN_SPACE
		output.position = vec4f(localPos.x, localPos.y, 0.0, 1.0);
	#else
		output.position = uniform.matrix_viewProjection * vec4f(localPos.xyz, 1.0);
	#endif
`});var M7,D7=m(()=>{M7=`
	var negNormal: vec3f = normal * 0.5 + 0.5;
	var posNormal: vec3f = -normal * 0.5 + 0.5;
	negNormal = negNormal * negNormal;
	posNormal = posNormal * posNormal;
`});var O7,N7=m(()=>{O7=`
attribute particle_vertexData: vec4f;
#if defined(USE_MESH)
	#if defined(USE_MESH_UV)
		attribute particle_uv: vec2f;
	#else
		var<private> particle_uv: vec2f = vec2f(0.0, 0.0);
	#endif
#endif
uniform matrix_viewProjection: mat4x4f;
uniform matrix_model: mat4x4f;
uniform matrix_normal: mat3x3f;
uniform matrix_viewInverse: mat4x4f;
#ifndef VIEWMATRIX
	#define VIEWMATRIX
	uniform matrix_view: mat4x4f;
#endif
uniform numParticles: f32;
uniform numParticlesPot: f32;
uniform graphSampleSize: f32;
uniform graphNumSamples: f32;
uniform stretch: f32;
uniform wrapBounds: vec3f;
uniform emitterScale: vec3f;
uniform emitterPos: vec3f;
uniform faceTangent: vec3f;
uniform faceBinorm: vec3f;
uniform rate: f32;
uniform rateDiv: f32;
uniform lifetime: f32;
uniform deltaRandomnessStatic: f32;
uniform scaleDivMult: f32;
uniform alphaDivMult: f32;
uniform seed: f32;
uniform delta: f32;
var particleTexOUT: texture_2d<f32>;
var particleTexOUTSampler: sampler;
var particleTexIN: texture_2d<f32>;
var particleTexINSampler: sampler;
#ifdef PARTICLE_GPU
	var internalTex0: texture_2d<f32>;
	var internalTex0Sampler: sampler;
	var internalTex1: texture_2d<f32>;
	var internalTex1Sampler: sampler;
	var internalTex2: texture_2d<f32>;
	var internalTex2Sampler: sampler;
#endif
#ifndef CAMERAPLANES
	#define CAMERAPLANES
	uniform camera_params: vec4f;
#endif
varying texCoordsAlphaLife: vec4f;
var<private> inPos: vec3f;
var<private> inVel: vec3f;
var<private> inAngle: f32;
var<private> inShow: bool;
var<private> inLife: f32;
`});var F7,U7=m(()=>{F7=`
	var negNormal: vec3f = max(normal, vec3(0.0));
	var posNormal: vec3f = max(-normal, vec3(0.0));
`});var B7,V7=m(()=>{B7=`
	let light: vec3f = negNormal.x * uniform.lightCube[0] + posNormal.x * uniform.lightCube[1] +
					   negNormal.y * uniform.lightCube[2] + posNormal.y * uniform.lightCube[3] +
					   negNormal.z * uniform.lightCube[4] + posNormal.z * uniform.lightCube[5];
	rgb = rgb * light;
`});var k7,G7=m(()=>{k7=`
particlePos = (uniform.matrix_model * vec4f(particlePos, 1.0)).xyz;
`});var z7,H7=m(()=>{z7=`
var localPos = meshLocalPos;
let rotResultXY = rotateWithMatrix(localPos.xy, inAngle);
localPos = vec3f(rotResultXY.rotatedVec, localPos.z);
rotMatrix = rotResultXY.matrix;
let rotResultYZ = rotateWithMatrix(localPos.yz, inAngle);
localPos = vec3f(localPos.x, rotResultYZ.rotatedVec);
rotMatrix = rotResultYZ.matrix;
billboard(particlePos, quadXY);
`});var X7,W7=m(()=>{X7=`
output.Normal = normalize(localPos + uniform.matrix_viewInverse[2].xyz);
`});var Y7,K7=m(()=>{Y7=`
	let sampledNormal: vec4f = textureSample(normalMap, normalMapSampler, vec2f(input.texCoordsAlphaLife.x, 1.0 - input.texCoordsAlphaLife.y));
	let normalMap: vec3f = normalize(sampledNormal.xyz * 2.0 - 1.0);
	let ParticleMat = mat3x3<f32>(ParticleMat0, ParticleMat1, ParticleMat2);
	let normal: vec3f = ParticleMat * normalMap;
`});var q7,j7=m(()=>{q7=`
	inAngle = atan2(velocityV.x, velocityV.y);
`});var $7,Z7=m(()=>{$7=`
	#include "particleUpdaterInitPS"
	#ifdef PACK8
		#include "particleInputRgba8PS"
		#include "particleOutputRgba8PS"
	#else
		#include "particleInputFloatPS"
		#include "particleOutputFloatPS"
	#endif
	#ifdef EMITTERSHAPE_BOX
		#include "particleUpdaterAABBPS"
	#else
		#include "particleUpdaterSpherePS"
	#endif
	#include "particleUpdaterStartPS"
	#ifdef RESPAWN
		#include "particleUpdaterRespawnPS"
	#endif
	#ifdef NO_RESPAWN
		#include "particleUpdaterNoRespawnPS"
	#endif
	#ifdef ON_STOP
		#include "particleUpdaterOnStopPS"
	#endif
	#include "particleUpdaterEndPS"
`});var Q7,J7=m(()=>{Q7=`
	#if NORMAL != NONE
		#if NORMAL == VERTEX
			varying Normal: vec3f;
		#endif
		#if NORMAL == MAP
			varying ParticleMat0: vec3f;
			varying ParticleMat1: vec3f;
			varying ParticleMat2: vec3f;
		#endif
		uniform lightCube: array<vec3f, 6>;
	#endif
	#ifdef SOFT
		varying vDepth: f32;
		#include "screenDepthPS"
	#endif
	#include "gammaPS"
	#include "tonemappingPS"
	#include "fogPS"
	#if NORMAL == MAP
		var normalMap: texture_2d<f32>;
		var normalMapSampler: sampler;
	#endif
	#include "particlePS"
	#ifdef SOFT
		#include "particle_softPS"
	#endif
	#if NORMAL == VERTEX
		var normal: vec3f = Normal;
	#endif
	#if NORMAL == MAP
		#include "particle_normalMapPS"
	#endif
	#if NORMAL != NONE
		#ifdef HALF_LAMBERT
			#include "particle_halflambertPS"
		#else
			#include "particle_lambertPS"
		#endif
		#include "particle_lightingPS"
	#endif
	#if BLEND == NORMAL
		#include "particle_blendNormalPS"
	#elif BLEND == ADDITIVE
		#include "particle_blendAddPS"
	#elif BLEND == MULTIPLICATIVE
		#include "particle_blendMultiplyPS"
	#endif
	#include "particle_endPS"
`});var eZ,tZ=m(()=>{eZ=`
	#ifdef ANIMTEX
		uniform animTexTilesParams: vec2f;
		uniform animTexParams: vec4f;
		uniform animTexIndexParams: vec2f;
	#endif
	#if NORMAL == MAP
		varying ParticleMat0: vec3f;
		varying ParticleMat1: vec3f;
		varying ParticleMat2: vec3f;
	#endif
	#if NORMAL == VERTEX
		varying Normal: vec3f;
	#endif
	#ifdef SOFT
		varying vDepth: f32;
	#endif
	#ifdef PARTICLE_GPU
		#include "particle_initVS"
		#ifdef PACK8
			#include "particleInputRgba8PS"
		#else
			#include  "particleInputFloatPS"
		#endif
		#ifdef SOFT
			#include "screenDepthPS"
		#endif
		#include "particleVS"
	#else
		#ifdef SOFT
			#include "screenDepthPS"
		#endif
		#include "particle_cpuVS"
	#endif
	#ifdef LOCAL_SPACE
		#include "particle_localShiftVS"
	#endif
	#ifdef ANIMTEX
		#ifdef ANIMTEX_LOOP
			#include "particleAnimFrameLoopVS"
		#else
			#include "particleAnimFrameClampVS"
		#endif
		#include "particleAnimTexVS"
	#endif
	#ifdef PARTICLE_GPU
		#ifdef WRAP
			#include "particle_wrapVS"
		#endif
	#endif
	#ifdef ALIGN_TO_MOTION
		#include "particle_pointAlongVS"
	#endif
	#ifdef USE_MESH
		#include "particle_meshVS"
	#else
		#ifdef CUSTOM_FACE
			#include "particle_customFaceVS"
		#else
			#include "particle_billboardVS"
		#endif
	#endif
	#if NORMAL == VERTEX
		#include "particle_normalVS"
	#endif
	#if NORMAL == MAP
		#include "particle_TBNVS"
	#endif
	#ifdef STRETCH
		#include "particle_stretchVS"
	#endif
	#ifdef PARTICLE_GPU
		#include "particle_endVS"
	#else
		#include "particle_cpu_endVS"
	#endif
	#ifdef SOFT
		#include "particle_softVS"
	#endif
	return output;
}
`});var sZ,iZ=m(()=>{sZ=`
	var depth: f32 = getLinearScreenDepthFrag();
	var particleDepth: f32 = vDepth;
	var depthDiff: f32 = saturate(abs(particleDepth - depth) * uniform.softening);
	a = a * depthDiff;
`});var rZ,aZ=m(()=>{rZ=`
	output.vDepth = getLinearDepth(localPos);
`});var nZ,oZ=m(()=>{nZ=`
	let moveDir: vec3f = inVel * uniform.stretch;
	var posPrev: vec3f = particlePos - moveDir;
	posPrev = posPrev + particlePosMoved;
	let viewRotationTemp: mat3x3f = mat3x3f(uniform.matrix_view[0].xyz, uniform.matrix_view[1].xyz, uniform.matrix_view[2].xyz);
	let centerToVertexV: vec2f = normalize((viewRotationTemp * localPos).xy);
	let interpolation: f32 = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;
	particlePos = mix(particlePos, posPrev, interpolation);
`});var lZ,hZ=m(()=>{lZ=`
	let rot3 = mat3x3f(
		vec3f(rotMatrix[0][0], rotMatrix[1][0], 0.0),
		vec3f(rotMatrix[0][1], rotMatrix[1][1], 0.0),
		vec3f(0.0, 0.0, 1.0)
	);
	let viewBasis = mat3x3f(
		-uniform.matrix_viewInverse[0].xyz,
		-uniform.matrix_viewInverse[1].xyz,
		uniform.matrix_viewInverse[2].xyz
	);
	let tempMat = viewBasis * rot3;
	output.ParticleMat0 = tempMat[0];
	output.ParticleMat1 = tempMat[1];
	output.ParticleMat2 = tempMat[2];
`});var cZ,fZ=m(()=>{cZ=`
	let origParticlePos: vec3f = particlePos;
	particlePos = particlePos - uniform.matrix_model[3].xyz;
	particlePos = (particlePos % uniform.wrapBounds) - uniform.wrapBounds * 0.5;
	particlePos = particlePos + uniform.matrix_model[3].xyz;
	particlePosMoved = particlePos - origParticlePos;
`});var dZ,uZ=m(()=>{N9();U9();V9();G9();H9();W9();K9();j9();Z9();J9();t7();i7();a7();o7();h7();f7();u7();p7();g7();T7();v7();y7();P7();C7();w7();b7();D7();N7();U7();V7();G7();H7();W7();K7();j7();Z7();J7();tZ();iZ();aZ();oZ();hZ();fZ();dZ={particlePS:O9,particleVS:F9,particleAnimFrameClampVS:B9,particleAnimFrameLoopVS:k9,particleAnimTexVS:z9,particleInputFloatPS:X9,particleInputRgba8PS:Y9,particleOutputFloatPS:q9,particleOutputRgba8PS:$9,particleUpdaterAABBPS:Q9,particleUpdaterEndPS:e7,particleUpdaterInitPS:s7,particleUpdaterNoRespawnPS:r7,particleUpdaterOnStopPS:n7,particleUpdaterRespawnPS:l7,particleUpdaterSpherePS:c7,particleUpdaterStartPS:d7,particle_billboardVS:m7,particle_blendAddPS:_7,particle_blendMultiplyPS:S7,particle_blendNormalPS:E7,particle_cpuVS:x7,particle_cpu_endVS:A7,particle_customFaceVS:R7,particle_endPS:I7,particle_endVS:L7,particle_halflambertPS:M7,particle_initVS:O7,particle_lambertPS:F7,particle_lightingPS:B7,particle_localShiftVS:k7,particle_meshVS:z7,particle_normalVS:X7,particle_normalMapPS:Y7,particle_pointAlongVS:q7,particle_simulationPS:$7,particle_shaderPS:Q7,particle_shaderVS:eZ,particle_softPS:sZ,particle_softVS:rZ,particle_stretchVS:nZ,particle_TBNVS:lZ,particle_wrapVS:cZ}});var woe,l_,VM=m(()=>{ou();jg();Q();rt();Ut();BM();Jj();D9();uZ();j();It();woe=["enabled","autoPlay","numParticles","lifetime","rate","rate2","startAngle","startAngle2","loop","preWarm","lighting","halfLambert","intensity","depthWrite","noFog","depthSoftening","sort","blendType","stretch","alignToMotion","emitterShape","emitterExtents","emitterExtentsInner","emitterRadius","emitterRadiusInner","initialVelocity","wrap","wrapBounds","localSpace","screenSpace","colorMapAsset","normalMapAsset","mesh","meshAsset","renderAsset","orientation","particleNormal","localVelocityGraph","localVelocityGraph2","velocityGraph","velocityGraph2","rotationSpeedGraph","rotationSpeedGraph2","radialSpeedGraph","radialSpeedGraph2","scaleGraph","scaleGraph2","colorGraph","colorGraph2","alphaGraph","alphaGraph2","colorMap","normalMap","animTilesX","animTilesY","animStartFrame","animNumFrames","animNumAnimations","animIndex","randomizeAnimIndex","animSpeed","animLoop","layers"],l_=class extends Me{constructor(e){super(e),this.id="particlesystem",this.ComponentType=o_,this.DataType=wP,this.schema=woe,this.propertyTypes={emitterExtents:"vec3",emitterExtentsInner:"vec3",particleNormal:"vec3",wrapBounds:"vec3",localVelocityGraph:"curveset",localVelocityGraph2:"curveset",velocityGraph:"curveset",velocityGraph2:"curveset",colorGraph:"curveset",colorGraph2:"curveset",alphaGraph:"curve",alphaGraph2:"curve",rotationSpeedGraph:"curve",rotationSpeedGraph2:"curve",radialSpeedGraph:"curve",radialSpeedGraph2:"curve",scaleGraph:"curve",scaleGraph2:"curve"},this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("update",this.onUpdate,this),ie.get(e.graphicsDevice,oe).add(M9),ie.get(e.graphicsDevice,le).add(dZ)}initializeComponentData(e,t,s){let i={};s=[];let r=this.propertyTypes;(t.mesh instanceof re||typeof t.mesh=="number")&&(t.meshAsset=t.mesh,delete t.mesh);for(let a in t){if(t.hasOwnProperty(a)&&(s.push(a),i[a]=t[a]),r[a]==="vec3")Array.isArray(i[a])&&(i[a]=new g(i[a][0],i[a][1],i[a][2]));else if(r[a]==="curve"){if(!(i[a]instanceof Ts)){let n=i[a].type;i[a]=new Ts(i[a].keys),i[a].type=n}}else if(r[a]==="curveset"&&!(i[a]instanceof Bi)){let n=i[a].type;i[a]=new Bi(i[a].keys),i[a].type=n}i.layers&&Array.isArray(i.layers)&&(i.layers=i.layers.slice(0))}super.initializeComponentData(e,i,s)}cloneComponent(e,t){let s=e.particlesystem.data,i=this.schema,r={};for(let a=0,n=i.length;a<n;a++){let l=i[a],h=s[l];h instanceof g||h instanceof Ts||h instanceof Bi?(h=h.clone(),r[l]=h):l==="layers"?r.layers=s.layers.slice(0):h!=null&&(r[l]=h)}return this.addComponent(t,r)}onUpdate(e){let t=this.store,s=this.app.stats.particles,i=this.app.scene.layers;for(let r=0;r<i.layerList.length;r++)i.layerList[r].requiresLightCube=!1;for(let r in t)if(t.hasOwnProperty(r)){let a=t[r],n=a.entity,l=a.data;if(l.enabled&&n.enabled){let h=n.particlesystem.emitter;if(!h?.meshInstance.visible)continue;if(h.lighting){let c=l.layers;for(let f=0;f<c.length;f++){let d=i.getLayerById(c[f]);d&&(d.requiresLightCube=!0)}}if(!l.paused){let c=0;if(h.simTime+=e,h.simTime>=h.fixedTimeStep&&(c=Math.floor(h.simTime/h.fixedTimeStep),h.simTime-=c*h.fixedTimeStep),c){c=Math.min(c,h.maxSubSteps);for(let f=0;f<c;f++)h.addTime(h.fixedTimeStep,!1);s._updatesPerFrame+=c,s._frameTime+=h._addTimeTime,h._addTimeTime=0}h.finishFrame()}}}}onBeforeRemove(e,t){t.onBeforeRemove()}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}});var kM,Td,GM=m(()=>{mS();Wf();kM=class extends eo{constructor(e,t){super(),this.skin=e,this.skinInstance=t}},Td=class o{static{this._skinInstanceCache=new Map}static createCachedSkinInstance(e,t,s){let i=o.getCachedSkinInstance(e,t);return i||(i=new ar(e),i.resolve(t,s),o.addCachedSkinInstance(e,t,i)),i}static getCachedSkinInstance(e,t){let s=null,i=o._skinInstanceCache.get(t);if(i){let r=i.find(a=>a.skin===e);r&&(r.incRefCount(),s=r.skinInstance)}return s}static addCachedSkinInstance(e,t,s){let i=o._skinInstanceCache.get(t);i||(i=[],o._skinInstanceCache.set(t,i));let r=i.find(a=>a.skin===e);r||(r=new kM(e,s),i.push(r)),r.incRefCount()}static removeCachedSkinInstance(e){if(e){let t=e.rootBone;if(t){let s=o._skinInstanceCache.get(t);if(s){let i=s.findIndex(r=>r.skinInstance===e);if(i>=0){let r=s[i];r.decRefCount(),r.refCount===0&&(s.splice(i,1),s.length||o._skinInstanceCache.delete(t),e&&(e.destroy(),r.skinInstance=null))}}}}}}});var Oa,FT=m(()=>{Oa=class{constructor(e,t,s,i,r){this._evtLoadById=null,this._evtUnloadById=null,this._evtAddById=null,this._evtRemoveById=null,this._evtLoadByUrl=null,this._evtAddByUrl=null,this._evtRemoveByUrl=null,this.propertyName=e,this.parent=t,this._scope=r,this._registry=s,this.id=null,this.url=null,this.asset=null,this._onAssetLoad=i.load,this._onAssetAdd=i.add,this._onAssetRemove=i.remove,this._onAssetUnload=i.unload}set id(e){if(this.url)throw Error("Can't set id and url");this._unbind(),this._id=e,this.asset=this._registry.get(this._id),this._bind()}get id(){return this._id}set url(e){if(this.id)throw Error("Can't set id and url");this._unbind(),this._url=e,this.asset=this._registry.getByUrl(this._url),this._bind()}get url(){return this._url}_bind(){this.id&&(this._onAssetLoad&&(this._evtLoadById=this._registry.on(`load:${this.id}`,this._onLoad,this)),this._onAssetAdd&&(this._evtAddById=this._registry.once(`add:${this.id}`,this._onAdd,this)),this._onAssetRemove&&(this._evtRemoveById=this._registry.on(`remove:${this.id}`,this._onRemove,this)),this._onAssetUnload&&(this._evtUnloadById=this._registry.on(`unload:${this.id}`,this._onUnload,this))),this.url&&(this._onAssetLoad&&(this._evtLoadByUrl=this._registry.on(`load:url:${this.url}`,this._onLoad,this)),this._onAssetAdd&&(this._evtAddByUrl=this._registry.once(`add:url:${this.url}`,this._onAdd,this)),this._onAssetRemove&&(this._evtRemoveByUrl=this._registry.on(`remove:url:${this.url}`,this._onRemove,this)))}_unbind(){this.id&&(this._evtLoadById?.off(),this._evtLoadById=null,this._evtAddById?.off(),this._evtAddById=null,this._evtRemoveById?.off(),this._evtRemoveById=null,this._evtUnloadById?.off(),this._evtUnloadById=null),this.url&&(this._evtLoadByUrl?.off(),this._evtLoadByUrl=null,this._evtAddByUrl?.off(),this._evtAddByUrl=null,this._evtRemoveByUrl?.off(),this._evtRemoveByUrl=null)}_onLoad(e){this._onAssetLoad.call(this._scope,this.propertyName,this.parent,e)}_onAdd(e){this.asset=e,this._onAssetAdd.call(this._scope,this.propertyName,this.parent,e)}_onRemove(e){this._onAssetRemove.call(this._scope,this.propertyName,this.parent,e),this.asset=null}_onUnload(e){this._onAssetUnload.call(this._scope,this.propertyName,this.parent,e)}}});var Ed,zM=m(()=>{J();Xf();_s();Km();FM();Zt();GM();rt();FT();We();Ed=class extends ae{constructor(e,t){super(e,t),this._type="asset",this._castShadows=!0,this._receiveShadows=!0,this._castShadowsLightmap=!0,this._lightmapped=!1,this._lightmapSizeMultiplier=1,this.isStatic=!1,this._batchGroupId=-1,this._layers=[ms],this._renderStyle=Qa,this._meshInstances=[],this._customAabb=null,this._area=null,this._materialReferences=[],this._rootBone=null,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._evtSetMeshes=null,this._assetReference=new Oa("asset",this,e.app.assets,{add:this._onRenderAssetAdded,load:this._onRenderAssetLoad,remove:this._onRenderAssetRemove,unload:this._onRenderAssetUnload},this),this._material=e.defaultMaterial,t.on("remove",this.onRemoveChild,this),t.on("removehierarchy",this.onRemoveChild,this),t.on("insert",this.onInsertChild,this),t.on("inserthierarchy",this.onInsertChild,this)}set renderStyle(e){this._renderStyle!==e&&(this._renderStyle=e,Oe._prepareRenderStyleForArray(this._meshInstances,e))}get renderStyle(){return this._renderStyle}set customAabb(e){this._customAabb=e;let t=this._meshInstances;if(t)for(let s=0;s<t.length;s++)t[s].setCustomAabb(this._customAabb)}get customAabb(){return this._customAabb}set type(e){if(this._type!==e&&(this._area=null,this._type=e,this.destroyMeshInstances(),e!=="asset")){let t=this._material;(!t||t===this.system.defaultMaterial)&&(t=this._materialReferences[0]&&this._materialReferences[0].asset&&this._materialReferences[0].asset.resource);let s=PP(this.system.app.graphicsDevice,e);this._area=s.area,this.meshInstances=[new Oe(s.mesh,t||this.system.defaultMaterial,this.entity)]}}get type(){return this._type}set meshInstances(e){if(this.destroyMeshInstances(),this._meshInstances=e,this._meshInstances){let t=this._meshInstances;for(let s=0;s<t.length;s++)t[s].node||(t[s].node=this.entity),t[s].castShadow=this._castShadows,t[s].receiveShadow=this._receiveShadows,t[s].renderStyle=this._renderStyle,t[s].setLightmapped(this._lightmapped),t[s].setCustomAabb(this._customAabb);this.enabled&&this.entity.enabled&&this.addToLayers()}}get meshInstances(){return this._meshInstances}set lightmapped(e){if(e!==this._lightmapped){this._lightmapped=e;let t=this._meshInstances;if(t)for(let s=0;s<t.length;s++)t[s].setLightmapped(e)}}get lightmapped(){return this._lightmapped}set castShadows(e){if(this._castShadows!==e){let t=this._meshInstances;if(t){let s=this.layers,i=this.system.app.scene;if(this._castShadows&&!e)for(let r=0;r<s.length;r++){let a=i.layers.getLayerById(this.layers[r]);a&&a.removeShadowCasters(t)}for(let r=0;r<t.length;r++)t[r].castShadow=e;if(!this._castShadows&&e)for(let r=0;r<s.length;r++){let a=i.layers.getLayerById(s[r]);a&&a.addShadowCasters(t)}}this._castShadows=e}}get castShadows(){return this._castShadows}set receiveShadows(e){if(this._receiveShadows!==e){this._receiveShadows=e;let t=this._meshInstances;if(t)for(let s=0;s<t.length;s++)t[s].receiveShadow=e}}get receiveShadows(){return this._receiveShadows}set castShadowsLightmap(e){this._castShadowsLightmap=e}get castShadowsLightmap(){return this._castShadowsLightmap}set lightmapSizeMultiplier(e){this._lightmapSizeMultiplier=e}get lightmapSizeMultiplier(){return this._lightmapSizeMultiplier}set layers(e){let t=this.system.app.scene.layers,s;if(this._meshInstances)for(let i=0;i<this._layers.length;i++)s=t.getLayerById(this._layers[i]),s&&s.removeMeshInstances(this._meshInstances);this._layers.length=0;for(let i=0;i<e.length;i++)this._layers[i]=e[i];if(!(!this.enabled||!this.entity.enabled||!this._meshInstances))for(let i=0;i<this._layers.length;i++)s=t.getLayerById(this._layers[i]),s&&s.addMeshInstances(this._meshInstances)}get layers(){return this._layers}set batchGroupId(e){this._batchGroupId!==e&&(this.entity.enabled&&this._batchGroupId>=0&&this.system.app.batcher?.remove(wt.RENDER,this.batchGroupId,this.entity),this.entity.enabled&&e>=0&&this.system.app.batcher?.insert(wt.RENDER,e,this.entity),e<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addToLayers(),this._batchGroupId=e)}get batchGroupId(){return this._batchGroupId}set material(e){if(this._material!==e&&(this._material=e,this._meshInstances&&this._type!=="asset"))for(let t=0;t<this._meshInstances.length;t++)this._meshInstances[t].material=e}get material(){return this._material}set materialAssets(e=[]){if(this._materialReferences.length>e.length){for(let t=e.length;t<this._materialReferences.length;t++)this._materialReferences[t].id=null;this._materialReferences.length=e.length}for(let t=0;t<e.length;t++)if(this._materialReferences[t]||this._materialReferences.push(new Oa(t,this,this.system.app.assets,{add:this._onMaterialAdded,load:this._onMaterialLoad,remove:this._onMaterialRemove,unload:this._onMaterialUnload},this)),e[t]){let s=e[t]instanceof re?e[t].id:e[t];this._materialReferences[t].id!==s&&(this._materialReferences[t].id=s),this._materialReferences[t].asset&&this._onMaterialAdded(t,this,this._materialReferences[t].asset)}else this._materialReferences[t].id=null,this._meshInstances[t]&&(this._meshInstances[t].material=this.system.defaultMaterial)}get materialAssets(){return this._materialReferences.map(e=>e.id)}set asset(e){let t=e instanceof re?e.id:e;this._assetReference.id!==t&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onRenderAssetRemove(),this._assetReference.id=t,this._assetReference.asset&&this._onRenderAssetAdded())}get asset(){return this._assetReference.id}assignAsset(e){let t=e instanceof re?e.id:e;this._assetReference.id=t}set rootBone(e){if(this._rootBone!==e){let t=typeof e=="string";if(this._rootBone&&t&&this._rootBone.getGuid()===e)return;this._rootBone&&this._clearSkinInstances(),e instanceof Ae?this._rootBone=e:t?(this._rootBone=this.system.app.getEntityFromIndex(e)||null,this._rootBone):this._rootBone=null,this._rootBone&&this._cloneSkinInstances()}}get rootBone(){return this._rootBone}destroyMeshInstances(){let e=this._meshInstances;if(e){this.removeFromLayers(),this._clearSkinInstances();for(let t=0;t<e.length;t++)e[t].destroy();this._meshInstances.length=0}}addToLayers(){let e=this.system.app.scene.layers;for(let t=0;t<this._layers.length;t++){let s=e.getLayerById(this._layers[t]);s&&s.addMeshInstances(this._meshInstances)}}removeFromLayers(){if(this._meshInstances&&this._meshInstances.length){let e=this.system.app.scene.layers;for(let t=0;t<this._layers.length;t++){let s=e.getLayerById(this._layers[t]);s&&s.removeMeshInstances(this._meshInstances)}}}onRemoveChild(){this.removeFromLayers()}onInsertChild(){this._meshInstances&&this.enabled&&this.entity.enabled&&this.addToLayers()}onRemove(){this.destroyMeshInstances(),this.asset=null,this.materialAsset=null,this._assetReference.id=null;for(let e=0;e<this._materialReferences.length;e++)this._materialReferences[e].id=null;this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(e,t){this.addToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||e.addMeshInstances(this._meshInstances)}onLayerRemoved(e){this.layers.indexOf(e.id)<0||e.removeMeshInstances(this._meshInstances)}onEnable(){let e=this.system.app,t=e.scene,s=t.layers;this._rootBone&&this._cloneSkinInstances(),this._evtLayersChanged=t.on("set:layers",this.onLayersChanged,this),s&&(this._evtLayerAdded=s.on("add",this.onLayerAdded,this),this._evtLayerRemoved=s.on("remove",this.onLayerRemoved,this));let i=this._type==="asset";this._meshInstances&&this._meshInstances.length?this.addToLayers():i&&this.asset&&this._onRenderAssetAdded();for(let r=0;r<this._materialReferences.length;r++)this._materialReferences[r].asset&&this.system.app.assets.load(this._materialReferences[r].asset);this._batchGroupId>=0&&e.batcher?.insert(wt.RENDER,this.batchGroupId,this.entity)}onDisable(){let e=this.system.app,s=e.scene.layers;this._evtLayersChanged?.off(),this._evtLayersChanged=null,this._rootBone&&this._clearSkinInstances(),s&&(this._evtLayerAdded?.off(),this._evtLayerAdded=null,this._evtLayerRemoved?.off(),this._evtLayerRemoved=null),this._batchGroupId>=0&&e.batcher?.remove(wt.RENDER,this.batchGroupId,this.entity),this.removeFromLayers()}hide(){if(this._meshInstances)for(let e=0;e<this._meshInstances.length;e++)this._meshInstances[e].visible=!1}show(){if(this._meshInstances)for(let e=0;e<this._meshInstances.length;e++)this._meshInstances[e].visible=!0}_onRenderAssetAdded(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onRenderAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset))}_onRenderAssetLoad(){if(this.destroyMeshInstances(),this._assetReference.asset){let e=this._assetReference.asset.resource;this._evtSetMeshes?.off(),this._evtSetMeshes=e.on("set:meshes",this._onSetMeshes,this),e.meshes&&this._onSetMeshes(e.meshes)}}_onSetMeshes(e){this._cloneMeshes(e)}_clearSkinInstances(){for(let e=0;e<this._meshInstances.length;e++){let t=this._meshInstances[e];Td.removeCachedSkinInstance(t.skinInstance),t.skinInstance=null}}_cloneSkinInstances(){if(this._meshInstances.length&&this._rootBone instanceof Ae)for(let e=0;e<this._meshInstances.length;e++){let t=this._meshInstances[e],s=t.mesh;s.skin&&!t.skinInstance&&(t.skinInstance=Td.createCachedSkinInstance(s.skin,this._rootBone,this.entity))}}_cloneMeshes(e){if(e&&e.length){let t=[];for(let s=0;s<e.length;s++){let i=e[s],r=this._materialReferences[s]&&this._materialReferences[s].asset&&this._materialReferences[s].asset.resource,a=new Oe(i,r||this.system.defaultMaterial,this.entity);t.push(a),i.morph&&(a.morphInstance=new br(i.morph))}this.meshInstances=t,this._cloneSkinInstances()}}_onRenderAssetUnload(){this._type==="asset"&&this.destroyMeshInstances()}_onRenderAssetRemove(){this._evtSetMeshes?.off(),this._evtSetMeshes=null,this._onRenderAssetUnload()}_onMaterialAdded(e,t,s){s.resource?this._onMaterialLoad(e,t,s):this.enabled&&this.entity.enabled&&this.system.app.assets.load(s)}_updateMainMaterial(e,t){e===0&&(this.material=t)}_onMaterialLoad(e,t,s){this._meshInstances[e]&&(this._meshInstances[e].material=s.resource),this._updateMainMaterial(e,s.resource)}_onMaterialRemove(e,t,s){this._meshInstances[e]&&(this._meshInstances[e].material=this.system.defaultMaterial),this._updateMainMaterial(e,this.system.defaultMaterial)}_onMaterialUnload(e,t,s){this._meshInstances[e]&&(this._meshInstances[e].material=this.system.defaultMaterial),this._updateMainMaterial(e,this.system.defaultMaterial)}resolveDuplicatedEntityReferenceProperties(e,t){e.rootBone&&(this.rootBone=t[e.rootBone.getGuid()])}}});var LP,mZ=m(()=>{LP=class{constructor(){this.enabled=!0}}});var HM,vd,wc,XM=m(()=>{Q();Vt();Vh();We();Ut();zM();mZ();HM=["enabled"],vd=["material","meshInstances","asset","materialAssets","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","renderStyle","type","layers","isStatic","batchGroupId","rootBone"],wc=class extends Me{constructor(e){super(e),this.id="render",this.ComponentType=Ed,this.DataType=LP,this.schema=HM,this.defaultMaterial=va(e.graphicsDevice),this.on("beforeremove",this.onRemove,this)}initializeComponentData(e,t,s){(t.batchGroupId===null||t.batchGroupId===void 0)&&(t.batchGroupId=-1),t.layers&&t.layers.length&&(t.layers=t.layers.slice(0));for(let i=0;i<vd.length;i++)t.hasOwnProperty(vd[i])&&(e[vd[i]]=t[vd[i]]);t.aabbCenter&&t.aabbHalfExtents&&(e.customAabb=new _e(new g(t.aabbCenter),new g(t.aabbHalfExtents))),super.initializeComponentData(e,t,HM)}cloneComponent(e,t){let s={};for(let n=0;n<vd.length;n++)s[vd[n]]=e.render[vd[n]];s.enabled=e.render.enabled,delete s.meshInstances;let i=this.addComponent(t,s),r=e.render.meshInstances,a=r.map(n=>n.mesh);i._onSetMeshes(a);for(let n=0;n<r.length;n++)i.meshInstances[n].material=r[n].material;return e.render.customAabb&&(i.customAabb=e.render.customAabb.clone()),i}onRemove(e,t){t.onRemove()}};ae._buildAccessors(Ed.prototype,HM)});var h_,pZ=m(()=>{h_=class{constructor(e,t){this._pool=[],this._count=0,this._constructor=e,this._resize(t)}_resize(e){if(e>this._pool.length)for(let t=this._pool.length;t<e;t++)this._pool[t]=new this._constructor}allocate(){return this._count>=this._pool.length&&this._resize(this._pool.length*2),this._pool[this._count++]}freeAll(){this._count=0}}});var Ur,Je,un,c_,Loe,boe,bP,Na,MP=m(()=>{Ve();Q();We();cP();Loe=new H,boe=new H,bP=new g,Na=class extends ae{static{this.EVENT_CONTACT="contact"}static{this.EVENT_COLLISIONSTART="collisionstart"}static{this.EVENT_COLLISIONEND="collisionend"}static{this.EVENT_TRIGGERENTER="triggerenter"}static{this.EVENT_TRIGGERLEAVE="triggerleave"}static{this.order=-1}static onLibraryLoaded(){typeof Ammo<"u"&&(Ur=new Ammo.btTransform,Je=new Ammo.btVector3,un=new Ammo.btVector3,c_=new Ammo.btQuaternion)}static onAppDestroy(){Ammo.destroy(Ur),Ammo.destroy(Je),Ammo.destroy(un),Ammo.destroy(c_),Ur=null,Je=null,un=null,c_=null}set angularDamping(e){this._angularDamping!==e&&(this._angularDamping=e,this._body&&this._body.setDamping(this._linearDamping,e))}get angularDamping(){return this._angularDamping}set angularFactor(e){this._angularFactor.equals(e)||(this._angularFactor.copy(e),this._body&&this._type===yi&&(Je.setValue(e.x,e.y,e.z),this._body.setAngularFactor(Je)))}get angularFactor(){return this._angularFactor}set angularVelocity(e){this._body&&this._type===yi&&(this._body.activate(),Je.setValue(e.x,e.y,e.z),this._body.setAngularVelocity(Je),this._angularVelocity.copy(e))}get angularVelocity(){if(this._body&&this._type===yi){let e=this._body.getAngularVelocity();this._angularVelocity.set(e.x(),e.y(),e.z())}return this._angularVelocity}set body(e){this._body!==e&&(this._body=e,e&&this._simulationEnabled&&e.activate())}get body(){return this._body}set friction(e){this._friction!==e&&(this._friction=e,this._body&&this._body.setFriction(e))}get friction(){return this._friction}set group(e){this._group!==e&&(this._group=e,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()))}get group(){return this._group}set linearDamping(e){this._linearDamping!==e&&(this._linearDamping=e,this._body&&this._body.setDamping(e,this._angularDamping))}get linearDamping(){return this._linearDamping}set linearFactor(e){this._linearFactor.equals(e)||(this._linearFactor.copy(e),this._body&&this._type===yi&&(Je.setValue(e.x,e.y,e.z),this._body.setLinearFactor(Je)))}get linearFactor(){return this._linearFactor}set linearVelocity(e){this._body&&this._type===yi&&(this._body.activate(),Je.setValue(e.x,e.y,e.z),this._body.setLinearVelocity(Je),this._linearVelocity.copy(e))}get linearVelocity(){if(this._body&&this._type===yi){let e=this._body.getLinearVelocity();this._linearVelocity.set(e.x(),e.y(),e.z())}return this._linearVelocity}set mask(e){this._mask!==e&&(this._mask=e,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()))}get mask(){return this._mask}set mass(e){if(this._mass!==e&&(this._mass=e,this._body&&this._type===yi)){let t=this.enabled&&this.entity.enabled;t&&this.disableSimulation(),this._body.getCollisionShape().calculateLocalInertia(e,Je),this._body.setMassProps(e,Je),this._body.updateInertiaTensor(),t&&this.enableSimulation()}}get mass(){return this._mass}set restitution(e){this._restitution!==e&&(this._restitution=e,this._body&&this._body.setRestitution(e))}get restitution(){return this._restitution}set rollingFriction(e){this._rollingFriction!==e&&(this._rollingFriction=e,this._body&&this._body.setRollingFriction(e))}get rollingFriction(){return this._rollingFriction}set type(e){if(this._type!==e){switch(this._type=e,this.disableSimulation(),e){case yi:this._group=1,this._mask=65535;break;case fn:this._group=4,this._mask=65535;break;case Ao:default:this._group=2,this._mask=65533;break}this.createBody()}}get type(){return this._type}createBody(){let e=this.entity,t;if(e.collision&&(t=e.collision.shape,e.trigger&&(e.trigger.destroy(),delete e.trigger)),t){this._body&&(this.system.removeBody(this._body),this.system.destroyBody(this._body),this._body=null);let s=this._type===yi?this._mass:0;this._getEntityTransform(Ur);let i=this.system.createBody(s,t,Ur);if(i.setRestitution(this._restitution),i.setFriction(this._friction),i.setRollingFriction(this._rollingFriction),i.setDamping(this._linearDamping,this._angularDamping),this._type===yi){let r=this._linearFactor;Je.setValue(r.x,r.y,r.z),i.setLinearFactor(Je);let a=this._angularFactor;Je.setValue(a.x,a.y,a.z),i.setAngularFactor(Je)}else this._type===fn&&(i.setCollisionFlags(i.getCollisionFlags()|2),i.setActivationState(4));i.entity=e,this.body=i,this.enabled&&e.enabled&&this.enableSimulation()}}isActive(){return this._body?this._body.isActive():!1}activate(){this._body&&this._body.activate()}enableSimulation(){let e=this.entity;if(e.collision&&e.collision.enabled&&!this._simulationEnabled){let t=this._body;if(t){switch(this.system.addBody(t,this._group,this._mask),this._type){case yi:this.system._dynamic.push(this),t.forceActivationState(1),this.syncEntityToBody();break;case fn:this.system._kinematic.push(this),t.forceActivationState(4);break;case Ao:t.forceActivationState(1),this.syncEntityToBody();break}e.collision.type==="compound"&&this.system._compounds.push(e.collision),t.activate(),this._simulationEnabled=!0}}}disableSimulation(){let e=this._body;if(e&&this._simulationEnabled){let t=this.system,s=t._compounds.indexOf(this.entity.collision);s>-1&&t._compounds.splice(s,1),s=t._dynamic.indexOf(this),s>-1&&t._dynamic.splice(s,1),s=t._kinematic.indexOf(this),s>-1&&t._kinematic.splice(s,1),t.removeBody(e),e.forceActivationState(5),this._simulationEnabled=!1}}applyForce(e,t,s,i,r,a){let n=this._body;n&&(n.activate(),e instanceof g?Je.setValue(e.x,e.y,e.z):Je.setValue(e,t,s),t instanceof g?un.setValue(t.x,t.y,t.z):i!==void 0?un.setValue(i,r,a):un.setValue(0,0,0),n.applyForce(Je,un))}applyTorque(e,t,s){let i=this._body;i&&(i.activate(),e instanceof g?Je.setValue(e.x,e.y,e.z):Je.setValue(e,t,s),i.applyTorque(Je))}applyImpulse(e,t,s,i,r,a){let n=this._body;n&&(n.activate(),e instanceof g?Je.setValue(e.x,e.y,e.z):Je.setValue(e,t,s),t instanceof g?un.setValue(t.x,t.y,t.z):i!==void 0?un.setValue(i,r,a):un.setValue(0,0,0),n.applyImpulse(Je,un))}applyTorqueImpulse(e,t,s){let i=this._body;i&&(i.activate(),e instanceof g?Je.setValue(e.x,e.y,e.z):Je.setValue(e,t,s),i.applyTorqueImpulse(Je))}isStatic(){return this._type===Ao}isStaticOrKinematic(){return this._type===Ao||this._type===fn}isKinematic(){return this._type===fn}_getEntityTransform(e){let t=this.entity,s=t.collision;if(s){let i=s.getShapePosition(),r=s.getShapeRotation();Je.setValue(i.x,i.y,i.z),c_.setValue(r.x,r.y,r.z,r.w)}else{let i=t.getPosition(),r=t.getRotation();Je.setValue(i.x,i.y,i.z),c_.setValue(r.x,r.y,r.z,r.w)}e.setOrigin(Je),e.setRotation(c_)}syncEntityToBody(){let e=this._body;if(e){if(this._getEntityTransform(Ur),e.setWorldTransform(Ur),this._type===fn){let t=e.getMotionState();t&&t.setWorldTransform(Ur)}e.activate()}}_updateDynamic(){let e=this._body;if(e.isActive()){let t=e.getMotionState();if(t){let s=this.entity;t.getWorldTransform(Ur);let i=Ur.getOrigin(),r=Ur.getRotation(),a=s.collision;if(a&&a._hasOffset){let n=a.data.linearOffset,l=a.data.angularOffset,h=boe.copy(l).invert(),c=Loe.set(r.x(),r.y(),r.z(),r.w()).mul(h);c.transformVector(n,bP),s.setPosition(i.x()-bP.x,i.y()-bP.y,i.z()-bP.z),s.setRotation(c)}else s.setPosition(i.x(),i.y(),i.z()),s.setRotation(r.x(),r.y(),r.z(),r.w())}}}_updateKinematic(){let e=this._body.getMotionState();e&&(this._getEntityTransform(Ur),e.setWorldTransform(Ur))}teleport(e,t,s,i,r,a){e instanceof g?this.entity.setPosition(e):this.entity.setPosition(e,t,s),t instanceof H?this.entity.setRotation(t):t instanceof g?this.entity.setEulerAngles(t):i!==void 0&&this.entity.setEulerAngles(i,r,a),this.syncEntityToBody()}onEnable(){this._body||this.createBody(),this.enableSimulation()}onDisable(){this.disableSimulation()}constructor(...e){super(...e),this._angularDamping=0,this._angularFactor=new g(1,1,1),this._angularVelocity=new g,this._body=null,this._friction=.5,this._group=2,this._linearDamping=0,this._linearFactor=new g(1,1,1),this._linearVelocity=new g,this._mask=65533,this._mass=1,this._restitution=0,this._rollingFriction=0,this._simulationEnabled=!1,this._type=Ao}}});var DP,_Z=m(()=>{DP=class{constructor(){this.enabled=!0}}});var Rl,Cl,f_,UT,BT,VT,gZ,Lc,OP=m(()=>{pZ();Q();We();Ut();MP();_Z();f_=class{constructor(e,t,s,i){this.entity=e,this.point=t,this.normal=s,this.hitFraction=i}},UT=class{constructor(e,t,s){arguments.length!==0?(this.a=e,this.b=t,this.impulse=s.impulse,this.localPointA=s.localPoint,this.localPointB=s.localPointOther,this.pointA=s.point,this.pointB=s.pointOther,this.normal=s.normal):(this.a=null,this.b=null,this.impulse=0,this.localPointA=new g,this.localPointB=new g,this.pointA=new g,this.pointB=new g,this.normal=new g)}},BT=class{constructor(e=new g,t=new g,s=new g,i=new g,r=new g,a=0){this.localPoint=e,this.localPointOther=t,this.point=s,this.pointOther=i,this.normal=r,this.impulse=a}},VT=class{constructor(e,t){this.other=e,this.contacts=t}},gZ=["enabled"],Lc=class extends Me{static{this.EVENT_CONTACT="contact"}constructor(e){super(e),this.maxSubSteps=10,this.fixedTimeStep=1/60,this.gravity=new g(0,-9.81,0),this._gravityFloat32=new Float32Array(3),this._dynamic=[],this._kinematic=[],this._triggers=[],this._compounds=[],this.id="rigidbody",this._stats=e.stats.frame,this.ComponentType=Na,this.DataType=DP,this.contactPointPool=null,this.contactResultPool=null,this.singleContactResultPool=null,this.schema=gZ,this.collisions={},this.frameCollisions={},this.on("beforeremove",this.onBeforeRemove,this)}onLibraryLoaded(){if(typeof Ammo<"u"){if(this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration,this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration),this.overlappingPairCache=new Ammo.btDbvtBroadphase,this.solver=new Ammo.btSequentialImpulseConstraintSolver,this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration),this.dynamicsWorld.setInternalTickCallback){let e=Ammo.addFunction(this._checkForCollisions.bind(this),"vif");this.dynamicsWorld.setInternalTickCallback(e)}Rl=new Ammo.btVector3,Cl=new Ammo.btVector3,Na.onLibraryLoaded(),this.contactPointPool=new h_(BT,1),this.contactResultPool=new h_(VT,1),this.singleContactResultPool=new h_(UT,1),this.app.systems.on("update",this.onUpdate,this)}else this.app.systems.off("update",this.onUpdate,this)}initializeComponentData(e,t,s){let i=["mass","linearDamping","angularDamping","linearFactor","angularFactor","friction","rollingFriction","restitution","type","group","mask"];for(let r of i)if(t.hasOwnProperty(r)){let a=t[r];Array.isArray(a)?e[r]=new g(a[0],a[1],a[2]):e[r]=a}super.initializeComponentData(e,t,["enabled"])}cloneComponent(e,t){let s=e.rigidbody,i={enabled:s.enabled,mass:s.mass,linearDamping:s.linearDamping,angularDamping:s.angularDamping,linearFactor:[s.linearFactor.x,s.linearFactor.y,s.linearFactor.z],angularFactor:[s.angularFactor.x,s.angularFactor.y,s.angularFactor.z],friction:s.friction,rollingFriction:s.rollingFriction,restitution:s.restitution,type:s.type,group:s.group,mask:s.mask};return this.addComponent(t,i)}onBeforeRemove(e,t){t.enabled&&(t.enabled=!1),t.body&&(this.destroyBody(t.body),t.body=null)}addBody(e,t,s){t!==void 0&&s!==void 0?this.dynamicsWorld.addRigidBody(e,t,s):this.dynamicsWorld.addRigidBody(e)}removeBody(e){this.dynamicsWorld.removeRigidBody(e)}createBody(e,t,s){let i=new Ammo.btVector3(0,0,0);e!==0&&t.calculateLocalInertia(e,i);let r=new Ammo.btDefaultMotionState(s),a=new Ammo.btRigidBodyConstructionInfo(e,r,t,i),n=new Ammo.btRigidBody(a);return Ammo.destroy(a),Ammo.destroy(i),n}destroyBody(e){let t=e.getMotionState();t&&Ammo.destroy(t),Ammo.destroy(e)}raycastFirst(e,t,s={}){if(s.filterTags||s.filterCallback)return s.sort=!0,this.raycastAll(e,t,s)[0]||null;let i=null;Rl.setValue(e.x,e.y,e.z),Cl.setValue(t.x,t.y,t.z);let r=new Ammo.ClosestRayResultCallback(Rl,Cl);if(typeof s.filterCollisionGroup=="number"&&r.set_m_collisionFilterGroup(s.filterCollisionGroup),typeof s.filterCollisionMask=="number"&&r.set_m_collisionFilterMask(s.filterCollisionMask),this.dynamicsWorld.rayTest(Rl,Cl,r),r.hasHit()){let a=r.get_m_collisionObject(),n=Ammo.castObject(a,Ammo.btRigidBody);if(n){let l=r.get_m_hitPointWorld(),h=r.get_m_hitNormalWorld();i=new f_(n.entity,new g(l.x(),l.y(),l.z()),new g(h.x(),h.y(),h.z()),r.get_m_closestHitFraction())}}return Ammo.destroy(r),i}raycastAll(e,t,s={}){let i=[];Rl.setValue(e.x,e.y,e.z),Cl.setValue(t.x,t.y,t.z);let r=new Ammo.AllHitsRayResultCallback(Rl,Cl);if(typeof s.filterCollisionGroup=="number"&&r.set_m_collisionFilterGroup(s.filterCollisionGroup),typeof s.filterCollisionMask=="number"&&r.set_m_collisionFilterMask(s.filterCollisionMask),this.dynamicsWorld.rayTest(Rl,Cl,r),r.hasHit()){let a=r.get_m_collisionObjects(),n=r.get_m_hitPointWorld(),l=r.get_m_hitNormalWorld(),h=r.get_m_hitFractions(),c=a.size();for(let f=0;f<c;f++){let d=Ammo.castObject(a.at(f),Ammo.btRigidBody);if(d&&d.entity){if(s.filterTags&&!d.entity.tags.has(...s.filterTags)||s.filterCallback&&!s.filterCallback(d.entity))continue;let u=n.at(f),p=l.at(f),_=new f_(d.entity,new g(u.x(),u.y(),u.z()),new g(p.x(),p.y(),p.z()),h.at(f));i.push(_)}}s.sort&&i.sort((f,d)=>f.hitFraction-d.hitFraction)}return Ammo.destroy(r),i}_storeCollision(e,t){let s=!1,i=e.getGuid();return this.collisions[i]=this.collisions[i]||{others:[],entity:e},this.collisions[i].others.indexOf(t)<0&&(this.collisions[i].others.push(t),s=!0),this.frameCollisions[i]=this.frameCollisions[i]||{others:[],entity:e},this.frameCollisions[i].others.push(t),s}_createContactPointFromAmmo(e){let t=e.get_m_localPointA(),s=e.get_m_localPointB(),i=e.getPositionWorldOnA(),r=e.getPositionWorldOnB(),a=e.get_m_normalWorldOnB(),n=this.contactPointPool.allocate();return n.localPoint.set(t.x(),t.y(),t.z()),n.localPointOther.set(s.x(),s.y(),s.z()),n.point.set(i.x(),i.y(),i.z()),n.pointOther.set(r.x(),r.y(),r.z()),n.normal.set(a.x(),a.y(),a.z()),n.impulse=e.getAppliedImpulse(),n}_createReverseContactPointFromAmmo(e){let t=e.get_m_localPointA(),s=e.get_m_localPointB(),i=e.getPositionWorldOnA(),r=e.getPositionWorldOnB(),a=e.get_m_normalWorldOnB(),n=this.contactPointPool.allocate();return n.localPointOther.set(t.x(),t.y(),t.z()),n.localPoint.set(s.x(),s.y(),s.z()),n.pointOther.set(i.x(),i.y(),i.z()),n.point.set(r.x(),r.y(),r.z()),n.normal.set(a.x(),a.y(),a.z()),n.impulse=e.getAppliedImpulse(),n}_createSingleContactResult(e,t,s){let i=this.singleContactResultPool.allocate();return i.a=e,i.b=t,i.localPointA=s.localPoint,i.localPointB=s.localPointOther,i.pointA=s.point,i.pointB=s.pointOther,i.normal=s.normal,i.impulse=s.impulse,i}_createContactResult(e,t){let s=this.contactResultPool.allocate();return s.other=e,s.contacts=t,s}_cleanOldCollisions(){for(let e in this.collisions)if(this.collisions.hasOwnProperty(e)){let t=this.frameCollisions[e],s=this.collisions[e],i=s.entity,r=i.collision,a=i.rigidbody,n=s.others,h=n.length;for(;h--;){let c=n[h];(!t||t.others.indexOf(c)<0)&&(n.splice(h,1),i.trigger?(r&&r.fire("triggerleave",c),c.rigidbody&&c.rigidbody.fire("triggerleave",i)):c.trigger||(a&&a.fire("collisionend",c),r&&r.fire("collisionend",c)))}n.length===0&&delete this.collisions[e]}}_hasContactEvent(e){let t=e.collision;if(t&&(t.hasEvent("collisionstart")||t.hasEvent("collisionend")||t.hasEvent("contact")))return!0;let s=e.rigidbody;return s&&(s.hasEvent("collisionstart")||s.hasEvent("collisionend")||s.hasEvent("contact"))}_checkForCollisions(e,t){let i=Ammo.wrapPointer(e,Ammo.btDynamicsWorld).getDispatcher(),r=i.getNumManifolds();this.frameCollisions={};for(let a=0;a<r;a++){let n=i.getManifoldByIndexInternal(a),l=n.getBody0(),h=n.getBody1(),c=Ammo.castObject(l,Ammo.btRigidBody),f=Ammo.castObject(h,Ammo.btRigidBody),d=c.entity,u=f.entity;if(!d||!u)continue;let p=c.getCollisionFlags(),_=f.getCollisionFlags(),S=n.getNumContacts(),T=[],x=[],A;if(S>0)if(p&4||_&4){let E=d.collision&&(d.collision.hasEvent("triggerenter")||d.collision.hasEvent("triggerleave")),v=u.collision&&(u.collision.hasEvent("triggerenter")||u.collision.hasEvent("triggerleave")),R=d.rigidbody&&(d.rigidbody.hasEvent("triggerenter")||d.rigidbody.hasEvent("triggerleave")),P=u.rigidbody&&(u.rigidbody.hasEvent("triggerenter")||u.rigidbody.hasEvent("triggerleave"));E&&(A=this._storeCollision(d,u),A&&!(_&4)&&d.collision.fire("triggerenter",u)),v&&(A=this._storeCollision(u,d),A&&!(p&4)&&u.collision.fire("triggerenter",d)),R&&(A||(A=this._storeCollision(u,d)),A&&d.rigidbody.fire("triggerenter",u)),P&&(A||(A=this._storeCollision(d,u)),A&&u.rigidbody.fire("triggerenter",d))}else{let E=this._hasContactEvent(d),v=this._hasContactEvent(u),R=this.hasEvent("contact");if(R||E||v){for(let P=0;P<S;P++){let y=n.getContactPoint(P),C=this._createContactPointFromAmmo(y);if(E||v){T.push(C);let L=this._createReverseContactPointFromAmmo(y);x.push(L)}if(R){let L=this._createSingleContactResult(d,u,C);this.fire("contact",L)}}if(E){let P=this._createContactResult(u,T);A=this._storeCollision(d,u),d.collision&&(d.collision.fire("contact",P),A&&d.collision.fire("collisionstart",P)),d.rigidbody&&(d.rigidbody.fire("contact",P),A&&d.rigidbody.fire("collisionstart",P))}if(v){let P=this._createContactResult(d,x);A=this._storeCollision(u,d),u.collision&&(u.collision.fire("contact",P),A&&u.collision.fire("collisionstart",P)),u.rigidbody&&(u.rigidbody.fire("contact",P),A&&u.rigidbody.fire("collisionstart",P))}}}}this._cleanOldCollisions(),this.contactPointPool.freeAll(),this.contactResultPool.freeAll(),this.singleContactResultPool.freeAll()}onUpdate(e){let t,s;this._gravityFloat32[0]=this.gravity.x,this._gravityFloat32[1]=this.gravity.y,this._gravityFloat32[2]=this.gravity.z;let i=this.dynamicsWorld.getGravity();(i.x()!==this._gravityFloat32[0]||i.y()!==this._gravityFloat32[1]||i.z()!==this._gravityFloat32[2])&&(i.setValue(this.gravity.x,this.gravity.y,this.gravity.z),this.dynamicsWorld.setGravity(i));let r=this._triggers;for(t=0,s=r.length;t<s;t++)r[t].updateTransform();let a=this._compounds;for(t=0,s=a.length;t<s;t++)a[t]._updateCompound();let n=this._kinematic;for(t=0,s=n.length;t<s;t++)n[t]._updateKinematic();this.dynamicsWorld.stepSimulation(e,this.maxSubSteps,this.fixedTimeStep);let l=this._dynamic;for(t=0,s=l.length;t<s;t++)l[t]._updateDynamic();this.dynamicsWorld.setInternalTickCallback||this._checkForCollisions(Ammo.getPointer(this.dynamicsWorld),e)}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this),typeof Ammo<"u"&&(Ammo.destroy(this.dynamicsWorld),Ammo.destroy(this.solver),Ammo.destroy(this.overlappingPairCache),Ammo.destroy(this.dispatcher),Ammo.destroy(this.collisionConfiguration),Ammo.destroy(Rl),Ammo.destroy(Cl),this.dynamicsWorld=null,this.solver=null,this.overlappingPairCache=null,this.dispatcher=null,this.collisionConfiguration=null,Rl=null,Cl=null,Na.onAppDestroy())}};ae._buildAccessors(Na.prototype,gZ)});var Il,NP,WM=m(()=>{Il="none",NP="blend"});var SZ,xd,YM=m(()=>{Ke();Ne();ci();WM();We();SZ=new k,xd=class extends ae{constructor(e,t){super(e,t),this._resolution=new D(640,320),this._referenceResolution=new D(640,320),this._scaleMode=Il,this.scale=1,this._scaleBlend=.5,this._priority=0,this._screenSpace=!1,this.cull=this._screenSpace,this._screenMatrix=new k,this._elements=new Set,e.app.graphicsDevice.on("resizecanvas",this._onResize,this)}syncDrawOrder(){this.system.queueDrawOrderSync(this.entity.getGuid(),this._processDrawOrderSync,this)}_recurseDrawOrderSync(e,t){if(!(e instanceof be))return t;if(e.element){let i=e.element.drawOrder;e.element.drawOrder=t++,e.element._batchGroupId>=0&&i!==e.element.drawOrder&&this.system.app.batcher?.markGroupDirty(e.element._batchGroupId)}e.particlesystem&&(e.particlesystem.drawOrder=t++);let s=e.children;for(let i=0;i<s.length;i++)t=this._recurseDrawOrderSync(s[i],t);return t}_processDrawOrderSync(){this._recurseDrawOrderSync(this.entity,1),this.fire("syncdraworder")}_calcProjectionMatrix(){let e=this._resolution.x/this.scale,t=this._resolution.y/this.scale,s=0,i=e,r=-t;this._screenMatrix.setOrtho(s,i,r,0,1,-1),this._screenSpace||(SZ.setScale(.5*e,.5*t,1),this._screenMatrix.mul2(SZ,this._screenMatrix))}_updateScale(){this.scale=this._calcScale(this._resolution,this.referenceResolution)}_calcScale(e,t){let s=Math.log2((e.x||1)/t.x),i=Math.log2((e.y||1)/t.y);return Math.pow(2,s*(1-this._scaleBlend)+i*this._scaleBlend)}_onResize(e,t){this._screenSpace&&(this._resolution.set(e,t),this.resolution=this._resolution)}_bindElement(e){this._elements.add(e)}_unbindElement(e){this._elements.delete(e)}onRemove(){this.system.app.graphicsDevice.off("resizecanvas",this._onResize,this),this.fire("remove"),this._elements.forEach(e=>e._onScreenRemove()),this._elements.clear(),this.off()}set resolution(e){this._screenSpace?this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height):this._resolution.set(e.x,e.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:resolution",this._resolution),this._elements.forEach(t=>t._onScreenResize(this._resolution))}get resolution(){return this._resolution}set referenceResolution(e){this._referenceResolution.set(e.x,e.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:referenceresolution",this._resolution),this._elements.forEach(t=>t._onScreenResize(this._resolution))}get referenceResolution(){return this._scaleMode===Il?this._resolution:this._referenceResolution}set screenSpace(e){this._screenSpace=e,this._screenSpace&&this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height),this.resolution=this._resolution,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:screenspace",this._screenSpace),this._elements.forEach(t=>t._onScreenSpaceChange())}get screenSpace(){return this._screenSpace}set scaleMode(e){e!==Il&&e!==NP&&(e=Il),!this._screenSpace&&e!==Il&&(e=Il),this._scaleMode=e,this.resolution=this._resolution,this.fire("set:scalemode",this._scaleMode)}get scaleMode(){return this._scaleMode}set scaleBlend(e){this._scaleBlend=e,this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:scaleblend",this._scaleBlend),this._elements.forEach(t=>t._onScreenResize(this._resolution))}get scaleBlend(){return this._scaleBlend}set priority(e){e>255&&(e=255),this._priority!==e&&(this._priority=e,this.syncDrawOrder())}get priority(){return this._priority}}});var FP,TZ=m(()=>{FP=class{constructor(){this.enabled=!0}}});var KM,d_,qM=m(()=>{ZC();Ne();We();Ut();YM();TZ();KM=["enabled"],d_=class extends Me{constructor(e){super(e),this.id="screen",this.ComponentType=xd,this.DataType=FP,this.schema=KM,this.windowResolution=new D,this._drawOrderSyncQueue=new ru,this.app.graphicsDevice.on("resizecanvas",this._onResize,this),this.app.systems.on("update",this._onUpdate,this),this.on("beforeremove",this.onRemoveComponent,this)}initializeComponentData(e,t,s){t.priority!==void 0&&(e.priority=t.priority),t.screenSpace!==void 0&&(e.screenSpace=t.screenSpace),e.cull=e.screenSpace,t.scaleMode!==void 0&&(e.scaleMode=t.scaleMode),t.scaleBlend!==void 0&&(e.scaleBlend=t.scaleBlend),t.resolution!==void 0&&(t.resolution instanceof D?e._resolution.copy(t.resolution):e._resolution.set(t.resolution[0],t.resolution[1]),e.resolution=e._resolution),t.referenceResolution!==void 0&&(t.referenceResolution instanceof D?e._referenceResolution.copy(t.referenceResolution):e._referenceResolution.set(t.referenceResolution[0],t.referenceResolution[1]),e.referenceResolution=e._referenceResolution),e.syncDrawOrder(),super.initializeComponentData(e,t,KM)}destroy(){super.destroy(),this.app.graphicsDevice.off("resizecanvas",this._onResize,this),this.app.systems.off("update",this._onUpdate,this)}_onUpdate(e){let t=this.store;for(let s in t)t[s].entity.screen.update&&t[s].entity.screen.update(e)}_onResize(e,t){this.windowResolution.x=e,this.windowResolution.y=t}cloneComponent(e,t){let s=e.screen;return this.addComponent(t,{enabled:s.enabled,screenSpace:s.screenSpace,scaleMode:s.scaleMode,resolution:s.resolution.clone(),referenceResolution:s.referenceResolution.clone()})}onRemoveComponent(e,t){t.onRemove()}processDrawOrderSyncQueue(){let e=this._drawOrderSyncQueue.list();for(let t=0;t<e.length;t++){let s=e[t];s.callback.call(s.scope)}this._drawOrderSyncQueue.clear()}queueDrawOrderSync(e,t,s){this._drawOrderSyncQueue.list().length||this.app.once("prerender",this.processDrawOrderSyncQueue,this),this._drawOrderSyncQueue.has(e)||this._drawOrderSyncQueue.push(e,{callback:t,scope:s})}};ae._buildAccessors(xd.prototype,KM)});var bc,EZ,yd,vZ,xZ,kT,Moe,Doe,Mc,UP=m(()=>{bt();Pe();Ve();Ne();Q();SP();Ql();Zg();bc=new D,EZ=new g,yd=new Es,vZ=new Rn,xZ=new g,kT=new g,Moe=new H,Doe={x:"y",y:"x"},Mc=class extends K{static{this.EVENT_DRAGSTART="drag:start"}static{this.EVENT_DRAGEND="drag:end"}static{this.EVENT_DRAGMOVE="drag:move"}constructor(e,t){if(super(),!e||!(e instanceof Cc))throw new Error("Element was null or not an ElementComponent");if(t&&t!=="x"&&t!=="y")throw new Error(`Unrecognized axis: ${t}`);this._element=e,this._app=e.system.app,this._axis=t||null,this._enabled=!0,this._dragScale=new g,this._dragStartMousePosition=new g,this._dragStartHandlePosition=new g,this._deltaMousePosition=new g,this._deltaHandlePosition=new g,this._isDragging=!1,this._toggleLifecycleListeners("on")}_toggleLifecycleListeners(e){this._element[e]("mousedown",this._onMouseDownOrTouchStart,this),this._element[e]("touchstart",this._onMouseDownOrTouchStart,this),this._element[e]("selectstart",this._onMouseDownOrTouchStart,this)}_toggleDragListeners(e){let t=e==="on";this._hasDragListeners&&t||(this._app.mouse&&(this._element[e]("mousemove",this._onMove,this),this._element[e]("mouseup",this._onMouseUpOrTouchEnd,this)),ue.touch&&(this._element[e]("touchmove",this._onMove,this),this._element[e]("touchend",this._onMouseUpOrTouchEnd,this),this._element[e]("touchcancel",this._onMouseUpOrTouchEnd,this)),this._element[e]("selectmove",this._onMove,this),this._element[e]("selectend",this._onMouseUpOrTouchEnd,this),this._hasDragListeners=t)}_onMouseDownOrTouchStart(e){if(this._element&&!this._isDragging&&this.enabled){this._dragCamera=e.camera,this._calculateDragScale();let t=this._screenToLocal(e);t&&(this._toggleDragListeners("on"),this._isDragging=!0,this._dragStartMousePosition.copy(t),this._dragStartHandlePosition.copy(this._element.entity.getLocalPosition()),this.fire("drag:start"))}}_onMouseUpOrTouchEnd(){this._isDragging&&(this._isDragging=!1,this._toggleDragListeners("off"),this.fire("drag:end"))}_screenToLocal(e){return e.inputSource?yd.set(e.inputSource.getOrigin(),e.inputSource.getDirection()):(this._determineInputPosition(e),this._chooseRayOriginAndDirection()),xZ.copy(this._element.entity.forward).mulScalar(-1),vZ.setFromPointNormal(this._element.entity.getPosition(),xZ),vZ.intersectsRay(yd,kT)?(Moe.copy(this._element.entity.getRotation()).invert().transformVector(kT,kT),kT.mul(this._dragScale),kT):null}_determineInputPosition(e){let t=this._app.graphicsDevice.maxPixelRatio;typeof e.x<"u"&&typeof e.y<"u"?(bc.x=e.x*t,bc.y=e.y*t):e.changedTouches?(bc.x=e.changedTouches[0].x*t,bc.y=e.changedTouches[0].y*t):console.warn("Could not determine position from input event")}_chooseRayOriginAndDirection(){this._element.screen&&this._element.screen.screen.screenSpace?(yd.origin.set(bc.x,-bc.y,0),yd.direction.copy(g.FORWARD)):(EZ.copy(this._dragCamera.screenToWorld(bc.x,bc.y,1)),yd.origin.copy(this._dragCamera.entity.getPosition()),yd.direction.copy(EZ).sub(yd.origin).normalize())}_calculateDragScale(){let e=this._element.entity.parent,t=this._element.screen&&this._element.screen.screen,s=t&&t.screenSpace,i=s?t.scale:1,r=this._dragScale;for(r.set(i,i,i);e&&(r.mul(e.getLocalScale()),e=e.parent,!(s&&e.screen)););r.x=1/r.x,r.y=1/r.y,r.z=0}_onMove(e){let{_element:t,_deltaMousePosition:s,_deltaHandlePosition:i,_axis:r}=this;if(t&&this._isDragging&&this.enabled&&t.enabled&&t.entity.enabled){let a=this._screenToLocal(e);if(a){if(s.sub2(a,this._dragStartMousePosition),i.add2(this._dragStartHandlePosition,s),r){let n=t.entity.getLocalPosition(),l=Doe[r];i[l]=n[l]}t.entity.setLocalPosition(i),this.fire("drag:move",i)}}}destroy(){this._toggleLifecycleListeners("off"),this._toggleDragListeners("off")}set enabled(e){this._enabled=e}get enabled(){return this._enabled}get isDragging(){return this._isDragging}}});var jM,BP,$M,ZM,QM,yZ=m(()=>{jM=0,BP=1,$M=2,ZM=0,QM=1});var GT,u_,JM=m(()=>{me();Ne();Q();J();Zt();UP();We();GT=new D,u_=class extends ae{static{this.EVENT_SETSCROLL="set:scroll"}constructor(e,t){super(e,t),this._viewportEntity=null,this._contentEntity=null,this._horizontalScrollbarEntity=null,this._verticalScrollbarEntity=null,this._evtElementRemove=null,this._evtViewportElementRemove=null,this._evtViewportResize=null,this._evtContentEntityElementAdd=null,this._evtContentElementRemove=null,this._evtContentResize=null,this._evtHorizontalScrollbarAdd=null,this._evtHorizontalScrollbarRemove=null,this._evtHorizontalScrollbarValue=null,this._evtVerticalScrollbarAdd=null,this._evtVerticalScrollbarRemove=null,this._evtVerticalScrollbarValue=null,this._scrollbarUpdateFlags={},this._scrollbarEntities={},this._prevContentSizes={},this._prevContentSizes[Ue]=null,this._prevContentSizes[it]=null,this._scroll=new D,this._velocity=new g,this._dragStartPosition=new g,this._disabledContentInput=!1,this._disabledContentInputEntities=[],this._toggleLifecycleListeners("on"),this._toggleElementListeners("on")}get data(){let e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){this._setValue("enabled",e)}get enabled(){return this.data.enabled}set horizontal(e){this._setValue("horizontal",e)}get horizontal(){return this.data.horizontal}set vertical(e){this._setValue("vertical",e)}get vertical(){return this.data.vertical}set scrollMode(e){this._setValue("scrollMode",e)}get scrollMode(){return this.data.scrollMode}set bounceAmount(e){this._setValue("bounceAmount",e)}get bounceAmount(){return this.data.bounceAmount}set friction(e){this._setValue("friction",e)}get friction(){return this.data.friction}set dragThreshold(e){this._setValue("dragThreshold",e)}get dragThreshold(){return this.data.dragThreshold}set useMouseWheel(e){this._setValue("useMouseWheel",e)}get useMouseWheel(){return this.data.useMouseWheel}set mouseWheelSensitivity(e){this._setValue("mouseWheelSensitivity",e)}get mouseWheelSensitivity(){return this.data.mouseWheelSensitivity}set horizontalScrollbarVisibility(e){this._setValue("horizontalScrollbarVisibility",e)}get horizontalScrollbarVisibility(){return this.data.horizontalScrollbarVisibility}set verticalScrollbarVisibility(e){this._setValue("verticalScrollbarVisibility",e)}get verticalScrollbarVisibility(){return this.data.verticalScrollbarVisibility}set viewportEntity(e){if(this._viewportEntity===e)return;let t=typeof e=="string";this._viewportEntity&&t&&this._viewportEntity.getGuid()===e||(this._viewportEntity&&this._viewportEntityUnsubscribe(),e instanceof Ae?this._viewportEntity=e:t?this._viewportEntity=this.system.app.getEntityFromIndex(e)||null:this._viewportEntity=null,this._viewportEntity&&this._viewportEntitySubscribe(),this._viewportEntity?this.data.viewportEntity=this._viewportEntity.getGuid():t&&e&&(this.data.viewportEntity=e))}get viewportEntity(){return this._viewportEntity}set contentEntity(e){if(this._contentEntity===e)return;let t=typeof e=="string";this._contentEntity&&t&&this._contentEntity.getGuid()===e||(this._contentEntity&&this._contentEntityUnsubscribe(),e instanceof Ae?this._contentEntity=e:t?this._contentEntity=this.system.app.getEntityFromIndex(e)||null:this._contentEntity=null,this._contentEntity&&this._contentEntitySubscribe(),this._contentEntity?this.data.contentEntity=this._contentEntity.getGuid():t&&e&&(this.data.contentEntity=e))}get contentEntity(){return this._contentEntity}set horizontalScrollbarEntity(e){if(this._horizontalScrollbarEntity===e)return;let t=typeof e=="string";this._horizontalScrollbarEntity&&t&&this._horizontalScrollbarEntity.getGuid()===e||(this._horizontalScrollbarEntity&&this._horizontalScrollbarEntityUnsubscribe(),e instanceof Ae?this._horizontalScrollbarEntity=e:t?this._horizontalScrollbarEntity=this.system.app.getEntityFromIndex(e)||null:this._horizontalScrollbarEntity=null,this._scrollbarEntities[Ue]=this._horizontalScrollbarEntity,this._horizontalScrollbarEntity&&this._horizontalScrollbarEntitySubscribe(),this._horizontalScrollbarEntity?this.data.horizontalScrollbarEntity=this._horizontalScrollbarEntity.getGuid():t&&e&&(this.data.horizontalScrollbarEntity=e))}get horizontalScrollbarEntity(){return this._horizontalScrollbarEntity}set verticalScrollbarEntity(e){if(this._verticalScrollbarEntity===e)return;let t=typeof e=="string";this._verticalScrollbarEntity&&t&&this._verticalScrollbarEntity.getGuid()===e||(this._verticalScrollbarEntity&&this._verticalScrollbarEntityUnsubscribe(),e instanceof Ae?this._verticalScrollbarEntity=e:t?this._verticalScrollbarEntity=this.system.app.getEntityFromIndex(e)||null:this._verticalScrollbarEntity=null,this._scrollbarEntities[it]=this._verticalScrollbarEntity,this._verticalScrollbarEntity&&this._verticalScrollbarEntitySubscribe(),this._verticalScrollbarEntity?this.data.verticalScrollbarEntity=this._verticalScrollbarEntity.getGuid():t&&e&&(this.data.verticalScrollbarEntity=e))}get verticalScrollbarEntity(){return this._verticalScrollbarEntity}set scroll(e){this._onSetScroll(e.x,e.y)}get scroll(){return this._scroll}_setValue(e,t){let s=this.data,i=s[e];s[e]=t,this.fire("set",e,i,t)}_toggleLifecycleListeners(e){this[e]("set_horizontal",this._onSetHorizontalScrollingEnabled,this),this[e]("set_vertical",this._onSetVerticalScrollingEnabled,this),this.entity[e]("element:add",this._onElementComponentAdd,this)}_toggleElementListeners(e){if(this.entity.element){if(e==="on"&&this._hasElementListeners)return;this.entity.element[e]("resize",this._syncAll,this),this.entity.element[e]("mousewheel",this._onMouseWheel,this),this._hasElementListeners=e==="on"}}_onElementComponentAdd(e){this._evtElementRemove=this.entity.element.once("beforeremove",this._onElementComponentRemove,this),this._toggleElementListeners("on")}_onElementComponentRemove(e){this._evtElementRemove?.off(),this._evtElementRemove=null,this._toggleElementListeners("off")}_viewportEntitySubscribe(){this._evtViewportEntityElementAdd=this._viewportEntity.on("element:add",this._onViewportElementGain,this),this._viewportEntity.element&&this._onViewportElementGain()}_viewportEntityUnsubscribe(){this._evtViewportEntityElementAdd?.off(),this._evtViewportEntityElementAdd=null,this._viewportEntity?.element&&this._onViewportElementLose()}_viewportEntityElementSubscribe(){let e=this._viewportEntity.element;this._evtViewportElementRemove=e.once("beforeremove",this._onViewportElementLose,this),this._evtViewportResize=e.on("resize",this._syncAll,this)}_viewportEntityElementUnsubscribe(){this._evtViewportElementRemove?.off(),this._evtViewportElementRemove=null,this._evtViewportResize?.off(),this._evtViewportResize=null}_onViewportElementGain(){this._viewportEntityElementSubscribe(),this._syncAll()}_onViewportElementLose(){this._viewportEntityElementUnsubscribe()}_contentEntitySubscribe(){this._evtContentEntityElementAdd=this._contentEntity.on("element:add",this._onContentElementGain,this),this._contentEntity.element&&this._onContentElementGain()}_contentEntityUnsubscribe(){this._evtContentEntityElementAdd?.off(),this._evtContentEntityElementAdd=null,this._contentEntity?.element&&this._onContentElementLose()}_contentEntityElementSubscribe(){let e=this._contentEntity.element;this._evtContentElementRemove=e.once("beforeremove",this._onContentElementLose,this),this._evtContentResize=e.on("resize",this._syncAll,this)}_contentEntityElementUnsubscribe(){this._evtContentElementRemove?.off(),this._evtContentElementRemove=null,this._evtContentResize?.off(),this._evtContentResize=null}_onContentElementGain(){this._contentEntityElementSubscribe(),this._destroyDragHelper(),this._contentDragHelper=new Mc(this._contentEntity.element),this._contentDragHelper.on("drag:start",this._onContentDragStart,this),this._contentDragHelper.on("drag:end",this._onContentDragEnd,this),this._contentDragHelper.on("drag:move",this._onContentDragMove,this),this._prevContentSizes[Ue]=null,this._prevContentSizes[it]=null,this._syncAll()}_onContentElementLose(){this._contentEntityElementUnsubscribe(),this._destroyDragHelper()}_onContentDragStart(){this._contentEntity&&this.enabled&&this.entity.enabled&&this._dragStartPosition.copy(this._contentEntity.getLocalPosition())}_onContentDragEnd(){this._prevContentDragPosition=null,this._enableContentInput()}_onContentDragMove(e){if(this._contentEntity&&this.enabled&&this.entity.enabled&&(this._wasDragged=!0,this._setScrollFromContentPosition(e),this._setVelocityFromContentPositionDelta(e),!this._disabledContentInput)){let t=e.x-this._dragStartPosition.x,s=e.y-this._dragStartPosition.y;(Math.abs(t)>this.dragThreshold||Math.abs(s)>this.dragThreshold)&&this._disableContentInput()}}_horizontalScrollbarEntitySubscribe(){this._evtHorizontalScrollbarAdd=this._horizontalScrollbarEntity.on("scrollbar:add",this._onHorizontalScrollbarGain,this),this._horizontalScrollbarEntity.scrollbar&&this._onHorizontalScrollbarGain()}_verticalScrollbarEntitySubscribe(){this._evtVerticalScrollbarAdd=this._verticalScrollbarEntity.on("scrollbar:add",this._onVerticalScrollbarGain,this),this._verticalScrollbarEntity.scrollbar&&this._onVerticalScrollbarGain()}_horizontalScrollbarEntityUnsubscribe(){this._evtHorizontalScrollbarAdd?.off(),this._evtHorizontalScrollbarAdd=null,this._horizontalScrollbarEntity.scrollbar&&this._onHorizontalScrollbarLose()}_verticalScrollbarEntityUnsubscribe(){this._evtVerticalScrollbarAdd?.off(),this._evtVerticalScrollbarAdd=null,this._verticalScrollbarEntity.scrollbar&&this._onVerticalScrollbarLose()}_onSetHorizontalScrollbarValue(e){!this._scrollbarUpdateFlags[Ue]&&this.enabled&&this.entity.enabled&&this._onSetScroll(e,null)}_onSetVerticalScrollbarValue(e){!this._scrollbarUpdateFlags[it]&&this.enabled&&this.entity.enabled&&this._onSetScroll(null,e)}_onHorizontalScrollbarGain(){let e=this._horizontalScrollbarEntity?.scrollbar;this._evtHorizontalScrollbarRemove=e.on("beforeremove",this._onHorizontalScrollbarLose,this),this._evtHorizontalScrollbarValue=e.on("set:value",this._onSetHorizontalScrollbarValue,this),this._syncScrollbarEnabledState(Ue),this._syncScrollbarPosition(Ue)}_onVerticalScrollbarGain(){let e=this._verticalScrollbarEntity?.scrollbar;this._evtVerticalScrollbarRemove=e.on("beforeremove",this._onVerticalScrollbarLose,this),this._evtVerticalScrollbarValue=e.on("set:value",this._onSetVerticalScrollbarValue,this),this._syncScrollbarEnabledState(it),this._syncScrollbarPosition(it)}_onHorizontalScrollbarLose(){this._evtHorizontalScrollbarRemove?.off(),this._evtHorizontalScrollbarRemove=null,this._evtHorizontalScrollbarValue?.off(),this._evtHorizontalScrollbarValue=null}_onVerticalScrollbarLose(){this._evtVerticalScrollbarRemove?.off(),this._evtVerticalScrollbarRemove=null,this._evtVerticalScrollbarValue?.off(),this._evtVerticalScrollbarValue=null}_onSetHorizontalScrollingEnabled(){this._syncScrollbarEnabledState(Ue)}_onSetVerticalScrollingEnabled(){this._syncScrollbarEnabledState(it)}_onSetScroll(e,t,s){s!==!1&&this._velocity.set(0,0,0);let i=this._updateAxis(e,"x",Ue),r=this._updateAxis(t,"y",it);(i||r)&&this.fire("set:scroll",this._scroll)}_updateAxis(e,t,s){let i=e!==null&&Math.abs(e-this._scroll[t])>1e-5;return(i||this._isDragging()||e===0)&&(this._scroll[t]=this._determineNewScrollValue(e,t,s),this._syncContentPosition(s),this._syncScrollbarPosition(s)),i}_determineNewScrollValue(e,t,s){if(!this._getScrollingEnabled(s))return this._scroll[t];switch(this.scrollMode){case 0:return w.clamp(e,0,this._getMaxScrollValue(s));case 1:return this._setVelocityFromOvershoot(e,t,s),e;case 2:return e;default:return console.warn(`Unhandled scroll mode:${this.scrollMode}`),e}}_syncAll(){this._syncContentPosition(Ue),this._syncContentPosition(it),this._syncScrollbarPosition(Ue),this._syncScrollbarPosition(it),this._syncScrollbarEnabledState(Ue),this._syncScrollbarEnabledState(it)}_syncContentPosition(e){if(!this._contentEntity)return;let t=this._getAxis(e),s=this._getSign(e),i=this._prevContentSizes[e],r=this._getContentSize(e);if(i!==null&&Math.abs(i-r)>1e-4){let l=this._getMaxOffset(e,i),h=this._getMaxOffset(e,r);h===0?this._scroll[t]=1:this._scroll[t]=w.clamp(this._scroll[t]*l/h,0,1)}let a=this._scroll[t]*this._getMaxOffset(e),n=this._contentEntity.getLocalPosition();n[t]=a*s,this._contentEntity.setLocalPosition(n),this._prevContentSizes[e]=r}_syncScrollbarPosition(e){let t=this._scrollbarEntities[e];if(!t?.scrollbar)return;let s=this._getAxis(e);this._scrollbarUpdateFlags[e]=!0,t.scrollbar.value=this._scroll[s],t.scrollbar.handleSize=this._getScrollbarHandleSize(s,e),this._scrollbarUpdateFlags[e]=!1}_syncScrollbarEnabledState(e){let t=this._scrollbarEntities[e];if(!t)return;let s=this._getScrollingEnabled(e),i=this._getScrollbarVisibility(e);switch(i){case 0:t.enabled=s;return;case 1:t.enabled=s&&this._contentIsLargerThanViewport(e);return;default:console.warn(`Unhandled scrollbar visibility:${i}`),t.enabled=s}}_contentIsLargerThanViewport(e){return this._getContentSize(e)>this._getViewportSize(e)}_contentPositionToScrollValue(e){let t=this._getMaxOffset(Ue),s=this._getMaxOffset(it);return t===0?GT.x=0:GT.x=e.x/t,s===0?GT.y=0:GT.y=e.y/-s,GT}_getMaxOffset(e,t){t=t===void 0?this._getContentSize(e):t;let s=this._getViewportSize(e);return t<s?-this._getViewportSize(e):s-t}_getMaxScrollValue(e){return this._contentIsLargerThanViewport(e)?1:0}_getScrollbarHandleSize(e,t){let s=this._getViewportSize(t),i=this._getContentSize(t);if(Math.abs(i)<.001)return 1;let r=Math.min(s/i,1),a=this._toOvershoot(this._scroll[e],t);return a===0?r:r/(1+Math.abs(a))}_getViewportSize(e){return this._getSize(e,this._viewportEntity)}_getContentSize(e){return this._getSize(e,this._contentEntity)}_getSize(e,t){return t?.element?t.element[this._getCalculatedDimension(e)]:0}_getScrollingEnabled(e){if(e===Ue)return this.horizontal;if(e===it)return this.vertical}_getScrollbarVisibility(e){if(e===Ue)return this.horizontalScrollbarVisibility;if(e===it)return this.verticalScrollbarVisibility}_getSign(e){return e===Ue?1:-1}_getAxis(e){return e===Ue?"x":"y"}_getCalculatedDimension(e){return e===Ue?"calculatedWidth":"calculatedHeight"}_destroyDragHelper(){this._contentDragHelper&&this._contentDragHelper.destroy()}onUpdate(){this._contentEntity&&(this._updateVelocity(),this._syncScrollbarEnabledState(Ue),this._syncScrollbarEnabledState(it))}_updateVelocity(){if(!this._isDragging()){if(this.scrollMode===1&&(this._hasOvershoot("x",Ue)&&this._setVelocityFromOvershoot(this.scroll.x,"x",Ue),this._hasOvershoot("y",it)&&this._setVelocityFromOvershoot(this.scroll.y,"y",it)),Math.abs(this._velocity.x)>1e-4||Math.abs(this._velocity.y)>1e-4){let e=this._contentEntity.getLocalPosition();e.x+=this._velocity.x,e.y+=this._velocity.y,this._contentEntity.setLocalPosition(e),this._setScrollFromContentPosition(e)}this._velocity.x*=1-this.friction,this._velocity.y*=1-this.friction}}_hasOvershoot(e,t){return Math.abs(this._toOvershoot(this.scroll[e],t))>.001}_toOvershoot(e,t){let s=this._getMaxScrollValue(t);return e<0?e:e>s?e-s:0}_setVelocityFromOvershoot(e,t,s){let r=this._toOvershoot(e,s)*this._getMaxOffset(s)*this._getSign(s);Math.abs(r)>0&&(this._velocity[t]=-r/(this.bounceAmount*50+1))}_setVelocityFromContentPositionDelta(e){this._prevContentDragPosition?(this._velocity.sub2(e,this._prevContentDragPosition),this._prevContentDragPosition.copy(e)):(this._velocity.set(0,0,0),this._prevContentDragPosition=e.clone())}_setScrollFromContentPosition(e){let t=this._contentPositionToScrollValue(e);this._isDragging()&&(t=this._applyScrollValueTension(t)),this._onSetScroll(t.x,t.y,!1)}_applyScrollValueTension(e){let s=this._getMaxScrollValue(Ue),i=this._toOvershoot(e.x,Ue);return i>0?e.x=s+1*Math.log10(1+i):i<0&&(e.x=-1*Math.log10(1-i)),s=this._getMaxScrollValue(it),i=this._toOvershoot(e.y,it),i>0?e.y=s+1*Math.log10(1+i):i<0&&(e.y=-1*Math.log10(1-i)),e}_isDragging(){return this._contentDragHelper&&this._contentDragHelper.isDragging}_setScrollbarComponentsEnabled(e){this._horizontalScrollbarEntity?.scrollbar&&(this._horizontalScrollbarEntity.scrollbar.enabled=e),this._verticalScrollbarEntity?.scrollbar&&(this._verticalScrollbarEntity.scrollbar.enabled=e)}_setContentDraggingEnabled(e){this._contentDragHelper&&(this._contentDragHelper.enabled=e)}_onMouseWheel(e){if(!this.useMouseWheel||!this._contentEntity?.element)return;let t=e.event,s=t.deltaX/this._contentEntity.element.calculatedWidth*this.mouseWheelSensitivity.x,i=t.deltaY/this._contentEntity.element.calculatedHeight*this.mouseWheelSensitivity.y,r=w.clamp(this._scroll.x+s,0,this._getMaxScrollValue(Ue)),a=w.clamp(this._scroll.y+i,0,this._getMaxScrollValue(it));this.scroll=new D(r,a)}_enableContentInput(){for(;this._disabledContentInputEntities.length;){let e=this._disabledContentInputEntities.pop();e.element&&(e.element.useInput=!0)}this._disabledContentInput=!1}_disableContentInput(){let e=t=>{t.element&&t.element.useInput&&(this._disabledContentInputEntities.push(t),t.element.useInput=!1);let s=t.children;for(let i=0,r=s.length;i<r;i++)e(s[i])};if(this._contentEntity){let t=this._contentEntity.children;for(let s=0,i=t.length;s<i;s++)e(t[s])}this._disabledContentInput=!0}onEnable(){this._setScrollbarComponentsEnabled(!0),this._setContentDraggingEnabled(!0),this._syncAll()}onDisable(){this._setScrollbarComponentsEnabled(!1),this._setContentDraggingEnabled(!1)}onRemove(){this._toggleLifecycleListeners("off"),this._toggleElementListeners("off"),this._destroyDragHelper()}resolveDuplicatedEntityReferenceProperties(e,t){e.viewportEntity&&(this.viewportEntity=t[e.viewportEntity.getGuid()]),e.contentEntity&&(this.contentEntity=t[e.contentEntity.getGuid()]),e.horizontalScrollbarEntity&&(this.horizontalScrollbarEntity=t[e.horizontalScrollbarEntity.getGuid()]),e.verticalScrollbarEntity&&(this.verticalScrollbarEntity=t[e.verticalScrollbarEntity.getGuid()])}}});var Ooe,VP,AZ=m(()=>{Ne();Ooe=10,VP=class{constructor(){this.enabled=!0,this.dragThreshold=Ooe,this.useMouseWheel=!0,this.mouseWheelSensitivity=new D(1,1),this.horizontalScrollbarVisibility=0,this.verticalScrollbarVisibility=0,this.viewportEntity=null,this.contentEntity=null,this.horizontalScrollbarEntity=null,this.verticalScrollbarEntity=null}}});var PZ,Noe,m_,eD=m(()=>{Ne();Ut();JM();AZ();PZ=[{name:"enabled",type:"boolean"},{name:"horizontal",type:"boolean"},{name:"vertical",type:"boolean"},{name:"scrollMode",type:"number"},{name:"bounceAmount",type:"number"},{name:"friction",type:"number"},{name:"dragThreshold",type:"number"},{name:"useMouseWheel",type:"boolean"},{name:"mouseWheelSensitivity",type:"vec2"},{name:"horizontalScrollbarVisibility",type:"number"},{name:"verticalScrollbarVisibility",type:"number"}],Noe=10,m_=class extends Me{constructor(e){super(e),this.id="scrollview",this.ComponentType=u_,this.DataType=VP,this.schema=PZ,this.on("beforeremove",this._onRemoveComponent,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(e,t,s){t.dragThreshold===void 0&&(t.dragThreshold=Noe),t.useMouseWheel===void 0&&(t.useMouseWheel=!0),t.mouseWheelSensitivity===void 0&&(t.mouseWheelSensitivity=new D(1,1)),super.initializeComponentData(e,t,PZ),e.viewportEntity=t.viewportEntity,e.contentEntity=t.contentEntity,e.horizontalScrollbarEntity=t.horizontalScrollbarEntity,e.verticalScrollbarEntity=t.verticalScrollbarEntity}onUpdate(e){let t=this.store;for(let s in t){let i=t[s].entity,r=i.scrollview;r.enabled&&i.enabled&&r.onUpdate()}}_onRemoveComponent(e,t){t.onRemove()}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}});var p_,tD=m(()=>{me();J();Zt();We();UP();p_=class extends ae{static{this.EVENT_SETVALUE="set:value"}constructor(e,t){super(e,t),this._handleEntity=null,this._evtHandleEntityElementAdd=null,this._evtHandleEntityChanges=[],this._toggleLifecycleListeners("on")}get data(){let e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){this._setValue("enabled",e)}get enabled(){return this.data.enabled}set orientation(e){this._setValue("orientation",e)}get orientation(){return this.data.orientation}set value(e){this._setValue("value",e)}get value(){return this.data.value}set handleSize(e){this._setValue("handleSize",e)}get handleSize(){return this.data.handleSize}set handleEntity(e){if(this._handleEntity===e)return;let t=typeof e=="string";this._handleEntity&&t&&this._handleEntity.getGuid()===e||(this._handleEntity&&this._handleEntityUnsubscribe(),e instanceof Ae?this._handleEntity=e:t?this._handleEntity=this.system.app.getEntityFromIndex(e)||null:this._handleEntity=null,this._handleEntity&&this._handleEntitySubscribe(),this._handleEntity?this.data.handleEntity=this._handleEntity.getGuid():t&&e&&(this.data.handleEntity=e))}get handleEntity(){return this._handleEntity}_setValue(e,t){let s=this.data,i=s[e];s[e]=t,this.fire("set",e,i,t)}_toggleLifecycleListeners(e){this[e]("set_value",this._onSetValue,this),this[e]("set_handleSize",this._onSetHandleSize,this),this[e]("set_orientation",this._onSetOrientation,this)}_handleEntitySubscribe(){this._evtHandleEntityElementAdd=this._handleEntity.on("element:add",this._onHandleElementGain,this),this._handleEntity.element&&this._onHandleElementGain()}_handleEntityUnsubscribe(){this._evtHandleEntityElementAdd?.off(),this._evtHandleEntityElementAdd=null,this._handleEntity?.element&&this._onHandleElementLose()}_handleEntityElementSubscribe(){let e=this._handleEntity.element,t=this._evtHandleEntityChanges;t.push(e.once("beforeremove",this._onHandleElementLose,this)),t.push(e.on("set:anchor",this._onSetHandleAlignment,this)),t.push(e.on("set:margin",this._onSetHandleAlignment,this)),t.push(e.on("set:pivot",this._onSetHandleAlignment,this))}_handleEntityElementUnsubscribe(){for(let e=0;e<this._evtHandleEntityChanges.length;e++)this._evtHandleEntityChanges[e].off();this._evtHandleEntityChanges.length=0}_onHandleElementGain(){this._handleEntityElementSubscribe(),this._destroyDragHelper(),this._handleDragHelper=new Mc(this._handleEntity.element,this._getAxis()),this._handleDragHelper.on("drag:move",this._onHandleDrag,this),this._updateHandlePositionAndSize()}_onHandleElementLose(){this._handleEntityElementUnsubscribe(),this._destroyDragHelper()}_onHandleDrag(e){this._handleEntity&&this.enabled&&this.entity.enabled&&(this.value=this._handlePositionToScrollValue(e[this._getAxis()]))}_onSetValue(e,t,s){Math.abs(s-t)>1e-5&&(this.data.value=w.clamp(s,0,1),this._updateHandlePositionAndSize(),this.fire("set:value",this.data.value))}_onSetHandleSize(e,t,s){Math.abs(s-t)>1e-5&&(this.data.handleSize=w.clamp(s,0,1),this._updateHandlePositionAndSize())}_onSetHandleAlignment(){this._updateHandlePositionAndSize()}_onSetOrientation(e,t,s){s!==t&&this._handleEntity?.element&&(this._handleEntity.element[this._getOppositeDimension()]=0)}_updateHandlePositionAndSize(){let e=this._handleEntity,t=e?.element;if(e){let s=e.getLocalPosition();s[this._getAxis()]=this._getHandlePosition(),e.setLocalPosition(s)}t&&(t[this._getDimension()]=this._getHandleLength())}_handlePositionToScrollValue(e){return e*this._getSign()/this._getUsableTrackLength()}_scrollValueToHandlePosition(e){return e*this._getSign()*this._getUsableTrackLength()}_getUsableTrackLength(){return Math.max(this._getTrackLength()-this._getHandleLength(),.001)}_getTrackLength(){return this.entity.element?this.orientation===Ue?this.entity.element.calculatedWidth:this.entity.element.calculatedHeight:0}_getHandleLength(){return this._getTrackLength()*this.handleSize}_getHandlePosition(){return this._scrollValueToHandlePosition(this.value)}_getSign(){return this.orientation===Ue?1:-1}_getAxis(){return this.orientation===Ue?"x":"y"}_getDimension(){return this.orientation===Ue?"width":"height"}_getOppositeDimension(){return this.orientation===Ue?"height":"width"}_destroyDragHelper(){this._handleDragHelper&&this._handleDragHelper.destroy()}_setHandleDraggingEnabled(e){this._handleDragHelper&&(this._handleDragHelper.enabled=e)}onEnable(){this._setHandleDraggingEnabled(!0)}onDisable(){this._setHandleDraggingEnabled(!1)}onRemove(){this._destroyDragHelper(),this._toggleLifecycleListeners("off")}resolveDuplicatedEntityReferenceProperties(e,t){e.handleEntity&&(this.handleEntity=t[e.handleEntity.getGuid()])}}});var kP,RZ=m(()=>{J();kP=class{constructor(){this.enabled=!0,this.orientation=Ue,this.value=0,this.handleSize=0,this.handleEntity=null}}});var CZ,__,sD=m(()=>{Ut();tD();RZ();CZ=[{name:"enabled",type:"boolean"},{name:"orientation",type:"number"},{name:"value",type:"number"},{name:"handleSize",type:"number"}],__=class extends Me{constructor(e){super(e),this.id="scrollbar",this.ComponentType=p_,this.DataType=kP,this.schema=CZ,this.on("add",this._onAddComponent,this),this.on("beforeremove",this._onRemoveComponent,this)}initializeComponentData(e,t,s){super.initializeComponentData(e,t,CZ),e.handleEntity=t.handleEntity}_onAddComponent(e){e.fire("scrollbar:add")}_onRemoveComponent(e,t){t.onRemove()}}});var Foe,Dc,iD=m(()=>{Pe();me();Q();rt();ay();iL();Foe={volume:0,pitch:0,loop:!1,startTime:0,duration:0,position:new g,maxDistance:0,refDistance:0,rollOffFactor:0,distanceModel:0,onPlay:null,onPause:null,onResume:null,onStop:null,onEnd:null},Dc=class extends K{static{this.EVENT_PLAY="play"}static{this.EVENT_PAUSE="pause"}static{this.EVENT_RESUME="resume"}static{this.EVENT_STOP="stop"}static{this.EVENT_END="end"}static{this.EVENT_LOAD="load"}constructor(e,t="Untitled",s={}){super(),this.instances=[],this._component=e,this._assets=e.system.app.assets,this._manager=e.system.manager,this.name=t,this._volume=s.volume!==void 0?w.clamp(Number(s.volume)||0,0,1):1,this._pitch=s.pitch!==void 0?Math.max(.01,Number(s.pitch)||0):1,this._loop=!!(s.loop!==void 0&&s.loop),this._duration=s.duration>0?s.duration:null,this._startTime=Math.max(0,Number(s.startTime)||0),this._overlap=!!s.overlap,this._autoPlay=!!s.autoPlay,this._firstNode=null,this._lastNode=null,this._asset=s.asset,this._asset instanceof re&&(this._asset=this._asset.id),this._onInstancePlayHandler=this._onInstancePlay.bind(this),this._onInstancePauseHandler=this._onInstancePause.bind(this),this._onInstanceResumeHandler=this._onInstanceResume.bind(this),this._onInstanceStopHandler=this._onInstanceStop.bind(this),this._onInstanceEndHandler=this._onInstanceEnd.bind(this)}play(){if(this.overlap||this.stop(),!this.isLoaded&&!this._hasAsset())return;let e=this._createInstance();if(this.instances.push(e),this.isLoaded)e.play();else{let t=function(s){let i=e._playWhenLoaded;e.sound=s,i&&e.play()};this.off("load",t),this.once("load",t),this.load()}return e}pause(){let e=!1,t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].pause()&&(e=!0);return e}resume(){let e=!1,t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].resume()&&(e=!0);return e}stop(){let e=!1,t=this.instances,s=t.length;for(;s--;)t[s].stop(),e=!0;return t.length=0,e}load(){if(!this._hasAsset())return;let e=this._assets.get(this._asset);if(!e){this._assets.off(`add:${this._asset}`,this._onAssetAdd,this),this._assets.once(`add:${this._asset}`,this._onAssetAdd,this);return}if(e.off("remove",this._onAssetRemoved,this),e.on("remove",this._onAssetRemoved,this),!e.resource){e.off("load",this._onAssetLoad,this),e.once("load",this._onAssetLoad,this),this._assets.load(e);return}this.fire("load",e.resource)}setExternalNodes(e,t){if(!e){console.error("The firstNode must have a valid AudioNode");return}if(t||(t=e),this._firstNode=e,this._lastNode=t,!this._overlap){let s=this.instances;for(let i=0,r=s.length;i<r;i++)s[i].setExternalNodes(e,t)}}clearExternalNodes(){if(this._firstNode=null,this._lastNode=null,!this._overlap){let e=this.instances;for(let t=0,s=e.length;t<s;t++)e[t].clearExternalNodes()}}getExternalNodes(){return[this._firstNode,this._lastNode]}_hasAsset(){return this._asset!=null}_createInstance(){let e=null,t=this._component,s=null;if(this._hasAsset()){let r=this._assets.get(this._asset);r&&(s=r.resource)}let i=Foe;return i.volume=this._volume*t.volume,i.pitch=this._pitch*t.pitch,i.loop=this._loop,i.startTime=this._startTime,i.duration=this._duration,i.onPlay=this._onInstancePlayHandler,i.onPause=this._onInstancePauseHandler,i.onResume=this._onInstanceResumeHandler,i.onStop=this._onInstanceStopHandler,i.onEnd=this._onInstanceEndHandler,t.positional?(i.position.copy(t.entity.getPosition()),i.maxDistance=t.maxDistance,i.refDistance=t.refDistance,i.rollOffFactor=t.rollOffFactor,i.distanceModel=t.distanceModel,e=new $a(this._manager,s,i)):e=new Ir(this._manager,s,i),this._firstNode&&e.setExternalNodes(this._firstNode,this._lastNode),e}_onInstancePlay(e){this.fire("play",e),this._component.fire("play",this,e)}_onInstancePause(e){this.fire("pause",e),this._component.fire("pause",this,e)}_onInstanceResume(e){this.fire("resume",e),this._component.fire("resume",this,e)}_onInstanceStop(e){let t=this.instances.indexOf(e);t!==-1&&this.instances.splice(t,1),this.fire("stop",e),this._component.fire("stop",this,e)}_onInstanceEnd(e){let t=this.instances.indexOf(e);t!==-1&&this.instances.splice(t,1),this.fire("end",e),this._component.fire("end",this,e)}_onAssetAdd(e){this.load()}_onAssetLoad(e){this.load()}_onAssetRemoved(e){e.off("remove",this._onAssetRemoved,this),this._assets.off(`add:${e.id}`,this._onAssetAdd,this),this.stop()}updatePosition(e){let t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].position=e}set asset(e){let t=this._asset;if(t){this._assets.off(`add:${t}`,this._onAssetAdd,this);let s=this._assets.get(t);s&&s.off("remove",this._onAssetRemoved,this)}this._asset=e,this._asset instanceof re&&(this._asset=this._asset.id),this._hasAsset()&&this._component.enabled&&this._component.entity.enabled&&this.load()}get asset(){return this._asset}set autoPlay(e){this._autoPlay=!!e}get autoPlay(){return this._autoPlay}set duration(e){if(this._duration=Math.max(0,Number(e)||0)||null,!this._overlap){let t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].duration=this._duration}}get duration(){let e=0;if(this._hasAsset()){let t=this._assets.get(this._asset);e=t?.resource?t.resource.duration:0}return this._duration!=null?this._duration%(e||1):e}get isLoaded(){if(this._hasAsset()){let e=this._assets.get(this._asset);if(e)return!!e.resource}return!1}get isPaused(){let e=this.instances,t=e.length;if(t===0)return!1;for(let s=0;s<t;s++)if(!e[s].isPaused)return!1;return!0}get isPlaying(){let e=this.instances;for(let t=0,s=e.length;t<s;t++)if(e[t].isPlaying)return!0;return!1}get isStopped(){let e=this.instances;for(let t=0,s=e.length;t<s;t++)if(!e[t].isStopped)return!1;return!0}set loop(e){this._loop=!!e;let t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].loop=this._loop}get loop(){return this._loop}set overlap(e){this._overlap=!!e}get overlap(){return this._overlap}set pitch(e){if(this._pitch=Math.max(Number(e)||0,.01),!this._overlap){let t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].pitch=this.pitch*this._component.pitch}}get pitch(){return this._pitch}set startTime(e){if(this._startTime=Math.max(0,Number(e)||0),!this._overlap){let t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].startTime=this._startTime}}get startTime(){return this._startTime}set volume(e){if(this._volume=w.clamp(Number(e)||0,0,1),!this._overlap){let t=this.instances;for(let s=0,i=t.length;s<i;s++)t[s].volume=this._volume*this._component.volume}}get volume(){return this._volume}}});var Ad,rD=m(()=>{sy();We();iD();Ad=class extends ae{static{this.EVENT_PLAY="play"}static{this.EVENT_PAUSE="pause"}static{this.EVENT_RESUME="resume"}static{this.EVENT_STOP="stop"}static{this.EVENT_END="end"}_updateSoundInstances(e,t,s){let i=this._slots;for(let r in i){let a=i[r];if(!a.overlap){let n=a.instances;for(let l=0,h=n.length;l<h;l++)n[l][e]=s?a[e]*t:t}}}set distanceModel(e){this._distanceModel=e,this._updateSoundInstances("distanceModel",e,!1)}get distanceModel(){return this._distanceModel}set maxDistance(e){this._maxDistance=e,this._updateSoundInstances("maxDistance",e,!1)}get maxDistance(){return this._maxDistance}set refDistance(e){this._refDistance=e,this._updateSoundInstances("refDistance",e,!1)}get refDistance(){return this._refDistance}set rollOffFactor(e){this._rollOffFactor=e,this._updateSoundInstances("rollOffFactor",e,!1)}get rollOffFactor(){return this._rollOffFactor}set pitch(e){this._pitch=e,this._updateSoundInstances("pitch",e,!0)}get pitch(){return this._pitch}set volume(e){this._volume=e,this._updateSoundInstances("volume",e,!0)}get volume(){return this._volume}set positional(e){this._positional=e;let t=this._slots;for(let s in t){let i=t[s];if(!i.overlap){let r=i.instances,a=r.length;for(let n=a-1;n>=0;n--){let l=r[n].isPlaying||r[n].isSuspended,h=r[n].currentTime;l&&r[n].stop();let c=i._createInstance();l&&(c.play(),c.currentTime=h),r.push(c)}}}}get positional(){return this._positional}set slots(e){let t=this._slots;if(t)for(let i in t)t[i].stop();let s={};for(let i in e)e[i]instanceof Dc?s[e[i].name]=e[i]:e[i].name&&(s[e[i].name]=new Dc(this,e[i].name,e[i]));this._slots=s,this.enabled&&this.entity.enabled&&this.onEnable()}get slots(){return this._slots}onEnable(){if(this.system._inTools)return;let e=this._slots,t=this._playingBeforeDisable;for(let s in e){let i=e[s];i.autoPlay&&i.isStopped?i.play():t[s]?i.resume():i.isLoaded||i.load()}}onDisable(){let e=this._slots,t={};for(let s in e)e[s].overlap||e[s].isPlaying&&(e[s].pause(),t[s]=!0);this._playingBeforeDisable=t}onRemove(){this.off()}addSlot(e,t){let s=this._slots;if(s[e])return null;let i=new Dc(this,e,t);return s[e]=i,i.autoPlay&&this.enabled&&this.entity.enabled&&i.play(),i}removeSlot(e){let t=this._slots;t[e]&&(t[e].stop(),delete t[e])}slot(e){return this._slots[e]}_getSlotProperty(e,t){if(!this.enabled||!this.entity.enabled)return;let s=this._slots[e];if(s)return s[t]}isPlaying(e){return this._getSlotProperty(e,"isPlaying")||!1}isLoaded(e){return this._getSlotProperty(e,"isLoaded")||!1}isPaused(e){return this._getSlotProperty(e,"isPaused")||!1}isStopped(e){return this._getSlotProperty(e,"isStopped")||!1}play(e){if(!this.enabled||!this.entity.enabled)return null;let t=this._slots[e];return t?t.play():null}pause(e){let t=this._slots;if(e){let s=t[e];if(!s)return;s.pause()}else for(let s in t)t[s].pause()}resume(e){let t=this._slots;if(e){let s=t[e];if(!s)return;s.isPaused&&s.resume()}else for(let s in t)t[s].resume()}stop(e){let t=this._slots;if(e){let s=t[e];if(!s)return;s.stop()}else for(let s in t)t[s].stop()}constructor(...e){super(...e),this._volume=1,this._pitch=1,this._positional=!0,this._refDistance=1,this._maxDistance=1e4,this._rollOffFactor=1,this._distanceModel=vf,this._slots={},this._playingBeforeDisable={}}}});var GP,IZ=m(()=>{GP=class{constructor(){this.enabled=!0}}});var wZ,g_,aD=m(()=>{PS();We();Ut();rD();IZ();wZ=["enabled"],g_=class extends Me{constructor(e){super(e),this.id="sound",this.ComponentType=Ad,this.DataType=GP,this.schema=wZ,this.manager=e.soundManager,this.app.systems.on("update",this.onUpdate,this),this.on("beforeremove",this.onBeforeRemove,this)}set volume(e){this.manager.volume=e}get volume(){return this.manager.volume}get context(){return Zo()?this.manager.context:null}initializeComponentData(e,t,s){s=["volume","pitch","positional","refDistance","maxDistance","rollOffFactor","distanceModel","slots"];for(let i=0;i<s.length;i++)t.hasOwnProperty(s[i])&&(e[s[i]]=t[s[i]]);super.initializeComponentData(e,t,["enabled"])}cloneComponent(e,t){let s=e.sound,i=s.slots,r={};for(let n in i){let l=i[n];r[n]={name:l.name,volume:l.volume,pitch:l.pitch,loop:l.loop,duration:l.duration,startTime:l.startTime,overlap:l.overlap,autoPlay:l.autoPlay,asset:l.asset}}let a={distanceModel:s.distanceModel,enabled:s.enabled,maxDistance:s.maxDistance,pitch:s.pitch,positional:s.positional,refDistance:s.refDistance,rollOffFactor:s.rollOffFactor,slots:r,volume:s.volume};return this.addComponent(t,a)}onUpdate(e){let t=this.store;for(let s in t)if(t.hasOwnProperty(s)){let r=t[s].entity;if(r.enabled){let a=r.sound;if(a.enabled&&a.positional){let n=r.getPosition(),l=a.slots;for(let h in l)l[h].updatePosition(n)}}}}onBeforeRemove(e,t){let s=t.slots;for(let i in s)s[i].overlap||s[i].stop();t.onRemove()}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}};ae._buildAccessors(Ad.prototype,wZ)});var zT,HT,nD=m(()=>{zT="simple",HT="animated"});var Oc,oD=m(()=>{Pe();me();rt();J();Oc=class extends K{static{this.EVENT_PLAY="play"}static{this.EVENT_PAUSE="pause"}static{this.EVENT_RESUME="resume"}static{this.EVENT_STOP="stop"}static{this.EVENT_END="end"}static{this.EVENT_LOOP="loop"}constructor(e,t){super(),this._evtSetMeshes=null,this._component=e,this._frame=0,this._sprite=null,this._spriteAsset=null,this.spriteAsset=t.spriteAsset,this.name=t.name,this.fps=t.fps||0,this.loop=t.loop||!1,this._playing=!1,this._paused=!1,this._time=0}get duration(){if(this._sprite){let e=this.fps||Number.MIN_VALUE;return this._sprite.frameKeys.length/Math.abs(e)}return 0}set frame(e){this._setFrame(e);let t=this.fps||Number.MIN_VALUE;this._setTime(this._frame/t)}get frame(){return this._frame}get isPaused(){return this._paused}get isPlaying(){return this._playing}set sprite(e){if(this._sprite&&(this._evtSetMeshes?.off(),this._evtSetMeshes=null,this._sprite.off("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.off("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.off("set:texture",this._onSpriteMeshesChange,this)),this._sprite=e,this._sprite&&(this._evtSetMeshes=this._sprite.on("set:meshes",this._onSpriteMeshesChange,this),this._sprite.on("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.on("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.on("set:texture",this._onSpriteMeshesChange,this)),this._component.currentClip===this){let t;!e||!e.atlas?(t=this._component._meshInstance,t&&(t.deleteParameter("texture_emissiveMap"),t.deleteParameter("texture_opacityMap")),this._component._hideModel()):(e.atlas.texture&&(t=this._component._meshInstance,t&&(t.setParameter("texture_emissiveMap",e.atlas.texture),t.setParameter("texture_opacityMap",e.atlas.texture)),this._component.enabled&&this._component.entity.enabled&&this._component._showModel()),this.time&&this.fps?this.time=this.time:this.frame=this.frame)}}get sprite(){return this._sprite}set spriteAsset(e){let t=this._component.system.app.assets,s=e;if(e instanceof re&&(s=e.id),this._spriteAsset!==s){if(this._spriteAsset){let i=t.get(this._spriteAsset);i&&this._unbindSpriteAsset(i)}if(this._spriteAsset=s,this._spriteAsset){let i=t.get(this._spriteAsset);i?this._bindSpriteAsset(i):(this.sprite=null,t.on(`add:${this._spriteAsset}`,this._onSpriteAssetAdded,this))}else this.sprite=null}}get spriteAsset(){return this._spriteAsset}set time(e){this._setTime(e),this._sprite?this.frame=Math.min(this._sprite.frameKeys.length-1,Math.floor(this._time*Math.abs(this.fps))):this.frame=0}get time(){return this._time}_onSpriteAssetAdded(e){this._component.system.app.assets.off(`add:${e.id}`,this._onSpriteAssetAdded,this),this._spriteAsset===e.id&&this._bindSpriteAsset(e)}_bindSpriteAsset(e){e.on("load",this._onSpriteAssetLoad,this),e.on("remove",this._onSpriteAssetRemove,this),e.resource?this._onSpriteAssetLoad(e):this._component.system.app.assets.load(e)}_unbindSpriteAsset(e){e&&(e.off("load",this._onSpriteAssetLoad,this),e.off("remove",this._onSpriteAssetRemove,this),e.resource&&!e.resource.atlas&&this._component.system.app.assets.off(`load:${e.data.textureAtlasAsset}`,this._onTextureAtlasLoad,this))}_onSpriteAssetLoad(e){if(!e.resource)this.sprite=null;else if(e.resource.atlas)this.sprite=e.resource;else{let t=e.data.textureAtlasAsset,s=this._component.system.app.assets;s.off(`load:${t}`,this._onTextureAtlasLoad,this),s.once(`load:${t}`,this._onTextureAtlasLoad,this)}}_onTextureAtlasLoad(e){let t=this._spriteAsset;t instanceof re?this._onSpriteAssetLoad(t):this._onSpriteAssetLoad(this._component.system.app.assets.get(t))}_onSpriteAssetRemove(e){this.sprite=null}_onSpriteMeshesChange(){this._component.currentClip===this&&this._component._showFrame(this.frame)}_onSpritePpuChanged(){this._component.currentClip===this&&this.sprite.renderMode!==ni&&this._component._showFrame(this.frame)}_update(e){if(this.fps===0||!this._playing||this._paused||!this._sprite)return;let t=this.fps<0?-1:1,s=this._time+e*this._component.speed*t,i=this.duration,r=s>i||s<0;this._setTime(s);let a=this.frame;this._sprite?a=Math.floor(this._sprite.frameKeys.length*this._time/i):a=0,a!==this._frame&&this._setFrame(a),r&&(this.loop?(this.fire("loop"),this._component.fire("loop",this)):(this._playing=!1,this._paused=!1,this.fire("end"),this._component.fire("end",this)))}_setTime(e){this._time=e;let t=this.duration;this._time<0?this.loop?this._time=this._time%t+t:this._time=0:this._time>t&&(this.loop?this._time%=t:this._time=t)}_setFrame(e){this._sprite?this._frame=w.clamp(e,0,this._sprite.frameKeys.length-1):this._frame=e,this._component.currentClip===this&&this._component._showFrame(this._frame)}_destroy(){if(this._spriteAsset){let e=this._component.system.app.assets;this._unbindSpriteAsset(e.get(this._spriteAsset))}this._sprite&&(this.sprite=null),this._spriteAsset&&(this.spriteAsset=null)}play(){this._playing||(this._playing=!0,this._paused=!1,this.frame=0,this.fire("play"),this._component.fire("play",this))}pause(){!this._playing||this._paused||(this._paused=!0,this.fire("pause"),this._component.fire("pause",this))}resume(){this._paused&&(this._paused=!1,this.fire("resume"),this._component.fire("resume",this))}stop(){this._playing&&(this._playing=!1,this._paused=!1,this._time=0,this.frame=0,this.fire("stop"),this._component.fire("stop",this))}}});var LZ,bZ,MZ,DZ,Uoe,Boe,Voe,Pd,lD=m(()=>{me();De();Ne();Ze();J();Xf();Zt();_s();ll();We();nD();oD();LZ="texture_emissiveMap",bZ="texture_opacityMap",MZ="material_emissive",DZ="material_opacity",Uoe="innerOffset",Boe="outerScale",Voe="atlasRect",Pd=class extends ae{static{this.EVENT_PLAY="play"}static{this.EVENT_PAUSE="pause"}static{this.EVENT_RESUME="resume"}static{this.EVENT_STOP="stop"}static{this.EVENT_END="end"}static{this.EVENT_LOOP="loop"}constructor(e,t){super(e,t),this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._type=zT,this._material=e.defaultMaterial,this._color=new N(1,1,1,1),this._colorUniform=new Float32Array(3),this._speed=1,this._flipX=!1,this._flipY=!1,this._width=1,this._height=1,this._drawOrder=0,this._layers=[ms],this._outerScale=new D(1,1),this._outerScaleUniform=new Float32Array(2),this._innerOffset=new W,this._innerOffsetUniform=new Float32Array(4),this._atlasRect=new W,this._atlasRectUniform=new Float32Array(4),this._batchGroupId=-1,this._batchGroup=null,this._node=new Ae,this._model=new Ys,this._model.graph=this._node,this._meshInstance=null,t.addChild(this._model.graph),this._model._entity=t,this._updateAabbFunc=this._updateAabb.bind(this),this._addedModel=!1,this._autoPlayClip=null,this._clips={},this._defaultClip=new Oc(this,{name:this.entity.name,fps:0,loop:!1,spriteAsset:null}),this._currentClip=this._defaultClip}set type(e){this._type!==e&&(this._type=e,this._type===zT?(this.stop(),this._currentClip=this._defaultClip,this.enabled&&this.entity.enabled&&(this._currentClip.frame=this.frame,this._currentClip.sprite?this._showModel():this._hideModel())):this._type===HT&&(this.stop(),this._autoPlayClip&&this._tryAutoPlay(),this._currentClip&&this._currentClip.isPlaying&&this.enabled&&this.entity.enabled?this._showModel():this._hideModel()))}get type(){return this._type}set frame(e){this._currentClip.frame=e}get frame(){return this._currentClip.frame}set spriteAsset(e){this._defaultClip.spriteAsset=e}get spriteAsset(){return this._defaultClip._spriteAsset}set sprite(e){this._currentClip.sprite=e}get sprite(){return this._currentClip.sprite}set material(e){this._material=e,this._meshInstance&&(this._meshInstance.material=e)}get material(){return this._material}set color(e){this._color.r=e.r,this._color.g=e.g,this._color.b=e.b,this._meshInstance&&(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter(MZ,this._colorUniform))}get color(){return this._color}set opacity(e){this._color.a=e,this._meshInstance&&this._meshInstance.setParameter(DZ,e)}get opacity(){return this._color.a}set clips(e){if(!e){for(let t in this._clips)this.removeClip(t);return}for(let t in this._clips){let s=!1;for(let i in e)if(e[i].name===t){s=!0,this._clips[t].fps=e[i].fps,this._clips[t].loop=e[i].loop,e[i].hasOwnProperty("sprite")?this._clips[t].sprite=e[i].sprite:e[i].hasOwnProperty("spriteAsset")&&(this._clips[t].spriteAsset=e[i].spriteAsset);break}s||this.removeClip(t)}for(let t in e)this._clips[e[t].name]||this.addClip(e[t]);this._autoPlayClip&&this._tryAutoPlay(),(!this._currentClip||!this._currentClip.sprite)&&this._hideModel()}get clips(){return this._clips}get currentClip(){return this._currentClip}set speed(e){this._speed=e}get speed(){return this._speed}set flipX(e){this._flipX!==e&&(this._flipX=e,this._updateTransform())}get flipX(){return this._flipX}set flipY(e){this._flipY!==e&&(this._flipY=e,this._updateTransform())}get flipY(){return this._flipY}set width(e){e!==this._width&&(this._width=e,this._outerScale.x=this._width,this.sprite&&(this.sprite.renderMode===vt||this.sprite.renderMode===Et)&&this._updateTransform())}get width(){return this._width}set height(e){e!==this._height&&(this._height=e,this._outerScale.y=this.height,this.sprite&&(this.sprite.renderMode===vt||this.sprite.renderMode===Et)&&this._updateTransform())}get height(){return this._height}set batchGroupId(e){if(this._batchGroupId===e)return;let t=this._batchGroupId;this._batchGroupId=e,this.entity.enabled&&t>=0&&this.system.app.batcher?.remove(wt.SPRITE,t,this.entity),this.entity.enabled&&e>=0?this.system.app.batcher?.insert(wt.SPRITE,e,this.entity):t>=0&&this._currentClip&&this._currentClip.sprite&&this.enabled&&this.entity.enabled&&this._showModel()}get batchGroupId(){return this._batchGroupId}set autoPlayClip(e){this._autoPlayClip=e instanceof Oc?e.name:e,this._tryAutoPlay()}get autoPlayClip(){return this._autoPlayClip}set drawOrder(e){this._drawOrder=e,this._meshInstance&&(this._meshInstance.drawOrder=e)}get drawOrder(){return this._drawOrder}set layers(e){this._addedModel&&this._hideModel(),this._layers=e,this._meshInstance&&this.enabled&&this.entity.enabled&&this._showModel()}get layers(){return this._layers}get aabb(){return this._meshInstance?this._meshInstance.aabb:null}onEnable(){let e=this.system.app,t=e.scene,s=t.layers;this._evtLayersChanged=t.on("set:layers",this._onLayersChanged,this),s&&(this._evtLayerAdded=s.on("add",this._onLayerAdded,this),this._evtLayerRemoved=s.on("remove",this._onLayerRemoved,this)),this._showModel(),this._autoPlayClip&&this._tryAutoPlay(),this._batchGroupId>=0&&e.batcher?.insert(wt.SPRITE,this._batchGroupId,this.entity)}onDisable(){let e=this.system.app,s=e.scene.layers;this._evtLayersChanged?.off(),this._evtLayersChanged=null,s&&(this._evtLayerAdded?.off(),this._evtLayerAdded=null,this._evtLayerRemoved?.off(),this._evtLayerRemoved=null),this.stop(),this._hideModel(),this._batchGroupId>=0&&e.batcher?.remove(wt.SPRITE,this._batchGroupId,this.entity)}onDestroy(){this._currentClip=null,this._defaultClip&&(this._defaultClip._destroy(),this._defaultClip=null);for(let e in this._clips)this._clips[e]._destroy();this._clips=null,this._hideModel(),this._model=null,this._node?.remove(),this._node=null,this._meshInstance&&(this._meshInstance.material=null,this._meshInstance.mesh=null,this._meshInstance=null)}_showModel(){if(this._addedModel||!this._meshInstance)return;let e=[this._meshInstance];for(let t=0,s=this._layers.length;t<s;t++){let i=this.system.app.scene.layers.getLayerById(this._layers[t]);i&&i.addMeshInstances(e)}this._addedModel=!0}_hideModel(){if(!this._addedModel||!this._meshInstance)return;let e=[this._meshInstance];for(let t=0,s=this._layers.length;t<s;t++){let i=this.system.app.scene.layers.getLayerById(this._layers[t]);i&&i.removeMeshInstances(e)}this._addedModel=!1}_showFrame(e){if(!this.sprite)return;let t=this.sprite.meshes[e];if(!t){this._meshInstance&&(this._meshInstance.mesh=null,this._meshInstance.visible=!1);return}let s;if(this.sprite.renderMode===Et?s=this.system.default9SlicedMaterialSlicedMode:this.sprite.renderMode===vt?s=this.system.default9SlicedMaterialTiledMode:s=this.system.defaultMaterial,this._meshInstance||(this._meshInstance=new Oe(t,this._material,this._node),this._meshInstance.castShadow=!1,this._meshInstance.receiveShadow=!1,this._meshInstance.drawOrder=this._drawOrder,this._model.meshInstances.push(this._meshInstance),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter(MZ,this._colorUniform),this._meshInstance.setParameter(DZ,this._color.a),this.enabled&&this.entity.enabled&&this._showModel()),this._meshInstance.material!==s&&(this._meshInstance.material=s),this._meshInstance.mesh!==t&&(this._meshInstance.mesh=t,this._meshInstance.visible=!0,this._meshInstance._aabbVer=-1),this.sprite.atlas&&this.sprite.atlas.texture?(this._meshInstance.setParameter(LZ,this.sprite.atlas.texture),this._meshInstance.setParameter(bZ,this.sprite.atlas.texture)):(this._meshInstance.deleteParameter(LZ),this._meshInstance.deleteParameter(bZ)),this.sprite.atlas&&(this.sprite.renderMode===Et||this.sprite.renderMode===vt)){this._meshInstance._updateAabbFunc=this._updateAabbFunc;let i=this.sprite.atlas.frames[this.sprite.frameKeys[e]];if(i){let r=2/i.rect.z,a=2/i.rect.w;this._innerOffset.set(i.border.x*r,i.border.y*a,i.border.z*r,i.border.w*a);let n=this.sprite.atlas.texture;this._atlasRect.set(i.rect.x/n.width,i.rect.y/n.height,i.rect.z/n.width,i.rect.w/n.height)}else this._innerOffset.set(0,0,0,0);this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._meshInstance.setParameter(Uoe,this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._meshInstance.setParameter(Voe,this._atlasRectUniform)}else this._meshInstance._updateAabbFunc=null;this._updateTransform()}_updateTransform(){let e=this.flipX?-1:1,t=this.flipY?-1:1,s=0,i=0;if(this.sprite&&(this.sprite.renderMode===Et||this.sprite.renderMode===vt)){let r=1,a=1;if(this.sprite.atlas){let h=this.sprite.atlas.frames[this.sprite.frameKeys[this.frame]];h&&(r=h.rect.z,a=h.rect.w,s=(.5-h.pivot.x)*this._width,i=(.5-h.pivot.y)*this._height)}let n=r/this.sprite.pixelsPerUnit,l=a/this.sprite.pixelsPerUnit;this._outerScale.set(Math.max(this._width,this._innerOffset.x*n),Math.max(this._height,this._innerOffset.y*l)),e*=n,t*=l,this._outerScale.x/=n,this._outerScale.y/=l,e*=w.clamp(this._width/(this._innerOffset.x*n),1e-4,1),t*=w.clamp(this._height/(this._innerOffset.y*l),1e-4,1),this._meshInstance&&(this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._meshInstance.setParameter(Boe,this._outerScaleUniform))}this._node.setLocalScale(e,t,1),this._node.setLocalPosition(s,i,0)}_updateAabb(e){return e.center.set(0,0,0),e.halfExtents.set(this._outerScale.x*.5,this._outerScale.y*.5,.001),e.setFromTransformedAabb(e,this._node.getWorldTransform()),e}_tryAutoPlay(){if(!this._autoPlayClip||this.type!==HT)return;let e=this._clips[this._autoPlayClip];e&&!e.isPlaying&&(!this._currentClip||!this._currentClip.isPlaying)&&this.enabled&&this.entity.enabled&&this.play(e.name)}_onLayersChanged(e,t){e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this),this.enabled&&this.entity.enabled&&this._showModel()}_onLayerAdded(e){this.layers.indexOf(e.id)<0||this._addedModel&&this.enabled&&this.entity.enabled&&this._meshInstance&&e.addMeshInstances([this._meshInstance])}_onLayerRemoved(e){!this._meshInstance||this.layers.indexOf(e.id)<0||e.removeMeshInstances([this._meshInstance])}removeModelFromLayers(){for(let e=0;e<this.layers.length;e++){let t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&t.removeMeshInstances([this._meshInstance])}}addClip(e){let t=new Oc(this,{name:e.name,fps:e.fps,loop:e.loop,spriteAsset:e.spriteAsset});return this._clips[e.name]=t,t.name&&t.name===this._autoPlayClip&&this._tryAutoPlay(),t}removeClip(e){delete this._clips[e]}clip(e){return this._clips[e]}play(e){let t=this._clips[e],s=this._currentClip;return s&&s!==t&&(s._playing=!1),this._currentClip=t,this._currentClip&&(this._currentClip=t,this._currentClip.play()),t}pause(){this._currentClip!==this._defaultClip&&this._currentClip.isPlaying&&this._currentClip.pause()}resume(){this._currentClip!==this._defaultClip&&this._currentClip.isPaused&&this._currentClip.resume()}stop(){this._currentClip!==this._defaultClip&&this._currentClip.stop()}}});var zP,OZ=m(()=>{zP=class{constructor(){this.enabled=!0}}});var NZ,S_,hD=m(()=>{De();Fe();J();ln();We();Ut();lD();OZ();NZ=["enabled"],S_=class extends Me{constructor(e){super(e),this.id="sprite",this.ComponentType=Pd,this.DataType=zP,this.schema=NZ,this._defaultTexture=null,this._defaultMaterial=null,this._default9SlicedMaterialSlicedMode=null,this._default9SlicedMaterialTiledMode=null,this.app.systems.on("update",this.onUpdate,this),this.on("beforeremove",this.onBeforeRemove,this)}set defaultMaterial(e){this._defaultMaterial=e}get defaultMaterial(){if(!this._defaultMaterial){let e=new q(this.app.graphicsDevice,{width:1,height:1,format:20,name:"sprite"}),t=new Uint8Array(e.lock());t[0]=t[1]=t[2]=t[3]=255,e.unlock();let s=new ct;s.diffuse.set(0,0,0),s.emissive.set(1,1,1),s.emissiveMap=e,s.opacityMap=e,s.opacityMapChannel="a",s.useLighting=!1,s.useTonemap=!1,s.useFog=!1,s.useSkybox=!1,s.blendType=er,s.depthWrite=!1,s.pixelSnap=!1,s.cull=0,s.update(),this._defaultTexture=e,this._defaultMaterial=s}return this._defaultMaterial}set default9SlicedMaterialSlicedMode(e){this._default9SlicedMaterialSlicedMode=e}get default9SlicedMaterialSlicedMode(){if(!this._default9SlicedMaterialSlicedMode){let e=this.defaultMaterial.clone();e.nineSlicedMode=Et,e.update(),this._default9SlicedMaterialSlicedMode=e}return this._default9SlicedMaterialSlicedMode}set default9SlicedMaterialTiledMode(e){this._default9SlicedMaterialTiledMode=e}get default9SlicedMaterialTiledMode(){if(!this._default9SlicedMaterialTiledMode){let e=this.defaultMaterial.clone();e.nineSlicedMode=vt,e.update(),this._default9SlicedMaterialTiledMode=e}return this._default9SlicedMaterialTiledMode}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this),this._defaultTexture&&(this._defaultTexture.destroy(),this._defaultTexture=null)}initializeComponentData(e,t,s){if(t.enabled!==void 0&&(e.enabled=t.enabled),e.type=t.type,t.layers&&Array.isArray(t.layers)&&(e.layers=t.layers.slice(0)),t.drawOrder!==void 0&&(e.drawOrder=t.drawOrder),t.color!==void 0&&(t.color instanceof N?e.color.set(t.color.r,t.color.g,t.color.b,t.opacity??1):e.color.set(t.color[0],t.color[1],t.color[2],t.opacity??1),e.color=e.color),t.opacity!==void 0&&(e.opacity=t.opacity),t.flipX!==void 0&&(e.flipX=t.flipX),t.flipY!==void 0&&(e.flipY=t.flipY),t.width!==void 0&&(e.width=t.width),t.height!==void 0&&(e.height=t.height),t.spriteAsset!==void 0&&(e.spriteAsset=t.spriteAsset),t.sprite&&(e.sprite=t.sprite),t.frame!==void 0&&(e.frame=t.frame),t.clips)for(let i in t.clips)e.addClip(t.clips[i]);t.speed!==void 0&&(e.speed=t.speed),t.autoPlayClip&&(e.autoPlayClip=t.autoPlayClip),e.batchGroupId=t.batchGroupId===void 0||t.batchGroupId===null?-1:t.batchGroupId,super.initializeComponentData(e,t,s)}cloneComponent(e,t){let s=e.sprite;return this.addComponent(t,{enabled:s.enabled,type:s.type,spriteAsset:s.spriteAsset,sprite:s.sprite,width:s.width,height:s.height,frame:s.frame,color:s.color.clone(),opacity:s.opacity,flipX:s.flipX,flipY:s.flipY,speed:s.speed,clips:s.clips,autoPlayClip:s.autoPlayClip,batchGroupId:s.batchGroupId,drawOrder:s.drawOrder,layers:s.layers.slice(0)})}onUpdate(e){let t=this.store;for(let s in t)if(t.hasOwnProperty(s)){let i=t[s];if(i.data.enabled&&i.entity.enabled){let r=i.entity.sprite;r._currentClip&&r._currentClip._update(e)}}}onBeforeRemove(e,t){t.onDestroy()}};ae._buildAccessors(Pd.prototype,NZ)});var Rd,cD=m(()=>{Q();We();Rd=class extends ae{static{this.EVENT_ENABLE="enable"}static{this.EVENT_DISABLE="disable"}static{this.EVENT_STATE="state"}static{this.EVENT_REMOVE="remove"}constructor(e,t){super(e,t),this._oldState=!0,this._size=new g,this.on("set_enabled",this._onSetEnabled,this)}set size(e){e instanceof g?this._size.copy(e):e instanceof Array&&e.length>=3&&this.size.set(e[0],e[1],e[2])}get size(){return this._size}onEnable(){this._checkState()}onDisable(){this._checkState()}_onSetEnabled(e,t,s){this._checkState()}_checkState(){let e=this.enabled&&this.entity.enabled;e!==this._oldState&&(this._oldState=e,this.fire("enable"),this.fire("state",this.enabled))}_onBeforeRemove(){this.fire("remove")}}});var HP,FZ=m(()=>{HP=class{constructor(){this.enabled=!0}}});var UZ,T_,fD=m(()=>{Q();We();Ut();cD();FZ();UZ=["enabled"],T_=class extends Me{constructor(e){super(e),this.id="zone",this.ComponentType=Rd,this.DataType=HP,this.schema=UZ,this.on("beforeremove",this._onBeforeRemove,this)}initializeComponentData(e,t,s){e.enabled=t.hasOwnProperty("enabled")?!!t.enabled:!0,t.size&&(t.size instanceof g?e.size.copy(t.size):t.size instanceof Array&&t.size.length>=3&&e.size.set(t.size[0],t.size[1],t.size[2]))}cloneComponent(e,t){let s={enabled:e.zone.enabled,size:e.zone.size};return this.addComponent(t,s)}_onBeforeRemove(e,t){t._onBeforeRemove()}};ae._buildAccessors(Rd.prototype,UZ)});var dD,E_,uD=m(()=>{Rt();Fe();J();dD=class{constructor(e,t){this.effect=e,this.inputTarget=t,this.outputTarget=null,this.name=e.constructor.name}},E_=class{constructor(e,t){this.app=e,this.camera=t,this.destinationRenderTarget=null,this.effects=[],this.enabled=!1,this.depthTarget=null,t.on("set:rect",this.onCameraRectChanged,this)}_allocateColorBuffer(e,t){let s=this.camera.rect,i=this.destinationRenderTarget,r=this.app.graphicsDevice,a=Math.floor(s.z*(i?.width??r.width)),n=Math.floor(s.w*(i?.height??r.height));return new q(r,{name:t,format:e,width:a,height:n,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1})}_createOffscreenTarget(e,t){let s=this.app.graphicsDevice,r=(this.destinationRenderTarget??s.backBuffer).isColorBufferSrgb(0),a=(t&&s.getRenderableHdrFormat([12,14],!0))??(r?20:7),n=`${this.camera.entity.name}-posteffect-${this.effects.length}`,l=this._allocateColorBuffer(a,n);return new xe({colorBuffer:l,depth:e,stencil:e&&this.app.graphicsDevice.supportsStencil,samples:e?s.samples:1})}_resizeOffscreenTarget(e){let t=e.colorBuffer.format,s=e.colorBuffer.name;e.destroyFrameBuffers(),e.destroyTextureBuffers(),e._colorBuffer=this._allocateColorBuffer(t,s),e._colorBuffers=[e._colorBuffer]}_destroyOffscreenTarget(e){e.destroyTextureBuffers(),e.destroy()}addEffect(e){let t=this.effects,s=t.length===0,i=this._createOffscreenTarget(s,e.hdr),r=new dD(e,i);t.push(r),this._sourceTarget=r.inputTarget,t.length>1&&(t[t.length-2].outputTarget=r.inputTarget),this._newPostEffect=e,e.needsDepthBuffer&&this._requestDepthMap(),this.enable(),this._newPostEffect=void 0}removeEffect(e){let t=-1;for(let s=0,i=this.effects.length;s<i;s++)if(this.effects[s].effect===e){t=s;break}t>=0&&(t>0?this.effects[t-1].outputTarget=t+1<this.effects.length?this.effects[t+1].inputTarget:null:this.effects.length>1&&(this.effects[1].inputTarget._depth||(this._destroyOffscreenTarget(this.effects[1].inputTarget),this.effects[1].inputTarget=this._createOffscreenTarget(!0,this.effects[1].hdr),this._sourceTarget=this.effects[1].inputTarget),this.camera.renderTarget=this.effects[1].inputTarget),this._destroyOffscreenTarget(this.effects[t].inputTarget),this.effects.splice(t,1)),this.enabled&&e.needsDepthBuffer&&this._releaseDepthMap(),this.effects.length===0&&this.disable()}_requestDepthMaps(){for(let e=0,t=this.effects.length;e<t;e++){let s=this.effects[e].effect;this._newPostEffect!==s&&s.needsDepthBuffer&&this._requestDepthMap()}}_releaseDepthMaps(){for(let e=0,t=this.effects.length;e<t;e++)this.effects[e].effect.needsDepthBuffer&&this._releaseDepthMap()}_requestDepthMap(){let e=this.app.scene.layers.getLayerById(Xt);e&&(e.incrementCounter(),this.camera.requestSceneDepthMap(!0))}_releaseDepthMap(){let e=this.app.scene.layers.getLayerById(Xt);e&&(e.decrementCounter(),this.camera.requestSceneDepthMap(!1))}destroy(){for(let e=0,t=this.effects.length;e<t;e++)this.effects[e].inputTarget.destroy();this.effects.length=0,this.disable()}enable(){!this.enabled&&this.effects.length&&(this.enabled=!0,this._requestDepthMaps(),this.app.graphicsDevice.on("resizecanvas",this._onCanvasResized,this),this.destinationRenderTarget=this.camera.renderTarget,this.camera.renderTarget=this.effects[0].inputTarget,this.camera.onPostprocessing=()=>{if(this.enabled){let e=null,t=this.effects.length;if(t)for(let s=0;s<t;s++){let i=this.effects[s],r=i.outputTarget;s===t-1&&(e=this.camera.rect,this.destinationRenderTarget&&(r=this.destinationRenderTarget)),i.effect.render(i.inputTarget,r,e)}}})}disable(){this.enabled&&(this.enabled=!1,this.app.graphicsDevice.off("resizecanvas",this._onCanvasResized,this),this._releaseDepthMaps(),this._destroyOffscreenTarget(this._sourceTarget),this.camera.renderTarget=this.destinationRenderTarget,this.camera.onPostprocessing=null)}_onCanvasResized(e,t){let s=this.camera.rect,i=this.destinationRenderTarget;e=i?.width??e,t=i?.height??t,this.camera.camera.aspectRatio=e*s.z/(t*s.w),this.resizeRenderTargets()}resizeRenderTargets(){let e=this.app.graphicsDevice,t=this.destinationRenderTarget,s=t?.width??e.width,i=t?.height??e.height,r=this.camera.rect,a=Math.floor(r.z*s),n=Math.floor(r.w*i),l=this.effects;for(let h=0,c=l.length;h<c;h++){let f=l[h];(f.inputTarget.width!==a||f.inputTarget.height!==n)&&this._resizeOffscreenTarget(f.inputTarget)}}onCameraRectChanged(e,t,s){this.enabled&&this.resizeRenderTargets()}}});var cr,XP=m(()=>{J();WS();el();We();uD();cr=class extends ae{constructor(e,t){super(e,t),this.onPostprocessing=null,this._renderSceneDepthMap=0,this._renderSceneColorMap=0,this._sceneDepthMapRequested=!1,this._sceneColorMapRequested=!1,this._priority=0,this._disablePostEffectsLayer=pa,this._camera=new co,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._camera.node=t,this._postEffects=new E_(e.app,this)}setShaderPass(e){let t=Ds.get(this.system.app.graphicsDevice),s=e?t.allocate(e,{isForward:!0}):null;return this._camera.shaderPassInfo=s,s.index}getShaderPass(){return this._camera.shaderPassInfo?.name}set renderPasses(e){this._camera.renderPasses=e||[],this.dirtyLayerCompositionCameras(),this.system.app.scene.updateShaders=!0}get renderPasses(){return this._camera.renderPasses}get shaderParams(){return this._camera.shaderParams}set gammaCorrection(e){this.camera.shaderParams.gammaCorrection=e}get gammaCorrection(){return this.camera.shaderParams.gammaCorrection}set toneMapping(e){this.camera.shaderParams.toneMapping=e}get toneMapping(){return this.camera.shaderParams.toneMapping}set fog(e){this._camera.fogParams=e}get fog(){return this._camera.fogParams}set aperture(e){this._camera.aperture=e}get aperture(){return this._camera.aperture}set aspectRatio(e){this._camera.aspectRatio=e}get aspectRatio(){return this._camera.aspectRatio}set aspectRatioMode(e){this._camera.aspectRatioMode=e}get aspectRatioMode(){return this._camera.aspectRatioMode}set calculateProjection(e){this._camera.calculateProjection=e}get calculateProjection(){return this._camera.calculateProjection}set calculateTransform(e){this._camera.calculateTransform=e}get calculateTransform(){return this._camera.calculateTransform}get camera(){return this._camera}set clearColor(e){this._camera.clearColor=e}get clearColor(){return this._camera.clearColor}set clearColorBuffer(e){this._camera.clearColorBuffer=e,this.dirtyLayerCompositionCameras()}get clearColorBuffer(){return this._camera.clearColorBuffer}set clearDepthBuffer(e){this._camera.clearDepthBuffer=e,this.dirtyLayerCompositionCameras()}get clearDepthBuffer(){return this._camera.clearDepthBuffer}set clearStencilBuffer(e){this._camera.clearStencilBuffer=e,this.dirtyLayerCompositionCameras()}get clearStencilBuffer(){return this._camera.clearStencilBuffer}set cullFaces(e){this._camera.cullFaces=e}get cullFaces(){return this._camera.cullFaces}set disablePostEffectsLayer(e){this._disablePostEffectsLayer=e,this.dirtyLayerCompositionCameras()}get disablePostEffectsLayer(){return this._disablePostEffectsLayer}set farClip(e){this._camera.farClip=e}get farClip(){return this._camera.farClip}set flipFaces(e){this._camera.flipFaces=e}get flipFaces(){return this._camera.flipFaces}set fov(e){this._camera.fov=e}get fov(){return this._camera.fov}get frustum(){return this._camera.frustum}set frustumCulling(e){this._camera.frustumCulling=e}get frustumCulling(){return this._camera.frustumCulling}set horizontalFov(e){this._camera.horizontalFov=e}get horizontalFov(){return this._camera.horizontalFov}set layers(e){let t=this._camera.layers,s=this.system.app.scene;t.forEach(i=>{s.layers.getLayerById(i)?.removeCamera(this)}),this._camera.layers=e,this.enabled&&this.entity.enabled&&e.forEach(i=>{s.layers.getLayerById(i)?.addCamera(this)}),this.fire("set:layers")}get layers(){return this._camera.layers}get layersSet(){return this._camera.layersSet}set jitter(e){this._camera.jitter=e}get jitter(){return this._camera.jitter}set nearClip(e){this._camera.nearClip=e}get nearClip(){return this._camera.nearClip}set orthoHeight(e){this._camera.orthoHeight=e}get orthoHeight(){return this._camera.orthoHeight}get postEffects(){return this._postEffects}get postEffectsEnabled(){return this._postEffects.enabled}set priority(e){this._priority=e,this.dirtyLayerCompositionCameras()}get priority(){return this._priority}set projection(e){this._camera.projection=e}get projection(){return this._camera.projection}get projectionMatrix(){return this._camera.projectionMatrix}set rect(e){this._camera.rect=e,this.fire("set:rect",this._camera.rect)}get rect(){return this._camera.rect}set renderSceneColorMap(e){e&&!this._sceneColorMapRequested?(this.requestSceneColorMap(!0),this._sceneColorMapRequested=!0):this._sceneColorMapRequested&&(this.requestSceneColorMap(!1),this._sceneColorMapRequested=!1)}get renderSceneColorMap(){return this._renderSceneColorMap>0}set renderSceneDepthMap(e){e&&!this._sceneDepthMapRequested?(this.requestSceneDepthMap(!0),this._sceneDepthMapRequested=!0):this._sceneDepthMapRequested&&(this.requestSceneDepthMap(!1),this._sceneDepthMapRequested=!1)}get renderSceneDepthMap(){return this._renderSceneDepthMap>0}set renderTarget(e){this._camera.renderTarget=e,this.dirtyLayerCompositionCameras()}get renderTarget(){return this._camera.renderTarget}set scissorRect(e){this._camera.scissorRect=e}get scissorRect(){return this._camera.scissorRect}set sensitivity(e){this._camera.sensitivity=e}get sensitivity(){return this._camera.sensitivity}set shutter(e){this._camera.shutter=e}get shutter(){return this._camera.shutter}get viewMatrix(){return this._camera.viewMatrix}_enableDepthLayer(e){if(this.layers.find(s=>s===Xt)){let s=this.system.app.scene.layers.getLayerById(Xt);e?s?.incrementCounter():s?.decrementCounter()}else if(e)return!1;return!0}requestSceneColorMap(e){this._renderSceneColorMap+=e?1:-1,this._enableDepthLayer(e),this.camera._enableRenderPassColorGrab(this.system.app.graphicsDevice,this.renderSceneColorMap),this.system.app.scene.layers.markDirty()}requestSceneDepthMap(e){this._renderSceneDepthMap+=e?1:-1,this._enableDepthLayer(e),this.camera._enableRenderPassDepthGrab(this.system.app.graphicsDevice,this.system.app.renderer,this.renderSceneDepthMap),this.system.app.scene.layers.markDirty()}dirtyLayerCompositionCameras(){let e=this.system.app.scene.layers;e._dirty=!0}screenToWorld(e,t,s,i){let r=this.system.app.graphicsDevice,{width:a,height:n}=r.clientRect;return this._camera.screenToWorld(e,t,s,a,n,i)}worldToScreen(e,t){let s=this.system.app.graphicsDevice,{width:i,height:r}=s.clientRect;return this._camera.worldToScreen(e,i,r,t)}onAppPrerender(){this._camera._viewMatDirty=!0,this._camera._viewProjMatDirty=!0}addCameraToLayers(){let e=this.layers;for(let t=0;t<e.length;t++){let s=this.system.app.scene.layers.getLayerById(e[t]);s&&s.addCamera(this)}}removeCameraFromLayers(){let e=this.layers;for(let t=0;t<e.length;t++){let s=this.system.app.scene.layers.getLayerById(e[t]);s&&s.removeCamera(this)}}onLayersChanged(e,t){this.addCameraToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||e.addCamera(this)}onLayerRemoved(e){this.layers.indexOf(e.id)<0||e.removeCamera(this)}onEnable(){let e=this.system.app.scene,t=e.layers;this.system.addCamera(this),this._evtLayersChanged?.off(),this._evtLayersChanged=e.on("set:layers",this.onLayersChanged,this),t&&(this._evtLayerAdded?.off(),this._evtLayerAdded=t.on("add",this.onLayerAdded,this),this._evtLayerRemoved?.off(),this._evtLayerRemoved=t.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addCameraToLayers(),this.postEffects.enable()}onDisable(){let t=this.system.app.scene.layers;this.postEffects.disable(),this.removeCameraFromLayers(),this._evtLayersChanged?.off(),this._evtLayersChanged=null,t&&(this._evtLayerAdded?.off(),this._evtLayerAdded=null,this._evtLayerRemoved?.off(),this._evtLayerRemoved=null),this.system.removeCamera(this)}onRemove(){this.onDisable(),this.off(),this.camera.destroy()}calculateAspectRatio(e){let t=this.system.app.graphicsDevice,s=e?e.width:t.width,i=e?e.height:t.height;return s*this.rect.z/(i*this.rect.w)}frameUpdate(e){this.aspectRatioMode===Nh&&(this.aspectRatio=this.calculateAspectRatio(e))}startXr(e,t,s){this.system.app.xr.start(this,e,t,s)}endXr(e){if(!this._camera.xr){e&&e(new Error("Camera is not in XR"));return}this._camera.xr.end(e)}copy(e){this.aperture=e.aperture,this.aspectRatio=e.aspectRatio,this.aspectRatioMode=e.aspectRatioMode,this.calculateProjection=e.calculateProjection,this.calculateTransform=e.calculateTransform,this.clearColor=e.clearColor,this.clearColorBuffer=e.clearColorBuffer,this.clearDepthBuffer=e.clearDepthBuffer,this.clearStencilBuffer=e.clearStencilBuffer,this.cullFaces=e.cullFaces,this.disablePostEffectsLayer=e.disablePostEffectsLayer,this.farClip=e.farClip,this.flipFaces=e.flipFaces,this.fov=e.fov,this.frustumCulling=e.frustumCulling,this.horizontalFov=e.horizontalFov,this.layers=e.layers,this.nearClip=e.nearClip,this.orthoHeight=e.orthoHeight,this.priority=e.priority,this.projection=e.projection,this.rect=e.rect,this.renderTarget=e.renderTarget,this.scissorRect=e.scissorRect,this.sensitivity=e.sensitivity,this.shutter=e.shutter}}});var WP,BZ=m(()=>{WP=class{constructor(){this.enabled=!0}}});var VZ,Nc,mD=m(()=>{hA();De();Ze();We();Ut();XP();BZ();VZ=["enabled"],Nc=class extends Me{constructor(e){super(e),this.cameras=[],this.id="camera",this.ComponentType=cr,this.DataType=WP,this.schema=VZ,this.on("beforeremove",this.onBeforeRemove,this),this.app.on("prerender",this.onAppPrerender,this)}initializeComponentData(e,t,s){s=["aspectRatio","aspectRatioMode","calculateProjection","calculateTransform","clearColor","clearColorBuffer","clearDepthBuffer","clearStencilBuffer","renderSceneColorMap","renderSceneDepthMap","cullFaces","farClip","flipFaces","fog","fov","frustumCulling","horizontalFov","layers","renderTarget","nearClip","orthoHeight","projection","priority","rect","scissorRect","aperture","shutter","sensitivity","gammaCorrection","toneMapping"];for(let i=0;i<s.length;i++){let r=s[i];if(t.hasOwnProperty(r)){let a=t[r];switch(r){case"rect":case"scissorRect":Array.isArray(a)?e[r]=new W(a[0],a[1],a[2],a[3]):e[r]=a;break;case"clearColor":Array.isArray(a)?e[r]=new N(a[0],a[1],a[2],a[3]):e[r]=a;break;default:e[r]=a;break}}}super.initializeComponentData(e,t,["enabled"])}cloneComponent(e,t){let s=e.camera;return this.addComponent(t,{aspectRatio:s.aspectRatio,aspectRatioMode:s.aspectRatioMode,calculateProjection:s.calculateProjection,calculateTransform:s.calculateTransform,clearColor:s.clearColor,clearColorBuffer:s.clearColorBuffer,clearDepthBuffer:s.clearDepthBuffer,clearStencilBuffer:s.clearStencilBuffer,renderSceneDepthMap:s.renderSceneDepthMap,renderSceneColorMap:s.renderSceneColorMap,cullFaces:s.cullFaces,enabled:s.enabled,farClip:s.farClip,flipFaces:s.flipFaces,fov:s.fov,frustumCulling:s.frustumCulling,horizontalFov:s.horizontalFov,layers:s.layers,renderTarget:s.renderTarget,nearClip:s.nearClip,orthoHeight:s.orthoHeight,projection:s.projection,priority:s.priority,rect:s.rect,scissorRect:s.scissorRect,aperture:s.aperture,sensitivity:s.sensitivity,shutter:s.shutter,gammaCorrection:s.gammaCorrection,toneMapping:s.toneMapping})}onBeforeRemove(e,t){this.removeCamera(t),t.onRemove()}onAppPrerender(){for(let e=0,t=this.cameras.length;e<t;e++)this.cameras[e].onAppPrerender()}addCamera(e){this.cameras.push(e),Yh(this.cameras)}removeCamera(e){let t=this.cameras.indexOf(e);t>=0&&(this.cameras.splice(t,1),Yh(this.cameras))}destroy(){this.app.off("prerender",this.onAppPrerender,this),super.destroy()}};ae._buildAccessors(cr.prototype,VZ)});var XT,Cd,pD=m(()=>{De();J();XT=class{constructor(){this.enabled=!0,this.type="directional",this.color=new N(1,1,1),this.intensity=1,this.luminance=0,this.shape=bs,this.affectSpecularity=!0,this.castShadows=!1,this.shadowDistance=40,this.shadowIntensity=1,this.shadowResolution=1024,this.shadowBias=.05,this.numCascades=1,this.cascadeBlend=0,this.bakeNumSamples=1,this.bakeArea=0,this.cascadeDistribution=.5,this.normalOffsetBias=0,this.range=10,this.innerConeAngle=40,this.outerConeAngle=45,this.falloffMode=Lf,this.shadowType=Hs,this.vsmBlurSize=11,this.vsmBlurMode=yh,this.vsmBias=.01*.25,this.cookieAsset=null,this.cookie=null,this.cookieIntensity=1,this.cookieFalloff=!0,this.cookieChannel="rgb",this.cookieAngle=0,this.cookieScale=null,this.cookieOffset=null,this.shadowUpdateMode=Dh,this.mask=1,this.affectDynamic=!0,this.affectLightmapped=!1,this.bake=!1,this.bakeDir=!0,this.isStatic=!1,this.layers=[ms],this.penumbraSize=1,this.penumbraFalloff=1,this.shadowSamples=16,this.shadowBlockerSamples=16}},Cd=Object.keys(new XT)});var v_,_D=m(()=>{me();Ze();J();rt();We();pD();v_=class extends ae{get data(){let e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){this._setValue("enabled",e,function(t,s){this.onSetEnabled(null,s,t)})}get enabled(){return this.data.enabled}set light(e){this._setValue("light",e)}get light(){return this.data.light}set type(e){this._setValue("type",e,function(t,s){this.system.changeType(this,s,t),this.refreshProperties()})}get type(){return this.data.type}set color(e){this._setValue("color",e,function(t,s){this.light.setColor(t)},!0)}get color(){return this.data.color}set intensity(e){this._setValue("intensity",e,function(t,s){this.light.intensity=t})}get intensity(){return this.data.intensity}set luminance(e){this._setValue("luminance",e,function(t,s){this.light.luminance=t})}get luminance(){return this.data.luminance}set shape(e){this._setValue("shape",e,function(t,s){this.light.shape=t})}get shape(){return this.data.shape}set affectSpecularity(e){this._setValue("affectSpecularity",e,function(t,s){this.light.affectSpecularity=t})}get affectSpecularity(){return this.data.affectSpecularity}set castShadows(e){this._setValue("castShadows",e,function(t,s){this.light.castShadows=t})}get castShadows(){return this.data.castShadows}set shadowDistance(e){this._setValue("shadowDistance",e,function(t,s){this.light.shadowDistance=t})}get shadowDistance(){return this.data.shadowDistance}set shadowIntensity(e){this._setValue("shadowIntensity",e,function(t,s){this.light.shadowIntensity=t})}get shadowIntensity(){return this.data.shadowIntensity}set shadowResolution(e){this._setValue("shadowResolution",e,function(t,s){this.light.shadowResolution=t})}get shadowResolution(){return this.data.shadowResolution}set shadowBias(e){this._setValue("shadowBias",e,function(t,s){this.light.shadowBias=-.01*w.clamp(t,0,1)})}get shadowBias(){return this.data.shadowBias}set numCascades(e){this._setValue("numCascades",e,function(t,s){this.light.numCascades=w.clamp(Math.floor(t),1,4)})}get numCascades(){return this.data.numCascades}set cascadeBlend(e){this._setValue("cascadeBlend",e,function(t,s){this.light.cascadeBlend=w.clamp(t,0,1)})}get cascadeBlend(){return this.data.cascadeBlend}set bakeNumSamples(e){this._setValue("bakeNumSamples",e,function(t,s){this.light.bakeNumSamples=w.clamp(Math.floor(t),1,255)})}get bakeNumSamples(){return this.data.bakeNumSamples}set bakeArea(e){this._setValue("bakeArea",e,function(t,s){this.light.bakeArea=w.clamp(t,0,180)})}get bakeArea(){return this.data.bakeArea}set cascadeDistribution(e){this._setValue("cascadeDistribution",e,function(t,s){this.light.cascadeDistribution=w.clamp(t,0,1)})}get cascadeDistribution(){return this.data.cascadeDistribution}set normalOffsetBias(e){this._setValue("normalOffsetBias",e,function(t,s){this.light.normalOffsetBias=w.clamp(t,0,1)})}get normalOffsetBias(){return this.data.normalOffsetBias}set range(e){this._setValue("range",e,function(t,s){this.light.attenuationEnd=t})}get range(){return this.data.range}set innerConeAngle(e){this._setValue("innerConeAngle",e,function(t,s){this.light.innerConeAngle=t})}get innerConeAngle(){return this.data.innerConeAngle}set outerConeAngle(e){this._setValue("outerConeAngle",e,function(t,s){this.light.outerConeAngle=t})}get outerConeAngle(){return this.data.outerConeAngle}set falloffMode(e){this._setValue("falloffMode",e,function(t,s){this.light.falloffMode=t})}get falloffMode(){return this.data.falloffMode}set shadowType(e){this._setValue("shadowType",e,function(t,s){this.light.shadowType=t})}get shadowType(){return this.data.shadowType}set vsmBlurSize(e){this._setValue("vsmBlurSize",e,function(t,s){this.light.vsmBlurSize=t})}get vsmBlurSize(){return this.data.vsmBlurSize}set vsmBlurMode(e){this._setValue("vsmBlurMode",e,function(t,s){this.light.vsmBlurMode=t})}get vsmBlurMode(){return this.data.vsmBlurMode}set vsmBias(e){this._setValue("vsmBias",e,function(t,s){this.light.vsmBias=w.clamp(t,0,1)})}get vsmBias(){return this.data.vsmBias}set cookieAsset(e){this._setValue("cookieAsset",e,function(t,s){if(!(this._cookieAssetId&&(t instanceof re&&t.id===this._cookieAssetId||t===this._cookieAssetId))){if(this.onCookieAssetRemove(),this._cookieAssetId=null,t instanceof re)this.data.cookieAsset=t.id,this._cookieAssetId=t.id,this.onCookieAssetAdd(t);else if(typeof t=="number"){this._cookieAssetId=t;let i=this.system.app.assets.get(t);i?this.onCookieAssetAdd(i):(this._cookieAssetAdd=!0,this.system.app.assets.on(`add:${this._cookieAssetId}`,this.onCookieAssetAdd,this))}}})}get cookieAsset(){return this.data.cookieAsset}set cookie(e){this._setValue("cookie",e,function(t,s){this.light.cookie=t})}get cookie(){return this.data.cookie}set cookieIntensity(e){this._setValue("cookieIntensity",e,function(t,s){this.light.cookieIntensity=w.clamp(t,0,1)})}get cookieIntensity(){return this.data.cookieIntensity}set cookieFalloff(e){this._setValue("cookieFalloff",e,function(t,s){this.light.cookieFalloff=t})}get cookieFalloff(){return this.data.cookieFalloff}set cookieChannel(e){this._setValue("cookieChannel",e,function(t,s){this.light.cookieChannel=t})}get cookieChannel(){return this.data.cookieChannel}set cookieAngle(e){this._setValue("cookieAngle",e,function(t,s){if(t!==0||this.cookieScale!==null){this._cookieMatrix||(this._cookieMatrix=new W);let i=1,r=1;this.cookieScale&&(i=this.cookieScale.x,r=this.cookieScale.y);let a=Math.cos(t*w.DEG_TO_RAD),n=Math.sin(t*w.DEG_TO_RAD);this._cookieMatrix.set(a/i,-n/i,n/r,a/r),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null})}get cookieAngle(){return this.data.cookieAngle}set cookieScale(e){this._setValue("cookieScale",e,function(t,s){if(t!==null||this.cookieAngle!==0){this._cookieMatrix||(this._cookieMatrix=new W);let i=t.x,r=t.y,a=Math.cos(this.cookieAngle*w.DEG_TO_RAD),n=Math.sin(this.cookieAngle*w.DEG_TO_RAD);this._cookieMatrix.set(a/i,-n/i,n/r,a/r),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null},!0)}get cookieScale(){return this.data.cookieScale}set cookieOffset(e){this._setValue("cookieOffset",e,function(t,s){this.light.cookieOffset=t},!0)}get cookieOffset(){return this.data.cookieOffset}set shadowUpdateMode(e){this._setValue("shadowUpdateMode",e,function(t,s){this.light.shadowUpdateMode=t},!0)}get shadowUpdateMode(){return this.data.shadowUpdateMode}set mask(e){this._setValue("mask",e,function(t,s){this.light.mask=t})}get mask(){return this.data.mask}set affectDynamic(e){this._setValue("affectDynamic",e,function(t,s){t?this.light.mask|=ps:this.light.mask&=-2,this.light.layersDirty()})}get affectDynamic(){return this.data.affectDynamic}set affectLightmapped(e){this._setValue("affectLightmapped",e,function(t,s){t?(this.light.mask|=ir,this.bake&&(this.light.mask&=-5)):(this.light.mask&=-3,this.bake&&(this.light.mask|=_a))})}get affectLightmapped(){return this.data.affectLightmapped}set bake(e){this._setValue("bake",e,function(t,s){t?(this.light.mask|=_a,this.affectLightmapped&&(this.light.mask&=-3)):(this.light.mask&=-5,this.affectLightmapped&&(this.light.mask|=ir)),this.light.layersDirty()})}get bake(){return this.data.bake}set bakeDir(e){this._setValue("bakeDir",e,function(t,s){this.light.bakeDir=t})}get bakeDir(){return this.data.bakeDir}set isStatic(e){this._setValue("isStatic",e,function(t,s){this.light.isStatic=t})}get isStatic(){return this.data.isStatic}set layers(e){this._setValue("layers",e,function(t,s){for(let i=0;i<s.length;i++){let r=this.system.app.scene.layers.getLayerById(s[i]);r&&(r.removeLight(this),this.light.removeLayer(r))}for(let i=0;i<t.length;i++){let r=this.system.app.scene.layers.getLayerById(t[i]);r&&this.enabled&&this.entity.enabled&&(r.addLight(this),this.light.addLayer(r))}})}get layers(){return this.data.layers}set shadowUpdateOverrides(e){this.light.shadowUpdateOverrides=e}get shadowUpdateOverrides(){return this.light.shadowUpdateOverrides}set shadowSamples(e){this.light.shadowSamples=e}get shadowSamples(){return this.light.shadowSamples}set shadowBlockerSamples(e){this.light.shadowBlockerSamples=e}get shadowBlockerSamples(){return this.light.shadowBlockerSamples}set penumbraSize(e){this.light.penumbraSize=e}get penumbraSize(){return this.light.penumbraSize}set penumbraFalloff(e){this.light.penumbraFalloff=e}get penumbraFalloff(){return this.light.penumbraFalloff}_setValue(e,t,s,i){let r=this.data,a=r[e];!i&&a===t||(r[e]=t,s&&s.call(this,t,a))}addLightToLayers(){for(let e=0;e<this.layers.length;e++){let t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&(t.addLight(this),this.light.addLayer(t))}}removeLightFromLayers(){for(let e=0;e<this.layers.length;e++){let t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&(t.removeLight(this),this.light.removeLayer(t))}}onLayersChanged(e,t){this.enabled&&this.entity.enabled&&this.addLightToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)>=0&&this.enabled&&this.entity.enabled&&(e.addLight(this),this.light.addLayer(e))}onLayerRemoved(e){this.layers.indexOf(e.id)>=0&&(e.removeLight(this),this.light.removeLayer(e))}refreshProperties(){for(let e=0;e<Cd.length;e++){let t=Cd[e];this[t]=this[t]}this.enabled&&this.entity.enabled&&this.onEnable()}onCookieAssetSet(){let e=!1;this._cookieAsset.type==="cubemap"&&!this._cookieAsset.loadFaces&&(this._cookieAsset.loadFaces=!0,e=!0),(!this._cookieAsset.resource||e)&&this.system.app.assets.load(this._cookieAsset),this._cookieAsset.resource&&this.onCookieAssetLoad()}onCookieAssetAdd(e){this._cookieAssetId===e.id&&(this._cookieAsset=e,this.light.enabled&&this.onCookieAssetSet(),this._cookieAsset.on("load",this.onCookieAssetLoad,this),this._cookieAsset.on("remove",this.onCookieAssetRemove,this))}onCookieAssetLoad(){!this._cookieAsset||!this._cookieAsset.resource||(this.cookie=this._cookieAsset.resource)}onCookieAssetRemove(){this._cookieAssetId&&(this._cookieAssetAdd&&(this.system.app.assets.off(`add:${this._cookieAssetId}`,this.onCookieAssetAdd,this),this._cookieAssetAdd=!1),this._cookieAsset&&(this._cookieAsset.off("load",this.onCookieAssetLoad,this),this._cookieAsset.off("remove",this.onCookieAssetRemove,this),this._cookieAsset=null),this.cookie=null)}onEnable(){let e=this.system.app.scene,t=e.layers;this.light.enabled=!0,this._evtLayersChanged=e.on("set:layers",this.onLayersChanged,this),t&&(this._evtLayerAdded=t.on("add",this.onLayerAdded,this),this._evtLayerRemoved=t.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addLightToLayers(),this._cookieAsset&&!this.cookie&&this.onCookieAssetSet()}onDisable(){let t=this.system.app.scene.layers;this.light.enabled=!1,this._evtLayersChanged?.off(),this._evtLayersChanged=null,t&&(this._evtLayerAdded?.off(),this._evtLayerAdded=null,this._evtLayerRemoved?.off(),this._evtLayerRemoved=null),this.removeLightFromLayers()}onRemove(){this.onDisable(),this.light.destroy(),this.cookieAsset=null}constructor(...e){super(...e),this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._cookieAsset=null,this._cookieAssetId=null,this._cookieAssetAdd=!1,this._cookieMatrix=null}}});var Fc,gD=m(()=>{De();Ne();J();dA();Ut();_D();pD();Fc=class extends Me{constructor(e){super(e),this.id="light",this.ComponentType=v_,this.DataType=XT,this.on("beforeremove",this._onRemoveComponent,this)}initializeComponentData(e,t){let s={...t};s.type||(s.type=e.data.type),e.data.type=s.type,s.layers&&Array.isArray(s.layers)&&(s.layers=s.layers.slice(0)),s.color&&Array.isArray(s.color)&&(s.color=new N(s.color[0],s.color[1],s.color[2])),s.cookieOffset&&s.cookieOffset instanceof Array&&(s.cookieOffset=new D(s.cookieOffset[0],s.cookieOffset[1])),s.cookieScale&&s.cookieScale instanceof Array&&(s.cookieScale=new D(s.cookieScale[0],s.cookieScale[1])),s.enable&&(console.warn("WARNING: enable: Property is deprecated. Set enabled property instead."),s.enabled=s.enable),s.shape||(s.shape=bs);let i=new Kh(this.app.graphicsDevice,this.app.scene.clusteredLightingEnabled);i.type=JS[s.type],i._node=e.entity,e.data.light=i,super.initializeComponentData(e,s,Cd)}_onRemoveComponent(e,t){t.onRemove()}cloneComponent(e,t){let s=e.light,i=[],r;for(let a=0;a<Cd.length;a++)r=Cd[a],r!=="light"&&(s[r]&&s[r].clone?i[r]=s[r].clone():i[r]=s[r]);return this.addComponent(t,i)}changeType(e,t,s){t!==s&&(e.light.type=JS[s])}}});function x_(o,e,t,s){switch(e.type){case"boolean":return!!t;case"number":if(typeof t=="number")return t;if(typeof t=="string"){let i=parseInt(t,10);return isNaN(i)?null:i}else if(typeof t=="boolean")return 0+t;return null;case"json":{let i={};if(Array.isArray(e.schema)){(!t||typeof t!="object")&&(t={});for(let r=0;r<e.schema.length;r++){let a=e.schema[r];if(a.name)if(a.array){i[a.name]=[];let n=Array.isArray(t[a.name])?t[a.name]:[];for(let l=0;l<n.length;l++)i[a.name].push(x_(o,a,n[l]))}else{let n=t.hasOwnProperty(a.name)?t[a.name]:a.default;i[a.name]=x_(o,a,n)}}}return i}case"asset":return t instanceof re?t:typeof t=="number"?o.assets.get(t)||null:typeof t=="string"&&o.assets.get(parseInt(t,10))||null;case"entity":return t instanceof Ae?t:typeof t=="string"?o.getEntityFromIndex(t):null;case"rgb":case"rgba":if(t instanceof N)return s instanceof N?(s.copy(t),s):t.clone();if(t instanceof Array&&t.length>=3&&t.length<=4){for(let i=0;i<t.length;i++)if(typeof t[i]!="number")return null;return s||(s=new N),s.r=t[0],s.g=t[1],s.b=t[2],s.a=t.length===3?1:t[3],s}else if(typeof t=="string"&&/#(?:[0-9a-f]{2}){3,4}/i.test(t))return s||(s=new N),s.fromString(t),s;return null;case"vec2":case"vec3":case"vec4":{let i=parseInt(e.type.slice(3),10),r=Goe[i];if(t instanceof r)return s instanceof r?(s.copy(t),s):t.clone();if(t instanceof Array&&t.length===i){for(let a=0;a<t.length;a++)if(typeof t[a]!="number")return null;s||(s=new r);for(let a=0;a<i;a++)s[koe[a]]=t[a];return s}return null}case"curve":if(t){let i;if(t instanceof Ts||t instanceof Bi)i=t.clone();else{let r=t.keys[0]instanceof Array?Bi:Ts;i=new r(t.keys),i.type=t.type}return i}break}return t}function kZ(o,e,t,s){return e.array?t.map((i,r)=>x_(o,e,i,s?s[r]:null)):x_(o,e,t,s)}function SD(o,e,t,s){if(t)for(let i in e){let r=e[i],a=t[i];a!==void 0&&(s[i]=kZ(o,r,a,s[i]))}}var koe,Goe,mn,WT=m(()=>{De();ou();jg();Ne();Q();Ze();Zt();rt();koe=["x","y","z","w"],Goe=[void 0,void 0,D,g,W];mn=class o{static{this.assignAttributesToScript=SD}static{this.attributeToValue=kZ}constructor(e){this.scriptType=e,this.index={}}static{this.reservedNames=new Set(["app","entity","enabled","_enabled","_enabledOld","_destroyed","__attributes","__attributesRaw","__scriptType","__executionOrder","_callbacks","_callbackActive","has","get","on","off","fire","once","hasEvent"])}add(e,t){this.index[e]||o.reservedNames.has(e)||(this.index[e]=t,Object.defineProperty(this.scriptType.prototype,e,{get:function(){return this.__attributes[e]},set:function(s){let i="attr",r=`attr:${e}`,a=this.__attributes[e],n=a;if(a&&t.type!=="json"&&t.type!=="entity"&&a.clone&&(this.hasEvent(i)||this.hasEvent(r))&&(n=a.clone()),t.array){if(this.__attributes[e]=[],s)for(let l=0,h=s.length;l<h;l++)this.__attributes[e].push(x_(this.app,t,s[l],a?a[l]:null))}else this.__attributes[e]=x_(this.app,t,s,a);this.fire(i,e,this.__attributes[e],n),this.fire(r,this.__attributes[e],n)}}))}remove(e){return this.index[e]?(delete this.index[e],delete this.scriptType.prototype[e],!0):!1}has(e){return!!this.index[e]}get(e){return this.index[e]||null}}});var YT,KT,GZ,zZ,HZ,TD=m(()=>{YT="initialize",KT="postInitialize",GZ="update",zZ="postUpdate",HZ="swap"});function ED(o){if(typeof o!="function")return;if(o.scriptName)return o.scriptName;if("name"in Function.prototype)return o.name;if(o===Function||o===Function.prototype.constructor)return"Function";let e=`${o}`.match(zoe);return e?e[1]:void 0}var pn,zoe,y_=m(()=>{Pe();TD();pn=class extends K{static{this.EVENT_ENABLE="enable"}static{this.EVENT_DISABLE="disable"}static{this.EVENT_STATE="state"}static{this.EVENT_DESTROY="destroy"}static{this.EVENT_ATTR="attr"}static{this.EVENT_ERROR="error"}constructor(e){super(),this.initScript(e)}set enabled(e){this._enabled=!!e,this.enabled!==this._enabledOld&&(this._enabledOld=this.enabled,this.fire(this.enabled?"enable":"disable"),this.fire("state",this.enabled),!this._initialized&&this.enabled&&(this._initialized=!0,this.fire("preInitialize"),this.initialize&&this.entity.script._scriptMethod(this,YT)),this._initialized&&!this._postInitialized&&this.enabled&&!this.entity.script._beingEnabled&&(this._postInitialized=!0,this.postInitialize&&this.entity.script._scriptMethod(this,KT)))}get enabled(){return this._enabled&&!this._destroyed&&this.entity.script.enabled&&this.entity.enabled}initScript(e){let t=this.constructor;this.app=e.app,this.entity=e.entity,this._enabled=typeof e.enabled=="boolean"?e.enabled:!0,this._enabledOld=this.enabled,this.__destroyed=!1,this.__scriptType=t,this.__executionOrder=-1}static{this.__name=null}static{this.__getScriptName=ED}static get scriptName(){return this.__name}},zoe=/^\s*function(?:\s|\s*\/\*.*\*\/\s*)+([^(\s\/]*)\s*/});var fr,YP=m(()=>{WT();y_();fr=class extends pn{constructor(e){super(e),this.initScriptType(e)}static get attributes(){return this.hasOwnProperty("__attributes")||(this.__attributes=new mn(this)),this.__attributes}initScript(e){pn.prototype.initScript.call(this,e),this.__attributes={},this.__attributesRaw=e.attributes||{}}initScriptType(e){this.initScript(e)}__initializeAttributes(e){if(!(!e&&!this.__attributesRaw)){for(let t in this.__scriptType.attributes.index)this.__attributesRaw&&this.__attributesRaw.hasOwnProperty(t)?this[t]=this.__attributesRaw[t]:this.__attributes.hasOwnProperty(t)||(this.__scriptType.attributes.index[t].hasOwnProperty("default")?this[t]=this.__scriptType.attributes.index[t].default:this[t]=null);this.__attributesRaw=null}}static extend(e){for(let t in e)e.hasOwnProperty(t)&&(this.prototype[t]=e[t])}}});var Hoe,A_,vD=m(()=>{IE();WT();We();ci();TD();YP();y_();Hoe=o=>o[0].toLowerCase()+o.substring(1),A_=class extends ae{static{this.EVENT_CREATE="create"}static{this.EVENT_DESTROY="destroy"}static{this.EVENT_ENABLE="enable"}static{this.EVENT_DISABLE="disable"}static{this.EVENT_REMOVE="remove"}static{this.EVENT_STATE="state"}static{this.EVENT_MOVE="move"}static{this.EVENT_ERROR="error"}constructor(e,t){super(e,t),this._attributeDataMap=new Map,this._scripts=[],this._updateList=new yn({sortBy:"__executionOrder"}),this._postUpdateList=new yn({sortBy:"__executionOrder"}),this._scriptsIndex={},this._destroyedScripts=[],this._destroyed=!1,this._scriptsData=null,this._oldState=!0,this._enabled=!0,this._beingEnabled=!1,this._isLoopingThroughScripts=!1,this._executionOrder=-1,this.on("set_enabled",this._onSetEnabled,this)}set scripts(e){this._scriptsData=e;for(let t in e){if(!e.hasOwnProperty(t))continue;let s=this._scriptsIndex[t];if(s){if(typeof e[t].enabled=="boolean"&&(s.once("preInitialize",()=>{this.initializeAttributes(s)}),s.enabled=!!e[t].enabled),typeof e[t].attributes=="object"){for(let i in e[t].attributes)if(!mn.reservedNames.has(i)){if(!s.__attributes.hasOwnProperty(i)){let r=this.system.app.scripts.get(t);r&&r.attributes.add(i,{})}s[i]=e[t].attributes[i]}}}else console.log(this.order)}}get scripts(){return this._scripts}set enabled(e){let t=this._enabled;this._enabled=e,this.fire("set","enabled",t,e)}get enabled(){return this._enabled}onEnable(){this._beingEnabled=!0,this._checkState(),this.entity._beingEnabled||this.onPostStateChange(),this._beingEnabled=!1}onDisable(){this._checkState()}onPostStateChange(){let e=this._beginLooping();for(let t=0,s=this.scripts.length;t<s;t++){let i=this.scripts[t];i._initialized&&!i._postInitialized&&i.enabled&&(i._postInitialized=!0,i.postInitialize&&this._scriptMethod(i,KT))}this._endLooping(e)}_beginLooping(){let e=this._isLoopingThroughScripts;return this._isLoopingThroughScripts=!0,e}_endLooping(e){this._isLoopingThroughScripts=e,this._isLoopingThroughScripts||this._removeDestroyedScripts()}_onSetEnabled(e,t,s){this._beingEnabled=!0,this._checkState(),this._beingEnabled=!1}_checkState(){let e=this.enabled&&this.entity.enabled;if(e===this._oldState)return;this._oldState=e,this.fire(e?"enable":"disable"),this.fire("state",e),e?this.system._addComponentToEnabled(this):this.system._removeComponentFromEnabled(this);let t=this._beginLooping();for(let s=0,i=this.scripts.length;s<i;s++){let r=this.scripts[s];r.once("preInitialize",()=>{this.initializeAttributes(r)}),r.enabled=r._enabled}this._endLooping(t)}_onBeforeRemove(){this.fire("remove");let e=this._beginLooping();for(let t=0;t<this.scripts.length;t++){let s=this.scripts[t];s&&this.destroy(s.__scriptType.__name)}this._endLooping(e)}_removeDestroyedScripts(){let e=this._destroyedScripts.length;if(e){for(let t=0;t<e;t++){let s=this._destroyedScripts[t];this._removeScriptInstance(s)}this._destroyedScripts.length=0,this._resetExecutionOrder(0,this._scripts.length)}}_onInitializeAttributes(){for(let e=0,t=this.scripts.length;e<t;e++){let s=this.scripts[e];this.initializeAttributes(s)}}initializeAttributes(e){if(e instanceof fr)e.__initializeAttributes();else{let t=e.__scriptType.__name,s=this._attributeDataMap.get(t);if(!s)return;let i=this.system.app.scripts?.getSchema(t);SD(this.system.app,i.attributes,s,e)}}_scriptMethod(e,t,s){e[t](s)}_onInitialize(){let e=this._scripts,t=this._beginLooping();for(let s=0,i=e.length;s<i;s++){let r=e[s];!r._initialized&&r.enabled&&(r._initialized=!0,r.initialize&&this._scriptMethod(r,YT))}this._endLooping(t)}_onPostInitialize(){this.onPostStateChange()}_onUpdate(e){let t=this._updateList;if(!t.length)return;let s=this._beginLooping();for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++){let i=t.items[t.loopIndex];i.enabled&&this._scriptMethod(i,GZ,e)}this._endLooping(s)}_onPostUpdate(e){let t=this._postUpdateList;if(!t.length)return;let s=this._beginLooping();for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++){let i=t.items[t.loopIndex];i.enabled&&this._scriptMethod(i,zZ,e)}this._endLooping(s)}_insertScriptInstance(e,t,s){t===-1?(this._scripts.push(e),e.__executionOrder=s,e.update&&this._updateList.append(e),e.postUpdate&&this._postUpdateList.append(e)):(this._scripts.splice(t,0,e),e.__executionOrder=t,this._resetExecutionOrder(t+1,s+1),e.update&&this._updateList.insert(e),e.postUpdate&&this._postUpdateList.insert(e))}_removeScriptInstance(e){let t=this._scripts.indexOf(e);return t===-1||(this._scripts.splice(t,1),e.update&&this._updateList.remove(e),e.postUpdate&&this._postUpdateList.remove(e)),t}_resetExecutionOrder(e,t){for(let s=e;s<t;s++)this._scripts[s].__executionOrder=s}_resolveEntityScriptAttribute(e,t,s,i,r,a){if(e.array){let n=s.length;if(!n)return;let l=s.slice();for(let h=0;h<n;h++){let c=l[h]instanceof be?l[h].getGuid():l[h];a[c]&&(l[h]=i?a[c].getGuid():a[c])}r[t]=l}else{if(s instanceof be)s=s.getGuid();else if(typeof s!="string")return;a[s]&&(r[t]=a[s])}}has(e){if(typeof e=="string")return!!this._scriptsIndex[e];if(!e)return!1;let t=e,s=t.__name,i=this._scriptsIndex[s];return(i&&i.instance)instanceof t}get(e){if(typeof e=="string"){let a=this._scriptsIndex[e];return a?a.instance:null}if(!e)return null;let t=e,s=t.__name,i=this._scriptsIndex[s],r=i&&i.instance;return r instanceof t?r:null}create(e,t={}){let s=this,i=e,r=e;if(typeof i=="string")i=this.system.app.scripts.get(i);else if(i){let a=ED(i),n=Hoe(a);!(i.prototype instanceof fr)&&i.scriptName,i.__name??=i.scriptName??n,r=i.__name}if(i){if(!this._scriptsIndex[r]||!this._scriptsIndex[r].instance){let a=new i({app:this.system.app,entity:this.entity,enabled:t.hasOwnProperty("enabled")?t.enabled:!0,attributes:t.attributes||{}});t.properties&&typeof t.properties=="object"&&Object.assign(a,t.properties),a instanceof fr||this._attributeDataMap.set(r,t.attributes);let n=this._scripts.length,l=-1;return typeof t.ind=="number"&&t.ind!==-1&&n>t.ind&&(l=t.ind),this._insertScriptInstance(a,l,n),this._scriptsIndex[r]={instance:a,onSwap:function(){s.swap(r)}},this[r]=a,t.preloading||this.initializeAttributes(a),this.fire("create",r,a),this.fire(`create:${r}`,a),this.system.app.scripts.on(`swap:${r}`,this._scriptsIndex[r].onSwap),t.preloading||(a.enabled&&!a._initialized&&(a._initialized=!0,a.initialize&&this._scriptMethod(a,YT)),a.enabled&&!a._postInitialized&&(a._postInitialized=!0,a.postInitialize&&this._scriptMethod(a,KT))),a}}else this._scriptsIndex[r]={awaiting:!0,ind:this._scripts.length};return null}destroy(e){let t=e,s=e;typeof s=="string"?s=this.system.app.scripts.get(s):s&&(t=s.__name);let i=this._scriptsIndex[t];if(delete this._scriptsIndex[t],!i)return!1;this._attributeDataMap.delete(t);let r=i.instance;if(r&&!r._destroyed)if(r.enabled=!1,r._destroyed=!0,this._isLoopingThroughScripts)this._destroyedScripts.push(r);else{let a=this._removeScriptInstance(r);a>=0&&this._resetExecutionOrder(a,this._scripts.length)}return this.system.app.scripts.off(`swap:${t}`,i.onSwap),delete this[t],this.fire("destroy",t,r||null),this.fire(`destroy:${t}`,r||null),r&&r.fire("destroy"),!0}swap(e){let t=e,s=e;typeof s=="string"?s=this.system.app.scripts.get(s):s&&(t=s.__name);let i=this._scriptsIndex[t];if(!i||!i.instance)return!1;let r=i.instance,a=this._scripts.indexOf(r),n=new s({app:this.system.app,entity:this.entity,enabled:r.enabled,attributes:r.__attributes});return n.swap?(this.initializeAttributes(n),this._scripts[a]=n,this._scriptsIndex[t].instance=n,this[t]=n,n.__executionOrder=a,r.update&&this._updateList.remove(r),r.postUpdate&&this._postUpdateList.remove(r),n.update&&this._updateList.insert(n),n.postUpdate&&this._postUpdateList.insert(n),this._scriptMethod(n,HZ,r),this.fire("swap",t,n),this.fire(`swap:${t}`,n),!0):!1}resolveDuplicatedEntityReferenceProperties(e,t){let s=this.entity.script;for(let i in e._scriptsIndex){let r=this.system.app.scripts.get(i);if(!r)continue;let a=e._scriptsIndex[i];if(!a||!a.instance)continue;let n=s[i].__attributesRaw??s._attributeDataMap.get(i),l=s[i].__attributes;if(!n&&!l)continue;let h=!!n,c=a.instance.__attributes??s._attributeDataMap.get(i);for(let f in c){if(!c[f])continue;let d=r.attributes?.get(f)??this.system.app.scripts.getSchema(i)?.attributes?.[f];if(d){if(d.type==="entity")this._resolveEntityScriptAttribute(d,f,c[f],h,n||l,t);else if(d.type==="json"&&Array.isArray(d.schema)){let u=c[f],p=n?n[f]:l[f];for(let _=0;_<d.schema.length;_++){let S=d.schema[_];if(S.type==="entity")if(d.array)for(let T=0;T<u.length;T++)this._resolveEntityScriptAttribute(S,S.name,u[T][S.name],h,p[T],t);else this._resolveEntityScriptAttribute(S,S.name,u[S.name],h,p,t)}}}}}}move(e,t){let s=this._scripts.length;if(t>=s||t<0)return!1;let i=e,r=e;typeof r!="string"?r=e.__name:i=null;let a=this._scriptsIndex[r];if(!a||!a.instance)return!1;let n=a.instance;if(i&&!(n instanceof i))return!1;let l=this._scripts.indexOf(n);return l===-1||l===t?!1:(this._scripts.splice(t,0,this._scripts.splice(l,1)[0]),this._resetExecutionOrder(0,s),this._updateList.sort(),this._postUpdateList.sort(),this.fire("move",r,n,t,l),this.fire(`move:${r}`,n,t,l),!0)}}});var KP,XZ=m(()=>{KP=class{constructor(){this.enabled=!0}}});var Xoe,Woe,Yoe,Koe,qoe,qP,Uc,xD=m(()=>{IE();Ut();vD();XZ();Xoe="_onInitializeAttributes",Woe="_onInitialize",Yoe="_onPostInitialize",Koe="_onUpdate",qoe="_onPostUpdate",qP=0,Uc=class extends Me{constructor(e){super(e),this.id="script",this.ComponentType=A_,this.DataType=KP,this._components=new yn({sortBy:"_executionOrder"}),this._enabledComponents=new yn({sortBy:"_executionOrder"}),this.preloading=!0,this.on("beforeremove",this._onBeforeRemove,this),this.app.systems.on("initialize",this._onInitialize,this),this.app.systems.on("postInitialize",this._onPostInitialize,this),this.app.systems.on("update",this._onUpdate,this),this.app.systems.on("postUpdate",this._onPostUpdate,this)}initializeComponentData(e,t){if(e._executionOrder=qP++,this._components.append(e),qP>Number.MAX_SAFE_INTEGER&&this._resetExecutionOrder(),e.enabled=t.hasOwnProperty("enabled")?!!t.enabled:!0,e.enabled&&e.entity.enabled&&this._enabledComponents.append(e),t.hasOwnProperty("order")&&t.hasOwnProperty("scripts")){e._scriptsData=t.scripts;for(let s=0;s<t.order.length;s++)e.create(t.order[s],{enabled:t.scripts[t.order[s]].enabled,attributes:t.scripts[t.order[s]].attributes,preloading:this.preloading})}}cloneComponent(e,t){let s=[],i={};for(let a=0;a<e.script._scripts.length;a++){let n=e.script._scripts[a],l=n.__scriptType.__name;s.push(l);let h=e.script._attributeDataMap?.get(l)||{};for(let c in n.__attributes)h[c]=n.__attributes[c];i[l]={enabled:n._enabled,attributes:h}}for(let a in e.script._scriptsIndex)a.awaiting&&s.splice(a.ind,0,a);let r={enabled:e.script.enabled,order:s,scripts:i};return this.addComponent(t,r)}_resetExecutionOrder(){qP=0;for(let e=0,t=this._components.length;e<t;e++)this._components.items[e]._executionOrder=qP++}_callComponentMethod(e,t,s){for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++)e.items[e.loopIndex][t](s)}_onInitialize(){this.preloading=!1,this._callComponentMethod(this._components,Xoe),this._callComponentMethod(this._enabledComponents,Woe)}_onPostInitialize(){this._callComponentMethod(this._enabledComponents,Yoe)}_onUpdate(e){this._callComponentMethod(this._enabledComponents,Koe,e)}_onPostUpdate(e){this._callComponentMethod(this._enabledComponents,qoe,e)}_addComponentToEnabled(e){this._enabledComponents.insert(e)}_removeComponentFromEnabled(e){this._enabledComponents.remove(e)}_onBeforeRemove(e,t){this._components.items.indexOf(t)>=0&&t._onBeforeRemove(),this._removeComponentFromEnabled(t),this._components.remove(t)}destroy(){super.destroy(),this.app.systems.off("initialize",this._onInitialize,this),this.app.systems.off("postInitialize",this._onPostInitialize,this),this.app.systems.off("update",this._onUpdate,this),this.app.systems.off("postUpdate",this._onPostUpdate,this)}}});var Id,yD=m(()=>{J();Pb();rt();FT();We();Id=class extends ae{constructor(e,t){super(e,t),this._layers=[ms],this._instance=null,this._materialTmp=null,this._highQualitySH=!0,this._customAabb=null,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._castShadows=!1,this._assetReference=new Oa("asset",this,e.app.assets,{add:this._onGSplatAssetAdded,load:this._onGSplatAssetLoad,remove:this._onGSplatAssetRemove,unload:this._onGSplatAssetUnload},this),t.on("remove",this.onRemoveChild,this),t.on("removehierarchy",this.onRemoveChild,this),t.on("insert",this.onInsertChild,this),t.on("inserthierarchy",this.onInsertChild,this)}set customAabb(e){this._customAabb=e,this._instance?.meshInstance?.setCustomAabb(this._customAabb)}get customAabb(){return this._customAabb}set instance(e){if(this.destroyInstance(),this._instance=e,this._instance){let t=this._instance.meshInstance;t.node||(t.node=this.entity),t.castShadow=this._castShadows,t.setCustomAabb(this._customAabb),this.enabled&&this.entity.enabled&&this.addToLayers()}}get instance(){return this._instance}set material(e){this._instance?this._instance.material=e:this._materialTmp=e}get material(){return this._instance?.material??this._materialTmp??null}set highQualitySH(e){e!==this._highQualitySH&&(this._highQualitySH=e,this._instance&&this._instance.setHighQualitySH(e))}get highQualitySH(){return this._highQualitySH}set castShadows(e){if(this._castShadows!==e){let t=this.instance?.meshInstance;if(t){let s=this.layers,i=this.system.app.scene;if(this._castShadows&&!e)for(let r=0;r<s.length;r++){let a=i.layers.getLayerById(this.layers[r]);a&&a.removeShadowCasters([t])}if(t.castShadow=e,!this._castShadows&&e)for(let r=0;r<s.length;r++){let a=i.layers.getLayerById(s[r]);a&&a.addShadowCasters([t])}}this._castShadows=e}}get castShadows(){return this._castShadows}set layers(e){this.removeFromLayers(),this._layers.length=0;for(let t=0;t<e.length;t++)this._layers[t]=e[t];!this.enabled||!this.entity.enabled||this.addToLayers()}get layers(){return this._layers}set asset(e){let t=e instanceof re?e.id:e;this._assetReference.id!==t&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onGSplatAssetRemove(),this._assetReference.id=t,this._assetReference.asset&&this._onGSplatAssetAdded())}get asset(){return this._assetReference.id}destroyInstance(){this._instance&&(this.removeFromLayers(),this._instance?.destroy(),this._instance=null)}addToLayers(){let e=this.instance?.meshInstance;if(e){let t=this.system.app.scene.layers;for(let s=0;s<this._layers.length;s++)t.getLayerById(this._layers[s])?.addMeshInstances([e])}}removeFromLayers(){let e=this.instance?.meshInstance;if(e){let t=this.system.app.scene.layers;for(let s=0;s<this._layers.length;s++)t.getLayerById(this._layers[s])?.removeMeshInstances([e])}}onRemoveChild(){this.removeFromLayers()}onInsertChild(){this._instance&&this.enabled&&this.entity.enabled&&this.addToLayers()}onRemove(){this.destroyInstance(),this.asset=null,this._assetReference.id=null,this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(e,t){this.addToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||this._instance&&e.addMeshInstances(this._instance.meshInstance)}onLayerRemoved(e){this.layers.indexOf(e.id)<0||this._instance&&e.removeMeshInstances(this._instance.meshInstance)}onEnable(){let e=this.system.app.scene,t=e.layers;this._evtLayersChanged=e.on("set:layers",this.onLayersChanged,this),t&&(this._evtLayerAdded=t.on("add",this.onLayerAdded,this),this._evtLayerRemoved=t.on("remove",this.onLayerRemoved,this)),this._instance?this.addToLayers():this.asset&&this._onGSplatAssetAdded()}onDisable(){let t=this.system.app.scene.layers;this._evtLayersChanged?.off(),this._evtLayersChanged=null,t&&(this._evtLayerAdded?.off(),this._evtLayerAdded=null,this._evtLayerRemoved?.off(),this._evtLayerRemoved=null),this.removeFromLayers()}hide(){this._instance&&(this._instance.meshInstance.visible=!1)}show(){this._instance&&(this._instance.meshInstance.visible=!0)}_onGSplatAssetAdded(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onGSplatAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset))}_onGSplatAssetLoad(){this.destroyInstance();let e=this._assetReference.asset;e&&(this.instance=new Tp(e.resource,{material:this._materialTmp,highQualitySH:this._highQualitySH}),this._materialTmp=null,this.customAabb=this.instance.resource.aabb.clone())}_onGSplatAssetUnload(){this.destroyInstance()}_onGSplatAssetRemove(){this._onGSplatAssetUnload()}}});var jP,WZ=m(()=>{jP=class{constructor(){this.enabled=!0}}});var AD,qT,Bc,PD=m(()=>{Q();Vt();We();Ut();yD();WZ();AD=["enabled"],qT=["castShadows","material","highQualitySH","asset","layers"],Bc=class extends Me{constructor(e){super(e),this.id="gsplat",this.ComponentType=Id,this.DataType=jP,this.schema=AD,this.on("beforeremove",this.onRemove,this)}initializeComponentData(e,t,s){t.layers&&t.layers.length&&(t.layers=t.layers.slice(0));for(let i=0;i<qT.length;i++)t.hasOwnProperty(qT[i])&&(e[qT[i]]=t[qT[i]]);t.aabbCenter&&t.aabbHalfExtents&&(e.customAabb=new _e(new g(t.aabbCenter),new g(t.aabbHalfExtents))),super.initializeComponentData(e,t,AD)}cloneComponent(e,t){let s=e.gsplat,i={};qT.forEach(a=>{a==="material"?i[a]=s[a].clone():i[a]=s[a]}),i.enabled=s.enabled;let r=this.addComponent(t,i);return s.customAabb&&(r.customAabb=s.customAabb.clone()),r}onRemove(e,t){t.onRemove()}};ae._buildAccessors(Id.prototype,AD)});var P_,RD=m(()=>{Pe();P_=class extends K{static{this.EVENT_SETMESHES="set:meshes"}set meshes(e){this.decRefMeshes(),this._meshes=e,this.incRefMeshes(),this.fire("set:meshes",e)}get meshes(){return this._meshes}destroy(){this.meshes=null}decRefMeshes(){this._meshes?.forEach((e,t)=>{e&&(e.decRefCount(),e.refCount<1&&(e.destroy(),this._meshes[t]=null))})}incRefMeshes(){this._meshes?.forEach(e=>{e?.incRefCount()})}constructor(...e){super(...e),this._meshes=null}}});function $P(o){let e=this;if(!e.resource)return;let t=o.resource,s=t.renders&&t.renders[e.data.renderIndex];s&&(e.resource.meshes=s.resource.meshes)}function YZ(o){let e=this;e.registry.off(`load:${o.id}`,$P,e),e.registry.on(`load:${o.id}`,$P,e),e.registry.off(`remove:${o.id}`,KZ,e),e.registry.once(`remove:${o.id}`,KZ,e),o.resource?$P.call(e,o):e.registry.load(o)}function KZ(o){let e=this;e.registry.off(`load:${o.id}`,$P,e),e.resource&&e.resource.destroy()}var R_,CD=m(()=>{RD();_t();R_=class extends ye{constructor(e){super(e,"render"),this._registry=e.assets}open(e,t){return new P_}patch(e,t){if(!e.data.containerAsset)return;let s=t.get(e.data.containerAsset);if(!s){t.once(`add:${e.data.containerAsset}`,YZ,e);return}YZ.call(e,s)}}});var Vc,ZP=m(()=>{Vc=class{constructor(e,t,s,i){this._paths=e,this._input=t,this._output=s,this._interpolation=i}get paths(){return this._paths}get input(){return this._input}get output(){return this._output}get interpolation(){return this._interpolation}}});var Po,QP=m(()=>{Po=class{constructor(e,t){this._components=e,this._data=t}get components(){return this._components}get data(){return this._data}}});function qZ(o,e){let t,r=(u,p)=>{switch(p){case t.DT_INT8:return new Int8Array(u.buffer,u.byteOffset,u.byteLength);case t.DT_INT16:return new Int16Array(u.buffer,u.byteOffset,u.byteLength/2);case t.DT_INT32:return new Int32Array(u.buffer,u.byteOffset,u.byteLength/4);case t.DT_UINT8:return new Uint8Array(u.buffer,u.byteOffset,u.byteLength);case t.DT_UINT16:return new Uint16Array(u.buffer,u.byteOffset,u.byteLength/2);case t.DT_UINT32:return new Uint32Array(u.buffer,u.byteOffset,u.byteLength/4);case t.DT_FLOAT32:return new Float32Array(u.buffer,u.byteOffset,u.byteLength/4)}return null},a=u=>{switch(u){case t.DT_INT8:return 1;case t.DT_INT16:return 2;case t.DT_INT32:return 4;case t.DT_UINT8:return 1;case t.DT_UINT16:return 2;case t.DT_UINT32:return 4;case t.DT_FLOAT32:return 4}return 1},n=u=>u.num_components()*a(u.data_type()),l={0:0,1:1,5:2,2:3,7:4,8:5,4:6,3:7},h=(u,p)=>{let _=(M,U,G)=>{M[0]=U[0]-G[0],M[1]=U[1]-G[1],M[2]=U[2]-G[2]},S=(M,U,G)=>{M[0]=U[1]*G[2]-G[1]*U[2],M[1]=U[2]*G[0]-G[2]*U[0],M[2]=U[0]*G[1]-G[0]*U[1]},T=(M,U)=>{let G=M[U+0],$=M[U+1],X=M[U+2],I=1/Math.sqrt(G*G+$*$+X*X);M[U+0]*=I,M[U+1]*=I,M[U+2]*=I},x=(M,U,G)=>{for(let $=0;$<3;++$)M[$]=U[G+$]},A=p.length/3,E=u.length/3,v=new Float32Array(u.length),R=[0,0,0],P=[0,0,0],y=[0,0,0],C=[0,0,0],L=[0,0,0],O=[0,0,0];for(let M=0;M<A;++M){let U=p[M*3+0]*3,G=p[M*3+1]*3,$=p[M*3+2]*3;x(R,u,U),x(P,u,G),x(y,u,$),_(C,P,R),_(L,y,R),S(O,C,L),T(O,0);for(let X=0;X<3;++X)v[U+X]+=O[X],v[G+X]+=O[X],v[$+X]+=O[X]}for(let M=0;M<E;++M)T(v,M*3);return new Uint8Array(v.buffer)},c=u=>{let p={},_=new t.DecoderBuffer;_.Init(u,u.length);let S=new t.Decoder;if(S.GetEncodedGeometryType(_)!==t.TRIANGULAR_MESH)return p.error="Failed to decode draco mesh: not a mesh",p;let T=new t.Mesh,x=S.DecodeBufferToMesh(_,T);if(!x||!x.ok()||t.getPointer(T)===0)return p.error="Failed to decode draco asset",p;let A=T.num_faces()*3,E=T.num_points()<=65535,v=A*(E?2:4),R=t._malloc(v);E?(S.GetTrianglesUInt16Array(T,v,R),p.indices=new Uint16Array(t.HEAPU16.buffer,R,A).slice().buffer):(S.GetTrianglesUInt32Array(T,v,R),p.indices=new Uint32Array(t.HEAPU32.buffer,R,A).slice().buffer),t._free(R);let P=[];for(let U=0;U<T.num_attributes();++U)P.push(S.GetAttribute(T,U));P.sort((U,G)=>(l[U.attribute_type()]??l.length)-(l[G.attribute_type()]??l.length)),p.attributes=P.map(U=>U.unique_id());let y=0,C=P.map(U=>{let G=y;return y+=Math.ceil(n(U)/4)*4,G}),L=P.some(U=>U.attribute_type()===1),O=C[1];if(!L){for(let U=1;U<C.length;++U)C[U]+=12;y+=12}p.vertices=new ArrayBuffer(T.num_points()*y);let M=new Uint8Array(p.vertices);for(let U=0;U<T.num_attributes();++U){let G=P[U],$=n(G),X=T.num_points()*$,I=t._malloc(X);S.GetAttributeDataArrayForAllPoints(T,G,G.data_type(),X,I);let b=new Uint8Array(t.HEAPU8.buffer,I,X);for(let F=0;F<T.num_points();++F)for(let B=0;B<$;++B)M[F*y+C[U]+B]=b[F*$+B];if(!L&&G.attribute_type()===0){let F=h(r(b,G.data_type()),E?new Uint16Array(p.indices):new Uint32Array(p.indices));for(let B=0;B<T.num_points();++B)for(let V=0;V<12;++V)M[B*y+O+V]=F[B*12+V]}t._free(I)}return t.destroy(T),t.destroy(S),t.destroy(_),p},f=u=>{let p=c(new Uint8Array(u.buffer));self.postMessage({jobId:u.jobId,error:p.error,indices:p.indices,vertices:p.vertices,attributes:p.attributes},[p.indices,p.vertices].filter(_=>_!=null))},d=[];self.onmessage=u=>{let p=u.data;switch(p.type){case"init":self.DracoDecoderModule({instantiateWasm:(_,S)=>(WebAssembly.instantiate(p.module,_).then(T=>S(T)).catch(T=>console.error(`instantiate failed + ${T}`)),{})}).then(_=>{t=_,d.forEach(S=>f(S))});break;case"decodeMesh":t?f(p):d.push(p);break}}}var jZ=m(()=>{});var $Z,ID,joe,$oe,ZZ,JP,wD,QZ,JZ,eQ,LD=m(()=>{RE();jZ();Ct();$Z=3,ID=class{constructor(){this.workers=[[],[],[]],this.jobId=0,this.jobQueue=[],this.jobCallbacks=new Map,this.run=(e,t)=>{e.postMessage({type:"decodeMesh",jobId:t.jobId,buffer:t.buffer},[t.buffer])}}init(e){for(e.forEach(t=>{t.addEventListener("message",s=>{let i=s.data,r=this.jobCallbacks.get(i.jobId);if(r&&r(i.error,{indices:i.indices,vertices:i.vertices,attributes:i.attributes}),this.jobCallbacks.delete(i.jobId),this.jobQueue.length>0){let a=this.jobQueue.shift();this.run(t,a)}else{let a=this.workers[2].indexOf(t);if(a!==-1)this.workers[2].splice(a,1),this.workers[1].push(t);else{let n=this.workers[1].indexOf(t);n!==-1&&(this.workers[1].splice(n,1),this.workers[0].push(t))}}})}),this.workers[0]=e;this.jobQueue.length&&(this.workers[0].length||this.workers[1].length);){let t=this.jobQueue.shift();if(this.workers[0].length>0){let s=this.workers[0].shift();this.workers[1].push(s),this.run(s,t)}else{let s=this.workers[1].shift();this.workers[2].push(s),this.run(s,t)}}}enqueueJob(e,t){let s={jobId:this.jobId++,buffer:e};if(this.jobCallbacks.set(s.jobId,t),this.workers[0].length>0){let i=this.workers[0].shift();this.workers[1].push(i),this.run(i,s)}else if(this.workers[1].length>0){let i=this.workers[1].shift();this.workers[2].push(i),this.run(i,s)}else this.jobQueue.push(s)}},joe=o=>new Promise((e,t)=>{let s={cache:!0,responseType:"text",retry:$Z>0,maxRetries:$Z};Le.get(o,s,(i,r)=>{i?t(i):e(r)})}),$oe=o=>{let e=()=>fetch(o).then(s=>s.arrayBuffer()).then(s=>WebAssembly.compile(s)),t=()=>WebAssembly.compileStreaming(fetch(o)).catch(s=>e());return WebAssembly.compileStreaming?t():e()},ZZ=1,QZ=o=>{if(JP)return!0;if(!o)if(wD)o=wD;else{let e=Wl.getConfig("DracoDecoderModule");e?o={jsUrl:e.glueUrl,wasmUrl:e.wasmUrl,numWorkers:e.numWorkers}:o={jsUrl:"draco.wasm.js",wasmUrl:"draco.wasm.wasm",numWorkers:ZZ}}return!o.jsUrl||!o.wasmUrl?!1:(JP=new ID,Promise.all([joe(o.jsUrl),$oe(o.wasmUrl)]).then(([e,t])=>{let s=["/* draco */",e,"/* worker */",`(
${qZ.toString()}
)()

`].join(`
`),i=new Blob([s],{type:"application/javascript"}),r=URL.createObjectURL(i),a=Math.max(1,Math.min(16,o.numWorkers||ZZ)),n=[];for(let l=0;l<a;++l){let h=new Worker(r);h.postMessage({type:"init",module:t}),n.push(h)}JP.init(n)}),!0)},JZ=o=>{o?.lazyInit?wD=o:QZ(o)},eQ=(o,e)=>QZ()?(JP.enqueueJob(o,e),!0):!1});var bD,sQ,Zoe,jT,sR,Qoe,Joe,tR,tQ,ele,MD,wd,w_,DD,iQ,tle,sle,ile,rle,ale,nle,ole,lle,hle,Ns,cle,fle,dle,ule,mle,ple,_le,gle,Sle,Tle,Ele,vle,rQ,xle,eR,C_,yle,Ale,Ple,Rle,Cle,Ile,wle,Lle,ble,Mle,Dle,Ole,Nle,Fle,Ule,Ble,Vle,I_,kle,Gle,zle,Hle,Xle,Wle,Yle,wl,iR=m(()=>{Fs();De();Ke();me();Ne();Q();Vt();j();vh();Fe();$i();Cr();Ct();J();Zt();dA();Ws();eT();mA();an();RD();NA();ln();ci();ZP();QP();gl();rt();Ap();LD();Ve();bD=class{destroy(){this.renders&&this.renders.forEach(e=>{e.meshes=null})}},sQ=o=>/^data:[^\n\r,\u2028\u2029]*,.*$/i.test(o),Zoe=o=>o.substring(o.indexOf(":")+1,o.indexOf(";")),jT=o=>{switch(o){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 3}},sR=o=>{switch(o){case 5120:return Ps;case 5121:return zs;case 5122:return Rs;case 5123:return mi;case 5124:return ke;case 5125:return gt;case 5126:return pe;default:return 0}},Qoe=o=>{switch(o){case 5120:return 1;case 5121:return 1;case 5122:return 2;case 5123:return 2;case 5124:return 4;case 5125:return 4;case 5126:return 4;default:return 0}},Joe=o=>{switch(o){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:return null}},tR={POSITION:te,NORMAL:Pt,TANGENT:as,COLOR_0:nt,JOINTS_0:Gt,WEIGHTS_0:hs,TEXCOORD_0:ot,TEXCOORD_1:ks,TEXCOORD_2:jr,TEXCOORD_3:$r,TEXCOORD_4:Zr,TEXCOORD_5:Qr,TEXCOORD_6:Jr,TEXCOORD_7:ea},tQ={[te]:0,[Pt]:1,[as]:2,[nt]:3,[Gt]:4,[hs]:5,[ot]:6,[ks]:7,[jr]:8,[$r]:9,[Zr]:10,[Qr]:11,[Jr]:12,[ea]:13},ele=o=>{switch(o){case Ps:return e=>Math.max(e/127,-1);case zs:return e=>e/255;case Rs:return e=>Math.max(e/32767,-1);case mi:return e=>e/65535;default:return e=>e}},MD=(o,e,t)=>{let s=ele(t),i=e.length;for(let r=0;r<i;++r)o[r]=s(e[r]);return o},wd=(o,e,t=!1)=>{let s=jT(o.type),i=Joe(o.componentType);if(!i)return null;let r;if(o.sparse){let a=o.sparse,n={count:a.count,type:"SCALAR"},l=wd(Object.assign(n,a.indices),e,!0),h={count:a.count,type:o.type,componentType:o.componentType},c=wd(Object.assign(h,a.values),e,!0);if(o.hasOwnProperty("bufferView")){let f={bufferView:o.bufferView,byteOffset:o.byteOffset,componentType:o.componentType,count:o.count,type:o.type};r=wd(f,e,!0).slice()}else r=new i(o.count*s);for(let f=0;f<a.count;++f){let d=l[f];for(let u=0;u<s;++u)r[d*s+u]=c[f*s+u]}}else if(o.hasOwnProperty("bufferView")){let a=e[o.bufferView];if(t&&a.hasOwnProperty("byteStride")){let n=s*i.BYTES_PER_ELEMENT,l=new ArrayBuffer(o.count*n),h=new Uint8Array(l),c=0;for(let f=0;f<o.count;++f){let d=(o.byteOffset||0)+f*a.byteStride;for(let u=0;u<n;++u)h[c++]=a[d++]}r=new i(l)}else r=new i(a.buffer,a.byteOffset+(o.byteOffset||0),o.count*s)}else r=new i(o.count*s);return r},w_=(o,e)=>{let t=wd(o,e,!0);if(t instanceof Float32Array||!o.normalized)return t;let s=new Float32Array(t.length);return MD(s,t,sR(o.componentType)),s},DD=o=>{let e=o.min,t=o.max;if(!e||!t)return null;if(o.normalized){let s=sR(o.componentType);e=MD([],e,s),t=MD([],t,s)}return new _e(new g((t[0]+e[0])*.5,(t[1]+e[1])*.5,(t[2]+e[2])*.5),new g((t[0]-e[0])*.5,(t[1]-e[1])*.5,(t[2]-e[2])*.5))},iQ=o=>{if(!o.hasOwnProperty("mode"))return As;switch(o.mode){case 0:return qr;case 1:return Mn;case 2:return Cu;case 3:return nh;case 4:return As;case 5:return rs;case 6:return Wi;default:return As}},tle=o=>{let e=new Uint16Array(o);for(let t=0;t<o;t++)e[t]=t;return e},sle=(o,e)=>{let t=o[te];if(!t||t.components!==3)return;let s;if(t.size!==t.stride){let n=t.stride/$n[t.type],l=new Xa[t.type](t.buffer,t.offset,t.count*n);s=new Xa[t.type](t.count*3);for(let h=0;h<t.count;++h)s[h*3+0]=l[h*n+0],s[h*3+1]=l[h*n+1],s[h*3+2]=l[h*n+2]}else s=new Xa[t.type](t.buffer,t.offset,t.count*3);let i=t.count;e||(e=tle(i));let r=Jm(s,e),a=new Float32Array(r.length);a.set(r),o[Pt]={buffer:a.buffer,size:12,offset:0,stride:12,count:i,components:3,type:pe}},ile=o=>{let e=s=>{let i=[];for(let r=0;r<s._levels.length;++r){let a=[];if(s.cubemap)for(let n=0;n<6;++n)a.push(s._levels[r][n]);else a=s._levels[r];i.push(a)}return i},t=new q(o.device,o);return t._levels=e(o),t},rle=o=>{let e=new re(`${o.name}_clone`,o.type,o.file,o.data,o.options);return e.loaded=!0,e.resource=ile(o.resource),o.registry.add(e),e},ale=(o,e)=>{let t=e[te];if(!t)return null;let s=t.count,i=[];for(let T in e)if(e.hasOwnProperty(T)){let x={semantic:T,components:e[T].components,type:e[T].type,normalize:!!e[T].normalize};Tt.isElementValid(o,x)||x.components++,i.push(x)}i.sort((T,x)=>tQ[T.semantic]-tQ[x.semantic]);let r,a,n,l,h,c,f=new Tt(o,i),d=!0;for(r=0;r<f.elements.length;++r)if(h=f.elements[r],l=e[h.name],c=l.offset-t.offset,l.buffer!==t.buffer||l.stride!==h.stride||l.size!==h.size||c!==h.offset){d=!1;break}let u=new mt(o,f,s),p=u.lock(),_=new Uint32Array(p),S;if(d)S=new Uint32Array(t.buffer,t.offset,s*u.format.size/4),_.set(S);else{let T,x;for(r=0;r<u.format.elements.length;++r){h=u.format.elements[r],T=h.stride/4,l=e[h.name],x=l.stride/4,S=new Uint32Array(l.buffer,l.offset,(l.count-1)*x+(l.size+3)/4);let A=0,E=h.offset/4,v=Math.floor((l.size+3)/4);for(a=0;a<s;++a){for(n=0;n<v;++n)_[E+n]=S[A+n];A+=x,E+=T}}}return u.unlock(),u},nle=(o,e,t,s,i,r)=>{let a={},n=[];for(let c in e)e.hasOwnProperty(c)&&tR.hasOwnProperty(c)&&(a[c]=e[c],n.push(`${c}:${e[c]}`));n.sort();let l=n.join(),h=r[l];if(!h){let c={};for(let f in a){let d=s[e[f]],u=wd(d,i),p=i[d.bufferView],_=tR[f],S=jT(d.type)*Qoe(d.componentType),T=p&&p.hasOwnProperty("byteStride")?p.byteStride:S;c[_]={buffer:u.buffer,size:S,offset:u.byteOffset,stride:T,count:d.count,components:jT(d.type),type:sR(d.componentType),normalize:d.normalized}}c.hasOwnProperty(Pt)||sle(c,t),h=ale(o,c),r[l]=h}return h},ole=(o,e,t,s,i,r)=>{let a,n,l,h=e.joints,c=h.length,f=[];if(e.hasOwnProperty("inverseBindMatrices")){let _=e.inverseBindMatrices,S=wd(t[_],s,!0),T=[];for(a=0;a<c;a++){for(n=0;n<16;n++)T[n]=S[a*16+n];l=new k,l.set(T),f.push(l)}}else for(a=0;a<c;a++)l=new k,f.push(l);let d=[];for(a=0;a<c;a++)d[a]=i[h[a]].name;let u=d.join("#"),p=r.get(u);return p||(p=new ec(o,f,d),r.set(u,p)),p},lle=(o,e,t,s,i,r,a)=>{let n=new Ce(o);n.aabb=DD(t[e.attributes.POSITION]);let l=[];for(let[h,c]of Object.entries(e.attributes)){let f=t[c],d=tR[h],u=sR(f.componentType);l.push({semantic:d,components:jT(f.type),type:u,normalize:f.normalized??(d===nt&&(u===zs||u===mi))})}if(a.push(new Promise((h,c)=>{let f=e.extensions.KHR_draco_mesh_compression;eQ(s[f.bufferView].slice().buffer,(d,u)=>{if(d)console.log(d),c(d);else{let p={};for(let[v,R]of Object.entries(f.attributes))p[tR[v]]=u.attributes.indexOf(R);l.sort((v,R)=>p[v.semantic]-p[R.semantic]),e.attributes?.NORMAL||l.splice(1,0,{semantic:"NORMAL",components:3,type:pe});let _=new Tt(o,l),S=u.vertices.byteLength/_.size,T=S<=65535?1:2,x=u.indices.byteLength/(S<=65535?2:4),A=new mt(o,_,S,{data:u.vertices}),E=new Ls(o,T,x,0,u.indices);n.vertexBuffer=A,n.indexBuffer[0]=E,n.primitive[0].type=iQ(e),n.primitive[0].base=0,n.primitive[0].count=E?x:S,n.primitive[0].indexed=!!E,h()}})})),e?.extensions?.KHR_materials_variants){let h=e.extensions.KHR_materials_variants,c={};h.mappings.forEach(f=>{f.variants.forEach(d=>{c[d]=f.material})}),i[n.id]=c}return r[n.id]=e.material,n},hle=(o,e,t,s,i,r,a,n,l)=>{let h=[];return e.primitives.forEach(c=>{if(c.extensions?.KHR_draco_mesh_compression)h.push(lle(o,c,t,s,r,a,l));else{let f=c.hasOwnProperty("indices")?wd(t[c.indices],s,!0):null,d=nle(o,c.attributes,f,t,s,i),u=iQ(c),p=new Ce(o);if(p.vertexBuffer=d,p.primitive[0].type=u,p.primitive[0].base=0,p.primitive[0].indexed=f!==null,f!==null){let S;f instanceof Uint8Array?S=0:f instanceof Uint16Array?S=1:S=2,S===0&&o.isWebGPU&&(S=1,f=new Uint16Array(f));let T=new Ls(o,S,f.length,0,f);p.indexBuffer[0]=T,p.primitive[0].count=f.length}else p.primitive[0].count=d.numVertices;if(c.hasOwnProperty("extensions")&&c.extensions.hasOwnProperty("KHR_materials_variants")){let S=c.extensions.KHR_materials_variants,T={};S.mappings.forEach(x=>{x.variants.forEach(A=>{T[A]=x.material})}),r[p.id]=T}a[p.id]=c.material;let _=t[c.attributes.POSITION];if(p.aabb=DD(_),c.hasOwnProperty("targets")){let S=[];c.targets.forEach((T,x)=>{let A={};T.hasOwnProperty("POSITION")&&(_=t[T.POSITION],A.deltaPositions=w_(_,s),A.aabb=DD(_)),T.hasOwnProperty("NORMAL")&&(_=t[T.NORMAL],A.deltaNormals=w_(_,s)),e.hasOwnProperty("extras")&&e.extras.hasOwnProperty("targetNames")?A.name=e.extras.targetNames[x]:A.name=x.toString(10),e.hasOwnProperty("weights")&&(A.defaultWeight=e.weights[x]),A.preserveData=n.morphPreserveData,S.push(new jh(A))}),p.morph=new po(S,o,{preferHighPrecision:n.morphPreferHighPrecision})}h.push(p)}}),h},Ns=(o,e,t)=>{let s,i=o.texCoord;if(i)for(s=0;s<t.length;++s)e[`${t[s]}MapUv`]=i;let r=[0,0],a=[1,1],n=o.extensions?.KHR_texture_transform;if(n){let l=n.offset||r,h=n.scale||a,c=n.rotation?-n.rotation*w.RAD_TO_DEG:0,f=new D(h[0],h[1]),d=new D(l[0],1-h[1]-l[1]);for(s=0;s<t.length;++s)e[`${t[s]}MapTiling`]=f,e[`${t[s]}MapOffset`]=d,e[`${t[s]}MapRotation`]=c}},cle=(o,e,t)=>{let s,i;if(o.hasOwnProperty("diffuseFactor")?(s=o.diffuseFactor,e.diffuse.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2)),e.opacity=s[3]):(e.diffuse.set(1,1,1),e.opacity=1),o.hasOwnProperty("diffuseTexture")){let r=o.diffuseTexture;i=t[r.index],e.diffuseMap=i,e.diffuseMapChannel="rgb",e.opacityMap=i,e.opacityMapChannel="a",Ns(r,e,["diffuse","opacity"])}if(e.useMetalness=!1,o.hasOwnProperty("specularFactor")?(s=o.specularFactor,e.specular.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))):e.specular.set(1,1,1),o.hasOwnProperty("glossinessFactor")?e.gloss=o.glossinessFactor:e.gloss=1,o.hasOwnProperty("specularGlossinessTexture")){let r=o.specularGlossinessTexture;e.specularMap=e.glossMap=t[r.index],e.specularMapChannel="rgb",e.glossMapChannel="a",Ns(r,e,["gloss","metalness"])}},fle=(o,e,t)=>{if(o.hasOwnProperty("clearcoatFactor")?e.clearCoat=o.clearcoatFactor*.25:e.clearCoat=0,o.hasOwnProperty("clearcoatTexture")){let s=o.clearcoatTexture;e.clearCoatMap=t[s.index],e.clearCoatMapChannel="r",Ns(s,e,["clearCoat"])}if(o.hasOwnProperty("clearcoatRoughnessFactor")?e.clearCoatGloss=o.clearcoatRoughnessFactor:e.clearCoatGloss=0,o.hasOwnProperty("clearcoatRoughnessTexture")){let s=o.clearcoatRoughnessTexture;e.clearCoatGlossMap=t[s.index],e.clearCoatGlossMapChannel="g",Ns(s,e,["clearCoatGloss"])}if(o.hasOwnProperty("clearcoatNormalTexture")){let s=o.clearcoatNormalTexture;e.clearCoatNormalMap=t[s.index],Ns(s,e,["clearCoatNormal"]),s.hasOwnProperty("scale")?e.clearCoatBumpiness=s.scale:e.clearCoatBumpiness=1}e.clearCoatGlossInvert=!0},dle=(o,e,t)=>{e.useLighting=!1,e.emissive.copy(e.diffuse),e.emissiveMap=e.diffuseMap,e.emissiveMapUv=e.diffuseMapUv,e.emissiveMapTiling.copy(e.diffuseMapTiling),e.emissiveMapOffset.copy(e.diffuseMapOffset),e.emissiveMapRotation=e.diffuseMapRotation,e.emissiveMapChannel=e.diffuseMapChannel,e.emissiveVertexColor=e.diffuseVertexColor,e.emissiveVertexColorChannel=e.diffuseVertexColorChannel,e.useLighting=!1,e.useSkybox=!1,e.diffuse.set(1,1,1),e.diffuseMap=null,e.diffuseVertexColor=!1},ule=(o,e,t)=>{if(e.useMetalnessSpecularColor=!0,o.hasOwnProperty("specularColorTexture")&&(e.specularMap=t[o.specularColorTexture.index],e.specularMapChannel="rgb",Ns(o.specularColorTexture,e,["specular"])),o.hasOwnProperty("specularColorFactor")){let s=o.specularColorFactor;e.specular.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))}else e.specular.set(1,1,1);o.hasOwnProperty("specularFactor")?e.specularityFactor=o.specularFactor:e.specularityFactor=1,o.hasOwnProperty("specularTexture")&&(e.specularityFactorMapChannel="a",e.specularityFactorMap=t[o.specularTexture.index],Ns(o.specularTexture,e,["specularityFactor"]))},mle=(o,e,t)=>{o.hasOwnProperty("ior")&&(e.refractionIndex=1/o.ior)},ple=(o,e,t)=>{o.hasOwnProperty("dispersion")&&(e.dispersion=o.dispersion)},_le=(o,e,t)=>{e.blendType=es,e.useDynamicRefraction=!0,o.hasOwnProperty("transmissionFactor")&&(e.refraction=o.transmissionFactor),o.hasOwnProperty("transmissionTexture")&&(e.refractionMapChannel="r",e.refractionMap=t[o.transmissionTexture.index],Ns(o.transmissionTexture,e,["refraction"]))},gle=(o,e,t)=>{if(e.useSheen=!0,o.hasOwnProperty("sheenColorFactor")){let s=o.sheenColorFactor;e.sheen.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))}else e.sheen.set(1,1,1);o.hasOwnProperty("sheenColorTexture")&&(e.sheenMap=t[o.sheenColorTexture.index],Ns(o.sheenColorTexture,e,["sheen"])),e.sheenGloss=o.hasOwnProperty("sheenRoughnessFactor")?o.sheenRoughnessFactor:0,o.hasOwnProperty("sheenRoughnessTexture")&&(e.sheenGlossMap=t[o.sheenRoughnessTexture.index],e.sheenGlossMapChannel="a",Ns(o.sheenRoughnessTexture,e,["sheenGloss"])),e.sheenGlossInvert=!0},Sle=(o,e,t)=>{if(e.blendType=es,e.useDynamicRefraction=!0,o.hasOwnProperty("thicknessFactor")&&(e.thickness=o.thicknessFactor),o.hasOwnProperty("thicknessTexture")&&(e.thicknessMap=t[o.thicknessTexture.index],e.thicknessMapChannel="g",Ns(o.thicknessTexture,e,["thickness"])),o.hasOwnProperty("attenuationDistance")&&(e.attenuationDistance=o.attenuationDistance),o.hasOwnProperty("attenuationColor")){let s=o.attenuationColor;e.attenuation.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))}},Tle=(o,e,t)=>{o.hasOwnProperty("emissiveStrength")&&(e.emissiveIntensity=o.emissiveStrength)},Ele=(o,e,t)=>{e.useIridescence=!0,o.hasOwnProperty("iridescenceFactor")&&(e.iridescence=o.iridescenceFactor),o.hasOwnProperty("iridescenceTexture")&&(e.iridescenceMapChannel="r",e.iridescenceMap=t[o.iridescenceTexture.index],Ns(o.iridescenceTexture,e,["iridescence"])),o.hasOwnProperty("iridescenceIor")&&(e.iridescenceRefractionIndex=o.iridescenceIor),o.hasOwnProperty("iridescenceThicknessMinimum")&&(e.iridescenceThicknessMin=o.iridescenceThicknessMinimum),o.hasOwnProperty("iridescenceThicknessMaximum")&&(e.iridescenceThicknessMax=o.iridescenceThicknessMaximum),o.hasOwnProperty("iridescenceThicknessTexture")&&(e.iridescenceThicknessMapChannel="g",e.iridescenceThicknessMap=t[o.iridescenceThicknessTexture.index],Ns(o.iridescenceThicknessTexture,e,["iridescenceThickness"]))},vle=(o,e,t)=>{if(e.enableGGXSpecular=!0,o.hasOwnProperty("anisotropyStrength")?e.anisotropyIntensity=o.anisotropyStrength:e.anisotropyIntensity=0,o.hasOwnProperty("anisotropyTexture")){let s=o.anisotropyTexture;e.anisotropyMap=t[s.index],Ns(s,e,["anisotropy"])}o.hasOwnProperty("anisotropyRotation")?e.anisotropyRotation=o.anisotropyRotation*w.RAD_TO_DEG:e.anisotropyRotation=0},rQ=(o,e)=>{let t=new ct;o.hasOwnProperty("name")&&(t.name=o.name),t.occludeSpecular=en,t.diffuseVertexColor=!0,t.specularTint=!0,t.specularVertexColor=!0,t.specular.set(1,1,1),t.gloss=1,t.glossInvert=!0,t.useMetalness=!0;let s,i;if(o.hasOwnProperty("pbrMetallicRoughness")){let a=o.pbrMetallicRoughness;if(a.hasOwnProperty("baseColorFactor")&&(s=a.baseColorFactor,t.diffuse.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2)),t.opacity=s[3]),a.hasOwnProperty("baseColorTexture")){let n=a.baseColorTexture;i=e[n.index],t.diffuseMap=i,t.diffuseMapChannel="rgb",t.opacityMap=i,t.opacityMapChannel="a",Ns(n,t,["diffuse","opacity"])}if(a.hasOwnProperty("metallicFactor")&&(t.metalness=a.metallicFactor),a.hasOwnProperty("roughnessFactor")&&(t.gloss=a.roughnessFactor),a.hasOwnProperty("metallicRoughnessTexture")){let n=a.metallicRoughnessTexture;t.metalnessMap=t.glossMap=e[n.index],t.metalnessMapChannel="b",t.glossMapChannel="g",Ns(n,t,["gloss","metalness"])}}if(o.hasOwnProperty("normalTexture")){let a=o.normalTexture;t.normalMap=e[a.index],Ns(a,t,["normal"]),a.hasOwnProperty("scale")&&(t.bumpiness=a.scale)}if(o.hasOwnProperty("occlusionTexture")){let a=o.occlusionTexture;t.aoMap=e[a.index],t.aoMapChannel="r",Ns(a,t,["ao"])}if(o.hasOwnProperty("emissiveFactor")&&(s=o.emissiveFactor,t.emissive.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))),o.hasOwnProperty("emissiveTexture")){let a=o.emissiveTexture;t.emissiveMap=e[a.index],Ns(a,t,["emissive"])}if(o.hasOwnProperty("alphaMode"))switch(o.alphaMode){case"MASK":t.blendType=$t,o.hasOwnProperty("alphaCutoff")?t.alphaTest=o.alphaCutoff:t.alphaTest=.5;break;case"BLEND":t.blendType=es,t.depthWrite=!1;break;default:case"OPAQUE":t.blendType=$t;break}else t.blendType=$t;o.hasOwnProperty("doubleSided")?(t.twoSidedLighting=o.doubleSided,t.cull=o.doubleSided?0:1):(t.twoSidedLighting=!1,t.cull=1);let r={KHR_materials_clearcoat:fle,KHR_materials_emissive_strength:Tle,KHR_materials_ior:mle,KHR_materials_dispersion:ple,KHR_materials_iridescence:Ele,KHR_materials_pbrSpecularGlossiness:cle,KHR_materials_sheen:gle,KHR_materials_specular:ule,KHR_materials_transmission:_le,KHR_materials_unlit:dle,KHR_materials_volume:Sle,KHR_materials_anisotropy:vle};if(o.hasOwnProperty("extensions"))for(let a in o.extensions){let n=r[a];n!==void 0&&n(o.extensions[a],t,e)}return t.update(),t},xle=(o,e,t,s,i,r,a)=>{let n=y=>new Po(jT(y.type),w_(y,s)),l={STEP:0,LINEAR:1,CUBICSPLINE:2},h={},c={},f={},d=1,u;for(u=0;u<o.samplers.length;++u){let y=o.samplers[u];h.hasOwnProperty(y.input)||(h[y.input]=n(t[y.input])),c.hasOwnProperty(y.output)||(c[y.output]=n(t[y.output]));let C=y.hasOwnProperty("interpolation")&&l.hasOwnProperty(y.interpolation)?l[y.interpolation]:1,L={paths:[],input:y.input,output:y.output,interpolation:C};f[u]=L}let p=[],_={translation:"localPosition",rotation:"localRotation",scale:"localScale"},S=y=>{let C=[];for(;y;)C.unshift(y.name),y=y.parent;return C},T=(y,C,L)=>{let O=c[y.output];if(!O)return;let M;if(r&&r[C.mesh]){let b=r[C.mesh];b.hasOwnProperty("extras")&&b.extras.hasOwnProperty("targetNames")&&(M=b.extras.targetNames)}let U=O.data,G=U.length/h[y.input].data.length,$=U.length/G,X=$*4,I=new ArrayBuffer(X*G);for(let b=0;b<G;b++){let F=new Float32Array(I,X*b,$);for(let ee=0;ee<$;ee++)F[ee]=U[ee*G+b];let B=new Po(1,F),V=M?.[b]?`name.${M[b]}`:b;c[-d]=B;let z={paths:[{entityPath:L,component:"graph",propertyPath:[`weight.${V}`]}],input:y.input,output:-d,interpolation:y.interpolation};d++,f[`morphCurve-${u}-${b}`]=z}};for(u=0;u<o.channels.length;++u){let y=o.channels[u],C=y.target,L=f[y.sampler],O=i[C.node],M=a[C.node],U=S(O);C.path.startsWith("weights")?(T(L,M,U),f[y.sampler].morphCurve=!0):L.paths.push({entityPath:U,component:"graph",propertyPath:[_[C.path]]})}let x=[],A=[],E=[];for(let y in h)x.push(h[y]),h[y]=x.length-1;for(let y in c)A.push(c[y]),c[y]=A.length-1;for(let y in f){let C=f[y];C.morphCurve||(E.push(new Vc(C.paths,h[C.input],c[C.output],C.interpolation)),C.paths.length>0&&C.paths[0].propertyPath[0]==="localRotation"&&C.interpolation!==2&&p.push(E[E.length-1].output))}p.sort();let v=null,R;for(u=0;u<p.length;++u){let y=p[u];if(u===0||y!==v){if(R=A[y],R.components===4){let C=R.data,L=C.length-4;for(let O=0;O<L;O+=4)C[O+0]*C[O+4]+C[O+1]*C[O+5]+C[O+2]*C[O+6]+C[O+3]*C[O+7]<0&&(C[O+4]*=-1,C[O+5]*=-1,C[O+6]*=-1,C[O+7]*=-1)}v=y}}let P=0;for(u=0;u<x.length;u++)R=x[u]._data,P=Math.max(P,R.length===0?0:R[R.length-1]);return new $s(o.hasOwnProperty("name")?o.name:`animation_${e}`,P,x,A,E)},eR=new k,C_=new g,yle=(o,e,t)=>{let s=new Ae;if(o.hasOwnProperty("name")&&o.name.length>0?s.name=o.name:s.name=`node_${e}`,o.hasOwnProperty("matrix")&&(eR.data.set(o.matrix),eR.getTranslation(C_),s.setLocalPosition(C_),eR.getEulerAngles(C_),s.setLocalEulerAngles(C_),eR.getScale(C_),s.setLocalScale(C_)),o.hasOwnProperty("rotation")){let i=o.rotation;s.setLocalRotation(i[0],i[1],i[2],i[3])}if(o.hasOwnProperty("translation")){let i=o.translation;s.setLocalPosition(i[0],i[1],i[2])}if(o.hasOwnProperty("scale")){let i=o.scale;s.setLocalScale(i[0],i[1],i[2])}return o.hasOwnProperty("extensions")&&o.extensions.EXT_mesh_gpu_instancing&&t.set(o,{ext:o.extensions.EXT_mesh_gpu_instancing}),s},Ale=(o,e)=>{let t=o.type==="orthographic"?Xs:Mt,s=t===Xs?o.orthographic:o.perspective,i={enabled:!1,projection:t,nearClip:s.znear,aspectRatioMode:Nh};s.zfar&&(i.farClip=s.zfar),t===Xs?(i.orthoHeight=.5*s.ymag,s.ymag&&(i.aspectRatioMode=Gf,i.aspectRatio=s.xmag/s.ymag)):(i.fov=s.yfov*w.RAD_TO_DEG,s.aspectRatio&&(i.aspectRatioMode=Gf,i.aspectRatio=s.aspectRatio));let r=new be(o.name);return r.addComponent("camera",i),r},Ple=(o,e)=>{let t={enabled:!1,type:o.type==="point"?"omni":o.type,color:o.hasOwnProperty("color")?new N(o.color):N.WHITE,range:o.hasOwnProperty("range")?o.range:9999,falloffMode:LS,intensity:o.hasOwnProperty("intensity")?w.clamp(o.intensity,0,2):1};o.hasOwnProperty("spot")&&(t.innerConeAngle=o.spot.hasOwnProperty("innerConeAngle")?o.spot.innerConeAngle*w.RAD_TO_DEG:0,t.outerConeAngle=o.spot.hasOwnProperty("outerConeAngle")?o.spot.outerConeAngle*w.RAD_TO_DEG:Math.PI/4),o.hasOwnProperty("intensity")&&(t.luminance=o.intensity*Kh.getLightUnitConversion(JS[t.type],t.outerConeAngle,t.innerConeAngle));let s=new be(e.name);return s.rotateLocal(90,0,0),s.addComponent("light",t),s},Rle=(o,e,t,s)=>{if(!e.hasOwnProperty("skins")||e.skins.length===0)return[];let i=new Map;return e.skins.map(r=>ole(o,r,e.accessors,s,t,i))},Cle=(o,e,t,s)=>{let i={},r={},a={},n=[];return{meshes:!s.skipMeshes&&e?.meshes?.length&&e?.accessors?.length&&e?.bufferViews?.length?e.meshes.map(c=>hle(o,c,e.accessors,t,i,r,a,s,n)):[],meshVariants:r,meshDefaultMaterials:a,promises:n}},Ile=(o,e,t)=>{if(!o.hasOwnProperty("materials")||o.materials.length===0)return[];let s=t?.material?.preprocess,i=t?.material?.process??rQ,r=t?.material?.postprocess;return o.materials.map(a=>{s&&s(a);let n=i(a,e);return r&&r(a,n),n})},wle=o=>{if(!o.hasOwnProperty("extensions")||!o.extensions.hasOwnProperty("KHR_materials_variants"))return null;let e=o.extensions.KHR_materials_variants.variants,t={};for(let s=0;s<e.length;s++)t[e[s].name]=s;return t},Lle=(o,e,t,s)=>{if(!o.hasOwnProperty("animations")||o.animations.length===0)return[];let i=s?.animation?.preprocess,r=s?.animation?.postprocess;return o.animations.map((a,n)=>{i&&i(a);let l=xle(a,n,o.accessors,t,e,o.meshes,o.nodes);return r&&r(a,l),l})},ble=(o,e,t,s)=>{let i=e.accessors;t.forEach((r,a)=>{let n=r.ext.attributes,l;if(n.hasOwnProperty("TRANSLATION")){let d=i[n.TRANSLATION];l=w_(d,s)}let h;if(n.hasOwnProperty("ROTATION")){let d=i[n.ROTATION];h=w_(d,s)}let c;if(n.hasOwnProperty("SCALE")){let d=i[n.SCALE];c=w_(d,s)}let f=(l?l.length/3:0)||(h?h.length/4:0)||(c?c.length/3:0);if(f){let d=new Float32Array(f*16),u=new g,p=new H,_=new g(1,1,1),S=new k,T=0;for(let x=0;x<f;x++){let A=x*3;if(l&&u.set(l[A],l[A+1],l[A+2]),h){let E=x*4;p.set(h[E],h[E+1],h[E+2],h[E+3])}c&&_.set(c[A],c[A+1],c[A+2]),S.setTRS(u,p,_);for(let E=0;E<16;E++)d[T++]=S.data[E]}r.matrices=d}})},Mle=(o,e,t)=>{if(!o.hasOwnProperty("nodes")||o.nodes.length===0)return[];let s=e?.node?.preprocess,i=e?.node?.process??yle,r=e?.node?.postprocess,a=o.nodes.map((n,l)=>{s&&s(n);let h=i(n,l,t);return r&&r(n,h),h});for(let n=0;n<o.nodes.length;++n){let l=o.nodes[n];if(l.hasOwnProperty("children")){let h=a[n],c={};for(let f=0;f<l.children.length;++f){let d=a[l.children[f]];d.parent||(c.hasOwnProperty(d.name)?d.name+=c[d.name]++:c[d.name]=1,h.addChild(d))}}}return a},Dle=(o,e)=>{let t=[],s=o.scenes.length;if(s===1&&o.scenes[0].nodes?.length===1){let i=o.scenes[0].nodes[0];t.push(e[i])}else for(let i=0;i<s;i++){let r=o.scenes[i];if(r.nodes){let a=new Ae(r.name);for(let n=0;n<r.nodes.length;n++){let l=e[r.nodes[n]];a.addChild(l)}t.push(a)}}return t},Ole=(o,e,t)=>{let s=null;if(o.hasOwnProperty("nodes")&&o.hasOwnProperty("cameras")&&o.cameras.length>0){let i=t?.camera?.preprocess,r=t?.camera?.process??Ale,a=t?.camera?.postprocess;o.nodes.forEach((n,l)=>{if(n.hasOwnProperty("camera")){let h=o.cameras[n.camera];if(h){i&&i(h);let c=r(h,e[l]);a&&a(h,c),c&&(s||(s=new Map),s.set(n,c))}}})}return s},Nle=(o,e,t)=>{let s=null;if(o.hasOwnProperty("nodes")&&o.hasOwnProperty("extensions")&&o.extensions.hasOwnProperty("KHR_lights_punctual")&&o.extensions.KHR_lights_punctual.hasOwnProperty("lights")){let i=o.extensions.KHR_lights_punctual.lights;if(i.length){let r=t?.light?.preprocess,a=t?.light?.process??Ple,n=t?.light?.postprocess;o.nodes.forEach((l,h)=>{if(l.hasOwnProperty("extensions")&&l.extensions.hasOwnProperty("KHR_lights_punctual")&&l.extensions.KHR_lights_punctual.hasOwnProperty("light")){let c=l.extensions.KHR_lights_punctual.light,f=i[c];if(f){r&&r(f);let d=a(f,e[h]);n&&n(f,d),d&&(s||(s=new Map),s.set(l,d))}}})}}return s},Fle=(o,e,t)=>{o.nodes.forEach(s=>{s.hasOwnProperty("mesh")&&s.hasOwnProperty("skin")&&e[s.mesh].meshes.forEach(r=>{r.skin=t[s.skin]})})},Ule=async(o,e,t,s,i)=>{let r=i?.global?.preprocess,a=i?.global?.postprocess;r&&r(e),e.asset&&e.asset.generator;let n=new Map,l=Mle(e,i,n),h=Dle(e,l),c=Nle(e,l,i),f=Ole(e,l,i),d=wle(e),u=await Promise.all(t),{meshes:p,meshVariants:_,meshDefaultMaterials:S,promises:T}=Cle(o,e,u,i),x=Lle(e,l,u,i);ble(o,e,n,u);let A=await Promise.all(s),E=A.map(C=>C.resource),v=Ile(e,E,i),R=Rle(o,e,l,u),P=[];for(let C=0;C<p.length;C++)P[C]=new P_,P[C].meshes=p[C];Fle(e,P,R);let y=new bD;return y.gltf=e,y.nodes=l,y.scenes=h,y.animations=x,y.textures=A,y.materials=v,y.variants=d,y.meshVariants=_,y.meshDefaultMaterials=S,y.renders=P,y.skins=R,y.lights=c,y.cameras=f,y.nodeInstancingMap=n,a&&a(e,y),await Promise.all(T),y},Ble=(o,e)=>{let t=(i,r)=>{switch(i){case 9728:return 0;case 9729:return 1;case 9984:return 2;case 9985:return 4;case 9986:return 3;case 9987:return 5;default:return r}},s=(i,r)=>{switch(i){case 33071:return 1;case 33648:return 2;case 10497:return 0;default:return r}};o&&(e=e??{},o.minFilter=t(e.minFilter,5),o.magFilter=t(e.magFilter,1),o.addressU=s(e.wrapS,0),o.addressV=s(e.wrapT,0))},Vle=0,I_=o=>o.extensions?.KHR_texture_basisu?.source??o.extensions?.EXT_texture_webp?.source??o.source,kle=(o,e,t,s,i)=>{if(!o.images||o.images.length===0)return[];let r=i?.image?.preprocess,a=i?.image?.processAsync,n=i?.image?.postprocess,l={"image/png":"png","image/jpeg":"jpg","image/basis":"basis","image/ktx":"ktx","image/ktx2":"ktx2","image/vnd-ms.dds":"dds"},h=d=>{let u=new Set;return d.hasOwnProperty("materials")&&d.materials.forEach(p=>{if(p.hasOwnProperty("pbrMetallicRoughness")){let _=p.pbrMetallicRoughness;if(_.hasOwnProperty("baseColorTexture")){let S=d.textures[_.baseColorTexture.index];u.add(I_(S))}}if(p.hasOwnProperty("emissiveTexture")){let _=d.textures[p.emissiveTexture.index];u.add(I_(_))}if(p.hasOwnProperty("extensions")){let _=p.extensions.KHR_materials_sheen;if(_&&_.hasOwnProperty("sheenColorTexture")){let x=d.textures[_.sheenColorTexture.index];u.add(I_(x))}let S=p.extensions.KHR_materials_pbrSpecularGlossiness;if(S&&S.hasOwnProperty("specularGlossinessTexture")){let x=d.textures[S.specularGlossinessTexture.index];u.add(I_(x))}let T=p.extensions.KHR_materials_specular;if(T&&T.hasOwnProperty("specularColorTexture")){let x=d.textures[T.specularColorTexture.index];u.add(I_(x))}}}),u},c=(d,u,p,_,S,T)=>new Promise((x,A)=>{let E=v=>{let R=`${d.name||"gltf-texture"}-${Vle++}`,P={url:u||R};if(v&&(P.contents=v.slice(0).buffer),_){let L=l[_];L&&(P.filename=`${P.url}.${L}`)}let y={srgb:T},C=new re(R,"texture",P,y,S);C.on("load",L=>x(L)),C.on("error",L=>A(L)),s.add(C),s.load(C)};p?p.then(v=>E(v)):E(null)}),f=h(o);return o.images.map((d,u)=>{r&&r(d);let p;return a?p=new Promise((_,S)=>{a(d,(T,x)=>{T?S(T):_(x)})}):p=new Promise(_=>{_(null)}),p=p.then(_=>{let S=f.has(u);return _||(d.hasOwnProperty("uri")?sQ(d.uri)?c(d,d.uri,null,Zoe(d.uri),null,S):c(d,La.test(d.uri)?d.uri:ve.join(t,d.uri),null,null,{crossOrigin:"anonymous"},S):d.hasOwnProperty("bufferView")&&d.hasOwnProperty("mimeType")?c(d,null,e[d.bufferView],d.mimeType,null,S):Promise.reject(new Error(`Invalid image found in gltf (neither uri or bufferView found). index=${u}`)))}),n&&(p=p.then(_=>(n(d,_),_))),p})},Gle=(o,e,t)=>{if(!o?.images?.length||!o?.textures?.length)return[];let s=t?.texture?.preprocess,i=t?.texture?.processAsync,r=t?.texture?.postprocess,a=new Set;return o.textures.map(n=>{s&&s(n);let l;return i?l=new Promise((h,c)=>{i(n,o.images,(f,d)=>{f?c(f):h(d)})}):l=new Promise(h=>{h(null)}),l=l.then(h=>{h=h??I_(n);let c=a.has(h);return a.add(h),e[h].then(f=>{let d=c?rle(f):f;return Ble(d.resource,(o.samplers??[])[n.sampler]),d})}),r&&(l=l.then(h=>(r(n,h),h))),l})},zle=(o,e,t,s)=>{if(!o.buffers||o.buffers.length===0)return[];let i=s?.buffer?.preprocess,r=s?.buffer?.processAsync,a=s?.buffer?.postprocess;return o.buffers.map((n,l)=>{i&&i(n);let h;return r?h=new Promise((c,f)=>{r(n,(d,u)=>{d?f(d):c(u)})}):h=new Promise(c=>{c(null)}),h=h.then(c=>{if(c)return c;if(n.hasOwnProperty("uri")){if(sQ(n.uri)){let f=atob(n.uri.split(",")[1]),d=new Uint8Array(f.length);for(let u=0;u<f.length;u++)d[u]=f.charCodeAt(u);return d}return new Promise((f,d)=>{Le.get(La.test(n.uri)?n.uri:ve.join(t,n.uri),{cache:!0,responseType:"arraybuffer",retry:!1},(u,p)=>{u?d(u):f(new Uint8Array(p))})})}return e}),a&&(h=h.then(c=>(a(o.buffers[l],c),c))),h})},Hle=(o,e)=>{let s=JSON.parse((i=>{if(typeof TextDecoder<"u")return new TextDecoder().decode(i);let r="";for(let a=0;a<i.length;a++)r+=String.fromCharCode(i[a]);return decodeURIComponent(escape(r))})(o));if(s.asset&&s.asset.version&&parseFloat(s.asset.version)<2){e(`Invalid gltf version. Expected version 2.0 or above but found version '${s.asset.version}'.`);return}e(null,s)},Xle=(o,e)=>{let t=o instanceof ArrayBuffer?new DataView(o):new DataView(o.buffer,o.byteOffset,o.byteLength),s=t.getUint32(0,!0),i=t.getUint32(4,!0),r=t.getUint32(8,!0);if(s!==1179937895){e(`Invalid magic number found in glb header. Expected 0x46546C67, found 0x${s.toString(16)}`);return}if(i!==2){e(`Invalid version number found in glb header. Expected 2, found ${i}`);return}if(r<=0||r>t.byteLength){e(`Invalid length found in glb header. Found ${r}`);return}let a=[],n=12;for(;n<r;){let l=t.getUint32(n,!0);n+l+8>t.byteLength&&e(`Invalid chunk length found in glb. Found ${l}`);let h=t.getUint32(n+4,!0),c=new Uint8Array(t.buffer,t.byteOffset+n+8,l);a.push({length:l,type:h,data:c}),n+=l+8}if(a.length!==1&&a.length!==2){e("Invalid number of chunks found in glb file.");return}if(a[0].type!==1313821514){e(`Invalid chunk type found in glb file. Expected 0x4E4F534A, found 0x${a[0].type.toString(16)}`);return}if(a.length>1&&a[1].type!==5130562){e(`Invalid chunk type found in glb file. Expected 0x004E4942, found 0x${a[1].type.toString(16)}`);return}e(null,{gltfChunk:a[0].data,binaryChunk:a.length===2?a[1].data:null})},Wle=(o,e,t)=>{let s=()=>{let i=new Uint8Array(e);return i[0]===103&&i[1]===108&&i[2]===84&&i[3]===70};o&&o.toLowerCase().endsWith(".glb")||s()?Xle(e,t):t(null,{gltfChunk:e,binaryChunk:null})},Yle=(o,e,t)=>{let s=[],i=t?.bufferView?.preprocess,r=t?.bufferView?.processAsync,a=t?.bufferView?.postprocess;if(!o.bufferViews?.length)return s;for(let n=0;n<o.bufferViews.length;++n){let l=o.bufferViews[n];i&&i(l);let h;r?h=new Promise((c,f)=>{r(l,e,(d,u)=>{d?f(d):c(u)})}):h=new Promise(c=>{c(null)}),h=h.then(c=>c||e[l.buffer].then(f=>new Uint8Array(f.buffer,f.byteOffset+(l.byteOffset||0),l.byteLength))),l.hasOwnProperty("byteStride")&&(h=h.then(c=>(c.byteStride=l.byteStride,c))),a&&(h=h.then(c=>(a(l,c),c))),s.push(h)}return s},wl=class{static parse(e,t,s,i,r,a,n){Wle(e,s,(l,h)=>{if(l){n(l);return}Hle(h.gltfChunk,(c,f)=>{if(c){n(c);return}let d=zle(f,h.binaryChunk,t,a),u=Yle(f,d,a),p=kle(f,u,t,r,a),_=Gle(f,p,a);Ule(i,f,u,_,a).then(S=>n(null,S)).catch(S=>n(S))})})}static createDefaultMaterial(){return rQ({name:"defaultGlbMaterial"},[])}}});var L_,OD=m(()=>{Fs();Ve();Q();Ct();FA();B0();iR();_t();L_=class extends ye{constructor(e){super(e,"animation"),this.device=e.graphicsDevice,this.assets=e.assets}load(e,t,s){typeof e=="string"&&(e={load:e,original:e});let i={retry:this.maxRetries>0,maxRetries:this.maxRetries};(e.load.startsWith("blob:")||e.load.startsWith("data:"))&&(ve.getExtension(e.original).toLowerCase()===".glb"?i.responseType=jt.ResponseType.ARRAY_BUFFER:i.responseType=jt.ResponseType.JSON),Le.get(e.load,i,(r,a)=>{r?t(`Error loading animation resource: ${e.original} [${r}]`):ve.getExtension(e.original).toLowerCase()===".glb"?wl.parse("filename.glb","",a,this.device,this.assets,s?.options??{},(n,l)=>{if(n)t(n);else{let h=l.animations;if(s?.data?.events)for(let c=0;c<h.length;c++)h[c].events=new Ec(Object.values(s.data.events));l.destroy(),t(null,h)}}):t(null,this[`_parseAnimationV${a.animation.version}`](a))})}open(e,t,s){return t}_parseAnimationV3(e){let t=e.animation,s=new sd;s.name=t.name,s.duration=t.duration;for(let i=0;i<t.nodes.length;i++){let r=new ul,a=t.nodes[i];r._name=a.name;for(let n=0;n<a.keys.length;n++){let l=a.keys[n],h=l.time,c=l.pos,f=l.rot,d=l.scale,u=new g(c[0],c[1],c[2]),p=new H().setFromEulerAngles(f[0],f[1],f[2]),_=new g(d[0],d[1],d[2]),S=new dl(h,u,p,_);r._keys.push(S)}s.addNode(r)}return s}_parseAnimationV4(e){let t=e.animation,s=new sd;s.name=t.name,s.duration=t.duration;for(let i=0;i<t.nodes.length;i++){let r=new ul,a=t.nodes[i];r._name=a.name;let n=a.defaults.p,l=a.defaults.r,h=a.defaults.s;for(let c=0;c<a.keys.length;c++){let f=a.keys[c],d=f.t,u=n||f.p,p=l||f.r,_=h||f.s,S=new g(u[0],u[1],u[2]),T=new H().setFromEulerAngles(p[0],p[1],p[2]),x=new g(_[0],_[1],_[2]),A=new dl(d,S,T,x);r._keys.push(A)}s.addNode(r)}return s}}});var b_,ND=m(()=>{Ct();ZP();QP();gl();_t();b_=class extends ye{constructor(e){super(e,"animclip")}load(e,t){typeof e=="string"&&(e={load:e,original:e});let s={retry:this.maxRetries>0,maxRetries:this.maxRetries};e.load.startsWith("blob:")&&(s.responseType=jt.ResponseType.JSON),Le.get(e.load,s,(i,r)=>{i?t(`Error loading animation clip resource: ${e.original} [${i}]`):t(null,r)})}open(e,t){let s=t.name,i=t.duration,r=t.inputs.map(l=>new Po(1,l)),a=t.outputs.map(l=>new Po(l.components,l.data)),n=t.curves.map(l=>new Vc([l.path],l.inputIndex,l.outputIndex,l.interpolation));return new $s(s,i,r,a,n)}}});var M_,FD=m(()=>{Ct();$0();_t();M_=class extends ye{constructor(e){super(e,"animstategraph")}load(e,t){typeof e=="string"&&(e={load:e,original:e});let s={retry:this.maxRetries>0,maxRetries:this.maxRetries};e.load.startsWith("blob:")&&(s.responseType=jt.ResponseType.JSON),Le.get(e.load,s,(i,r)=>{i?t(`Error loading animation state graph resource: ${e.original} [${i}]`):t(null,r)})}open(e,t){return new yo(t)}}});var UD,Kle,D_,BD=m(()=>{Fs();Ct();PS();sL();_t();UD=function(){if(typeof window>"u")return!1;let o=window.navigator.userAgent,e=o.indexOf("MSIE ");if(e>0)return parseInt(o.substring(e+5,o.indexOf(".",e)),10);if(o.indexOf("Trident/")>0){let s=o.indexOf("rv:");return parseInt(o.substring(s+3,o.indexOf(".",s)),10)}return!1}(),Kle=[".ogg",".mp3",".wav",".mp4a",".m4a",".mp4",".aac",".opus"],D_=class extends ye{constructor(e){super(e,"audio"),this.manager=e.soundManager}_isSupported(e){let t=ve.getExtension(e);return Kle.indexOf(t)>-1}load(e,t){typeof e=="string"&&(e={load:e,original:e});let s=function(r){t(null,new Em(r))},i=function(r){let a=`Error loading audio url: ${e.original}`;r&&(a+=`: ${r.message||r}`),console.warn(a),t(a)};if(this._createSound){if(!this._isSupported(e.original)){i(`Audio format for ${e.original} not supported`);return}this._createSound(e.load,s,i)}else i(null)}_createSound(e,t,s){if(Zo()){let i=this.manager;if(!i.context){s("Audio manager has no audio context");return}let r={retry:this.maxRetries>0,maxRetries:this.maxRetries};(e.startsWith("blob:")||e.startsWith("data:"))&&(r.responseType=jt.ResponseType.ARRAY_BUFFER),Le.get(e,r,(a,n)=>{if(a){s(a);return}i.context.decodeAudioData(n,t,s)})}else{let i=null;try{i=new Audio}catch{s("No support for Audio element");return}UD&&document.body.appendChild(i);let r=function(){i.removeEventListener("canplaythrough",r),UD&&document.body.removeChild(i),t(i)};i.onerror=function(){i.onerror=null,UD&&document.body.removeChild(i),s()},i.addEventListener("canplaythrough",r),i.src=e}}}});var O_,VD=m(()=>{Ct();_t();O_=class extends ye{constructor(e){super(e,"binary")}load(e,t){typeof e=="string"&&(e={load:e,original:e}),Le.get(e.load,{responseType:jt.ResponseType.ARRAY_BUFFER,retry:this.maxRetries>0,maxRetries:this.maxRetries},(s,i)=>{s?t(`Error loading binary resource: ${e.original} [${s}]`):t(null,i)})}openBinary(e){return e.buffer}}});var N_,kD=m(()=>{Zt();_s();ll();Km();Wf();GM();ci();rt();Cr();$i();N_=class o{constructor(e,t,s,i){let r=function(h,c,f){let d=o.createAsset(t.name,h,c,f);return s.add(d),d},a=[];for(let h=0;h<e.renders.length;++h)a.push(r("render",e.renders[h],h));let n=[];for(let h=0;h<e.materials.length;++h)n.push(r("material",e.materials[h],h));let l=[];for(let h=0;h<e.animations.length;++h)l.push(r("animation",e.animations[h],h));this.data=e,this._model=null,this._assetName=t.name,this._assets=s,this._defaultMaterial=i,this.renders=a,this.materials=n,this.textures=e.textures,this.animations=l}get model(){if(!this._model){let e=o.createModel(this.data,this._defaultMaterial),t=o.createAsset(this._assetName,"model",e,0);this._assets.add(t),this._model=t}return this._model}static createAsset(e,t,s,i){let r=new re(`${e}/${t}/${i}`,t,{url:""});return r.resource=s,r.loaded=!0,r}instantiateModelEntity(e){let t=new be(void 0,this._assets._loader._app);return t.addComponent("model",Object.assign({type:"asset",asset:this.model},e)),t}instantiateRenderEntity(e){let t=this._defaultMaterial,s=[],i=function(n,l,h,c,f,d,u,p){let _=f[h.id],S=_===void 0?t:c[_],T=new Oe(h,S);h.morph&&(T.morphInstance=new br(h.morph)),u.hasOwnProperty("skin")&&s.push({meshInstance:T,rootBone:n,entity:l});let x=p.get(u);if(x){let A=x.matrices,E=Tt.getDefaultInstancingFormat(h.device),v=new mt(h.device,E,A.length/16,{data:A});T.setInstancing(v),T.instancingData._destroyVertexBuffer=!0}return T},r=(n,l,h)=>{let c=new be(void 0,this._assets._loader._app);l._cloneInternal(c),n||(n=c);let f=null,d=null;for(let p=0;p<h.nodes.length;p++)if(h.nodes[p]===l){let S=h.gltf.nodes[p];if(S.hasOwnProperty("mesh")){let T=h.renders[S.mesh].meshes;d=this.renders[S.mesh];for(let x=0;x<T.length;x++){let A=T[x];if(A){let E=i(n,c,A,h.materials,h.meshDefaultMaterials,h.skins,S,h.nodeInstancingMap);f||(f=[]),f.push(E)}}}if(h.lights){let T=h.lights.get(S);T&&c.addChild(T.clone())}if(h.cameras){let T=h.cameras.get(S);T&&T.camera.system.cloneComponent(T,c)}}f&&(c.addComponent("render",Object.assign({type:"asset",meshInstances:f},e)),c.render.assignAsset(d));let u=l.children;for(let p=0;p<u.length;p++){let _=r(n,u[p],h);c.addChild(_)}return c},a=[];for(let n of this.data.scenes)a.push(r(null,n,this.data));return s.forEach(n=>{n.meshInstance.skinInstance=Td.createCachedSkinInstance(n.meshInstance.mesh.skin,n.rootBone,n.entity),n.meshInstance.node.render.rootBone=n.rootBone}),o.createSceneHierarchy(a,be)}getMaterialVariants(){return this.data.variants?Object.keys(this.data.variants):[]}applyMaterialVariant(e,t){let s=t?this.data.variants[t]:null;if(s===void 0)return;let i=e.findComponents("render");for(let r=0;r<i.length;r++){let a=i[r];this._applyMaterialVariant(s,a.meshInstances)}}applyMaterialVariantInstances(e,t){let s=t?this.data.variants[t]:null;s!==void 0&&this._applyMaterialVariant(s,e)}_applyMaterialVariant(e,t){t.forEach(s=>{if(e===null)s.material=this._defaultMaterial;else{let i=this.data.meshVariants[s.mesh.id];i&&(s.material=this.data.materials[i[e]])}})}static createSceneHierarchy(e,t){let s=null;if(e.length===1)s=e[0];else{s=new t("SceneGroup");for(let i of e)s.addChild(i)}return s}static createModel(e,t){let s=function(a,n,l,h,c,f,d){let u=e.meshDefaultMaterials[n.id],p=u===void 0?t:c[u],_=new Oe(n,p,f);if(n.morph){let S=new br(n.morph);_.morphInstance=S,a.morphInstances.push(S)}if(d.hasOwnProperty("skin")){let S=d.skin,T=l[S];n.skin=T;let x=h[S];_.skinInstance=x,a.skinInstances.push(x)}a.meshInstances.push(_)},i=new Ys,r=[];for(let a of e.skins){let n=new ar(a);n.bones=a.bones,r.push(n)}i.graph=o.createSceneHierarchy(e.scenes,Ae);for(let a=0;a<e.nodes.length;a++){let n=e.nodes[a];if(n.root===i.graph){let l=e.gltf.nodes[a];if(l.hasOwnProperty("mesh")){let h=e.renders[l.mesh].meshes;for(let c=0;c<h.length;c++){let f=h[c];f&&s(i,f,e.skins,r,e.materials,n,l)}}}}return i}destroy(){let e=this._assets,t=function(i){e.remove(i),i.unload()},s=function(i){i.forEach(r=>{t(r)})};this.animations&&(s(this.animations),this.animations=null),this.textures&&(s(this.textures),this.textures=null),this.materials&&(s(this.materials),this.materials=null),this.renders&&(s(this.renders),this.renders=null),this._model&&(t(this._model),this._model=null),this.data=null,this.assets=null}}});var rR,aQ=m(()=>{Fs();rt();iR();kD();rR=class{constructor(e,t,s){this._device=e,this._assets=t,this._defaultMaterial=wl.createDefaultMaterial(),this.maxRetries=s}_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}load(e,t,s){re.fetchArrayBuffer(e.load,(i,r)=>{i?t(i):wl.parse(this._getUrlWithoutParams(e.original),ve.extractPath(e.load),r,this._device,s.registry,s.options,(a,n)=>{a?t(a):t(null,new N_(n,s,this._assets,this._defaultMaterial))})},s,this.maxRetries)}open(e,t,s){return t}patch(e,t){}}});var aR,F_,GD=m(()=>{Fs();aQ();_t();aR=class{instantiateModelEntity(e){return null}instantiateRenderEntity(e){return null}getMaterialVariants(){return null}applyMaterialVariant(e,t){}applyMaterialVariantInstances(e,t){}},F_=class extends ye{constructor(e){super(e,"container"),this.glbContainerParser=new rR(e.graphicsDevice,e.assets,0),this.parsers={}}set maxRetries(e){this.glbContainerParser.maxRetries=e;for(let t in this.parsers)this.parsers.hasOwnProperty(t)&&(this.parsers[t].maxRetries=e)}get maxRetries(){return this.glbContainerParser.maxRetries}_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}_getParser(e){let t=e?ve.getExtension(this._getUrlWithoutParams(e)).toLowerCase().replace(".",""):null;return this.parsers[t]||this.glbContainerParser}load(e,t,s){typeof e=="string"&&(e={load:e,original:e}),this._getParser(e.original).load(e,t,s)}open(e,t,s){return this._getParser(e).open(e,t,s)}}});var U_,zD=m(()=>{Ct();_t();U_=class extends ye{constructor(e){super(e,"css"),this.decoder=null}load(e,t){typeof e=="string"&&(e={load:e,original:e}),Le.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(s,i)=>{s?t(`Error loading css resource: ${e.original} [${s}]`):t(null,i)})}openBinary(e){return this.decoder??=new TextDecoder("utf-8"),this.decoder.decode(e)}}});var B_,HD=m(()=>{j();Fe();rt();_t();B_=class extends ye{constructor(e){super(e,"cubemap"),this._device=e.graphicsDevice,this._registry=e.assets,this._loader=e.loader}load(e,t,s){this.loadAssets(s,t)}open(e,t,s){return s?s.resource:null}patch(e,t){this.loadAssets(e,(s,i)=>{s&&(t.fire("error",e),t.fire(`error:${e.id}`,s,e),e.fire("error",e))})}getAssetIds(e){let t=[];if(t[0]=e.file,(e.loadFaces||!e.file)&&e.data&&e.data.textures)for(let s=0;s<6;++s)t[s+1]=e.data.textures[s];else t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=null;return t}compareAssetIds(e,t){return e&&t?parseInt(e,10)===e||typeof e=="string"?e===t:e.url===t.url:e!==null==(t!==null)}update(e,t,s){let i=e.data||{},r=e._handlerState.assets,a=e._resources,n,l,h,c=[null,null,null,null,null,null,null],f=function(){return i.hasOwnProperty("type")?i.type:i.hasOwnProperty("rgbm")?i.rgbm?ti:zt:null};if(!e.loaded||s[0]!==r[0]){if(s[0])if(n=s[0].resource,n.cubemap)for(h=0;h<6;++h)c[h+1]=new q(this._device,{name:`${e.name}_prelitCubemap${n.width>>h}`,cubemap:!0,type:f()||n.type,width:n.width>>h,height:n.height>>h,format:n.format,levels:[n._levels[h]],addressU:1,addressV:1,mipmaps:h===0});else c[1]=n}else c[1]=a[1]||null,c[2]=a[2]||null,c[3]=a[3]||null,c[4]=a[4]||null,c[5]=a[5]||null,c[6]=a[6]||null;let d=s.slice(1);if(!e.loaded||!this.cmpArrays(d,r.slice(1))){if(d.indexOf(null)===-1){let u=d.map(T=>T.resource),p=[];for(l=0;l<u[0]._levels.length;++l)p.push(u.map(T=>T._levels[l]));let _=u[0].format,S=new q(this._device,{name:`${e.name}_faces`,cubemap:!0,type:f()||u[0].type,width:u[0].width,height:u[0].height,format:_===6?7:_,mipmaps:i.mipmaps??!0,levels:p,minFilter:i.hasOwnProperty("minFilter")?i.minFilter:u[0].minFilter,magFilter:i.hasOwnProperty("magFilter")?i.magFilter:u[0].magFilter,anisotropy:i.hasOwnProperty("anisotropy")?i.anisotropy:1,addressU:1,addressV:1});c[0]=S}}else c[0]=a[0]||null;if(!this.cmpArrays(c,a))for(e.resources=c,e._handlerState.assetIds=t,e._handlerState.assets=s,h=0;h<a.length;++h)a[h]!==null&&c.indexOf(a[h])===-1&&a[h].destroy();for(h=0;h<r.length;++h)r[h]!==null&&s.indexOf(r[h])===-1&&r[h].unload()}cmpArrays(e,t){if(e.length!==t.length)return!1;for(let s=0;s<e.length;++s)if(e[s]!==t[s])return!1;return!0}resolveId(e){let t=parseInt(e,10);return t===e||t.toString()===e?t:e}loadAssets(e,t){e.hasOwnProperty("_handlerState")||(e._handlerState={assetIds:[null,null,null,null,null,null,null],assets:[null,null,null,null,null,null,null]});let s=this,i=s.getAssetIds(e),r=[null,null,null,null,null,null,null],a=e._handlerState.assetIds,n=e._handlerState.assets,l=s._registry,h=7,c=function(p,_){r[p]=_,h--,h===0&&(s.update(e,i,r),t(null,e.resources))},f=function(p,_,S){t(_)},d=function(p,_){_.loaded?c(p,_):(l.once(`load:${_.id}`,c.bind(s,p)),l.once(`error:${_.id}`,f.bind(s,p)),_.loading||l.load(_))},u;for(let p=0;p<7;++p){let _=this.resolveId(i[p]);if(!_)c(p,null);else if(s.compareAssetIds(_,a[p]))d(p,n[p]);else if(parseInt(_,10)===_)u=l.get(_),u?d(p,u):setTimeout(((S,T)=>{let x=l.get(T);x?d(S,x):f(S,`failed to find dependent cubemap asset=${T}`)}).bind(null,p,_));else{let S=typeof _=="string"?{url:_,filename:_}:_,T=S.url.search(".dds")===-1?{type:"rgbp",addressu:"clamp",addressv:"clamp",mipmaps:!1}:null;u=new re(`${e.name}_part_${p}`,"texture",S,T),l.add(u),d(p,u)}}}}});var V_,XD=m(()=>{_t();V_=class extends ye{constructor(e){super(e,"folder")}load(e,t){t(null,null)}}});var Ld,WD=m(()=>{mP();Ld=class{constructor(e,t){this.type=t?t.type||Rc:Rc,this.em=1,this.textures=e,this.intensity=0,this._data=null,this.data=t}set data(e){if(this._data=e,!!e&&(this._data.intensity!==void 0&&(this.intensity=this._data.intensity),this._data.info||(this._data.info={}),(!this._data.version||this._data.version<2)&&(this._data.info.maps=[{width:this._data.info.width,height:this._data.info.height}],this._data.chars)))for(let t in this._data.chars)this._data.chars[t].map=0}get data(){return this._data}}});function YD(o){return o.version<3&&(o.version<2&&(o.info.maps=o.info.maps||[{width:o.info.width,height:o.info.height}]),o.chars=Object.keys(o.chars||{}).reduce((e,t)=>{let s=o.chars[t],i=s.letter!==void 0?s.letter:zr.fromCodePoint(t);return o.version<2&&(s.map=s.map||0),e[i]=s,e},{}),o.version=3),o}var k_,KD=m(()=>{Fs();Kg();Ct();WD();_t();k_=class extends ye{constructor(e){super(e,"font"),this._loader=e.loader,this.maxRetries=0}load(e,t,s){typeof e=="string"&&(e={load:e,original:e});let i=this;ve.getExtension(e.original)===".json"?Le.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(r,a)=>{if(r)t(`Error loading font resource: ${e.original} [${r}]`);else{let n=YD(a);i._loadTextures(e.load.replace(".json",".png"),n,(l,h)=>{l?t(l):t(null,{data:n,textures:h})})}}):(s&&s.data&&(s.data=YD(s.data)),this._loadTextures(e.load,s&&s.data,t))}_loadTextures(e,t,s){let i=t.info.maps.length,r=0,a=null,n=new Array(i),l=this._loader,h=function(c){let f=function(d,u){if(!a){if(d){a=d,s(d);return}u.upload(),n[c]=u,r++,r===i&&s(null,n)}};c===0?l.load(e,"texture",f):l.load(e.replace(".png",`${c}.png`),"texture",f)};for(let c=0;c<i;c++)h(c)}open(e,t,s){let i;return t.textures?i=new Ld(t.textures,t.data):i=new Ld(t,null),i}patch(e,t){let s=e.resource;!s.data&&e.data?s.data=e.data:!e.data&&s.data&&(e.data=s.data),e.data&&(e.data=YD(e.data))}}});var qD,jD,nR,nQ=m(()=>{Ve();Q();Ze();oT();qD=.28209479177387814,jD=class{constructor(e,t,s,i,r,a){let n=(E,v)=>{let R=(1<<v)-1;return(E&R)/R},l=(E,v)=>{E.x=n(v>>>21,11),E.y=n(v>>>11,10),E.z=n(v,11)},h=(E,v)=>{E.x=n(v>>>24,8),E.y=n(v>>>16,8),E.z=n(v>>>8,8),E.w=n(v,8)},c=(E,v)=>{let R=1/(Math.sqrt(2)*.5),P=(n(v>>>20,10)-.5)*R,y=(n(v>>>10,10)-.5)*R,C=(n(v,10)-.5)*R,L=Math.sqrt(1-(P*P+y*y+C*C));switch(v>>>30){case 0:E.set(P,y,C,L);break;case 1:E.set(L,y,C,P);break;case 2:E.set(y,L,C,P);break;case 3:E.set(y,C,L,P);break}},f=(E,v,R)=>E*(1-R)+v*R,{chunkData:d,chunkSize:u,vertexData:p,shData0:_,shData1:S,shData2:T,shBands:x}=e,A=[3,8,15][x-1];this.read=E=>{let v=Math.floor(E/256)*u;if(t&&(l(t,p[E*4+0]),t.x=f(d[v+0],d[v+3],t.x),t.y=f(d[v+1],d[v+4],t.y),t.z=f(d[v+2],d[v+5],t.z)),s&&c(s,p[E*4+1]),i&&(l(i,p[E*4+2]),i.x=f(d[v+6],d[v+9],i.x),i.y=f(d[v+7],d[v+10],i.y),i.z=f(d[v+8],d[v+11],i.z)),r&&(h(r,p[E*4+3]),u>12&&(r.x=f(d[v+12],d[v+15],r.x),r.y=f(d[v+13],d[v+16],r.y),r.z=f(d[v+14],d[v+17],r.z))),a&&x>0){let R=[_,S,T];for(let P=0;P<3;++P)for(let y=0;y<15;++y)a[P*15+y]=y<A?R[P][E*16+y]*(8/255)-4:0}}}},nR=class{createIter(e,t,s,i,r){return new jD(this,e,t,s,i,r)}calcAabb(e){let{chunkData:t,numChunks:s,chunkSize:i}=this,r=Math.exp(Math.max(t[9],t[10],t[11])),a=t[0]-r,n=t[1]-r,l=t[2]-r,h=t[3]+r,c=t[4]+r,f=t[5]+r;for(let d=1;d<s;++d){let u=d*i;r=Math.exp(Math.max(t[u+9],t[u+10],t[u+11])),a=Math.min(a,t[u+0]-r),n=Math.min(n,t[u+1]-r),l=Math.min(l,t[u+2]-r),h=Math.max(h,t[u+3]+r),c=Math.max(c,t[u+4]+r),f=Math.max(f,t[u+5]+r)}return e.center.set((a+h)*.5,(n+c)*.5,(l+f)*.5),e.halfExtents.set((h-a)*.5,(c-n)*.5,(f-l)*.5),!0}getCenters(e){let{vertexData:t,chunkData:s,numChunks:i,chunkSize:r}=this,a,n,l,h,c,f;for(let d=0;d<i;++d){let u=d*r;a=s[u+0],n=s[u+1],l=s[u+2],h=s[u+3],c=s[u+4],f=s[u+5];let p=Math.min(this.numSplats,(d+1)*256);for(let _=d*256;_<p;++_){let S=t[_*4],T=(S>>>21)/2047,x=(S>>>11&1023)/1023,A=(S&2047)/2047;e[_*3+0]=(1-T)*a+T*h,e[_*3+1]=(1-x)*n+x*c,e[_*3+2]=(1-A)*l+A*f}}}getChunks(e){let{chunkData:t,numChunks:s,chunkSize:i}=this,r,a,n,l,h,c;for(let f=0;f<s;++f){let d=f*i;r=t[d+0],a=t[d+1],n=t[d+2],l=t[d+3],h=t[d+4],c=t[d+5],e[f*6+0]=r,e[f*6+1]=a,e[f*6+2]=n,e[f*6+3]=l,e[f*6+4]=h,e[f*6+5]=c}}calcFocalPoint(e){let{chunkData:t,numChunks:s,chunkSize:i}=this;e.x=0,e.y=0,e.z=0;for(let r=0;r<s;++r){let a=r*i;e.x+=t[a+0]+t[a+3],e.y+=t[a+1]+t[a+4],e.z+=t[a+2]+t[a+5]}e.mulScalar(.5/s)}get isCompressed(){return!0}get numChunks(){return Math.ceil(this.numSplats/256)}get chunkSize(){return this.chunkData.length/this.numChunks}decompress(){let e=["x","y","z","f_dc_0","f_dc_1","f_dc_2","opacity","scale_0","scale_1","scale_2","rot_0","rot_1","rot_2","rot_3"],{shBands:t}=this;if(t>0){let c=[];for(let f=0;f<45;++f)c.push(`f_rest_${f}`);e.splice(e.indexOf("f_dc_0")+1,0,...c)}let s={};e.forEach(c=>{s[c]=new Float32Array(this.numSplats)});let i=new g,r=new H,a=new g,n=new W,l=t>0?new Float32Array(45):null,h=this.createIter(i,r,a,n,l);for(let c=0;c<this.numSplats;++c)if(h.read(c),s.x[c]=i.x,s.y[c]=i.y,s.z[c]=i.z,s.rot_1[c]=r.x,s.rot_2[c]=r.y,s.rot_3[c]=r.z,s.rot_0[c]=r.w,s.scale_0[c]=a.x,s.scale_1[c]=a.y,s.scale_2[c]=a.z,s.f_dc_0[c]=(n.x-.5)/qD,s.f_dc_1[c]=(n.y-.5)/qD,s.f_dc_2[c]=(n.z-.5)/qD,s.opacity[c]=n.w<=0?-40:n.w>=1?40:-Math.log(1/n.w-1),l)for(let f=0;f<45;++f)s[`f_rest_${f}`][c]=l[f];return new cn([{name:"vertex",count:this.numSplats,properties:e.map(c=>({name:c,type:"float",byteSize:4,storage:s[c]}))}],this.comments)}}});var qle,oR,oQ=m(()=>{Ne();lT();qle=(o,e,t,s,i)=>{for(let r=0;r<i;++r)for(let a=0;a<s;++a)o[r*e+a]=t[r*s+a]},oR=class extends To{constructor(e,t){super(e,t);let{chunkData:s,chunkSize:i,numChunks:r,numSplats:a,vertexData:n,shBands:l}=t;this.chunks=new Float32Array(r*6),t.getChunks(this.chunks),this.packedTexture=this.createTexture("packedData",49,this.evalTextureSize(a),n);let h=this.evalTextureSize(r);h.x*=5,this.chunkTexture=this.createTexture("chunkData",14,h);let c=this.chunkTexture.lock();if(qle(c,20,s,i,r),i===12)for(let f=0;f<r;++f)c[f*20+15]=1,c[f*20+16]=1,c[f*20+17]=1;if(this.chunkTexture.unlock(),l>0){let f=this.evalTextureSize(a);this.shTexture0=this.createTexture("shTexture0",49,f,new Uint32Array(t.shData0.buffer)),this.shTexture1=this.createTexture("shTexture1",49,f,new Uint32Array(t.shData1.buffer)),this.shTexture2=this.createTexture("shTexture2",49,f,new Uint32Array(t.shData2.buffer))}else this.shTexture0=null,this.shTexture1=null,this.shTexture2=null}destroy(){this.packedTexture?.destroy(),this.chunkTexture?.destroy(),this.shTexture0?.destroy(),this.shTexture1?.destroy(),this.shTexture2?.destroy(),super.destroy()}configureMaterial(e){e.setDefine("GSPLAT_COMPRESSED_DATA",!0),e.setParameter("packedTexture",this.packedTexture),e.setParameter("chunkTexture",this.chunkTexture),this.shTexture0?(e.setDefine("SH_BANDS",3),e.setParameter("shTexture0",this.shTexture0),e.setParameter("shTexture1",this.shTexture1),e.setParameter("shTexture2",this.shTexture2)):e.setDefine("SH_BANDS",0)}evalTextureSize(e){let t=Math.ceil(Math.sqrt(e)),s=Math.ceil(e/t);return new D(t,s)}}});var lQ,hQ,$D,ZD,jle,$le,Zle,Qle,Jle,ehe,the,she,lR,cQ=m(()=>{oT();nQ();oQ();KA();lQ=new Uint8Array([112,108,121,10]),hQ=new Uint8Array([10,101,110,100,95,104,101,97,100,101,114,10]),$D=new Map([["char",Int8Array],["uchar",Uint8Array],["short",Int16Array],["ushort",Uint16Array],["int",Int32Array],["uint",Uint32Array],["float",Float32Array],["double",Float64Array]]),ZD=class{constructor(e,t){this.head=0,this.tail=0,this.reader=e,this.progressFunc=t}async read(){let{value:e,done:t}=await this.reader.read();if(t)throw new Error("Stream finished before end of header");this.push(e),this.progressFunc?.(e.byteLength)}push(e){if(!this.data)this.data=e,this.view=new DataView(this.data.buffer),this.tail=e.length;else{let t=this.tail-this.head,s=t+e.length;if(this.data.length>=s)this.head>0?(this.data.copyWithin(0,this.head,this.tail),this.data.set(e,t),this.head=0,this.tail=s):(this.data.set(e,this.tail),this.tail+=e.length);else{let i=new Uint8Array(s);this.head>0||this.tail<this.data.length?i.set(this.data.subarray(this.head,this.tail),0):i.set(this.data,0),i.set(e,t),this.data=i,this.view=new DataView(this.data.buffer),this.head=0,this.tail=s}}}compact(){this.head>0&&(this.data.copyWithin(0,this.head,this.tail),this.tail-=this.head,this.head=0)}get remaining(){return this.tail-this.head}getInt8(){let e=this.view.getInt8(this.head);return this.head++,e}getUint8(){let e=this.view.getUint8(this.head);return this.head++,e}getInt16(){let e=this.view.getInt16(this.head,!0);return this.head+=2,e}getUint16(){let e=this.view.getUint16(this.head,!0);return this.head+=2,e}getInt32(){let e=this.view.getInt32(this.head,!0);return this.head+=4,e}getUint32(){let e=this.view.getUint32(this.head,!0);return this.head+=4,e}getFloat32(){let e=this.view.getFloat32(this.head,!0);return this.head+=4,e}getFloat64(){let e=this.view.getFloat64(this.head,!0);return this.head+=8,e}},jle=o=>{let e=[],t=[],s;for(let i=1;i<o.length;++i){let r=o[i].split(" ");switch(r[0]){case"comment":t.push(r.slice(1).join(" "));break;case"format":s=r[1];break;case"element":e.push({name:r[1],count:parseInt(r[2],10),properties:[]});break;case"property":{if(!$D.has(r[1]))throw new Error(`Unrecognized property data type '${r[1]}' in ply header`);e[e.length-1].properties.push({type:r[1],name:r[2],storage:null,byteSize:$D.get(r[1]).BYTES_PER_ELEMENT});break}default:throw new Error(`Unrecognized header value '${r[0]}' in ply header`)}}return{elements:e,format:s,comments:t}},$le=o=>{let e=["min_x","min_y","min_z","max_x","max_y","max_z","min_scale_x","min_scale_y","min_scale_z","max_scale_x","max_scale_y","max_scale_z","min_r","min_g","min_b","max_r","max_g","max_b"],t=["packed_position","packed_rotation","packed_scale","packed_color"],s=new Array(45).fill("").map((a,n)=>`f_rest_${n}`),i=()=>o[0].name==="chunk"&&o[0].properties.every((a,n)=>a.name===e[n]&&a.type==="float")&&o[1].name==="vertex"&&o[1].properties.every((a,n)=>a.name===t[n]&&a.type==="uint"),r=()=>o[2].name==="sh"&&[9,24,45].indexOf(o[2].properties.length)!==-1&&o[2].properties.every((a,n)=>a.name===s[n]&&a.type==="uchar");return o.length===2&&i()||o.length===3&&i()&&r()},Zle=o=>o.length===1&&o[0].name==="vertex"&&o[0].properties.every(e=>e.type==="float"),Qle=async(o,e,t)=>{let s=new nR;s.comments=t;let i=e[0].count,r=e[0].properties.length,a=e[1].count,l=(c=>{let f=Math.ceil(Math.sqrt(c)),d=Math.ceil(c/f);return f*d})(a);s.numSplats=a,s.chunkData=new Float32Array(i*r),s.vertexData=new Uint32Array(l*4);let h=async(c,f)=>{let d=new Uint8Array(c),u=0;for(;u<f;){for(;o.remaining===0;)await o.read();let p=Math.min(f-u,o.remaining),_=o.data;for(let S=0;S<p;++S)d[u++]=_[o.head++]}};if(await h(s.chunkData.buffer,i*r*4),await h(s.vertexData.buffer,a*4*4),e.length===3){let c=l*16,f=new Uint8Array(c),d=new Uint8Array(c),u=new Uint8Array(c),p=1024,_=e[2].properties.length/3,S=new Uint8Array(p*_*3);for(let T=0;T<s.numSplats;T+=p){let x=Math.min(p,s.numSplats-T);await h(S.buffer,x*_*3);for(let A=0;A<x;++A)for(let E=0;E<15;++E){let v=(T+A)*16+E;E<_?(f[v]=S[(A*3+0)*_+E],d[v]=S[(A*3+1)*_+E],u[v]=S[(A*3+2)*_+E]):(f[v]=127,d[v]=127,u[v]=127)}}s.shData0=f,s.shData1=d,s.shData2=u,s.shBands={3:1,8:2,15:3}[_]}else s.shBands=0;return s},Jle=async(o,e,t)=>{let s=e[0],i=s.properties,r=i.length,a=i.map(f=>f.storage),n=i.reduce((f,d)=>f+d.byteSize,0),l=0,h,c=()=>{let f=o.data.buffer;h?.buffer!==f&&(h=new Float32Array(f,0,f.byteLength/4))};for(c();l<s.count;){for(;o.remaining<n;)await o.read(),c();let f=Math.min(s.count-l,Math.floor(o.remaining/n));for(let d=0;d<r;++d){let u=a[d];for(let p=0;p<f;++p)u[p+l]=h[p*r+d]}l+=f,o.head+=f*n}return new cn(e,t)},ehe=async(o,e,t)=>{for(let s=0;s<e.length;++s){let i=e[s],r=i.properties.reduce((l,h)=>l+h.byteSize,0),a=i.properties.map(l=>{if(l.storage)switch(l.type){case"char":return(h,c)=>{l.storage[c]=h.getInt8()};case"uchar":return(h,c)=>{l.storage[c]=h.getUint8()};case"short":return(h,c)=>{l.storage[c]=h.getInt16()};case"ushort":return(h,c)=>{l.storage[c]=h.getUint16()};case"int":return(h,c)=>{l.storage[c]=h.getInt32()};case"uint":return(h,c)=>{l.storage[c]=h.getUint32()};case"float":return(h,c)=>{l.storage[c]=h.getFloat32()};case"double":return(h,c)=>{l.storage[c]=h.getFloat64()};default:throw new Error(`Unsupported property data type '${l.type}' in ply header`)}else return h=>{h.head+=l.byteSize}}),n=0;for(;n<i.count;){for(;o.remaining<r;)await o.read();let l=Math.min(i.count-n,Math.floor(o.remaining/r));for(let h=0;h<l;++h){for(let c=0;c<i.properties.length;++c)a[c](o,n);n++}}}return new cn(e,t)},the=async(o,e=null,t=null)=>{let s=(d,u)=>{let p=d.length-u.length,_,S;for(_=0;_<=p;++_){for(S=0;S<u.length&&d[_+S]===u[S];++S);if(S===u.length)return _}return-1},i=(d,u)=>{if(d.length<u.length)return!1;for(let p=0;p<u.length;++p)if(d[p]!==u[p])return!1;return!0},r=new ZD(o,t),a;for(;;){if(await r.read(),r.tail>=lQ.length&&!i(r.data,lQ))throw new Error("Invalid ply header");if(a=s(r.data,hQ),a!==-1)break}let n=new TextDecoder("ascii").decode(r.data.subarray(0,a)).split(`
`),{elements:l,format:h,comments:c}=jle(n);if(h!=="binary_little_endian")throw new Error("Unsupported ply format");return r.head=a+hQ.length,r.compact(),await(async()=>$le(l)?await Qle(r,l,c):(l.forEach(d=>{d.properties.forEach(u=>{let p=$D.get(u.type);if(p){let _=!e||e(u.name)?new p(d.count):null;u.storage=_}})}),Zle(l)?await Jle(r,l,c):await ehe(r,l,c)))()},she=o=>!0,lR=class{constructor(e,t){this.app=e,this.maxRetries=t}async load(e,t,s){try{let i=await(s.file?.contents??fetch(e.load));if(!i||!i.body)t("Error loading resource",null);else{let r=parseInt(i.headers.get("content-length")??"0",10),a=0,n=await the(i.body.getReader(),s.data.elementFilter??she,h=>{a+=h,s&&s.fire("progress",a,r)});s.fire("load:data",n),n.isCompressed||(s.data.reorder??!0)&&n.reorderData();let l=n.isCompressed&&!s.data.decompress?new oR(this.app.graphicsDevice,n):new oc(this.app.graphicsDevice,n.isCompressed?n.decompress():n);t(null,l)}}catch(i){t(i,null)}}open(e,t){return t}}});var ihe,hR,fQ=m(()=>{rt();Ct();KA();$A();Rb();ihe=(o,e)=>{let t=new Map,s=()=>{let i=0,r=0;t.forEach(a=>{i+=a.loaded,r+=a.total}),o.fire("progress",i,r)};e.forEach(i=>{let r=(n,l)=>{t.set(i,{loaded:n,total:l}),s()},a=()=>{i.off("progress",r),i.off("load",a),i.off("error",a)};i.on("progress",r),i.on("load",a),i.on("error",a)})},hR=class{constructor(e,t){this.app=e,this.maxRetries=t}async loadTextures(e,t,s,i){let{assets:r}=this.app,a=["means","quats","scales","sh0","shN"],n={},l=[];a.forEach(u=>{let p=i[u]?.files??[];n[u]=p.map(_=>{let S=new re(_,"texture",{url:s.options?.mapUrl?.(_)??new URL(_,new URL(e.load,window.location.href).toString()).toString(),filename:_},{mipmaps:!1}),T=new Promise((x,A)=>{S.on("load",()=>x(null)),S.on("error",E=>A(E))});return r.add(S),l.push(T),S})});let h=a.map(u=>n[u]).flat();ihe(s,h),h.forEach(u=>r.load(u)),await Promise.allSettled(l);let c=new lc;c.meta=i,c.numSplats=i.means.shape[0],c.means_l=n.means[0].resource,c.means_u=n.means[1].resource,c.quats=n.quats[0].resource,c.scales=n.scales[0].resource,c.sh0=n.sh0[0].resource,c.sh_centroids=n.shN?.[0]?.resource,c.sh_labels=n.shN?.[1]?.resource;let f=s.data?.decompress;f||await c.prepareGpuData();let d=f?new oc(this.app.graphicsDevice,await c.decompress()):new Ep(this.app.graphicsDevice,c);t(null,d)}load(e,t,s){if(s.data?.means)this.loadTextures(e,t,s,s.data);else{typeof e=="string"&&(e={load:e,original:e});let i={retry:this.maxRetries>0,maxRetries:this.maxRetries,responseType:jt.ResponseType.JSON};Le.get(e.load,i,(r,a)=>{r?t(`Error loading gsplat meta: ${e.original} [${r}]`):this.loadTextures(e,t,s,a)})}}}});var kc,QD=m(()=>{Fs();cQ();_t();fQ();kc=class extends ye{constructor(e){super(e,"gsplat"),this.parsers={ply:new lR(e,3),json:new hR(e,3)}}_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}_getParser(e){let t=ve.getExtension(this._getUrlWithoutParams(e)).toLowerCase().replace(".","");return this.parsers[t]||this.parsers.ply}load(e,t,s){typeof e=="string"&&(e={load:e,original:e}),this._getParser(e.original).load(e,t,s)}open(e,t,s){return t}}});var bd,JD=m(()=>{bd=class{static setCompressedPRS(e,t,s){let i=s.singleVecs,r,a,n=t.___1;n||(r=s.tripleVecs,a=t.___2);let l=n?n[0]:r[a];e.setLocalPosition(i[l],i[l+1],i[l+2]),l=n?n[1]:r[a+1],e.setLocalEulerAngles(i[l],i[l+1],i[l+2]),l=n?n[2]:r[a+2],e.setLocalScale(i[l],i[l+1],i[l+2])}static oneCharToKey(e,t){let s=e.charCodeAt(0)-t.fieldFirstCode;return t.fieldArray[s]}static multCharToKey(e,t){let s=0;for(let i=0;i<e.length;i++)s=s*t.fieldCodeBase+e.charCodeAt(i)-t.fieldFirstCode;return t.fieldArray[s]}}});var cR,dQ=m(()=>{JD();cR=class o{constructor(e,t){this._node=e,this._data=t}run(){let e=Object.prototype.toString.call(this._node);return e==="[object Object]"?this._handleMap():e==="[object Array]"?this._handleArray():this._result=this._node,this._result}_handleMap(){this._result={},Object.keys(this._node).forEach(this._handleKey,this)}_handleKey(e){let t=e,s=e.length;s===1?t=bd.oneCharToKey(e,this._data):s===2&&(t=bd.multCharToKey(e,this._data)),this._result[t]=new o(this._node[e],this._data).run()}_handleArray(){this._result=[],this._node.forEach(this._handleArElt,this)}_handleArElt(e){let t=new o(e,this._data).run();this._result.push(t)}}});var Gc,fR=m(()=>{ci();JD();dQ();Gc=class{constructor(e,t){this._app=e,this._isTemplate=t}parse(e){let t={},s=null,i=e.compressedFormat;i&&!e.entDecompressed&&(e.entDecompressed=!0,e.entities=new cR(e.entities,i).run());for(let r in e.entities){let a=e.entities[r],n=this._createEntity(a,i);t[r]=n,a.parent===null&&(s=n)}for(let r in e.entities){let a=t[r],n=e.entities[r].children,l=n.length;for(let h=0;h<l;h++){let c=t[n[h]];c&&a.addChild(c)}}return this._openComponentData(s,e.entities),s}_createEntity(e,t){let s=new be(e.name,this._app);if(s.setGuid(e.resource_id),this._setPosRotScale(s,e,t),s._enabled=e.enabled??!0,this._isTemplate?s._template=!0:s._enabledInHierarchy=s._enabled,s.template=e.template,e.tags)for(let i=0;i<e.tags.length;i++)s.tags.add(e.tags[i]);return s}_setPosRotScale(e,t,s){if(s)bd.setCompressedPRS(e,t,s);else{let i=t.position,r=t.rotation,a=t.scale;e.setLocalPosition(i[0],i[1],i[2]),e.setLocalEulerAngles(r[0],r[1],r[2]),e.setLocalScale(a[0],a[1],a[2])}}_openComponentData(e,t){let s=this._app.systems.list,i=s.length,r=t[e.getGuid()];for(let n=0;n<i;n++){let l=s[n],h=r.components[l.id];h&&l.addComponent(e,h)}i=r.children.length;let a=e._children;for(let n=0;n<i;n++)a[n]&&(a[n]=this._openComponentData(a[n],t));return e}}});var zc,dR=m(()=>{Ct();zc=class{static load(e,t,s){typeof e=="string"&&(e={load:e,original:e}),Le.get(e.load,{retry:t>0,maxRetries:t},(i,r)=>{if(!i)s(i,r);else{let a=`Error while loading scene JSON ${e.original}`;i.message?(a+=`: ${i.message}`,i.stack&&(a+=`
${i.stack}`)):a+=`: ${i}`,s(a)}})}}});var G_,e2=m(()=>{fR();dR();_t();G_=class extends ye{constructor(e){super(e,"hierarchy")}load(e,t){zc.load(e,this.maxRetries,t)}open(e,t){this._app.systems.script.preloading=!0;let i=new Gc(this._app,!1).parse(t);return this._app.systems.script.preloading=!1,i}}});var z_,t2=m(()=>{Ct();_t();z_=class extends ye{constructor(e){super(e,"html"),this.decoder=null}load(e,t){typeof e=="string"&&(e={load:e,original:e}),Le.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(s,i)=>{s?t(`Error loading html resource: ${e.original} [${s}]`):t(null,i)})}openBinary(e){return this.decoder??=new TextDecoder("utf-8"),this.decoder.decode(e)}}});var H_,s2=m(()=>{Ct();_t();H_=class extends ye{constructor(e){super(e,"json"),this.decoder=null}load(e,t){typeof e=="string"&&(e={load:e,original:e});let s={retry:this.maxRetries>0,maxRetries:this.maxRetries};e.load.startsWith("blob:")&&(s.responseType=jt.ResponseType.JSON),Le.get(e.load,s,(i,r)=>{i?t(`Error loading JSON resource: ${e.original} [${i}]`):t(null,r)})}openBinary(e){return this.decoder??=new TextDecoder("utf-8"),JSON.parse(this.decoder.decode(e))}}});var uR,uQ=m(()=>{Fe();J();hp();uR=class{constructor(){this.removeInvalid=!0,this.valid=!0,this.enumValidators={occludeSpecular:this._createEnumValidator([FS,en,US]),cull:this._createEnumValidator([0,1,2,3]),blendType:this._createEnumValidator([xf,yf,es,$t,er,Af,Pf,Rf,Cf,If,wf]),depthFunc:this._createEnumValidator([0,1,2,3,4,5,6,7])}}setInvalid(e,t){this.valid=!1,this.removeInvalid&&delete t[e]}validate(e){let t=rc,s=FV,i=e.mappingFormat==="path";for(let r in e){let a=t[r];if(!a){s[r]?delete e[r]:this.valid=!1;continue}if(a.startsWith("enum")){let n=a.split(":")[1];this.enumValidators[n]&&(this.enumValidators[n](e[r])||this.setInvalid(r,e))}else if(a==="number")typeof e[r]!="number"&&this.setInvalid(r,e);else if(a==="boolean")typeof e[r]!="boolean"&&this.setInvalid(r,e);else if(a==="string")typeof e[r]!="string"&&this.setInvalid(r,e);else if(a==="vec2")e[r]instanceof Array&&e[r].length===2||this.setInvalid(r,e);else if(a==="rgb")e[r]instanceof Array&&e[r].length===3||this.setInvalid(r,e);else if(a==="texture")i?typeof e[r]=="string"||e[r]===null||e[r]instanceof q||this.setInvalid(r,e):typeof e[r]=="number"||e[r]===null||e[r]instanceof q||this.setInvalid(r,e);else if(a==="boundingbox")e[r].center&&e[r].center instanceof Array&&e[r].center.length===3||this.setInvalid(r,e),e[r].halfExtents&&e[r].halfExtents instanceof Array&&e[r].halfExtents.length===3||this.setInvalid(r,e);else if(a==="cubemap")typeof e[r]=="number"||e[r]===null||e[r]===void 0||e[r]instanceof q&&e[r].cubemap||this.setInvalid(r,e);else if(a==="chunks"){let n=Object.keys(e[r]);for(let l=0;l<n.length;l++)typeof e[r][n[l]]!="string"&&this.setInvalid(n[l],e[r])}else console.error(`Unknown material type: ${a}`)}return e.validated=!0,this.valid}_createEnumValidator(e){return function(t){return e.indexOf(t)>=0}}}});var X_,i2=m(()=>{De();Ne();Q();Fe();Vt();ln();uQ();hp();X_=class{constructor(){this._validator=null}parse(e){let t=this.migrate(e),s=this._validate(t),i=new ct;return this.initialize(i,s),i}initialize(e,t){if(t.validated||(t=this._validate(t)),t.chunks&&t.chunks&&Object.keys(t.chunks).length>0){let s=e.shaderChunks.glsl;Object.entries(t.chunks).forEach(([i,r])=>s.set(i,r))}for(let s in t){let i=rc[s],r=t[s];if(i==="vec2")e[s]=new D(r[0],r[1]);else if(i==="rgb")e[s]=new N(r[0],r[1],r[2]);else if(i==="texture")r instanceof q?e[s]=r:e[s]instanceof q&&typeof r=="number"&&r>0||(e[s]=null);else if(i==="cubemap")r instanceof q?e[s]=r:e[s]instanceof q&&typeof r=="number"&&r>0||(e[s]=null),s==="cubeMap"&&!r&&(e.prefilteredCubemaps=null);else if(i==="boundingbox"){let a=new g(r.center[0],r.center[1],r.center[2]),n=new g(r.halfExtents[0],r.halfExtents[1],r.halfExtents[2]);e[s]=new _e(a,n)}else e[s]=t[s]}e.update()}migrate(e){e.shader&&delete e.shader,e.mapping_format&&(e.mappingFormat=e.mapping_format,delete e.mapping_format);let t,s=[["bumpMapFactor","bumpiness"],["aoUvSet","aoMapUv"],["aoMapVertexColor","aoVertexColor"],["diffuseMapVertexColor","diffuseVertexColor"],["emissiveMapVertexColor","emissiveVertexColor"],["specularMapVertexColor","specularVertexColor"],["metalnessMapVertexColor","metalnessVertexColor"],["opacityMapVertexColor","opacityVertexColor"],["glossMapVertexColor","glossVertexColor"],["lightMapVertexColor","lightVertexColor"],["specularMapTint","specularTint"],["metalnessMapTint","metalnessTint"],["clearCoatGlossiness","clearCoatGloss"]];for(t=0;t<s.length;t++){let r=s[t][0],a=s[t][1];e[r]!==void 0&&(e[a]===void 0&&(e[a]=e[r]),delete e[r])}let i=["fresnelFactor","shadowSampleType"];for(t=0;t<i.length;t++){let r=i[t];e.hasOwnProperty(r)&&delete e[r]}return e}_validate(e){return e.validated||(this._validator||(this._validator=new uR),this._validator.validate(e)),e}}});var rhe,W_,r2=m(()=>{Ct();hp();FT();i2();_t();Xv();rhe={aoMap:"white",aoDetailMap:"white",diffuseMap:"gray",diffuseDetailMap:"gray",specularMap:"gray",specularityFactorMap:"white",metalnessMap:"black",glossMap:"gray",sheenMap:"black",sheenGlossMap:"gray",clearCoatMap:"black",clearCoatGlossMap:"gray",clearCoatNormalMap:"normal",refractionMap:"white",emissiveMap:"gray",normalMap:"normal",normalDetailMap:"normal",heightMap:"gray",opacityMap:"gray",sphereMap:"gray",lightMap:"white",thicknessMap:"black",iridescenceMap:"black",iridescenceThicknessMap:"black",envAtlas:"black",anisotropyMap:"black"},W_=class extends ye{constructor(e){super(e,"material"),this._assets=e.assets,this._device=e.graphicsDevice,this._parser=new X_}load(e,t){typeof e=="string"&&(e={load:e,original:e}),Le.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(s,i)=>{s?t&&t(`Error loading material: ${e.original} [${s}]`):t&&(i._engine=!0,t(null,i))})}open(e,t){let s=this._parser.parse(t);return t._engine&&(s._data=t,delete t._engine),s}patch(e,t){e.resource._data&&(e._data=e.resource._data,delete e.resource._data),e.data.name=e.name,e.resource.name=e.name,this._bindAndAssignAssets(e,t),e.off("unload",this._onAssetUnload,this),e.on("unload",this._onAssetUnload,this)}_onAssetUnload(e){delete e.data.parameters,delete e.data.chunks,delete e.data.name}_assignTexture(e,t,s){t.resource[e]=s}_getPlaceholderTexture(e){let t=rhe[e];return Qn(this._device,t)}_assignPlaceholderTexture(e,t){t.resource[e]=this._getPlaceholderTexture(e)}_onTextureLoad(e,t,s){this._assignTexture(e,t,s.resource),t.resource.update()}_onTextureAdd(e,t,s){this._assets.load(s)}_onTextureRemoveOrUnload(e,t,s){let i=t.resource;i&&t.resource[e]===s.resource&&(this._assignPlaceholderTexture(e,t),i.update())}_assignCubemap(e,t,s){if(t.resource[e]=s[0],e==="cubeMap"){let i=s.slice(1);i.every(r=>r)?t.resource.prefilteredCubemaps=i:i[0]&&(t.resource.envAtlas=i[0])}}_onCubemapLoad(e,t,s){this._assignCubemap(e,t,s.resources),this._parser.initialize(t.resource,t.data)}_onCubemapAdd(e,t,s){this._assets.load(s)}_onCubemapRemoveOrUnload(e,t,s){let i=t.resource;t.data.prefilteredCubeMap128===s.resources[1]&&(this._assignCubemap(e,t,[null,null,null,null,null,null,null]),i.update())}_bindAndAssignAssets(e,t){let s=this._parser.migrate(e.data),i=e.resource,r=s.mappingFormat==="path",a=id,n,l,h;for(n=0;n<a.length;n++){l=a[n],h=i._assetReferences[l];let f=s[l],d=i[l],u=d===this._getPlaceholderTexture(l),p=s.validated;f&&(!d||!p||u)?(h||(h=new Oa(l,e,t,{load:this._onTextureLoad,add:this._onTextureAdd,remove:this._onTextureRemoveOrUnload,unload:this._onTextureRemoveOrUnload},this),i._assetReferences[l]=h),r?h.url=e.getAbsoluteUrl(f):h.id=f,h.asset&&(h.asset.resource?this._assignTexture(l,e,h.asset.resource):this._assignPlaceholderTexture(l,e),t.load(h.asset))):h&&(r?h.url=null:h.id=null)}let c=rT;for(n=0;n<c.length;n++)l=c[n],h=i._assetReferences[l],s[l]&&!e.data.prefilteredCubeMap128&&(h||(h=new Oa(l,e,t,{load:this._onCubemapLoad,add:this._onCubemapAdd,remove:this._onCubemapRemoveOrUnload,unload:this._onCubemapRemoveOrUnload},this),i._assetReferences[l]=h),r?h.url=s[l]:h.id=s[l],h.asset&&(h.asset.loaded&&this._assignCubemap(l,e,h.asset.resources),t.load(h.asset)));this._parser.initialize(i,s)}}});var mR,mQ=m(()=>{kD();iR();mR=class{constructor(e){this._device=e.device,this._defaultMaterial=e.defaultMaterial,this._assets=e.assets}parse(e,t,s){wl.parse("filename.glb","",e,this._device,this._assets,s?.options??{},(i,r)=>{if(i)t(i);else{let a=N_.createModel(r,this._defaultMaterial);r.destroy(),t(null,a)}})}}});var ahe,nhe,pR,pQ=m(()=>{Ke();Q();Vt();j();vh();$i();Cr();pS();Zt();Ws();_s();ll();eT();Km();mA();NA();Wf();ahe={points:qr,lines:Mn,lineloop:Cu,linestrip:nh,triangles:As,trianglestrip:rs,trianglefan:Wi},nhe={int8:Ps,uint8:zs,int16:Rs,uint16:mi,int32:ke,uint32:gt,float32:pe},pR=class{constructor(e){this._device=e.device,this._defaultMaterial=e.defaultMaterial}parse(e,t){let s=e.model;if(!s){t(null,null);return}if(s.version<=1){t("JsonModelParser#parse: Trying to parse unsupported model format.");return}let i=this._parseNodes(e),r=this._parseSkins(e,i),a=this._parseVertexBuffers(e),n=this._parseIndexBuffers(e,a),l=this._parseMorphs(e,i,a),h=this._parseMeshes(e,r.skins,l.morphs,a,n.buffer,n.data),c=this._parseMeshInstances(e,i,h,r.skins,r.instances,l.morphs,l.instances),f=new Ys;f.graph=i[0],f.meshInstances=c,f.skinInstances=r.instances,f.morphInstances=l.instances,f.getGraph().syncHierarchy(),t(null,f)}_parseNodes(e){let t=e.model,s=[],i;for(i=0;i<t.nodes.length;i++){let r=t.nodes[i],a=new Ae(r.name);a.setLocalPosition(r.position[0],r.position[1],r.position[2]),a.setLocalEulerAngles(r.rotation[0],r.rotation[1],r.rotation[2]),a.setLocalScale(r.scale[0],r.scale[1],r.scale[2]),a.scaleCompensation=!!r.scaleCompensation,s.push(a)}for(i=1;i<t.parents.length;i++)s[t.parents[i]].addChild(s[i]);return s}_parseSkins(e,t){let s=e.model,i=[],r=[],a,n;for(a=0;a<s.skins.length;a++){let l=s.skins[a],h=[];for(n=0;n<l.inverseBindMatrices.length;n++){let u=l.inverseBindMatrices[n];h[n]=new k().set(u)}let c=new ec(this._device,h,l.boneNames);i.push(c);let f=new ar(c),d=[];for(n=0;n<c.boneNames.length;n++){let u=c.boneNames[n],p=t[0].findByName(u);d.push(p)}f.bones=d,r.push(f)}return{skins:i,instances:r}}_getMorphVertexCount(e,t,s){for(let i=0;i<e.meshes.length;i++){let r=e.meshes[i];if(r.morph===t)return s[r.vertices].numVertices}}_parseMorphs(e,t,s){let i=e.model,r=[],a=[],n,l,h,c,f,d;if(i.morphs){let u=function(p,_,S){let T=new Float32Array(S*3);for(let x=0;x<_.length;x++){let A=_[x]*3;T[A]=p[x*3],T[A+1]=p[x*3+1],T[A+2]=p[x*3+2]}return T};for(n=0;n<i.morphs.length;n++){for(c=i.morphs[n].targets,d=[],h=this._getMorphVertexCount(i,n,s),l=0;l<c.length;l++){let S=c[l].aabb,T=S.min,x=S.max,A=new _e(new g((x[0]+T[0])*.5,(x[1]+T[1])*.5,(x[2]+T[2])*.5),new g((x[0]-T[0])*.5,(x[1]-T[1])*.5,(x[2]-T[2])*.5)),E=c[l].indices,v=c[l].deltaPositions,R=c[l].deltaNormals;E&&(v=u(v,E,h),R=u(R,E,h)),f=new jh({deltaPositions:v,deltaNormals:R,name:c[l].name,aabb:A}),d.push(f)}let p=new po(d,this._device);r.push(p);let _=new br(p);a.push(_)}}return{morphs:r,instances:a}}_parseVertexBuffers(e){let t=e.model,s=[],i={position:te,normal:Pt,tangent:as,blendWeight:hs,blendIndices:Gt,color:nt,texCoord0:ot,texCoord1:ks,texCoord2:jr,texCoord3:$r,texCoord4:Zr,texCoord5:Qr,texCoord6:Jr,texCoord7:ea};for(let r=0;r<t.vertices.length;r++){let a=t.vertices[r],n=[];for(let d in a){let u=a[d];n.push({semantic:i[d],components:u.components,type:nhe[u.type],normalize:i[d]===nt})}let l=new Tt(this._device,n),h=a.position.data.length/a.position.components,c=new mt(this._device,l,h),f=new ua(c);for(let d=0;d<h;d++){for(let u in a){let p=a[u];switch(p.components){case 1:f.element[i[u]].set(p.data[d]);break;case 2:f.element[i[u]].set(p.data[d*2],1-p.data[d*2+1]);break;case 3:f.element[i[u]].set(p.data[d*3],p.data[d*3+1],p.data[d*3+2]);break;case 4:f.element[i[u]].set(p.data[d*4],p.data[d*4+1],p.data[d*4+2],p.data[d*4+3]);break}}f.next()}f.end(),s.push(c)}return s}_parseIndexBuffers(e,t){let s=e.model,i=null,r=null,a,n=0;for(a=0;a<s.meshes.length;a++){let h=s.meshes[a];h.indices!==void 0&&(n+=h.indices.length)}let l=0;for(a=0;a<t.length;a++)l=Math.max(l,t[a].numVertices);return n>0&&(l>65535?(i=new Ls(this._device,2,n),r=new Uint32Array(i.lock())):(i=new Ls(this._device,1,n),r=new Uint16Array(i.lock()))),{buffer:i,data:r}}_parseMeshes(e,t,s,i,r,a){let n=e.model,l=[],h=0;for(let c=0;c<n.meshes.length;c++){let f=n.meshes[c],d=f.aabb,u=d.min,p=d.max,_=new _e(new g((p[0]+u[0])*.5,(p[1]+u[1])*.5,(p[2]+u[2])*.5),new g((p[0]-u[0])*.5,(p[1]-u[1])*.5,(p[2]-u[2])*.5)),S=f.indices!==void 0,T=new Ce(this._device);T.vertexBuffer=i[f.vertices],T.indexBuffer[0]=S?r:null,T.primitive[0].type=ahe[f.type],T.primitive[0].base=S?f.base+h:f.base,T.primitive[0].count=f.count,T.primitive[0].indexed=S,T.skin=f.skin!==void 0?t[f.skin]:null,T.morph=f.morph!==void 0?s[f.morph]:null,T.aabb=_,S&&(a.set(f.indices,h),h+=f.indices.length),l.push(T)}return r!==null&&r.unlock(),l}_parseMeshInstances(e,t,s,i,r,a,n){let l=e.model,h=[],c;for(c=0;c<l.meshInstances.length;c++){let f=l.meshInstances[c],d=t[f.node],u=s[f.mesh],p=new Oe(u,this._defaultMaterial,d);if(u.skin){let _=i.indexOf(u.skin);p.skinInstance=r[_]}if(u.morph){let _=a.indexOf(u.morph);p.morphInstance=n[_]}h.push(p)}return h}}});var Y_,a2=m(()=>{Fs();Ct();Vh();mQ();pQ();_t();Y_=class extends ye{constructor(e){super(e,"model"),this._parsers=[],this.device=e.graphicsDevice,this.assets=e.assets,this.defaultMaterial=va(this.device),this.addParser(new pR(this),(t,s)=>ve.getExtension(t)===".json"),this.addParser(new mR(this),(t,s)=>ve.getExtension(t)===".glb")}load(e,t,s){typeof e=="string"&&(e={load:e,original:e});let i={retry:this.maxRetries>0,maxRetries:this.maxRetries};(e.load.startsWith("blob:")||e.load.startsWith("data:"))&&(ve.getExtension(e.original).toLowerCase()===".glb"?i.responseType=jt.ResponseType.ARRAY_BUFFER:i.responseType=jt.ResponseType.JSON),Le.get(e.load,i,(r,a)=>{if(t)if(r)t(`Error loading model: ${e.original} [${r}]`);else{for(let n=0;n<this._parsers.length;n++){let l=this._parsers[n];if(l.decider(e.original,a)){l.parser.parse(a,(h,c)=>{h?t(h):t(null,c)},s);return}}t("No parsers found")}})}open(e,t){return t}patch(e,t){if(!e.resource)return;let s=e.data,i=this;e.resource.meshInstances.forEach((r,a)=>{if(s.mapping){let n=function(f){f.resource?r.material=f.resource:(f.once("load",n),t.load(f)),f.once("remove",d=>{r.material===d.resource&&(r.material=i.defaultMaterial)})};if(!s.mapping[a]){r.material=i.defaultMaterial;return}let l=s.mapping[a].material,h=s.mapping[a].path,c;if(l!==void 0)l?(c=t.get(l),c?n(c):t.once(`add:${l}`,n)):r.material=i.defaultMaterial;else if(h){let f=e.getAbsoluteUrl(s.mapping[a].path);c=t.getByUrl(f),c?n(c):t.once(`add:url:${f}`,n)}}})}addParser(e,t){this._parsers.push({parser:e,decider:t})}}});var K_,n2=m(()=>{dR();fR();_t();K_=class extends ye{constructor(e){super(e,"scene")}load(e,t){zc.load(e,this.maxRetries,t)}open(e,t){this._app.systems.script.preloading=!0;let i=new Gc(this._app,!1).parse(t),r=this._app.scene;return r.root=i,this._app.applySceneSettings(t.settings),this._app.systems.script.preloading=!1,r}}});var Ll,o2=m(()=>{Ll=class o{static{this._types=[]}static push(e){o._types.push(e)}}});function _Q(){return l2}function Md(o,e){if(l2.has(o))throw new Error(`Script name '${o}' is reserved, please rename the script`);let t=function(s){K.prototype.initEventHandler.call(this),fr.prototype.initScriptType.call(this,s)};return t.prototype=Object.create(fr.prototype),t.prototype.constructor=t,t.extend=fr.extend,t.attributes=new mn(t),$T(t,o,e),t}function $T(o,e,t){if(typeof o!="function")throw new Error(`script class: '${o}' must be a constructor function (i.e. class).`);if(!(o.prototype instanceof pn))throw new Error(`script class: '${fr.__getScriptName(o)}' does not extend pc.Script.`);if(e=e||o.__name||fr.__getScriptName(o),l2.has(e))throw new Error(`script name: '${e}' is reserved, please change script name`);o.__name=e,(t?t.scripts:js.getApplication().scripts).add(o),Ll.push(o)}var l2,gQ,h2=m(()=>{Pe();mT();WT();YP();o2();y_();l2=new Set(["system","entity","create","destroy","swap","move","data","scripts","_scripts","_scriptsIndex","_scriptsData","enabled","_oldState","onEnable","onDisable","onPostStateChange","_onSetEnabled","_checkState","_onBeforeRemove","_onInitializeAttributes","_onInitialize","_onPostInitialize","_onUpdate","_onPostUpdate","_callbacks","_callbackActive","has","get","on","off","fire","once","hasEvent"]);gQ={};mn.reservedNames.forEach((o,e,t)=>{gQ[o]=1});Md.reservedAttributes=gQ});var ohe,q_,c2=m(()=>{bt();s0();o2();h2();c0();_t();y_();ohe=o=>o[0].toLowerCase()+o.substring(1),q_=class extends ye{constructor(e){super(e,"script"),this._scripts={},this._cache={}}clearCache(){for(let e in this._cache){let t=this._cache[e],s=t.parentNode;s&&s.removeChild(t)}this._cache={}}load(e,t){typeof e=="string"&&(e={load:e,original:e});let s=this;vp.app=this._app;let i=(e.load,(n,l,h)=>{if(n)t(n);else{let c={};for(let d=0;d<Ll._types.length;d++)c[Ll._types[d].name]=Ll._types[d];Ll._types.length=0,t(null,c,h);let f=l.split("&hash=")[0];delete s._loader._cache[dc.makeKey(f,"script")]}}),[r]=e.load.split("?");r.endsWith(".mjs")?this._loadModule(r,i):this._loadScript(e.load,i)}open(e,t){return t}patch(e,t){}_loadScript(e,t){let s=document.head,i=document.createElement("script");this._cache[e]=i,i.async=!1,i.addEventListener("error",a=>{t(`Script: ${a.target.src} failed to load`)},!1);let r=!1;i.onload=i.onreadystatechange=function(){!r&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")&&(r=!0,t(null,e,i))},i.src=e,s.appendChild(i)}_loadModule(e,t){let i=ue.browser&&window.location.origin!=="null"?window.location.origin+window.location.pathname:import.meta.url,r=new URL(e,i);import(r.toString()).then(a=>{let n=r.pathname.split("/").pop(),l=this._app.assets.find(n,"script")?.data?.scripts;for(let h in a){let c=a[h];if(c.prototype instanceof pn){let d=ohe(c.name);c.scriptName;let u=c.scriptName??d;$T(c,u),l&&this._app.scripts.addSchema(u,l[u])}}t(null,e,null)}).catch(a=>{t(a)})}}});var j_,f2=m(()=>{Ct();_t();j_=class extends ye{constructor(e){super(e,"shader"),this.decoder=null}load(e,t){typeof e=="string"&&(e={load:e,original:e}),Le.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(s,i)=>{s?t(`Error loading shader resource: ${e.original} [${s}]`):t(null,i)})}openBinary(e){return this.decoder??=new TextDecoder("utf-8"),this.decoder.decode(e)}}});function d2(o){let e=this;e.resource&&(e.resource.atlas=o.resource)}function u2(o){this.registry.load(o)}var $_,m2=m(()=>{Fs();Ct();nb();_t();$_=class extends ye{constructor(e){super(e,"sprite"),this._assets=e.assets,this._device=e.graphicsDevice}load(e,t){typeof e=="string"&&(e={load:e,original:e}),ve.getExtension(e.original)===".json"&&Le.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(s,i)=>{s?t(s):t(null,i)})}open(e,t){let s=new rp(this._device);return e&&(s.__data=t),s}patch(e,t){let s=e.resource;if(s.__data&&(e.data.pixelsPerUnit=s.__data.pixelsPerUnit,e.data.renderMode=s.__data.renderMode,e.data.frameKeys=s.__data.frameKeys,s.__data.textureAtlasAsset)){let i=t.getByUrl(s.__data.textureAtlasAsset);i?e.data.textureAtlasAsset=i.id:console.warn(`Could not find textureatlas with url: ${s.__data.textureAtlasAsset}`)}s.startUpdate(),s.renderMode=e.data.renderMode,s.pixelsPerUnit=e.data.pixelsPerUnit,s.frameKeys=e.data.frameKeys,this._updateAtlas(e),s.endUpdate(),e.off("change",this._onAssetChange,this),e.on("change",this._onAssetChange,this)}_updateAtlas(e){let t=e.resource;if(!e.data.textureAtlasAsset){t.atlas=null;return}this._assets.off(`load:${e.data.textureAtlasAsset}`,d2,e),this._assets.on(`load:${e.data.textureAtlasAsset}`,d2,e);let s=this._assets.get(e.data.textureAtlasAsset);s&&s.resource?t.atlas=s.resource:s?this._assets.load(s):(this._assets.off(`add:${e.data.textureAtlasAsset}`,u2,e),this._assets.on(`add:${e.data.textureAtlasAsset}`,u2,e))}_onAssetChange(e,t,s,i){t==="data"&&s&&s.textureAtlasAsset&&i&&s.textureAtlasAsset!==i.textureAtlasAsset&&(this._assets.off(`load:${i.textureAtlasAsset}`,d2,e),this._assets.off(`add:${i.textureAtlasAsset}`,u2,e))}}});var Dd,p2=m(()=>{fR();Dd=class{constructor(e,t){this._templateRoot=null,this._app=e,this._data=t}instantiate(){return this._templateRoot||this._parseTemplate(),this._templateRoot.clone()}_parseTemplate(){let e=new Gc(this._app,!0);this._templateRoot=e.parse(this._data)}}});var Z_,_2=m(()=>{Ct();p2();_t();Z_=class extends ye{constructor(e){super(e,"template"),this.decoder=null}load(e,t){typeof e=="string"&&(e={load:e,original:e});let s={retry:this.maxRetries>0,maxRetries:this.maxRetries};Le.get(e.load,s,(i,r)=>{i?t(`Error requesting template: ${e.original}`):t(i,r)})}open(e,t){return new Dd(this._app,t)}openBinary(e){return this.decoder??=new TextDecoder("utf-8"),new Dd(this._app,JSON.parse(this.decoder.decode(e)))}}});var Q_,g2=m(()=>{Ct();_t();Q_=class extends ye{constructor(e){super(e,"text"),this.decoder=null}load(e,t){typeof e=="string"&&(e={load:e,original:e}),Le.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(s,i)=>{s?t(`Error loading text resource: ${e.original} [${s}]`):t(null,i)})}openBinary(e){return this.decoder??=new TextDecoder("utf-8"),this.decoder.decode(e)}}});var _R,gR,lhe,J_,S2=m(()=>{Fs();Ne();Ze();j();Ct();ob();_t();_R={repeat:0,clamp:1,mirror:2},gR={nearest:0,linear:1,nearest_mip_nearest:2,linear_mip_nearest:4,nearest_mip_linear:3,linear_mip_linear:5},lhe=/^data\.frames\.(\d+)$/,J_=class extends ye{constructor(e){super(e,"textureatlas"),this._loader=e.loader}load(e,t){typeof e=="string"&&(e={load:e,original:e});let s=this,i=this._loader.getHandler("texture");ve.getExtension(e.original)===".json"?Le.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(r,a)=>{if(r)t(r);else{let n=e.original.replace(".json",".png");s._loader.load(n,"texture",(l,h)=>{l?t(l):t(null,{data:a,texture:h})})}}):i.load(e,t)}open(e,t,s){let i=new ap;if(t.texture&&t.data)i.texture=t.texture,i.__data=t.data;else{let a=this._loader.getHandler("texture").open(e,t,s);if(!a)return null;i.texture=a}return i}patch(e,t){if(!e.resource)return;e.resource.__data&&(e.resource.__data.minfilter!==void 0&&(e.data.minfilter=e.resource.__data.minfilter),e.resource.__data.magfilter!==void 0&&(e.data.magfilter=e.resource.__data.magfilter),e.resource.__data.addressu!==void 0&&(e.data.addressu=e.resource.__data.addressu),e.resource.__data.addressv!==void 0&&(e.data.addressv=e.resource.__data.addressv),e.resource.__data.mipmaps!==void 0&&(e.data.mipmaps=e.resource.__data.mipmaps),e.resource.__data.anisotropy!==void 0&&(e.data.anisotropy=e.resource.__data.anisotropy),e.resource.__data.rgbm!==void 0&&(e.data.rgbm=!!e.resource.__data.rgbm),e.data.frames=e.resource.__data.frames,delete e.resource.__data);let s=e.resource.texture;if(s&&(s.name=e.name,e.data.hasOwnProperty("minfilter")&&s.minFilter!==gR[e.data.minfilter]&&(s.minFilter=gR[e.data.minfilter]),e.data.hasOwnProperty("magfilter")&&s.magFilter!==gR[e.data.magfilter]&&(s.magFilter=gR[e.data.magfilter]),e.data.hasOwnProperty("addressu")&&s.addressU!==_R[e.data.addressu]&&(s.addressU=_R[e.data.addressu]),e.data.hasOwnProperty("addressv")&&s.addressV!==_R[e.data.addressv]&&(s.addressV=_R[e.data.addressv]),e.data.hasOwnProperty("mipmaps")&&s.mipmaps!==e.data.mipmaps&&(s.mipmaps=e.data.mipmaps),e.data.hasOwnProperty("anisotropy")&&s.anisotropy!==e.data.anisotropy&&(s.anisotropy=e.data.anisotropy),e.data.hasOwnProperty("rgbm"))){let r=e.data.rgbm?ti:zt;s.type!==r&&(s.type=r)}e.resource.texture=s;let i={};for(let r in e.data.frames){let a=e.data.frames[r];i[r]={rect:new W(a.rect),pivot:new D(a.pivot),border:new W(a.border)}}e.resource.frames=i,e.off("change",this._onAssetChange,this),e.on("change",this._onAssetChange,this)}_onAssetChange(e,t,s){let i;if(t==="data"||t==="data.frames"){let r={};for(let a in s.frames)i=s.frames[a],r[a]={rect:new W(i.rect),pivot:new D(i.pivot),border:new W(i.border)};e.resource.frames=r}else{let r=t.match(lhe);if(r){let a=r[1];s?(e.resource.frames[a]?(i=e.resource.frames[a],i.rect.set(s.rect[0],s.rect[1],s.rect[2],s.rect[3]),i.pivot.set(s.pivot[0],s.pivot[1]),i.border.set(s.border[0],s.border[1],s.border[2],s.border[3])):e.resource.frames[a]={rect:new W(s.rect),pivot:new D(s.pivot),border:new W(s.border)},e.resource.fire("set:frame",a,e.resource.frames[a])):e.resource.frames[a]&&(delete e.resource.frames[a],e.resource.fire("remove:frame",a))}}}}});function SQ(){let o={cTFETC1:0,cTFETC2:1,cTFBC1:2,cTFBC3:3,cTFPVRTC1_4_RGB:8,cTFPVRTC1_4_RGBA:9,cTFASTC_4x4:10,cTFATC_RGB:11,cTFATC_RGBA_INTERPOLATED_ALPHA:12,cTFRGBA32:13,cTFRGB565:14,cTFRGBA4444:16},e={astc:o.cTFASTC_4x4,dxt:o.cTFBC1,etc1:o.cTFETC1,etc2:o.cTFETC1,pvr:o.cTFPVRTC1_4_RGB,atc:o.cTFATC_RGB,none:o.cTFRGB565},t={astc:o.cTFASTC_4x4,dxt:o.cTFBC3,etc1:o.cTFRGBA4444,etc2:o.cTFETC2,pvr:o.cTFPVRTC1_4_RGBA,atc:o.cTFATC_RGBA_INTERPOLATED_ALPHA,none:o.cTFRGBA4444},s={ETC1:21,ETC2_RGB:22,ETC2_RGBA:23,DXT1:8,DXT5:10,PVRTC_4BPP_RGB_1:26,PVRTC_4BPP_RGBA_1:27,ASTC_4x4:28,ATC_RGB:29,ATC_RGBA:30,R8_G8_B8_A8:7,R5_G6_B5:3,R4_G4_B4_A4:5},i=(E,v)=>{switch(E){case o.cTFETC1:return v.formats.etc2?s.ETC2_RGB:s.ETC1;case o.cTFETC2:return s.ETC2_RGBA;case o.cTFBC1:return s.DXT1;case o.cTFBC3:return s.DXT5;case o.cTFPVRTC1_4_RGB:return s.PVRTC_4BPP_RGB_1;case o.cTFPVRTC1_4_RGBA:return s.PVRTC_4BPP_RGBA_1;case o.cTFASTC_4x4:return s.ASTC_4x4;case o.cTFATC_RGB:return s.ATC_RGB;case o.cTFATC_RGBA_INTERPOLATED_ALPHA:return s.ATC_RGBA;case o.cTFRGBA32:return s.R8_G8_B8_A8;case o.cTFRGB565:return s.R5_G6_B5;case o.cTFRGBA4444:return s.R4_G4_B4_A4}},r=E=>{let v=function(R,P){let y=R*.00784313725490196-1,C=P*(2/255)-1,L=Math.sqrt(1-Math.min(1,y*y+C*C));return Math.max(0,Math.min(255,Math.floor((L+1)*.5*255)))};for(let R=0;R<E.length;R+=4){let P=E[R+3],y=E[R+1];E[R+0]=P,E[R+2]=v(P,y),E[R+3]=255}return E},a=E=>{let v=new Uint16Array(E.length/4);for(let R=0;R<E.length;R+=4){let P=E[R+0],y=E[R+1],C=E[R+2];v[R/4]=(P&248)<<8|(y&252)<<3|C>>3}return v},n=(E,v)=>(E&E-1)===0&&(v&v-1)===0,l=()=>typeof performance<"u"?performance.now():0,h,c,f,d=(E,v,R)=>{if(R){if(E.formats.astc)return"astc"}else if(v){if(E.formats.etc2)return"etc2"}else{if(E.formats.etc2)return"etc2";if(E.formats.etc1)return"etc1"}return(y=>{for(let C=0;C<y.length;++C){let L=y[C];if(E.formats[L])return L}return"none"})(v?f:c)},u=(E,v,R)=>{switch(R){case o.cTFETC1:case o.cTFETC2:return!0;case o.cTFBC1:case o.cTFBC3:return(E&3)===0&&(v&3)===0;case o.cTFPVRTC1_4_RGB:case o.cTFPVRTC1_4_RGBA:return n(E,v);case o.cTFASTC_4x4:return!0;case o.cTFATC_RGB:case o.cTFATC_RGBA_INTERPOLATED_ALPHA:return!0}return!1},p=(E,v,R)=>{if(!h.KTX2File)throw new Error("Basis transcoder module does not include support for KTX2.");let P=l(),y=new h.KTX2File(new Uint8Array(v)),C=y.getWidth(),L=y.getHeight(),O=y.getLevels(),M=!!y.getHasAlpha(),U=y.isUASTC&&y.isUASTC();if(!C||!L||!O)throw y.close(),y.delete(),new Error(`Invalid image dimensions url=${E} width=${C} height=${L} levels=${O}`);let G=d(R.deviceDetails,M,U),$=!!R.isGGGR&&G==="pvr",X;if($?X=o.cTFRGBA32:(X=M?t[G]:e[G],u(C,L,X)||(X=M?o.cTFRGBA32:o.cTFRGB565)),!y.startTranscoding())throw y.close(),y.delete(),new Error(`Failed to start transcoding url=${E}`);let I,b=[];for(let F=0;F<O;++F){let B=y.getImageTranscodedSizeInBytes(F,0,0,X),V=new Uint8Array(B);if(!y.transcodeImage(V,F,0,0,X,0,-1,-1))throw y.close(),y.delete(),new Error(`Failed to transcode image url=${E}`);let z=X===o.cTFRGB565||X===o.cTFRGBA4444;b.push(z?new Uint16Array(V.buffer):V)}if(y.close(),y.delete(),$)for(X=o.cTFRGB565,I=0;I<b.length;++I)b[I]=a(r(b[I]));return{format:i(X,R.deviceDetails),width:C,height:L,levels:b,cubemap:!1,transcodeTime:l()-P,url:E,unswizzledGGGR:$}},_=(E,v,R)=>{let P=l(),y=new h.BasisFile(new Uint8Array(v)),C=y.getImageWidth(0,0),L=y.getImageHeight(0,0),O=y.getNumImages(),M=y.getNumLevels(0),U=!!y.getHasAlpha(),G=y.isUASTC&&y.isUASTC();if(!C||!L||!O||!M)throw y.close(),y.delete(),new Error(`Invalid image dimensions url=${E} width=${C} height=${L} images=${O} levels=${M}`);let $=d(R.deviceDetails,U,G),X=!!R.isGGGR&&$==="pvr",I;if(X?I=o.cTFRGBA32:(I=U?t[$]:e[$],u(C,L,I)||(I=U?o.cTFRGBA32:o.cTFRGB565)),!y.startTranscoding())throw y.close(),y.delete(),new Error(`Failed to start transcoding url=${E}`);let b,F=[];for(let B=0;B<M;++B){let V=y.getImageTranscodedSizeInBytes(0,B,I),z=new Uint8Array(V);if(!y.transcodeImage(z,0,B,I,0,0))if(B===M-1&&V===F[B-1].buffer.byteLength)z.set(new Uint8Array(F[B-1].buffer)),console.warn(`Failed to transcode last mipmap level, using previous level instead url=${E}`);else throw y.close(),y.delete(),new Error(`Failed to transcode image url=${E}`);let ee=I===o.cTFRGB565||I===o.cTFRGBA4444;F.push(ee?new Uint16Array(z.buffer):z)}if(y.close(),y.delete(),X)for(I=o.cTFRGB565,b=0;b<F.length;++b)F[b]=a(r(F[b]));return{format:i(I,R.deviceDetails),width:C,height:L,levels:F,cubemap:!1,transcodeTime:l()-P,url:E,unswizzledGGGR:X}},S=(E,v,R)=>R.isKTX2?p(E,v,R):_(E,v,R),T=(E,v,R)=>{try{let P=S(E,v,R);P.levels=P.levels.map(y=>y.buffer),self.postMessage({url:E,data:P},P.levels)}catch(P){self.postMessage({url:E,err:P},null)}},x=(E,v)=>{let R=(P,y)=>(WebAssembly.instantiate(E.module,P).then(C=>{y(C)}).catch(C=>{console.error(`instantiate failed + ${C}`)}),{});self.BASIS(E.module?{instantiateWasm:R}:null).then(P=>{P.initializeBasis(),h=P,c=E.rgbPriority,f=E.rgbaPriority,v(null)})},A=[];self.onmessage=E=>{let v=E.data;switch(v.type){case"init":x(v.config,()=>{for(let R=0;R<A.length;++R)T(A[R].url,A[R].data,A[R].options);A.length=0});break;case"transcode":h?T(v.url,v.data,v.options):A.push(v);break}}}var TQ=m(()=>{});function A2(o){if(!y2){if(!o)o=EQ||{};else if(o.lazyInit){EQ=o;return}if(!o.glueUrl||!o.wasmUrl||!o.fallbackUrl){let e=Wl.getConfig("BASIS");e&&(o={glueUrl:e.glueUrl,wasmUrl:e.wasmUrl,fallbackUrl:e.fallbackUrl,numWorkers:e.numWorkers})}if(o.glueUrl||o.wasmUrl||o.fallbackUrl){y2=!0;let e=Math.max(1,Math.min(16,o.numWorkers||fhe)),t=o.numWorkers===1||(o.hasOwnProperty("eagerWorkers")?o.eagerWorkers:!0);o.rgbPriority=o.rgbPriority||dhe,o.rgbaPriority=o.rgbaPriority||uhe,o.maxRetries=o.hasOwnProperty("maxRetries")?o.maxRetries:mhe,che(o,(s,i)=>{if(s)console.error(`failed to initialize basis worker: ${s}`);else for(let r=0;r<e;++r)x2.enqueueClient(new v2(x2,i,t))})}}}function SR(o,e,t,s,i){return A2(),T2||(T2={formats:hhe(o)}),x2.enqueueJob(e,t,s,{deviceDetails:T2,isGGGR:!!i?.isGGGR,isKTX2:!!i?.isKTX2}),y2}var hhe,che,E2,v2,fhe,dhe,uhe,mhe,x2,EQ,y2,T2,TR=m(()=>{RE();TQ();Ct();hhe=o=>({astc:!!o.extCompressedTextureASTC,atc:!!o.extCompressedTextureATC,dxt:!!o.extCompressedTextureS3TC,etc1:!!o.extCompressedTextureETC1,etc2:!!o.extCompressedTextureETC,pvr:!!o.extCompressedTexturePVRTC}),che=(o,e)=>{let t=a=>{let n=["/* basis */",a,"",`(${SQ.toString()})()

`].join(`
`);return new Blob([n],{type:"application/javascript"})},s=()=>{try{if(typeof WebAssembly=="object"&&typeof WebAssembly.instantiate=="function"){let a=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(a instanceof WebAssembly.Module)return new WebAssembly.Instance(a)instanceof WebAssembly.Instance}}catch{}return!1},i=(a,n)=>{e(null,{workerUrl:URL.createObjectURL(t(a)),module:n,rgbPriority:o.rgbPriority,rgbaPriority:o.rgbaPriority})},r={cache:!0,responseType:"text",retry:o.maxRetries>0,maxRetries:o.maxRetries};if(o.glueUrl&&o.wasmUrl&&s()){let a=null,n=null;Le.get(o.glueUrl,r,(c,f)=>{c?e(c):n?i(f,n):a=f});let l=fetch(o.wasmUrl),h=()=>{l.then(c=>c.arrayBuffer()).then(c=>WebAssembly.compile(c)).then(c=>{a?i(a,c):n=c}).catch(c=>{e(c,null)})};WebAssembly.compileStreaming?WebAssembly.compileStreaming(l).then(c=>{a?i(a,c):n=c}).catch(c=>{h()}):h()}else Le.get(o.fallbackUrl,r,(a,n)=>{a?e(a,null):i(n,null)})},E2=class{constructor(){this.callbacks={},this.queue=[],this.clients=[]}enqueueJob(e,t,s,i){if(this.callbacks.hasOwnProperty(e))this.callbacks[e].push(s);else{this.callbacks[e]=[s];let r={url:e,data:t,options:i};this.clients.length>0?this.clients.shift().run(r):this.queue.push(r)}}enqueueClient(e){this.queue.length>0?e.run(this.queue.shift()):this.clients.push(e)}handleResponse(e,t,s){let i=this.callbacks[e];if(t)for(let r=0;r<i.length;++r)i[r](t);else{s.format===3||s.format===5?s.levels=s.levels.map(r=>new Uint16Array(r)):s.levels=s.levels.map(r=>new Uint8Array(r));for(let r=0;r<i.length;++r)i[r](null,s)}delete this.callbacks[e]}},v2=class{constructor(e,t,s){this.queue=e,this.worker=new Worker(t.workerUrl),this.worker.addEventListener("message",i=>{let r=i.data;this.queue.handleResponse(r.url,r.err,r.data),this.eager||this.queue.enqueueClient(this)}),this.worker.postMessage({type:"init",config:t}),this.eager=s}run(e){let t=[];e.data instanceof ArrayBuffer&&t.push(e.data),this.worker.postMessage({type:"transcode",url:e.url,format:e.format,data:e.data,options:e.options},t),this.eager&&this.queue.enqueueClient(this)}},fhe=1,dhe=["etc2","etc1","astc","dxt","pvr","atc"],uhe=["astc","dxt","etc2","pvr","atc"],mhe=5,x2=new E2,EQ=null,y2=!1;T2=null});var dr,Od=m(()=>{dr=class{load(e,t,s){throw new Error("not implemented")}open(e,t,s){throw new Error("not implemented")}}});var ER,vQ=m(()=>{j();Fe();rt();TR();Od();ER=class extends dr{constructor(e,t){super(),this.device=t,this.maxRetries=0}load(e,t,s){let i=this.device,r=a=>{SR(i,e.load,a,t,{isGGGR:(s?.file?.variants?.basis?.opt&8)!==0})||t(`Basis module not found. Asset [${s.name}](${s.getFileUrl()}) basis texture variant will not be loaded.`)};re.fetchArrayBuffer(e.load,(a,n)=>{a?t(a):r(n)},s,this.maxRetries)}open(e,t,s,i={}){let r=i.srgb?bn(t.format):t.format,a=new q(s,{name:e,addressU:t.cubemap?1:0,addressV:t.cubemap?1:0,width:t.width,height:t.height,format:r,cubemap:t.cubemap,levels:t.levels,...i});return a.upload(),a}}});var vR,xQ=m(()=>{Fe();Ct();Ap();Od();vR=class extends dr{constructor(e,t){super(),this.crossOrigin=e.prefix?"anonymous":null,this.maxRetries=0,this.device=t}load(e,t,s){let i=!!s?.file?.contents;if(i){if(this.device.supportsImageBitmap){this._loadImageBitmapFromBlob(new Blob([s.file.contents]),t);return}e={load:URL.createObjectURL(new Blob([s.file.contents])),original:e.original}}let r=(n,l)=>{i&&URL.revokeObjectURL(e.load),t(n,l)},a;s&&s.options&&s.options.hasOwnProperty("crossOrigin")?a=s.options.crossOrigin:La.test(e.load)&&(a=this.crossOrigin),this.device.supportsImageBitmap?this._loadImageBitmap(e.load,e.original,a,r,s):this._loadImage(e.load,e.original,a,r,s)}open(e,t,s,i={}){let r=new q(s,{name:e,width:t.width,height:t.height,format:i.srgb?20:7,...i});return r.setSource(t),r}_loadImage(e,t,s,i,r){let a=new Image;s&&(a.crossOrigin=s);let n=0,l=this.maxRetries,h,c=1024*1024;r?.fire("progress",0,c),a.onload=function(){r?.fire("progress",c,c),i(null,a)},a.onerror=function(){if(!h)if(l>0&&++n<=l){let f=Math.pow(2,n)*100;console.log(`Error loading Texture from: '${t}' - Retrying in ${f}ms...`);let u=e.indexOf("?")>=0?"&":"?";h=setTimeout(()=>{a.src=`${e+u}retry=${Date.now()}`,h=null},f)}else i(`Error loading Texture from: '${t}'`)},a.src=e}_loadImageBitmap(e,t,s,i,r){let a={cache:!0,responseType:"blob",retry:this.maxRetries>0,maxRetries:this.maxRetries,progress:r};Le.get(e,a,(n,l)=>{n?i(n):this._loadImageBitmapFromBlob(l,i)})}_loadImageBitmapFromBlob(e,t){createImageBitmap(e,{premultiplyAlpha:"none",colorSpaceConversion:"none"}).then(s=>t(null,s)).catch(s=>t(s))}}});function _he(o,e,t,s){return o===18?new Uint32Array(e,t,s/4):new Uint8Array(e,t,s)}var P2,phe,xR,yQ=m(()=>{j();Fe();rt();Od();P2=[1481919403,3140563232,169478669],phe={33776:8,33778:9,33779:10,36196:21,37492:22,37496:23,35840:26,35841:24,35842:27,35843:25,32849:6,32856:7,35905:19,35907:20,35898:18,34843:11,34842:12};xR=class extends dr{constructor(e){super(),this.maxRetries=0}load(e,t,s){re.fetchArrayBuffer(e.load,t,s,this.maxRetries)}open(e,t,s,i={}){let r=this.parse(t);if(!r)return null;let a=i.srgb?bn(r.format):r.format,n=new q(s,{name:e,addressU:r.cubemap?1:0,addressV:r.cubemap?1:0,width:r.width,height:r.height,format:a,cubemap:r.cubemap,levels:r.levels,...i});return n.upload(),n}parse(e){let t=new Uint32Array(e);if(P2[0]!==t[0]||P2[1]!==t[1]||P2[2]!==t[2])return null;let s={endianness:t[3],glType:t[4],glTypeSize:t[5],glFormat:t[6],glInternalFormat:t[7],glBaseInternalFormat:t[8],pixelWidth:t[9],pixelHeight:t[10],pixelDepth:t[11],numberOfArrayElements:t[12],numberOfFaces:t[13],numberOfMipmapLevels:t[14],bytesOfKeyValueData:t[15]};if(s.pixelDepth>1||s.numberOfArrayElements!==0)return null;let i=phe[s.glInternalFormat];if(i===void 0)return null;let r=16+s.bytesOfKeyValueData/4,a=s.numberOfFaces>1,n=[];for(let l=0;l<(s.numberOfMipmapLevels||1);l++){let h=t[r++];a&&n.push([]);let c=a?n[l]:n;for(let f=0;f<(a?6:1);++f)c.push(_he(i,e,r*4,h)),r+=h+3>>2}return{format:i,width:s.pixelWidth,height:s.pixelHeight,levels:n,cubemap:a}}}});var ghe,yR,AQ=m(()=>{CE();j();Fe();rt();TR();Od();ghe={KHR_DF_MODEL_UASTC:166},yR=class extends dr{constructor(e,t){super(),this.maxRetries=0,this.device=t}load(e,t,s){re.fetchArrayBuffer(e.load,(i,r)=>{i?t(i,r):this.parse(r,e,t,s)},s,this.maxRetries)}open(e,t,s,i={}){let r=i.srgb?bn(t.format):t.format,a=new q(s,{name:e,addressU:t.cubemap?1:0,addressV:t.cubemap?1:0,width:t.width,height:t.height,format:r,cubemap:t.cubemap,levels:t.levels,...i});return a.upload(),a}parse(e,t,s,i){let r=new Yl(e),a=[r.readU32be(),r.readU32be(),r.readU32be()];if(a[0]!==2873840728||a[1]!==540160187||a[2]!==218765834)return null;let n={vkFormat:r.readU32(),typeSize:r.readU32(),pixelWidth:r.readU32(),pixelHeight:r.readU32(),pixelDepth:r.readU32(),layerCount:r.readU32(),faceCount:r.readU32(),levelCount:r.readU32(),supercompressionScheme:r.readU32()},l={dfdByteOffset:r.readU32(),dfdByteLength:r.readU32(),kvdByteOffset:r.readU32(),kvdByteLength:r.readU32(),sgdByteOffset:r.readU64(),sgdByteLength:r.readU64()},h=[];for(let d=0;d<Math.max(1,n.levelCount);++d)h.push({byteOffset:r.readU64(),byteLength:r.readU64(),uncompressedByteLength:r.readU64()});if(r.readU32()!==l.kvdByteOffset-l.dfdByteOffset)return null;r.skip(8);let f=r.readU8();r.skip(l.dfdByteLength-9),r.skip(l.kvdByteLength),n.supercompressionScheme===1||f===ghe.KHR_DF_MODEL_UASTC?SR(this.device,t.load,e,s,{isGGGR:(i?.file?.variants?.basis?.opt&8)!==0,isKTX2:!0})||s(`Basis module not found. Asset [${i.name}](${i.getFileUrl()}) basis texture variant will not be loaded.`):s("unsupported KTX2 pixel format")}}});var AR,PQ=m(()=>{Fe();rt();Od();AR=class extends dr{constructor(e){super(),this.maxRetries=0}load(e,t,s){re.fetchArrayBuffer(e.load,t,s,this.maxRetries)}open(e,t,s,i={}){let r=new Uint32Array(t,0,32),a=r[4],n=r[3],l=Math.max(r[7],1),h=r[20]===4,c=r[21],f=r[22],d=r[28]===65024,u=827611204,p=894720068,_=113,S=116,T=826496069,x=825438800,A=825504336,E=825439312,v=825504848,R=!1,P=!1,y=!1,C=!1,L=null,O=1,M;if(h?c===u?(L=8,R=!0):c===p?(L=10,R=!0):c===_?(L=12,O=2):c===S?(L=14,O=4):c===T?(L=21,R=!0,P=!0):c===x||c===A?(L=c===x?24:25,R=!0,y=!0):(c===E||c===v)&&(L=c===E?26:27,R=!0,C=!0):f===32&&(L=7),!L)return M=new q(s,{width:4,height:4,format:6,name:"dds-legacy-empty"}),M;M=new q(s,{name:e,addressU:d?1:0,addressV:d?1:0,width:a,height:n,format:L,cubemap:d,mipmaps:l>1,...i});let U=128,G=d?6:1,$,X=4,I=4,b=c===u?8:16,F,B,V;for(let z=0;z<G;z++){let ee=a,se=n;for(let Y=0;Y<l;Y++){R?P?$=Math.floor((ee+3)/4)*Math.floor((se+3)/4)*8:y?$=Math.max(ee,16)*Math.max(se,8)/4:C?$=Math.max(ee,8)*Math.max(se,8)/2:(F=Math.floor((ee+X-1)/X),B=Math.floor((se+I-1)/I),V=F*B,$=V*b):$=ee*se*4;let ne=L===14?new Float32Array(t,U,$):L===12?new Uint16Array(t,U,$):new Uint8Array(t,U,$);d?(M._levels[Y]||(M._levels[Y]=[]),M._levels[Y][z]=ne):M._levels[Y]=ne,U+=$*O,ee=Math.max(ee*.5,1),se=Math.max(se*.5,1)}}return M.upload(),M}}});var PR,RQ=m(()=>{CE();j();Fe();rt();Od();PR=class extends dr{constructor(e){super(),this.maxRetries=0}load(e,t,s){re.fetchArrayBuffer(e.load,t,s,this.maxRetries),s.data&&!s.data.type&&(s.data.type=zo)}open(e,t,s,i={}){let r=this.parse(t);if(!r)return null;let a=new q(s,{name:e,addressU:0,addressV:1,minFilter:0,magFilter:0,width:r.width,height:r.height,levels:r.levels,format:7,type:zo,mipmaps:!1,...i});return a.upload(),a}parse(e){let t=new Yl(e);if(!t.readLine().startsWith("#?RADIANCE"))return null;let i={};for(;;){let h=t.readLine();if(h.length===0)break;{let c=h.split("=");c.length===2&&(i[c[0]]=c[1])}}if(!i.hasOwnProperty("FORMAT"))return null;let r=t.readLine().split(" ");if(r.length!==4)return null;let a=parseInt(r[1],10),n=parseInt(r[3],10),l=this._readPixels(t,n,a,r[0]==="-Y");return l?{width:n,height:a,levels:[l]}:null}_readPixels(e,t,s,i){if(t<8||t>32767)return this._readPixelsFlat(e,t,s);let r=[0,0,0,0];if(e.readArray(r),r[0]!==2||r[1]!==2||(r[2]&128)!==0)return e.skip(-4),this._readPixelsFlat(e,t,s);let a=new ArrayBuffer(t*s*4),n=new Uint8Array(a),l=i?0:t*4*(s-1),h,c,f,d,u,p;for(c=0;c<s;++c){if(c&&e.readArray(r),(r[2]<<8)+r[3]!==t)return null;for(d=0;d<4;++d)for(h=0;h<t;)if(u=e.readU8(),u>128){if(u-=128,h+u>t)return null;for(p=e.readU8(),f=0;f<u;++f)n[l+d+4*h++]=p}else{if(u===0||h+u>t)return null;for(f=0;f<u;++f)n[l+d+4*h++]=e.readU8()}l+=t*4*(i?1:-1)}return n}_readPixelsFlat(e,t,s){return e.remainingBytes===t*s*4?new Uint8Array(e.arraybuffer,e.offset):null}}});var CQ,IQ,She,The,Hc,R2=m(()=>{Fs();j();Fe();_f();vQ();xQ();yQ();AQ();PQ();RQ();_t();CQ={repeat:0,clamp:1,mirror:2},IQ={nearest:0,linear:1,nearest_mip_nearest:2,linear_mip_nearest:4,nearest_mip_linear:3,linear_mip_linear:5},She={default:zt,rgbm:ti,rgbe:zo,rgbp:On,swizzleGGGR:Nn},The=function(o){let e=Cs.calcMipLevelsCount(o._width,o._height),t=function(i){return i instanceof HTMLCanvasElement||i instanceof HTMLImageElement||i instanceof HTMLVideoElement};if(!(o._format===7||o._format===14)||o._volume||o._compressed||o._levels.length===1||o._levels.length===e||t(o._cubemap?o._levels[0][0]:o._levels[0]))return;let s=function(i,r,a){let n=Math.max(1,i>>1),l=Math.max(1,r>>1),h=new a.constructor(n*l*4),c=Math.floor(i/n),f=Math.floor(r/l),d=c*f;for(let u=0;u<l;++u)for(let p=0;p<n;++p)for(let _=0;_<4;++_){let S=0;for(let T=0;T<f;++T)for(let x=0;x<c;++x)S+=a[(p*c+x+(u*f+T)*i)*4+_];h[(p+u*n)*4+_]=S/d}return h};for(let i=o._levels.length;i<e;++i){let r=Math.max(1,o._width>>i-1),a=Math.max(1,o._height>>i-1);if(o._cubemap){let n=[];for(let l=0;l<6;++l)n.push(s(r,a,o._levels[i-1][l]));o._levels.push(n)}else o._levels.push(s(r,a,o._levels[i-1]))}o._levelsUpdated=o._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0]},Hc=class extends ye{constructor(e){super(e,"texture");let t=e.assets,s=e.graphicsDevice;this._device=s,this._assets=t,this.imgParser=new vR(t,s),this.parsers={dds:new AR(t),ktx:new xR(t),ktx2:new yR(t,s),basis:new ER(t,s),hdr:new PR(t)}}set crossOrigin(e){this.imgParser.crossOrigin=e}get crossOrigin(){return this.imgParser.crossOrigin}set maxRetries(e){this.imgParser.maxRetries=e;for(let t in this.parsers)this.parsers.hasOwnProperty(t)&&(this.parsers[t].maxRetries=e)}get maxRetries(){return this.imgParser.maxRetries}_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}_getParser(e){let t=ve.getExtension(this._getUrlWithoutParams(e)).toLowerCase().replace(".","");return this.parsers[t]||this.imgParser}_getTextureOptions(e){let t={};if(e){e.name?.length>0&&(t.name=e.name);let s=e.data;s.hasOwnProperty("minfilter")&&(t.minFilter=IQ[s.minfilter]),s.hasOwnProperty("magfilter")&&(t.magFilter=IQ[s.magfilter]),s.hasOwnProperty("addressu")&&(t.addressU=CQ[s.addressu]),s.hasOwnProperty("addressv")&&(t.addressV=CQ[s.addressv]),s.hasOwnProperty("mipmaps")&&(t.mipmaps=s.mipmaps),s.hasOwnProperty("anisotropy")&&(t.anisotropy=s.anisotropy),s.hasOwnProperty("flipY")&&(t.flipY=!!s.flipY),s.hasOwnProperty("srgb")&&(t.srgb=!!s.srgb),t.type=zt,s.hasOwnProperty("type")?t.type=She[s.type]:s.hasOwnProperty("rgbm")&&s.rgbm?t.type=ti:e.file&&(e.file.opt&8)!==0&&(t.type=Nn)}return t}load(e,t,s){typeof e=="string"&&(e={load:e,original:e}),this._getParser(e.original).load(e,t,s)}open(e,t,s){if(!e)return;let i=this._getTextureOptions(s),r=this._getParser(e).open(e,t,this._device,i);return r===null?r=new q(this._device,{width:4,height:4,format:6}):(The(r),t.unswizzledGGGR&&(s.file.variants.basis.opt&=-9)),r}patch(e,t){let s=e.resource;if(!s)return;let i=this._getTextureOptions(e);for(let r of Object.keys(i))s[r]=i[r]}}});var RR,CR,Ro,ZT,wQ,LQ,bQ,MQ,DQ,OQ,NQ,FQ,UQ,BQ,VQ,IR,kQ,GQ,zQ,HQ,wR,eg,tg,sg,ig,Nd=m(()=>{RR="inline",CR="immersive-vr",Ro="immersive-ar",ZT="viewer",wQ="local",LQ="local-floor",bQ="bounded-floor",MQ="unbounded",DQ="gaze",OQ="screen",NQ="tracked-pointer",FQ="none",UQ="left",BQ="right",VQ="none",IR="left",kQ="right",GQ="point",zQ="plane",HQ="mesh",wR="cpu-optimized",eg="gpu-optimized",tg="luminance-alpha",sg="unsigned-short",ig="float32"});var rg,C2=m(()=>{bt();rg=class{constructor(e){this._supported=ue.browser&&!!window.XRDOMOverlayState,this._root=null,this._manager=e}get supported(){return this._supported}get available(){return this._supported&&this._manager.active&&this._manager._session.domOverlayState!==null}get state(){return!this._supported||!this._manager.active||!this._manager._session.domOverlayState?null:this._manager._session.domOverlayState.type}set root(e){!this._supported||this._manager.active||(this._root=e)}get root(){return this._root}}});var LR,XQ,ag,I2=m(()=>{Pe();Ve();Q();LR=[],XQ=[],ag=class extends K{static{this.EVENT_REMOVE="remove"}static{this.EVENT_RESULT="result"}constructor(e,t,s,i=null){super(),this.manager=e,this._xrHitTestSource=t,this._transient=s,this._inputSource=i}remove(){if(!this._xrHitTestSource)return;let e=this.manager.hitTest.sources,t=e.indexOf(this);t!==-1&&e.splice(t,1),this.onStop()}onStop(){this._xrHitTestSource.cancel(),this._xrHitTestSource=null,this.fire("remove"),this.manager.hitTest.fire("remove",this)}update(e){if(this._transient){let t=e.getHitTestResultsForTransientInput(this._xrHitTestSource);for(let s=0;s<t.length;s++){let i=t[s];if(!i.results.length)continue;let r;i.inputSource&&(r=this.manager.input._getByInputSource(i.inputSource)),this.updateHitResults(i.results,r)}}else{let t=e.getHitTestResults(this._xrHitTestSource);if(!t.length)return;this.updateHitResults(t)}}updateHitResults(e,t){if(this._inputSource&&this._inputSource!==t)return;let s=LR.pop()??new g;t?s.copy(t.getOrigin()):s.copy(this.manager.camera.getPosition());let i=1/0,r=null,a=LR.pop()??new g,n=XQ.pop()??new H;for(let l=0;l<e.length;l++){let h=e[l].getPose(this.manager._referenceSpace),c=s.distance(h.transform.position);c>=i||(i=c,r=e[l],a.copy(h.transform.position),n.copy(h.transform.orientation))}this.fire("result",a,n,t||this._inputSource,r),this.manager.hitTest.fire("result",this,a,n,t||this._inputSource,r),LR.push(s),LR.push(a),XQ.push(n)}}});var ng,w2=m(()=>{bt();Pe();Nd();I2();ng=class extends K{static{this.EVENT_AVAILABLE="available"}static{this.EVENT_UNAVAILABLE="unavailable"}static{this.EVENT_ADD="add"}static{this.EVENT_REMOVE="remove"}static{this.EVENT_RESULT="result"}static{this.EVENT_ERROR="error"}constructor(e){super(),this._supported=ue.browser&&!!(window.XRSession&&window.XRSession.prototype.requestHitTestSource),this._available=!1,this._checkingAvailability=!1,this.sources=[],this.manager=e,this._supported&&(this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this))}_onSessionStart(){if(this.manager.session.enabledFeatures){let e=this.manager.session.enabledFeatures.indexOf("hit-test")!==-1;if(!e)return;this._available=e,this.fire("available")}else this._checkingAvailability||(this._checkingAvailability=!0,this.manager.session.requestReferenceSpace(ZT).then(e=>{this.manager.session.requestHitTestSource({space:e}).then(t=>{t.cancel(),this.manager.active&&(this._available=!0,this.fire("available"))}).catch(()=>{})}).catch(()=>{}))}_onSessionEnd(){if(this._available){this._available=!1;for(let e=0;e<this.sources.length;e++)this.sources[e].onStop();this.sources=[],this.fire("unavailable")}}start(e={}){if(!this._supported){e.callback?.(new Error("XR HitTest is not supported"),null);return}if(!this._available){e.callback?.(new Error("XR HitTest is not available"),null);return}!e.profile&&!e.spaceType&&(e.spaceType=ZT);let t,s=e.offsetRay;if(s){let r=new DOMPoint(s.origin.x,s.origin.y,s.origin.z,1),a=new DOMPoint(s.direction.x,s.direction.y,s.direction.z,0);t=new XRRay(r,a)}let i=e.callback;e.spaceType?this.manager.session.requestReferenceSpace(e.spaceType).then(r=>{if(!this.manager.session){let a=new Error("XR Session is not started (2)");i&&i(a),this.fire("error",a);return}this.manager.session.requestHitTestSource({space:r,entityTypes:e.entityTypes||void 0,offsetRay:t}).then(a=>{this._onHitTestSource(a,!1,e.inputSource,i)}).catch(a=>{i&&i(a),this.fire("error",a)})}).catch(r=>{i&&i(r),this.fire("error",r)}):this.manager.session.requestHitTestSourceForTransientInput({profile:e.profile,entityTypes:e.entityTypes||void 0,offsetRay:t}).then(r=>{this._onHitTestSource(r,!0,e.inputSource,i)}).catch(r=>{i&&i(r),this.fire("error",r)})}_onHitTestSource(e,t,s,i){if(!this.manager.session){e.cancel();let a=new Error("XR Session is not started (3)");i&&i(a),this.fire("error",a);return}let r=new ag(this.manager,e,t,s??null);this.sources.push(r),i&&i(null,r),this.fire("add",r)}update(e){if(this._available)for(let t=0;t<this.sources.length;t++)this.sources[t].update(e)}get supported(){return this._supported}get available(){return this._available}}});var og,L2=m(()=>{Pe();Q();Ve();og=class extends K{static{this.EVENT_TRACKED="tracked"}static{this.EVENT_UNTRACKED="untracked"}constructor(e,t){super(),this._bitmap=null,this._measuredWidth=0,this._trackable=!1,this._tracking=!1,this._emulated=!1,this._pose=null,this._position=new g,this._rotation=new H,this._image=e,this._width=t}get image(){return this._image}set width(e){this._width=e}get width(){return this._width}get trackable(){return this._trackable}get tracking(){return this._tracking}get emulated(){return this._emulated}prepare(){return this._bitmap?{image:this._bitmap,widthInMeters:this._width}:createImageBitmap(this._image).then(e=>(this._bitmap=e,{image:this._bitmap,widthInMeters:this._width}))}destroy(){this._image=null,this._pose=null,this._bitmap&&(this._bitmap.close(),this._bitmap=null)}getPosition(){return this._pose&&this._position.copy(this._pose.transform.position),this._position}getRotation(){return this._pose&&this._rotation.copy(this._pose.transform.orientation),this._rotation}}});var lg,b2=m(()=>{Pe();bt();L2();lg=class extends K{static{this.EVENT_ERROR="error"}constructor(e){super(),this._supported=ue.browser&&!!window.XRImageTrackingResult,this._available=!1,this._images=[],this._manager=e,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}add(e,t){if(!this._supported||this._manager.active)return null;let s=new og(e,t);return this._images.push(s),s}remove(e){if(this._manager.active)return;let t=this._images.indexOf(e);t!==-1&&(e.destroy(),this._images.splice(t,1))}_onSessionStart(){this._manager.session.getTrackedImageScores().then(e=>{this._available=!0;for(let t=0;t<e.length;t++)this._images[t]._trackable=e[t]==="trackable"}).catch(e=>{this._available=!1,this.fire("error",e)})}_onSessionEnd(){this._available=!1;for(let e=0;e<this._images.length;e++){let t=this._images[e];t._pose=null,t._measuredWidth=0,t._tracking&&(t._tracking=!1,t.fire("untracked"))}}prepareImages(e){this._images.length?Promise.all(this._images.map(t=>t.prepare())).then(t=>{e(null,t)}).catch(t=>{e(t,null)}):e(null,null)}update(e){if(!this._available)return;let t=e.getImageTrackingResults(),s={};for(let i=0;i<t.length;i++){s[t[i].index]=t[i];let r=this._images[t[i].index];r._emulated=t[i].trackingState==="emulated",r._measuredWidth=t[i].measuredWidthInMeters,r._pose=e.getPose(t[i].imageSpace,this._manager._referenceSpace)}for(let i=0;i<this._images.length;i++)this._images[i]._tracking&&!s[i]?(this._images[i]._tracking=!1,this._images[i].fire("untracked")):!this._images[i]._tracking&&s[i]&&(this._images[i]._tracking=!0,this._images[i].fire("tracked"))}get supported(){return this._supported}get available(){return this._available}get images(){return this._images}}});var hg,M2=m(()=>{hg=class{constructor(e,t){this._joints=[],this._tip=null,this._index=e,this._hand=t,this._hand._fingers.push(this)}get index(){return this._index}get hand(){return this._hand}get joints(){return this._joints}get tip(){return this._tip}}});var WQ,YQ,Fd,D2=m(()=>{bt();Ke();Ve();Q();WQ=ue.browser&&window.XRHand?["thumb-tip","index-finger-tip","middle-finger-tip","ring-finger-tip","pinky-finger-tip"]:[],YQ={};for(let o=0;o<WQ.length;o++)YQ[WQ[o]]=!0;Fd=class{constructor(e,t,s,i=null){this._radius=null,this._localTransform=new k,this._worldTransform=new k,this._localPosition=new g,this._localRotation=new H,this._position=new g,this._rotation=new H,this._dirtyLocal=!0,this._index=e,this._id=t,this._hand=s,this._finger=i,this._wrist=t==="wrist",this._tip=this._finger&&!!YQ[t]}update(e){this._dirtyLocal=!0,this._radius=e.radius,this._localPosition.copy(e.transform.position),this._localRotation.copy(e.transform.orientation)}_updateTransforms(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,g.ONE));let t=this._hand._manager.camera.parent;t?this._worldTransform.mul2(t.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)}getPosition(){return this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position}getRotation(){return this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation}get id(){return this._id}get index(){return this._index}get hand(){return this._hand}get finger(){return this._finger}get wrist(){return this._wrist}get tip(){return this._tip}get radius(){return this._radius||.005}}});var MR,Ud,bR,KQ,cg,O2=m(()=>{Pe();bt();Q();Nd();M2();D2();MR=[],Ud=new g,bR=new g,KQ=new g;ue.browser&&window.XRHand&&(MR=[["thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip"],["index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip"],["middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip"],["ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip"],["pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"]]);cg=class extends K{static{this.EVENT_TRACKING="tracking"}static{this.EVENT_TRACKINGLOST="trackinglost"}constructor(e){super(),this._tracking=!1,this._fingers=[],this._joints=[],this._jointsById={},this._tips=[],this._wrist=null;let t=e._xrInputSource.hand;if(this._manager=e._manager,this._inputSource=e,t.get("wrist")){let s=new Fd(0,"wrist",this,null);this._wrist=s,this._joints.push(s),this._jointsById.wrist=s}for(let s=0;s<MR.length;s++){let i=new hg(s,this);for(let r=0;r<MR[s].length;r++){let a=MR[s][r];if(!t.get(a))continue;let n=new Fd(r,a,this,i);this._joints.push(n),this._jointsById[a]=n,n.tip&&(this._tips.push(n),i._tip=n),i._joints.push(n)}}}update(e){let t=this._inputSource._xrInputSource;for(let c=0;c<this._joints.length;c++){let f=this._joints[c],d=t.hand.get(f._id);if(d){let u;if(e.session.visibilityState!=="hidden"&&(u=e.getJointPose(d,this._manager._referenceSpace)),u)f.update(u),f.wrist&&!this._tracking&&(this._tracking=!0,this.fire("tracking"));else if(f.wrist){this._tracking&&(this._tracking=!1,this.fire("trackinglost"));break}}}let s=this._jointsById["thumb-metacarpal"],i=this._jointsById["thumb-tip"],r=this._jointsById["index-finger-phalanx-proximal"],a=this._jointsById["index-finger-tip"],n=this._jointsById["ring-finger-phalanx-proximal"],l=this._jointsById["pinky-finger-phalanx-proximal"];if(s&&i&&r&&a&&n&&l){this._inputSource._dirtyRay=!0,this._inputSource._rayLocal.origin.lerp(i._localPosition,a._localPosition,.5);let c=s,f=l;if(this._inputSource.handedness===IR){let d=c;c=f,f=d}Ud.sub2(c._localPosition,this._wrist._localPosition),bR.sub2(f._localPosition,this._wrist._localPosition),KQ.cross(Ud,bR).normalize(),Ud.lerp(r._localPosition,n._localPosition,.5),Ud.sub(this._wrist._localPosition).normalize(),this._inputSource._rayLocal.direction.lerp(KQ,Ud,.5).normalize()}this._fingerIsClosed(1)&&this._fingerIsClosed(2)&&this._fingerIsClosed(3)&&this._fingerIsClosed(4)?this._inputSource._squeezing||(this._inputSource._squeezing=!0,this._inputSource.fire("squeezestart"),this._manager.input.fire("squeezestart",this._inputSource)):this._inputSource._squeezing&&(this._inputSource._squeezing=!1,this._inputSource.fire("squeeze"),this._manager.input.fire("squeeze",this._inputSource),this._inputSource.fire("squeezeend"),this._manager.input.fire("squeezeend",this._inputSource))}_fingerIsClosed(e){let t=this._fingers[e];return Ud.sub2(t.joints[0]._localPosition,t.joints[1]._localPosition).normalize(),bR.sub2(t.joints[2]._localPosition,t.joints[3]._localPosition).normalize(),Ud.dot(bR)<-.8}getJointById(e){return this._jointsById[e]||null}get fingers(){return this._fingers}get joints(){return this._joints}get tips(){return this._tips}get wrist(){return this._wrist}get tracking(){return this._tracking}}});var qQ,jQ,Ehe,Co,DR=m(()=>{Pe();Ke();Ve();Q();Ql();O2();ql();qQ=new g,jQ=new H,Ehe=0,Co=class extends K{static{this.EVENT_REMOVE="remove"}static{this.EVENT_SELECT="select"}static{this.EVENT_SELECTSTART="selectstart"}static{this.EVENT_SELECTEND="selectend"}static{this.EVENT_SQUEEZE="squeeze"}static{this.EVENT_SQUEEZESTART="squeezestart"}static{this.EVENT_SQUEEZEEND="squeezeend"}static{this.EVENT_HITTESTADD="hittest:add"}static{this.EVENT_HITTESTREMOVE="hittest:remove"}static{this.EVENT_HITTESTRESULT="hittest:result"}constructor(e,t){super(),this._ray=new Es,this._rayLocal=new Es,this._grip=!1,this._hand=null,this._velocitiesAvailable=!1,this._velocitiesTimestamp=Us(),this._localTransform=null,this._worldTransform=null,this._position=new g,this._rotation=new H,this._localPosition=null,this._localPositionLast=null,this._localRotation=null,this._linearVelocity=null,this._dirtyLocal=!0,this._dirtyRay=!1,this._selecting=!1,this._squeezing=!1,this._elementInput=!0,this._elementEntity=null,this._hitTestSources=[],this._id=++Ehe,this._manager=e,this._xrInputSource=t,t.hand&&(this._hand=new cg(this))}get id(){return this._id}get inputSource(){return this._xrInputSource}get targetRayMode(){return this._xrInputSource.targetRayMode}get handedness(){return this._xrInputSource.handedness}get profiles(){return this._xrInputSource.profiles}get grip(){return this._grip}get hand(){return this._hand}get gamepad(){return this._xrInputSource.gamepad||null}get selecting(){return this._selecting}get squeezing(){return this._squeezing}set elementInput(e){this._elementInput!==e&&(this._elementInput=e,this._elementInput||(this._elementEntity=null))}get elementInput(){return this._elementInput}get elementEntity(){return this._elementEntity}get hitTestSources(){return this._hitTestSources}update(e){if(this._hand)this._hand.update(e);else{let t=this._xrInputSource.gripSpace;if(t){let i=e.getPose(t,this._manager._referenceSpace);if(i){this._grip||(this._grip=!0,this._localTransform=new k,this._worldTransform=new k,this._localPositionLast=new g,this._localPosition=new g,this._localRotation=new H,this._linearVelocity=new g);let r=Us(),a=(r-this._velocitiesTimestamp)/1e3;this._velocitiesTimestamp=r,this._dirtyLocal=!0,this._localPositionLast.copy(this._localPosition),this._localPosition.copy(i.transform.position),this._localRotation.copy(i.transform.orientation),this._velocitiesAvailable=!0,this._manager.input.velocitiesSupported&&i.linearVelocity?this._linearVelocity.copy(i.linearVelocity):a>0&&(qQ.sub2(this._localPosition,this._localPositionLast).divScalar(a),this._linearVelocity.lerp(this._linearVelocity,qQ,.15))}else this._velocitiesAvailable=!1}let s=e.getPose(this._xrInputSource.targetRaySpace,this._manager._referenceSpace);s&&(this._dirtyRay=!0,this._rayLocal.origin.copy(s.transform.position),this._rayLocal.direction.set(0,0,-1),jQ.copy(s.transform.orientation),jQ.transformVector(this._rayLocal.direction,this._rayLocal.direction))}}_updateTransforms(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,g.ONE));let e=this._manager.camera.parent;e?this._worldTransform.mul2(e.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)}_updateRayTransforms(){let e=this._dirtyRay;if(this._dirtyRay=!1,this._manager.camera.parent){let s=this._manager.camera.parent.getWorldTransform();s.getTranslation(this._position),this._rotation.setFromMat4(s),this._rotation.transformVector(this._rayLocal.origin,this._ray.origin),this._ray.origin.add(this._position),this._rotation.transformVector(this._rayLocal.direction,this._ray.direction)}else e&&(this._ray.origin.copy(this._rayLocal.origin),this._ray.direction.copy(this._rayLocal.direction))}getPosition(){return this._position?(this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position):null}getLocalPosition(){return this._localPosition}getRotation(){return this._rotation?(this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation):null}getLocalRotation(){return this._localRotation}getLinearVelocity(){return this._velocitiesAvailable?this._linearVelocity:null}getOrigin(){return this._updateRayTransforms(),this._ray.origin}getDirection(){return this._updateRayTransforms(),this._ray.direction}hitTestStart(e={}){e.inputSource=this,e.profile=this._xrInputSource.profiles[0];let t=e.callback;e.callback=(s,i)=>{i&&this.onHitTestSourceAdd(i),t&&t(s,i)},this._manager.hitTest.start(e)}onHitTestSourceAdd(e){this._hitTestSources.push(e),this.fire("hittest:add",e),e.on("result",(t,s,i,r)=>{i===this&&this.fire("hittest:result",e,t,s,r)}),e.once("remove",()=>{this.onHitTestSourceRemove(e),this.fire("hittest:remove",e)})}onHitTestSourceRemove(e){let t=this._hitTestSources.indexOf(e);t!==-1&&this._hitTestSources.splice(t,1)}}});var fg,N2=m(()=>{Pe();bt();DR();fg=class extends K{static{this.EVENT_ADD="add"}static{this.EVENT_REMOVE="remove"}static{this.EVENT_SELECT="select"}static{this.EVENT_SELECTSTART="selectstart"}static{this.EVENT_SELECTEND="selectend"}static{this.EVENT_SQUEEZE="squeeze"}static{this.EVENT_SQUEEZESTART="squeezestart"}static{this.EVENT_SQUEEZEEND="squeezeend"}constructor(e){super(),this._inputSources=[],this.velocitiesSupported=!1,this.manager=e,this.velocitiesSupported=!!(ue.browser&&window.XRPose?.prototype?.hasOwnProperty("linearVelocity")),this._onInputSourcesChangeEvt=t=>{this._onInputSourcesChange(t)},this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this)}_onSessionStart(){let e=this.manager.session;e.addEventListener("inputsourceschange",this._onInputSourcesChangeEvt),e.addEventListener("select",s=>{let i=this._getByInputSource(s.inputSource);i.update(s.frame),i.fire("select",s),this.fire("select",i,s)}),e.addEventListener("selectstart",s=>{let i=this._getByInputSource(s.inputSource);i.update(s.frame),i._selecting=!0,i.fire("selectstart",s),this.fire("selectstart",i,s)}),e.addEventListener("selectend",s=>{let i=this._getByInputSource(s.inputSource);i.update(s.frame),i._selecting=!1,i.fire("selectend",s),this.fire("selectend",i,s)}),e.addEventListener("squeeze",s=>{let i=this._getByInputSource(s.inputSource);i.update(s.frame),i.fire("squeeze",s),this.fire("squeeze",i,s)}),e.addEventListener("squeezestart",s=>{let i=this._getByInputSource(s.inputSource);i.update(s.frame),i._squeezing=!0,i.fire("squeezestart",s),this.fire("squeezestart",i,s)}),e.addEventListener("squeezeend",s=>{let i=this._getByInputSource(s.inputSource);i.update(s.frame),i._squeezing=!1,i.fire("squeezeend",s),this.fire("squeezeend",i,s)});let t=e.inputSources;for(let s=0;s<t.length;s++)this._addInputSource(t[s])}_onSessionEnd(){let e=this._inputSources.length;for(;e--;){let s=this._inputSources[e];this._inputSources.splice(e,1),s.fire("remove"),this.fire("remove",s)}this.manager.session.removeEventListener("inputsourceschange",this._onInputSourcesChangeEvt)}_onInputSourcesChange(e){for(let t=0;t<e.removed.length;t++)this._removeInputSource(e.removed[t]);for(let t=0;t<e.added.length;t++)this._addInputSource(e.added[t])}_getByInputSource(e){for(let t=0;t<this._inputSources.length;t++)if(this._inputSources[t].inputSource===e)return this._inputSources[t];return null}_addInputSource(e){if(this._getByInputSource(e))return;let t=new Co(this.manager,e);this._inputSources.push(t),this.fire("add",t)}_removeInputSource(e){for(let t=0;t<this._inputSources.length;t++){if(this._inputSources[t].inputSource!==e)continue;let s=this._inputSources[t];this._inputSources.splice(t,1);let i=s.hitTestSources.length;for(;i--;)s.hitTestSources[i].remove();s.fire("remove"),this.fire("remove",s);return}}update(e){for(let t=0;t<this._inputSources.length;t++)this._inputSources[t].update(e)}get inputSources(){return this._inputSources}}});var dg,$Q,F2,ZQ,ug,U2=m(()=>{Pe();De();Ke();Ve();Q();Nd();dg=new g,$Q=new g,F2=new k,ZQ=new k,ug=class extends K{static{this.EVENT_AVAILABLE="available"}static{this.EVENT_ERROR="error"}constructor(e){super(),this._supported=!1,this._available=!1,this._lightProbeRequested=!1,this._lightProbe=null,this._intensity=0,this._rotation=new H,this._color=new N,this._sphericalHarmonics=new Float32Array(27),this._manager=e,this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this)}_onSessionStart(){this._manager.session.requestLightProbe&&(this._supported=!0)}_onSessionEnd(){this._supported=!1,this._available=!1,this._lightProbeRequested=!1,this._lightProbe=null}start(){let e;if(this._manager.session||(e=new Error("XR session is not running")),!e&&this._manager.type!==Ro&&(e=new Error("XR session type is not AR")),!e&&!this._supported&&(e=new Error("light-estimation is not supported")),(!e&&this._lightProbe||this._lightProbeRequested)&&(e=new Error("light estimation is already requested")),e){this.fire("error",e);return}this._lightProbeRequested=!0,this._manager.session.requestLightProbe().then(t=>{let s=this._lightProbeRequested;this._lightProbeRequested=!1,this._manager.active?s&&(this._lightProbe=t):this.fire("error",new Error("XR session is not active"))}).catch(t=>{this._lightProbeRequested=!1,this.fire("error",t)})}end(){this._lightProbeRequested=!1,this._lightProbe=null,this._available=!1}update(e){if(!this._lightProbe)return;let t=e.getLightEstimate(this._lightProbe);if(!t)return;this._available||(this._available=!0,this.fire("available"));let s=t.primaryLightIntensity;this._intensity=Math.max(1,Math.max(s.x,Math.max(s.y,s.z))),dg.copy(s).mulScalar(1/this._intensity),this._color.set(dg.x,dg.y,dg.z),dg.set(0,0,0),$Q.copy(t.primaryLightDirection),F2.setLookAt($Q,dg,g.UP),ZQ.setFromAxisAngle(g.RIGHT,90),F2.mul(ZQ),this._rotation.setFromMat4(F2),this._sphericalHarmonics.set(t.sphericalHarmonicsCoefficients)}get supported(){return this._supported}get available(){return this._available}get intensity(){return this._available?this._intensity:null}get color(){return this._available?this._color:null}get rotation(){return this._available?this._rotation:null}get sphericalHarmonics(){return this._available?this._sphericalHarmonics:null}}});var vhe,mg,B2=m(()=>{Pe();Ve();Q();vhe=0,mg=class extends K{static{this.EVENT_REMOVE="remove"}static{this.EVENT_CHANGE="change"}constructor(e,t){super(),this._position=new g,this._rotation=new H,this._id=++vhe,this._planeDetection=e,this._xrPlane=t,this._lastChangedTime=t.lastChangedTime,this._orientation=t.orientation}destroy(){this._xrPlane&&(this._xrPlane=null,this.fire("remove"))}update(e){let t=this._planeDetection._manager,s=e.getPose(this._xrPlane.planeSpace,t._referenceSpace);s&&(this._position.copy(s.transform.position),this._rotation.copy(s.transform.orientation)),this._lastChangedTime!==this._xrPlane.lastChangedTime&&(this._lastChangedTime=this._xrPlane.lastChangedTime,this.fire("change"))}getPosition(){return this._position}getRotation(){return this._rotation}get id(){return this._id}get orientation(){return this._orientation}get points(){return this._xrPlane.polygon}get label(){return this._xrPlane.semanticLabel||""}}});var pg,V2=m(()=>{bt();Pe();B2();pg=class extends K{static{this.EVENT_AVAILABLE="available"}static{this.EVENT_UNAVAILABLE="unavailable"}static{this.EVENT_ADD="add"}static{this.EVENT_REMOVE="remove"}constructor(e){super(),this._supported=ue.browser&&!!window.XRPlane,this._available=!1,this._planesIndex=new Map,this._planes=[],this._manager=e,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}_onSessionStart(){this._manager.session.enabledFeatures&&this._manager.session.enabledFeatures.indexOf("plane-detection")!==-1&&(this._available=!0,this.fire("available"))}_onSessionEnd(){for(let e=0;e<this._planes.length;e++)this._planes[e].destroy(),this.fire("remove",this._planes[e]);this._planesIndex.clear(),this._planes.length=0,this._available&&(this._available=!1,this.fire("unavailable"))}update(e){if(!this._available)if(!this._manager.session.enabledFeatures&&e.detectedPlanes.size)this._available=!0,this.fire("available");else return;let t=e.detectedPlanes;for(let[s,i]of this._planesIndex)t.has(s)||(this._planesIndex.delete(s),this._planes.splice(this._planes.indexOf(i),1),i.destroy(),this.fire("remove",i));for(let s of t){let i=this._planesIndex.get(s);i?i.update(e):(i=new mg(this,s),this._planesIndex.set(s,i),this._planes.push(i),i.update(e),this.fire("add",i))}}get supported(){return this._supported}get available(){return this._available}get planes(){return this._planes}}});var _g,k2=m(()=>{Pe();Q();Ve();_g=class extends K{static{this.EVENT_DESTROY="destroy"}static{this.EVENT_CHANGE="change"}static{this.EVENT_PERSIST="persist"}static{this.EVENT_FORGET="forget"}constructor(e,t,s=null){super(),this._position=new g,this._rotation=new H,this._uuid=null,this._uuidRequests=null,this._anchors=e,this._xrAnchor=t,this._uuid=s}destroy(){if(!this._xrAnchor)return;let e=this._xrAnchor;this._xrAnchor.delete(),this._xrAnchor=null,this.fire("destroy",e,this)}update(e){if(!this._xrAnchor)return;let t=e.getPose(this._xrAnchor.anchorSpace,this._anchors.manager._referenceSpace);if(t){if(this._position.equals(t.transform.position)&&this._rotation.equals(t.transform.orientation))return;this._position.copy(t.transform.position),this._rotation.copy(t.transform.orientation),this.fire("change")}}getPosition(){return this._position}getRotation(){return this._rotation}persist(e){if(!this._anchors.persistence){e?.(new Error("Persistent Anchors are not supported"),null);return}if(this._uuid){e?.(null,this._uuid);return}if(this._uuidRequests){e&&this._uuidRequests.push(e);return}this._uuidRequests=[],this._xrAnchor.requestPersistentHandle().then(t=>{this._uuid=t,this._anchors._indexByUuid.set(this._uuid,this),e?.(null,t);for(let s of this._uuidRequests)s(null,t);this._uuidRequests=null,this.fire("persist",t)}).catch(t=>{e?.(t,null);for(let s of this._uuidRequests)s(t,null);this._uuidRequests=null})}forget(e){if(!this._uuid){e?.(new Error("Anchor is not persistent"));return}this._anchors.forget(this._uuid,t=>{this._uuid=null,e?.(t),this.fire("forget")})}get uuid(){return this._uuid}get persistent(){return!!this._uuid}}});var gg,G2=m(()=>{Pe();bt();k2();gg=class extends K{static{this.EVENT_AVAILABLE="available"}static{this.EVENT_UNAVAILABLE="unavailable"}static{this.EVENT_ERROR="error"}static{this.EVENT_ADD="add"}static{this.EVENT_DESTROY="destroy"}constructor(e){super(),this._supported=ue.browser&&!!window.XRAnchor,this._available=!1,this._checkingAvailability=!1,this._persistence=ue.browser&&!!window?.XRSession?.prototype.restorePersistentAnchor,this._creationQueue=[],this._index=new Map,this._indexByUuid=new Map,this._list=[],this._callbacksAnchors=new Map,this.manager=e,this._supported&&(this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this))}_onSessionStart(){let e=this.manager.session.enabledFeatures?.indexOf("anchors")>=0;e&&(this._available=e,this.fire("available"))}_onSessionEnd(){if(!this._available)return;this._available=!1;for(let t=0;t<this._creationQueue.length;t++)this._creationQueue[t].callback&&this._creationQueue[t].callback(new Error("session ended"),null);this._creationQueue.length=0,this._index.clear(),this._indexByUuid.clear();let e=this._list.length;for(;e--;)this._list[e].destroy();this._list.length=0,this.fire("unavailable")}_createAnchor(e,t=null){let s=new _g(this,e,t);return this._index.set(e,s),t&&this._indexByUuid.set(t,s),this._list.push(s),s.once("destroy",this._onAnchorDestroy,this),s}_onAnchorDestroy(e,t){this._index.delete(e),t.uuid&&this._indexByUuid.delete(t.uuid);let s=this._list.indexOf(t);s!==-1&&this._list.splice(s,1),this.fire("destroy",t)}create(e,t,s){if(!this._available){s?.(new Error("Anchors API is not available"),null);return}if(window.XRHitTestResult&&e instanceof XRHitTestResult){let i=e;if(s=t,!this._supported){s?.(new Error("Anchors API is not supported"),null);return}if(!i.createAnchor){s?.(new Error("Creating Anchor from Hit Test is not supported"),null);return}i.createAnchor().then(r=>{let a=this._createAnchor(r);s?.(null,a),this.fire("add",a)}).catch(r=>{s?.(r,null),this.fire("error",r)})}else this._creationQueue.push({transform:new XRRigidTransform(e,t),callback:s})}restore(e,t){if(!this._available){t?.(new Error("Anchors API is not available"),null);return}if(!this._persistence){t?.(new Error("Anchor Persistence is not supported"),null);return}if(!this.manager.active){t?.(new Error("WebXR session is not active"),null);return}this.manager.session.restorePersistentAnchor(e).then(s=>{let i=this._createAnchor(s,e);t?.(null,i),this.fire("add",i)}).catch(s=>{t?.(s,null),this.fire("error",s)})}forget(e,t){if(!this._available){t?.(new Error("Anchors API is not available"));return}if(!this._persistence){t?.(new Error("Anchor Persistence is not supported"));return}if(!this.manager.active){t?.(new Error("WebXR session is not active"));return}this.manager.session.deletePersistentAnchor(e).then(()=>{t?.(null)}).catch(s=>{t?.(s),this.fire("error",s)})}update(e){if(!this._available){!this.manager.session.enabledFeatures&&!this._checkingAvailability&&(this._checkingAvailability=!0,e.createAnchor(new XRRigidTransform,this.manager._referenceSpace).then(t=>{t.delete(),this.manager.active&&(this._available=!0,this.fire("available"))}).catch(()=>{}));return}if(this._creationQueue.length){for(let t=0;t<this._creationQueue.length;t++){let s=this._creationQueue[t];e.createAnchor(s.transform,this.manager._referenceSpace).then(i=>{s.callback&&this._callbacksAnchors.set(i,s.callback)}).catch(i=>{s.callback&&s.callback(i,null),this.fire("error",i)})}this._creationQueue.length=0}for(let[t,s]of this._index)e.trackedAnchors.has(t)||(this._index.delete(t),s.destroy());for(let t=0;t<this._list.length;t++)this._list[t].update(e);for(let t of e.trackedAnchors){if(this._index.has(t))continue;try{let r=t.anchorSpace}catch{continue}let s=this._createAnchor(t);s.update(e);let i=this._callbacksAnchors.get(t);i&&(this._callbacksAnchors.delete(t),i(null,s)),this.fire("add",s)}}get supported(){return this._supported}get available(){return this._available}get persistence(){return this._persistence}get uuids(){return!this._available||!this._persistence||!this.manager.active?null:this.manager.session.persistentAnchors}get list(){return this._list}}});var OR,QQ=m(()=>{Pe();Q();Ve();OR=class extends K{static{this.EVENT_REMOVE="remove"}static{this.EVENT_CHANGE="change"}constructor(e,t){super(),this._lastChanged=0,this._position=new g,this._rotation=new H,this._meshDetection=e,this._xrMesh=t,this._lastChanged=this._xrMesh.lastChangedTime}get xrMesh(){return this._xrMesh}get label(){return this._xrMesh.semanticLabel||""}get vertices(){return this._xrMesh.vertices}get indices(){return this._xrMesh.indices}destroy(){this._xrMesh&&(this._xrMesh=null,this.fire("remove"))}update(e){let t=this._meshDetection._manager,s=e.getPose(this._xrMesh.meshSpace,t._referenceSpace);s&&(this._position.copy(s.transform.position),this._rotation.copy(s.transform.orientation)),this._lastChanged!==this._xrMesh.lastChangedTime&&(this._lastChanged=this._xrMesh.lastChangedTime,this.fire("change"))}getPosition(){return this._position}getRotation(){return this._rotation}}});var Sg,z2=m(()=>{bt();Pe();QQ();Sg=class extends K{static{this.EVENT_AVAILABLE="available"}static{this.EVENT_UNAVAILABLE="unavailable"}static{this.EVENT_ADD="add"}static{this.EVENT_REMOVE="remove"}constructor(e){super(),this._supported=ue.browser&&!!window.XRMesh,this._available=!1,this._index=new Map,this._list=[],this._manager=e,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}update(e){if(!this._available)if(!this._manager.session.enabledFeatures&&e.detectedMeshes.size)this._available=!0,this.fire("available");else return;for(let t of e.detectedMeshes){let s=this._index.get(t);s?s.update(e):(s=new OR(this,t),this._index.set(t,s),this._list.push(s),s.update(e),this.fire("add",s))}for(let t of this._index.values())e.detectedMeshes.has(t.xrMesh)||this._removeMesh(t)}_removeMesh(e){this._index.delete(e.xrMesh),this._list.splice(this._list.indexOf(e),1),e.destroy(),this.fire("remove",e)}_onSessionStart(){if(this._manager.session.enabledFeatures){let e=this._manager.session.enabledFeatures.indexOf("mesh-detection")!==-1;if(!e)return;this._available=e,this.fire("available")}}_onSessionEnd(){if(this._available){this._available=!1;for(let e of this._index.values())this._removeMesh(e);this.fire("unavailable")}}get supported(){return this._supported}get available(){return this._available}get meshes(){return this._list}}});var Tg,H2=m(()=>{Pe();Fe();Ze();Zl();Ke();Tg=class extends K{static{this.EVENT_DEPTHRESIZE="depth:resize"}constructor(e,t,s){super(),this._positionData=new Float32Array(3),this._viewport=new W,this._projMat=new k,this._projViewOffMat=new k,this._viewMat=new k,this._viewOffMat=new k,this._viewMat3=new Vs,this._viewInvMat=new k,this._viewInvOffMat=new k,this._xrCamera=null,this._textureColor=null,this._textureDepth=null,this._depthInfo=null,this._emptyDepthBuffer=new Uint8Array(32),this._depthMatrix=new k,this._manager=e,this._xrView=t;let i=this._manager.app.graphicsDevice;if(this._manager.views.supportedColor&&(this._xrCamera=this._xrView.camera,this._manager.views.availableColor&&this._xrCamera&&(this._textureColor=new q(i,{format:6,mipmaps:!1,addressU:1,addressV:1,minFilter:1,magFilter:1,width:this._xrCamera.width,height:this._xrCamera.height,name:`XrView-${this._xrView.eye}-Color`}))),this._manager.views.supportedDepth&&this._manager.views.availableDepth){let r=this._manager.views.depthGpuOptimized?0:1;this._textureDepth=new q(i,{format:this._manager.views.depthPixelFormat,arrayLength:s===1?0:s,mipmaps:!1,addressU:1,addressV:1,minFilter:r,magFilter:r,width:4,height:4,name:`XrView-${this._xrView.eye}-Depth`});for(let a=0;a<this._textureDepth._levels.length;a++)this._textureDepth._levels[a]=this._emptyDepthBuffer;this._textureDepth.upload()}(this._textureColor||this._textureDepth)&&i.on("devicelost",this._onDeviceLost,this)}get textureColor(){return this._textureColor}get textureDepth(){return this._textureDepth}get depthUvMatrix(){return this._depthMatrix}get depthValueToMeters(){return this._depthInfo?.rawValueToMeters||0}get eye(){return this._xrView.eye}get viewport(){return this._viewport}get projMat(){return this._projMat}get projViewOffMat(){return this._projViewOffMat}get viewOffMat(){return this._viewOffMat}get viewInvOffMat(){return this._viewInvOffMat}get viewMat3(){return this._viewMat3}get positionData(){return this._positionData}update(e,t){this._xrView=t,this._manager.views.availableColor&&(this._xrCamera=this._xrView.camera);let i=e.session.renderState.baseLayer.getViewport(this._xrView);this._viewport.x=i.x,this._viewport.y=i.y,this._viewport.z=i.width,this._viewport.w=i.height,this._projMat.set(this._xrView.projectionMatrix),this._viewMat.set(this._xrView.transform.inverse.matrix),this._viewInvMat.set(this._xrView.transform.matrix),this._updateTextureColor(),this._updateDepth(e)}_updateTextureColor(){if(!this._manager.views.availableColor||!this._xrCamera||!this._textureColor)return;let e=this._manager.webglBinding;if(!e)return;let t=e.getCameraImage(this._xrCamera);if(!t)return;let s=this._manager.app.graphicsDevice,i=s.gl;if(!this._frameBufferSource)this._frameBufferSource=i.createFramebuffer(),this._frameBuffer=i.createFramebuffer();else{let r=i.COLOR_ATTACHMENT0,a=this._xrCamera.width,n=this._xrCamera.height;s.setFramebuffer(this._frameBufferSource),i.framebufferTexture2D(i.FRAMEBUFFER,r,i.TEXTURE_2D,t,0),s.setFramebuffer(this._frameBuffer),i.framebufferTexture2D(i.FRAMEBUFFER,r,i.TEXTURE_2D,this._textureColor.impl._glTexture,0),i.bindFramebuffer(i.READ_FRAMEBUFFER,this._frameBufferSource),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,this._frameBuffer),i.blitFramebuffer(0,n,a,0,0,0,a,n,i.COLOR_BUFFER_BIT,i.NEAREST)}}_updateDepth(e){if(!this._manager.views.availableDepth||!this._textureDepth)return;let t=this._manager.views.depthGpuOptimized,s=t?this._manager.webglBinding:e;if(!s){this._depthInfo=null;return}let i=s.getDepthInformation(this._xrView);if(!i){this._depthInfo=null;return}let r=!this._depthInfo!=!i;this._depthInfo=i;let a=this._depthInfo?.width||4,n=this._depthInfo?.height||4,l=!1;if((this._textureDepth.width!==a||this._textureDepth.height!==n)&&(this._textureDepth._width=a,this._textureDepth._height=n,r=!0,l=!0),r&&(this._depthInfo?this._depthMatrix.data.set(this._depthInfo.normDepthBufferFromNormView.matrix):this._depthMatrix.setIdentity()),this._depthInfo)if(t){if(this._depthInfo.texture){let h=this._manager.app.graphicsDevice.gl;switch(this._textureDepth.impl._glTexture=this._depthInfo.texture,this._depthInfo.textureType==="texture-array"?this._textureDepth.impl._glTarget=h.TEXTURE_2D_ARRAY:this._textureDepth.impl._glTarget=h.TEXTURE_2D,this._manager.views.depthPixelFormat){case 15:this._textureDepth.impl._glInternalFormat=h.R32F,this._textureDepth.impl._glPixelType=h.FLOAT,this._textureDepth.impl._glFormat=h.RED;break;case 16:this._textureDepth.impl._glInternalFormat=h.DEPTH_COMPONENT16,this._textureDepth.impl._glPixelType=h.UNSIGNED_SHORT,this._textureDepth.impl._glFormat=h.DEPTH_COMPONENT;break}this._textureDepth.impl._glCreated=!0}}else this._textureDepth._levels[0]=new Uint8Array(this._depthInfo.data),this._textureDepth.upload();else this._textureDepth._levels[0]=this._emptyDepthBuffer,this._textureDepth.upload();l&&this.fire("depth:resize",a,n)}updateTransforms(e){e?(this._viewInvOffMat.mul2(e,this._viewInvMat),this.viewOffMat.copy(this._viewInvOffMat).invert()):(this._viewInvOffMat.copy(this._viewInvMat),this.viewOffMat.copy(this._viewMat)),this._viewMat3.setFromMat4(this._viewOffMat),this._projViewOffMat.mul2(this._projMat,this._viewOffMat),this._positionData[0]=this._viewInvOffMat.data[12],this._positionData[1]=this._viewInvOffMat.data[13],this._positionData[2]=this._viewInvOffMat.data[14]}_onDeviceLost(){this._frameBufferSource=null,this._frameBuffer=null,this._depthInfo=null}getDepth(e,t){return this._manager.views.depthGpuOptimized?null:this._depthInfo?.getDepthInMeters(e,t)??null}destroy(){if(this._depthInfo=null,this._textureColor&&(this._textureColor.destroy(),this._textureColor=null),this._textureDepth&&(this._textureDepth.destroy(),this._textureDepth=null),this._frameBufferSource){let e=this._manager.app.graphicsDevice.gl;e.deleteFramebuffer(this._frameBufferSource),this._frameBufferSource=null,e.deleteFramebuffer(this._frameBuffer),this._frameBuffer=null}}}});var Bd,X2=m(()=>{bt();Pe();H2();Nd();Bd=class extends K{static{this.EVENT_ADD="add"}static{this.EVENT_REMOVE="remove"}constructor(e){super(),this._index=new Map,this._indexTmp=new Map,this._list=[],this._supportedColor=ue.browser&&!!window.XRCamera&&!!window.XRWebGLBinding,this._supportedDepth=ue.browser&&!!window.XRDepthInformation,this._availableColor=!1,this._availableDepth=!1,this._depthUsage="",this._depthFormat="",this._depthFormats={[tg]:2,[sg]:16,[ig]:15},this._manager=e,this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this)}get list(){return this._list}get supportedColor(){return this._supportedColor}get supportedDepth(){return this._supportedDepth}get availableColor(){return this._availableColor}get availableDepth(){return this._availableDepth}get depthUsage(){return this._depthUsage}get depthGpuOptimized(){return this._depthUsage===eg}get depthFormat(){return this._depthFormat}get depthPixelFormat(){return this._depthFormats[this._depthFormat]??null}update(e,t){for(let s=0;s<t.length;s++)this._indexTmp.set(t[s].eye,t[s]);for(let[s,i]of this._indexTmp){let r=this._index.get(s);r?r.update(e,i):(r=new Tg(this._manager,i,t.length),this._index.set(s,r),this._list.push(r),r.update(e,i),this.fire("add",r))}for(let[s,i]of this._index){if(this._indexTmp.has(s))continue;i.destroy(),this._index.delete(s);let r=this._list.indexOf(i);r!==-1&&this._list.splice(r,1),this.fire("remove",i)}this._indexTmp.clear()}get(e){return this._index.get(e)||null}_onSessionStart(){if(this._manager.type===Ro&&this._manager.session.enabledFeatures&&(this._availableColor=this._manager.session.enabledFeatures.indexOf("camera-access")!==-1,this._availableDepth=this._manager.session.enabledFeatures.indexOf("depth-sensing")!==-1,this._availableDepth)){let e=this._manager.session;this._depthUsage=e.depthUsage,this._depthFormat=e.depthDataFormat}}_onSessionEnd(){for(let e of this._index.values())e.destroy();this._index.clear(),this._availableColor=!1,this._availableDepth=!1,this._depthUsage="",this._depthFormat="",this._list.length=0}}});var Eg,W2=m(()=>{Pe();bt();Ke();Ve();Q();Nd();C2();w2();b2();N2();U2();V2();G2();z2();X2();Eg=class extends K{static{this.EVENT_AVAILABLE="available"}static{this.EVENT_START="start"}static{this.EVENT_END="end"}static{this.EVENT_UPDATE="update"}static{this.EVENT_ERROR="error"}constructor(e){super(),this._supported=ue.browser&&!!navigator.xr,this._available={},this._type=null,this._spaceType=null,this._session=null,this._baseLayer=null,this.webglBinding=null,this._referenceSpace=null,this._camera=null,this._localPosition=new g,this._localRotation=new H,this._depthNear=.1,this._depthFar=1e3,this._supportedFrameRates=null,this._width=0,this._height=0,this._framebufferScaleFactor=1,this.app=e,this._available[RR]=!1,this._available[CR]=!1,this._available[Ro]=!1,this.views=new Bd(this),this.domOverlay=new rg(this),this.hitTest=new ng(this),this.imageTracking=new lg(this),this.planeDetection=new pg(this),this.meshDetection=new Sg(this),this.input=new fg(this),this.lightEstimation=new ug(this),this.anchors=new gg(this),this.views=new Bd(this),this._supported&&(navigator.xr.addEventListener("devicechange",()=>{this._deviceAvailabilityCheck()}),this._deviceAvailabilityCheck(),this.app.graphicsDevice.on("devicelost",this._onDeviceLost,this),this.app.graphicsDevice.on("devicerestored",this._onDeviceRestored,this))}destroy(){}start(e,t,s,i){let r=i;if(typeof i=="object"&&(r=i.callback),!this._available[t]){r&&r(new Error("XR is not available"));return}if(this._session){r&&r(new Error("XR session is already started"));return}this._camera=e,this._camera.camera.xr=this,this._type=t,this._spaceType=s,this._framebufferScaleFactor=i?.framebufferScaleFactor??1,this._setClipPlanes(e.nearClip,e.farClip);let a={requiredFeatures:[s],optionalFeatures:[]},n=this.app.graphicsDevice;n?.isWebGPU&&a.requiredFeatures.push("webgpu");let l=n?.isWebGL2;if(t===Ro){if(a.optionalFeatures.push("light-estimation"),a.optionalFeatures.push("hit-test"),i&&(i.imageTracking&&this.imageTracking.supported&&a.optionalFeatures.push("image-tracking"),i.planeDetection&&a.optionalFeatures.push("plane-detection"),i.meshDetection&&a.optionalFeatures.push("mesh-detection")),this.domOverlay.supported&&this.domOverlay.root&&(a.optionalFeatures.push("dom-overlay"),a.domOverlay={root:this.domOverlay.root}),i&&i.anchors&&this.anchors.supported&&a.optionalFeatures.push("anchors"),i&&i.depthSensing&&this.views.supportedDepth){a.optionalFeatures.push("depth-sensing");let h=[],c=[];if(h.push(eg,wR),c.push(ig,tg,sg),i.depthSensing.usagePreference){let f=h.indexOf(i.depthSensing.usagePreference);f!==-1&&h.splice(f,1),h.unshift(i.depthSensing.usagePreference)}if(i.depthSensing.dataFormatPreference){let f=c.indexOf(i.depthSensing.dataFormatPreference);f!==-1&&c.splice(f,1),c.unshift(i.depthSensing.dataFormatPreference)}a.depthSensing={usagePreference:h,dataFormatPreference:c}}l&&i&&i.cameraColor&&this.views.supportedColor&&a.optionalFeatures.push("camera-access")}a.optionalFeatures.push("hand-tracking"),i&&i.optionalFeatures&&(a.optionalFeatures=a.optionalFeatures.concat(i.optionalFeatures)),this.imageTracking.supported&&this.imageTracking.images.length?this.imageTracking.prepareImages((h,c)=>{if(h){r&&r(h),this.fire("error",h);return}c!==null&&(a.trackedImages=c),this._onStartOptionsReady(t,s,a,r)}):this._onStartOptionsReady(t,s,a,r)}_onStartOptionsReady(e,t,s,i){navigator.xr.requestSession(e,s).then(r=>{this._onSessionStart(r,t,i)}).catch(r=>{this._camera.camera.xr=null,this._camera=null,this._type=null,this._spaceType=null,i&&i(r),this.fire("error",r)})}end(e){if(!this._session){e&&e(new Error("XR Session is not initialized"));return}this.webglBinding=null,e&&this.once("end",e),this._session.end()}isAvailable(e){return this._available[e]}_deviceAvailabilityCheck(){for(let e in this._available)this._sessionSupportCheck(e)}initiateRoomCapture(e){if(!this._session){e(new Error("Session is not active"));return}if(!this._session.initiateRoomCapture){e(new Error("Session does not support manual room capture"));return}this._session.initiateRoomCapture().then(()=>{e&&e(null)}).catch(t=>{e&&e(t)})}updateTargetFrameRate(e,t){if(!this._session?.updateTargetFrameRate){t?.(new Error("unable to update frameRate"));return}this._session.updateTargetFrameRate(e).then(()=>{t?.()}).catch(s=>{t?.(s)})}_sessionSupportCheck(e){navigator.xr.isSessionSupported(e).then(t=>{this._available[e]!==t&&(this._available[e]=t,this.fire("available",e,t),this.fire(`available:${e}`,t))}).catch(t=>{this.fire("error",t)})}_onSessionStart(e,t,s){let i=!1;this._session=e;let r=()=>{this.fire("visibility:change",e.visibilityState)},a=()=>{this._setClipPlanes(this._camera.nearClip,this._camera.farClip)},n=()=>{this._camera&&(this._camera.off("set_nearClip",a),this._camera.off("set_farClip",a),this._camera.camera.xr=null,this._camera=null),e.removeEventListener("end",n),e.removeEventListener("visibilitychange",r),i||this.fire("end"),this._session=null,this._referenceSpace=null,this._width=0,this._height=0,this._type=null,this._spaceType=null,this.app.systems&&this.app.tick()};e.addEventListener("end",n),e.addEventListener("visibilitychange",r),this._camera.on("set_nearClip",a),this._camera.on("set_farClip",a),this._createBaseLayer(),this.session.supportedFrameRates?this._supportedFrameRates=Array.from(this.session.supportedFrameRates):this._supportedFrameRates=null,this._session.addEventListener("frameratechange",()=>{this.fire("frameratechange",this._session?.frameRate)}),e.requestReferenceSpace(t).then(l=>{this._referenceSpace=l,this.app.tick(),s&&s(null),this.fire("start")}).catch(l=>{i=!0,e.end(),s&&s(l),this.fire("error",l)})}_setClipPlanes(e,t){this._depthNear===e&&this._depthFar===t||(this._depthNear=e,this._depthFar=t,this._session&&this._session.updateRenderState({depthNear:this._depthNear,depthFar:this._depthFar}))}_createBaseLayer(){let e=this.app.graphicsDevice,t=e.maxPixelRatio/window.devicePixelRatio*this._framebufferScaleFactor;if(this._baseLayer=new XRWebGLLayer(this._session,e.gl,{alpha:!0,depth:!0,stencil:!0,framebufferScaleFactor:t,antialias:!1}),e?.isWebGL2&&window.XRWebGLBinding)try{this.webglBinding=new XRWebGLBinding(this._session,e.gl)}catch(s){this.fire("error",s)}this._session.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar})}_onDeviceLost(){this._session&&(this.webglBinding&&(this.webglBinding=null),this._baseLayer=null,this._session.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar}))}_onDeviceRestored(){this._session&&setTimeout(()=>{this.app.graphicsDevice.gl.makeXRCompatible().then(()=>{this._createBaseLayer()}).catch(e=>{this.fire("error",e)})},0)}update(e){if(!this._session)return!1;let t=e.session.renderState.baseLayer.framebufferWidth,s=e.session.renderState.baseLayer.framebufferHeight;(this._width!==t||this._height!==s)&&(this._width=t,this._height=s,this.app.graphicsDevice.setResolution(t,s));let i=e.getViewerPose(this._referenceSpace);if(!i)return!1;let r=this.views.list.length;this.views.update(e,i.views);let a=i.transform.position,n=i.transform.orientation;if(this._localPosition.set(a.x,a.y,a.z),this._localRotation.set(n.x,n.y,n.z,n.w),r===0&&this.views.list.length>0){let l=new k,h=this.views.list[0];l.copy(h.projMat);let c=l.data,f=2*Math.atan(1/c[5])*180/Math.PI,d=c[5]/c[0],u=c[14]/(c[10]+1),p=c[14]/(c[10]-1);this._camera.camera.setXrProperties({aspectRatio:d,farClip:u,fov:f,horizontalFov:!1,nearClip:p})}return this._camera.camera._node.setLocalPosition(this._localPosition),this._camera.camera._node.setLocalRotation(this._localRotation),this.input.update(e),this._type===Ro&&(this.hitTest.supported&&this.hitTest.update(e),this.lightEstimation.supported&&this.lightEstimation.update(e),this.imageTracking.supported&&this.imageTracking.update(e),this.anchors.supported&&this.anchors.update(e),this.planeDetection.supported&&this.planeDetection.update(e),this.meshDetection.supported&&this.meshDetection.update(e)),this.fire("update",e),!0}get supported(){return this._supported}get active(){return!!this._session}get type(){return this._type}get spaceType(){return this._spaceType}get session(){return this._session}get frameRate(){return this._session?.frameRate??null}get supportedFrameRates(){return this._supportedFrameRates}get framebufferScaleFactor(){return this._framebufferScaleFactor}set fixedFoveation(e){(this._baseLayer?.fixedFoveation??null)!==null&&(this.app.graphicsDevice.samples>1,this._baseLayer.fixedFoveation=e)}get fixedFoveation(){return this._baseLayer?.fixedFoveation??null}get camera(){return this._camera?this._camera.entity:null}get visibilityState(){return this._session?this._session.visibilityState:null}}});var NR,JQ=m(()=>{bt();Ox();tL();Gb();yL();mT();Vb();Yb();Jb();tM();iM();dM();vM();PM();CM();OM();UM();VM();XM();OP();qM();eD();sD();aD();hD();fD();mD();gD();xD();PD();CD();OD();ND();FD();BD();VD();GD();zD();HD();XD();KD();QD();e2();t2();s2();r2();a2();n2();c2();f2();m2();_2();g2();S2();R2();W2();NR=class extends js{constructor(e,t={}){super(e);let s=new uc;s.graphicsDevice=t.graphicsDevice??this.createDevice(e,t),this.addComponentSystems(s),this.addResourceHandles(s),s.elementInput=t.elementInput,s.keyboard=t.keyboard,s.mouse=t.mouse,s.touch=t.touch,s.gamepads=t.gamepads,s.scriptPrefix=t.scriptPrefix,s.assetPrefix=t.assetPrefix,s.scriptsOrder=t.scriptsOrder,s.soundManager=new Tm,s.lightmapper=Mp,s.batchManager=Um,s.xr=Eg,this.init(s)}createDevice(e,t){return t.graphicsDeviceOptions||(t.graphicsDeviceOptions={}),ue.browser&&navigator.xr&&(t.graphicsDeviceOptions.xrCompatible=!0),t.graphicsDeviceOptions.alpha=t.graphicsDeviceOptions.alpha||!1,new Eh(e,t.graphicsDeviceOptions)}addComponentSystems(e){e.componentSystems=[Lc,jp,t_,Fp,Vp,a_,wc,Nc,Fc,Uc,g_,kp,l_,d_,e_,Xp,m_,__,S_,r_,s_,T_,Bc]}addResourceHandles(e){e.resourceHandlers=[R_,L_,b_,M_,Y_,W_,Hc,Q_,H_,D_,q_,K_,B_,z_,U_,j_,G_,V_,k_,O_,J_,$_,Z_,F_,kc]}}});var vg,eJ=m(()=>{Pe();rt();vg=class extends K{constructor(e,t){super(),this._assets=new Set,this._loadingAssets=new Set,this._waitingAssets=new Set,this._loading=!1,this._loaded=!1,this._failed=[],this._registry=t,e.forEach(s=>{if(s instanceof re)s.registry||(s.registry=t),this._assets.add(s);else{let i=t.get(s);i?this._assets.add(i):this._waitForAsset(s)}})}destroy(){this._registry.off("load",this._onLoad),this._registry.off("error",this._onError),this._waitingAssets.forEach(e=>{this._registry.off(`add:${e}`,this._onAddAsset)}),this.off("progress"),this.off("load")}_assetHasDependencies(e){return e.type==="model"&&e.file?.url&&e.file.url&&e.file.url.match(/.json$/g)}load(e,t){if(this._loading)return;this._loading=!0,this._callback=e,this._scope=t,this._registry.on("load",this._onLoad,this),this._registry.on("error",this._onError,this);let s=!1;this._assets.forEach(i=>{i.loaded||(s=!0,this._assetHasDependencies(i)&&this._registry.loadFromUrl(i.file.url,i.type,(r,a)=>{if(r){this._onError(r,i);return}this._onLoad(i)}),this._loadingAssets.add(i),this._registry.add(i))}),this._loadingAssets.forEach(i=>{this._assetHasDependencies(i)||this._registry.load(i)}),!s&&this._waitingAssets.size===0&&this._loadingComplete()}ready(e,t=this){this._loaded?e.call(t,Array.from(this._assets)):this.once("load",s=>{e.call(t,s)})}_loadingComplete(){this._loaded||(this._loaded=!0,this._registry.off("load",this._onLoad,this),this._registry.off("error",this._onError,this),this._failed.length?(this._callback&&this._callback.call(this._scope,"Failed to load some assets",this._failed),this.fire("error",this._failed)):(this._callback&&this._callback.call(this._scope),this.fire("load",Array.from(this._assets))))}_onLoad(e){this._loadingAssets.has(e)&&(this.fire("progress",e),this._loadingAssets.delete(e)),this._loadingAssets.size===0&&setTimeout(()=>{this._loadingComplete()},0)}_onError(e,t){this._loadingAssets.has(t)&&(this._failed.push(t),this._loadingAssets.delete(t)),this._loadingAssets.size===0&&setTimeout(()=>{this._loadingComplete()},0)}_onAddAsset(e){this._waitingAssets.delete(e),this._assets.add(e),e.loaded||(this._loadingAssets.add(e),this._registry.load(e))}_waitForAsset(e){this._waitingAssets.add(e),this._registry.once(`add:${e}`,this._onAddAsset,this)}}});var tJ,sJ,Y2,FR,iJ=m(()=>{Kg();Pe();De();Fe();tJ=4096,sJ=512,Y2=class{constructor(e,t,s,i){this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=s,this.texture=new q(e,{name:i,format:20,width:t,height:s,mipmaps:!0,minFilter:5,magFilter:1,addressU:1,addressV:1,levels:[this.canvas]}),this.ctx=this.canvas.getContext("2d",{alpha:!0})}destroy(){this.texture.destroy()}clear(e){let{width:t,height:s}=this.canvas;this.ctx.clearRect(0,0,t,s),this.ctx.fillStyle=e,this.ctx.fillRect(0,0,t,s)}},FR=class extends K{constructor(e,t={}){super(),this.type="bitmap",this.app=e,this.intensity=0,this.fontWeight=t.fontWeight||"normal",this.fontSize=parseInt(t.fontSize,10),this.glyphSize=this.fontSize,this.fontName=t.fontName||"Arial",this.color=t.color||new N(1,1,1),this.padding=t.padding||0,this.width=Math.min(tJ,t.width||sJ),this.height=Math.min(tJ,t.height||sJ),this.atlases=[],this.chars="",this.data={}}createTextures(e){let t=this._normalizeCharsSet(e);if(t.length!==this.chars.length){this._renderAtlas(t);return}for(let s=0;s<t.length;s++)if(t[s]!==this.chars[s]){this._renderAtlas(t);return}}updateTextures(e){let t=this._normalizeCharsSet(e),s=[];for(let i=0;i<t.length;i++){let r=t[i];this.data.chars[r]||s.push(r)}s.length>0&&this._renderAtlas(this.chars.concat(s))}destroy(){this.atlases.forEach(e=>e.destroy()),this.chars=null,this.color=null,this.data=null,this.fontName=null,this.fontSize=null,this.glyphSize=null,this.intensity=null,this.atlases=null,this.type=null,this.fontWeight=null}_colorToRgbString(e,t){let s,i=Math.round(255*e.r),r=Math.round(255*e.g),a=Math.round(255*e.b);return t?s=`rgba(${i}, ${r}, ${a}, ${e.a})`:s=`rgb(${i}, ${r}, ${a})`,s}renderCharacter(e,t,s,i,r){e.fillStyle=r,e.fillText(t,s,i)}_getAtlas(e){return e>=this.atlases.length&&(this.atlases[e]=new Y2(this.app.graphicsDevice,this.width,this.height,`font-atlas-${this.fontName}-${e}`)),this.atlases[e]}_renderAtlas(e){this.chars=e;let t=this.width,s=this.height,i=this._colorToRgbString(this.color,!1),r=this.color.a;this.color.a=1/255;let a=this._colorToRgbString(this.color,!0);this.color.a=r;let n="center",l="alphabetic",h=0,c=this._getAtlas(h++);c.clear(a),this.data=this._createJson(this.chars,this.fontName,t,s);let f=zr.getSymbols(this.chars.join("")),d=0,u=0,p={};for(let v=0;v<f.length;v++){let R=f[v];p[R]=this._getTextMetrics(R),d=Math.max(d,p[R].height),u=Math.max(u,p[R].descent)}this.glyphSize=Math.max(this.glyphSize,d);let _=this.glyphSize+this.padding*2,S=this.glyphSize+this.padding*2,T=this.glyphSize/2+this.padding,x=S-u-this.padding,A=0,E=0;for(let v=0;v<f.length;v++){let R=f[v],P=zr.getCodePoint(f[v]),y=this.fontSize;c.ctx.font=`${this.fontWeight} ${y.toString()}px ${this.fontName}`,c.ctx.textAlign=n,c.ctx.textBaseline=l;let C=c.ctx.measureText(R).width;C>y&&(y=this.fontSize*this.fontSize/C,c.ctx.font=`${this.fontWeight} ${y.toString()}px ${this.fontName}`,C=this.fontSize),this.renderCharacter(c.ctx,R,A+T,E+x,i);let L=this.padding+(this.glyphSize-C)/2,O=-this.padding+p[R].descent-u,M=C;this._addChar(this.data,R,P,A,E,_,S,L,O,M,h-1,t,s),A+=_,A+_>t&&(A=0,E+=S,E+S>s&&(c=this._getAtlas(h++),c.clear(a),E=0))}this.atlases.splice(h).forEach(v=>v.destroy()),this.atlases.forEach(v=>v.texture.upload()),this.fire("render")}_createJson(e,t,s,i){return{version:3,intensity:this.intensity,info:{face:t,width:s,height:i,maps:[{width:s,height:i}]},chars:{}}}_addChar(e,t,s,i,r,a,n,l,h,c,f,d,u){e.info.maps.length<f+1&&e.info.maps.push({width:d,height:u});let p=this.fontSize/32;e.chars[t]={id:s,letter:t,x:i,y:r,width:a,height:n,xadvance:c/p,xoffset:l/p,yoffset:(h+this.padding)/p,scale:p,range:1,map:f,bounds:[0,0,a/p,n/p]}}_normalizeCharsSet(e){let t=this.app.systems.element.getUnicodeConverter();t&&(e=t(e));let s={},i=zr.getSymbols(e);for(let a=0;a<i.length;a++){let n=i[a];s[n]||(s[n]=n)}return Object.keys(s).sort()}_getTextMetrics(e){let t=document.createElement("span");t.id="content-span",t.innerHTML=e;let s=document.createElement("div");s.id="content-block",s.style.display="inline-block",s.style.width="1px",s.style.height="0px";let i=document.createElement("div");i.appendChild(t),i.appendChild(s),i.style.font=`${this.fontSize}px ${this.fontName}`,document.body.appendChild(i);let a=-1,n=-1,l=-1;try{s.style["vertical-align"]="baseline",a=s.offsetTop-t.offsetTop,s.style["vertical-align"]="bottom",l=s.offsetTop-t.offsetTop,n=l-a}finally{document.body.removeChild(i)}return{ascent:a,descent:n,height:l}}get textures(){return this.atlases.map(e=>e.texture)}}});var UR,xhe,BR,rJ=m(()=>{qt();us();J();UR=[],xhe=[[],[],[]],BR=class extends Xe{constructor(e,t){super(e),this.viewBindGroups=[],this.renderer=t}destroy(){this.viewBindGroups.forEach(e=>{e.defaultUniformBuffer.destroy(),e.destroy()}),this.viewBindGroups.length=0}update(e,t,s,i){this.camera=e,this.scene=t,this.layers=s,this.mapping=i}execute(){let e=this.device,{renderer:t,camera:s,scene:i,layers:r,mapping:a,renderTarget:n}=this,l=i.layers.layerList,h=i.layers.subLayerEnabled,c=i.layers.subLayerList;for(let f=0;f<l.length;f++){let d=l[f];if(!(r&&r.indexOf(d)<0)&&d.enabled&&h[f]&&d.camerasSet.has(s.camera)){let u=c[f];d._clearDepthBuffer&&t.clear(s.camera,!1,!0,!1);let p=d.meshInstances;for(let _=0;_<p.length;_++){let S=p[_];S.pick&&S.transparent===u&&(UR.push(S),a.set(S.id,S))}UR.length>0&&(i.clusteredLightingEnabled&&t.worldClustersAllocator.empty.activate(),t.setCameraUniforms(s.camera,n),e.supportsUniformBuffers&&t.setupViewUniformBuffers(this.viewBindGroups,t.viewUniformFormat,t.viewBindGroupFormat,null),t.renderForward(s.camera,n,UR,xhe,Sa,S=>{e.setBlendState(Ie.NOBLEND)}),UR.length=0)}}}}});var K2,yhe,VR,aJ=m(()=>{De();Rt();Fe();Ym();rJ();me();Ze();K2=new Set,yhe=new W,VR=class{constructor(e,t,s){this.renderTarget=null,this.mapping=new Map,this.deviceValid=!0,this.renderer=e.renderer,this.device=e.graphicsDevice,this.renderPass=new BR(this.device,e.renderer),this.width=0,this.height=0,this.resize(t,s),this.device.on("destroy",()=>{this.deviceValid=!1})}getSelection(e,t,s=1,i=1){let r=this.device;if(r.isWebGPU)return[];t=this.renderTarget.height-(t+i);let a=this.sanitizeRect(e,t,s,i);r.setRenderTarget(this.renderTarget),r.updateBegin();let n=new Uint8Array(4*a.z*a.w);return r.readPixels(a.x,a.y,a.z,a.w,n),r.updateEnd(),this.decodePixels(n,this.mapping)}getSelectionAsync(e,t,s=1,i=1){this.device?.isWebGL2&&(t=this.renderTarget.height-(t+i));let r=this.sanitizeRect(e,t,s,i);return this.renderTarget.colorBuffer.read(r.x,r.y,r.z,r.w,{renderTarget:this.renderTarget,immediate:!0}).then(a=>this.decodePixels(a,this.mapping))}sanitizeRect(e,t,s,i){let r=this.renderTarget.width,a=this.renderTarget.height;return e=w.clamp(Math.floor(e),0,r-1),t=w.clamp(Math.floor(t),0,a-1),s=Math.floor(Math.max(s,1)),s=Math.min(s,r-e),i=Math.floor(Math.max(i,1)),i=Math.min(i,a-t),yhe.set(e,t,s,i)}decodePixels(e,t){let s=[];if(this.deviceValid){let i=e.length;for(let r=0;r<i;r+=4){let a=e[r+0],n=e[r+1],l=e[r+2],c=(e[r+3]<<24|a<<16|n<<8|l)>>>0;c!==4294967295&&K2.add(t.get(c))}K2.forEach(r=>{r&&s.push(r)}),K2.clear()}return s}allocateRenderTarget(){let e=new q(this.device,{format:7,width:this.width,height:this.height,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1,name:"pick"});this.renderTarget=new xe({colorBuffer:e,depth:!0})}releaseRenderTarget(){this.renderTarget&&(this.renderTarget.destroyTextureBuffers(),this.renderTarget.destroy(),this.renderTarget=null)}prepare(e,t,s){s instanceof At&&(s=[s]),(!this.renderTarget||this.width!==this.renderTarget.width||this.height!==this.renderTarget.height)&&(this.releaseRenderTarget(),this.allocateRenderTarget()),this.mapping.clear();let i=this.renderPass;i.init(this.renderTarget),i.colorOps.clearValue=N.WHITE,i.colorOps.clear=!0,i.depthStencilOps.clearDepth=!0,i.update(e,t,s,this.mapping),i.render()}resize(e,t){this.width=Math.floor(e),this.height=Math.floor(t)}}});var kR,nJ=m(()=>{dR();_t();kR=class extends ye{constructor(e){super(e,"scenesettings")}load(e,t){zc.load(e,this.maxRetries,t)}open(e,t){return t.settings}}});function uJ(o,e,t){return Ahe.cross(o,e).dot(t)}function Rhe(o,e,t){xg.sub2(e,o),GR.sub2(t[0],o),j2.sub2(t[1],o),lJ.sub2(t[2],o),zR.cross(lJ,xg);let s=GR.dot(zR),i,r;if(s>=0){if(i=-j2.dot(zR),i<0||(r=uJ(xg,j2,GR),r<0))return-1;let a=1/(i+s+r);HR.copy(t[0]).mulScalar(i*a),XR.copy(t[1]).mulScalar(s*a),WR.copy(t[2]).mulScalar(r*a),Z2.copy(HR).add(XR).add(WR)}else{if($2.sub2(t[3],o),i=$2.dot(zR),i<0||(r=uJ(xg,GR,$2),r<0))return-1;s=-s;let a=1/(i+s+r);HR.copy(t[0]).mulScalar(i*a),XR.copy(t[3]).mulScalar(s*a),WR.copy(t[2]).mulScalar(r*a),Z2.copy(HR).add(XR).add(WR)}return xg.sub2(t[0],t[2]).lengthSq()<1e-4*1e-4||xg.sub2(t[1],t[3]).lengthSq()<1e-4*1e-4?-1:Z2.sub(o).lengthSq()}var Xc,Wc,q2,oJ,bl,eE,Q2,xg,GR,j2,lJ,$2,zR,HR,XR,WR,Z2,Ahe,yg,QT,YR,KR,JT,hJ,cJ,fJ,dJ,Phe,Vd,Ml,Dl,Fa,Ag,J2=m(()=>{bt();Q();Ze();Ql();qx();Jx();hc();q2=new g,oJ=new g,bl=new Es,eE=new Es,Q2=new Es;bl.end=new g;eE.end=new g;Q2.end=new g;xg=new g,GR=new g,j2=new g,lJ=new g,$2=new g,zR=new g,HR=new g,XR=new g,WR=new g,Z2=new g,Ahe=new g,yg=new g,QT=new g,YR=new g,KR=new g,JT=new g,hJ=new g,cJ=new g,fJ=new g,dJ=new g,Phe=new W;Vd=class{constructor(e,t,s){this.event=e,this.element=t,this.camera=s,this._stopPropagation=!1}stopPropagation(){this._stopPropagation=!0,this.event&&(this.event.stopImmediatePropagation(),this.event.stopPropagation())}},Ml=class extends Vd{constructor(e,t,s,i,r,a,n){super(e,t,s),this.x=i,this.y=r,this.ctrlKey=e.ctrlKey||!1,this.altKey=e.altKey||!1,this.shiftKey=e.shiftKey||!1,this.metaKey=e.metaKey||!1,this.button=e.button,ma.isPointerLocked()?(this.dx=e.movementX||e.webkitMovementX||e.mozMovementX||0,this.dy=e.movementY||e.webkitMovementY||e.mozMovementY||0):(this.dx=i-a,this.dy=r-n),this.wheelDelta=0,e.type==="wheel"&&(e.deltaY>0?this.wheelDelta=1:e.deltaY<0&&(this.wheelDelta=-1))}},Dl=class extends Vd{constructor(e,t,s,i,r,a){super(e,t,s),this.touches=e.touches,this.changedTouches=e.changedTouches,this.x=i,this.y=r,this.touch=a}},Fa=class extends Vd{constructor(e,t,s,i){super(e,t,s),this.inputSource=i}},Ag=class o{constructor(e,t){this._app=null,this._attached=!1,this._target=null,this._enabled=!0,this._lastX=0,this._lastY=0,this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._touchstartHandler=this._handleTouchStart.bind(this),this._touchendHandler=this._handleTouchEnd.bind(this),this._touchcancelHandler=this._touchendHandler,this._touchmoveHandler=this._handleTouchMove.bind(this),this._sortHandler=this._sortElements.bind(this),this._elements=[],this._hoveredElement=null,this._pressedElement=null,this._touchedElements={},this._touchesForWhichTouchLeaveHasFired={},this._selectedElements={},this._selectedPressedElements={},this._useMouse=!t||t.useMouse!==!1,this._useTouch=!t||t.useTouch!==!1,this._useXr=!t||t.useXr!==!1,this._selectEventsAttached=!1,ue.touch&&(this._clickedEntities={}),this.attach(e)}set enabled(e){this._enabled=e}get enabled(){return this._enabled}set app(e){this._app=e}get app(){return this._app||Ss()}attach(e){this._attached&&(this._attached=!1,this.detach()),this._target=e,this._attached=!0;let t=ue.passiveEvents?{passive:!0}:!1;this._useMouse&&(window.addEventListener("mouseup",this._upHandler,t),window.addEventListener("mousedown",this._downHandler,t),window.addEventListener("mousemove",this._moveHandler,t),window.addEventListener("wheel",this._wheelHandler,t)),this._useTouch&&ue.touch&&(this._target.addEventListener("touchstart",this._touchstartHandler,t),this._target.addEventListener("touchend",this._touchendHandler,!1),this._target.addEventListener("touchmove",this._touchmoveHandler,!1),this._target.addEventListener("touchcancel",this._touchcancelHandler,!1)),this.attachSelectEvents()}attachSelectEvents(){!this._selectEventsAttached&&this._useXr&&this.app&&this.app.xr&&this.app.xr.supported&&(this._clickedEntities||(this._clickedEntities={}),this._selectEventsAttached=!0,this.app.xr.on("start",this._onXrStart,this))}detach(){if(!this._attached)return;this._attached=!1;let e=ue.passiveEvents?{passive:!0}:!1;this._useMouse&&(window.removeEventListener("mouseup",this._upHandler,e),window.removeEventListener("mousedown",this._downHandler,e),window.removeEventListener("mousemove",this._moveHandler,e),window.removeEventListener("wheel",this._wheelHandler,e)),this._useTouch&&(this._target.removeEventListener("touchstart",this._touchstartHandler,e),this._target.removeEventListener("touchend",this._touchendHandler,!1),this._target.removeEventListener("touchmove",this._touchmoveHandler,!1),this._target.removeEventListener("touchcancel",this._touchcancelHandler,!1)),this._selectEventsAttached&&(this._selectEventsAttached=!1,this.app.xr.off("start",this._onXrStart,this),this.app.xr.off("end",this._onXrEnd,this),this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this)),this._target=null}addElement(e){this._elements.indexOf(e)===-1&&this._elements.push(e)}removeElement(e){let t=this._elements.indexOf(e);t!==-1&&this._elements.splice(t,1)}_handleUp(e){this._enabled&&(ma.isPointerLocked()||(this._calcMouseCoords(e),this._onElementMouseEvent("mouseup",e)))}_handleDown(e){this._enabled&&(ma.isPointerLocked()||(this._calcMouseCoords(e),this._onElementMouseEvent("mousedown",e)))}_handleMove(e){this._enabled&&(this._calcMouseCoords(e),this._onElementMouseEvent("mousemove",e),this._lastX=Xc,this._lastY=Wc)}_handleWheel(e){this._enabled&&(this._calcMouseCoords(e),this._onElementMouseEvent("mousewheel",e))}_determineTouchedElements(e){let t={},s=this.app.systems.camera.cameras;for(let i=s.length-1;i>=0;i--){let r=s[i],a=0,n=e.changedTouches.length;for(let l=0;l<n;l++){if(t[e.changedTouches[l].identifier]){a++;continue}let h=Ef(e.changedTouches[l]),c=this._getTargetElementByCoords(r,h.x,h.y);c&&(a++,t[e.changedTouches[l].identifier]={element:c,camera:r,x:h.x,y:h.y})}if(a===n)break}return t}_handleTouchStart(e){if(!this._enabled)return;let t=this._determineTouchedElements(e);for(let s=0,i=e.changedTouches.length;s<i;s++){let r=e.changedTouches[s],a=t[r.identifier],n=this._touchedElements[r.identifier];a&&(!n||a.element!==n.element)&&(this._fireEvent(e.type,new Dl(e,a.element,a.camera,a.x,a.y,r)),this._touchesForWhichTouchLeaveHasFired[r.identifier]=!1)}for(let s in t)this._touchedElements[s]=t[s]}_handleTouchEnd(e){if(!this._enabled)return;let t=this.app.systems.camera.cameras;for(let s in this._clickedEntities)delete this._clickedEntities[s];for(let s=0,i=e.changedTouches.length;s<i;s++){let r=e.changedTouches[s],a=this._touchedElements[r.identifier];if(!a)continue;let n=a.element,l=a.camera,h=a.x,c=a.y;delete this._touchedElements[r.identifier],delete this._touchesForWhichTouchLeaveHasFired[r.identifier];let f=Ef(r);for(let d=t.length-1;d>=0;d--)this._getTargetElementByCoords(t[d],f.x,f.y)===n&&(this._clickedEntities[n.entity.getGuid()]||(this._fireEvent("click",new Dl(e,n,l,h,c,r)),this._clickedEntities[n.entity.getGuid()]=Date.now()));this._fireEvent(e.type,new Dl(e,n,l,h,c,r))}}_handleTouchMove(e){if(e.preventDefault(),!this._enabled)return;let t=this._determineTouchedElements(e);for(let s=0,i=e.changedTouches.length;s<i;s++){let r=e.changedTouches[s],a=t[r.identifier],n=this._touchedElements[r.identifier];if(n){let l=Ef(r);(!a||a.element!==n.element)&&!this._touchesForWhichTouchLeaveHasFired[r.identifier]&&(this._fireEvent("touchleave",new Dl(e,n.element,n.camera,l.x,l.y,r)),this._touchesForWhichTouchLeaveHasFired[r.identifier]=!0),this._fireEvent("touchmove",new Dl(e,n.element,n.camera,l.x,l.y,r))}}}_onElementMouseEvent(e,t){let s=null,i=this._hoveredElement;this._hoveredElement=null;let r=this.app.systems.camera.cameras,a;for(let n=r.length-1;n>=0&&(a=r[n],s=this._getTargetElementByCoords(a,Xc,Wc),!s);n--);if(this._hoveredElement=s,(e==="mousemove"||e==="mouseup")&&this._pressedElement?this._fireEvent(e,new Ml(t,this._pressedElement,a,Xc,Wc,this._lastX,this._lastY)):s&&(this._fireEvent(e,new Ml(t,s,a,Xc,Wc,this._lastX,this._lastY)),e==="mousedown"&&(this._pressedElement=s)),i!==this._hoveredElement&&(i&&this._fireEvent("mouseleave",new Ml(t,i,a,Xc,Wc,this._lastX,this._lastY)),this._hoveredElement&&this._fireEvent("mouseenter",new Ml(t,this._hoveredElement,a,Xc,Wc,this._lastX,this._lastY))),e==="mouseup"&&this._pressedElement){if(this._pressedElement===this._hoveredElement){let n=this._hoveredElement.entity.getGuid(),l=!this._clickedEntities;if(this._clickedEntities){let h=this._clickedEntities[n]||0;l=Date.now()-h>300,delete this._clickedEntities[n]}l&&this._fireEvent("click",new Ml(t,this._hoveredElement,a,Xc,Wc,this._lastX,this._lastY))}this._pressedElement=null}}_onXrStart(){this.app.xr.on("end",this._onXrEnd,this),this.app.xr.on("update",this._onXrUpdate,this),this.app.xr.input.on("selectstart",this._onSelectStart,this),this.app.xr.input.on("selectend",this._onSelectEnd,this),this.app.xr.input.on("remove",this._onXrInputRemove,this)}_onXrEnd(){this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this)}_onXrUpdate(){if(!this._enabled)return;let e=this.app.xr.input.inputSources;for(let t=0;t<e.length;t++)this._onElementSelectEvent("selectmove",e[t],null)}_onXrInputRemove(e){let t=this._selectedElements[e.id];t&&(e._elementEntity=null,this._fireEvent("selectleave",new Fa(null,t,null,e))),delete this._selectedElements[e.id],delete this._selectedPressedElements[e.id]}_onSelectStart(e,t){this._enabled&&this._onElementSelectEvent("selectstart",e,t)}_onSelectEnd(e,t){this._enabled&&this._onElementSelectEvent("selectend",e,t)}_onElementSelectEvent(e,t,s){let i,r=this._selectedElements[t.id],a,n=this.app.systems.camera.cameras,l;if(t.elementInput){Q2.set(t.getOrigin(),t.getDirection());for(let c=n.length-1;c>=0&&(l=n[c],i=this._getTargetElementByRay(Q2,l),!i);c--);}t._elementEntity=i||null,i?(this._selectedElements[t.id]=i,a=i):delete this._selectedElements[t.id],r!==a&&(r&&this._fireEvent("selectleave",new Fa(s,r,l,t)),a&&this._fireEvent("selectenter",new Fa(s,a,l,t)));let h=this._selectedPressedElements[t.id];e==="selectmove"&&h&&this._fireEvent("selectmove",new Fa(s,h,l,t)),e==="selectstart"&&(this._selectedPressedElements[t.id]=a,a&&this._fireEvent("selectstart",new Fa(s,a,l,t))),!t.elementInput&&h&&(delete this._selectedPressedElements[t.id],r&&this._fireEvent("selectend",new Fa(s,h,l,t))),e==="selectend"&&t.elementInput&&(delete this._selectedPressedElements[t.id],h&&this._fireEvent("selectend",new Fa(s,h,l,t)),h&&h===r&&this._fireEvent("click",new Fa(s,h,l,t)))}_fireEvent(e,t){let s=t.element;for(;s.fire(e,t),!(t._stopPropagation||!s.entity.parent||(s=s.entity.parent.element,!s)););}_calcMouseCoords(e){let t=this._target.getBoundingClientRect(),s=Math.floor(t.left),i=Math.floor(t.top);Xc=e.clientX-s,Wc=e.clientY-i}_sortElements(e,t){let s=this.app.scene.layers.sortTransparentLayers(e.layers,t.layers);return s!==0?s:e.screen&&!t.screen?-1:!e.screen&&t.screen?1:!e.screen&&!t.screen?0:e.screen.screen.screenSpace&&!t.screen.screen.screenSpace?-1:t.screen.screen.screenSpace&&!e.screen.screen.screenSpace?1:t.drawOrder-e.drawOrder}_getTargetElementByCoords(e,t,s){let i=this._calculateRayScreen(t,s,e,bl)?bl:null,r=this._calculateRay3d(t,s,e,eE)?eE:null;return this._getTargetElement(e,i,r)}_getTargetElementByRay(e,t){bl.origin.copy(e.origin),bl.direction.copy(e.direction),bl.end.copy(bl.direction).mulScalar(t.farClip*2).add(bl.origin);let s=bl,i=t.worldToScreen(s.origin,q2),r=this._calculateRayScreen(i.x,i.y,t,eE)?eE:null;return this._getTargetElement(t,r,s)}_getTargetElement(e,t,s){let i=null,r=1/0;this._elements.sort(this._sortHandler);for(let a=0,n=this._elements.length;a<n;a++){let l=this._elements[a];if(l.layers.some(h=>e.layersSet.has(h)))if(l.screen&&l.screen.screen.screenSpace){if(!t)continue;if(this._checkElement(t,l,!0)>=0){i=l;break}}else{if(!s)continue;let h=this._checkElement(s,l,!1);if(h>=0&&(h<r&&(i=l,r=h),l.screen)){i=l;break}}}return i}_calculateRayScreen(e,t,s,i){let r=this.app.graphicsDevice.width,a=this.app.graphicsDevice.height,n=s.rect.z*r,l=s.rect.w*a,h=s.rect.x*r,c=h+n,f=(1-s.rect.y)*a,d=f-l,u=e*r/this._target.clientWidth,p=t*a/this._target.clientHeight;return u>=h&&u<=c&&p<=f&&p>=d?(u=r*(u-h)/n,p=a*(p-d)/l,p=a-p,i.origin.set(u,p,1),i.direction.set(0,0,-1),i.end.copy(i.direction).mulScalar(2).add(i.origin),!0):!1}_calculateRay3d(e,t,s,i){let r=this._target.clientWidth,a=this._target.clientHeight,n=s.rect.z*r,l=s.rect.w*a,h=s.rect.x*r,c=h+n,f=(1-s.rect.y)*a,d=f-l,u=e,p=t;return e>=h&&e<=c&&t<=f&&p>=d?(u=r*(u-h)/n,p=a*(p-d)/l,s.screenToWorld(u,p,s.nearClip,q2),s.screenToWorld(u,p,s.farClip,oJ),i.origin.copy(q2),i.direction.set(0,0,-1),i.end.copy(oJ),!0):!1}_checkElement(e,t,s){if(t.maskedBy&&this._checkElement(e,t.maskedBy.element,s)<0)return-1;let i;s?i=o.calculateScaleToScreen(t):i=o.calculateScaleToWorld(t);let r=o.buildHitCorners(t,s?t.screenCorners:t.worldCorners,i);return Rhe(e.origin,e.end,r)}static buildHitCorners(e,t,s){let i=t;if(e.entity&&e.entity.button){let a=e.entity.button.hitPadding||Phe;QT.copy(e.entity.up),YR.copy(QT).mulScalar(-1),JT.copy(e.entity.right),KR.copy(JT).mulScalar(-1),QT.mulScalar(a.w*s.y),YR.mulScalar(a.y*s.y),JT.mulScalar(a.z*s.x),KR.mulScalar(a.x*s.x),hJ.copy(i[0]).add(YR).add(KR),cJ.copy(i[1]).add(YR).add(JT),fJ.copy(i[2]).add(QT).add(JT),dJ.copy(i[3]).add(QT).add(KR),i=[hJ,cJ,fJ,dJ]}if(s.x<0){let a=i[2].x,n=i[0].x;i[0].x=a,i[1].x=n,i[2].x=n,i[3].x=a}if(s.y<0){let a=i[2].y,n=i[0].y;i[0].y=a,i[1].y=a,i[2].y=n,i[3].y=n}if(s.z<0){let a=i[2].x,n=i[2].y,l=i[2].z;i[2].x=i[0].x,i[2].y=i[0].y,i[2].z=i[0].z,i[0].x=a,i[0].y=n,i[0].z=l}return i}static calculateScaleToScreen(e){let t=e.entity,s=e.screen.screen.scale;for(yg.set(s,s,s);t&&!t.screen;)yg.mul(t.getLocalScale()),t=t.parent;return yg}static calculateScaleToWorld(e){let t=e.entity;for(yg.set(1,1,1);t;)yg.mul(t.getLocalScale()),t=t.parent;return yg}}});function zJ(o,e){return Ce.fromGeometry(o,new or(e))}function HJ(o,e){return Ce.fromGeometry(o,new wa(e))}function XJ(o,e){return Ce.fromGeometry(o,new hi(e))}function WJ(o,e){return Ce.fromGeometry(o,new Dr(e))}function YJ(o,e){return Ce.fromGeometry(o,new nc(e))}function KJ(o,e){return Ce.fromGeometry(o,new Ia(e))}function qJ(o,e){return Ce.fromGeometry(o,new hr(e))}function jJ(o,e,t={}){let s=new Qt;return s.positions=e,s.normals=t.normals,s.tangents=t.tangents,s.colors=t.colors,s.uvs=t.uvs,s.uvs1=t.uvs1,s.blendIndices=t.blendIndices,s.blendWeights=t.blendWeights,s.indices=t.indices,Ce.fromGeometry(o,s,t)}function $J(o,e,t,s,i){let r;if(i){let a=e?e.width:o.width,n=e?e.height:o.height;r=Che.set(i.x*a,i.y*n,i.z*a,i.w*n)}Ot(o,e,s,r)}function fi(o,e,t=""){Object.defineProperty(o.prototype,e,{set:function(s){},get:function(){}})}function _n(o,e){Object.defineProperty(ct.prototype,e,{get:function(){return this[o]},set:function(t){this[o]=t}})}function qR(o){Object.defineProperty(ct.prototype,o,{get:function(){return!0},set:function(e){}})}function tee(o,e){o!=="pass"&&Object.defineProperty(lr.prototype,o,{get:function(){return this.litOptions[e||o]},set:function(t){this.litOptions[e||o]=t}})}var pJ,_J,gJ,SJ,TJ,EJ,vJ,xJ,yJ,AJ,PJ,RJ,CJ,IJ,wJ,LJ,bJ,MJ,DJ,OJ,NJ,FJ,UJ,BJ,VJ,kJ,GJ,Che,ss,Ol,ZJ,QJ,JJ,eee,Ihe,mJ,see,iee,tE,sE,iE,rE,aE,nE,oE,lE,ree,aee,nee,oee,lee,hee,cee,fee,dee,uee,mee,pee,_ee,gee,See,Tee,Eee=m(()=>{Ne();Q();Ze();me();j();Ea();Zu();cA();Rt();Fe();Cr();qt();ii();FA();nn();rd();Zh();YA();fp();dp();td();up();oA();Zt();rl();Ws();eT();_s();OA();ln();Vh();lp();sT();Ym();l0();DR();J2();Kx();mT();hc();RP();cP();MP();OP();XP();It();D.prototype.scale=D.prototype.mulScalar;g.prototype.scale=g.prototype.mulScalar;W.prototype.scale=W.prototype.mulScalar;pJ=2,_J=3,gJ=4,SJ=5,TJ=6,EJ=7,vJ=19,xJ=20,yJ=11,AJ=12,PJ=11,RJ=12,CJ="1.51",IJ="1.55",wJ="1.56",LJ="1.57",bJ="1.58",MJ="1.60",DJ="1.62",OJ="1.65",NJ="1.70",FJ="2.1",UJ="2.3",BJ="2.5",VJ="2.6",kJ="2.7",GJ="2.8",Che=new W;Object.defineProperties(xe.prototype,{_glFrameBuffer:{get:function(){return this.impl._glFrameBuffer},set:function(o){}}});Object.defineProperty(Tt,"defaultInstancingFormat",{get:function(){return null}});Object.defineProperties(q.prototype,{rgbm:{get:function(){return this.type===ti},set:function(o){this.type=o?ti:zt}},swizzleGGGR:{get:function(){return this.type===Nn},set:function(o){this.type=o?Nn:zt}},_glTexture:{get:function(){return this.impl._glTexture}}});Object.defineProperty(Qe.prototype,"boneLimit",{get:function(){return 1024}});Object.defineProperty(Qe.prototype,"webgl2",{get:function(){return this.isWebGL2}});Object.defineProperty(Qe.prototype,"textureFloatHighPrecision",{get:function(){return!0}});Object.defineProperty(Qe.prototype,"extBlendMinmax",{get:function(){return!0}});Object.defineProperty(Qe.prototype,"extTextureHalfFloat",{get:function(){return!0}});Object.defineProperty(Qe.prototype,"extTextureLod",{get:function(){return!0}});Object.defineProperty(Qe.prototype,"textureHalfFloatFilterable",{get:function(){return!0}});Object.defineProperty(Qe.prototype,"supportsMrt",{get:function(){return!0}});Object.defineProperty(Qe.prototype,"supportsVolumeTextures",{get:function(){return!0}});Object.defineProperty(Qe.prototype,"supportsInstancing",{get:function(){return!0}});Object.defineProperty(Qe.prototype,"textureHalfFloatUpdatable",{get:function(){return!0}});Object.defineProperty(Qe.prototype,"extTextureFloat",{get:function(){return!0}});Object.defineProperty(Qe.prototype,"extStandardDerivatives",{get:function(){return!0}});Ie.DEFAULT=Object.freeze(new Ie);ss=new Ie,Ol=new $e;Qe.prototype.setBlendFunction=function(o,e){let t=this.blendState;ss.copy(t),ss.setColorBlend(t.colorOp,o,e),ss.setAlphaBlend(t.alphaOp,o,e),this.setBlendState(ss)};Qe.prototype.setBlendFunctionSeparate=function(o,e,t,s){let i=this.blendState;ss.copy(i),ss.setColorBlend(i.colorOp,o,e),ss.setAlphaBlend(i.alphaOp,t,s),this.setBlendState(ss)};Qe.prototype.setBlendEquation=function(o){let e=this.blendState;ss.copy(e),ss.setColorBlend(o,e.colorSrcFactor,e.colorDstFactor),ss.setAlphaBlend(o,e.alphaSrcFactor,e.alphaDstFactor),this.setBlendState(ss)};Qe.prototype.setBlendEquationSeparate=function(o,e){let t=this.blendState;ss.copy(t),ss.setColorBlend(o,t.colorSrcFactor,t.colorDstFactor),ss.setAlphaBlend(e,t.alphaSrcFactor,t.alphaDstFactor),this.setBlendState(ss)};Qe.prototype.setColorWrite=function(o,e,t,s){let i=this.blendState;ss.copy(i),ss.setColorWrite(o,e,t,s),this.setBlendState(ss)};Qe.prototype.getBlending=function(){return this.blendState.blend};Qe.prototype.setBlending=function(o){ss.copy(this.blendState),ss.blend=o,this.setBlendState(ss)};Qe.prototype.setDepthWrite=function(o){Ol.copy(this.depthState),Ol.write=o,this.setDepthState(Ol)};Qe.prototype.setDepthFunc=function(o){Ol.copy(this.depthState),Ol.func=o,this.setDepthState(Ol)};Qe.prototype.setDepthTest=function(o){Ol.copy(this.depthState),Ol.test=o,this.setDepthState(Ol)};Qe.prototype.getCullMode=function(){return this.cullMode};ZJ=dl,QJ=ul,JJ=on,eee=new Proxy({},{get(o,e){return ie.get(Ss().graphicsDevice,oe).get(e)},set(o,e,t){return ie.get(Ss().graphicsDevice,oe).set(e,t),!0}});Object.defineProperty(qs.prototype,"defaultMaterial",{get:function(){return va(Ss().graphicsDevice)}});Object.defineProperty(qs.prototype,"fogColor",{set:function(o){this.fog.color=o},get:function(){return this.fog.color}});Object.defineProperty(qs.prototype,"fogEnd",{set:function(o){this.fog.end=o},get:function(){return this.fog.end}});Object.defineProperty(qs.prototype,"fogStart",{set:function(o){this.fog.start=o},get:function(){return this.fog.start}});Object.defineProperty(qs.prototype,"fogDensity",{set:function(o){this.fog.density=o},get:function(){return this.fog.density}});Object.defineProperty(qs.prototype,"toneMapping",{set:function(o){},get:function(){}});Object.defineProperty(qs.prototype,"gammaCorrection",{set:function(o){},get:function(){}});Object.defineProperty(qs.prototype,"rendering",{set:function(o){},get:function(){}});Object.defineProperty(nl.prototype,"_meshInstances",{get:function(){return null}});Object.defineProperty(qs.prototype,"drawCalls",{get:function(){return null}});["128","64","32","16","8","4"].forEach((o,e)=>{Object.defineProperty(qs.prototype,`skyboxPrefiltered${o}`,{get:function(){return this._prefilteredCubemaps[e]},set:function(t){this._prefilteredCubemaps[e]=t,this.updateShaders=!0}})});Object.defineProperty(qs.prototype,"models",{get:function(){return this._models||(this._models=[]),this._models}});fi(At,"renderTarget");fi(At,"onPreCull");fi(At,"onPreRender");fi(At,"onPreRenderOpaque");fi(At,"onPreRenderTransparent");fi(At,"onPostCull");fi(At,"onPostRender");fi(At,"onPostRenderOpaque");fi(At,"onPostRenderTransparent");fi(At,"onDrawCall");fi(At,"layerReference");fi(cr,"onPreCull","Use Scene#EVENT_PRECULL event instead.");fi(cr,"onPostCull","Use Scene#EVENT_POSTCULL event instead.");fi(cr,"onPreRender","Use Scene#EVENT_PRERENDER event instead.");fi(cr,"onPostRender","Use Scene#EVENT_POSTRENDER event instead.");fi(cr,"onPreRenderLayer","Use Scene#EVENT_PRERENDER_LAYER event instead.");fi(cr,"onPostRenderLayer","Use Scene#EVENT_POSTRENDER_LAYER event instead.");Wh.prototype.renderComposition=function(o){Ss().renderComposition(o)};Oe.prototype.syncAabb=function(){};po.prototype.getTarget=function(o){return this.targets[o]};Ae.prototype.getChildren=function(){return this.children};Ae.prototype.getName=function(){return this.name};Ae.prototype.getPath=function(){return this.path};Ae.prototype.getRoot=function(){return this.root};Ae.prototype.getParent=function(){return this.parent};Ae.prototype.setName=function(o){this.name=o};Object.defineProperty(Os.prototype,"shader",{set:function(o){},get:function(){return null}});Object.defineProperty(Os.prototype,"blend",{set:function(o){this.blendState.blend=o},get:function(){return this.blendState.blend}});Object.defineProperty(ct.prototype,"shininess",{get:function(){return this.gloss*100},set:function(o){this.gloss=o*.01}});Object.defineProperty(ct.prototype,"useGammaTonemap",{get:function(){return this.useTonemap},set:function(o){this.useTonemap=o}});Object.defineProperty(ct.prototype,"anisotropy",{get:function(){let o=Math.sign(Math.cos(this.anisotropyRotation*w.DEG_TO_RAD*2));return this.anisotropyIntensity*o},set:function(o){this.anisotropyIntensity=Math.abs(o),o>=0?this.anisotropyRotation=0:this.anisotropyRotation=90}});qR("sheenTint");qR("diffuseTint");qR("emissiveTint");qR("ambientTint");_n("specularTint","specularMapTint");_n("aoVertexColor","aoMapVertexColor");_n("diffuseVertexColor","diffuseMapVertexColor");_n("specularVertexColor","specularMapVertexColor");_n("emissiveVertexColor","emissiveMapVertexColor");_n("metalnessVertexColor","metalnessMapVertexColor");_n("glossVertexColor","glossMapVertexColor");_n("opacityVertexColor","opacityMapVertexColor");_n("lightVertexColor","lightMapVertexColor");_n("sheenGloss","sheenGlossiess");_n("clearCoatGloss","clearCostGlossiness");tee("refraction","useRefraction");Ihe=new on,mJ=Object.getOwnPropertyNames(Ihe);for(let o in mJ)tee(mJ[o]);fc.prototype.getAssetById=function(o){return this.get(o)};Object.defineProperty(Co.prototype,"ray",{get:function(){return this._rayLocal}});Object.defineProperty(Co.prototype,"position",{get:function(){return this._localPosition}});Object.defineProperty(Co.prototype,"rotation",{get:function(){return this._localRotation}});see="keydown",iee="keyup",tE="mousedown",sE="mousemove",iE="mouseup",rE="mousewheel",aE="touchstart",nE="touchend",oE="touchmove",lE="touchcancel",ree="gamepadconnected",aee="gamepaddisconnected",nee="select",oee="selectstart",lee="selectend";Object.defineProperty(Ag.prototype,"wheel",{get:function(){return this.wheelDelta*-2}});Object.defineProperty(qa.prototype,"wheel",{get:function(){return this.wheelDelta*-2}});hee=Ao,cee=yi,fee=fn,dee=1,uee=2,mee=4,pee=1,_ee=2,gee=3,See=4,Tee=5;js.prototype.isFullscreen=function(){return!!document.fullscreenElement};js.prototype.enableFullscreen=function(o,e,t){o=o||this.graphicsDevice.canvas;let s=function(){e(),document.removeEventListener("fullscreenchange",s)},i=function(){t(),document.removeEventListener("fullscreenerror",i)};e&&document.addEventListener("fullscreenchange",s,!1),t&&document.addEventListener("fullscreenerror",i,!1),o.requestFullscreen?o.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT):t()};js.prototype.disableFullscreen=function(o){let e=function(){o(),document.removeEventListener("fullscreenchange",e)};o&&document.addEventListener("fullscreenchange",e,!1),document.exitFullscreen()};js.prototype.getSceneUrl=function(o){let e=this.scenes.find(o);return e?e.url:null};js.prototype.loadScene=function(o,e){this.scenes.loadScene(o,e)};js.prototype.loadSceneHierarchy=function(o,e){this.scenes.loadSceneHierarchy(o,e)};js.prototype.loadSceneSettings=function(o,e){this.scenes.loadSceneSettings(o,e)};Pl.prototype.setVisible=function(o){this.enabled=o};Object.defineProperty(Na.prototype,"bodyType",{get:function(){return this.type},set:function(o){this.type=o}});Na.prototype.syncBodyToEntity=function(){this._updateDynamic()};Lc.prototype.setGravity=function(){arguments.length===1?this.gravity.copy(arguments[0]):this.gravity.set(arguments[0],arguments[1],arguments[2])}});var jR,vee=m(()=>{ql();jR=class{constructor(e){this._frameIndex=0,this._frameTimings=[],this._timings=[],this._prevTimings=[],this.unitsName="ms",this.decimalPlaces=1,this.enabled=!0,e.on("frameupdate",this.begin.bind(this,"update")),e.on("framerender",this.mark.bind(this,"render")),e.on("frameend",this.mark.bind(this,"other"))}begin(e){if(!this.enabled)return;this._frameIndex<this._frameTimings.length&&this._frameTimings.splice(this._frameIndex);let t=this._prevTimings;this._prevTimings=this._timings,this._timings=this._frameTimings,this._frameTimings=t,this._frameIndex=0,this.mark(e)}mark(e){if(!this.enabled)return;let t=Us();if(this._frameIndex>0){let s=this._frameTimings[this._frameIndex-1];s[1]=t-s[1]}else if(this._timings.length>0){let s=this._timings[this._timings.length-1];s[1]=t-s[1]}if(this._frameIndex>=this._frameTimings.length)this._frameTimings.push([e,t]);else{let s=this._frameTimings[this._frameIndex];s[0]=e,s[1]=t}this._frameIndex++}get timings(){return this._timings.slice(0,-1).map(e=>e[1])}}});var $R,xee=m(()=>{$R=class{constructor(e){this.device=e,e.gpuProfiler.enabled=!0,this.enabled=!0,this.unitsName="ms",this.decimalPlaces=1,this._timings=[]}get timings(){return this._timings[0]=this.device.gpuProfiler._frameTime,this._timings}}});var ZR,yee=m(()=>{ZR=class{constructor(e,t,s,i,r){this.app=e,this.values=[],this.statNames=t,this.statNames.length>3&&(this.statNames.length=3),this.unitsName=i,this.decimalPlaces=s,this.multiplier=r||1;let a=(n,l)=>n.split(".").reduce((h,c)=>h?h[c]:null,l||this);e.on("frameupdate",n=>{for(let l=0;l<this.statNames.length;l++)this.values[l]=a(this.statNames[l],this.app.stats)*this.multiplier})}get timings(){return this.values}}});var Pg,Aee=m(()=>{Pg=class{constructor(e,t,s,i,r){this.app=t,this.name=e,this.device=t.graphicsDevice,this.timer=r,this.watermark=s,this.enabled=!1,this.textRefreshRate=i,this.avgTotal=0,this.avgTimer=0,this.avgCount=0,this.timingText="",this.texture=null,this.yOffset=0,this.cursor=0,this.sample=new Uint8ClampedArray(4),this.sample.set([0,0,0,255]),this.counter=0,this.app.on("frameupdate",this.update,this)}destroy(){this.app.off("frameupdate",this.update,this)}loseContext(){this.timer&&typeof this.timer.loseContext=="function"&&this.timer.loseContext()}update(e){let t=this.timer.timings,s=t.reduce((i,r)=>i+r,0);if(this.avgTotal+=s,this.avgTimer+=e,this.avgCount++,this.avgTimer>this.textRefreshRate&&(this.timingText=(this.avgTotal/this.avgCount).toFixed(this.timer.decimalPlaces),this.avgTimer=0,this.avgTotal=0,this.avgCount=0),this.enabled){let i=0,r=1.5*this.watermark;for(let n=0;n<t.length;++n)i+=Math.floor(t[n]/r*255),this.sample[n]=i;this.sample[3]=this.watermark/r*255,this.texture.lock().set(this.sample,(this.cursor+this.yOffset*this.texture.width)*4),this.texture.unlock(),this.cursor++,this.cursor===this.texture.width&&(this.cursor=0)}}render(e,t,s,i,r){e.quad(t+i,s,-i,r,this.enabled?this.cursor:0,this.enabled?.5+this.yOffset:this.texture.height-1,-i,0,this.texture,0)}}});var QR,Pee=m(()=>{me();Fe();QR=class{constructor(e,t){let s=u=>{u.font='10px "Lucida Console", Monaco, monospace',u.textAlign="left",u.textBaseline="alphabetic"},i=u=>u==="."||u.length===1&&u.charCodeAt(0)>=48&&u.charCodeAt(0)<=57,r=document.createElement("canvas"),a=r.getContext("2d",{alpha:!0});s(a);let n=new Map,l=5,h=512,c=l,f=l;t.forEach(u=>{let p=a.measureText(u),_=Math.ceil(-p.actualBoundingBoxLeft),S=Math.ceil(p.actualBoundingBoxRight),T=Math.ceil(p.actualBoundingBoxAscent),x=Math.ceil(p.actualBoundingBoxDescent),A=_+S,E=T+x;c+A+l>=h&&(c=l,f+=16),n.set(u,{l:_,r:S,a:T,d:x,w:A,h:E,x:c,y:f}),c+=A+l}),r.width=512,r.height=w.nextPowerOfTwo(f+16+l),s(a),a.fillStyle="rgb(0, 0, 0)",a.fillRect(0,0,r.width,r.height),n.forEach((u,p)=>{a.fillStyle=i(p)?"rgb(255, 255, 255)":"rgb(170, 170, 170)",a.fillText(p,u.x-u.l,u.y+u.a)}),this.placements=n;let d=a.getImageData(0,0,r.width,r.height).data;for(let u=0;u<d.length;u+=4)d[u+3]=d[u+0],d[u+0]=255,d[u+1]=255,d[u+2]=255;this.texture=new q(e,{name:"mini-stats-word-atlas",width:r.width,height:r.height,mipmaps:!1,minFilter:0,magFilter:0,levels:[d]})}destroy(){this.texture.destroy(),this.texture=null}render(e,t,s,i){let r=this.placements.get(t);return r?(e.quad(s+r.l-1,i-r.d+1,r.w+2,r.h+2,r.x-1,this.texture.height-r.y-r.h-1,void 0,void 0,this.texture,1),r.w):0}}});var whe,Lhe,bhe,Mhe,JR,Ree=m(()=>{j();ii();qt();Zt();_s();Ws();vh();$i();Cr();$h();whe=`
	attribute vec3 vertex_position;
	attribute vec4 vertex_texCoord0;
	varying vec4 uv0;
	varying float wordFlag;
	void main(void) {
		gl_Position = vec4(vertex_position.xy * 2.0 - 1.0, 0.5, 1.0);
		uv0 = vertex_texCoord0;
		wordFlag = vertex_position.z;
	}
`,Lhe=`
	attribute vertex_position: vec3f;
	attribute vertex_texCoord0: vec4f;
	varying uv0: vec4f;
	varying wordFlag: f32;
	@vertex fn vertexMain(input : VertexInput) -> VertexOutput {
		var output : VertexOutput;
		output.position = vec4(input.vertex_position.xy * 2.0 - 1.0, 0.5, 1.0);
		output.uv0 = input.vertex_texCoord0;
		output.wordFlag = input.vertex_position.z;
		return output;
	}
`,bhe=`
	varying vec4 uv0;
	varying float wordFlag;
	uniform vec4 clr;
	uniform sampler2D graphTex;
	uniform sampler2D wordsTex;
	void main (void) {
		vec4 graphSample = texture2D(graphTex, uv0.xy);
		vec4 graph;
		if (uv0.w < graphSample.r)
			graph = vec4(0.7, 0.2, 0.2, 1.0);
		else if (uv0.w < graphSample.g)
			graph = vec4(0.2, 0.7, 0.2, 1.0);
		else if (uv0.w < graphSample.b)
			graph = vec4(0.2, 0.2, 0.7, 1.0);
		else
			graph = vec4(0.0, 0.0, 0.0, 1.0 - 0.25 * sin(uv0.w * 3.14159));
		vec4 words = texture2D(wordsTex, vec2(uv0.x, 1.0 - uv0.y));
		gl_FragColor = mix(graph, words, wordFlag) * clr;
	}
`,Mhe=`
	varying uv0: vec4f;
	varying wordFlag: f32;
	uniform clr: vec4f;
	var graphTex : texture_2d<f32>;
	var graphTex_sampler : sampler;
	var wordsTex : texture_2d<f32>;
	var wordsTex_sampler : sampler;
	@fragment fn fragmentMain(input : FragmentInput) -> FragmentOutput {
		var uv0: vec4f = input.uv0;
		var graphSample: vec4f = textureSample(graphTex, graphTex_sampler, uv0.xy);
		var graph: vec4f;
		if (uv0.w < graphSample.r) {
			graph = vec4f(0.7, 0.2, 0.2, 1.0);
		} else if (uv0.w < graphSample.g) {
			graph = vec4f(0.2, 0.7, 0.2, 1.0);
		} else if (uv0.w < graphSample.b) {
			graph = vec4f(0.2, 0.2, 0.7, 1.0);
		} else {
			graph = vec4f(0.0, 0.0, 0.0, 1.0 - 0.25 * sin(uv0.w * 3.14159));
		}
		var words: vec4f = textureSample(wordsTex, wordsTex_sampler, vec2f(uv0.x, 1.0 - uv0.y));
		var output: FragmentOutput;
		output.color = mix(graph, words, input.wordFlag) * uniform.clr;
		return output;
	}
`,JR=class{constructor(e,t=512){let s=new Tt(e,[{semantic:te,components:3,type:pe},{semantic:ot,components:4,type:pe}]),i=new Uint16Array(t*6);for(let a=0;a<t;++a)i[a*6+0]=a*4,i[a*6+1]=a*4+1,i[a*6+2]=a*4+2,i[a*6+3]=a*4,i[a*6+4]=a*4+2,i[a*6+5]=a*4+3;this.device=e,this.buffer=new mt(e,s,t*4,{usage:2}),this.data=new Float32Array(this.buffer.numBytes/4),this.indexBuffer=new Ls(e,1,t*6,0,i),this.prim={type:As,indexed:!0,base:0,baseVertex:0,count:0},this.quads=0,this.mesh=new Ce(e),this.mesh.vertexBuffer=this.buffer,this.mesh.indexBuffer[0]=this.indexBuffer,this.mesh.primitive=[this.prim];let r=new oi({uniqueName:"MiniStats",vertexGLSL:whe,fragmentGLSL:bhe,vertexWGSL:Lhe,fragmentWGSL:Mhe,attributes:{vertex_position:te,vertex_texCoord0:ot}});this.material=r,r.cull=0,r.depthState=$e.NODEPTH,r.blendState=new Ie(!0,0,6,8,0,1,1),r.update(),this.meshInstance=new Oe(this.mesh,r,new Ae("MiniStatsMesh")),this.uniforms={clr:new Float32Array(4)},this.targetSize={width:e.width,height:e.height}}quad(e,t,s,i,r,a,n,l,h,c=0){let f=this.targetSize.width,d=this.targetSize.height,u=e/f,p=t/d,_=(e+s)/f,S=(t+i)/d,T=h.width,x=h.height,A=r/T,E=a/x,v=(r+(n??s))/T,R=(a+(l??i))/x;this.data.set([u,p,c,A,E,0,0,_,p,c,v,E,1,0,_,S,c,v,R,1,1,u,S,c,A,R,0,1],28*this.quads),this.quads++,this.prim.count+=6}startFrame(){this.quads=0,this.prim.count=0,this.targetSize.width=this.device.canvas.scrollWidth,this.targetSize.height=this.device.canvas.scrollHeight}render(e,t,s,i,r,a){this.buffer.setData(this.data.buffer),this.uniforms.clr.set(r,0),this.material.setParameter("clr",this.uniforms.clr),this.material.setParameter("graphTex",s),this.material.setParameter("wordsTex",i),e.drawMeshInstance(this.meshInstance,t)}}});var eC,Cee=m(()=>{me();Fe();J();vee();xee();yee();Aee();Pee();Ree();eC=class o{constructor(e,t){let s=e.graphicsDevice;t=t||o.getDefaultOptions(),this.initGraphs(e,s,t);let i=new Set(["","ms","0","1","2","3","4","5","6","7","8","9","."].concat(this.graphs.map(a=>a.name)).concat(t.stats?t.stats.map(a=>a.unitsName):[]).filter(a=>!!a));this.wordAtlas=new QR(s,i),this.sizes=t.sizes,this._activeSizeIndex=t.startSizeIndex;let r=document.createElement("div");r.setAttribute("id","mini-stats"),r.style.cssText="position:fixed;bottom:0;left:0;background:transparent;",document.body.appendChild(r),r.addEventListener("mouseenter",a=>{this.opacity=1}),r.addEventListener("mouseleave",a=>{this.opacity=.7}),r.addEventListener("click",a=>{a.preventDefault(),this._enabled&&(this.activeSizeIndex=(this.activeSizeIndex+1)%this.sizes.length,this.resize(this.sizes[this.activeSizeIndex].width,this.sizes[this.activeSizeIndex].height,this.sizes[this.activeSizeIndex].graphs))}),s.on("resizecanvas",this.updateDiv,this),s.on("losecontext",this.loseContext,this),e.on("postrender",this.postRender,this),this.app=e,this.drawLayer=e.scene.layers.getLayerById(pa),this.device=s,this.render2d=new JR(s),this.div=r,this.width=0,this.height=0,this.gspacing=2,this.clr=[1,1,1,.5],this._enabled=!0,this.activeSizeIndex=this._activeSizeIndex}destroy(){this.device.off("resizecanvas",this.updateDiv,this),this.device.off("losecontext",this.loseContext,this),this.app.off("postrender",this.postRender,this),this.graphs.forEach(e=>e.destroy()),this.wordAtlas.destroy(),this.texture.destroy()}static getDefaultOptions(){return{sizes:[{width:100,height:16,spacing:0,graphs:!1},{width:128,height:32,spacing:2,graphs:!0},{width:256,height:64,spacing:2,graphs:!0}],startSizeIndex:0,textRefreshRate:500,cpu:{enabled:!0,watermark:33},gpu:{enabled:!0,watermark:33},stats:[{name:"Frame",stats:["frame.ms"],decimalPlaces:1,unitsName:"ms",watermark:33},{name:"DrawCalls",stats:["drawCalls.total"],watermark:1e3}]}}set activeSizeIndex(e){this._activeSizeIndex=e,this.gspacing=this.sizes[e].spacing,this.resize(this.sizes[e].width,this.sizes[e].height,this.sizes[e].graphs)}get activeSizeIndex(){return this._activeSizeIndex}set opacity(e){this.clr[3]=e}get opacity(){return this.clr[3]}get overallHeight(){let e=this.graphs,t=this.gspacing;return this.height*e.length+t*(e.length-1)}set enabled(e){if(e!==this._enabled){this._enabled=e;for(let t=0;t<this.graphs.length;++t)this.graphs[t].enabled=e,this.graphs[t].timer.enabled=e}}get enabled(){return this._enabled}initGraphs(e,t,s){if(this.graphs=[],s.cpu.enabled){let r=new jR(e),a=new Pg("CPU",e,s.cpu.watermark,s.textRefreshRate,r);this.graphs.push(a)}if(s.gpu.enabled){let r=new $R(t),a=new Pg("GPU",e,s.gpu.watermark,s.textRefreshRate,r);this.graphs.push(a)}s.stats&&s.stats.forEach(r=>{let a=new ZR(e,r.stats,r.decimalPlaces,r.unitsName,r.multiplier),n=new Pg(r.name,e,r.watermark,s.textRefreshRate,a);this.graphs.push(n)});let i=s.sizes.reduce((r,a)=>a.width>r?a.width:r,0);this.texture=new q(t,{name:"mini-stats-graph-texture",width:w.nextPowerOfTwo(i),height:w.nextPowerOfTwo(this.graphs.length),mipmaps:!1,minFilter:0,magFilter:0,addressU:0,addressV:0}),this.graphs.forEach((r,a)=>{r.texture=this.texture,r.yOffset=a})}render(){let e=this.graphs,t=this.wordAtlas,s=this.render2d,i=this.width,r=this.height,a=this.gspacing;s.startFrame();for(let n=0;n<e.length;++n){let l=e[n],h=n*(r+a);l.render(s,0,h,i,r);let c=1;h+=r-13,c+=t.render(s,l.name,c,h)+10;let f=l.timingText;for(let d=0;d<f.length;++d)c+=t.render(s,f[d],c,h);l.timer.unitsName&&(c+=3,t.render(s,l.timer.unitsName,c,h))}s.render(this.app,this.drawLayer,this.texture,this.wordAtlas.texture,this.clr,r)}resize(e,t,s){let i=this.graphs;for(let r=0;r<i.length;++r)i[r].enabled=s;this.width=e,this.height=t,this.updateDiv()}updateDiv(){let e=this.device.canvas.getBoundingClientRect();this.div.style.left=`${e.left}px`,this.div.style.bottom=`${window.innerHeight-e.bottom}px`,this.div.style.width=`${this.width}px`,this.div.style.height=`${this.overallHeight}px`}loseContext(){this.graphs.forEach(e=>e.loseContext())}postRender(){this._enabled&&this.render()}}});var Dhe,Rg,tC,sC,Iee=m(()=>{De();ci();qt();j();ii();Rt();Fe();Ea();zf();lp();ln();It();Dt();Dhe=`
	varying vec2 vUv0;
	uniform vec2 uOffset;
	uniform float uSrcMultiplier;
	uniform sampler2D source;
	void main(void)
	{
		vec4 pixel;
		vec4 texel = texture2D(source, vUv0);
		vec4 firstTexel = texel;
		float diff = texel.a * uSrcMultiplier;
		pixel = texture2D(source, vUv0 + uOffset * -2.0);
		texel = max(texel, pixel);
		diff = max(diff, length(firstTexel.rgb - pixel.rgb));
		pixel = texture2D(source, vUv0 + uOffset * -1.0);
		texel = max(texel, pixel);
		diff = max(diff, length(firstTexel.rgb - pixel.rgb));
		pixel = texture2D(source, vUv0 + uOffset * 1.0);
		texel = max(texel, pixel);
		diff = max(diff, length(firstTexel.rgb - pixel.rgb));
		pixel = texture2D(source, vUv0 + uOffset * 2.0);
		texel = max(texel, pixel);
		diff = max(diff, length(firstTexel.rgb - pixel.rgb));
	   gl_FragColor = vec4(texel.rgb, min(diff, 1.0));
	}
`,Rg=new Float32Array(2),tC=new N,sC=class{constructor(e,t,s=-1){this.app=e,this.renderingLayer=t??e.scene.layers.getLayerByName("Immediate"),this.rt=this.createRenderTarget("OutlineTexture",1,1,!0),this.outlineCameraEntity=new be("OutlineCamera"),this.outlineCameraEntity.addComponent("camera",{layers:[this.renderingLayer.id],priority:s,clearColor:new N(0,0,0,0),renderTarget:this.rt}),this.outlineShaderPass=this.outlineCameraEntity.camera.setShaderPass("OutlineShaderPass"),this.postRender=a=>{this.outlineCameraEntity.camera===a&&this.onPostRender()},e.scene.on("postrender",this.postRender),this.app.root.addChild(this.outlineCameraEntity),this.tempRt=this.createRenderTarget("OutlineTempTexture",1,1,!1),this.blendState=new Ie(!0,0,6,8);let i=this.app.graphicsDevice;this.shaderExtend=Te.createShader(i,{uniqueName:"OutlineExtendShader",attributes:{vertex_position:te},vertexGLSL:ie.get(i,oe).get("fullscreenQuadVS"),fragmentGLSL:Dhe}),this.shaderBlend=Te.createShader(i,{uniqueName:"OutlineBlendShader",attributes:{vertex_position:te},vertexChunk:"fullscreenQuadVS",fragmentChunk:"outputTex2DPS"}),this.quadRenderer=new Oi(this.shaderBlend),this.whiteTex=new q(i,{name:"OutlineWhiteTexture",width:1,height:1,format:20,mipmaps:!1}),this.whiteTex.lock().set(new Uint8Array([255,255,255,255])),this.whiteTex.unlock()}destroy(){this.whiteTex.destroy(),this.whiteTex=null,this.outlineCameraEntity.destroy(),this.outlineCameraEntity=null,this.rt.destroyTextureBuffers(),this.rt.destroy(),this.rt=null,this.tempRt.destroyTextureBuffers(),this.tempRt.destroy(),this.tempRt=null,this.app.scene.off("postrender",this.postRender),this.quadRenderer?.destroy(),this.quadRenderer=null}getMeshInstances(e,t){let s=[];return e&&((t?e.findComponents("render"):e.render?[e.render]:[]).forEach(a=>{a.meshInstances&&s.push(...a.meshInstances)}),(t?e.findComponents("model"):e.model?[e.model]:[]).forEach(a=>{a.meshInstances&&s.push(...a.meshInstances)})),s}addEntity(e,t,s=!0){let i=this.getMeshInstances(e,s);i.forEach(r=>{if(r.material instanceof ct){let a=this.outlineShaderPass;r.material.onUpdateShader=l=>{if(l.pass===a){let h=new lr;return h.defines=l.defines,h.opacityMap=l.opacityMap,h.opacityMapUv=l.opacityMapUv,h.opacityMapChannel=l.opacityMapChannel,h.opacityMapTransform=l.opacityMapTransform,h.opacityVertexColor=l.opacityVertexColor,h.opacityVertexColorChannel=l.opacityVertexColorChannel,h.litOptions.vertexColors=l.litOptions.vertexColors,h.litOptions.alphaTest=l.litOptions.alphaTest,h.litOptions.skin=l.litOptions.skin,h.litOptions.batch=l.litOptions.batch,h.litOptions.useInstancing=l.litOptions.useInstancing,h.litOptions.useMorphPosition=l.litOptions.useMorphPosition,h.litOptions.useMorphNormal=l.litOptions.useMorphNormal,h.litOptions.useMorphTextureBasedInt=l.litOptions.useMorphTextureBasedInt,h.litOptions.opacityFadesSpecular=l.litOptions.opacityFadesSpecular,h}return l},tC.linear(t);let n=new Float32Array([tC.r,tC.g,tC.b]);r.setParameter("material_emissive",n,1<<this.outlineShaderPass),r.setParameter("texture_emissiveMap",this.whiteTex,1<<this.outlineShaderPass)}}),this.renderingLayer.addMeshInstances(i,!0)}removeEntity(e,t=!0){let s=this.getMeshInstances(e,t);this.renderingLayer.removeMeshInstances(s),s.forEach(i=>{i.material instanceof ct&&(i.material.onUpdateShader=null,i.deleteParameter("material_emissive"))})}removeAllEntities(){this.renderingLayer.clearMeshInstances()}blendOutlines(){let e=this.app.graphicsDevice;e.scope.resolve("source").setValue(this.rt.colorBuffer),e.setDepthState($e.NODEPTH),e.setCullMode(0),e.setBlendState(this.blendState),this.quadRenderer.render()}onPostRender(){let e=this.app.graphicsDevice,t=e.scope.resolve("uOffset"),s=e.scope.resolve("source"),i=e.scope.resolve("uSrcMultiplier"),{rt:r,tempRt:a,shaderExtend:n}=this,{width:l,height:h}=r;Rg[0]=1/l/2,Rg[1]=0,t.setValue(Rg),s.setValue(r.colorBuffer),i.setValue(0),Ot(e,a,n),Rg[0]=0,Rg[1]=1/h/2,t.setValue(Rg),s.setValue(a.colorBuffer),i.setValue(1),Ot(e,r,n)}createRenderTarget(e,t,s,i){let r=new q(this.app.graphicsDevice,{name:e,width:t,height:s,format:20,mipmaps:!1,addressU:1,addressV:1,minFilter:5,magFilter:1});return new xe({colorBuffer:r,depth:i,flipY:this.app.graphicsDevice.isWebGPU})}updateRenderTarget(e){let t=e.renderTarget?.width??this.app.graphicsDevice.width,s=e.renderTarget?.height??this.app.graphicsDevice.height,i=this.outlineCameraEntity.camera;(!i.renderTarget||i.renderTarget.width!==t||i.renderTarget.height!==s)&&(this.rt.resize(t,s),this.tempRt.resize(t,s))}frameUpdate(e,t,s){let i=e.camera;this.updateRenderTarget(i);let r=this.app.scene.on("prerender:layer",(n,l,h)=>{i===n&&h===s&&l===t&&(this.blendOutlines(),r.off())});this.outlineCameraEntity.setLocalPosition(e.getPosition()),this.outlineCameraEntity.setLocalRotation(e.getRotation());let a=this.outlineCameraEntity.camera;a.projection=i.projection,a.horizontalFov=i.horizontalFov,a.fov=i.fov,a.orthoHeight=i.orthoHeight,a.nearClip=i.nearClip,a.farClip=i.farClip}}});var Cg,eO=m(()=>{Dt();Fe();qt();Ea();Rt();j();Cg=class{constructor(){}textureToCanvas(e,t={}){let s=e.getSource();if(typeof HTMLImageElement<"u"&&s instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&s instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&s instanceof OffscreenCanvas||typeof ImageBitmap<"u"&&s instanceof ImageBitmap){let{width:f,height:d}=this.calcTextureSize(s.width,s.height,t.maxTextureSize),u=document.createElement("canvas");u.width=f,u.height=d;let p=u.getContext("2d");if(p===null)return Promise.resolve(void 0);if(p.drawImage(s,0,0,u.width,u.height),t.color){let{r:_,g:S,b:T}=t.color,x=p.getImageData(0,0,f,d),A=x.data;for(let E=0;E<A.length;E+=4)A[E+0]=A[E+0]*_,A[E+1]=A[E+1]*S,A[E+2]=A[E+2]*T;p.putImageData(x,0,0)}return Promise.resolve(u)}let i=e.device,{width:r,height:a}=this.calcTextureSize(e.width,e.height,t.maxTextureSize),n=Vo(e.format)?7:e.format,l=new q(i,{name:"ExtractedTexture",width:r,height:a,format:n,cubemap:!1,mipmaps:!1,minFilter:1,magFilter:1,addressU:1,addressV:1}),h=new xe({colorBuffer:l,depth:!1}),c=Te.createShader(i,{uniqueName:"ShaderCoreExporterBlit",attributes:{vertex_position:te},vertexChunk:"fullscreenQuadVS",fragmentChunk:"outputTex2DPS"});return i.scope.resolve("source").setValue(e),i.setBlendState(Ie.NOBLEND),Ot(i,h,c),l.read(0,0,r,a,{renderTarget:h,immediate:!0}).then(f=>{l.destroy(),h.destroy();let d=new Uint8ClampedArray(r*a*4);d.set(f);let u=new ImageData(d,r,a),p=document.createElement("canvas");p.width=r,p.height=a;let _=p.getContext("2d");return _?(_.putImageData(u,0,0),Promise.resolve(p)):Promise.resolve(void 0)})}calcTextureSize(e,t,s){if(s){let i=Math.min(s/Math.max(e,t),1);e=Math.round(e*i),t=Math.round(t*i)}return{width:e,height:t}}}});function Xhe(o,e){return Hhe(o,e||{},0,0)}function iC(o,e){var t;if(Dee)return Dee.encode(o);for(var s=o.length,i=new Ai(o.length+(o.length>>1)),r=0,a=function(h){i[r++]=h},t=0;t<s;++t){if(r+5>i.length){var n=new Ai(r+8+(s-t<<1));n.set(i),i=n}var l=o.charCodeAt(t);l<128||e?a(l):l<2048?(a(192|l>>6),a(128|l&63)):l>55295&&l<57344?(l=65536+(l&1047552)|o.charCodeAt(++t)&1023,a(240|l>>18),a(128|l>>12&63),a(128|l>>6&63),a(128|l&63)):(a(224|l>>12),a(128|l>>6&63),a(128|l&63))}return Bee(i,0,r)}function Hee(o,e){e||(e={});var t={},s=[];zee(o,"",t,e);var i=0,r=0;for(var a in t){var n=t[a],l=n[0],h=n[1],c=h.level==0?0:8,f=iC(a),d=f.length,u=h.comment,p=u&&iC(u),_=p&&p.length,S=aO(h.extra);d>65535&&rC(11);var T=c?Xhe(l,h):l,x=T.length,A=zhe();A.p(l),s.push(Gee(h,{size:l.length,crc:A.d(),c:T,f,m:p,u:d!=a.length||p&&u.length!=_,o:i,compression:c})),i+=30+d+S+x,r+=76+2*(d+S)+(_||0)+x}for(var E=new Ai(r+22),v=i,R=r-i,P=0;P<s.length;++P){var f=s[P];Oee(E,f.o,f,f.f,f.u,f.c.length);var y=30+f.f.length+aO(f.extra);E.set(f.c,f.o+y),Oee(E,i,f,f.f,f.u,f.c.length,f.o,f.m),i+=16+y+(f.m?f.m.length:0)}return Khe(E,i,s.length,R,v),E}var Ai,Br,nO,oO,lO,wee,Nee,Fee,Ohe,sO,Nhe,Lee,iO,Nl,at,kd,Yc,at,at,at,at,fE,at,Fhe,Uhe,Uee,Bee,Bhe,rC,Fl,hE,tO,rO,bee,cE,Vee,Mee,Vhe,kee,khe,Ghe,zhe,Hhe,Gee,di,zee,Dee,Whe,Yhe,aO,Oee,Khe,Xee=m(()=>{Ai=Uint8Array,Br=Uint16Array,nO=Int32Array,oO=new Ai([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),lO=new Ai([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),wee=new Ai([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Nee=function(o,e){for(var t=new Br(31),s=0;s<31;++s)t[s]=e+=1<<o[s-1];for(var i=new nO(t[30]),s=1;s<30;++s)for(var r=t[s];r<t[s+1];++r)i[r]=r-t[s]<<5|s;return{b:t,r:i}},Fee=Nee(oO,2),Ohe=Fee.b,sO=Fee.r;Ohe[28]=258,sO[258]=28;Nhe=Nee(lO,0),Lee=Nhe.r,iO=new Br(32768);for(at=0;at<32768;++at)Nl=(at&43690)>>1|(at&21845)<<1,Nl=(Nl&52428)>>2|(Nl&13107)<<2,Nl=(Nl&61680)>>4|(Nl&3855)<<4,iO[at]=((Nl&65280)>>8|(Nl&255)<<8)>>1;kd=function(o,e,t){for(var s=o.length,i=0,r=new Br(e);i<s;++i)o[i]&&++r[o[i]-1];var a=new Br(e);for(i=1;i<e;++i)a[i]=a[i-1]+r[i-1]<<1;var n;if(t){n=new Br(1<<e);var l=15-e;for(i=0;i<s;++i)if(o[i])for(var h=i<<4|o[i],c=e-o[i],f=a[o[i]-1]++<<c,d=f|(1<<c)-1;f<=d;++f)n[iO[f]>>l]=h}else for(n=new Br(s),i=0;i<s;++i)o[i]&&(n[i]=iO[a[o[i]-1]++]>>15-o[i]);return n},Yc=new Ai(288);for(at=0;at<144;++at)Yc[at]=8;for(at=144;at<256;++at)Yc[at]=9;for(at=256;at<280;++at)Yc[at]=7;for(at=280;at<288;++at)Yc[at]=8;fE=new Ai(32);for(at=0;at<32;++at)fE[at]=5;Fhe=kd(Yc,9,0);kd(Yc,9,1);Uhe=kd(fE,5,0);kd(fE,5,1);Uee=function(o){return(o+7)/8|0},Bee=function(o,e,t){return(t==null||t>o.length)&&(t=o.length),new Ai(o.subarray(e,t))},Bhe=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],rC=function(o,e,t){var s=new Error(e||Bhe[o]);if(s.code=o,Error.captureStackTrace&&Error.captureStackTrace(s,rC),!t)throw s;return s},Fl=function(o,e,t){t<<=e&7;var s=e/8|0;o[s]|=t,o[s+1]|=t>>8},hE=function(o,e,t){t<<=e&7;var s=e/8|0;o[s]|=t,o[s+1]|=t>>8,o[s+2]|=t>>16},tO=function(o,e){for(var t=[],s=0;s<o.length;++s)o[s]&&t.push({s,f:o[s]});var i=t.length,r=t.slice();if(!i)return{t:kee,l:0};if(i==1){var a=new Ai(t[0].s+1);return a[t[0].s]=1,{t:a,l:1}}t.sort(function(v,R){return v.f-R.f}),t.push({s:-1,f:25001});var n=t[0],l=t[1],h=0,c=1,f=2;for(t[0]={s:-1,f:n.f+l.f,l:n,r:l};c!=i-1;)n=t[t[h].f<t[f].f?h++:f++],l=t[h!=c&&t[h].f<t[f].f?h++:f++],t[c++]={s:-1,f:n.f+l.f,l:n,r:l};for(var d=r[0].s,s=1;s<i;++s)r[s].s>d&&(d=r[s].s);var u=new Br(d+1),p=rO(t[c-1],u,0);if(p>e){var s=0,_=0,S=p-e,T=1<<S;for(r.sort(function(R,P){return u[P.s]-u[R.s]||R.f-P.f});s<i;++s){var x=r[s].s;if(u[x]>e)_+=T-(1<<p-u[x]),u[x]=e;else break}for(_>>=S;_>0;){var A=r[s].s;u[A]<e?_-=1<<e-u[A]++-1:++s}for(;s>=0&&_;--s){var E=r[s].s;u[E]==e&&(--u[E],++_)}p=e}return{t:new Ai(u),l:p}},rO=function(o,e,t){return o.s==-1?Math.max(rO(o.l,e,t+1),rO(o.r,e,t+1)):e[o.s]=t},bee=function(o){for(var e=o.length;e&&!o[--e];);for(var t=new Br(++e),s=0,i=o[0],r=1,a=function(l){t[s++]=l},n=1;n<=e;++n)if(o[n]==i&&n!=e)++r;else{if(!i&&r>2){for(;r>138;r-=138)a(32754);r>2&&(a(r>10?r-11<<5|28690:r-3<<5|12305),r=0)}else if(r>3){for(a(i),--r;r>6;r-=6)a(8304);r>2&&(a(r-3<<5|8208),r=0)}for(;r--;)a(i);r=1,i=o[n]}return{c:t.subarray(0,s),n:e}},cE=function(o,e){for(var t=0,s=0;s<e.length;++s)t+=o[s]*e[s];return t},Vee=function(o,e,t){var s=t.length,i=Uee(e+2);o[i]=s&255,o[i+1]=s>>8,o[i+2]=o[i]^255,o[i+3]=o[i+1]^255;for(var r=0;r<s;++r)o[i+r+4]=t[r];return(i+4+s)*8},Mee=function(o,e,t,s,i,r,a,n,l,h,c){Fl(e,c++,t),++i[256];for(var f=tO(i,15),d=f.t,u=f.l,p=tO(r,15),_=p.t,S=p.l,T=bee(d),x=T.c,A=T.n,E=bee(_),v=E.c,R=E.n,P=new Br(19),y=0;y<x.length;++y)++P[x[y]&31];for(var y=0;y<v.length;++y)++P[v[y]&31];for(var C=tO(P,7),L=C.t,O=C.l,M=19;M>4&&!L[wee[M-1]];--M);var U=h+5<<3,G=cE(i,Yc)+cE(r,fE)+a,$=cE(i,d)+cE(r,_)+a+14+3*M+cE(P,L)+2*P[16]+3*P[17]+7*P[18];if(l>=0&&U<=G&&U<=$)return Vee(e,c,o.subarray(l,l+h));var X,I,b,F;if(Fl(e,c,1+($<G)),c+=2,$<G){X=kd(d,u,0),I=d,b=kd(_,S,0),F=_;var B=kd(L,O,0);Fl(e,c,A-257),Fl(e,c+5,R-1),Fl(e,c+10,M-4),c+=14;for(var y=0;y<M;++y)Fl(e,c+3*y,L[wee[y]]);c+=3*M;for(var V=[x,v],z=0;z<2;++z)for(var ee=V[z],y=0;y<ee.length;++y){var se=ee[y]&31;Fl(e,c,B[se]),c+=L[se],se>15&&(Fl(e,c,ee[y]>>5&127),c+=ee[y]>>12)}}else X=Fhe,I=Yc,b=Uhe,F=fE;for(var y=0;y<n;++y){var Y=s[y];if(Y>255){var se=Y>>18&31;hE(e,c,X[se+257]),c+=I[se+257],se>7&&(Fl(e,c,Y>>23&31),c+=oO[se]);var ne=Y&31;hE(e,c,b[ne]),c+=F[ne],ne>3&&(hE(e,c,Y>>5&8191),c+=lO[ne])}else hE(e,c,X[Y]),c+=I[Y]}return hE(e,c,X[256]),c+I[256]},Vhe=new nO([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),kee=new Ai(0),khe=function(o,e,t,s,i,r){var a=r.z||o.length,n=new Ai(s+a+5*(1+Math.ceil(a/7e3))+i),l=n.subarray(s,n.length-i),h=r.l,c=(r.r||0)&7;if(e){c&&(l[0]=r.r>>3);for(var f=Vhe[e-1],d=f>>13,u=f&8191,p=(1<<t)-1,_=r.p||new Br(32768),S=r.h||new Br(p+1),T=Math.ceil(t/3),x=2*T,A=function(eu){return(o[eu]^o[eu+1]<<T^o[eu+2]<<x)&p},E=new nO(25e3),v=new Br(288),R=new Br(32),P=0,y=0,C=r.i||0,L=0,O=r.w||0,M=0;C+2<a;++C){var U=A(C),G=C&32767,$=S[U];if(_[G]=$,S[U]=G,O<=C){var X=a-C;if((P>7e3||L>24576)&&(X>423||!h)){c=Mee(o,l,0,E,v,R,y,L,M,C-M,c),L=P=y=0,M=C;for(var I=0;I<286;++I)v[I]=0;for(var I=0;I<30;++I)R[I]=0}var b=2,F=0,B=u,V=G-$&32767;if(X>2&&U==A(C-V))for(var z=Math.min(d,X)-1,ee=Math.min(32767,C),se=Math.min(258,X);V<=ee&&--B&&G!=$;){if(o[C+b]==o[C+b-V]){for(var Y=0;Y<se&&o[C+Y]==o[C+Y-V];++Y);if(Y>b){if(b=Y,F=V,Y>z)break;for(var ne=Math.min(V,Y-2),ce=0,I=0;I<ne;++I){var ze=C-V+I&32767,Bt=_[ze],Lt=ze-Bt&32767;Lt>ce&&(ce=Lt,$=ze)}}}G=$,$=_[G],V+=G-$&32767}if(F){E[L++]=268435456|sO[b]<<18|Lee[F];var Kt=sO[b]&31,Va=Lee[F]&31;y+=oO[Kt]+lO[Va],++v[257+Kt],++R[Va],O=C+b,++P}else E[L++]=o[C],++v[o[C]]}}for(C=Math.max(C,O);C<a;++C)E[L++]=o[C],++v[o[C]];c=Mee(o,l,h,E,v,R,y,L,M,C-M,c),h||(r.r=c&7|l[c/8|0]<<3,c-=7,r.h=S,r.p=_,r.i=C,r.w=O)}else{for(var C=r.w||0;C<a+h;C+=65535){var vn=C+65535;vn>=a&&(l[c/8|0]=h,vn=a),c=Vee(l,c+1,o.subarray(C,vn))}r.i=a}return Bee(n,0,s+Uee(c)+i)},Ghe=function(){for(var o=new Int32Array(256),e=0;e<256;++e){for(var t=e,s=9;--s;)t=(t&1&&-306674912)^t>>>1;o[e]=t}return o}(),zhe=function(){var o=-1;return{p:function(e){for(var t=o,s=0;s<e.length;++s)t=Ghe[t&255^e[s]]^t>>>8;o=t},d:function(){return~o}}},Hhe=function(o,e,t,s,i){if(!i&&(i={l:1},e.dictionary)){var r=e.dictionary.subarray(-32768),a=new Ai(r.length+o.length);a.set(r),a.set(o,r.length),o=a,i.w=r.length}return khe(o,e.level==null?6:e.level,e.mem==null?i.l?Math.ceil(Math.max(8,Math.min(13,Math.log(o.length)))*1.5):20:12+e.mem,t,s,i)},Gee=function(o,e){var t={};for(var s in o)t[s]=o[s];for(var s in e)t[s]=e[s];return t},di=function(o,e,t){for(;t;++e)o[e]=t,t>>>=8};zee=function(o,e,t,s){for(var i in o){var r=o[i],a=e+i,n=s;Array.isArray(r)&&(n=Gee(s,r[1]),r=r[0]),r instanceof Ai?t[a]=[r,n]:(t[a+="/"]=[new Ai(0),n],zee(r,a,t,s))}},Dee=typeof TextEncoder<"u"&&new TextEncoder,Whe=typeof TextDecoder<"u"&&new TextDecoder,Yhe=0;try{Whe.decode(kee,{stream:!0}),Yhe=1}catch{}aO=function(o){var e=0;if(o)for(var t in o){var s=o[t].length;s>65535&&rC(9),e+=s+4}return e},Oee=function(o,e,t,s,i,r,a,n){var l=s.length,h=t.extra,c=n&&n.length,f=aO(h);di(o,e,a!=null?33639248:67324752),e+=4,a!=null&&(o[e++]=20,o[e++]=t.os),o[e]=20,e+=2,o[e++]=t.flag<<1|(r<0&&8),o[e++]=i&&8,o[e++]=t.compression&255,o[e++]=t.compression>>8;var d=new Date(t.mtime==null?Date.now():t.mtime),u=d.getFullYear()-1980;if((u<0||u>119)&&rC(10),di(o,e,u<<25|d.getMonth()+1<<21|d.getDate()<<16|d.getHours()<<11|d.getMinutes()<<5|d.getSeconds()>>1),e+=4,r!=-1&&(di(o,e,t.crc),di(o,e+4,r<0?-r-2:r),di(o,e+8,t.size)),di(o,e+12,l),di(o,e+14,f),e+=16,a!=null&&(di(o,e,c),di(o,e+6,t.attrs),di(o,e+10,a),e+=14),o.set(s,e),e+=l,f)for(var p in h){var _=h[p],S=_.length;di(o,e,+p),di(o,e+2,S),o.set(_,e+4),e+=4+S}return c&&(o.set(n,e),e+=c),e},Khe=function(o,e,t,s,i){di(o,e,101010256),di(o,e+8,t),di(o,e+10,t),di(o,e+12,s),di(o,e+16,i)}});var Wee,qhe,jhe,$he,Zhe,Yee,aC,Kee=m(()=>{eO();Xee();De();j();Wee="root",qhe=`#usda 1.0
(
		customLayerData = {
				string creator = "PlayCanvas UsdzExporter"
		}
		metersPerUnit = 1
		upAxis = "Y"
)
`,jhe=o=>`
def "Materials"
{
		${o.join(`
`)}
}
`,$he=(o,e,t,s,i,r)=>`
def "Mesh"
{
		def Mesh "Mesh"
		{
				int[] faceVertexCounts = [${o}]
				int[] faceVertexIndices = [${e}]
				normal3f[] normals = [${t}] (
						interpolation = "vertex"
				)
				point3f[] points = [${s}]
				texCoord2f[] primvars:st = [${i}] (
						interpolation = "vertex"
				)
				texCoord2f[] primvars:st1 = [${r}] (
						interpolation = "vertex"
				)
				uniform token subdivisionScheme = "none"
		}
}
`,Zhe=(o,e,t,s)=>`
def Xform "${o}" (
		prepend references = ${e}
)
{
		matrix4d xformOp:transform = ${t}
		uniform token[] xformOpOrder = ["xformOp:transform"]

		rel material:binding = ${s}
}
`,Yee=(o,e,t)=>`                    ${o} inputs:${e} = ${t}`,aC=class extends Cg{init(){this.meshMap=new Map,this.textureMap=new Map,this.materialMap=new Map,this.materials=[],this.files={},this.nodeNames=new Set}done(){this.meshMap=null,this.textureMap=null,this.materialMap=null,this.materials=null,this.files=null,this.nodeNames=null}build(e,t={}){this.init(),this.addFile(null,Wee);let s=[];e&&e.findComponents("render").forEach(c=>{s.push(...c.meshInstances)});let i="";s.forEach(h=>{i+=this.buildMeshInstance(h)}),i+=jhe(this.materials),this.addFile(null,Wee,"",i);let r={maxTextureSize:t.maxTextureSize},a=Array.from(this.textureMap.keys()),n=[];for(let h=0;h<a.length;h++){let c="image/png",f=a[h],d=this.textureToCanvas(f,r).then(u=>u?new Promise(p=>u.toBlob(p,c,1)).then(p=>p.arrayBuffer()):(console.warn(`Export of texture ${f.name} is not currently supported.`),new Promise(p=>p(null))));n.push(d)}return Promise.all(n).then(h=>{h.forEach((f,d)=>{let u=a[d],p=this.getTextureFileIds(u);this.files[p.fileName]=new Uint8Array(f)}),this.alignFiles();let c=Hee(this.files,{level:0});return this.done(),c})}alignFiles(){let e=0;for(let t in this.files){let s=this.files[t],i=34+t.length;e+=i;let r=e&63;if(r!==4){let a=64-r,n=new Uint8Array(a);this.files[t]=[s,{extra:{12345:n}}]}e=s.length}}getFileIds(e,t,s,i="usda"){let r=`${e?`${e}/`:""}${t}.${i}`,a=`@./${r}@</${s}>`;return{name:t,fileName:r,refName:a}}getTextureFileIds(e){return this.getFileIds("texture",`Texture_${e.id}`,"Texture","png")}addFile(e,t,s="",i=""){let r=null;i&&(i=`${qhe}
${i}`,r=iC(i));let a=this.getFileIds(e,t,s);return this.files[a.fileName]=r,a.refName}getMaterialRef(e){let t=this.materialMap.get(e);return t||(t=this.buildMaterial(e),this.materialMap.set(e,t)),t}getMeshRef(e){let t=this.meshMap.get(e);return t||(t=this.buildMesh(e),this.meshMap.set(e,t)),t}buildArray2(e){let t=[],s=e.length;for(let i=0;i<s;i+=2)t.push(`(${e[i]}, ${1-e[i+1]})`);return t.join(", ")}buildArray3(e){let t=[],s=e.length;for(let i=0;i<s;i+=3)t.push(`(${e[i]}, ${e[i+1]}, ${e[i+2]})`);return t.join(", ")}buildMat4(e){let t=e.data,s=[];for(let i=0;i<16;i+=4)s.push(`(${t[i]}, ${t[i+1]}, ${t[i+2]}, ${t[i+3]})`);return`( ${s.join(", ")} )`}buildMaterial(e){let t=`Material_${e.id}`,s=`/Materials/${t}`,i=c=>`<${s}${c}>`,r=(c,f,d,u,p,_,S,T)=>`
								def Shader "Transform2d_${d}" (
										sdrMetadata = {
												string role = "math"
										}
								)
								{
										uniform token info:id = "UsdTransform2d"
										float2 inputs:in.connect = ${i(`/uvReader_${u}.outputs:result`)}
										float inputs:rotation = ${S}
										float2 inputs:scale = (${p.x}, ${p.y})
										float2 inputs:translation = (${_.x}, ${_.y})
										float2 outputs:result
								}

								def Shader "Texture_${c.id}_${d}"
								{
										uniform token info:id = "UsdUVTexture"
										asset inputs:file = @${f.fileName}@
										float2 inputs:st.connect = ${i(`/Transform2d_${d}.outputs:result`)}
										token inputs:wrapS = "repeat"
										token inputs:wrapT = "repeat"
										float4 inputs:scale = (${T.r}, ${T.g}, ${T.b}, ${T.a})
										float outputs:r
										float outputs:g
										float outputs:b
										float3 outputs:rgb
										float outputs:a
								}
						`,a=[],n=[],l=(c,f,d,u,p,_=!1,S=!1)=>{let T=e[c];if(T){let x=this.getTextureFileIds(T);this.textureMap.set(T,x.refName);let A=e[`${c}Channel`]||"rgb",E=i(`/${x.name}_${p}.outputs:${A}`);a.push(Yee(d,`${u}.connect`,E)),_&&e.alphaTest>0;let v=e[`${c}Tiling`],R=e[`${c}Offset`],P=e[`${c}Rotation`],y=e[`${c}Uv`]===1?"st1":"st",C=S&&f?f:N.WHITE;n.push(r(T,x,p,y,v,R,P,C))}else if(f){let x=d==="float"?`${f}`:`(${f.r}, ${f.g}, ${f.b})`;a.push(Yee(d,u,x))}};l("diffuseMap",e.diffuse,"color3f","diffuseColor","diffuse",!1,!0),(e.transparent||e.alphaTest>0)&&l("opacityMap",e.opacity,"float","opacity","opacity",!0),l("normalMap",null,"normal3f","normal","normal"),l("emissiveMap",e.emissive,"color3f","emissiveColor","emissive",!1,!0),l("aoMap",null,"float","occlusion","occlusion"),l("metalnessMap",e.metalness,"float","metallic","metallic"),l("glossMap",e.gloss,"float","roughness","roughness");let h=`
						def Material "${t}"
						{
								def Shader "PreviewSurface"
								{
										uniform token info:id = "UsdPreviewSurface"
${a.join(`
`)}
										int inputs:useSpecularWorkflow = 0
										token outputs:surface
								}

								token outputs:surface.connect = ${i("/PreviewSurface.outputs:surface")}

								def Shader "uvReader_st"
								{
										uniform token info:id = "UsdPrimvarReader_float2"
										token inputs:varname = "st"
										float2 inputs:fallback = (0.0, 0.0)
										float2 outputs:result
								}

								def Shader "uvReader_st1"
								{
										uniform token info:id = "UsdPrimvarReader_float2"
										token inputs:varname = "st1"
										float2 inputs:fallback = (0.0, 0.0)
										float2 outputs:result
								}

								${n.join(`
`)}
						}
				`;return this.materials.push(h),i("")}buildMesh(e){let t=[],s=[],i=[],r=[],a=[];e.getVertexStream(te,t),e.getVertexStream(Pt,i),e.getVertexStream(ot,r),e.getVertexStream(ks,a),e.getIndices(s);let n=s.length||t.length,l=Array(n/3).fill(3).join(", ");if(!s.length)for(let d=0;d<n;d++)s[d]=d;let h=t.length/3;i=i.length?i:Array(h*3).fill(0),r=r.length?r:Array(h*2).fill(0),a=a.length?a:Array(h*2).fill(0),t=this.buildArray3(t),i=this.buildArray3(i),r=this.buildArray2(r),a=this.buildArray2(a);let c=$he(l,s,i,t,r,a);return this.addFile("mesh",`Mesh_${e.id}`,"Mesh",c)}buildMeshInstance(e){let t=this.getMeshRef(e.mesh),s=this.getMaterialRef(e.material),i=this.buildMat4(e.node.getWorldTransform()),r=e.node.name.replace(/[^a-z0-9]/gi,"_"),a=r;for(;this.nodeNames.has(a);)a=`${r}_${Math.random().toString(36).slice(2,7)}`;return this.nodeNames.add(a),Zhe(a,t,i,s)}}});function tce(o){let t=o.getContext("2d").getImageData(0,0,o.width,o.height).data;for(let s=3;s<t.length;s+=4)if(t[s]<255)return!0;return!1}var hO,qee,Qhe,jee,Jhe,ece,$ee,Zee,Qee,nC,Jee=m(()=>{eO();me();Ne();Q();Ve();De();Vt();j();vh();$i();ln();J();hO=34962,qee=34963,Qhe=o=>{switch(o){case 0:return 5121;case 1:return 5123;case 2:return 5125}return 0},jee=o=>{switch(o){case Ps:return 5120;case zs:return 5121;case Rs:return 5122;case mi:return 5123;case ke:return 5124;case gt:return 5125;case pe:return 5126}return 0},Jhe=o=>{switch(o){case 1:return"SCALAR";case 2:return"VEC2";case 3:return"VEC3";case 4:return"VEC4"}return 0},ece=o=>{switch(o){case te:return"POSITION";case Pt:return"NORMAL";case as:return"TANGENT";case nt:return"COLOR_0";case Gt:return"JOINTS_0";case hs:return"WEIGHTS_0";case ot:return"TEXCOORD_0";case ks:return"TEXCOORD_1";case jr:return"TEXCOORD_2";case $r:return"TEXCOORD_3";case Zr:return"TEXCOORD_4";case Qr:return"TEXCOORD_5";case Jr:return"TEXCOORD_6";case ea:return"TEXCOORD_7"}return""},$ee=function(o){switch(o){case 0:return 9728;case 1:return 9729;case 2:return 9984;case 4:return 9985;case 3:return 9986;case 5:return 9987}return 0},Zee=function(o){switch(o){case 1:return 33071;case 2:return 33648;case 0:return 10497}return 0};Qee=["diffuseMap","colorMap","normalMap","metalnessMap","emissiveMap"],nC=class o extends Cg{collectResources(e){let t={buffers:[],cameras:[],entities:[],materials:[],skins:[],textures:[],entityMeshInstances:[],bufferViewMap:new Map,compressableTexture:new Set},{materials:s,buffers:i,entityMeshInstances:r,textures:a}=t;e.forEach(l=>{t.entities.push(l)});let n=l=>{l.forEach(h=>{let c=h.material;s.indexOf(c)<0&&(t.materials.push(c),Qee.forEach(S=>{let T=c[S];T&&a.indexOf(T)<0&&(S!=="normalMap"&&t.compressableTexture.add(T),a.push(T))}));let f=h.node,d=r.find(S=>S.node===f);d||(d={node:f,meshInstances:[]},r.push(d)),d.meshInstances.push(h);let u=h.mesh,p=u.vertexBuffer;i.indexOf(p)<0&&i.unshift(p);let _=u.indexBuffer[0];i.indexOf(_)<0&&i.push(_),u.skin&&t.skins.indexOf(u.skin)<0&&t.skins.push(u.skin)})};return t.entities.forEach(l=>{l.camera&&t.cameras.push(l.camera),l.render&&l.render.enabled&&n(l.render.meshInstances),l.model&&l.model.enabled&&l.model.meshInstances&&n(l.model.meshInstances)}),t}writeBufferViews(e,t){t.bufferViews=[];for(let s of e.buffers)o.writeBufferView(e,t,s)}static writeBufferView(e,t,s){t.buffers=t.buffers??[],t.buffers[0]=t.buffers[0]??{byteLength:0};let i=t.buffers[0];i.byteLength=w.roundUp(i.byteLength,4);let r=i.byteLength,a=(l,h,c,f)=>{let d={buffer:0,byteLength:h,byteOffset:c};return(l===hO||l===qee)&&(d.target=l),f!==void 0&&(d.byteStride=f),t.bufferViews.push(d)-1},n;if(s instanceof mt){n=s.lock();let l=s.getFormat();if(l.interleaved){let h=a(hO,n.byteLength,r,l.size);e.bufferViewMap.set(s,[h])}else{let h=[];for(let c of l.elements){let f=a(hO,c.size*l.vertexCount,r+c.offset,c.size);h.push(f)}e.bufferViewMap.set(s,h)}}else if(s instanceof Ls){n=s.lock();let l=a(qee,n.byteLength,r);e.bufferViewMap.set(s,[l])}else{n=s;let l=a(void 0,n.byteLength,r);e.bufferViewMap.set(s,[l])}i.byteLength+=n.byteLength}writeCameras(e,t){e.cameras.length>0&&(t.cameras=e.cameras.map(s=>{let i=s.projection,r=s.nearClip,a=s.farClip,n={};if(i===Xs)n.type="orthographic",n.orthographic={xmag:1,ymag:1,znear:r,zfar:a};else{let l=s.fov;n.type="perspective",n.perspective={yfov:l*Math.PI/180,znear:r,zfar:a}}return n}))}attachTexture(e,t,s,i,r,a){let n=t[r];if(n){let l=e.textures.indexOf(n);l<0&&console.warn(`Texture ${n.name} wasn't collected.`),s[i]={index:l};let h=t[`${r}Tiling`],c=t[`${r}Offset`],f=t[`${r}Rotation`];(h&&!h.equals(D.ONE)||c&&!c.equals(D.ZERO)||f!==0)&&(s[i].extensions={KHR_texture_transform:{}},a.extensionsUsed=a.extensionsUsed??[],a.extensionsUsed.indexOf("KHR_texture_transform")<0&&a.extensionsUsed.push("KHR_texture_transform"),a.extensionsRequired=a.extensionsRequired??[],a.extensionsRequired.indexOf("KHR_texture_transform")<0&&a.extensionsRequired.push("KHR_texture_transform"),h&&!h.equals(D.ONE)&&(s[i].extensions.KHR_texture_transform.scale=[h.x,h.y]),c&&!c.equals(D.ZERO)&&(s[i].extensions.KHR_texture_transform.offset=[c.x,c.y-1+h.y]),f!==0&&(s[i].extensions.KHR_texture_transform.rotation=f*w.DEG_TO_RAD))}}writeStandardMaterial(e,t,s,i){let{diffuse:r,emissive:a,opacity:n,metalness:l,gloss:h,glossInvert:c}=t,f=s.pbrMetallicRoughness;(!r.equals(N.WHITE)||n!==1)&&(f.baseColorFactor=[r.r,r.g,r.b,n]),l!==1&&(f.metallicFactor=l);let d=c?h:1-h;d!==1&&(f.roughnessFactor=d),this.attachTexture(e,t,f,"baseColorTexture","diffuseMap",i),this.attachTexture(e,t,f,"metallicRoughnessTexture","metalnessMap",i),a.equals(N.BLACK)||(s.emissiveFactor=[a.r,a.g,a.b])}writeMaterials(e,t){e.materials.length>0&&(t.materials=e.materials.map(s=>{let{name:i,blendType:r,cull:a,alphaTest:n}=s,l={pbrMetallicRoughness:{}};return i&&i.length>0&&(l.name=i),s instanceof ct&&this.writeStandardMaterial(e,s,l,t),r===es?l.alphaMode="BLEND":r===$t&&n!==0&&(l.alphaMode="MASK",l.alphaCutoff=n),a===0&&(l.doubleSided=!0),this.attachTexture(e,s,l,"normalTexture","normalMap",t),this.attachTexture(e,s,l,"occlusionTexture","aoMap",t),this.attachTexture(e,s,l,"emissiveTexture","emissiveMap",t),l}))}writeNodes(e,t){e.entities.length>0&&(t.nodes=e.entities.map(s=>{let i=s.name,r=s.getLocalPosition(),a=s.getLocalRotation(),n=s.getLocalScale(),l={};i&&i.length>0&&(l.name=i),r.equals(g.ZERO)||(l.translation=[r.x,r.y,r.z]),a.equals(H.IDENTITY)||(l.rotation=[a.x,a.y,a.z,a.w]),n.equals(g.ONE)||(l.scale=[n.x,n.y,n.z]),s.camera&&s.camera.enabled&&(l.camera=e.cameras.indexOf(s.camera));let h=e.entityMeshInstances.find(c=>c.node===s);if(h){l.mesh=e.entityMeshInstances.indexOf(h);let c=h.meshInstances[0];c&&c.mesh.skin&&(l.skin=e.skins.indexOf(c.mesh.skin))}return s.children.length>0&&(l.children=[],s.children.forEach(c=>{l.children.push(e.entities.indexOf(c))})),l}))}writeMeshes(e,t,s){e.entityMeshInstances.length>0&&(t.accessors=[],t.meshes=[],e.entityMeshInstances.forEach(i=>{let r={primitives:[]};i.meshInstances.forEach(n=>{let l=o.createPrimitive(e,t,n.mesh,s);l.material=e.materials.indexOf(n.material),r.primitives.push(l)}),t.meshes.push(r)}))}static createPrimitive(e,t,s,i={}){let r={attributes:{}},{vertexBuffer:a}=s,{format:n}=a,{interleaved:l,elements:h}=n,c=a.getNumVertices();h.forEach((d,u)=>{let p=ece(d.name);if(i.stripUnusedAttributes){let A=!0;if(p.startsWith("TEXCOORD_")){let E=parseInt(p.split("_")[1],10);A=e.materials.some(v=>Qee.some(R=>v[R]&&(E===0||v[`${R}Tiling`]?.uv===E)))}if(p==="COLOR_0"&&(A=e.materials.some(E=>E.vertexColors)),p==="TANGENT"&&(A=e.materials.some(E=>E.normalMap)),(p==="JOINTS_0"||p==="WEIGHTS_0")&&(A=e.entityMeshInstances.some(E=>E.meshInstances.some(v=>v.mesh.skin))),!A)return}let _=e.bufferViewMap.get(a);_||(o.writeBufferView(e,t,a),e.buffers.push(a),_=e.bufferViewMap.get(a));let T={bufferView:_[l?0:u],byteOffset:l?d.offset:0,componentType:jee(d.dataType),type:Jhe(d.numComponents),count:c},x=t.accessors.push(T)-1;if(r.attributes[p]=x,d.name===te){let A=[];s.getPositions(A);let E=new g,v=new g;_e.computeMinMax(A,E,v),T.min=[E.x,E.y,E.z],T.max=[v.x,v.y,v.z]}});let f=s.indexBuffer[0];if(f){let d=e.bufferViewMap.get(f);d||(o.writeBufferView(e,t,f),e.buffers.push(f),d=e.bufferViewMap.get(f));let p={bufferView:d[0],componentType:Qhe(f.getFormat()),count:f.getNumIndices(),type:"SCALAR"},_=t.accessors.push(p)-1;r.indices=_}return r}writeSkins(e,t){e.skins.length>0&&(t.skins=e.skins.map(s=>{let i=new Float32Array(s.inverseBindPose.length*16);for(let c=0;c<s.inverseBindPose.length;c++){let f=s.inverseBindPose[c];i.set(f.data,c*16)}let r=i.buffer;o.writeBufferView(e,t,r),e.buffers.push(r);let n={bufferView:e.bufferViewMap.get(r)[0],componentType:jee(pe),count:s.inverseBindPose.length,type:"MAT4"},l=t.accessors.push(n)-1,h=s.boneNames.map(c=>{let f=e.entities.find(d=>d.name===c);return e.entities.indexOf(f)});return{inverseBindMatrices:l,joints:h}}))}convertTextures(e,t){let s={maxTextureSize:t.maxTextureSize},i=[];return e.forEach(r=>{let a=this.textureToCanvas(r,s);a.then(n=>new Promise(l=>l(n))),i.push(a)}),i}writeTextures(e,t,s,i){let r=e.textures,a=[];for(let n=0;n<t.length;n++){let l=r[n],h=t[n],f=tce(h)||!e.compressableTexture.has(l)?"image/png":"image/jpeg";a.push(this.getBlob(h,f).then(d=>{let u=new FileReader;return u.readAsArrayBuffer(d),new Promise(p=>{u.onloadend=()=>{p(u)}})}).then(d=>{let u=this.getPaddedArrayBuffer(d.result);o.writeBufferView(e,s,u),e.buffers.push(u);let p=e.bufferViewMap.get(u);s.images[n]={mimeType:f,bufferView:p[0]},s.samplers[n]={minFilter:$ee(l.minFilter),magFilter:$ee(l.magFilter),wrapS:Zee(l.addressU),wrapT:Zee(l.addressV)},s.textures[n]={sampler:n,source:n}}))}return Promise.all(a)}getBlob(e,t){if(e.toBlob!==void 0)return new Promise(i=>{e.toBlob(i,t)});let s=1;return t==="image/jpeg"&&(s=.92),e.convertToBlob({type:t,quality:s})}getPaddedArrayBuffer(e,t=0){let s=w.roundUp(e.byteLength,4);if(s!==e.byteLength){let i=new Uint8Array(s);if(i.set(new Uint8Array(e)),t!==0)for(let r=e.byteLength;r<s;r++)i[r]=t;return i.buffer}return e}buildJson(e,t){let s=this.convertTextures(e.textures,t);return Promise.all(s).then(async i=>{let r={asset:{version:"2.0",generator:"PlayCanvas GltfExporter"},scenes:[{nodes:[0]}],images:[],samplers:[],textures:[],scene:0};return this.writeBufferViews(e,r),this.writeCameras(e,r),this.writeMeshes(e,r,t),this.writeMaterials(e,r),this.writeNodes(e,r,t),this.writeSkins(e,r),await this.writeTextures(e,i,r,t),r.images.length||delete r.images,r.samplers.length||delete r.samplers,r.textures.length||delete r.textures,r})}build(e,t={}){let s=this.collectResources(e);return this.buildJson(s,t).then(i=>{let a=new TextEncoder().encode(JSON.stringify(i)),n=12,l=8,h=a.length,c=4-(h&3)&3,f=8,d=i.buffers.reduce((T,x)=>w.roundUp(T+x.byteLength,4),0),u=n+l+h+c;d>0&&(u+=f+d);let p=new ArrayBuffer(u),_=new DataView(p);_.setUint32(0,1179937895,!0),_.setUint32(4,2,!0),_.setUint32(8,u,!0),_.setUint32(12,h+c,!0),_.setUint32(16,1313821514,!0);let S=n+l;new Uint8Array(p,S,h).set(a),S+=h;for(let T=0;T<c;T++)_.setUint8(S+T,32);return S+=c,d>0&&(_.setUint32(S,d,!0),_.setUint32(S+4,5130562,!0),S+=f,s.buffers.forEach(T=>{let x,A=s.bufferViewMap.get(T)[0],E=i.bufferViews[A].byteOffset;if(T instanceof ArrayBuffer)x=new Uint8Array(T);else{let R=T.lock();R instanceof ArrayBuffer?x=new Uint8Array(R):x=new Uint8Array(R.buffer,R.byteOffset,R.byteLength)}new Uint8Array(p,S+E,x.byteLength).set(x)})),Promise.resolve(p)})}}});var Io,oC,lC,hC=m(()=>{Io="none",oC="lighting",lC="combine"});var ete,tte=m(()=>{ete=`
uniform sampler2D sourceTexture;
uniform vec2 sourceInvResolution;
varying vec2 uv0;
#ifdef PREMULTIPLY
	uniform sampler2D premultiplyTexture;
#endif
void main()
{
	vec3 e = texture2D (sourceTexture, uv0).rgb;
	#ifdef BOXFILTER
		vec3 value = e;
		#ifdef PREMULTIPLY
			float premultiply = texture2D(premultiplyTexture, uv0).{PREMULTIPLY_SRC_CHANNEL};
			value *= vec3(premultiply);
		#endif
	#else
		float x = sourceInvResolution.x;
		float y = sourceInvResolution.y;
		vec3 a = texture2D(sourceTexture, vec2 (uv0.x - 2.0 * x, uv0.y + 2.0 * y)).rgb;
		vec3 b = texture2D(sourceTexture, vec2 (uv0.x,		   uv0.y + 2.0 * y)).rgb;
		vec3 c = texture2D(sourceTexture, vec2 (uv0.x + 2.0 * x, uv0.y + 2.0 * y)).rgb;
		vec3 d = texture2D(sourceTexture, vec2 (uv0.x - 2.0 * x, uv0.y)).rgb;
		vec3 f = texture2D(sourceTexture, vec2 (uv0.x + 2.0 * x, uv0.y)).rgb;
		vec3 g = texture2D(sourceTexture, vec2 (uv0.x - 2.0 * x, uv0.y - 2.0 * y)).rgb;
		vec3 h = texture2D(sourceTexture, vec2 (uv0.x,		   uv0.y - 2.0 * y)).rgb;
		vec3 i = texture2D(sourceTexture, vec2 (uv0.x + 2.0 * x, uv0.y - 2.0 * y)).rgb;
		vec3 j = texture2D(sourceTexture, vec2 (uv0.x - x, uv0.y + y)).rgb;
		vec3 k = texture2D(sourceTexture, vec2 (uv0.x + x, uv0.y + y)).rgb;
		vec3 l = texture2D(sourceTexture, vec2 (uv0.x - x, uv0.y - y)).rgb;
		vec3 m = texture2D(sourceTexture, vec2 (uv0.x + x, uv0.y - y)).rgb;
		vec3 value = e * 0.125;
		value += (a + c + g + i) * 0.03125;
		value += (b + d + f + h) * 0.0625;
		value += (j + k + l + m) * 0.125;
	#endif
	#ifdef REMOVE_INVALID
		value = max(value, vec3(0.0));
	#endif
	gl_FragColor = vec4(value, 1.0);
}
`});var ste,ite=m(()=>{ste=`
var sourceTexture: texture_2d<f32>;
var sourceTextureSampler: sampler;
uniform sourceInvResolution: vec2f;
varying uv0: vec2f;
#ifdef PREMULTIPLY
	var premultiplyTexture: texture_2d<f32>;
	var premultiplyTextureSampler: sampler;
#endif
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	let e: vec3f = textureSample(sourceTexture, sourceTextureSampler, input.uv0).rgb;
	#ifdef BOXFILTER
		var value: vec3f = e;
		#ifdef PREMULTIPLY
			let premultiply: f32 = textureSample(premultiplyTexture, premultiplyTextureSampler, input.uv0).{PREMULTIPLY_SRC_CHANNEL};
			value = value * vec3f(premultiply);
		#endif
	#else
		let x: f32 = uniform.sourceInvResolution.x;
		let y: f32 = uniform.sourceInvResolution.y;
		let a: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x - 2.0 * x, input.uv0.y + 2.0 * y)).rgb;
		let b: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x,		   input.uv0.y + 2.0 * y)).rgb;
		let c: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x + 2.0 * x, input.uv0.y + 2.0 * y)).rgb;
		let d: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x - 2.0 * x, input.uv0.y)).rgb;
		let f: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x + 2.0 * x, input.uv0.y)).rgb;
		let g: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x - 2.0 * x, input.uv0.y - 2.0 * y)).rgb;
		let h: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x,		   input.uv0.y - 2.0 * y)).rgb;
		let i: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x + 2.0 * x, input.uv0.y - 2.0 * y)).rgb;
		let j: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x - x, input.uv0.y + y)).rgb;
		let k: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x + x, input.uv0.y + y)).rgb;
		let l: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x - x, input.uv0.y - y)).rgb;
		let m: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x + x, input.uv0.y - y)).rgb;
		var value: vec3f = e * 0.125;
		value = value + (a + c + g + i) * 0.03125;
		value = value + (b + d + f + h) * 0.0625;
		value = value + (j + k + l + m) * 0.125;
	#endif
	#ifdef REMOVE_INVALID
		value = max(value, vec3f(0.0));
	#endif
	output.color = vec4f(value, 1.0);
	return output;
}
`});var wo,dE=m(()=>{j();go();Dt();tte();ite();It();wo=class extends gs{constructor(e,t,s={}){super(e),this.sourceTexture=t,this.premultiplyTexture=s.premultiplyTexture,ie.get(e,oe).set("downsamplePS",ete),ie.get(e,le).set("downsamplePS",ste);let i=s.boxFilter??!1,r=`${i?"Box":""}-${s.premultiplyTexture?"Premultiply":""}-${s.premultiplySrcChannel??""}-${s.removeInvalid?"RemoveInvalid":""}`,a=new Map;i&&a.set("BOXFILTER",""),s.premultiplyTexture&&a.set("PREMULTIPLY",""),s.removeInvalid&&a.set("REMOVE_INVALID",""),a.set("{PREMULTIPLY_SRC_CHANNEL}",s.premultiplySrcChannel??"x"),this.shader=Te.createShader(e,{uniqueName:`DownSampleShader:${r}`,attributes:{aPosition:te},vertexChunk:"quadVS",fragmentChunk:"downsamplePS",fragmentDefines:a}),this.sourceTextureId=e.scope.resolve("sourceTexture"),this.premultiplyTextureId=e.scope.resolve("premultiplyTexture"),this.sourceInvResolutionId=e.scope.resolve("sourceInvResolution"),this.sourceInvResolutionValue=new Float32Array(2)}setSourceTexture(e){this._sourceTexture=e,this.options.resizeSource=e}execute(){this.sourceTextureId.setValue(this.sourceTexture),this.premultiplyTexture&&this.premultiplyTextureId.setValue(this.premultiplyTexture),this.sourceInvResolutionValue[0]=1/this.sourceTexture.width,this.sourceInvResolutionValue[1]=1/this.sourceTexture.height,this.sourceInvResolutionId.setValue(this.sourceInvResolutionValue),super.execute()}}});var rte,ate=m(()=>{rte=`
	uniform sampler2D sourceTexture;
	uniform vec2 sourceInvResolution;
	varying vec2 uv0;
	void main()
	{
		float x = sourceInvResolution.x;
		float y = sourceInvResolution.y;
		vec3 a = texture2D (sourceTexture, vec2 (uv0.x - x, uv0.y + y)).rgb;
		vec3 b = texture2D (sourceTexture, vec2 (uv0.x,	 uv0.y + y)).rgb;
		vec3 c = texture2D (sourceTexture, vec2 (uv0.x + x, uv0.y + y)).rgb;
		vec3 d = texture2D (sourceTexture, vec2 (uv0.x - x, uv0.y)).rgb;
		vec3 e = texture2D (sourceTexture, vec2 (uv0.x,	 uv0.y)).rgb;
		vec3 f = texture2D (sourceTexture, vec2 (uv0.x + x, uv0.y)).rgb;
		vec3 g = texture2D (sourceTexture, vec2 (uv0.x - x, uv0.y - y)).rgb;
		vec3 h = texture2D (sourceTexture, vec2 (uv0.x,	 uv0.y - y)).rgb;
		vec3 i = texture2D (sourceTexture, vec2 (uv0.x + x, uv0.y - y)).rgb;
		vec3 value = e * 4.0;
		value += (b + d + f + h) * 2.0;
		value += (a + c + g + i);
		value *= 1.0 / 16.0;
		gl_FragColor = vec4(value, 1.0);
	}
`});var nte,ote=m(()=>{nte=`
	var sourceTexture: texture_2d<f32>;
	var sourceTextureSampler: sampler;
	uniform sourceInvResolution: vec2f;
	varying uv0: vec2f;
	@fragment
	fn fragmentMain(input: FragmentInput) -> FragmentOutput {
		var output: FragmentOutput;
		let x: f32 = uniform.sourceInvResolution.x;
		let y: f32 = uniform.sourceInvResolution.y;
		let a: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x - x, input.uv0.y + y)).rgb;
		let b: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x,	 input.uv0.y + y)).rgb;
		let c: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x + x, input.uv0.y + y)).rgb;
		let d: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x - x, input.uv0.y)).rgb;
		let e: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x,	 input.uv0.y)).rgb;
		let f: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x + x, input.uv0.y)).rgb;
		let g: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x - x, input.uv0.y - y)).rgb;
		let h: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x,	 input.uv0.y - y)).rgb;
		let i: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x + x, input.uv0.y - y)).rgb;
		var value: vec3f = e * 4.0;
		value = value + (b + d + f + h) * 2.0;
		value = value + (a + c + g + i);
		value = value * (1.0 / 16.0);
		output.color = vec4f(value, 1.0);
		return output;
	}
`});var Ig,cO=m(()=>{j();go();Dt();ate();ote();It();Ig=class extends gs{constructor(e,t){super(e),this.sourceTexture=t,ie.get(e,oe).set("upsamplePS",rte),ie.get(e,le).set("upsamplePS",nte),this.shader=Te.createShader(e,{uniqueName:"UpSampleShader",attributes:{aPosition:te},vertexChunk:"quadVS",fragmentChunk:"upsamplePS"}),this.sourceTextureId=e.scope.resolve("sourceTexture"),this.sourceInvResolutionId=e.scope.resolve("sourceInvResolution"),this.sourceInvResolutionValue=new Float32Array(2)}execute(){this.sourceTextureId.setValue(this.sourceTexture),this.sourceInvResolutionValue[0]=1/this.sourceTexture.width,this.sourceInvResolutionValue[1]=1/this.sourceTexture.height,this.sourceInvResolutionId.setValue(this.sourceInvResolutionValue),super.execute()}}});var wg,fO=m(()=>{De();Fe();qt();Rt();us();dE();cO();me();wg=class extends Xe{constructor(e,t,s){super(e),this.blurLevel=16,this.renderTargets=[],this._sourceTexture=t,this.textureFormat=s,this.bloomRenderTarget=this.createRenderTarget(0),this.bloomTexture=this.bloomRenderTarget.colorBuffer}destroy(){this.destroyRenderPasses(),this.destroyRenderTargets()}destroyRenderTargets(e=0){for(let t=e;t<this.renderTargets.length;t++){let s=this.renderTargets[t];s.destroyTextureBuffers(),s.destroy()}this.renderTargets.length=0}destroyRenderPasses(){for(let e=0;e<this.beforePasses.length;e++)this.beforePasses[e].destroy();this.beforePasses.length=0}createRenderTarget(e){return new xe({depth:!1,colorBuffer:new q(this.device,{name:`BloomTexture${e}`,width:1,height:1,format:this.textureFormat,mipmaps:!1,minFilter:1,magFilter:1,addressU:1,addressV:1})})}createRenderTargets(e){for(let t=0;t<e;t++){let s=t===0?this.bloomRenderTarget:this.createRenderTarget(t);this.renderTargets.push(s)}}calcMipLevels(e,t,s){let i=Math.min(e,t);return Math.floor(Math.log2(i)-Math.log2(s))}createRenderPasses(e){let t=this.device,s=this._sourceTexture;for(let i=0;i<e;i++){let r=new wo(t,s),a=this.renderTargets[i];r.init(a,{resizeSource:s,scaleX:.5,scaleY:.5}),r.setClearColor(N.BLACK),this.beforePasses.push(r),s=a.colorBuffer}s=this.renderTargets[e-1].colorBuffer;for(let i=e-2;i>=0;i--){let r=new Ig(t,s),a=this.renderTargets[i];r.init(a),r.blendState=Ie.ADDBLEND,this.beforePasses.push(r),s=a.colorBuffer}}onDisable(){this.renderTargets[0]?.resize(1,1),this.destroyRenderPasses(),this.destroyRenderTargets(1)}frameUpdate(){super.frameUpdate();let e=this.calcMipLevels(this._sourceTexture.width,this._sourceTexture.height,1),t=w.clamp(e,1,this.blurLevel);this.renderTargets.length!==t&&(this.destroyRenderPasses(),this.destroyRenderTargets(1),this.createRenderTargets(t),this.createRenderPasses(t))}}});var lte,hte=m(()=>{lte=`
	#include "tonemappingPS"
	#include "gammaPS"
	varying vec2 uv0;
	uniform sampler2D sceneTexture;
	uniform vec2 sceneTextureInvRes;
	#include "composeBloomPS"
	#include "composeDofPS"
	#include "composeSsaoPS"
	#include "composeGradingPS"
	#include "composeVignettePS"
	#include "composeFringingPS"
	#include "composeCasPS"
	#include "composeColorLutPS"
	void main() {
		vec2 uv = uv0;
		#ifdef TAA
		#ifdef WEBGPU
			uv.y = 1.0 - uv.y;
		#endif
		#endif
		vec4 scene = texture2DLod(sceneTexture, uv, 0.0);
		vec3 result = scene.rgb;
		#ifdef CAS
			result = applyCas(result, uv, sharpness);
		#endif
		#ifdef DOF
			result = applyDof(result, uv0);
		#endif
		#ifdef SSAO_TEXTURE
			result = applySsao(result, uv0);
		#endif
		#ifdef FRINGING
			result = applyFringing(result, uv);
		#endif
		#ifdef BLOOM
			result = applyBloom(result, uv0);
		#endif
		#ifdef GRADING
			result = applyGrading(result);
		#endif
		result = toneMap(max(vec3(0.0), result));
		#ifdef COLOR_LUT
			result = applyColorLUT(result);
		#endif
		#ifdef VIGNETTE
			result = applyVignette(result, uv);
		#endif
		#ifdef DEBUG_COMPOSE
			#if DEBUG_COMPOSE == scene
				result = scene.rgb;
			#elif defined(BLOOM) && DEBUG_COMPOSE == bloom
				result = dBloom * bloomIntensity;
			#elif defined(DOF) && DEBUG_COMPOSE == dofcoc
				result = vec3(dCoc, 0.0);
			#elif defined(DOF) && DEBUG_COMPOSE == dofblur
				result = dBlur;
			#elif defined(SSAO_TEXTURE) && DEBUG_COMPOSE == ssao
				result = vec3(dSsao);
			#elif defined(VIGNETTE) && DEBUG_COMPOSE == vignette
				result = vec3(dVignette);
			#endif
		#endif
		result = gammaCorrectOutput(result);
		gl_FragColor = vec4(result, scene.a);
	}
`});var cte,fte=m(()=>{cte=`
	#ifdef BLOOM
		uniform sampler2D bloomTexture;
		uniform float bloomIntensity;
		
		vec3 dBloom;
		
		vec3 applyBloom(vec3 color, vec2 uv) {
			dBloom = texture2DLod(bloomTexture, uv, 0.0).rgb;
			return color + dBloom * bloomIntensity;
		}
	#endif
`});var dte,ute=m(()=>{dte=`
	#ifdef DOF
		uniform sampler2D cocTexture;
		uniform sampler2D blurTexture;
		
		vec2 dCoc;
		vec3 dBlur;
		vec3 getDofBlur(vec2 uv) {
			dCoc = texture2DLod(cocTexture, uv, 0.0).rg;
			#if DOF_UPSCALE
				vec2 blurTexelSize = 1.0 / vec2(textureSize(blurTexture, 0));
				vec3 bilinearBlur = vec3(0.0);
				float totalWeight = 0.0;
				for (int i = -1; i <= 1; i++) {
					for (int j = -1; j <= 1; j++) {
						vec2 offset = vec2(i, j) * blurTexelSize;
						vec2 cocSample = texture2DLod(cocTexture, uv + offset, 0.0).rg;
						vec3 blurSample = texture2DLod(blurTexture, uv + offset, 0.0).rgb;
						float cocWeight = clamp(cocSample.r + cocSample.g, 0.0, 1.0);
						bilinearBlur += blurSample * cocWeight;
						totalWeight += cocWeight;
					}
				}
				if (totalWeight > 0.0) {
					bilinearBlur /= totalWeight;
				}
				dBlur = bilinearBlur;
				return bilinearBlur;
			#else
				dBlur = texture2DLod(blurTexture, uv, 0.0).rgb;
				return dBlur;
			#endif
		}
		vec3 applyDof(vec3 color, vec2 uv) {
			vec3 blur = getDofBlur(uv);
			return mix(color, blur, dCoc.r + dCoc.g);
		}
	#endif
`});var mte,pte=m(()=>{mte=`
	#ifdef SSAO
		#define SSAO_TEXTURE
	#endif
	#if DEBUG_COMPOSE == ssao
		#define SSAO_TEXTURE
	#endif
	#ifdef SSAO_TEXTURE
		uniform sampler2D ssaoTexture;
		
		float dSsao;
		
		vec3 applySsao(vec3 color, vec2 uv) {
			dSsao = texture2DLod(ssaoTexture, uv, 0.0).r;
			
			#ifdef SSAO
				return color * dSsao;
			#else
				return color;
			#endif
		}
	#endif
`});var _te,gte=m(()=>{_te=`
	#ifdef GRADING
		uniform vec3 brightnessContrastSaturation;
		uniform vec3 tint;
		vec3 colorGradingHDR(vec3 color, float brt, float sat, float con) {
			color *= tint;
			color = color * brt;
			float grey = dot(color, vec3(0.3, 0.59, 0.11));
			grey = grey / max(1.0, max(color.r, max(color.g, color.b)));
			color = mix(vec3(grey), color, sat);
			return mix(vec3(0.5), color, con);
		}
		vec3 applyGrading(vec3 color) {
			return colorGradingHDR(color, 
				brightnessContrastSaturation.x, 
				brightnessContrastSaturation.z, 
				brightnessContrastSaturation.y);
		}
	#endif
`});var Ste,Tte=m(()=>{Ste=`
	#ifdef VIGNETTE
		uniform vec4 vignetterParams;
		
		float dVignette;
		
		float calcVignette(vec2 uv) {
			float inner = vignetterParams.x;
			float outer = vignetterParams.y;
			float curvature = vignetterParams.z;
			float intensity = vignetterParams.w;
			vec2 curve = pow(abs(uv * 2.0 -1.0), vec2(1.0 / curvature));
			float edge = pow(length(curve), curvature);
			dVignette = 1.0 - intensity * smoothstep(inner, outer, edge);
			return dVignette;
		}
		vec3 applyVignette(vec3 color, vec2 uv) {
			return color * calcVignette(uv);
		}
	#endif
`});var Ete,vte=m(()=>{Ete=`
	#ifdef FRINGING
		uniform float fringingIntensity;
		vec3 applyFringing(vec3 color, vec2 uv) {
			vec2 centerDistance = uv - 0.5;
			vec2 offset = fringingIntensity * pow(centerDistance, vec2(2.0, 2.0));
			color.r = texture2D(sceneTexture, uv - offset).r;
			color.b = texture2D(sceneTexture, uv + offset).b;
			return color;
		}
	#endif
`});var xte,yte=m(()=>{xte=`
	#ifdef CAS
		uniform float sharpness;
		float maxComponent(float x, float y, float z) { return max(x, max(y, z)); }
		vec3 toSDR(vec3 c) { return c / (1.0 + maxComponent(c.r, c.g, c.b)); }
		vec3 toHDR(vec3 c) { return c / (1.0 - maxComponent(c.r, c.g, c.b)); }
		vec3 applyCas(vec3 color, vec2 uv, float sharpness) {
			float x = sceneTextureInvRes.x;
			float y = sceneTextureInvRes.y;
			vec3 a = toSDR(texture2DLod(sceneTexture, uv + vec2(0.0, -y), 0.0).rgb);
			vec3 b = toSDR(texture2DLod(sceneTexture, uv + vec2(-x, 0.0), 0.0).rgb);
			vec3 c = toSDR(color.rgb);
			vec3 d = toSDR(texture2DLod(sceneTexture, uv + vec2(x, 0.0), 0.0).rgb);
			vec3 e = toSDR(texture2DLod(sceneTexture, uv + vec2(0.0, y), 0.0).rgb);
			float min_g = min(a.g, min(b.g, min(c.g, min(d.g, e.g))));
			float max_g = max(a.g, max(b.g, max(c.g, max(d.g, e.g))));
			float sharpening_amount = sqrt(min(1.0 - max_g, min_g) / max_g);
			float w = sharpening_amount * sharpness;
			vec3 res = (w * (a + b + d + e) + c) / (4.0 * w + 1.0);
			res = max(res, 0.0);
			return toHDR(res);
		}
	#endif
`});var Ate,Pte=m(()=>{Ate=`
	#ifdef COLOR_LUT
		uniform sampler2D colorLUT;
		uniform vec4 colorLUTParams;
		vec3 applyColorLUT(vec3 color) {
			vec3 c = clamp(color, 0.0, 1.0);
			float width = colorLUTParams.x;
			float height = colorLUTParams.y;
			float maxColor = colorLUTParams.z;
			float cell = c.b * maxColor;
			float cell_l = floor(cell);
			float cell_h = ceil(cell);
			float half_px_x = 0.5 / width;
			float half_px_y = 0.5 / height;
			float r_offset = half_px_x + c.r / height * (maxColor / height);
			float g_offset = half_px_y + c.g * (maxColor / height);
			vec2 uv_l = vec2(cell_l / height + r_offset, g_offset);
			vec2 uv_h = vec2(cell_h / height + r_offset, g_offset);
			vec3 color_l = texture2DLod(colorLUT, uv_l, 0.0).rgb;
			vec3 color_h = texture2DLod(colorLUT, uv_h, 0.0).rgb;
			vec3 lutColor = mix(color_l, color_h, fract(cell));
			return mix(color, lutColor, colorLUTParams.w);
		}
	#endif
`});var Rte,Cte=m(()=>{hte();fte();ute();pte();gte();Tte();vte();yte();Pte();Rte={composePS:lte,composeBloomPS:cte,composeDofPS:dte,composeSsaoPS:mte,composeGradingPS:_te,composeVignettePS:Ste,composeFringingPS:Ete,composeCasPS:xte,composeColorLutPS:Ate}});var Ite,wte=m(()=>{Ite=`
	#include "tonemappingPS"
	#include "gammaPS"
	varying uv0: vec2f;
	var sceneTexture: texture_2d<f32>;
	var sceneTextureSampler: sampler;
	uniform sceneTextureInvRes: vec2f;
	#include "composeBloomPS"
	#include "composeDofPS"
	#include "composeSsaoPS"
	#include "composeGradingPS"
	#include "composeVignettePS"
	#include "composeFringingPS"
	#include "composeCasPS"
	#include "composeColorLutPS"
	@fragment
	fn fragmentMain(input: FragmentInput) -> FragmentOutput {
		var output: FragmentOutput;
		var uv = uv0;
		#ifdef TAA
			uv.y = 1.0 - uv.y;
		#endif
		let scene = textureSampleLevel(sceneTexture, sceneTextureSampler, uv, 0.0);
		var result = scene.rgb;
		#ifdef CAS
			result = applyCas(result, uv, uniform.sharpness);
		#endif
		#ifdef DOF
			result = applyDof(result, uv0);
		#endif
		#ifdef SSAO_TEXTURE
			result = applySsao(result, uv0);
		#endif
		#ifdef FRINGING
			result = applyFringing(result, uv);
		#endif
		#ifdef BLOOM
			result = applyBloom(result, uv0);
		#endif
		#ifdef GRADING
			result = applyGrading(result);
		#endif
		result = toneMap(max(vec3f(0.0), result));
		#ifdef COLOR_LUT
			result = applyColorLUT(result);
		#endif
		#ifdef VIGNETTE
			result = applyVignette(result, uv);
		#endif
		#ifdef DEBUG_COMPOSE
			#if DEBUG_COMPOSE == scene
				result = scene.rgb;
			#elif defined(BLOOM) && DEBUG_COMPOSE == bloom
				result = dBloom * uniform.bloomIntensity;
			#elif defined(DOF) && DEBUG_COMPOSE == dofcoc
				result = vec3f(dCoc, 0.0);
			#elif defined(DOF) && DEBUG_COMPOSE == dofblur
				result = dBlur;
			#elif defined(SSAO_TEXTURE) && DEBUG_COMPOSE == ssao
				result = vec3f(dSsao);
			#elif defined(VIGNETTE) && DEBUG_COMPOSE == vignette
				result = vec3f(dVignette);
			#endif
		#endif
		result = gammaCorrectOutput(result);
		output.color = vec4f(result, scene.a);
		return output;
	}
`});var Lte,bte=m(()=>{Lte=`
	#ifdef BLOOM
		var bloomTexture: texture_2d<f32>;
		var bloomTextureSampler: sampler;
		uniform bloomIntensity: f32;
		
		var<private> dBloom: vec3f;
		
		fn applyBloom(color: vec3f, uv: vec2f) -> vec3f {
			dBloom = textureSampleLevel(bloomTexture, bloomTextureSampler, uv, 0.0).rgb;
			return color + dBloom * uniform.bloomIntensity;
		}
	#endif
`});var Mte,Dte=m(()=>{Mte=`
	#ifdef DOF
		var cocTexture: texture_2d<f32>;
		var cocTextureSampler: sampler;
		var blurTexture: texture_2d<f32>;
		var blurTextureSampler: sampler;
		
		var<private> dCoc: vec2f;
		var<private> dBlur: vec3f;
		fn getDofBlur(uv: vec2f) -> vec3f {
			dCoc = textureSampleLevel(cocTexture, cocTextureSampler, uv, 0.0).rg;
			#if DOF_UPSCALE
				let blurTexelSize = 1.0 / vec2f(textureDimensions(blurTexture, 0));
				var bilinearBlur = vec3f(0.0);
				var totalWeight = 0.0;
				for (var i = -1; i <= 1; i++) {
					for (var j = -1; j <= 1; j++) {
						let offset = vec2f(f32(i), f32(j)) * blurTexelSize;
						let cocSample = textureSampleLevel(cocTexture, cocTextureSampler, uv + offset, 0.0).rg;
						let blurSample = textureSampleLevel(blurTexture, blurTextureSampler, uv + offset, 0.0).rgb;
						let cocWeight = clamp(cocSample.r + cocSample.g, 0.0, 1.0);
						bilinearBlur += blurSample * cocWeight;
						totalWeight += cocWeight;
					}
				}
				if (totalWeight > 0.0) {
					bilinearBlur /= totalWeight;
				}
				dBlur = bilinearBlur;
				return bilinearBlur;
			#else
				dBlur = textureSampleLevel(blurTexture, blurTextureSampler, uv, 0.0).rgb;
				return dBlur;
			#endif
		}
		fn applyDof(color: vec3f, uv: vec2f) -> vec3f {
			let blur = getDofBlur(uv);
			return mix(color, blur, dCoc.r + dCoc.g);
		}
	#endif
`});var Ote,Nte=m(()=>{Ote=`
	#ifdef SSAO
		#define SSAO_TEXTURE
	#endif
	#if DEBUG_COMPOSE == ssao
		#define SSAO_TEXTURE
	#endif
	#ifdef SSAO_TEXTURE
		var ssaoTexture: texture_2d<f32>;
		var ssaoTextureSampler: sampler;
		
		var<private> dSsao: f32;
		
		fn applySsao(color: vec3f, uv: vec2f) -> vec3f {
			dSsao = textureSampleLevel(ssaoTexture, ssaoTextureSampler, uv, 0.0).r;
			
			#ifdef SSAO
				return color * dSsao;
			#else
				return color;
			#endif
		}
	#endif
`});var Fte,Ute=m(()=>{Fte=`
	#ifdef GRADING
		uniform brightnessContrastSaturation: vec3f;
		uniform tint: vec3f;
		fn colorGradingHDR(color: vec3f, brt: f32, sat: f32, con: f32) -> vec3f {
			var colorOut = color * uniform.tint;
			colorOut = colorOut * brt;
			let grey = dot(colorOut, vec3f(0.3, 0.59, 0.11));
			let normalizedGrey = grey / max(1.0, max(colorOut.r, max(colorOut.g, colorOut.b)));
			colorOut = mix(vec3f(normalizedGrey), colorOut, sat);
			return mix(vec3f(0.5), colorOut, con);
		}
		fn applyGrading(color: vec3f) -> vec3f {
			return colorGradingHDR(color, 
				uniform.brightnessContrastSaturation.x, 
				uniform.brightnessContrastSaturation.z, 
				uniform.brightnessContrastSaturation.y);
		}
	#endif
`});var Bte,Vte=m(()=>{Bte=`
	#ifdef VIGNETTE
		uniform vignetterParams: vec4f;
		
		var<private> dVignette: f32;
		
		fn calcVignette(uv: vec2f) -> f32 {
			let inner = uniform.vignetterParams.x;
			let outer = uniform.vignetterParams.y;
			let curvature = uniform.vignetterParams.z;
			let intensity = uniform.vignetterParams.w;
			let curve = pow(abs(uv * 2.0 - 1.0), vec2f(1.0 / curvature));
			let edge = pow(length(curve), curvature);
			dVignette = 1.0 - intensity * smoothstep(inner, outer, edge);
			return dVignette;
		}
		fn applyVignette(color: vec3f, uv: vec2f) -> vec3f {
			return color * calcVignette(uv);
		}
	#endif
`});var kte,Gte=m(()=>{kte=`
	#ifdef FRINGING
		uniform fringingIntensity: f32;
		fn applyFringing(color: vec3f, uv: vec2f) -> vec3f {
			let centerDistance = uv - 0.5;
			let offset = uniform.fringingIntensity * pow(centerDistance, vec2f(2.0));
			var colorOut = color;
			colorOut.r = textureSample(sceneTexture, sceneTextureSampler, uv - offset).r;
			colorOut.b = textureSample(sceneTexture, sceneTextureSampler, uv + offset).b;
			return colorOut;
		}
	#endif
`});var zte,Hte=m(()=>{zte=`
	#ifdef CAS
		uniform sharpness: f32;
		fn maxComponent(x: f32, y: f32, z: f32) -> f32 { return max(x, max(y, z)); }
		fn toSDR(c: vec3f) -> vec3f { return c / (1.0 + maxComponent(c.r, c.g, c.b)); }
		fn toHDR(c: vec3f) -> vec3f { return c / (1.0 - maxComponent(c.r, c.g, c.b)); }
		fn applyCas(color: vec3f, uv: vec2f, sharpness: f32) -> vec3f {
			let x = uniform.sceneTextureInvRes.x;
			let y = uniform.sceneTextureInvRes.y;
			let a = toSDR(textureSampleLevel(sceneTexture, sceneTextureSampler, uv + vec2f(0.0, -y), 0.0).rgb);
			let b = toSDR(textureSampleLevel(sceneTexture, sceneTextureSampler, uv + vec2f(-x, 0.0), 0.0).rgb);
			let c = toSDR(color.rgb);
			let d = toSDR(textureSampleLevel(sceneTexture, sceneTextureSampler, uv + vec2f(x, 0.0), 0.0).rgb);
			let e = toSDR(textureSampleLevel(sceneTexture, sceneTextureSampler, uv + vec2f(0.0, y), 0.0).rgb);
			let min_g = min(a.g, min(b.g, min(c.g, min(d.g, e.g))));
			let max_g = max(a.g, max(b.g, max(c.g, max(d.g, e.g))));
			let sharpening_amount = sqrt(min(1.0 - max_g, min_g) / max_g);
			let w = sharpening_amount * uniform.sharpness;
			var res = (w * (a + b + d + e) + c) / (4.0 * w + 1.0);
			res = max(res, vec3f(0.0));
			return toHDR(res);
		}
	#endif
`});var Xte,Wte=m(()=>{Xte=`
	#ifdef COLOR_LUT
		var colorLUT: texture_2d<f32>;
		var colorLUTSampler: sampler;
		uniform colorLUTParams: vec4f;
		fn applyColorLUT(color: vec3f) -> vec3f {
			var c: vec3f = clamp(color, vec3f(0.0), vec3f(1.0));
			let width: f32 = uniform.colorLUTParams.x;
			let height: f32 = uniform.colorLUTParams.y;
			let maxColor: f32 = uniform.colorLUTParams.z;
			let cell: f32 = c.b * maxColor;
			let cell_l: f32 = floor(cell);
			let cell_h: f32 = ceil(cell);
			let half_px_x: f32 = 0.5 / width;
			let half_px_y: f32 = 0.5 / height;
			let r_offset: f32 = half_px_x + c.r / height * (maxColor / height);
			let g_offset: f32 = half_px_y + c.g * (maxColor / height);
			let uv_l: vec2f = vec2f(cell_l / height + r_offset, g_offset);
			let uv_h: vec2f = vec2f(cell_h / height + r_offset, g_offset);
			let color_l: vec3f = textureSampleLevel(colorLUT, colorLUTSampler, uv_l, 0.0).rgb;
			let color_h: vec3f = textureSampleLevel(colorLUT, colorLUTSampler, uv_h, 0.0).rgb;
			let lutColor: vec3f = mix(color_l, color_h, fract(cell));
			return mix(color, lutColor, uniform.colorLUTParams.w);
		}
	#endif
`});var Yte,Kte=m(()=>{wte();bte();Dte();Nte();Ute();Vte();Gte();Hte();Wte();Yte={composePS:Ite,composeBloomPS:Lte,composeDofPS:Mte,composeSsaoPS:Ote,composeGradingPS:Fte,composeVignettePS:Bte,composeFringingPS:kte,composeCasPS:zte,composeColorLutPS:Xte}});var Lg,dO=m(()=>{me();De();go();J();It();j();Dt();Cte();Kte();Lg=class extends gs{constructor(e){super(e),this.sceneTexture=null,this.bloomIntensity=.01,this._bloomTexture=null,this._cocTexture=null,this.blurTexture=null,this.blurTextureUpscale=!1,this._ssaoTexture=null,this._toneMapping=ro,this._gradingEnabled=!1,this.gradingSaturation=1,this.gradingContrast=1,this.gradingBrightness=1,this.gradingTint=new N(1,1,1,1),this._shaderDirty=!0,this._vignetteEnabled=!1,this.vignetteInner=.5,this.vignetteOuter=1,this.vignetteCurvature=.5,this.vignetteIntensity=.3,this._fringingEnabled=!1,this.fringingIntensity=10,this._taaEnabled=!1,this._sharpness=.5,this._gammaCorrection=io,this._colorLUT=null,this.colorLUTIntensity=1,this._key="",this._debug=null,ie.get(e,oe).add(Rte),ie.get(e,le).add(Yte);let{scope:t}=e;this.sceneTextureId=t.resolve("sceneTexture"),this.bloomTextureId=t.resolve("bloomTexture"),this.cocTextureId=t.resolve("cocTexture"),this.ssaoTextureId=t.resolve("ssaoTexture"),this.blurTextureId=t.resolve("blurTexture"),this.bloomIntensityId=t.resolve("bloomIntensity"),this.bcsId=t.resolve("brightnessContrastSaturation"),this.tintId=t.resolve("tint"),this.vignetterParamsId=t.resolve("vignetterParams"),this.fringingIntensityId=t.resolve("fringingIntensity"),this.sceneTextureInvResId=t.resolve("sceneTextureInvRes"),this.sceneTextureInvResValue=new Float32Array(2),this.sharpnessId=t.resolve("sharpness"),this.colorLUTId=t.resolve("colorLUT"),this.colorLUTParams=new Float32Array(4),this.colorLUTParamsId=t.resolve("colorLUTParams")}set debug(e){this._debug!==e&&(this._debug=e,this._shaderDirty=!0)}get debug(){return this._debug}set colorLUT(e){this._colorLUT!==e&&(this._colorLUT=e,this._shaderDirty=!0)}get colorLUT(){return this._colorLUT}set bloomTexture(e){this._bloomTexture!==e&&(this._bloomTexture=e,this._shaderDirty=!0)}get bloomTexture(){return this._bloomTexture}set cocTexture(e){this._cocTexture!==e&&(this._cocTexture=e,this._shaderDirty=!0)}get cocTexture(){return this._cocTexture}set ssaoTexture(e){this._ssaoTexture!==e&&(this._ssaoTexture=e,this._shaderDirty=!0)}get ssaoTexture(){return this._ssaoTexture}set taaEnabled(e){this._taaEnabled!==e&&(this._taaEnabled=e,this._shaderDirty=!0)}get taaEnabled(){return this._taaEnabled}set gradingEnabled(e){this._gradingEnabled!==e&&(this._gradingEnabled=e,this._shaderDirty=!0)}get gradingEnabled(){return this._gradingEnabled}set vignetteEnabled(e){this._vignetteEnabled!==e&&(this._vignetteEnabled=e,this._shaderDirty=!0)}get vignetteEnabled(){return this._vignetteEnabled}set fringingEnabled(e){this._fringingEnabled!==e&&(this._fringingEnabled=e,this._shaderDirty=!0)}get fringingEnabled(){return this._fringingEnabled}set toneMapping(e){this._toneMapping!==e&&(this._toneMapping=e,this._shaderDirty=!0)}get toneMapping(){return this._toneMapping}set sharpness(e){this._sharpness!==e&&(this._sharpness=e,this._shaderDirty=!0)}get sharpness(){return this._sharpness}get isSharpnessEnabled(){return this._sharpness>0}postInit(){this.setClearColor(N.BLACK),this.setClearDepth(1),this.setClearStencil(0)}frameUpdate(){let s=(this.renderTarget??this.device.backBuffer).isColorBufferSrgb(0)?Mi:io;if(this._gammaCorrection!==s&&(this._gammaCorrection=s,this._shaderDirty=!0),this._shaderDirty){this._shaderDirty=!1;let i=Rm[this._gammaCorrection],r=`${this.toneMapping}-${i}-${this.bloomTexture?"bloom":"nobloom"}-${this.cocTexture?"dof":"nodof"}-${this.blurTextureUpscale?"dofupscale":""}-${this.ssaoTexture?"ssao":"nossao"}-${this.gradingEnabled?"grading":"nograding"}-${this.colorLUT?"colorlut":"nocolorlut"}-${this.vignetteEnabled?"vignette":"novignette"}-${this.fringingEnabled?"fringing":"nofringing"}-${this.taaEnabled?"taa":"notaa"}-${this.isSharpnessEnabled?"cas":"nocas"}-${this._debug??""}`;if(this._key!==r){this._key=r;let a=new Map;a.set("TONEMAP",Ph[this.toneMapping]),a.set("GAMMA",i),this.bloomTexture&&a.set("BLOOM",!0),this.cocTexture&&a.set("DOF",!0),this.blurTextureUpscale&&a.set("DOF_UPSCALE",!0),this.ssaoTexture&&a.set("SSAO",!0),this.gradingEnabled&&a.set("GRADING",!0),this.colorLUT&&a.set("COLOR_LUT",!0),this.vignetteEnabled&&a.set("VIGNETTE",!0),this.fringingEnabled&&a.set("FRINGING",!0),this.taaEnabled&&a.set("TAA",!0),this.isSharpnessEnabled&&a.set("CAS",!0),this._debug&&a.set("DEBUG_COMPOSE",this._debug);let n=new Map(ie.get(this.device,this.device.isWebGPU?le:oe));this.shader=Te.createShader(this.device,{uniqueName:`ComposeShader-${r}`,attributes:{aPosition:te},vertexChunk:"quadVS",fragmentChunk:"composePS",fragmentDefines:a,fragmentIncludes:n})}}}execute(){this.sceneTextureId.setValue(this.sceneTexture),this.sceneTextureInvResValue[0]=1/this.sceneTexture.width,this.sceneTextureInvResValue[1]=1/this.sceneTexture.height,this.sceneTextureInvResId.setValue(this.sceneTextureInvResValue),this._bloomTexture&&(this.bloomTextureId.setValue(this._bloomTexture),this.bloomIntensityId.setValue(this.bloomIntensity)),this._cocTexture&&(this.cocTextureId.setValue(this._cocTexture),this.blurTextureId.setValue(this.blurTexture)),this._ssaoTexture&&this.ssaoTextureId.setValue(this._ssaoTexture),this._gradingEnabled&&(this.bcsId.setValue([this.gradingBrightness,this.gradingContrast,this.gradingSaturation]),this.tintId.setValue([this.gradingTint.r,this.gradingTint.g,this.gradingTint.b]));let e=this._colorLUT;e&&(this.colorLUTParams[0]=e.width,this.colorLUTParams[1]=e.height,this.colorLUTParams[2]=e.height-1,this.colorLUTParams[3]=this.colorLUTIntensity,this.colorLUTParamsId.setValue(this.colorLUTParams),this.colorLUTId.setValue(e)),this._vignetteEnabled&&this.vignetterParamsId.setValue([this.vignetteInner,this.vignetteOuter,this.vignetteCurvature,this.vignetteIntensity]),this._fringingEnabled&&this.fringingIntensityId.setValue(this.fringingIntensity/1024),this.isSharpnessEnabled&&this.sharpnessId.setValue(w.lerp(-.125,-.2,this.sharpness)),super.execute()}}});var qte,jte=m(()=>{qte=`
vec4 SampleTextureCatmullRom(TEXTURE_ACCEPT(tex), vec2 uv, vec2 texSize) {
	vec2 samplePos = uv * texSize;
	vec2 texPos1 = floor(samplePos - 0.5) + 0.5;
	vec2 f = samplePos - texPos1;
	vec2 w0 = f * (-0.5 + f * (1.0 - 0.5 * f));
	vec2 w1 = 1.0 + f * f * (-2.5 + 1.5 * f);
	vec2 w2 = f * (0.5 + f * (2.0 - 1.5 * f));
	vec2 w3 = f * f * (-0.5 + 0.5 * f);
	vec2 w12 = w1 + w2;
	vec2 offset12 = w2 / (w1 + w2);
	vec2 texPos0 = (texPos1 - 1.0) / texSize;
	vec2 texPos3 = (texPos1 + 2.0) / texSize;
	vec2 texPos12 = (texPos1 + offset12) / texSize;
	vec4 result = vec4(0.0);
	result += texture2DLod(tex, vec2(texPos0.x, texPos0.y), 0.0) * w0.x * w0.y;
	result += texture2DLod(tex, vec2(texPos12.x, texPos0.y), 0.0) * w12.x * w0.y;
	result += texture2DLod(tex, vec2(texPos3.x, texPos0.y), 0.0) * w3.x * w0.y;
	result += texture2DLod(tex, vec2(texPos0.x, texPos12.y), 0.0) * w0.x * w12.y;
	result += texture2DLod(tex, vec2(texPos12.x, texPos12.y), 0.0) * w12.x * w12.y;
	result += texture2DLod(tex, vec2(texPos3.x, texPos12.y), 0.0) * w3.x * w12.y;
	result += texture2DLod(tex, vec2(texPos0.x, texPos3.y), 0.0) * w0.x * w3.y;
	result += texture2DLod(tex, vec2(texPos12.x, texPos3.y), 0.0) * w12.x * w3.y;
	result += texture2DLod(tex, vec2(texPos3.x, texPos3.y), 0.0) * w3.x * w3.y;
	return result;
}
`});var $te,Zte=m(()=>{$te=`
fn SampleTextureCatmullRom(tex: texture_2d<f32>, texSampler: sampler, uv: vec2f, texSize: vec2f) -> vec4f {
	let samplePos: vec2f = uv * texSize;
	let texPos1: vec2f = floor(samplePos - 0.5) + 0.5;
	let f: vec2f = samplePos - texPos1;
	let w0: vec2f = f * (-0.5 + f * (1.0 - 0.5 * f));
	let w1: vec2f = 1.0 + f * f * (-2.5 + 1.5 * f);
	let w2: vec2f = f * (0.5 + f * (2.0 - 1.5 * f));
	let w3: vec2f = f * f * (-0.5 + 0.5 * f);
	let w12: vec2f = w1 + w2;
	let offset12: vec2f = w2 / w12;
	let texPos0: vec2f = (texPos1 - 1.0) / texSize;
	let texPos3: vec2f = (texPos1 + 2.0) / texSize;
	let texPos12: vec2f = (texPos1 + offset12) / texSize;
	var result: vec4f = vec4f(0.0);
	result = result + textureSampleLevel(tex, texSampler, vec2f(texPos0.x, texPos0.y), 0.0) * w0.x * w0.y;
	result = result + textureSampleLevel(tex, texSampler, vec2f(texPos12.x, texPos0.y), 0.0) * w12.x * w0.y;
	result = result + textureSampleLevel(tex, texSampler, vec2f(texPos3.x, texPos0.y), 0.0) * w3.x * w0.y;
	result = result + textureSampleLevel(tex, texSampler, vec2f(texPos0.x, texPos12.y), 0.0) * w0.x * w12.y;
	result = result + textureSampleLevel(tex, texSampler, vec2f(texPos12.x, texPos12.y), 0.0) * w12.x * w12.y;
	result = result + textureSampleLevel(tex, texSampler, vec2f(texPos3.x, texPos12.y), 0.0) * w3.x * w12.y;
	result = result + textureSampleLevel(tex, texSampler, vec2f(texPos0.x, texPos3.y), 0.0) * w0.x * w3.y;
	result = result + textureSampleLevel(tex, texSampler, vec2f(texPos12.x, texPos3.y), 0.0) * w12.x * w3.y;
	result = result + textureSampleLevel(tex, texSampler, vec2f(texPos3.x, texPos3.y), 0.0) * w3.x * w3.y;
	return result;
}
`});var Qte,Jte=m(()=>{Qte=`
	#include  "sampleCatmullRomPS"
	#include  "screenDepthPS"
	uniform sampler2D sourceTexture;
	uniform sampler2D historyTexture;
	uniform mat4 matrix_viewProjectionPrevious;
	uniform mat4 matrix_viewProjectionInverse;
	uniform vec4 jitters;
	uniform vec2 textureSize;
	varying vec2 uv0;
	vec2 reproject(vec2 uv, float depth) {
		#ifndef WEBGPU
			depth = depth * 2.0 - 1.0;
		#endif
		vec4 ndc = vec4(uv * 2.0 - 1.0, depth, 1.0);
		ndc.xy -= jitters.xy;
		vec4 worldPosition = matrix_viewProjectionInverse * ndc;
		worldPosition /= worldPosition.w;
		vec4 screenPrevious = matrix_viewProjectionPrevious * worldPosition;
		return (screenPrevious.xy / screenPrevious.w) * 0.5 + 0.5;
	}
	vec4 colorClamp(vec2 uv, vec4 historyColor) {
		vec3 minColor = vec3(9999.0);
		vec3 maxColor = vec3(-9999.0);
		for(float x = -1.0; x <= 1.0; ++x) {
			for(float y = -1.0; y <= 1.0; ++y) {
				vec3 color = texture2D(sourceTexture, uv + vec2(x, y) / textureSize).rgb;
				minColor = min(minColor, color);
				maxColor = max(maxColor, color);
			}
		}
		vec3 clamped = clamp(historyColor.rgb, minColor, maxColor);
		return vec4(clamped, historyColor.a);
	}
	void main()
	{
		vec2 uv = uv0;
		#ifdef WEBGPU
			uv.y = 1.0 - uv.y;
		#endif
		vec4 srcColor = texture2D(sourceTexture, uv);
		float linearDepth = getLinearScreenDepth(uv0);
		float depth = delinearizeDepth(linearDepth);
		vec2 historyUv = reproject(uv0, depth);
		#ifdef QUALITY_HIGH
			vec4 historyColor = SampleTextureCatmullRom(TEXTURE_PASS(historyTexture), historyUv, textureSize);
		#else
			vec4 historyColor = texture2D(historyTexture, historyUv);
		#endif
		vec4 historyColorClamped = colorClamp(uv, historyColor);
		float mixFactor = (historyUv.x < 0.0 || historyUv.x > 1.0 || historyUv.y < 0.0 || historyUv.y > 1.0) ?
			1.0 : 0.05;
		gl_FragColor = mix(historyColorClamped, srcColor, mixFactor);
	}
`});var ese,tse=m(()=>{ese=`
	#include "sampleCatmullRomPS"
	#include "screenDepthPS"
	var sourceTexture: texture_2d<f32>;
	var sourceTextureSampler: sampler;
	var historyTexture: texture_2d<f32>;
	var historyTextureSampler: sampler;
	uniform matrix_viewProjectionPrevious: mat4x4f;
	uniform matrix_viewProjectionInverse: mat4x4f;
	uniform jitters: vec4f;
	uniform textureSize: vec2f;
	varying uv0: vec2f;
	fn reproject(uv: vec2f, depth: f32) -> vec2f {
		var ndc = vec4f(uv * 2.0 - 1.0, depth, 1.0);
		ndc = vec4f(ndc.xy - uniform.jitters.xy, ndc.zw);
		var worldPosition = uniform.matrix_viewProjectionInverse * ndc;
		worldPosition = worldPosition / worldPosition.w;
		let screenPrevious = uniform.matrix_viewProjectionPrevious * worldPosition;
		return (screenPrevious.xy / screenPrevious.w) * 0.5 + 0.5;
	}
	fn colorClamp(uv: vec2f, historyColor: vec4f) -> vec4f {
		var minColor = vec3f(9999.0);
		var maxColor = vec3f(-9999.0);
		for (var ix: i32 = -1; ix <= 1; ix = ix + 1) {
			for (var iy: i32 = -1; iy <= 1; iy = iy + 1) {
				let color_sample = textureSample(sourceTexture, sourceTextureSampler, uv + vec2f(f32(ix), f32(iy)) / uniform.textureSize).rgb;
				minColor = min(minColor, color_sample);
				maxColor = max(maxColor, color_sample);
			}
		}
		let clamped = clamp(historyColor.rgb, minColor, maxColor);
		return vec4f(clamped, historyColor.a);
	}
	@fragment
	fn fragmentMain(input: FragmentInput) -> FragmentOutput {
		var output: FragmentOutput;
		var uv = input.uv0;
		uv.y = 1.0 - uv.y;
		let srcColor = textureSample(sourceTexture, sourceTextureSampler, uv);
		let linearDepth = getLinearScreenDepth(uv0);
		let depth = delinearizeDepth(linearDepth);
		let historyUv = reproject(uv0, depth);
		#ifdef QUALITY_HIGH
			var historyColor: vec4f = SampleTextureCatmullRom(historyTexture, historyTextureSampler, historyUv, uniform.textureSize);
		#else
			var historyColor: vec4f = textureSample(historyTexture, historyTextureSampler, historyUv);
		#endif
		let historyColorClamped = colorClamp(uv, historyColor);
		let mixFactor_condition = historyUv.x < 0.0 || historyUv.x > 1.0 || historyUv.y < 0.0 || historyUv.y > 1.0;
		let mixFactor = select(0.05, 1.0, mixFactor_condition);
		output.color = mix(historyColorClamped, srcColor, mixFactor);
		return output;
	}
`});var bg,uO=m(()=>{j();Fe();go();Rt();J();Dt();jte();Zte();Jte();tse();It();bg=class extends gs{constructor(e,t,s){super(e),this.historyIndex=0,this.historyTexture=null,this.historyTextures=[],this.historyRenderTargets=[],this.sourceTexture=t,this.cameraComponent=s,ie.get(e,oe).set("sampleCatmullRomPS",qte),ie.get(e,le).set("sampleCatmullRomPS",$te),ie.get(e,oe).set("taaResolvePS",Qte),ie.get(e,le).set("taaResolvePS",ese);let i=new Map;i.set("QUALITY_HIGH",!0),Te.addScreenDepthChunkDefines(e,s.shaderParams,i),this.shader=Te.createShader(e,{uniqueName:"TaaResolveShader",attributes:{aPosition:te},vertexChunk:"quadVS",fragmentChunk:"taaResolvePS",fragmentDefines:i});let{scope:r}=e;this.sourceTextureId=r.resolve("sourceTexture"),this.textureSizeId=r.resolve("textureSize"),this.textureSize=new Float32Array(2),this.historyTextureId=r.resolve("historyTexture"),this.viewProjPrevId=r.resolve("matrix_viewProjectionPrevious"),this.viewProjInvId=r.resolve("matrix_viewProjectionInverse"),this.jittersId=r.resolve("jitters"),this.cameraParams=new Float32Array(4),this.cameraParamsId=r.resolve("camera_params"),this.setup()}destroy(){this.renderTarget&&(this.renderTarget.destroyTextureBuffers(),this.renderTarget.destroy(),this.renderTarget=null)}setup(){for(let e=0;e<2;++e)this.historyTextures[e]=new q(this.device,{name:`TAA-History-${e}`,width:4,height:4,format:this.sourceTexture.format,mipmaps:!1,minFilter:1,magFilter:1,addressU:1,addressV:1}),this.historyRenderTargets[e]=new xe({colorBuffer:this.historyTextures[e],depth:!1});this.historyTexture=this.historyTextures[0],this.init(this.historyRenderTargets[0],{resizeSource:this.sourceTexture})}before(){this.sourceTextureId.setValue(this.sourceTexture),this.historyTextureId.setValue(this.historyTextures[1-this.historyIndex]),this.textureSize[0]=this.sourceTexture.width,this.textureSize[1]=this.sourceTexture.height,this.textureSizeId.setValue(this.textureSize);let e=this.cameraComponent.camera;this.viewProjPrevId.setValue(e._viewProjPrevious.data),this.viewProjInvId.setValue(e._viewProjInverse.data),this.jittersId.setValue(e._jitters);let t=e._farClip;this.cameraParams[0]=1/t,this.cameraParams[1]=t,this.cameraParams[2]=e._nearClip,this.cameraParams[3]=e.projection===Xs?1:0,this.cameraParamsId.setValue(this.cameraParams)}update(){return this.historyIndex=1-this.historyIndex,this.historyTexture=this.historyTextures[this.historyIndex],this.renderTarget=this.historyRenderTargets[this.historyIndex],this.historyTexture}}});var sse,ise=m(()=>{sse=`
	#include "screenDepthPS"
	varying vec2 uv0;
	uniform vec3 params;
	void main()
	{
		float depth = getLinearScreenDepth(uv0);
		float focusDistance = params.x;
		float focusRange = params.y;
		float invRange = params.z;
		float farRange = focusDistance + focusRange * 0.5;
		
		float cocFar = min((depth - farRange) * invRange, 1.0);
		#ifdef NEAR_BLUR
			float nearRange = focusDistance - focusRange * 0.5;
			float cocNear = min((nearRange - depth) * invRange, 1.0);
		#else
			float cocNear = 0.0;
		#endif
		gl_FragColor = vec4(cocFar, cocNear, 0.0, 0.0);
	}
`});var rse,ase=m(()=>{rse=`
#include "screenDepthPS"
varying uv0: vec2f;
uniform params: vec3f;
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	let depth: f32 = getLinearScreenDepth(uv0);
	let focusDistance: f32 = uniform.params.x;
	let focusRange: f32 = uniform.params.y;
	let invRange: f32 = uniform.params.z;
	let farRange: f32 = focusDistance + focusRange * 0.5;
	let cocFar: f32 = min((depth - farRange) * invRange, 1.0);
	#ifdef NEAR_BLUR
		let nearRange: f32 = focusDistance - focusRange * 0.5;
		var cocNear: f32 = min((nearRange - depth) * invRange, 1.0);
	#else
		var cocNear: f32 = 0.0;
	#endif
	output.color = vec4f(cocFar, cocNear, 0.0, 0.0);
	return output;
}
`});var cC,nse=m(()=>{j();J();go();Dt();ise();ase();It();cC=class extends gs{constructor(e,t,s){super(e),this.cameraComponent=t,ie.get(e,oe).set("cocPS",sse),ie.get(e,le).set("cocPS",rse);let i=new Map;s&&i.set("NEAR_BLUR",""),Te.addScreenDepthChunkDefines(e,t.shaderParams,i),this.shader=Te.createShader(e,{uniqueName:`CocShader-${s}`,attributes:{aPosition:te},vertexChunk:"quadVS",fragmentChunk:"cocPS",fragmentDefines:i}),this.paramsId=e.scope.resolve("params"),this.paramsValue=new Float32Array(3),this.cameraParams=new Float32Array(4),this.cameraParamsId=e.scope.resolve("camera_params")}execute(){let{paramsValue:e,focusRange:t}=this;e[0]=this.focusDistance+.001,e[1]=t,e[2]=1/t,this.paramsId.setValue(e);let s=this.cameraComponent.camera,i=s._farClip;this.cameraParams[0]=1/i,this.cameraParams[1]=i,this.cameraParams[2]=s._nearClip,this.cameraParams[3]=s.projection===Xs?1:0,this.cameraParamsId.setValue(this.cameraParams),super.execute()}}});var ose,lse=m(()=>{ose=`
	#if defined(NEAR_BLUR)
		uniform sampler2D nearTexture;
	#endif
	uniform sampler2D farTexture;
	uniform sampler2D cocTexture;
	uniform vec2 kernel[{KERNEL_COUNT}];
	uniform float blurRadiusNear;
	uniform float blurRadiusFar;
	varying vec2 uv0;
	void main()
	{
		vec2 coc = texture2D(cocTexture, uv0).rg;
		float cocFar = coc.r;
		vec3 sum = vec3(0.0, 0.0, 0.0);
		#if defined(NEAR_BLUR)
			float cocNear = coc.g;
			if (cocNear > 0.0001) {
				ivec2 nearTextureSize = textureSize(nearTexture, 0);
				vec2 step = cocNear * blurRadiusNear / vec2(nearTextureSize);
				for (int i = 0; i < {KERNEL_COUNT}; i++) {
					vec2 uv = uv0 + step * kernel[i];
					vec3 tap = texture2DLod(nearTexture, uv, 0.0).rgb;
					sum += tap.rgb;
				}
				sum *= float({INV_KERNEL_COUNT});
			} else
		#endif
			
			if (cocFar > 0.0001) {
			ivec2 farTextureSize = textureSize(farTexture, 0);
			vec2 step = cocFar * blurRadiusFar / vec2(farTextureSize);
			float sumCoC = 0.0; 
			for (int i = 0; i < {KERNEL_COUNT}; i++) {
				vec2 uv = uv0 + step * kernel[i];
				vec3 tap = texture2DLod(farTexture, uv, 0.0).rgb;
				float cocThis = texture2DLod(cocTexture, uv, 0.0).r;
				tap *= cocThis;
				sumCoC += cocThis;
				sum += tap;
			}
			if (sumCoC > 0.0)
				sum /= sumCoC;
			sum /= cocFar;
		}
		pcFragColor0 = vec4(sum, 1.0);
	}
`});var hse,cse=m(()=>{hse=`
#if defined(NEAR_BLUR)
	var nearTexture: texture_2d<f32>;
	var nearTextureSampler: sampler;
#endif
var farTexture: texture_2d<f32>;
var farTextureSampler: sampler;
var cocTexture: texture_2d<f32>;
var cocTextureSampler: sampler;
uniform kernel: array<vec2f, {KERNEL_COUNT}>;
uniform blurRadiusNear: f32;
uniform blurRadiusFar: f32;
varying uv0: vec2f;
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	let coc: vec2f = textureSample(cocTexture, cocTextureSampler, input.uv0).rg;
	let cocFar: f32 = coc.r;
	var sum: vec3f = vec3f(0.0, 0.0, 0.0);
	#if defined(NEAR_BLUR)
		let cocNear: f32 = coc.g;
		if (cocNear > 0.0001) {
			let nearTextureSize: vec2f = vec2f(textureDimensions(nearTexture, 0));
			let step: vec2f = cocNear * uniform.blurRadiusNear / nearTextureSize;
			for (var i: i32 = 0; i < {KERNEL_COUNT}; i = i + 1) {
				let uv: vec2f = uv0 + step * uniform.kernel[i].element;
				let tap: vec3f = textureSampleLevel(nearTexture, nearTextureSampler, uv, 0.0).rgb;
				sum = sum + tap;
			}
			sum = sum * f32({INV_KERNEL_COUNT});
		} else
	#endif
		if (cocFar > 0.0001) {
			let farTextureSize: vec2f = vec2f(textureDimensions(farTexture, 0));
			let step: vec2f = cocFar * uniform.blurRadiusFar / farTextureSize;
			var sumCoC: f32 = 0.0;
			for (var i: i32 = 0; i < {KERNEL_COUNT}; i = i + 1) {
				let uv: vec2f = uv0 + step * uniform.kernel[i].element;
				var tap: vec3f = textureSampleLevel(farTexture, farTextureSampler, uv, 0.0).rgb;
				let cocThis: f32 = textureSampleLevel(cocTexture, cocTextureSampler, uv, 0.0).r;
				tap = tap * cocThis;
				sumCoC = sumCoC + cocThis;
				sum = sum + tap;
			}
			if (sumCoC > 0.0) {
				sum = sum / sumCoC;
			}
			sum = sum / cocFar;
		}
	output.color = vec4f(sum, 1.0);
	return output;
}
`});var fC,fse=m(()=>{rI();j();go();lse();cse();It();Dt();fC=class extends gs{constructor(e,t,s,i){super(e),this.blurRadiusNear=1,this.blurRadiusFar=1,this._blurRings=3,this._blurRingPoints=3,this.nearTexture=t,this.farTexture=s,this.cocTexture=i,ie.get(e,oe).set("dofBlurPS",ose),ie.get(e,le).set("dofBlurPS",hse);let{scope:r}=e;this.kernelId=r.resolve("kernel[0]"),this.kernelCountId=r.resolve("kernelCount"),this.blurRadiusNearId=r.resolve("blurRadiusNear"),this.blurRadiusFarId=r.resolve("blurRadiusFar"),this.nearTextureId=r.resolve("nearTexture"),this.farTextureId=r.resolve("farTexture"),this.cocTextureId=r.resolve("cocTexture")}set blurRings(e){this._blurRings!==e&&(this._blurRings=e,this.shader=null)}get blurRings(){return this._blurRings}set blurRingPoints(e){this._blurRingPoints!==e&&(this._blurRingPoints=e,this.shader=null)}get blurRingPoints(){return this._blurRingPoints}createShader(){this.kernel=new Float32Array(lu.concentric(this.blurRings,this.blurRingPoints));let e=this.kernel.length>>1,t=this.nearTexture!==null,s=new Map;s.set("{KERNEL_COUNT}",e),s.set("{INV_KERNEL_COUNT}",1/e),t&&s.set("NEAR_BLUR",""),this.shader=Te.createShader(this.device,{uniqueName:`DofBlurShader-${e}-${t?"nearBlur":"noNearBlur"}`,attributes:{aPosition:te},vertexChunk:"quadVS",fragmentChunk:"dofBlurPS",fragmentDefines:s})}execute(){this.shader||this.createShader(),this.nearTextureId.setValue(this.nearTexture),this.farTextureId.setValue(this.farTexture),this.cocTextureId.setValue(this.cocTexture),this.kernelId.setValue(this.kernel),this.kernelCountId.setValue(this.kernel.length>>1),this.blurRadiusNearId.setValue(this.blurRadiusNear),this.blurRadiusFarId.setValue(this.blurRadiusFar),super.execute()}}});var Mg,mO=m(()=>{De();Fe();Rt();us();dE();nse();fse();Mg=class extends Xe{constructor(e,t,s,i,r,a){super(e),this.focusDistance=100,this.focusRange=50,this.blurRadius=1,this.blurRings=3,this.blurRingPoints=3,this.highQuality=!0,this.cocTexture=null,this.blurTexture=null,this.cocPass=null,this.farPass=null,this.blurPass=null,this.highQuality=r,this.cocPass=this.setupCocPass(e,t,s,a),this.beforePasses.push(this.cocPass);let n=r?s:i;this.farPass=this.setupFarPass(e,n,.5),this.beforePasses.push(this.farPass),this.blurPass=this.setupBlurPass(e,i,a,r?2:.5),this.beforePasses.push(this.blurPass)}destroy(){this.destroyRenderPasses(),this.cocPass=null,this.farPass=null,this.blurPass=null,this.destroyRT(this.cocRT),this.destroyRT(this.farRt),this.destroyRT(this.blurRt),this.cocRT=null,this.farRt=null,this.blurRt=null}destroyRenderPasses(){for(let e=0;e<this.beforePasses.length;e++)this.beforePasses[e].destroy();this.beforePasses.length=0}destroyRT(e){e&&(e.destroyTextureBuffers(),e.destroy())}setupCocPass(e,t,s,i){let r=i?53:52;this.cocRT=this.createRenderTarget("CoCTexture",r),this.cocTexture=this.cocRT.colorBuffer;let a=new cC(e,t,i);return a.init(this.cocRT,{resizeSource:s}),a.setClearColor(N.BLACK),a}setupFarPass(e,t,s){this.farRt=this.createRenderTarget("FarDofTexture",t.format);let i=new wo(e,t,{boxFilter:!0,premultiplyTexture:this.cocTexture,premultiplySrcChannel:"r"});return i.init(this.farRt,{resizeSource:t,scaleX:s,scaleY:s}),i.setClearColor(N.BLACK),i}setupBlurPass(e,t,s,i){let r=this.farRt?.colorBuffer;this.blurRt=this.createRenderTarget("DofBlurTexture",t.format),this.blurTexture=this.blurRt.colorBuffer;let a=new fC(e,s?t:null,r,this.cocTexture);return a.init(this.blurRt,{resizeSource:t,scaleX:i,scaleY:i}),a.setClearColor(N.BLACK),a}createTexture(e,t){return new q(this.device,{name:e,width:1,height:1,format:t,mipmaps:!1,minFilter:1,magFilter:1,addressU:1,addressV:1})}createRenderTarget(e,t){return new xe({colorBuffer:this.createTexture(e,t),depth:!1,stencil:!1})}frameUpdate(){super.frameUpdate(),this.cocPass.focusDistance=this.focusDistance,this.cocPass.focusRange=this.focusRange,this.blurPass.blurRadiusNear=this.blurRadius,this.blurPass.blurRadiusFar=this.blurRadius*(this.highQuality?1:.5),this.blurPass.blurRings=this.blurRings,this.blurPass.blurRingPoints=this.blurRingPoints}}});var pO,sce,Dg,_O=m(()=>{Fe();us();Rt();J();De();$l();pO=[],sce="uSceneDepthMap",Dg=class extends Xe{constructor(e,t,s,i,r){super(e),this.viewBindGroups=[],this.linearDepthClearValue=new N(0,0,0,0),this.scene=t,this.renderer=s,this.camera=i,this.setupRenderTarget(r)}destroy(){super.destroy(),this.renderTarget?.destroy(),this.renderTarget=null,this.linearDepthTexture?.destroy(),this.linearDepthTexture=null,this.viewBindGroups.forEach(e=>{e.defaultUniformBuffer.destroy(),e.destroy()}),this.viewBindGroups.length=0}setupRenderTarget(e){let{device:t}=this;this.linearDepthFormat=t.textureFloatRenderable?15:7,this.linearDepthTexture=new q(t,{name:"SceneLinearDepthTexture",width:1,height:1,format:this.linearDepthFormat,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1});let s=new xe({name:"PrepassRT",colorBuffer:this.linearDepthTexture,depth:!0,samples:1});this.camera.shaderParams.sceneDepthMapLinear=!0,this.init(s,e)}after(){this.device.scope.resolve(sce).setValue(this.linearDepthTexture)}execute(){let{renderer:e,scene:t,renderTarget:s}=this,i=this.camera.camera,r=t.layers.layerList,a=t.layers.subLayerEnabled,n=t.layers.subLayerList;for(let l=0;l<r.length;l++){let h=r[l];if(h.id===Xt)break;if(h.enabled&&a[l]&&h.camerasSet.has(i)){let c=h.getCulledInstances(i),f=n[l]?c.transparent:c.opaque;for(let d=0;d<f.length;d++){let u=f[d];u.material?.depthWrite&&pO.push(u)}e.renderForwardLayer(i,s,null,void 0,ga,this.viewBindGroups,{meshInstances:pO}),pO.length=0}}}frameUpdate(){super.frameUpdate();let{camera:e}=this;this.setClearDepth(e.clearDepthBuffer?1:void 0);let t;if(e.clearDepthBuffer){let s=e.farClip-Number.MIN_VALUE;t=this.linearDepthClearValue,this.linearDepthFormat===15?t.r=s:Bs.float2RGBA8(s,t)}this.setClearColor(t)}}});var dse,use=m(()=>{dse=`
	#include "screenDepthPS"
	varying vec2 uv0;
	uniform sampler2D sourceTexture;
	uniform vec2 sourceInvResolution;
	uniform int filterSize;
	float random(const highp vec2 w) {
		const vec3 m = vec3(0.06711056, 0.00583715, 52.9829189);
		return fract(m.z * fract(dot(w, m.xy)));
	}
	mediump float bilateralWeight(in mediump float depth, in mediump float sampleDepth) {
		mediump float diff = (sampleDepth - depth);
		return max(0.0, 1.0 - diff * diff);
	}
	void tap(inout float sum, inout float totalWeight, float weight, float depth, vec2 position) {
		mediump float color = texture2D(sourceTexture, position).r;
		mediump float textureDepth = -getLinearScreenDepth(position);
	
		mediump float bilateral = bilateralWeight(depth, textureDepth);
		bilateral *= weight;
		sum += color * bilateral;
		totalWeight += bilateral;
	}
	void main() {
		mediump float depth = -getLinearScreenDepth(uv0);
		mediump float totalWeight = 1.0;
		mediump float color = texture2D(sourceTexture, uv0 ).r;
		mediump float sum = color * totalWeight;
		for (mediump int i = -filterSize; i <= filterSize; i++) {
			mediump float weight = 1.0;
			#ifdef HORIZONTAL
				vec2 offset = vec2(i, 0) * sourceInvResolution;
			#else
				vec2 offset = vec2(0, i) * sourceInvResolution;
			#endif
			tap(sum, totalWeight, weight, depth, uv0 + offset);
		}
		mediump float ao = sum / totalWeight;
		gl_FragColor.r = ao;
	}
`});var mse,pse=m(()=>{mse=`
#include "screenDepthPS"
varying uv0: vec2f;
var sourceTexture: texture_2d<f32>;
var sourceTextureSampler: sampler;
uniform sourceInvResolution: vec2f;
uniform filterSize: i32;
fn random(w: vec2f) -> f32 {
	const m: vec3f = vec3f(0.06711056, 0.00583715, 52.9829189);
	return fract(m.z * fract(dot(w, m.xy)));
}
fn bilateralWeight(depth: f32, sampleDepth: f32) -> f32 {
	let diff: f32 = (sampleDepth - depth);
	return max(0.0, 1.0 - diff * diff);
}
fn tap(sum_ptr: ptr<function, f32>, totalWeight_ptr: ptr<function, f32>, weight: f32, depth: f32, position: vec2f) {
	let color: f32 = textureSample(sourceTexture, sourceTextureSampler, position).r;
	let textureDepth: f32 = -getLinearScreenDepth(position);
	let bilateral: f32 = bilateralWeight(depth, textureDepth) * weight;
	*sum_ptr = *sum_ptr + color * bilateral;
	*totalWeight_ptr = *totalWeight_ptr + bilateral;
}
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	let depth: f32 = -getLinearScreenDepth(input.uv0);
	var totalWeight: f32 = 1.0;
	let color: f32 = textureSample(sourceTexture, sourceTextureSampler, input.uv0 ).r;
	var sum: f32 = color * totalWeight;
	for (var i: i32 = -uniform.filterSize; i <= uniform.filterSize; i = i + 1) {
		let weight: f32 = 1.0;
		#ifdef HORIZONTAL
			var offset: vec2f = vec2f(f32(i), 0.0) * uniform.sourceInvResolution;
		#else
			var offset: vec2f = vec2f(0.0, f32(i)) * uniform.sourceInvResolution;
		#endif
		tap(&sum, &totalWeight, weight, depth, input.uv0 + offset);
	}
	let ao: f32 = sum / totalWeight;
	output.color = vec4f(ao, ao, ao, 1.0);
	return output;
}
`});var Gd,gO=m(()=>{j();go();Dt();use();pse();It();Gd=class extends gs{constructor(e,t,s,i){super(e),this.sourceTexture=t,ie.get(e,oe).set("depthAwareBlurPS",dse),ie.get(e,le).set("depthAwareBlurPS",mse);let r=new Map;i&&r.set("HORIZONTAL",""),Te.addScreenDepthChunkDefines(e,s.shaderParams,r),this.shader=Te.createShader(e,{uniqueName:`DepthAware${i?"Horizontal":"Vertical"}BlurShader`,attributes:{aPosition:te},vertexChunk:"quadVS",fragmentChunk:"depthAwareBlurPS",fragmentDefines:r});let a=this.device.scope;this.sourceTextureId=a.resolve("sourceTexture"),this.sourceInvResolutionId=a.resolve("sourceInvResolution"),this.sourceInvResolutionValue=new Float32Array(2),this.filterSizeId=a.resolve("filterSize")}execute(){this.filterSizeId.setValue(4),this.sourceTextureId.setValue(this.sourceTexture);let{width:e,height:t}=this.sourceTexture;this.sourceInvResolutionValue[0]=1/e,this.sourceInvResolutionValue[1]=1/t,this.sourceInvResolutionId.setValue(this.sourceInvResolutionValue),super.execute()}}});var _se,gse=m(()=>{_se=`
	#include "screenDepthPS"
	
	varying vec2 uv0;
	uniform vec2 uInvResolution;
	uniform float uAspect;
	#define saturate(x) clamp(x,0.0,1.0)
	highp float getWFromProjectionMatrix(const mat4 p, const vec3 v) {
		return -v.z;
	}
	highp float getViewSpaceZFromW(const mat4 p, const float w) {
		return -w;
	}
	const float kLog2LodRate = 3.0;
	float random(const highp vec2 w) {
		const vec3 m = vec3(0.06711056, 0.00583715, 52.9829189);
		return fract(m.z * fract(dot(w, m.xy)));
	}
	highp vec2 getFragCoord() {
		return gl_FragCoord.xy;
	}
	highp vec3 computeViewSpacePositionFromDepth(highp vec2 uv, highp float linearDepth) {
		return vec3((0.5 - uv) * vec2(uAspect, 1.0) * linearDepth, linearDepth);
	}
	highp vec3 faceNormal(highp vec3 dpdx, highp vec3 dpdy) {
		return normalize(cross(dpdx, dpdy));
	}
	highp vec3 computeViewSpaceNormal(const highp vec3 position) {
		return faceNormal(dFdx(position), dFdy(position));
	}
	highp vec3 computeViewSpaceNormal(const highp vec3 position, const highp vec2 uv) {
		highp vec2 uvdx = uv + vec2(uInvResolution.x, 0.0);
		highp vec2 uvdy = uv + vec2(0.0, uInvResolution.y);
		highp vec3 px = computeViewSpacePositionFromDepth(uvdx, -getLinearScreenDepth(uvdx));
		highp vec3 py = computeViewSpacePositionFromDepth(uvdy, -getLinearScreenDepth(uvdy));
		highp vec3 dpdx = px - position;
		highp vec3 dpdy = py - position;
		return faceNormal(dpdx, dpdy);
	}
	uniform vec2 uSampleCount;
	uniform float uSpiralTurns;
	#define PI (3.14159)
	mediump vec3 tapLocation(mediump float i, const mediump float noise) {
		mediump float offset = ((2.0 * PI) * 2.4) * noise;
		mediump float angle = ((i * uSampleCount.y) * uSpiralTurns) * (2.0 * PI) + offset;
		mediump float radius = (i + noise + 0.5) * uSampleCount.y;
		return vec3(cos(angle), sin(angle), radius * radius);
	}
	highp vec2 startPosition(const float noise) {
		float angle = ((2.0 * PI) * 2.4) * noise;
		return vec2(cos(angle), sin(angle));
	}
	uniform vec2 uAngleIncCosSin;
	highp mat2 tapAngleStep() {
		highp vec2 t = uAngleIncCosSin;
		return mat2(t.x, t.y, -t.y, t.x);
	}
	mediump vec3 tapLocationFast(mediump float i, mediump vec2 p, const mediump float noise) {
		mediump float radius = (i + noise + 0.5) * uSampleCount.y;
		return vec3(p, radius * radius);
	}
	uniform float uMaxLevel;
	uniform float uInvRadiusSquared;
	uniform float uMinHorizonAngleSineSquared;
	uniform float uBias;
	uniform float uPeak2;
	void computeAmbientOcclusionSAO(inout mediump float occlusion, mediump float i, mediump float ssDiskRadius,
			const highp vec2 uv, const highp vec3 origin, const mediump vec3 normal,
			const mediump vec2 tapPosition, const float noise) {
		mediump vec3 tap = tapLocationFast(i, tapPosition, noise);
		mediump float ssRadius = max(1.0, tap.z * ssDiskRadius);
		mediump vec2 uvSamplePos = uv + vec2(ssRadius * tap.xy) * uInvResolution;
		mediump float level = clamp(floor(log2(ssRadius)) - kLog2LodRate, 0.0, float(uMaxLevel));
		highp float occlusionDepth = -getLinearScreenDepth(uvSamplePos);
		highp vec3 p = computeViewSpacePositionFromDepth(uvSamplePos, occlusionDepth);
		vec3 v = p - origin;
		float vv = dot(v, v);
		float vn = dot(v, normal);
		mediump float w = max(0.0, 1.0 - vv * uInvRadiusSquared);
		w = w * w;
		w *= step(vv * uMinHorizonAngleSineSquared, vn * vn);
		occlusion += w * max(0.0, vn + origin.z * uBias) / (vv + uPeak2);
	}
	uniform float uProjectionScaleRadius;
	uniform float uIntensity;
	uniform float uRandomize;
	float scalableAmbientObscurance(highp vec2 uv, highp vec3 origin, vec3 normal) {
		float noise = random(getFragCoord()) + uRandomize;
		highp vec2 tapPosition = startPosition(noise);
		highp mat2 angleStep = tapAngleStep();
		float ssDiskRadius = -(uProjectionScaleRadius / origin.z);
		float occlusion = 0.0;
		for (float i = 0.0; i < uSampleCount.x; i += 1.0) {
			computeAmbientOcclusionSAO(occlusion, i, ssDiskRadius, uv, origin, normal, tapPosition, noise);
			tapPosition = angleStep * tapPosition;
		}
		return occlusion;
	}
	uniform float uPower;
	void main() {
		highp vec2 uv = uv0;
		highp float depth = -getLinearScreenDepth(uv0);
		highp vec3 origin = computeViewSpacePositionFromDepth(uv, depth);
		vec3 normal = computeViewSpaceNormal(origin, uv);
		float occlusion = 0.0;
		if (uIntensity > 0.0) {
			occlusion = scalableAmbientObscurance(uv, origin, normal);
		}
		float ao = max(0.0, 1.0 - occlusion * uIntensity);
		ao = pow(ao, uPower);
		gl_FragColor = vec4(ao, ao, ao, 1.0);
	}
`});var Sse,Tse=m(()=>{Sse=`
	#include "screenDepthPS"
	varying uv0: vec2f;
	uniform uInvResolution: vec2f;
	uniform uAspect: f32;
	fn getWFromProjectionMatrix(p: mat4x4f, v: vec3f) -> f32 {
		return -v.z;
	}
	fn getViewSpaceZFromW(p: mat4x4f, w: f32) -> f32 {
		return -w;
	}
	const kLog2LodRate: f32 = 3.0;
	fn random(w: vec2f) -> f32 {
		const m: vec3f = vec3f(0.06711056, 0.00583715, 52.9829189);
		return fract(m.z * fract(dot(w, m.xy)));
	}
	fn getFragCoord() -> vec2f {
		return pcPosition.xy;
	}
	fn computeViewSpacePositionFromDepth(uv: vec2f, linearDepth: f32) -> vec3f {
		return vec3f((0.5 - uv) * vec2f(uniform.uAspect, 1.0) * linearDepth, linearDepth);
	}
	fn faceNormal(dpdx: vec3f, dpdy: vec3f) -> vec3f {
		return normalize(cross(dpdx, dpdy));
	}
	fn computeViewSpaceNormalDeriv(position: vec3f) -> vec3f {
		return faceNormal(dpdx(position), dpdy(position));
	}
	fn computeViewSpaceNormalDepth(position: vec3f, uv: vec2f) -> vec3f {
		let uvdx: vec2f = uv + vec2f(uniform.uInvResolution.x, 0.0);
		let uvdy: vec2f = uv + vec2f(0.0, uniform.uInvResolution.y);
		let px: vec3f = computeViewSpacePositionFromDepth(uvdx, -getLinearScreenDepth(uvdx));
		let py: vec3f = computeViewSpacePositionFromDepth(uvdy, -getLinearScreenDepth(uvdy));
		let dpdx: vec3f = px - position;
		let dpdy: vec3f = py - position;
		return faceNormal(dpdx, dpdy);
	}
	uniform uSampleCount: vec2f;
	uniform uSpiralTurns: f32;
	const PI: f32 = 3.14159;
	fn tapLocation(i: f32, noise: f32) -> vec3f {
		let offset: f32 = ((2.0 * PI) * 2.4) * noise;
		let angle: f32 = ((i * uniform.uSampleCount.y) * uniform.uSpiralTurns) * (2.0 * PI) + offset;
		let radius: f32 = (i + noise + 0.5) * uniform.uSampleCount.y;
		return vec3f(cos(angle), sin(angle), radius * radius);
	}
	fn startPosition(noise: f32) -> vec2f {
		let angle: f32 = ((2.0 * PI) * 2.4) * noise;
		return vec2f(cos(angle), sin(angle));
	}
	uniform uAngleIncCosSin: vec2f;
	fn tapAngleStep() -> mat2x2f {
		let t: vec2f = uniform.uAngleIncCosSin;
		return mat2x2f(vec2f(t.x, t.y), vec2f(-t.y, t.x));
	}
	fn tapLocationFast(i: f32, p: vec2f, noise_in: f32) -> vec3f {
		let radius: f32 = (i + noise_in + 0.5) * uniform.uSampleCount.y;
		return vec3f(p.x, p.y, radius * radius);
	}
	uniform uMaxLevel: f32;
	uniform uInvRadiusSquared: f32;
	uniform uMinHorizonAngleSineSquared: f32;
	uniform uBias: f32;
	uniform uPeak2: f32;
	fn computeAmbientOcclusionSAO(occlusion_ptr: ptr<function, f32>, i: f32, ssDiskRadius: f32,
			uv: vec2f, origin: vec3f, normal: vec3f,
			tapPosition: vec2f, noise: f32) {
		let tap: vec3f = tapLocationFast(i, tapPosition, noise);
		let ssRadius: f32 = max(1.0, tap.z * ssDiskRadius);
		let uvSamplePos: vec2f = uv + (ssRadius * tap.xy) * uniform.uInvResolution;
		let level: f32 = clamp(floor(log2(ssRadius)) - kLog2LodRate, 0.0, uniform.uMaxLevel);
		let occlusionDepth: f32 = -getLinearScreenDepth(uvSamplePos);
		let p: vec3f = computeViewSpacePositionFromDepth(uvSamplePos, occlusionDepth);
		let v: vec3f = p - origin;
		let vv: f32 = dot(v, v);
		let vn: f32 = dot(v, normal);
		var w_val: f32 = max(0.0, 1.0 - vv * uniform.uInvRadiusSquared);
		w_val = w_val * w_val;
		w_val = w_val * step(vv * uniform.uMinHorizonAngleSineSquared, vn * vn);
		*occlusion_ptr = *occlusion_ptr + w_val * max(0.0, vn + origin.z * uniform.uBias) / (vv + uniform.uPeak2);
	}
	uniform uProjectionScaleRadius: f32;
	uniform uIntensity: f32;
	uniform uRandomize: f32;
	fn scalableAmbientObscurance(uv: vec2f, origin: vec3f, normal: vec3f) -> f32 {
		let noise: f32 = random(getFragCoord()) + uniform.uRandomize;
		var tapPosition: vec2f = startPosition(noise);
		let angleStep: mat2x2f = tapAngleStep();
		let ssDiskRadius: f32 = -(uniform.uProjectionScaleRadius / origin.z);
		var occlusion: f32 = 0.0;
		for (var i: i32 = 0; i < i32(uniform.uSampleCount.x); i = i + 1) {
			computeAmbientOcclusionSAO(&occlusion, f32(i), ssDiskRadius, uv, origin, normal, tapPosition, noise);
			tapPosition = angleStep * tapPosition;
		}
		return occlusion;
	}
	uniform uPower: f32;
	@fragment
	fn fragmentMain(input: FragmentInput) -> FragmentOutput {
		var output: FragmentOutput;
		let uv: vec2f = input.uv0;
		let depth: f32 = -getLinearScreenDepth(input.uv0);
		let origin: vec3f = computeViewSpacePositionFromDepth(uv, depth);
		let normal: vec3f = computeViewSpaceNormalDepth(origin, uv);
		var occlusion: f32 = 0.0;
		if (uniform.uIntensity > 0.0) {
			occlusion = scalableAmbientObscurance(uv, origin, normal);
		}
		var ao: f32 = max(0.0, 1.0 - occlusion * uniform.uIntensity);
		ao = pow(ao, uniform.uPower);
		output.color = vec4f(ao, ao, ao, 1.0);
		return output;
	}
`});var Og,SO=m(()=>{Xy();De();j();Rt();Fe();go();gO();It();Dt();gse();Tse();Og=class extends gs{constructor(e,t,s,i){super(e),this.radius=5,this.intensity=1,this.power=1,this.sampleCount=10,this.minAngle=5,this.randomize=!1,this._scale=1,this._blueNoise=new Gm(19),this.sourceTexture=t,this.cameraComponent=s,ie.get(e,oe).set("ssaoPS",_se),ie.get(e,le).set("ssaoPS",Sse);let r=new Map;Te.addScreenDepthChunkDefines(e,s.shaderParams,r),this.shader=Te.createShader(e,{uniqueName:"SsaoShader",attributes:{aPosition:te},vertexChunk:"quadVS",fragmentChunk:"ssaoPS",fragmentDefines:r});let a=this.createRenderTarget("SsaoFinalTexture");this.ssaoTexture=a.colorBuffer,this.init(a,{resizeSource:this.sourceTexture});let n=new N(0,0,0,0);if(this.setClearColor(n),i){let l=this.createRenderTarget("SsaoTempTexture"),h=new Gd(e,a.colorBuffer,s,!0);h.init(l,{resizeSource:a.colorBuffer}),h.setClearColor(n);let c=new Gd(e,l.colorBuffer,s,!1);c.init(a,{resizeSource:a.colorBuffer}),c.setClearColor(n),this.afterPasses.push(h),this.afterPasses.push(c)}this.ssaoTextureId=e.scope.resolve("ssaoTexture"),this.ssaoTextureSizeInvId=e.scope.resolve("ssaoTextureSizeInv")}destroy(){if(this.renderTarget?.destroyTextureBuffers(),this.renderTarget?.destroy(),this.renderTarget=null,this.afterPasses.length>0){let e=this.afterPasses[0].renderTarget;e?.destroyTextureBuffers(),e?.destroy()}this.afterPasses.forEach(e=>e.destroy()),this.afterPasses.length=0,super.destroy()}set scale(e){this._scale=e,this.scaleX=e,this.scaleY=e}get scale(){return this._scale}createRenderTarget(e){return new xe({depth:!1,colorBuffer:new q(this.device,{name:e,width:1,height:1,format:52,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1})})}execute(){let{device:e,sourceTexture:t,sampleCount:s,minAngle:i,scale:r}=this,{width:a,height:n}=this.renderTarget.colorBuffer,l=e.scope;l.resolve("uAspect").setValue(a/n),l.resolve("uInvResolution").setValue([1/a,1/n]),l.resolve("uSampleCount").setValue([s,1/s]);let h=Math.sin(i*Math.PI/180);l.resolve("uMinHorizonAngleSineSquared").setValue(h*h);let c=10,f=1/(s-.5)*c*2*3.141,d=this.radius/r,u=.001,p=.1*d,_=2*(p*2*3.141)*this.intensity/s,S=.5*t.height;l.resolve("uSpiralTurns").setValue(c),l.resolve("uAngleIncCosSin").setValue([Math.cos(f),Math.sin(f)]),l.resolve("uMaxLevel").setValue(0),l.resolve("uInvRadiusSquared").setValue(1/(d*d)),l.resolve("uBias").setValue(u),l.resolve("uPeak2").setValue(p*p),l.resolve("uIntensity").setValue(_),l.resolve("uPower").setValue(this.power),l.resolve("uProjectionScaleRadius").setValue(S*d),l.resolve("uRandomize").setValue(this.randomize?this._blueNoise.value():0),super.execute()}after(){this.ssaoTextureId.setValue(this.ssaoTexture);let e=this.sourceTexture;this.ssaoTextureSizeInvId.setValue([1/e.width,1/e.height])}}});var zd,ice,Ng,TO=m(()=>{J();Fe();us();Ny();aA();Rt();fO();dO();uO();mO();_O();SO();hC();dE();De();zd=class{constructor(){this.stencil=!1,this.samples=1,this.sceneColorMap=!1,this.lastGrabLayerId=to,this.lastGrabLayerIsTransparent=!1,this.lastSceneLayerId=so,this.lastSceneLayerIsTransparent=!0,this.taaEnabled=!1,this.bloomEnabled=!1,this.ssaoType=Io,this.ssaoBlurEnabled=!0,this.prepassEnabled=!1,this.dofEnabled=!1,this.dofNearBlur=!1,this.dofHighQuality=!0}},ice=new zd,Ng=class extends Xe{constructor(e,t,s,i={}){super(e.graphicsDevice),this._renderTargetScale=1,this.layersDirty=!1,this.rt=null,this.app=e,this.cameraComponent=s,this.cameraFrame=t,this.options=this.sanitizeOptions(i),this.setupRenderPasses(this.options)}destroy(){this.reset()}reset(){this.sceneTexture=null,this.sceneTextureHalf=null,this.rt&&(this.rt.destroyTextureBuffers(),this.rt.destroy(),this.rt=null),this.rtHalf&&(this.rtHalf.destroyTextureBuffers(),this.rtHalf.destroy(),this.rtHalf=null),this.beforePasses.forEach(e=>e.destroy()),this.beforePasses.length=0,this.prePass=null,this.scenePass=null,this.scenePassTransparent=null,this.colorGrabPass=null,this.composePass=null,this.bloomPass=null,this.ssaoPass=null,this.taaPass=null,this.afterPass=null,this.scenePassHalf=null,this.dofPass=null}sanitizeOptions(e){return e=Object.assign({},ice,e),(e.taaEnabled||e.ssaoType!==Io||e.dofEnabled)&&(e.prepassEnabled=!0),e}set renderTargetScale(e){this._renderTargetScale=e,this.scenePass&&(this.scenePass.scaleX=e,this.scenePass.scaleY=e)}get renderTargetScale(){return this._renderTargetScale}needsReset(e){let t=this.options,s=(i,r)=>i!==r&&(!(Array.isArray(i)&&Array.isArray(r))||i.length!==r.length||!i.every((a,n)=>a===r[n]));return e.ssaoType!==t.ssaoType||e.ssaoBlurEnabled!==t.ssaoBlurEnabled||e.taaEnabled!==t.taaEnabled||e.samples!==t.samples||e.stencil!==t.stencil||e.bloomEnabled!==t.bloomEnabled||e.prepassEnabled!==t.prepassEnabled||e.sceneColorMap!==t.sceneColorMap||e.dofEnabled!==t.dofEnabled||e.dofNearBlur!==t.dofNearBlur||e.dofHighQuality!==t.dofHighQuality||s(e.formats,t.formats)}update(e){e=this.sanitizeOptions(e),(this.needsReset(e)||this.layersDirty)&&(this.layersDirty=!1,this.reset()),this.options=e,this.sceneTexture||this.setupRenderPasses(this.options)}createRenderTarget(e,t,s,i,r){let a=new q(this.device,{name:e,width:4,height:4,format:this.hdrFormat,mipmaps:!1,minFilter:1,magFilter:1,addressU:1,addressV:1});return new xe({colorBuffer:a,depth:t,stencil:s,samples:i,flipY:r})}setupRenderPasses(e){let{device:t}=this,s=this.cameraComponent,i=s.renderTarget;this.hdrFormat=t.getRenderableHdrFormat(e.formats,!0,e.samples)||7,this._bloomEnabled=e.bloomEnabled&&this.hdrFormat!==7,this._sceneHalfEnabled=this._bloomEnabled||e.dofEnabled,s.shaderParams.ssaoEnabled=e.ssaoType===oC;let r=!!i?.flipY;this.rt=this.createRenderTarget("SceneColor",!0,e.stencil,e.samples,r),this.sceneTexture=this.rt.colorBuffer,this._sceneHalfEnabled&&(this.rtHalf=this.createRenderTarget("SceneColorHalf",!1,!1,1,r),this.sceneTextureHalf=this.rtHalf.colorBuffer),this.sceneOptions={resizeSource:i,scaleX:this.renderTargetScale,scaleY:this.renderTargetScale},this.createPasses(e);let a=this.collectPasses();this.beforePasses=a.filter(n=>n!=null)}collectPasses(){return[this.prePass,this.ssaoPass,this.scenePass,this.colorGrabPass,this.scenePassTransparent,this.taaPass,this.scenePassHalf,this.bloomPass,this.dofPass,this.composePass,this.afterPass]}createPasses(e){this.setupScenePrepass(e),this.setupSsaoPass(e);let t=this.setupScenePass(e),s=this.setupTaaPass(e);this.setupSceneHalfPass(e,s),this.setupBloomPass(e,this.sceneTextureHalf),this.setupDofPass(e,this.sceneTexture,this.sceneTextureHalf),this.setupComposePass(e),this.setupAfterPass(e,t)}setupScenePrepass(e){if(e.prepassEnabled){let{app:t,device:s,cameraComponent:i}=this,{scene:r,renderer:a}=t;this.prePass=new Dg(s,r,a,i,this.sceneOptions)}}setupScenePassSettings(e){e.gammaCorrection=Mi,e.toneMapping=Ah}setupScenePass(e){let{app:t,device:s,cameraComponent:i}=this,{scene:r,renderer:a}=t,n=r.layers;this.scenePass=new mo(s,n,r,a),this.setupScenePassSettings(this.scenePass),this.scenePass.init(this.rt,this.sceneOptions);let l=e.sceneColorMap?e.lastGrabLayerId:e.lastSceneLayerId,h=e.sceneColorMap?e.lastGrabLayerIsTransparent:e.lastSceneLayerIsTransparent,c={lastAddedIndex:0,clearRenderTarget:!0};return c.lastAddedIndex=this.scenePass.addLayers(n,i,c.lastAddedIndex,c.clearRenderTarget,l,h),c.clearRenderTarget=!1,e.sceneColorMap&&(this.colorGrabPass=new kh(s),this.colorGrabPass.source=this.rt,this.scenePassTransparent=new mo(s,n,r,a),this.setupScenePassSettings(this.scenePassTransparent),this.scenePassTransparent.init(this.rt),c.lastAddedIndex=this.scenePassTransparent.addLayers(n,i,c.lastAddedIndex,c.clearRenderTarget,e.lastSceneLayerId,e.lastSceneLayerIsTransparent),this.scenePassTransparent.rendersAnything||(this.scenePassTransparent.destroy(),this.scenePassTransparent=null),this.scenePassTransparent&&e.prepassEnabled&&(this.scenePassTransparent.depthStencilOps.storeDepth=!0)),c}setupSsaoPass(e){let{ssaoBlurEnabled:t,ssaoType:s}=e,{device:i,cameraComponent:r}=this;s!==Io&&(this.ssaoPass=new Og(i,this.sceneTexture,r,t))}setupSceneHalfPass(e,t){this._sceneHalfEnabled&&(this.scenePassHalf=new wo(this.device,this.sceneTexture,{boxFilter:!0,removeInvalid:!0}),this.scenePassHalf.name="RenderPassSceneHalf",this.scenePassHalf.init(this.rtHalf,{resizeSource:t,scaleX:.5,scaleY:.5}),this.scenePassHalf.setClearColor(N.BLACK))}setupBloomPass(e,t){this._bloomEnabled&&(this.bloomPass=new wg(this.device,t,this.hdrFormat))}setupDofPass(e,t,s){e.dofEnabled&&(this.dofPass=new Mg(this.device,this.cameraComponent,t,s,e.dofHighQuality,e.dofNearBlur))}setupTaaPass(e){let t=this.sceneTexture;return e.taaEnabled&&(this.taaPass=new bg(this.device,this.sceneTexture,this.cameraComponent),t=this.taaPass.historyTexture),t}setupComposePass(e){this.composePass=new Lg(this.device),this.composePass.bloomTexture=this.bloomPass?.bloomTexture,this.composePass.taaEnabled=e.taaEnabled,this.composePass.cocTexture=this.dofPass?.cocTexture,this.composePass.blurTexture=this.dofPass?.blurTexture,this.composePass.blurTextureUpscale=!this.dofPass?.highQuality;let s=this.cameraComponent.renderTarget;this.composePass.init(s),this.composePass.ssaoTexture=e.ssaoType===lC?this.ssaoPass.ssaoTexture:null}setupAfterPass(e,t){let{app:s,cameraComponent:i}=this,{scene:r,renderer:a}=s,n=r.layers,l=i.renderTarget;this.afterPass=new mo(this.device,n,r,a),this.afterPass.init(l),this.afterPass.addLayers(n,i,t.lastAddedIndex,t.clearRenderTarget)}frameUpdate(){this.layersDirty&&this.cameraFrame.update(),super.frameUpdate();let e=this.taaPass?.update()??this.rt.colorBuffer;this.composePass.sceneTexture=e,this.scenePassHalf?.setSourceTexture(e)}}});var dC,Ese=m(()=>{De();me();hC();TO();dC=class{constructor(e,t){this._enabled=!0,this.rendering={renderFormats:[18,12,14],stencil:!1,renderTargetScale:1,samples:1,sceneColorMap:!1,sceneDepthMap:!1,toneMapping:0,sharpness:0},this.ssao={type:Io,blurEnabled:!0,randomize:!1,intensity:.5,radius:30,samples:12,power:6,minAngle:10,scale:1},this.bloom={intensity:0,blurLevel:16},this.grading={enabled:!1,brightness:1,contrast:1,saturation:1,tint:new N(1,1,1,1)},this.colorLUT={texture:null,intensity:1},this.vignette={intensity:0,inner:.5,outer:1,curvature:.5},this.taa={enabled:!1,jitter:1},this.fringing={intensity:0},this.dof={enabled:!1,nearBlur:!1,focusDistance:100,focusRange:10,blurRadius:3,blurRings:4,blurRingPoints:5,highQuality:!0},this.debug=null,this.options=new zd,this.renderPassCamera=null,this.app=e,this.cameraComponent=t,this.updateOptions(),this.enable(),this.cameraLayersChanged=t.on("set:layers",()=>{this.renderPassCamera&&(this.renderPassCamera.layersDirty=!0)})}destroy(){this.disable(),this.cameraLayersChanged.off()}enable(){this.renderPassCamera=this.createRenderPass(),this.cameraComponent.renderPasses=[this.renderPassCamera]}disable(){let e=this.cameraComponent;e.renderPasses?.forEach(t=>{t.destroy()}),e.renderPasses=[],e.rendering=null,e.jitter=0,e.shaderParams.ssaoEnabled=!1,this.renderPassCamera=null}createRenderPass(){return new Ng(this.app,this,this.cameraComponent,this.options)}set enabled(e){this._enabled!==e&&(e?this.enable():this.disable(),this._enabled=e)}get enabled(){return this._enabled}updateOptions(){let{options:e,rendering:t,bloom:s,taa:i,ssao:r}=this;e.stencil=t.stencil,e.samples=t.samples,e.sceneColorMap=t.sceneColorMap,e.prepassEnabled=t.sceneDepthMap,e.bloomEnabled=s.intensity>0,e.taaEnabled=i.enabled,e.ssaoType=r.type,e.ssaoBlurEnabled=r.blurEnabled,e.formats=t.renderFormats.slice(),e.dofEnabled=this.dof.enabled,e.dofNearBlur=this.dof.nearBlur,e.dofHighQuality=this.dof.highQuality}update(){if(!this._enabled)return;let e=this.cameraComponent,{options:t,renderPassCamera:s,rendering:i,bloom:r,grading:a,vignette:n,fringing:l,taa:h,ssao:c}=this;this.updateOptions(),s.update(t);let{composePass:f,bloomPass:d,ssaoPass:u,dofPass:p}=s;s.renderTargetScale=w.clamp(i.renderTargetScale,.1,1),f.toneMapping=i.toneMapping,f.sharpness=i.sharpness,t.bloomEnabled&&d&&(f.bloomIntensity=r.intensity,d.blurLevel=r.blurLevel),t.dofEnabled&&(p.focusDistance=this.dof.focusDistance,p.focusRange=this.dof.focusRange,p.blurRadius=this.dof.blurRadius,p.blurRings=this.dof.blurRings,p.blurRingPoints=this.dof.blurRingPoints),t.ssaoType!==Io&&(u.intensity=c.intensity,u.power=c.power,u.radius=c.radius,u.sampleCount=c.samples,u.minAngle=c.minAngle,u.scale=c.scale,u.randomize=c.randomize),f.gradingEnabled=a.enabled,a.enabled&&(f.gradingSaturation=a.saturation,f.gradingBrightness=a.brightness,f.gradingContrast=a.contrast,f.gradingTint=a.tint),f.colorLUT=this.colorLUT.texture,f.colorLUTIntensity=this.colorLUT.intensity,f.vignetteEnabled=n.intensity>0,f.vignetteEnabled&&(f.vignetteInner=n.inner,f.vignetteOuter=n.outer,f.vignetteCurvature=n.curvature,f.vignetteIntensity=n.intensity),f.fringingEnabled=l.intensity>0,f.fringingEnabled&&(f.fringingIntensity=l.intensity),e.jitter=h.enabled?h.jitter:0,f.debug=this.debug,f.debug==="ssao"&&t.ssaoType===Io&&(f.debug=null),f.debug==="vignette"&&!f.vignetteEnabled&&(f.debug=null)}}});var rce,ace,Zs,Fg=m(()=>{me();Ve();Ne();Q();rce=new g,ace=new H,Zs=class o{constructor(e=g.ZERO,t=g.ZERO,s=0){this.position=new g,this.angles=new g,this.distance=0,this.pitchRange=new D(-1/0,1/0),this.yawRange=new D(-1/0,1/0),this.xRange=new D(-1/0,1/0),this.yRange=new D(-1/0,1/0),this.zRange=new D(-1/0,1/0),this.set(e,t,s)}copy(e){return this.set(e.position,e.angles,e.distance)}clone(){return new o(this.position.clone(),this.angles.clone(),this.distance)}equalsApprox(e,t=1e-6){return this.position.equalsApprox(e.position,t)&&this.angles.equalsApprox(e.angles,t)&&Math.abs(this.distance-e.distance)<t}lerp(e,t,s,i=s,r=s){return this.position.lerp(e.position,t.position,s),this.angles.x=w.lerpAngle(e.angles.x,t.angles.x,i)%360,this.angles.y=w.lerpAngle(e.angles.y,t.angles.y,i)%360,this.angles.z=w.lerpAngle(e.angles.z,t.angles.z,i)%360,this.distance=w.lerp(e.distance,t.distance,r),this}move(e){return this.position.add(e),this.position.x=w.clamp(this.position.x,this.xRange.x,this.xRange.y),this.position.y=w.clamp(this.position.y,this.yRange.x,this.yRange.y),this.position.z=w.clamp(this.position.z,this.zRange.x,this.zRange.y),this}rotate(e){return this.angles.add(e),this.angles.x%=360,this.angles.y%=360,this.angles.z%=360,this.angles.x=w.clamp(this.angles.x,this.pitchRange.x,this.pitchRange.y),this.angles.y=w.clamp(this.angles.y,this.yawRange.x,this.yawRange.y),this}set(e,t,s){return this.position.copy(e),this.angles.copy(t),this.distance=s,this}look(e,t){this.position.copy(e),this.distance=e.distance(t);let s=rce.sub2(t,e).normalize(),i=Math.atan2(-s.y,Math.sqrt(s.x*s.x+s.z*s.z))*w.RAD_TO_DEG,r=Math.atan2(-s.x,-s.z)*w.RAD_TO_DEG;return this.angles.set(-i,r,0),this}getFocus(e){return ace.setFromEulerAngles(this.angles).transformVector(g.FORWARD,e).mulScalar(this.distance).add(this.position)}}});var uE,mE,ur,pE,Lo,bo=m(()=>{Pe();Fg();uE=class{constructor(e){Array.isArray(e)?this._value=e.slice():this._value=new Array(+e).fill(0)}add(e){for(let t=0;t<this._value.length;t++)this._value[t]+=e._value[t]||0;return this}append(e){for(let t=0;t<this._value.length;t++)this._value[t]+=e[t]||0;return this}copy(e){for(let t=0;t<this._value.length;t++)this._value[t]=e._value[t]||0;return this}length(){let e=0;for(let t of this._value)e+=t*t;return Math.sqrt(e)}read(){let e=this._value.slice();return this._value.fill(0),e}},mE=class{constructor(e){this.deltas={};for(let t in e)this.deltas[t]=new uE(e[t])}read(){let e={};for(let t in this.deltas)e[t]=this.deltas[t].read();return e}},ur=class extends mE{on(e,t){this._events.on(e,t)}off(e,t){this._events.off(e,t)}fire(e,...t){this._events.fire(e,...t)}attach(e){this._element&&this.detach(),this._element=e}detach(){this._element&&(this._element=null,this.read())}destroy(){this.detach(),this._events.off()}constructor(...e){super(...e),this._element=null,this._events=new K}},pE=class{update(e,t){e.read()}},Lo=class extends pE{attach(e,t=!0){}detach(){}update(e,t){return super.update(e,t),this._pose}destroy(){this.detach()}constructor(...e){super(...e),this._pose=new Zs}}});var Hd,Xd,EO=m(()=>{me();Ne();Hd=new D,Xd=class{constructor({range:e}={}){this._range=70,this._position=new D,this._value=new D,this._range=e??this._range}get value(){return this._value}down(e,t){return this._position.set(e,t),this._value.set(0,0),[e,t,e,t]}move(e,t){Hd.set(e-this._position.x,t-this._position.y),Hd.length()>this._range&&Hd.normalize().mulScalar(this._range),this._value.set(w.clamp(Hd.x/this._range,-1,1),w.clamp(Hd.y/this._range,-1,1));let{x:s,y:i}=this._position;return[s,i,s+Hd.x,i+Hd.y]}up(){return this._position.set(0,0),this._value.set(0,0),[-1,-1,-1,-1]}}});var uC,vse=m(()=>{bo();EO();uC=class extends ur{constructor(){super({input:[0,0],doubleTap:[0]}),this._layout="joystick",this._pointerData=new Map,this._lastPointer={x:0,y:0,time:0},this._joystick=new Xd,this._onPointerDown=this._onPointerDown.bind(this),this._onPointerMove=this._onPointerMove.bind(this),this._onPointerUp=this._onPointerUp.bind(this)}set layout(e){this._layout!==e&&(this._layout=e,this.read(),this._pointerData.clear())}get layout(){return this._layout}get joystick(){return this._joystick}_onPointerDown(e){let{pointerType:t,pointerId:s,clientX:i,clientY:r}=e;if(t!=="touch")return;this._element?.setPointerCapture(s),this._pointerData.set(s,{x:i,y:r});let a=Date.now();(this._lastPointer.x-i)**2+(this._lastPointer.y-r)**2<100&&a-this._lastPointer.time<250&&this.deltas.doubleTap.append([1]),this._lastPointer.x=i,this._lastPointer.y=r,this._lastPointer.time=a,this._layout==="joystick"&&this.fire("joystick:position",this._joystick.down(i,r))}_onPointerMove(e){let{pointerType:t,pointerId:s,target:i,clientX:r,clientY:a,movementX:n,movementY:l}=e;if(t!=="touch"||i!==this._element)return;let h=this._pointerData.get(s);h&&(h.x=r,h.y=a,this._layout==="joystick"?this.fire("joystick:position",this._joystick.move(r,a)):this.deltas.input.append([n,l]))}_onPointerUp(e){let{pointerType:t,pointerId:s}=e;t!=="touch"||(this._element?.releasePointerCapture(s),!this._pointerData.get(s))||(this._pointerData.delete(s),this._layout==="joystick"&&this.fire("joystick:position",this._joystick.up()))}attach(e){super.attach(e),this._element=e,this._element.addEventListener("pointerdown",this._onPointerDown),this._element.addEventListener("pointermove",this._onPointerMove),this._element.addEventListener("pointerup",this._onPointerUp),this._element.addEventListener("pointercancel",this._onPointerUp)}detach(){this._element&&(this._element.removeEventListener("pointerdown",this._onPointerDown),this._element.removeEventListener("pointermove",this._onPointerMove),this._element.removeEventListener("pointerup",this._onPointerUp),this._element.removeEventListener("pointercancel",this._onPointerUp),this._pointerData.clear(),super.detach())}read(){return this.deltas.input.append([this._joystick.value.x,this._joystick.value.y]),super.read()}destroy(){this._joystick.up(),super.destroy()}}});var vO,xO,mC,xse=m(()=>{bo();EO();vO=(o,e)=>o.indexOf(e)===0,xO=(o,e)=>o.indexOf(e,o.length-e.length)!==-1,mC=class extends ur{constructor(e){super({leftInput:[0,0],rightInput:[0,0],doubleTap:[0]}),this._layout="joystick-touch",this._pointerData=new Map,this._lastPointer={x:0,y:0,time:0},e&&(this.layout=e),this._leftJoystick=new Xd,this._rightJoystick=new Xd,this._onPointerDown=this._onPointerDown.bind(this),this._onPointerMove=this._onPointerMove.bind(this),this._onPointerUp=this._onPointerUp.bind(this)}set layout(e){this._layout!==e&&(this._layout=e,this.read(),this._pointerData.clear())}get layout(){return this._layout}get leftJoystick(){return this._leftJoystick}get rightJoystick(){return this._rightJoystick}_onPointerDown(e){let{pointerType:t,pointerId:s,clientX:i,clientY:r}=e;if(t!=="touch")return;this._element?.setPointerCapture(s);let a=i<window.innerWidth*.5;this._pointerData.set(s,{x:i,y:r,left:a});let n=Date.now();(this._lastPointer.x-i)**2+(this._lastPointer.y-r)**2<100&&n-this._lastPointer.time<250&&this.deltas.doubleTap.append([1]),this._lastPointer.x=i,this._lastPointer.y=r,this._lastPointer.time=n,a&&vO(this._layout,"joystick")&&this.fire("joystick:position:left",this._leftJoystick.down(i,r)),!a&&xO(this._layout,"joystick")&&this.fire("joystick:position:right",this._rightJoystick.down(i,r))}_onPointerMove(e){let{pointerType:t,pointerId:s,target:i,clientX:r,clientY:a,movementX:n,movementY:l}=e;if(t!=="touch"||i!==this._element)return;let h=this._pointerData.get(s);if(!h)return;let{left:c}=h;h.x=r,h.y=a,c?vO(this._layout,"joystick")?this.fire("joystick:position:left",this._leftJoystick.move(r,a)):this.deltas.leftInput.append([n,l]):xO(this._layout,"joystick")?this.fire("joystick:position:right",this._rightJoystick.move(r,a)):this.deltas.rightInput.append([n,l])}_onPointerUp(e){let{pointerType:t,pointerId:s}=e;if(t!=="touch")return;this._element?.releasePointerCapture(s);let i=this._pointerData.get(s);if(!i)return;let{left:r}=i;this._pointerData.delete(s),r&&vO(this._layout,"joystick")&&this.fire("joystick:position:left",this._leftJoystick.up()),!r&&xO(this._layout,"joystick")&&this.fire("joystick:position:right",this._rightJoystick.up())}attach(e){super.attach(e),this._element=e,this._element.addEventListener("pointerdown",this._onPointerDown),this._element.addEventListener("pointermove",this._onPointerMove),this._element.addEventListener("pointerup",this._onPointerUp),this._element.addEventListener("pointercancel",this._onPointerUp)}detach(){this._element&&(this._element.removeEventListener("pointerdown",this._onPointerDown),this._element.removeEventListener("pointermove",this._onPointerMove),this._element.removeEventListener("pointerup",this._onPointerUp),this._element.removeEventListener("pointercancel",this._onPointerUp),this._pointerData.clear(),super.detach())}read(){return this.deltas.leftInput.append([this._leftJoystick.value.x,this._leftJoystick.value.y]),this.deltas.rightInput.append([this._rightJoystick.value.x,this._rightJoystick.value.y]),super.read()}destroy(){this._leftJoystick.up(),this._rightJoystick.up(),super.destroy()}}});var lce,pC,yse=m(()=>{Ne();bo();lce=new D,pC=class extends ur{constructor(){super({touch:[0,0],count:[0],pinch:[0]}),this._pointerEvents=new Map,this._pointerPos=new D,this._pinchDist=-1,this._onPointerDown=this._onPointerDown.bind(this),this._onPointerMove=this._onPointerMove.bind(this),this._onPointerUp=this._onPointerUp.bind(this),this._onContextMenu=this._onContextMenu.bind(this)}_onPointerDown(e){let{pointerId:t,pointerType:s}=e;s==="touch"&&(this._element?.setPointerCapture(t),this._pointerEvents.set(t,e),this.deltas.count.append([1]),this._pointerEvents.size>1&&(this._getMidPoint(this._pointerPos),this._pinchDist=this._getPinchDist()))}_onPointerMove(e){let{pointerType:t,target:s,pointerId:i,movementX:r,movementY:a}=e;if(t==="touch"&&s===this._element&&this._pointerEvents.size!==0)if(this._pointerEvents.set(i,e),this._pointerEvents.size>1){let n=this._getMidPoint(lce);this.deltas.touch.append([n.x-this._pointerPos.x,n.y-this._pointerPos.y]),this._pointerPos.copy(n);let l=this._getPinchDist();this._pinchDist>0&&this.deltas.pinch.append([this._pinchDist-l]),this._pinchDist=l}else this.deltas.touch.append([r,a])}_onPointerUp(e){let{pointerType:t,pointerId:s}=e;t==="touch"&&(this._element?.releasePointerCapture(s),this._pointerEvents.delete(s),this.deltas.count.append([-1]),this._pointerEvents.size<2&&(this._pinchDist=-1),this._pointerPos.set(0,0))}_onContextMenu(e){e.preventDefault()}_getMidPoint(e){if(this._pointerEvents.size<2)return e.set(0,0);let[t,s]=this._pointerEvents.values(),i=t.clientX-s.clientX,r=t.clientY-s.clientY;return e.set(s.clientX+i*.5,s.clientY+r*.5)}_getPinchDist(){if(this._pointerEvents.size<2)return 0;let[e,t]=this._pointerEvents.values(),s=e.clientX-t.clientX,i=e.clientY-t.clientY;return Math.sqrt(s*s+i*i)}attach(e){super.attach(e),this._element=e,this._element.addEventListener("pointerdown",this._onPointerDown),this._element.addEventListener("pointermove",this._onPointerMove),this._element.addEventListener("pointerup",this._onPointerUp),this._element.addEventListener("pointercancel",this._onPointerUp),this._element.addEventListener("contextmenu",this._onContextMenu)}detach(){this._element&&(this._element.removeEventListener("pointerdown",this._onPointerDown),this._element.removeEventListener("pointermove",this._onPointerMove),this._element.removeEventListener("pointerup",this._onPointerUp),this._element.removeEventListener("pointercancel",this._onPointerUp),this._element.removeEventListener("contextmenu",this._onContextMenu),this._pointerEvents.clear(),super.detach())}}});var Ase,Pse,_C,yO,gC,Rse=m(()=>{bo();Ase={passive:!1},Pse={A:0,B:1,C:2,D:3,E:4,F:5,G:6,H:7,I:8,J:9,K:10,L:11,M:12,N:13,O:14,P:15,Q:16,R:17,S:18,T:19,U:20,V:21,W:22,X:23,Y:24,Z:25,0:26,1:27,2:28,3:29,4:30,5:31,6:32,7:33,8:34,9:35,UP:36,DOWN:37,LEFT:38,RIGHT:39,SPACE:40,SHIFT:41,CTRL:42},_C=Object.keys(Pse).length,yO=Array(_C).fill(0),gC=class o extends ur{static{this.keyCode=Pse}constructor({pointerLock:e=!1}={}){super({key:Array(_C).fill(0),button:[0,0,0],mouse:[0,0],wheel:[0]}),this._pointerId=0,this._keyMap=new Map,this._keyPrev=Array(_C).fill(0),this._keyNow=Array(_C).fill(0),this._button=Array(3).fill(0),this._pointerLock=e??!1;let{keyCode:t}=o;for(let s=0;s<26;s++){let i=`Key${String.fromCharCode(65+s)}`;this._keyMap.set(i,t.A+s)}for(let s=0;s<10;s++){let i=`Digit${s}`;this._keyMap.set(i,t[0]+s)}this._keyMap.set("ArrowUp",t.UP),this._keyMap.set("ArrowDown",t.DOWN),this._keyMap.set("ArrowLeft",t.LEFT),this._keyMap.set("ArrowRight",t.RIGHT),this._keyMap.set("Space",t.SPACE),this._keyMap.set("ShiftLeft",t.SHIFT),this._keyMap.set("ShiftRight",t.SHIFT),this._keyMap.set("ControlLeft",t.CTRL),this._keyMap.set("ControlRight",t.CTRL),this._onWheel=this._onWheel.bind(this),this._onPointerDown=this._onPointerDown.bind(this),this._onPointerMove=this._onPointerMove.bind(this),this._onPointerUp=this._onPointerUp.bind(this),this._onContextMenu=this._onContextMenu.bind(this),this._onKeyDown=this._onKeyDown.bind(this),this._onKeyUp=this._onKeyUp.bind(this)}_onWheel(e){e.preventDefault(),this.deltas.wheel.append([e.deltaY])}_onPointerDown(e){e.pointerType==="mouse"&&(this._pointerLock?document.pointerLockElement!==this._element&&this._element?.requestPointerLock():this._element?.setPointerCapture(e.pointerId),this._clearButtons(),this._button[e.button]=1,this.deltas.button.append(this._button),!this._pointerId&&(this._pointerId=e.pointerId))}_onPointerMove(e){if(e.pointerType==="mouse"&&e.target===this._element){if(this._pointerLock){if(document.pointerLockElement!==this._element)return}else if(this._pointerId!==e.pointerId)return;this.deltas.mouse.append([e.movementX,e.movementY])}}_onPointerUp(e){e.pointerType==="mouse"&&(this._pointerLock||this._element?.releasePointerCapture(e.pointerId),this._clearButtons(),this.deltas.button.append(this._button),this._pointerId===e.pointerId&&(this._pointerId=0))}_onContextMenu(e){e.preventDefault()}_onKeyDown(e){this._pointerLock&&document.pointerLockElement!==this._element||(e.stopPropagation(),this._setKey(e.code,1))}_onKeyUp(e){e.stopPropagation(),this._setKey(e.code,0)}_clearButtons(){for(let e=0;e<this._button.length;e++){if(this._button[e]===1){this._button[e]=-1;continue}this._button[e]=0}}_setKey(e,t){this._keyMap.has(e)&&(this._keyNow[this._keyMap.get(e)??0]=t)}attach(e){super.attach(e),this._element=e,this._element.addEventListener("wheel",this._onWheel,Ase),this._element.addEventListener("pointerdown",this._onPointerDown),this._element.addEventListener("pointermove",this._onPointerMove),this._element.addEventListener("pointerup",this._onPointerUp),this._element.addEventListener("pointercancel",this._onPointerUp),this._element.addEventListener("contextmenu",this._onContextMenu),window.addEventListener("keydown",this._onKeyDown,!1),window.addEventListener("keyup",this._onKeyUp,!1)}detach(){this._element&&(this._element.removeEventListener("wheel",this._onWheel,Ase),this._element.removeEventListener("pointerdown",this._onPointerDown),this._element.removeEventListener("pointermove",this._onPointerMove),this._element.removeEventListener("pointerup",this._onPointerUp),this._element.removeEventListener("pointercancel",this._onPointerUp),this._element.removeEventListener("contextmenu",this._onContextMenu),window.removeEventListener("keydown",this._onKeyDown,!1),window.removeEventListener("keyup",this._onKeyUp,!1),this._keyNow.fill(0),this._keyPrev.fill(0),super.detach())}read(){for(let e=0;e<yO.length;e++)yO[e]=this._keyNow[e]-this._keyPrev[e],this._keyPrev[e]=this._keyNow[e];return this.deltas.key.append(yO),super.read()}}});var Cse,AO,SC,Ise=m(()=>{bo();Cse={A:0,B:1,X:2,Y:3,LB:4,RB:5,LT:6,RT:7,SELECT:8,START:9,LEFT_STICK:10,RIGHT_STICK:11},AO=Object.keys(Cse).length,SC=class extends ur{static{this.buttonCode=Cse}constructor(){super({buttons:Array(AO).fill(0),leftStick:[0,0],rightStick:[0,0]}),this._buttonPrev=Array(AO).fill(0)}read(){let e=navigator.getGamepads();for(let t=0;t<e.length;t++){let s=e[t];if(!s||s.mapping!=="standard"||s.axes.length<4||s.buttons.length<AO)continue;let{buttons:i,axes:r}=s;for(let a=0;a<this._buttonPrev.length;a++){let n=+i[a].pressed;this.deltas.buttons[a]=n-this._buttonPrev[a],this._buttonPrev[a]=n}this.deltas.leftStick.append([r[0],r[1]]),this.deltas.rightStick.append([r[2],r[3]])}return super.read()}}});var gn,TC=m(()=>{gn=(o,e)=>1-Math.pow(o,e*1e3)});var _E,hce,wse,Lse,bse,EC,vC,Mse=m(()=>{Q();Ve();bo();Fg();TC();_E=new g,hce=new g,wse=new g,Lse=new g,bse=new g,EC=new H,vC=class extends Lo{set pitchRange(e){this._targetPose.pitchRange.copy(e),this._pose.copy(this._targetPose.rotate(g.ZERO))}get pitchRange(){return this._targetPose.pitchRange}set yawRange(e){this._targetPose.yawRange.copy(e),this._pose.copy(this._targetPose.rotate(g.ZERO))}get yawRange(){return this._targetPose.yawRange}attach(e,t=!0){this._targetPose.copy(e),t||this._pose.copy(this._targetPose)}detach(){this._targetPose.copy(this._pose)}update(e,t){let{move:s,rotate:i}=e.read();return this._targetPose.rotate(hce.set(-i[1],-i[0],0)),EC.setFromEulerAngles(this._pose.angles),EC.transformVector(g.FORWARD,wse),EC.transformVector(g.RIGHT,Lse),EC.transformVector(g.UP,bse),_E.set(0,0,0),_E.add(wse.mulScalar(s[2])),_E.add(Lse.mulScalar(s[0])),_E.add(bse.mulScalar(s[1])),this._targetPose.move(_E),this._pose.lerp(this._pose,this._targetPose,gn(this.moveDamping,t),gn(this.rotateDamping,t))}destroy(){this.detach()}constructor(...e){super(...e),this._targetPose=new Zs,this.rotateDamping=.98,this.moveDamping=.98}}});var cce,Wd,fce,Dse,xC,Ose=m(()=>{Ve();Q();bo();TC();Fg();cce=new g,Wd=new g,fce=new g,Dse=new H,xC=class extends Lo{set pitchRange(e){this._targetRootPose.pitchRange.copy(e),this._rootPose.copy(this._targetRootPose.rotate(g.ZERO))}get pitchRange(){return this._targetRootPose.pitchRange}set yawRange(e){this._targetRootPose.yawRange.copy(e),this._rootPose.copy(this._targetRootPose.rotate(g.ZERO))}get yawRange(){return this._targetRootPose.yawRange}set zoomRange(e){this._targetChildPose.zRange.copy(e),this._childPose.copy(this._targetChildPose.move(g.ZERO))}get zoomRange(){return this._targetRootPose.zRange}attach(e,t=!0){this._targetRootPose.set(e.getFocus(cce),e.angles,0),this._targetChildPose.position.set(0,0,e.distance),t||(this._rootPose.copy(this._targetRootPose),this._childPose.copy(this._targetChildPose))}detach(){this._targetRootPose.copy(this._rootPose),this._targetChildPose.copy(this._childPose)}update(e,t){let{move:s,rotate:i}=e.read();Wd.set(s[0],s[1],0),Dse.setFromEulerAngles(this._rootPose.angles).transformVector(Wd,Wd),this._targetRootPose.move(Wd);let{z:r}=this._targetChildPose.position;return this._targetChildPose.move(Wd.set(0,0,r*(1+s[2])-r)),this._targetRootPose.rotate(fce.set(-i[1],-i[0],0)),this._rootPose.lerp(this._rootPose,this._targetRootPose,gn(this.moveDamping,t),gn(this.rotateDamping,t),1),this._childPose.lerp(this._childPose,this._targetChildPose,gn(this.zoomDamping,t),1,1),Dse.setFromEulerAngles(this._rootPose.angles).transformVector(this._childPose.position,Wd).add(this._rootPose.position),this._pose.set(Wd,this._rootPose.angles,this._childPose.position.z)}destroy(){this.detach()}constructor(...e){super(...e),this._targetRootPose=new Zs,this._rootPose=new Zs,this._targetChildPose=new Zs,this._childPose=new Zs,this.rotateDamping=.98,this.moveDamping=.98,this.zoomDamping=.98}}});var Nse,dce,Fse,uce,yC,Use=m(()=>{Ve();Q();bo();TC();Fg();Nse=.001,dce=new g,Fse=new g,uce=new H,yC=class extends Lo{attach(e,t=!0){this._targetRootPose.set(e.getFocus(dce),e.angles,0),this._targetChildPose.position.set(0,0,e.distance),t||(this._rootPose.copy(this._targetRootPose),this._childPose.copy(this._targetChildPose))}detach(){this._targetRootPose.copy(this._rootPose),this._targetChildPose.copy(this._childPose)}complete(){return this._targetRootPose.equalsApprox(this._rootPose,Nse)&&this._targetChildPose.equalsApprox(this._childPose,Nse)}update(e,t){return e.read(),this._rootPose.lerp(this._rootPose,this._targetRootPose,gn(this.focusDamping,t),gn(this.focusDamping,t),1),this._childPose.lerp(this._childPose,this._targetChildPose,gn(this.focusDamping,t),1,1),uce.setFromEulerAngles(this._rootPose.angles).transformVector(this._childPose.position,Fse).add(this._rootPose.position),this._pose.set(Fse,this._rootPose.angles,this._childPose.position.length())}destroy(){this.detach()}constructor(...e){super(...e),this._targetRootPose=new Zs,this._rootPose=new Zs,this._targetChildPose=new Zs,this._childPose=new Zs,this.focusDamping=.98}}});var Sn,gE,Vr,kr,Gr,Bse,Vse,kse,Kc,Ni,Yd=m(()=>{Sn="local",gE="world",Vr="x",kr="y",Gr="z",Bse="yz",Vse="xz",kse="xy",Kc="xyz",Ni="face"});var mr,Gse,mce,pce,_ce,gce,Sce,Tce,Ece,PO,Ua,RO=m(()=>{me();Q();Ke();Ql();Pe();J();ci();Ym();Yd();mr=new g,Gse=new g,mce=new k,pce=new k,_ce=new Es,gce="Gizmo",Sce=1e-4,Tce=.3,Ece=.32,PO=1e-6,Ua=class o extends K{static{this.EVENT_POINTERDOWN="pointer:down"}static{this.EVENT_POINTERMOVE="pointer:move"}static{this.EVENT_POINTERUP="pointer:up"}static{this.EVENT_POSITIONUPDATE="position:update"}static{this.EVENT_ROTATIONUPDATE="rotation:update"}static{this.EVENT_SCALEUPDATE="scale:update"}static{this.EVENT_NODESATTACH="nodes:attach"}static{this.EVENT_NODESDETACH="nodes:detach"}static{this.EVENT_RENDERUPDATE="render:update"}static createLayer(e,t=gce,s){let i=new At({name:t,clearDepthBuffer:!0,opaqueSortMode:tn,transparentSortMode:tn});return e.scene.layers.insert(i,s??e.scene.layers.layerList.length),i}constructor(e,t){super(),this._size=1,this._scale=1,this._coordSpace=gE,this.nodes=[],this.intersectShapes=[],this._camera=e,this._app=e.system.app,this._device=this._app.graphicsDevice,this._layer=t,e.layers=e.layers.concat(t.id),this.root=new be("gizmo"),this._app.root.addChild(this.root),this.root.enabled=!1,this._updateScale(),this._onPointerDown=this._onPointerDown.bind(this),this._onPointerMove=this._onPointerMove.bind(this),this._onPointerUp=this._onPointerUp.bind(this),this._device.canvas.addEventListener("pointerdown",this._onPointerDown),this._device.canvas.addEventListener("pointermove",this._onPointerMove),this._device.canvas.addEventListener("pointerup",this._onPointerUp),this._app.on("update",()=>{this._updatePosition(),this._updateRotation(),this._updateScale()}),this._app.on("destroy",()=>this.destroy())}get layer(){return this._layer}set coordSpace(e){this._coordSpace=e??gE,this._updateRotation()}get coordSpace(){return this._coordSpace}set size(e){this._size=e,this._updateScale()}get size(){return this._size}get facing(){if(this._camera.projection===Mt){let e=this.root.getPosition(),t=this._camera.entity.getPosition();return Gse.sub2(t,e).normalize()}return Gse.copy(this._camera.entity.forward).mulScalar(-1)}_onPointerDown(e){if(!this.root.enabled||document.pointerLockElement)return;let t=this._getSelection(e.offsetX,e.offsetY);t[0]&&(e.preventDefault(),e.stopPropagation());let{canvas:s}=this._device;s.setPointerCapture(e.pointerId),this.fire(o.EVENT_POINTERDOWN,e.offsetX,e.offsetY,t[0])}_onPointerMove(e){if(!this.root.enabled||document.pointerLockElement)return;let t=this._getSelection(e.offsetX,e.offsetY);t[0]&&(e.preventDefault(),e.stopPropagation()),this.fire(o.EVENT_POINTERMOVE,e.offsetX,e.offsetY,t[0])}_onPointerUp(e){if(!this.root.enabled||document.pointerLockElement)return;let t=this._getSelection(e.offsetX,e.offsetY);t[0]&&(e.preventDefault(),e.stopPropagation());let{canvas:s}=this._device;s.releasePointerCapture(e.pointerId),this.fire(o.EVENT_POINTERUP,e.offsetX,e.offsetY,t[0])}_updatePosition(){mr.set(0,0,0);for(let e=0;e<this.nodes.length;e++){let t=this.nodes[e];mr.add(t.getPosition())}mr.mulScalar(1/(this.nodes.length||1)),!(mr.distance(this.root.getPosition())<PO)&&(this.root.setPosition(mr),this.fire(o.EVENT_POSITIONUPDATE,mr))}_updateRotation(){mr.set(0,0,0),this._coordSpace===Sn&&this.nodes.length!==0&&mr.copy(this.nodes[this.nodes.length-1].getEulerAngles()),!(mr.distance(this.root.getEulerAngles())<PO)&&(this.root.setEulerAngles(mr),this.fire(o.EVENT_ROTATIONUPDATE,mr))}_updateScale(){if(this._camera.projection===Mt){let e=this.root.getPosition(),t=this._camera.entity.getPosition(),s=e.distance(t);this._scale=Math.tan(.5*this._camera.fov*w.DEG_TO_RAD)*s*Tce}else this._scale=this._camera.orthoHeight*Ece;this._scale=Math.max(this._scale*this._size,Sce),!(Math.abs(this._scale-this.root.getLocalScale().x)<PO)&&(this.root.setLocalScale(this._scale,this._scale,this._scale),this.fire(o.EVENT_SCALEUPDATE,this._scale))}_getSelection(e,t){let s=this._camera.screenToWorld(e,t,0),i=this._camera.screenToWorld(e,t,this._camera.farClip-this._camera.nearClip),r=mr.copy(i).sub(s).normalize(),a=[];for(let n=0;n<this.intersectShapes.length;n++){let l=this.intersectShapes[n];if(l.disabled||!l.entity.enabled)continue;let h=l.entity.getWorldTransform();for(let c=0;c<l.triData.length;c++){let{tris:f,transform:d,priority:u}=l.triData[c],p=mce.copy(h).mul(d),_=pce.copy(p).invert(),S=_ce;_.transformPoint(s,S.origin),_.transformVector(r,S.direction),S.direction.normalize();for(let T=0;T<f.length;T++)f[T].intersectsRay(S,mr)&&a.push({dist:p.transformPoint(mr).sub(s).length(),meshInstances:l.meshInstances,priority:u})}}return a.length?(a.sort((n,l)=>n.priority!==0&&l.priority!==0?l.priority-n.priority:n.dist-l.dist),a[0].meshInstances):[]}attach(e=[]){if(Array.isArray(e)){if(e.length===0)return;this.nodes=e}else this.nodes=[e];this._updatePosition(),this._updateRotation(),this._updateScale(),this.fire(o.EVENT_NODESATTACH),this.root.enabled=!0,this.fire(o.EVENT_RENDERUPDATE)}detach(){this.root.enabled=!1,this.fire(o.EVENT_RENDERUPDATE),this.fire(o.EVENT_NODESDETACH),this.nodes=[]}destroy(){this.detach(),this._device.canvas.removeEventListener("pointerdown",this._onPointerDown),this._device.canvas.removeEventListener("pointermove",this._onPointerMove),this._device.canvas.removeEventListener("pointerup",this._onPointerUp),this.root.destroy()}}});var Ug,Bg,Vg,CO,AC,zse,Hse,PC=m(()=>{De();Ug=Object.freeze(new N(1,.3,.3)),Bg=Object.freeze(new N(.3,1,.3)),Vg=Object.freeze(new N(.3,.3,1)),CO=Object.freeze(new N(1,1,.5)),AC=Object.freeze(new N(.5,.5,.5,.5)),zse=o=>new N(o.r,o.g,o.b),Hse=(o,e)=>new N(o.r,o.g,o.b,e)});var pr,kg,vce,Kd,Xse,Wse,os,SE=m(()=>{me();De();Ve();Q();Ql();Zg();J();PC();Yd();RO();pr=new g,kg=new g,vce=new H,Kd=new Es,Xse=new Rn,Wse=Object.keys(pr),os=class o extends Ua{static{this.EVENT_TRANSFORMSTART="transform:start"}static{this.EVENT_TRANSFORMMOVE="transform:move"}static{this.EVENT_TRANSFORMEND="transform:end"}constructor(e,t){super(e,t),this._colorAlpha=.6,this._meshColors={axis:{x:this._colorSemi(Ug),y:this._colorSemi(Bg),z:this._colorSemi(Vg),xyz:this._colorSemi(N.WHITE),f:this._colorSemi(N.WHITE)},hover:{x:Ug.clone(),y:Bg.clone(),z:Vg.clone(),xyz:N.WHITE.clone(),f:CO.clone()},disabled:AC.clone()},this._guideColors={x:Ug.clone(),y:Bg.clone(),z:Vg.clone(),f:CO.clone()},this._rootStartPos=new g,this._rootStartRot=new H,this._shading=!1,this._shapes={},this._shapeMap=new Map,this._hoverShape=null,this._hoverAxis="",this._hoverIsPlane=!1,this._noSelection=!1,this._selectedAxis="",this._selectedIsPlane=!1,this._selectionStartPoint=new g,this._dragging=!1,this._snap=!1,this.snapIncrement=1,this._app.on("prerender",()=>{this.root.enabled&&this._drawGuideLines()}),this.on(Ua.EVENT_POINTERDOWN,(s,i,r)=>{if(this._shapeMap.get(r)?.disabled||this._dragging)return;if(!r){this._noSelection=!0;return}this._selectedAxis=this._getAxis(r),this._selectedIsPlane=this._getIsPlane(r),this._rootStartPos.copy(this.root.getPosition()),this._rootStartRot.copy(this.root.getRotation());let n=this._screenToPoint(s,i);this._selectionStartPoint.copy(n),this._dragging=!0,this.fire(o.EVENT_TRANSFORMSTART,n,s,i)}),this.on(Ua.EVENT_POINTERMOVE,(s,i,r)=>{if(this._shapeMap.get(r)?.disabled||(this._noSelection||this._hover(r),!this._dragging))return;let n=this._screenToPoint(s,i);this.fire(o.EVENT_TRANSFORMMOVE,n,s,i),this._hoverAxis="",this._hoverIsPlane=!1}),this.on(Ua.EVENT_POINTERUP,(s,i,r)=>{this._noSelection=!1,this._hover(r),this._dragging&&(this._dragging=!1,this.fire(o.EVENT_TRANSFORMEND),this._selectedAxis="",this._selectedIsPlane=!1)}),this.on(Ua.EVENT_NODESDETACH,()=>{this.snap=!1,this._hoverAxis="",this._hoverIsPlane=!1,this._hover(),this.fire(Ua.EVENT_POINTERUP)})}set shading(e){this._shading=this.root.enabled&&e;for(let t in this._shapes)this._shapes[t].shading=this._shading}get shading(){return this._shading}set snap(e){this._snap=this.root.enabled&&e}get snap(){return this._snap}set xAxisColor(e){this._updateAxisColor("x",e)}get xAxisColor(){return this._meshColors.axis.x}set yAxisColor(e){this._updateAxisColor("y",e)}get yAxisColor(){return this._meshColors.axis.y}set zAxisColor(e){this._updateAxisColor("z",e)}get zAxisColor(){return this._meshColors.axis.z}set colorAlpha(e){this._colorAlpha=w.clamp(e,0,1),this._meshColors.axis.x.copy(this._colorSemi(this._meshColors.axis.x)),this._meshColors.axis.y.copy(this._colorSemi(this._meshColors.axis.y)),this._meshColors.axis.z.copy(this._colorSemi(this._meshColors.axis.z)),this._meshColors.axis.xyz.copy(this._colorSemi(this._meshColors.axis.xyz)),this._meshColors.axis.f.copy(this._colorSemi(this._meshColors.axis.f));for(let t in this._shapes)this._shapes[t].hover(!!this._hoverAxis)}get colorAlpha(){return this._colorAlpha}_colorSemi(e){return Hse(e,this._colorAlpha)}_updateAxisColor(e,t){let s=zse(t),i=this._colorSemi(t);this._guideColors[e].copy(s),this._meshColors.axis[e].copy(i),this._meshColors.hover[e].copy(s);for(let r in this._shapes)this._shapes[r].hover(!!this._hoverAxis)}_getAxis(e){return e?e.node.name.split(":")[1]:""}_getIsPlane(e){return e?e.node.name.indexOf("plane")!==-1:!1}_hover(e){if(this._dragging)return;this._hoverAxis=this._getAxis(e),this._hoverIsPlane=this._getIsPlane(e);let t=e?this._shapeMap.get(e)??null:null;t!==this._hoverShape&&(this._hoverShape&&(this._hoverShape.hover(!1),this._hoverShape=null),t&&(t.hover(!0),this._hoverShape=t),this.fire(Ua.EVENT_RENDERUPDATE))}_createRay(e){if(this._camera.projection===Mt)return Kd.origin.copy(this._camera.entity.getPosition()),Kd.direction.sub2(e,Kd.origin).normalize(),Kd;let t=this._camera.farClip-this._camera.nearClip;return Kd.origin.sub2(e,pr.copy(this._camera.entity.forward).mulScalar(t)),Kd.direction.copy(this._camera.entity.forward),Kd}_createPlane(e,t,s){let i=pr.copy(this.facing),r=Xse.normal.set(0,0,0);return t?r.copy(i):(r[e]=1,this._rootStartRot.transformVector(r,r),s&&(kg.cross(r,i).normalize(),r.cross(kg,r).normalize())),Xse.setFromPointNormal(this._rootStartPos,r)}_dirFromAxis(e,t){return e===Ni?t.copy(this._camera.entity.forward).mulScalar(-1):(t.set(0,0,0),t[e]=1),t}_projectToAxis(e,t){pr.set(0,0,0),pr[t]=1,e.copy(pr.mulScalar(pr.dot(e)));let s=e[t];e.set(0,0,0),e[t]=s}_screenToPoint(e,t,s=!1,i=!1){let r=this._camera.screenToWorld(e,t,1),a=this._selectedAxis,n=this._createRay(r),l=this._createPlane(a,s,i),h=new g;return l.intersectsRay(n,h),h}_drawGuideLines(){let e=this.root.getPosition(),t=vce.copy(this.root.getRotation()),s=this._hoverAxis||this._selectedAxis,i=this._hoverIsPlane||this._selectedIsPlane;for(let r=0;r<Wse.length;r++){let a=Wse[r];if(s==="xyz"){this._drawSpanLine(e,t,a);continue}i?a!==s&&this._drawSpanLine(e,t,a):a===s&&this._drawSpanLine(e,t,a)}}_drawSpanLine(e,t,s){pr.set(0,0,0),pr[s]=1,pr.mulScalar(this._camera.farClip-this._camera.nearClip),kg.copy(pr).mulScalar(-1),t.transformVector(pr,pr),t.transformVector(kg,kg),this._app.drawLine(pr.add(e),kg.add(e),this._guideColors[s],!0)}_createTransform(){for(let e in this._shapes){let t=this._shapes[e];this.root.addChild(t.entity),this.intersectShapes.push(t);for(let s=0;s<t.meshInstances.length;s++)this._shapeMap.set(t.meshInstances[s],t)}}enableShape(e,t){this._shapes.hasOwnProperty(e)&&(this._shapes[e].disabled=!t)}isShapeEnabled(e){return this._shapes.hasOwnProperty(e)?!this._shapes[e].disabled:!1}destroy(){super.destroy();for(let e in this._shapes)this._shapes[e].destroy()}}});var Yse,Kse,qse,Pi,qd=m(()=>{Q();Ve();Ke();dI();nn();Yse=new g,Kse=new g,qse=new g,Pi=class{constructor(e,t=0){this._priority=0,this._transform=new k,this.tris=[],this.fromGeometry(e),this._priority=t}get transform(){return this._transform}get priority(){return this._priority}setTransform(e=new g,t=new H,s=new g){this.transform.setTRS(e,t,s)}fromGeometry(e){if(!e||!(e instanceof Qt))throw new Error("No geometry provided.");let t=e.positions??[],s=e.indices??[];this.tris=[];for(let i=0;i<s.length;i+=3){let r=s[i],a=s[i+1],n=s[i+2];Yse.set(t[r*3],t[r*3+1],t[r*3+2]),Kse.set(t[a*3],t[a*3+1],t[a*3+2]),qse.set(t[n*3],t[n*3+1],t[n*3+2]);let l=new uu(Yse,Kse,qse);this.tris.push(l)}}}});var xce,yce,Ace,Pce,Rce,wO,jse,Cce,Ice,TE,$se,IO,_r,jd=m(()=>{De();Q();$h();_s();ci();j();J();PC();Ws();nn();Zh();rd();fp();dp();td();up();Ke();xce=.25,yce=.75,Ace=new g(1,2,3),Pce={box:hi,cone:Ia,cylinder:hr,plane:wa,sphere:or,torus:Dr},Rce={uniqueName:"axis-shape",attributes:{vertex_position:te,vertex_color:nt},vertexGLSL:`
		attribute vec3 vertex_position;
		attribute vec4 vertex_color;
	
		varying vec4 vColor;
	
		uniform mat4 matrix_model;
		uniform mat4 matrix_viewProjection;
	
		void main(void) {
			gl_Position = matrix_viewProjection * matrix_model * vec4(vertex_position, 1.0);
			gl_Position.z = clamp(gl_Position.z, -abs(gl_Position.w), abs(gl_Position.w));
			vColor = vertex_color;
		}
	`,fragmentGLSL:`
		#include "gammaPS"
	
		precision highp float;
	
		varying vec4 vColor;
		void main(void) {
			gl_FragColor = vec4(gammaCorrectOutput(decodeGamma(vColor)), vColor.w);
		}
	`,vertexWGSL:`
		attribute vertex_position: vec3f;
		attribute vertex_color: vec4f;
		uniform matrix_model: mat4x4f;
		uniform matrix_viewProjection: mat4x4f;
		varying vColor: vec4f;
		@vertex
		fn vertexMain(input: VertexInput) -> VertexOutput {
			var output: VertexOutput;
			output.vColor = input.vertex_color;
			let pos = vec4f(input.vertex_position, 1.0);
			output.position = uniform.matrix_viewProjection * uniform.matrix_model * pos;
			output.position.z = clamp(output.position.z, -abs(output.position.w), abs(output.position.w));
			return output;
		}
	`,fragmentWGSL:`
		#include "gammaPS"
		varying vColor: vec4f;
		@fragment
		fn fragmentMain(input: FragmentInput) -> FragmentOutput {
			var output: FragmentOutput;
			output.color = vec4f(gammaCorrectOutput(decodeGamma(input.vColor)), input.vColor.w);
			return output;
		}
	`},wO=new Map,jse=new g,Cce=new g,Ice=new k,TE=new Qt;TE.positions=[];TE.normals=[];$se=(o,e,t)=>{if(!o.normals||!o.positions)return[];let s;t&&(s=Ice.copy(t).invert().transformVector(jse.copy(Ace),jse).normalize()),o.colors=[];let i=[],r=o.positions.length/3;for(let a=0;a<r;a++){let n=1;if(s){let l=o.normals[a*3],h=o.normals[a*3+1],c=o.normals[a*3+2],f=Cce.set(l,h,c);n=s.dot(f)*xce+yce}i.push(n),o.colors.push(n*e.r*255,n*e.g*255,n*e.b*255,e.a*255)}return i},IO=(o,e)=>{let t=wO.get(o),s=[];for(let i=0;i<t.length;i++)s.push(t[i]*e.r*255,t[i]*e.g*255,t[i]*e.b*255,e.a*255);o.setColors32(s),o.update()},_r=class{constructor(e,t){this._layers=[],this._shading=!0,this._defaultColor=N.WHITE,this._hoverColor=N.BLACK,this._disabledColor=AC,this._cull=1,this.triData=[],this.meshInstances=[],this.device=e,this.axis=t.axis??"x",this._position=t.position??new g,this._rotation=t.rotation??new g,this._scale=t.scale??new g(1,1,1),this._disabled=t.disabled??!1,this._layers=t.layers??this._layers,this._shading=t.shading??this._shading,t.defaultColor instanceof N&&(this._defaultColor=t.defaultColor),t.hoverColor instanceof N&&(this._hoverColor=t.hoverColor),t.disabledColor instanceof N&&(this._disabledColor=t.disabledColor)}set disabled(e){for(let t=0;t<this.meshInstances.length;t++)IO(this.meshInstances[t].mesh,e?this._disabledColor:this._defaultColor);this._disabled=e??!1}get disabled(){return this._disabled}set shading(e){this._shading=e??!0;let t=this._disabled?this._disabledColor:this._defaultColor;for(let s=0;s<this.meshInstances.length;s++){let i=this.meshInstances[s].mesh;i.getPositions(TE.positions),i.getNormals(TE.normals);let r=$se(TE,t,this._shading?this.entity.getWorldTransform():void 0);wO.set(i,r),IO(i,t)}}get shading(){return this._shading}_createRoot(e){this.entity=new be(`${e}:${this.axis}`),this.entity.setLocalPosition(this._position),this.entity.setLocalEulerAngles(this._rotation),this.entity.setLocalScale(this._scale)}_createMesh(e,t=!0){let s=this._disabled?this._disabledColor:this._defaultColor,i=$se(e,s,t?this.entity.getWorldTransform():void 0),r=Ce.fromGeometry(this.device,e);return wO.set(r,i),r}_createRenderComponent(e,t){let s=new oi(Rce);s.cull=this._cull,s.blendType=es,s.update();let i=[];for(let r=0;r<t.length;r++){let a=new Oe(t[r],s);a.cull=!1,i.push(a),this.meshInstances.push(a)}e.addComponent("render",{meshInstances:i,layers:this._layers,castShadows:!1})}_addRenderMesh(e,t,s){let i=Pce[t];if(!i)throw new Error("Invalid primitive type.");this._createRenderComponent(e,[this._createMesh(new i,s)])}hover(e){if(!this._disabled)for(let t=0;t<this.meshInstances.length;t++){let s=e?this._hoverColor:this._defaultColor,i=this.meshInstances[t].mesh;IO(i,s)}}destroy(){this.entity.destroy()}}});var wce,Mo,LO=m(()=>{Q();dp();qd();jd();wce=1e-6,Mo=class extends _r{constructor(e,t={}){super(e,t),this._cull=0,this._size=.2,this._gap=.1,this._flipped=new g,this.triData=[new Pi(new wa)],this._createPlane()}set size(e){this._size=e??1,this._updateTransform()}get size(){return this._size}set gap(e){this._gap=e??0,this._updateTransform()}get gap(){return this._gap}set flipped(e){this._flipped.distance(e)<wce||(this._flipped.copy(e),this.entity.setLocalPosition(this._getPosition()))}get flipped(){return this._flipped}_getPosition(){let e=this._size/2+this._gap,t=new g(this._flipped.x?-e:e,this._flipped.y?-e:e,this._flipped.z?-e:e);return t[this.axis]=0,t}_createPlane(){this._createRoot("plane"),this._updateTransform(),this._addRenderMesh(this.entity,"plane",this._shading)}_updateTransform(){this.entity.setLocalPosition(this._getPosition()),this.entity.setLocalEulerAngles(this._rotation),this.entity.setLocalScale(this._size,this._size,this._size)}}});var $d,RC,CC,Gg,Zse=m(()=>{Ve();Q();ci();fp();rd();qd();jd();$d=new g,RC=new g,CC=new H,Gg=class extends _r{constructor(e,t={}){super(e,t),this._gap=0,this._lineThickness=.02,this._lineLength=.5,this._arrowThickness=.12,this._arrowLength=.18,this._tolerance=.1,this._flipped=!1,this.triData=[new Pi(new Ia),new Pi(new hr,1)],this._createArrow()}set gap(e){this._gap=e??0,this._updateHead(),this._updateLine()}get gap(){return this._gap}set lineThickness(e){this._lineThickness=e??1,this._updateHead(),this._updateLine()}get lineThickness(){return this._lineThickness}set lineLength(e){this._lineLength=e??1,this._updateHead(),this._updateLine()}get lineLength(){return this._lineLength}set arrowThickness(e){this._arrowThickness=e??1,this._updateHead()}get arrowThickness(){return this._arrowThickness}set arrowLength(e){this._arrowLength=e??1,this._updateHead()}get arrowLength(){return this._arrowLength}set tolerance(e){this._tolerance=e,this._updateLine()}get tolerance(){return this._tolerance}set flipped(e){this._flipped!==e&&(this._flipped=e,this._rotation.equals(g.ZERO)?$d.set(0,0,this._flipped?180:0):$d.copy(this._rotation).mulScalar(this._flipped?-1:1),this._line.enabled=!this._flipped,this.entity.setLocalEulerAngles($d))}get flipped(){return this._flipped}_createArrow(){this._createRoot("arrow"),this._head=new be(`head:${this.axis}`),this.entity.addChild(this._head),this._updateHead(),this._addRenderMesh(this._head,"cone",this._shading),this._line=new be(`line:${this.axis}`),this.entity.addChild(this._line),this._updateLine(),this._addRenderMesh(this._line,"cylinder",this._shading)}_updateHead(){$d.set(0,this._gap+this._arrowLength*.5+this._lineLength,0),CC.set(0,0,0,1),RC.set(this._arrowThickness,this._arrowLength,this._arrowThickness),this.triData[0].setTransform($d,CC,RC),this._head.setLocalPosition(0,this._gap+this._arrowLength*.5+this._lineLength,0),this._head.setLocalScale(this._arrowThickness,this._arrowLength,this._arrowThickness)}_updateLine(){$d.set(0,this._gap+this._lineLength*.5,0),CC.set(0,0,0,1),RC.set(this._lineThickness+this._tolerance,this._lineLength,this._lineThickness+this._tolerance),this.triData[1].setTransform($d,CC,RC),this._line.setLocalPosition(0,this._gap+this._lineLength*.5,0),this._line.setLocalScale(this._lineThickness,this._lineLength,this._lineThickness)}}});var IC,Qse=m(()=>{td();qd();jd();IC=class extends _r{constructor(e,t={}){super(e,t),this._size=.12,this._tolerance=.05,this.triData=[new Pi(new or,2)],this._createCenter()}_createCenter(){this._createRoot("sphereCenter"),this._updateTransform(),this._addRenderMesh(this.entity,"sphere",this._shading)}set size(e){this._size=e??1,this._updateTransform()}get size(){return this._size}set tolerance(e){this._tolerance=e,this._updateTransform()}get tolerance(){return this._tolerance}_updateTransform(){this.entity.setLocalScale(this._size,this._size,this._size)}}});var Qs,Tn,Lce,Jse,zg,wC,eie=m(()=>{Q();Ve();Yd();SE();LO();Zse();Qse();Qs=new g,Tn=new g,Lce=new g,Jse=new H,zg=.98,wC=class extends os{constructor(e,t){super(e,t),this._shapes={face:new IC(this._device,{axis:Ni,layers:[this._layer.id],shading:this._shading,defaultColor:this._meshColors.axis.xyz,hoverColor:this._meshColors.hover.xyz}),yz:new Mo(this._device,{axis:"x",layers:[this._layer.id],shading:this._shading,rotation:new g(0,0,-90),defaultColor:this._meshColors.axis.x,hoverColor:this._meshColors.hover.x}),xz:new Mo(this._device,{axis:"y",layers:[this._layer.id],shading:this._shading,rotation:new g(0,0,0),defaultColor:this._meshColors.axis.y,hoverColor:this._meshColors.hover.y}),xy:new Mo(this._device,{axis:"z",layers:[this._layer.id],shading:this._shading,rotation:new g(90,0,0),defaultColor:this._meshColors.axis.z,hoverColor:this._meshColors.hover.z}),x:new Gg(this._device,{axis:"x",layers:[this._layer.id],shading:this._shading,rotation:new g(0,0,-90),defaultColor:this._meshColors.axis.x,hoverColor:this._meshColors.hover.x}),y:new Gg(this._device,{axis:"y",layers:[this._layer.id],shading:this._shading,rotation:new g(0,0,0),defaultColor:this._meshColors.axis.y,hoverColor:this._meshColors.hover.y}),z:new Gg(this._device,{axis:"z",layers:[this._layer.id],shading:this._shading,rotation:new g(90,0,0),defaultColor:this._meshColors.axis.z,hoverColor:this._meshColors.hover.z})},this._nodeLocalPositions=new Map,this._nodePositions=new Map,this.snapIncrement=1,this.flipShapes=!0,this._createTransform(),this.on(os.EVENT_TRANSFORMSTART,()=>{this._storeNodePositions()}),this.on(os.EVENT_TRANSFORMMOVE,s=>{let i=Lce.copy(s).sub(this._selectionStartPoint);this.snap&&(i.mulScalar(1/this.snapIncrement),i.round(),i.mulScalar(this.snapIncrement)),this._setNodePositions(i)}),this.on(os.EVENT_NODESDETACH,()=>{this._nodeLocalPositions.clear(),this._nodePositions.clear()}),this._app.on("prerender",()=>{this._shapesLookAtCamera()})}set axisGap(e){this._setArrowProp("gap",e)}get axisGap(){return this._shapes.x.gap}set axisLineThickness(e){this._setArrowProp("lineThickness",e)}get axisLineThickness(){return this._shapes.x.lineThickness}set axisLineLength(e){this._setArrowProp("lineLength",e)}get axisLineLength(){return this._shapes.x.lineLength}set axisLineTolerance(e){this._setArrowProp("tolerance",e)}get axisLineTolerance(){return this._shapes.x.tolerance}set axisArrowThickness(e){this._setArrowProp("arrowThickness",e)}get axisArrowThickness(){return this._shapes.x.arrowThickness}set axisArrowLength(e){this._setArrowProp("arrowLength",e)}get axisArrowLength(){return this._shapes.x.arrowLength}set axisPlaneSize(e){this._setPlaneProp("size",e)}get axisPlaneSize(){return this._shapes.yz.size}set axisPlaneGap(e){this._setPlaneProp("gap",e)}get axisPlaneGap(){return this._shapes.yz.gap}set axisCenterSize(e){this._shapes.face.size=e}get axisCenterSize(){return this._shapes.face.size}set axisCenterTolerance(e){this._shapes.face.tolerance=e}get axisCenterTolerance(){return this._shapes.face.tolerance}_setArrowProp(e,t){this._shapes.x[e]=t,this._shapes.y[e]=t,this._shapes.z[e]=t}_setPlaneProp(e,t){this._shapes.yz[e]=t,this._shapes.xz[e]=t,this._shapes.xy[e]=t}_shapesLookAtCamera(){let e=this.facing,t=e.dot(this.root.right);this._shapes.x.entity.enabled=Math.abs(t)<zg,this.flipShapes&&(this._shapes.x.flipped=t<0),t=e.dot(this.root.up),this._shapes.y.entity.enabled=Math.abs(t)<zg,this.flipShapes&&(this._shapes.y.flipped=t<0),t=e.dot(this.root.forward),this._shapes.z.entity.enabled=Math.abs(t)<zg,this.flipShapes&&(this._shapes.z.flipped=t>0),Qs.cross(e,this.root.right),this._shapes.yz.entity.enabled=Qs.length()<zg,this.flipShapes&&(this._shapes.yz.flipped=Tn.set(0,+(Qs.dot(this.root.forward)<0),+(Qs.dot(this.root.up)<0))),Qs.cross(e,this.root.forward),this._shapes.xy.entity.enabled=Qs.length()<zg,this.flipShapes&&(this._shapes.xy.flipped=Tn.set(+(Qs.dot(this.root.up)<0),+(Qs.dot(this.root.right)>0),0)),Qs.cross(e,this.root.up),this._shapes.xz.entity.enabled=Qs.length()<zg,this.flipShapes&&(this._shapes.xz.flipped=Tn.set(+(Qs.dot(this.root.forward)>0),0,+(Qs.dot(this.root.right)>0)))}_storeNodePositions(){for(let e=0;e<this.nodes.length;e++){let t=this.nodes[e];this._nodeLocalPositions.set(t,t.getLocalPosition().clone()),this._nodePositions.set(t,t.getPosition().clone())}}_setNodePositions(e){for(let t=0;t<this.nodes.length;t++){let s=this.nodes[t];if(this._coordSpace===Sn){let i=this._nodeLocalPositions.get(s);if(!i)continue;Qs.copy(e),s.parent?.getWorldTransform().getScale(Tn),Tn.x=1/Tn.x,Tn.y=1/Tn.y,Tn.z=1/Tn.z,Jse.copy(s.getLocalRotation()).transformVector(Qs,Qs),Qs.mul(Tn),s.setLocalPosition(Qs.add(i))}else{let i=this._nodePositions.get(s);if(!i)continue;s.setPosition(Qs.copy(e).add(i))}}this._updatePosition()}_screenToPoint(e,t){let s=this._camera.screenToWorld(e,t,1),i=this._selectedAxis,r=this._selectedIsPlane,a=this._createRay(s),n=this._createPlane(i,i===Ni,!r),l=new g;return n.intersectsRay(a,l),Jse.copy(this._rootStartRot).invert().transformVector(l,l),!r&&i!==Ni&&this._projectToAxis(l,i),l}}});var bce,Mce,Zd,tie=m(()=>{up();qd();jd();bce=80,Mce=20,Zd=class extends _r{constructor(e,t={}){super(e,t),this._tubeRadius=.01,this._ringRadius=.5,this._tolerance=.05,this._tubeRadius=t.tubeRadius??this._tubeRadius,this._ringRadius=t.ringRadius??this._ringRadius,this._sectorAngle=t.sectorAngle??this._sectorAngle,this.triData=[new Pi(this._createTorusGeometry())],this._createDisk()}_createTorusGeometry(){return new Dr({tubeRadius:this._tubeRadius+this._tolerance,ringRadius:this._ringRadius,sectorAngle:this._sectorAngle,segments:Mce})}_createTorusMesh(e){let t=new Dr({tubeRadius:this._tubeRadius,ringRadius:this._ringRadius,sectorAngle:e,segments:bce});return this._createMesh(t,this._shading)}_createDisk(){this._createRoot("disk"),this._createRenderComponent(this.entity,[this._createTorusMesh(this._sectorAngle),this._createTorusMesh(360)]),this.drag(!1)}set tubeRadius(e){this._tubeRadius=e??.1,this._updateTransform()}get tubeRadius(){return this._tubeRadius}set ringRadius(e){this._ringRadius=e??.1,this._updateTransform()}get ringRadius(){return this._ringRadius}set tolerance(e){this._tolerance=e,this._updateTransform()}get tolerance(){return this._tolerance}_updateTransform(){this.triData[0].fromGeometry(this._createTorusGeometry()),this.meshInstances[0].mesh=this._createTorusMesh(this._sectorAngle),this.meshInstances[1].mesh=this._createTorusMesh(360)}drag(e){this.meshInstances[0].visible=!e,this.meshInstances[1].visible=e}hide(e){if(e){this.meshInstances[0].visible=!1,this.meshInstances[1].visible=!1;return}this.drag(!1)}}});var ft,Qd,sie,iie,rie,En,LC,Dce,Oce,bC,aie=m(()=>{me();De();Ve();Ke();Q();J();tie();Yd();SE();ft=new g,Qd=new g,sie=new g,iie=new g,rie=new k,En=new H,LC=new H,Dce=.9,Oce=new N(0,0,0,.3),bC=class extends os{constructor(e,t){super(e,t),this._shapes={z:new Zd(this._device,{axis:"z",layers:[this._layer.id],shading:this._shading,rotation:new g(90,0,90),defaultColor:this._meshColors.axis.z,hoverColor:this._meshColors.hover.z,sectorAngle:180}),x:new Zd(this._device,{axis:"x",layers:[this._layer.id],shading:this._shading,rotation:new g(0,0,-90),defaultColor:this._meshColors.axis.x,hoverColor:this._meshColors.hover.x,sectorAngle:180}),y:new Zd(this._device,{axis:"y",layers:[this._layer.id],shading:this._shading,rotation:new g(0,0,0),defaultColor:this._meshColors.axis.y,hoverColor:this._meshColors.hover.y,sectorAngle:180}),face:new Zd(this._device,{axis:Ni,layers:[this._layer.id],shading:this._shading,rotation:this._getLookAtEulerAngles(this._camera.entity.getPosition()),defaultColor:this._meshColors.axis.f,hoverColor:this._meshColors.hover.f,ringRadius:.55})},this._selectionStartAngle=0,this._nodeLocalRotations=new Map,this._nodeRotations=new Map,this._nodeOffsets=new Map,this._guideAngleStartColor=Oce.clone(),this._guideAngleStart=new g,this._guideAngleEnd=new g,this.snapIncrement=5,this.orbitRotation=!1,this._createTransform(),this.on(os.EVENT_TRANSFORMSTART,(s,i,r)=>{this._selectionStartAngle=this._calculateAngle(s,i,r),this._storeNodeRotations(),this._storeGuidePoints(),this._drag(!0)}),this.on(os.EVENT_TRANSFORMMOVE,(s,i,r)=>{let a=this._selectedAxis,n=this._calculateAngle(s,i,r)-this._selectionStartAngle;this.snap&&(n=Math.round(n/this.snapIncrement)*this.snapIncrement),this._setNodeRotations(a,n),this._updateGuidePoints(n)}),this.on(os.EVENT_TRANSFORMEND,()=>{this._drag(!1)}),this.on(os.EVENT_NODESDETACH,()=>{this._nodeLocalRotations.clear(),this._nodeRotations.clear(),this._nodeOffsets.clear()}),this._app.on("prerender",()=>{if(this._shapesLookAtCamera(),this._dragging){let s=this.root.getPosition();this._drawGuideAngleLine(s,this._selectedAxis,this._guideAngleStart,this._guideAngleStartColor),this._drawGuideAngleLine(s,this._selectedAxis,this._guideAngleEnd)}})}set xyzTubeRadius(e){this._setDiskProp("tubeRadius",e)}get xyzTubeRadius(){return this._shapes.x.tubeRadius}set xyzRingRadius(e){this._setDiskProp("ringRadius",e)}get xyzRingRadius(){return this._shapes.x.ringRadius}set faceTubeRadius(e){this._shapes.face.tubeRadius=e}get faceTubeRadius(){return this._shapes.face.tubeRadius}set faceRingRadius(e){this._shapes.face.ringRadius=e}get faceRingRadius(){return this._shapes.face.ringRadius}set ringTolerance(e){this._setDiskProp("tolerance",e),this._shapes.face.tolerance=e}get ringTolerance(){return this._shapes.x.tolerance}_setDiskProp(e,t){this._shapes.x[e]=t,this._shapes.y[e]=t,this._shapes.z[e]=t}_storeGuidePoints(){let e=this.root.getPosition(),i=this._selectedAxis===Ni?this.faceRingRadius:this.xyzRingRadius;this._guideAngleStart.copy(this._selectionStartPoint).sub(e).normalize(),this._guideAngleStart.mulScalar(i),this._guideAngleEnd.copy(this._guideAngleStart)}_updateGuidePoints(e){let t=this._selectedAxis;t===Ni?ft.copy(this.facing):(ft.set(0,0,0),ft[t]=1,this._rootStartRot.transformVector(ft,ft)),En.setFromAxisAngle(ft,e),En.transformVector(this._guideAngleStart,this._guideAngleEnd)}_drawGuideAngleLine(e,t,s,i=this._guideColors[t]){ft.set(0,0,0),Qd.copy(s).mulScalar(this._scale),this._app.drawLine(ft.add(e),Qd.add(e),i,!1,this._layer)}_getLookAtEulerAngles(e){return ft.set(0,0,0),rie.setLookAt(ft,e,g.UP),En.setFromMat4(rie),En.getEulerAngles(ft),ft.x+=90,ft}_shapesLookAtCamera(){this._camera.projection===Mt?(this._shapes.face.entity.lookAt(this._camera.entity.getPosition()),this._shapes.face.entity.rotateLocal(90,0,0)):(En.copy(this._camera.entity.getRotation()).getEulerAngles(ft),this._shapes.face.entity.setEulerAngles(ft),this._shapes.face.entity.rotateLocal(-90,0,0));let e=ft.copy(this.facing);En.copy(this.root.getRotation()).invert().transformVector(e,e);let t=Math.atan2(e.z,e.y)*w.RAD_TO_DEG;this._shapes.x.entity.setLocalEulerAngles(0,t-90,-90),t=Math.atan2(e.x,e.z)*w.RAD_TO_DEG,this._shapes.y.entity.setLocalEulerAngles(0,t,0),t=Math.atan2(e.y,e.x)*w.RAD_TO_DEG,this._shapes.z.entity.setLocalEulerAngles(90,0,t+90)}_drag(e){for(let t in this._shapes){let s=this._shapes[t];t===this._selectedAxis?s.drag(e):s.hide(e)}this.fire(os.EVENT_RENDERUPDATE)}_storeNodeRotations(){let e=this.root.getPosition();for(let t=0;t<this.nodes.length;t++){let s=this.nodes[t];this._nodeLocalRotations.set(s,s.getLocalRotation().clone()),this._nodeRotations.set(s,s.getRotation().clone()),this._nodeOffsets.set(s,s.getPosition().clone().sub(e))}}_setNodeRotations(e,t){let s=this.root.getPosition(),i=e===Ni;En.setFromAxisAngle(this._dirFromAxis(e,ft),t);for(let r=0;r<this.nodes.length;r++){let a=this.nodes[r];if(!i&&this._coordSpace===Sn){let n=this._nodeLocalRotations.get(a);if(!n)continue;LC.copy(n).mul(En),a.setLocalRotation(LC)}else{let n=this._nodeRotations.get(a);if(!n)continue;let l=this._nodeOffsets.get(a);if(!l)continue;ft.copy(l),En.transformVector(ft,ft),LC.copy(En).mul(n),a.setEulerAngles(LC.getEulerAngles()),a.setPosition(ft.add(s))}}this._coordSpace===Sn&&this._updateRotation()}_screenToPoint(e,t){let s=this._camera.screenToWorld(e,t,1),i=this._selectedAxis,r=this._createRay(s),a=this._createPlane(i,i===Ni,!1),n=new g;return a.intersectsRay(r,n),n}_calculateAngle(e,t,s){let i=this.root.getPosition(),r=this._selectedAxis,a=this._createPlane(r,r===Ni,!1),n=0,l=Qd.copy(this.facing),h=a.normal.dot(l);return this.orbitRotation||Math.abs(h)>Dce?(ft.sub2(e,i),En.copy(this._camera.entity.getRotation()).invert().transformVector(ft,ft),n=Math.sign(h)*Math.atan2(ft.y,ft.x)*w.RAD_TO_DEG):(ft.copy(i),Qd.cross(a.normal,l).normalize().add(i),this._camera.worldToScreen(ft,sie),this._camera.worldToScreen(Qd,iie),ft.sub2(iie,sie).normalize(),Qd.set(t,s,0),n=ft.dot(Qd)),n}}});var MC,nie=m(()=>{Zh();qd();jd();MC=class extends _r{constructor(e,t={}){super(e,t),this._size=.12,this._tolerance=.05,this.triData=[new Pi(new hi,2)],this._createCenter()}_createCenter(){this._createRoot("boxCenter"),this._updateTransform(),this._addRenderMesh(this.entity,"box",this._shading)}set size(e){this._size=e??1,this._updateTransform()}get size(){return this._size}set tolerance(e){this._tolerance=e,this._updateTransform()}get tolerance(){return this._tolerance}_updateTransform(){this.entity.setLocalScale(this._size,this._size,this._size)}}});var Jd,DC,OC,Hg,oie=m(()=>{Ve();Q();ci();Zh();rd();qd();jd();Jd=new g,DC=new g,OC=new H,Hg=class extends _r{constructor(e,t={}){super(e,t),this._gap=0,this._lineThickness=.02,this._lineLength=.5,this._boxSize=.12,this._tolerance=.1,this._flipped=!1,this.triData=[new Pi(new hi),new Pi(new hr,1)],this._createBoxLine()}set gap(e){this._gap=e??0,this._updateLine(),this._updateBox()}get gap(){return this._gap}set lineThickness(e){this._lineThickness=e??1,this._updateLine(),this._updateBox()}get lineThickness(){return this._lineThickness}set lineLength(e){this._lineLength=e??1,this._updateLine(),this._updateBox()}get lineLength(){return this._lineLength}set boxSize(e){this._boxSize=e??1,this._updateBox()}get boxSize(){return this._boxSize}set tolerance(e){this._tolerance=e,this._updateLine()}get tolerance(){return this._tolerance}set flipped(e){this._flipped!==e&&(this._flipped=e,this._rotation.equals(g.ZERO)?Jd.set(0,0,this._flipped?180:0):Jd.copy(this._rotation).mulScalar(this._flipped?-1:1),this._line.enabled=!this._flipped,this.entity.setLocalEulerAngles(Jd))}get flipped(){return this._flipped}_createBoxLine(){this._createRoot("boxLine"),this._box=new be(`box:${this.axis}`),this.entity.addChild(this._box),this._updateBox(),this._addRenderMesh(this._box,"box",this._shading),this._line=new be(`line:${this.axis}`),this.entity.addChild(this._line),this._updateLine(),this._addRenderMesh(this._line,"cylinder",this._shading)}_updateBox(){Jd.set(0,this._gap+this._boxSize*.5+this._lineLength,0),OC.set(0,0,0,1),DC.set(this._boxSize,this._boxSize,this._boxSize),this.triData[0].setTransform(Jd,OC,DC),this._box.setLocalPosition(0,this._gap+this._boxSize*.5+this._lineLength,0),this._box.setLocalScale(this._boxSize,this._boxSize,this._boxSize)}_updateLine(){Jd.set(0,this._gap+this._lineLength*.5,0),OC.set(0,0,0,1),DC.set(this._lineThickness+this._tolerance,this._lineLength,this._lineThickness+this._tolerance),this.triData[1].setTransform(Jd,OC,DC),this._line.setLocalPosition(0,this._gap+this._lineLength*.5,0),this._line.setLocalScale(this._lineThickness,this._lineLength,this._lineThickness)}}});var ls,Ul,Nce,Fce,Xg,NC,lie=m(()=>{Q();Ve();Yd();SE();nie();LO();oie();ls=new g,Ul=new g,Nce=new g,Fce=new H,Xg=.98,NC=class extends os{constructor(e,t){super(e,t),this._shapes={xyz:new MC(this._device,{axis:"xyz",layers:[this._layer.id],shading:this._shading,defaultColor:this._meshColors.axis.xyz,hoverColor:this._meshColors.hover.xyz}),yz:new Mo(this._device,{axis:"x",layers:[this._layer.id],shading:this._shading,rotation:new g(0,0,-90),defaultColor:this._meshColors.axis.x,hoverColor:this._meshColors.hover.x}),xz:new Mo(this._device,{axis:"y",layers:[this._layer.id],shading:this._shading,rotation:new g(0,0,0),defaultColor:this._meshColors.axis.y,hoverColor:this._meshColors.hover.y}),xy:new Mo(this._device,{axis:"z",layers:[this._layer.id],shading:this._shading,rotation:new g(90,0,0),defaultColor:this._meshColors.axis.z,hoverColor:this._meshColors.hover.z}),x:new Hg(this._device,{axis:"x",layers:[this._layer.id],shading:this._shading,rotation:new g(0,0,-90),defaultColor:this._meshColors.axis.x,hoverColor:this._meshColors.hover.x}),y:new Hg(this._device,{axis:"y",layers:[this._layer.id],shading:this._shading,rotation:new g(0,0,0),defaultColor:this._meshColors.axis.y,hoverColor:this._meshColors.hover.y}),z:new Hg(this._device,{axis:"z",layers:[this._layer.id],shading:this._shading,rotation:new g(90,0,0),defaultColor:this._meshColors.axis.z,hoverColor:this._meshColors.hover.z})},this._coordSpace=Sn,this._nodeScales=new Map,this._useUniformScaling=!1,this.snapIncrement=1,this.flipShapes=!0,this.lowerBoundScale=new g(-1/0,-1/0,-1/0),this._createTransform(),this.on(os.EVENT_TRANSFORMSTART,()=>{this._storeNodeScales()}),this.on(os.EVENT_TRANSFORMMOVE,s=>{let i=Nce.copy(s).sub(this._selectionStartPoint);this.snap&&(i.mulScalar(1/this.snapIncrement),i.round(),i.mulScalar(this.snapIncrement)),i.mulScalar(1/this._scale),this._setNodeScales(i.add(g.ONE))}),this.on(os.EVENT_NODESDETACH,()=>{this._nodeScales.clear()}),this._app.on("prerender",()=>{this._shapesLookAtCamera()})}set coordSpace(e){}get coordSpace(){return this._coordSpace}set uniform(e){this._useUniformScaling=e??!0}get uniform(){return this._useUniformScaling}set axisGap(e){this._setArrowProp("gap",e)}get axisGap(){return this._shapes.x.gap}set axisLineThickness(e){this._setArrowProp("lineThickness",e)}get axisLineThickness(){return this._shapes.x.lineThickness}set axisLineLength(e){this._setArrowProp("lineLength",e)}get axisLineLength(){return this._shapes.x.lineLength}set axisLineTolerance(e){this._setArrowProp("tolerance",e)}get axisLineTolerance(){return this._shapes.x.tolerance}set axisBoxSize(e){this._setArrowProp("boxSize",e)}get axisBoxSize(){return this._shapes.x.boxSize}set axisPlaneSize(e){this._setPlaneProp("size",e)}get axisPlaneSize(){return this._shapes.yz.size}set axisPlaneGap(e){this._setPlaneProp("gap",e)}get axisPlaneGap(){return this._shapes.yz.gap}set axisCenterSize(e){this._shapes.xyz.size=e}get axisCenterSize(){return this._shapes.xyz.size}set axisCenterTolerance(e){this._shapes.xyz.tolerance=e}get axisCenterTolerance(){return this._shapes.xyz.tolerance}_setArrowProp(e,t){this._shapes.x[e]=t,this._shapes.y[e]=t,this._shapes.z[e]=t}_setPlaneProp(e,t){this._shapes.yz[e]=t,this._shapes.xz[e]=t,this._shapes.xy[e]=t}_shapesLookAtCamera(){let e=this.facing,t=e.dot(this.root.right);this._shapes.x.entity.enabled=Math.abs(t)<Xg,this.flipShapes&&(this._shapes.x.flipped=t<0),t=e.dot(this.root.up),this._shapes.y.entity.enabled=Math.abs(t)<Xg,this.flipShapes&&(this._shapes.y.flipped=t<0),t=e.dot(this.root.forward),this._shapes.z.entity.enabled=Math.abs(t)<Xg,this.flipShapes&&(this._shapes.z.flipped=t>0),ls.cross(e,this.root.right),this._shapes.yz.entity.enabled=ls.length()<Xg,this.flipShapes&&(this._shapes.yz.flipped=Ul.set(0,+(ls.dot(this.root.forward)<0),+(ls.dot(this.root.up)<0))),ls.cross(e,this.root.forward),this._shapes.xy.entity.enabled=ls.length()<Xg,this.flipShapes&&(this._shapes.xy.flipped=Ul.set(+(ls.dot(this.root.up)<0),+(ls.dot(this.root.right)>0),0)),ls.cross(e,this.root.up),this._shapes.xz.entity.enabled=ls.length()<Xg,this.flipShapes&&(this._shapes.xz.flipped=Ul.set(+(ls.dot(this.root.forward)>0),0,+(ls.dot(this.root.right)>0)))}_storeNodeScales(){for(let e=0;e<this.nodes.length;e++){let t=this.nodes[e];this._nodeScales.set(t,t.getLocalScale().clone())}}_setNodeScales(e){for(let t=0;t<this.nodes.length;t++){let s=this.nodes[t],i=this._nodeScales.get(s);i&&s.setLocalScale(ls.copy(i).mul(e).max(this.lowerBoundScale))}}_screenToPoint(e,t){let s=this.root.getPosition(),i=this._camera.screenToWorld(e,t,1),r=this._selectedAxis,a=this._selectedIsPlane,n=this._useUniformScaling&&a||r==="xyz",l=this._createRay(i),h=this._createPlane(r,n,!a),c=new g;if(h.intersectsRay(l,c),n){switch(r){case"x":ls.copy(this.root.up),Ul.copy(this.root.forward).mulScalar(-1);break;case"y":ls.copy(this.root.right),Ul.copy(this.root.forward).mulScalar(-1);break;case"z":ls.copy(this.root.up),Ul.copy(this.root.right);break;default:ls.copy(this._camera.entity.up),Ul.copy(this._camera.entity.right);break}Ul.add(ls).normalize(),ls.sub2(c,s);let d=ls.length()*ls.normalize().dot(Ul);return c.set(d,d,d),r!=="xyz"&&(c[r]=1),c}return Fce.copy(this._rootStartRot).invert().transformVector(c,c),a||this._projectToAxis(c,r),c}}});var Bl,Vl,kl,FC,UC,hie=m(()=>{Pe();De();Ke();Q();Ze();PC();Bl=new g,Vl=new g,kl=new g,FC=new k,UC=class o extends K{static{this.EVENT_CAMERAALIGN="camera:align"}constructor(e){super(),this._size=0,this._anchor=new W(1,1,1,1),this._colorX=Ug.clone(),this._colorY=Bg.clone(),this._colorZ=Vg.clone(),this._colorNeg=new N(.3,.3,.3),this._radius=10,this._textSize=10,this._lineThickness=2,this._lineLength=40,this.dom=document.createElement("div"),this.dom.id="view-cube-container",this.dom.style.cssText=["position: absolute","margin: auto","pointer-events: none"].join(";"),document.body.appendChild(this.dom),this.anchor=e??this._anchor,this._svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this._svg.id="view-cube-svg",this._group=document.createElementNS(this._svg.namespaceURI,"g"),this._svg.appendChild(this._group),this._resize();let t=this._colorX.toString(!1),s=this._colorY.toString(!1),i=this._colorZ.toString(!1);this._shapes={nx:this._circle(t),ny:this._circle(s),nz:this._circle(i),px:this._circle(t,!0,"X"),py:this._circle(s,!0,"Y"),pz:this._circle(i,!0,"Z"),xaxis:this._line(t),yaxis:this._line(s),zaxis:this._line(i)},this._shapes.px.children[0].addEventListener("pointerdown",()=>{this.fire(o.EVENT_CAMERAALIGN,g.RIGHT)}),this._shapes.py.children[0].addEventListener("pointerdown",()=>{this.fire(o.EVENT_CAMERAALIGN,g.UP)}),this._shapes.pz.children[0].addEventListener("pointerdown",()=>{this.fire(o.EVENT_CAMERAALIGN,g.BACK)}),this._shapes.nx.children[0].addEventListener("pointerdown",()=>{this.fire(o.EVENT_CAMERAALIGN,g.LEFT)}),this._shapes.ny.children[0].addEventListener("pointerdown",()=>{this.fire(o.EVENT_CAMERAALIGN,g.DOWN)}),this._shapes.nz.children[0].addEventListener("pointerdown",()=>{this.fire(o.EVENT_CAMERAALIGN,g.FORWARD)}),this.dom.appendChild(this._svg)}set anchor(e){this._anchor.copy(e),this.dom.style.top=this._anchor.x?"0px":"auto",this.dom.style.right=this._anchor.y?"0px":"auto",this.dom.style.bottom=this._anchor.z?"0px":"auto",this.dom.style.left=this._anchor.w?"0px":"auto"}get anchor(){return this._anchor}set colorX(e){this._colorX.copy(e),this._shapes.px.children[0].setAttribute("fill",this._colorX.toString(!1)),this._shapes.px.children[0].setAttribute("stroke",this._colorX.toString(!1)),this._shapes.nx.children[0].setAttribute("stroke",this._colorX.toString(!1)),this._shapes.xaxis.setAttribute("stroke",this._colorX.toString(!1))}get colorX(){return this._colorX}set colorY(e){this._colorY.copy(e),this._shapes.py.children[0].setAttribute("fill",this._colorY.toString(!1)),this._shapes.py.children[0].setAttribute("stroke",this._colorY.toString(!1)),this._shapes.ny.children[0].setAttribute("stroke",this._colorY.toString(!1)),this._shapes.yaxis.setAttribute("stroke",this._colorY.toString(!1))}get colorY(){return this._colorY}set colorZ(e){this._colorZ.copy(e),this._shapes.pz.children[0].setAttribute("fill",this._colorZ.toString(!1)),this._shapes.pz.children[0].setAttribute("stroke",this._colorZ.toString(!1)),this._shapes.nz.children[0].setAttribute("stroke",this._colorZ.toString(!1)),this._shapes.zaxis.setAttribute("stroke",this._colorZ.toString(!1))}get colorZ(){return this._colorZ}set colorNeg(e){this._colorNeg.copy(e),this._shapes.px.children[0].setAttribute("fill",this._colorNeg.toString(!1)),this._shapes.py.children[0].setAttribute("fill",this._colorNeg.toString(!1)),this._shapes.pz.children[0].setAttribute("fill",this._colorNeg.toString(!1))}get colorNeg(){return this._colorNeg}set radius(e){this._radius=e,this._shapes.px.children[0].setAttribute("r",`${e}`),this._shapes.py.children[0].setAttribute("r",`${e}`),this._shapes.pz.children[0].setAttribute("r",`${e}`),this._shapes.nx.children[0].setAttribute("r",`${e}`),this._shapes.ny.children[0].setAttribute("r",`${e}`),this._shapes.nz.children[0].setAttribute("r",`${e}`),this._resize()}get radius(){return this._radius}set textSize(e){this._textSize=e,this._shapes.px.children[1].setAttribute("font-size",`${e}`),this._shapes.py.children[1].setAttribute("font-size",`${e}`),this._shapes.pz.children[1].setAttribute("font-size",`${e}`)}get textSize(){return this._textSize}set lineThickness(e){this._lineThickness=e,this._shapes.xaxis.setAttribute("stroke-width",`${e}`),this._shapes.yaxis.setAttribute("stroke-width",`${e}`),this._shapes.zaxis.setAttribute("stroke-width",`${e}`),this._shapes.px.children[0].setAttribute("stroke-width",`${e}`),this._shapes.py.children[0].setAttribute("stroke-width",`${e}`),this._shapes.pz.children[0].setAttribute("stroke-width",`${e}`),this._shapes.nx.children[0].setAttribute("stroke-width",`${e}`),this._shapes.ny.children[0].setAttribute("stroke-width",`${e}`),this._shapes.nz.children[0].setAttribute("stroke-width",`${e}`),this._resize()}get lineThickness(){return this._lineThickness}set lineLength(e){this._lineLength=e,this._resize()}get lineLength(){return this._lineLength}_resize(){this._size=2*(this.lineLength+this.radius+this.lineThickness),this.dom.style.width=`${this._size}px`,this.dom.style.height=`${this._size}px`,this._svg.setAttribute("width",`${this._size}`),this._svg.setAttribute("height",`${this._size}`),this._group.setAttribute("transform",`translate(${this._size*.5}, ${this._size*.5})`)}_transform(e,t,s){e.setAttribute("transform",`translate(${t*this._lineLength}, ${s*this._lineLength})`)}_x2y2(e,t,s){e.setAttribute("x2",`${t*this._lineLength}`),e.setAttribute("y2",`${s*this._lineLength}`)}_line(e){let t=document.createElementNS(this._svg.namespaceURI,"line");return t.setAttribute("stroke",e),t.setAttribute("stroke-width",`${this._lineThickness}`),this._group.appendChild(t),t}_circle(e,t=!1,s){let i=document.createElementNS(this._svg.namespaceURI,"g"),r=document.createElementNS(this._svg.namespaceURI,"circle");if(r.setAttribute("fill",t?e:this._colorNeg.toString(!1)),r.setAttribute("stroke",e),r.setAttribute("stroke-width",`${this._lineThickness}`),r.setAttribute("r",`${this._radius}`),r.setAttribute("cx","0"),r.setAttribute("cy","0"),r.setAttribute("pointer-events","all"),i.appendChild(r),s){let a=document.createElementNS(this._svg.namespaceURI,"text");a.setAttribute("font-size",`${this._textSize}`),a.setAttribute("font-family","Arial"),a.setAttribute("font-weight","bold"),a.setAttribute("text-anchor","middle"),a.setAttribute("alignment-baseline","central"),a.textContent=s,i.appendChild(a)}return i.setAttribute("cursor","pointer"),this._group.appendChild(i),i}update(e){if(!this._size)return;FC.invert(e),FC.getX(Bl),FC.getY(Vl),FC.getZ(kl),this._transform(this._shapes.px,Bl.x,-Bl.y),this._transform(this._shapes.nx,-Bl.x,Bl.y),this._transform(this._shapes.py,Vl.x,-Vl.y),this._transform(this._shapes.ny,-Vl.x,Vl.y),this._transform(this._shapes.pz,kl.x,-kl.y),this._transform(this._shapes.nz,-kl.x,kl.y),this._x2y2(this._shapes.xaxis,Bl.x,-Bl.y),this._x2y2(this._shapes.yaxis,Vl.x,-Vl.y),this._x2y2(this._shapes.zaxis,kl.x,-kl.y);let t=[{n:["xaxis","px"],value:Bl.z},{n:["yaxis","py"],value:Vl.z},{n:["zaxis","pz"],value:kl.z},{n:["nx"],value:-Bl.z},{n:["ny"],value:-Vl.z},{n:["nz"],value:-kl.z}].sort((i,r)=>i.value-r.value),s=document.createDocumentFragment();t.forEach(i=>{i.n.forEach(r=>{s.appendChild(this._shapes[r])})}),this._group.appendChild(s)}destroy(){this.dom.remove(),this.off()}}});var BC={};Eie(BC,{ABSOLUTE_URL:()=>La,ACTION_GAMEPAD:()=>mm,ACTION_KEYBOARD:()=>um,ACTION_MOUSE:()=>dm,ADDRESS_CLAMP_TO_EDGE:()=>Z,ADDRESS_MIRRORED_REPEAT:()=>Xr,ADDRESS_REPEAT:()=>je,AMBIENTSRC_AMBIENTSH:()=>Nf,AMBIENTSRC_CONSTANT:()=>Uf,AMBIENTSRC_ENVALATLAS:()=>Ff,ANIM_BLEND_1D:()=>M0,ANIM_BLEND_2D_CARTESIAN:()=>O0,ANIM_BLEND_2D_DIRECTIONAL:()=>D0,ANIM_BLEND_DIRECT:()=>N0,ANIM_CONTROL_STATES:()=>_l,ANIM_EQUAL_TO:()=>L0,ANIM_GREATER_THAN:()=>R0,ANIM_GREATER_THAN_EQUAL_TO:()=>I0,ANIM_INTERRUPTION_NEXT:()=>y0,ANIM_INTERRUPTION_NEXT_PREV:()=>P0,ANIM_INTERRUPTION_NONE:()=>Dp,ANIM_INTERRUPTION_PREV:()=>x0,ANIM_INTERRUPTION_PREV_NEXT:()=>A0,ANIM_LAYER_ADDITIVE:()=>F0,ANIM_LAYER_OVERWRITE:()=>Op,ANIM_LESS_THAN:()=>C0,ANIM_LESS_THAN_EQUAL_TO:()=>w0,ANIM_NOT_EQUAL_TO:()=>b0,ANIM_PARAMETER_BOOLEAN:()=>vT,ANIM_PARAMETER_FLOAT:()=>ET,ANIM_PARAMETER_INTEGER:()=>TT,ANIM_PARAMETER_TRIGGER:()=>_c,ANIM_STATE_ANY:()=>pl,ANIM_STATE_END:()=>xT,ANIM_STATE_START:()=>gc,ASPECT_AUTO:()=>Nh,ASPECT_MANUAL:()=>Gf,ASSET_ANIMATION:()=>sk,ASSET_AUDIO:()=>ik,ASSET_CONTAINER:()=>_k,ASSET_CSS:()=>uk,ASSET_CUBEMAP:()=>fk,ASSET_HTML:()=>mk,ASSET_IMAGE:()=>rk,ASSET_JSON:()=>ak,ASSET_MATERIAL:()=>ok,ASSET_MODEL:()=>nk,ASSET_SCRIPT:()=>pk,ASSET_SHADER:()=>dk,ASSET_TEXT:()=>lk,ASSET_TEXTURE:()=>hk,ASSET_TEXTUREATLAS:()=>ck,AXIS_KEY:()=>l3,AXIS_MOUSE_X:()=>s3,AXIS_MOUSE_Y:()=>i3,AXIS_PAD_L_X:()=>r3,AXIS_PAD_L_Y:()=>a3,AXIS_PAD_R_X:()=>n3,AXIS_PAD_R_Y:()=>o3,AnimBinder:()=>Ma,AnimClip:()=>mc,AnimClipHandler:()=>b_,AnimComponent:()=>cd,AnimComponentLayer:()=>Bp,AnimComponentSystem:()=>Vp,AnimController:()=>Up,AnimCurve:()=>Vc,AnimData:()=>Po,AnimEvaluator:()=>Tc,AnimEvents:()=>Ec,AnimSnapshot:()=>ld,AnimStateGraph:()=>yo,AnimStateGraphHandler:()=>M_,AnimTarget:()=>Sl,AnimTrack:()=>$s,Animation:()=>sd,AnimationComponent:()=>hd,AnimationComponentSystem:()=>Fp,AnimationHandler:()=>L_,AnimationKey:()=>dl,AnimationNode:()=>ul,AppBase:()=>js,AppOptions:()=>uc,Application:()=>NR,Asset:()=>re,AssetListLoader:()=>vg,AssetReference:()=>Oa,AssetRegistry:()=>fc,AudioHandler:()=>D_,AudioListenerComponent:()=>fd,AudioListenerComponentSystem:()=>kp,BAKE_COLOR:()=>$U,BAKE_COLORDIR:()=>Oh,BINDGROUP_MESH:()=>ca,BINDGROUP_MESH_UB:()=>Rr,BINDGROUP_VIEW:()=>Ha,BLENDEQUATION_ADD:()=>vs,BLENDEQUATION_MAX:()=>VE,BLENDEQUATION_MIN:()=>BE,BLENDEQUATION_REVERSE_SUBTRACT:()=>UE,BLENDEQUATION_SUBTRACT:()=>x1,BLENDMODE_CONSTANT:()=>Jg,BLENDMODE_CONSTANT_ALPHA:()=>PJ,BLENDMODE_CONSTANT_COLOR:()=>yJ,BLENDMODE_DST_ALPHA:()=>E1,BLENDMODE_DST_COLOR:()=>Qg,BLENDMODE_ONE:()=>Jt,BLENDMODE_ONE_MINUS_CONSTANT:()=>eS,BLENDMODE_ONE_MINUS_CONSTANT_ALPHA:()=>RJ,BLENDMODE_ONE_MINUS_CONSTANT_COLOR:()=>AJ,BLENDMODE_ONE_MINUS_DST_ALPHA:()=>v1,BLENDMODE_ONE_MINUS_DST_COLOR:()=>FE,BLENDMODE_ONE_MINUS_SRC_ALPHA:()=>In,BLENDMODE_ONE_MINUS_SRC_COLOR:()=>S1,BLENDMODE_SRC_ALPHA:()=>Cn,BLENDMODE_SRC_ALPHA_SATURATE:()=>T1,BLENDMODE_SRC_COLOR:()=>NE,BLENDMODE_ZERO:()=>mu,BLEND_ADDITIVE:()=>yf,BLEND_ADDITIVEALPHA:()=>Pf,BLEND_MAX:()=>wf,BLEND_MIN:()=>If,BLEND_MULTIPLICATIVE:()=>Af,BLEND_MULTIPLICATIVE2X:()=>Rf,BLEND_NONE:()=>$t,BLEND_NORMAL:()=>es,BLEND_PREMULTIPLIED:()=>er,BLEND_SCREEN:()=>Cf,BLEND_SUBTRACTIVE:()=>xf,BLUR_BOX:()=>AU,BLUR_GAUSSIAN:()=>yh,BODYFLAG_KINEMATIC_OBJECT:()=>Yp,BODYFLAG_NORESPONSE_OBJECT:()=>Tl,BODYFLAG_STATIC_OBJECT:()=>rP,BODYGROUP_DEFAULT:()=>Sj,BODYGROUP_DYNAMIC:()=>oP,BODYGROUP_ENGINE_1:()=>Tj,BODYGROUP_ENGINE_2:()=>Ej,BODYGROUP_ENGINE_3:()=>vj,BODYGROUP_KINEMATIC:()=>lP,BODYGROUP_NONE:()=>gj,BODYGROUP_STATIC:()=>MT,BODYGROUP_TRIGGER:()=>hP,BODYGROUP_USER_1:()=>xj,BODYGROUP_USER_2:()=>yj,BODYGROUP_USER_3:()=>Aj,BODYGROUP_USER_4:()=>Pj,BODYGROUP_USER_5:()=>Rj,BODYGROUP_USER_6:()=>Cj,BODYGROUP_USER_7:()=>Ij,BODYGROUP_USER_8:()=>wj,BODYMASK_ALL:()=>DT,BODYMASK_NONE:()=>Lj,BODYMASK_NOT_STATIC:()=>Kp,BODYMASK_NOT_STATIC_KINEMATIC:()=>Mj,BODYMASK_STATIC:()=>bj,BODYSTATE_ACTIVE_TAG:()=>Pc,BODYSTATE_DISABLE_DEACTIVATION:()=>ud,BODYSTATE_DISABLE_SIMULATION:()=>md,BODYSTATE_ISLAND_SLEEPING:()=>aP,BODYSTATE_WANTS_DEACTIVATION:()=>nP,BODYTYPE_DYNAMIC:()=>yi,BODYTYPE_KINEMATIC:()=>fn,BODYTYPE_STATIC:()=>Ao,BUFFERUSAGE_COPY_DST:()=>jc,BUFFERUSAGE_COPY_SRC:()=>A1,BUFFERUSAGE_INDEX:()=>uI,BUFFERUSAGE_INDIRECT:()=>kE,BUFFERUSAGE_READ:()=>pu,BUFFERUSAGE_STORAGE:()=>tS,BUFFERUSAGE_UNIFORM:()=>pI,BUFFERUSAGE_VERTEX:()=>mI,BUFFERUSAGE_WRITE:()=>y1,BUFFER_DYNAMIC:()=>Jl,BUFFER_GPUDYNAMIC:()=>_u,BUFFER_STATIC:()=>xs,BUFFER_STREAM:()=>sS,BUTTON_TRANSITION_MODE_SPRITE_CHANGE:()=>J0,BUTTON_TRANSITION_MODE_TINT:()=>IT,Batch:()=>Hf,BatchGroup:()=>wt,BatchManager:()=>Um,BinaryHandler:()=>O_,BindGroupFormat:()=>_i,BindStorageBufferFormat:()=>pf,BindStorageTextureFormat:()=>dS,BindTextureFormat:()=>Zn,BindUniformBufferFormat:()=>Wa,BlendState:()=>Ie,BoundingBox:()=>_e,BoundingSphere:()=>Hr,BoxGeometry:()=>hi,Bundle:()=>Cp,BundleHandler:()=>Ip,BundleRegistry:()=>Pp,ButtonComponent:()=>Hp,ButtonComponentSystem:()=>Xp,CHUNKAPI_1_51:()=>CJ,CHUNKAPI_1_55:()=>IJ,CHUNKAPI_1_56:()=>wJ,CHUNKAPI_1_57:()=>LJ,CHUNKAPI_1_58:()=>bJ,CHUNKAPI_1_60:()=>MJ,CHUNKAPI_1_62:()=>DJ,CHUNKAPI_1_65:()=>OJ,CHUNKAPI_1_70:()=>NJ,CHUNKAPI_2_1:()=>FJ,CHUNKAPI_2_3:()=>UJ,CHUNKAPI_2_5:()=>BJ,CHUNKAPI_2_6:()=>VJ,CHUNKAPI_2_7:()=>kJ,CHUNKAPI_2_8:()=>GJ,CLEARFLAG_COLOR:()=>Wr,CLEARFLAG_DEPTH:()=>Yr,CLEARFLAG_STENCIL:()=>wn,CUBEFACE_NEGX:()=>R1,CUBEFACE_NEGY:()=>I1,CUBEFACE_NEGZ:()=>L1,CUBEFACE_POSX:()=>P1,CUBEFACE_POSY:()=>C1,CUBEFACE_POSZ:()=>w1,CUBEPROJ_BOX:()=>OS,CUBEPROJ_NONE:()=>Of,CULLFACE_BACK:()=>Ci,CULLFACE_FRONT:()=>Oo,CULLFACE_FRONTANDBACK:()=>_I,CULLFACE_NONE:()=>He,CURVE_LINEAR:()=>eI,CURVE_SMOOTHSTEP:()=>qg,CURVE_SPLINE:()=>LE,CURVE_STEP:()=>tI,Camera:()=>co,CameraComponent:()=>cr,CameraComponentSystem:()=>Nc,CameraFrame:()=>dC,CameraFrameOptions:()=>zd,CanvasFont:()=>FR,CapsuleGeometry:()=>nc,ChunkUtils:()=>li,CollisionComponent:()=>Wp,CollisionComponentSystem:()=>jp,Color:()=>N,Component:()=>ae,ComponentSystem:()=>Me,ComponentSystemRegistry:()=>Rp,Compute:()=>Gx,ConeGeometry:()=>Ia,ContactPoint:()=>BT,ContactResult:()=>VT,ContainerHandler:()=>F_,ContainerResource:()=>aR,Controller:()=>jx,CssHandler:()=>U_,CubemapHandler:()=>B_,Curve:()=>Ts,CurveSet:()=>Bi,CylinderGeometry:()=>hr,DETAILMODE_ADD:()=>LU,DETAILMODE_MAX:()=>OU,DETAILMODE_MIN:()=>DU,DETAILMODE_MUL:()=>NS,DETAILMODE_OVERLAY:()=>MU,DETAILMODE_SCREEN:()=>bU,DEVICETYPE_NULL:()=>dh,DEVICETYPE_WEBGL2:()=>fh,DEVICETYPE_WEBGPU:()=>Du,DISPLAYFORMAT_HDR:()=>Gv,DISPLAYFORMAT_LDR:()=>kv,DISPLAYFORMAT_LDR_SRGB:()=>mf,DISTANCE_EXPONENTIAL:()=>ty,DISTANCE_INVERSE:()=>ey,DISTANCE_LINEAR:()=>vf,DITHER_BAYER8:()=>oL,DITHER_BLUENOISE:()=>lL,DITHER_IGNNOISE:()=>hL,DITHER_NONE:()=>Ei,DefaultAnimBinder:()=>vc,DepthState:()=>$e,DomeGeometry:()=>ep,DualGestureSource:()=>mC,ELEMENTTYPE_GROUP:()=>yc,ELEMENTTYPE_IMAGE:()=>dd,ELEMENTTYPE_TEXT:()=>Gp,EMITTERSHAPE_BOX:()=>Si,EMITTERSHAPE_SPHERE:()=>dy,EVENT_CULL_END:()=>by,EVENT_GAMEPADCONNECTED:()=>ree,EVENT_GAMEPADDISCONNECTED:()=>aee,EVENT_KEYDOWN:()=>see,EVENT_KEYUP:()=>iee,EVENT_MOUSEDOWN:()=>tE,EVENT_MOUSEMOVE:()=>sE,EVENT_MOUSEUP:()=>iE,EVENT_MOUSEWHEEL:()=>rE,EVENT_POSTCULL:()=>Dm,EVENT_POSTRENDER:()=>Iy,EVENT_POSTRENDER_LAYER:()=>Ly,EVENT_PRECULL:()=>Mm,EVENT_PRERENDER:()=>Cy,EVENT_PRERENDER_LAYER:()=>wy,EVENT_SELECT:()=>nee,EVENT_SELECTEND:()=>lee,EVENT_SELECTSTART:()=>oee,EVENT_TOUCHCANCEL:()=>lE,EVENT_TOUCHEND:()=>nE,EVENT_TOUCHMOVE:()=>oE,EVENT_TOUCHSTART:()=>aE,ElementComponent:()=>Cc,ElementComponentSystem:()=>e_,ElementDragHelper:()=>Mc,ElementInput:()=>Ag,ElementInputEvent:()=>Vd,ElementMouseEvent:()=>Ml,ElementSelectEvent:()=>Fa,ElementTouchEvent:()=>Dl,Entity:()=>be,EnvLighting:()=>Jh,EventHandle:()=>iu,EventHandler:()=>K,FILLMODE_FILL_WINDOW:()=>JA,FILLMODE_KEEP_ASPECT:()=>cT,FILLMODE_NONE:()=>QA,FILTER_LINEAR:()=>we,FILTER_LINEAR_MIPMAP_LINEAR:()=>is,FILTER_LINEAR_MIPMAP_NEAREST:()=>Gi,FILTER_NEAREST:()=>fe,FILTER_NEAREST_MIPMAP_LINEAR:()=>ki,FILTER_NEAREST_MIPMAP_NEAREST:()=>Vi,FITMODE_CONTAIN:()=>eP,FITMODE_COVER:()=>tP,FITMODE_STRETCH:()=>Ac,FITTING_BOTH:()=>wM,FITTING_NONE:()=>NT,FITTING_SHRINK:()=>xP,FITTING_STRETCH:()=>IM,FOG_EXP:()=>cU,FOG_EXP2:()=>fU,FOG_LINEAR:()=>ny,FOG_NONE:()=>tr,FONT_BITMAP:()=>uP,FONT_MSDF:()=>Rc,FRESNEL_NONE:()=>rL,FRESNEL_SCHLICK:()=>Qo,FUNC_ALWAYS:()=>zi,FUNC_EQUAL:()=>th,FUNC_GREATER:()=>SI,FUNC_GREATEREQUAL:()=>EI,FUNC_LESS:()=>eh,FUNC_LESSEQUAL:()=>iS,FUNC_NEVER:()=>gI,FUNC_NOTEQUAL:()=>TI,FloatPacking:()=>Bs,FlyController:()=>vC,FocusController:()=>yC,FogParams:()=>ip,FolderHandler:()=>V_,Font:()=>Ld,FontHandler:()=>k_,ForwardRenderer:()=>Wh,Frustum:()=>du,GAMMA_NONE:()=>Mi,GAMMA_SRGB:()=>io,GIZMOAXIS_FACE:()=>Ni,GIZMOAXIS_X:()=>Vr,GIZMOAXIS_XY:()=>kse,GIZMOAXIS_XYZ:()=>Kc,GIZMOAXIS_XZ:()=>Vse,GIZMOAXIS_Y:()=>kr,GIZMOAXIS_YZ:()=>Bse,GIZMOAXIS_Z:()=>Gr,GIZMOSPACE_LOCAL:()=>Sn,GIZMOSPACE_WORLD:()=>gE,GSplatComponent:()=>Id,GSplatComponentSystem:()=>Bc,GSplatData:()=>cn,GSplatHandler:()=>kc,GSplatInstance:()=>Tp,GSplatResource:()=>oc,GSplatResourceBase:()=>To,GSplatSogsData:()=>lc,GSplatSogsResource:()=>Ep,GamePads:()=>Qx,GamepadSource:()=>SC,Geometry:()=>Qt,Gizmo:()=>Ua,GltfExporter:()=>nC,GraphNode:()=>Ae,GraphicsDevice:()=>Qe,HierarchyHandler:()=>G_,HtmlHandler:()=>z_,Http:()=>jt,I18n:()=>ba,INDEXFORMAT_UINT16:()=>ys,INDEXFORMAT_UINT32:()=>Js,INDEXFORMAT_UINT8:()=>sh,INTERPOLATION_CUBIC:()=>ST,INTERPOLATION_LINEAR:()=>gT,INTERPOLATION_STEP:()=>T0,ImageElement:()=>$p,IndexBuffer:()=>Ls,IndexedList:()=>ru,InputConsumer:()=>pE,InputController:()=>Lo,InputDelta:()=>uE,InputFrame:()=>mE,InputSource:()=>ur,JointComponent:()=>Ic,JointComponentSystem:()=>t_,JsonHandler:()=>H_,JsonStandardMaterialParser:()=>X_,KEY_0:()=>b3,KEY_1:()=>M3,KEY_2:()=>D3,KEY_3:()=>O3,KEY_4:()=>N3,KEY_5:()=>F3,KEY_6:()=>U3,KEY_7:()=>B3,KEY_8:()=>V3,KEY_9:()=>k3,KEY_A:()=>H3,KEY_ADD:()=>IF,KEY_ALT:()=>p3,KEY_B:()=>X3,KEY_BACKSPACE:()=>h3,KEY_BACK_SLASH:()=>jF,KEY_C:()=>W3,KEY_CAPS_LOCK:()=>g3,KEY_CLOSE_BRACKET:()=>$F,KEY_COMMA:()=>WF,KEY_CONTEXT_MENU:()=>_F,KEY_CONTROL:()=>m3,KEY_D:()=>Y3,KEY_DECIMAL:()=>bF,KEY_DELETE:()=>L3,KEY_DIVIDE:()=>MF,KEY_DOWN:()=>C3,KEY_E:()=>K3,KEY_END:()=>x3,KEY_ENTER:()=>d3,KEY_EQUAL:()=>z3,KEY_ESCAPE:()=>S3,KEY_F:()=>q3,KEY_F1:()=>DF,KEY_F10:()=>zF,KEY_F11:()=>HF,KEY_F12:()=>XF,KEY_F2:()=>OF,KEY_F3:()=>NF,KEY_F4:()=>FF,KEY_F5:()=>UF,KEY_F6:()=>BF,KEY_F7:()=>VF,KEY_F8:()=>kF,KEY_F9:()=>GF,KEY_G:()=>j3,KEY_H:()=>$3,KEY_HOME:()=>y3,KEY_I:()=>Z3,KEY_INSERT:()=>w3,KEY_J:()=>Q3,KEY_K:()=>J3,KEY_L:()=>eF,KEY_LEFT:()=>A3,KEY_M:()=>tF,KEY_META:()=>ZF,KEY_MULTIPLY:()=>CF,KEY_N:()=>sF,KEY_NUMPAD_0:()=>gF,KEY_NUMPAD_1:()=>SF,KEY_NUMPAD_2:()=>TF,KEY_NUMPAD_3:()=>EF,KEY_NUMPAD_4:()=>vF,KEY_NUMPAD_5:()=>xF,KEY_NUMPAD_6:()=>yF,KEY_NUMPAD_7:()=>AF,KEY_NUMPAD_8:()=>PF,KEY_NUMPAD_9:()=>RF,KEY_O:()=>iF,KEY_OPEN_BRACKET:()=>qF,KEY_P:()=>rF,KEY_PAGE_DOWN:()=>v3,KEY_PAGE_UP:()=>E3,KEY_PAUSE:()=>_3,KEY_PERIOD:()=>YF,KEY_PRINT_SCREEN:()=>I3,KEY_Q:()=>aF,KEY_R:()=>nF,KEY_RETURN:()=>f3,KEY_RIGHT:()=>R3,KEY_S:()=>oF,KEY_SEMICOLON:()=>G3,KEY_SEPARATOR:()=>wF,KEY_SHIFT:()=>u3,KEY_SLASH:()=>KF,KEY_SPACE:()=>T3,KEY_SUBTRACT:()=>LF,KEY_T:()=>lF,KEY_TAB:()=>c3,KEY_U:()=>hF,KEY_UP:()=>P3,KEY_V:()=>cF,KEY_W:()=>fF,KEY_WINDOWS:()=>pF,KEY_X:()=>dF,KEY_Y:()=>uF,KEY_Z:()=>mF,Kernel:()=>lu,Key:()=>ZJ,Keyboard:()=>_m,KeyboardEvent:()=>pm,KeyboardMouseSource:()=>gC,LAYERID_DEPTH:()=>Xt,LAYERID_IMMEDIATE:()=>so,LAYERID_SKYBOX:()=>to,LAYERID_UI:()=>pa,LAYERID_WORLD:()=>ms,LAYER_GIZMO:()=>dU,LAYER_HUD:()=>ly,LAYER_WORLD:()=>ym,LIGHTFALLOFF_INVERSESQUARED:()=>LS,LIGHTFALLOFF_LINEAR:()=>Lf,LIGHTSHAPE_DISK:()=>IS,LIGHTSHAPE_PUNCTUAL:()=>bs,LIGHTSHAPE_RECT:()=>CS,LIGHTSHAPE_SPHERE:()=>wS,LIGHTTYPE_COUNT:()=>mU,LIGHTTYPE_DIRECTIONAL:()=>ge,LIGHTTYPE_OMNI:()=>Ge,LIGHTTYPE_POINT:()=>uU,LIGHTTYPE_SPOT:()=>Ye,LIGHT_COLOR_DIVIDER:()=>xh,Layer:()=>At,LayerComposition:()=>nl,LayoutCalculator:()=>i_,LayoutChildComponent:()=>gd,LayoutChildComponentSystem:()=>s_,LayoutGroupComponent:()=>Sd,LayoutGroupComponentSystem:()=>r_,Light:()=>Kh,LightComponent:()=>v_,LightComponentSystem:()=>Fc,LightingParams:()=>qh,Lightmapper:()=>Mp,LitMaterial:()=>VA,LitOptions:()=>JJ,LitShaderOptions:()=>on,LocalizedAsset:()=>Zp,MASK_AFFECT_DYNAMIC:()=>ps,MASK_AFFECT_LIGHTMAPPED:()=>ir,MASK_BAKE:()=>_a,MOTION_FREE:()=>xl,MOTION_LIMITED:()=>yl,MOTION_LOCKED:()=>Al,MOUSEBUTTON_LEFT:()=>_S,MOUSEBUTTON_MIDDLE:()=>gS,MOUSEBUTTON_NONE:()=>Ew,MOUSEBUTTON_RIGHT:()=>SS,Mat3:()=>Vs,Mat4:()=>k,Material:()=>Os,MaterialHandler:()=>W_,Mesh:()=>Ce,MeshInstance:()=>Oe,MiniStats:()=>eC,Model:()=>Ys,ModelComponent:()=>Pl,ModelComponentSystem:()=>a_,ModelHandler:()=>Y_,Morph:()=>po,MorphInstance:()=>br,MorphTarget:()=>jh,Mouse:()=>ma,MouseEvent:()=>qa,MultiTouchSource:()=>pC,Node:()=>QJ,NullGraphicsDevice:()=>fm,ORIENTATION_HORIZONTAL:()=>Ue,ORIENTATION_VERTICAL:()=>it,OrbitController:()=>xC,OrientedBox:()=>OE,OutlineRenderer:()=>sC,PAD_1:()=>Hx,PAD_2:()=>QF,PAD_3:()=>JF,PAD_4:()=>eU,PAD_DOWN:()=>Ow,PAD_FACE_1:()=>vw,PAD_FACE_2:()=>xw,PAD_FACE_3:()=>yw,PAD_FACE_4:()=>Aw,PAD_LEFT:()=>Nw,PAD_L_SHOULDER_1:()=>Pw,PAD_L_SHOULDER_2:()=>Cw,PAD_L_STICK_BUTTON:()=>bw,PAD_L_STICK_X:()=>TS,PAD_L_STICK_Y:()=>ES,PAD_RIGHT:()=>Fw,PAD_R_SHOULDER_1:()=>Rw,PAD_R_SHOULDER_2:()=>Iw,PAD_R_STICK_BUTTON:()=>Mw,PAD_R_STICK_X:()=>vS,PAD_R_STICK_Y:()=>xS,PAD_SELECT:()=>ww,PAD_START:()=>Lw,PAD_UP:()=>Dw,PAD_VENDOR:()=>Uw,PARTICLEMODE_CPU:()=>IU,PARTICLEMODE_GPU:()=>Pm,PARTICLEORIENTATION_EMITTER:()=>wU,PARTICLEORIENTATION_SCREEN:()=>Jo,PARTICLEORIENTATION_WORLD:()=>uy,PARTICLESORT_DISTANCE:()=>PU,PARTICLESORT_NEWER_FIRST:()=>RU,PARTICLESORT_NONE:()=>Mf,PARTICLESORT_OLDER_FIRST:()=>CU,PIXELFORMAT_111110F:()=>Ga,PIXELFORMAT_A8:()=>GE,PIXELFORMAT_ASTC_4x4:()=>XE,PIXELFORMAT_ASTC_4x4_SRGB:()=>mv,PIXELFORMAT_ATC_RGB:()=>WE,PIXELFORMAT_ATC_RGBA:()=>YE,PIXELFORMAT_BC6F:()=>pv,PIXELFORMAT_BC6UF:()=>_v,PIXELFORMAT_BC7:()=>gv,PIXELFORMAT_BC7_SRGBA:()=>Sv,PIXELFORMAT_BGRA8:()=>xu,PIXELFORMAT_DEPTH:()=>Kr,PIXELFORMAT_DEPTH16:()=>Bo,PIXELFORMAT_DEPTHSTENCIL:()=>Ln,PIXELFORMAT_DXT1:()=>Jc,PIXELFORMAT_DXT1_SRGB:()=>hv,PIXELFORMAT_DXT3:()=>Su,PIXELFORMAT_DXT3_SRGBA:()=>cv,PIXELFORMAT_DXT5:()=>No,PIXELFORMAT_DXT5_SRGBA:()=>fv,PIXELFORMAT_ETC1:()=>ef,PIXELFORMAT_ETC2_RGB:()=>Eu,PIXELFORMAT_ETC2_RGBA:()=>vu,PIXELFORMAT_ETC2_SRGB:()=>dv,PIXELFORMAT_ETC2_SRGBA:()=>uv,PIXELFORMAT_L8:()=>zE,PIXELFORMAT_L8_A8:()=>pJ,PIXELFORMAT_LA8:()=>$c,PIXELFORMAT_PVRTC_2BPP_RGBA_1:()=>Uo,PIXELFORMAT_PVRTC_2BPP_RGB_1:()=>Fo,PIXELFORMAT_PVRTC_4BPP_RGBA_1:()=>sf,PIXELFORMAT_PVRTC_4BPP_RGB_1:()=>tf,PIXELFORMAT_R16F:()=>Au,PIXELFORMAT_R16I:()=>jE,PIXELFORMAT_R16U:()=>$E,PIXELFORMAT_R32F:()=>Hi,PIXELFORMAT_R32I:()=>ZE,PIXELFORMAT_R32U:()=>rf,PIXELFORMAT_R4_G4_B4_A4:()=>SJ,PIXELFORMAT_R5_G5_B5_A1:()=>gJ,PIXELFORMAT_R5_G6_B5:()=>_J,PIXELFORMAT_R8:()=>rh,PIXELFORMAT_R8I:()=>KE,PIXELFORMAT_R8U:()=>qE,PIXELFORMAT_R8_G8_B8:()=>TJ,PIXELFORMAT_R8_G8_B8_A8:()=>EJ,PIXELFORMAT_RG16F:()=>lv,PIXELFORMAT_RG16I:()=>ev,PIXELFORMAT_RG16U:()=>tv,PIXELFORMAT_RG32I:()=>sv,PIXELFORMAT_RG32U:()=>iv,PIXELFORMAT_RG8:()=>rS,PIXELFORMAT_RG8I:()=>QE,PIXELFORMAT_RG8U:()=>JE,PIXELFORMAT_RGB16F:()=>Tu,PIXELFORMAT_RGB32F:()=>HE,PIXELFORMAT_RGB565:()=>Zc,PIXELFORMAT_RGB8:()=>ui,PIXELFORMAT_RGBA16F:()=>tt,PIXELFORMAT_RGBA16I:()=>nv,PIXELFORMAT_RGBA16U:()=>yu,PIXELFORMAT_RGBA32F:()=>St,PIXELFORMAT_RGBA32I:()=>ov,PIXELFORMAT_RGBA32U:()=>Ii,PIXELFORMAT_RGBA4:()=>Qc,PIXELFORMAT_RGBA5551:()=>gu,PIXELFORMAT_RGBA8:()=>Re,PIXELFORMAT_RGBA8I:()=>rv,PIXELFORMAT_RGBA8U:()=>av,PIXELFORMAT_SBGRA8:()=>Pu,PIXELFORMAT_SRGB:()=>vJ,PIXELFORMAT_SRGB8:()=>ih,PIXELFORMAT_SRGBA:()=>xJ,PIXELFORMAT_SRGBA8:()=>kt,PRIMITIVE_LINELOOP:()=>Cu,PRIMITIVE_LINES:()=>Mn,PRIMITIVE_LINESTRIP:()=>nh,PRIMITIVE_POINTS:()=>qr,PRIMITIVE_TRIANGLES:()=>As,PRIMITIVE_TRIFAN:()=>Wi,PRIMITIVE_TRISTRIP:()=>rs,PROJECTION_ORTHOGRAPHIC:()=>Xs,PROJECTION_PERSPECTIVE:()=>Mt,ParticleEmitter:()=>Qm,ParticleSystemComponent:()=>o_,ParticleSystemComponentSystem:()=>l_,Picker:()=>VR,Plane:()=>Rn,PlaneGeometry:()=>wa,Pose:()=>Zs,PostEffect:()=>UA,PostEffectQueue:()=>E_,ProgramLibrary:()=>mp,QuadRender:()=>Oi,Quat:()=>H,REFLECTIONSRC_CUBEMAP:()=>Ih,REFLECTIONSRC_ENVATLAS:()=>Rh,REFLECTIONSRC_ENVATLASHQ:()=>Ch,REFLECTIONSRC_NONE:()=>sr,REFLECTIONSRC_SPHEREMAP:()=>BS,RENDERSTYLE_POINTS:()=>Df,RENDERSTYLE_SOLID:()=>Qa,RENDERSTYLE_WIREFRAME:()=>Ja,RESOLUTION_AUTO:()=>ad,RESOLUTION_FIXED:()=>e0,RIGIDBODY_ACTIVE_TAG:()=>pee,RIGIDBODY_CF_KINEMATIC_OBJECT:()=>uee,RIGIDBODY_CF_NORESPONSE_OBJECT:()=>mee,RIGIDBODY_CF_STATIC_OBJECT:()=>dee,RIGIDBODY_DISABLE_DEACTIVATION:()=>See,RIGIDBODY_DISABLE_SIMULATION:()=>Tee,RIGIDBODY_ISLAND_SLEEPING:()=>_ee,RIGIDBODY_TYPE_DYNAMIC:()=>cee,RIGIDBODY_TYPE_KINEMATIC:()=>fee,RIGIDBODY_TYPE_STATIC:()=>hee,RIGIDBODY_WANTS_DEACTIVATION:()=>gee,Ray:()=>Es,RaycastResult:()=>f_,ReadStream:()=>Yl,RenderComponent:()=>Ed,RenderComponentSystem:()=>wc,RenderHandler:()=>R_,RenderPass:()=>Xe,RenderPassBloom:()=>wg,RenderPassCameraFrame:()=>Ng,RenderPassColorGrab:()=>kh,RenderPassCompose:()=>Lg,RenderPassDepthAwareBlur:()=>Gd,RenderPassDof:()=>Mg,RenderPassDownsample:()=>wo,RenderPassForward:()=>mo,RenderPassPrepass:()=>Dg,RenderPassShaderQuad:()=>gs,RenderPassSsao:()=>Og,RenderPassTAA:()=>bg,RenderPassUpsample:()=>Ig,RenderTarget:()=>xe,ResourceHandler:()=>ye,ResourceLoader:()=>dc,RigidBodyComponent:()=>Na,RigidBodyComponentSystem:()=>Lc,RotateGizmo:()=>bC,SAMPLETYPE_DEPTH:()=>si,SAMPLETYPE_FLOAT:()=>cs,SAMPLETYPE_INT:()=>vr,SAMPLETYPE_UINT:()=>xr,SAMPLETYPE_UNFILTERABLE_FLOAT:()=>Er,SCALEMODE_BLEND:()=>NP,SCALEMODE_NONE:()=>Il,SCROLLBAR_VISIBILITY_SHOW_ALWAYS:()=>ZM,SCROLLBAR_VISIBILITY_SHOW_WHEN_REQUIRED:()=>QM,SCROLL_MODE_BOUNCE:()=>BP,SCROLL_MODE_CLAMP:()=>jM,SCROLL_MODE_INFINITE:()=>$M,SEMANTIC_ATTR0:()=>Iu,SEMANTIC_ATTR1:()=>oh,SEMANTIC_ATTR10:()=>AI,SEMANTIC_ATTR11:()=>lf,SEMANTIC_ATTR12:()=>hf,SEMANTIC_ATTR13:()=>cf,SEMANTIC_ATTR14:()=>ff,SEMANTIC_ATTR15:()=>ta,SEMANTIC_ATTR2:()=>af,SEMANTIC_ATTR3:()=>nf,SEMANTIC_ATTR4:()=>of,SEMANTIC_ATTR5:()=>vI,SEMANTIC_ATTR6:()=>xI,SEMANTIC_ATTR7:()=>yI,SEMANTIC_ATTR8:()=>ko,SEMANTIC_ATTR9:()=>Go,SEMANTIC_BLENDINDICES:()=>Gt,SEMANTIC_BLENDWEIGHT:()=>hs,SEMANTIC_COLOR:()=>nt,SEMANTIC_NORMAL:()=>Pt,SEMANTIC_POSITION:()=>te,SEMANTIC_TANGENT:()=>as,SEMANTIC_TEXCOORD:()=>aS,SEMANTIC_TEXCOORD0:()=>ot,SEMANTIC_TEXCOORD1:()=>ks,SEMANTIC_TEXCOORD2:()=>jr,SEMANTIC_TEXCOORD3:()=>$r,SEMANTIC_TEXCOORD4:()=>Zr,SEMANTIC_TEXCOORD5:()=>Qr,SEMANTIC_TEXCOORD6:()=>Jr,SEMANTIC_TEXCOORD7:()=>ea,SHADERDEF_BATCH:()=>Vf,SHADERDEF_DIRLM:()=>wm,SHADERDEF_INSTANCING:()=>no,SHADERDEF_LM:()=>Bf,SHADERDEF_LMAMBIENT:()=>Lm,SHADERDEF_MORPH_NORMAL:()=>lo,SHADERDEF_MORPH_POSITION:()=>oo,SHADERDEF_MORPH_TEXTURE_BASED_INT:()=>ho,SHADERDEF_NOSHADOW:()=>wh,SHADERDEF_SCREENSPACE:()=>bh,SHADERDEF_SKIN:()=>ao,SHADERDEF_TANGENTS:()=>Mh,SHADERDEF_UV0:()=>Lh,SHADERDEF_UV1:()=>Cm,SHADERDEF_VCOLOR:()=>Im,SHADERLANGUAGE_GLSL:()=>oe,SHADERLANGUAGE_WGSL:()=>le,SHADERPASS_ALBEDO:()=>kU,SHADERPASS_AO:()=>YU,SHADERPASS_EMISSION:()=>KU,SHADERPASS_FORWARD:()=>VU,SHADERPASS_GLOSS:()=>XU,SHADERPASS_LIGHTING:()=>qU,SHADERPASS_METALNESS:()=>WU,SHADERPASS_OPACITY:()=>zU,SHADERPASS_SPECULARITY:()=>HU,SHADERPASS_UV0:()=>jU,SHADERPASS_WORLDNORMAL:()=>GU,SHADERSTAGE_COMPUTE:()=>Ou,SHADERSTAGE_FRAGMENT:()=>Li,SHADERSTAGE_VERTEX:()=>wi,SHADERTAG_MATERIAL:()=>wu,SHADER_FORWARD:()=>Ti,SHADER_PICK:()=>Sa,SHADER_PREPASS:()=>ga,SHADER_SHADOW:()=>bm,SHADOWUPDATE_NONE:()=>Ms,SHADOWUPDATE_REALTIME:()=>Dh,SHADOWUPDATE_THISFRAME:()=>Di,SHADOW_CASCADE_0:()=>EU,SHADOW_CASCADE_1:()=>vU,SHADOW_CASCADE_2:()=>xU,SHADOW_CASCADE_3:()=>yU,SHADOW_CASCADE_ALL:()=>fy,SHADOW_PCF1:()=>TU,SHADOW_PCF1_16F:()=>MS,SHADOW_PCF1_32F:()=>bS,SHADOW_PCF3:()=>pU,SHADOW_PCF3_16F:()=>DS,SHADOW_PCF3_32F:()=>Hs,SHADOW_PCF5:()=>SU,SHADOW_PCF5_16F:()=>nL,SHADOW_PCF5_32F:()=>aL,SHADOW_PCSS_32F:()=>Za,SHADOW_VSM16:()=>_U,SHADOW_VSM32:()=>gU,SHADOW_VSM_16F:()=>Am,SHADOW_VSM_32F:()=>bf,SKYTYPE_BOX:()=>Ay,SKYTYPE_DOME:()=>Py,SKYTYPE_INFINITE:()=>Fh,SORTMODE_BACK2FRONT:()=>VS,SORTMODE_CUSTOM:()=>yy,SORTMODE_FRONT2BACK:()=>xy,SORTMODE_MANUAL:()=>Ey,SORTMODE_MATERIALMESH:()=>vy,SORTMODE_NONE:()=>tn,SPECOCC_AO:()=>en,SPECOCC_GLOSSDEPENDENT:()=>US,SPECOCC_NONE:()=>FS,SPRITETYPE_ANIMATED:()=>HT,SPRITETYPE_SIMPLE:()=>zT,SPRITE_RENDERMODE_SIMPLE:()=>ni,SPRITE_RENDERMODE_SLICED:()=>Et,SPRITE_RENDERMODE_TILED:()=>vt,SSAOTYPE_COMBINE:()=>lC,SSAOTYPE_LIGHTING:()=>oC,SSAOTYPE_NONE:()=>Io,STENCILOP_DECREMENT:()=>yv,STENCILOP_DECREMENTWRAP:()=>D1,STENCILOP_INCREMENT:()=>xv,STENCILOP_INCREMENTWRAP:()=>M1,STENCILOP_INVERT:()=>O1,STENCILOP_KEEP:()=>Dn,STENCILOP_REPLACE:()=>vv,STENCILOP_ZERO:()=>b1,ScaleGizmo:()=>NC,Scene:()=>qs,SceneHandler:()=>K_,SceneRegistry:()=>Lp,SceneRegistryItem:()=>nd,SceneSettingsHandler:()=>kR,ScopeId:()=>qu,ScopeSpace:()=>ju,ScreenComponent:()=>xd,ScreenComponentSystem:()=>d_,Script:()=>pn,ScriptAttributes:()=>mn,ScriptComponent:()=>A_,ScriptComponentSystem:()=>Uc,ScriptHandler:()=>q_,ScriptRegistry:()=>wp,ScriptType:()=>fr,ScrollViewComponent:()=>u_,ScrollViewComponentSystem:()=>m_,ScrollbarComponent:()=>p_,ScrollbarComponentSystem:()=>__,Shader:()=>ai,ShaderChunks:()=>ie,ShaderHandler:()=>j_,ShaderMaterial:()=>oi,ShaderPass:()=>Ds,ShaderUtils:()=>Te,SingleContactResult:()=>UT,SingleGestureSource:()=>uC,Skeleton:()=>tc,Skin:()=>ec,SkinBatchInstance:()=>Yf,SkinInstance:()=>ar,Sky:()=>tp,SortedLoopArray:()=>yn,Sound:()=>Em,SoundComponent:()=>Ad,SoundComponentSystem:()=>g_,SoundInstance:()=>Ir,SoundInstance3d:()=>$a,SoundManager:()=>Tm,SoundSlot:()=>Dc,SphereGeometry:()=>or,Sprite:()=>rp,SpriteAnimationClip:()=>Oc,SpriteComponent:()=>Pd,SpriteComponentSystem:()=>S_,SpriteHandler:()=>$_,StandardMaterial:()=>ct,StandardMaterialOptions:()=>lr,StencilParameters:()=>ws,StorageBuffer:()=>om,TEXHINT_ASSET:()=>U1,TEXHINT_LIGHTMAP:()=>B1,TEXHINT_NONE:()=>N1,TEXHINT_SHADOWMAP:()=>F1,TEXPROPERTY_ADDRESS_U:()=>Uu,TEXPROPERTY_ADDRESS_V:()=>Bu,TEXPROPERTY_ADDRESS_W:()=>Vu,TEXPROPERTY_ALL:()=>zv,TEXPROPERTY_ANISOTROPY:()=>zu,TEXPROPERTY_COMPARE_FUNC:()=>Gu,TEXPROPERTY_COMPARE_ON_READ:()=>ku,TEXPROPERTY_MAG_FILTER:()=>Fu,TEXPROPERTY_MIN_FILTER:()=>Nu,TEXTUREDIMENSION_1D:()=>oS,TEXTUREDIMENSION_2D:()=>Gs,TEXTUREDIMENSION_2D_ARRAY:()=>Sr,TEXTUREDIMENSION_3D:()=>Fn,TEXTUREDIMENSION_CUBE:()=>Tr,TEXTUREDIMENSION_CUBE_ARRAY:()=>df,TEXTURELOCK_NONE:()=>Lu,TEXTURELOCK_READ:()=>bu,TEXTURELOCK_WRITE:()=>nS,TEXTUREPROJECTION_CUBE:()=>uf,TEXTUREPROJECTION_EQUIRECT:()=>lS,TEXTUREPROJECTION_NONE:()=>Av,TEXTUREPROJECTION_OCTAHEDRAL:()=>Pv,TEXTURETYPE_DEFAULT:()=>zt,TEXTURETYPE_RGBE:()=>zo,TEXTURETYPE_RGBM:()=>ti,TEXTURETYPE_RGBP:()=>On,TEXTURETYPE_SWIZZLEGGGR:()=>Nn,TONEMAP_ACES:()=>py,TONEMAP_ACES2:()=>UU,TONEMAP_FILMIC:()=>NU,TONEMAP_HEJL:()=>FU,TONEMAP_LINEAR:()=>ro,TONEMAP_NEUTRAL:()=>BU,TONEMAP_NONE:()=>Ah,TRACEID_BINDGROUPFORMAT_ALLOC:()=>ZO,TRACEID_BINDGROUP_ALLOC:()=>$O,TRACEID_COMPUTEPIPELINE_ALLOC:()=>JO,TRACEID_ELEMENT:()=>t1,TRACEID_GPU_TIMINGS:()=>yE,TRACEID_PIPELINELAYOUT_ALLOC:()=>e1,TRACEID_RENDERPIPELINE_ALLOC:()=>QO,TRACEID_RENDER_ACTION:()=>GO,TRACEID_RENDER_FRAME:()=>UO,TRACEID_RENDER_FRAME_TIME:()=>BO,TRACEID_RENDER_PASS:()=>VO,TRACEID_RENDER_PASS_DETAIL:()=>kO,TRACEID_RENDER_QUEUE:()=>i1,TRACEID_RENDER_TARGET_ALLOC:()=>zO,TRACEID_SHADER_ALLOC:()=>XO,TRACEID_SHADER_COMPILE:()=>WO,TRACEID_TEXTURES:()=>s1,TRACEID_TEXTURE_ALLOC:()=>HO,TRACEID_VRAM_IB:()=>qO,TRACEID_VRAM_SB:()=>jO,TRACEID_VRAM_TEXTURE:()=>YO,TRACEID_VRAM_VB:()=>KO,TYPE_FLOAT16:()=>Ho,TYPE_FLOAT32:()=>pe,TYPE_INT16:()=>Rs,TYPE_INT32:()=>ke,TYPE_INT8:()=>Ps,TYPE_UINT16:()=>mi,TYPE_UINT32:()=>gt,TYPE_UINT8:()=>zs,Tags:()=>Kl,Template:()=>Dd,TemplateHandler:()=>Z_,TextElement:()=>Qp,TextHandler:()=>Q_,Texture:()=>q,TextureAtlas:()=>ap,TextureAtlasHandler:()=>J_,TextureHandler:()=>Hc,TextureUtils:()=>Cs,TorusGeometry:()=>Dr,Touch:()=>gm,TouchDevice:()=>Sm,TouchEvent:()=>$o,Tracing:()=>au,TransformFeedback:()=>zx,TransformGizmo:()=>os,TranslateGizmo:()=>wC,Tri:()=>uu,UNIFORMTYPE_BOOL:()=>za,UNIFORMTYPE_BOOLARRAY:()=>Xn,UNIFORMTYPE_BVEC2:()=>Un,UNIFORMTYPE_BVEC2ARRAY:()=>Yn,UNIFORMTYPE_BVEC3:()=>Bn,UNIFORMTYPE_BVEC3ARRAY:()=>qn,UNIFORMTYPE_BVEC4:()=>Vn,UNIFORMTYPE_BVEC4ARRAY:()=>ch,UNIFORMTYPE_FLOAT:()=>Ht,UNIFORMTYPE_FLOATARRAY:()=>kn,UNIFORMTYPE_INT:()=>Yi,UNIFORMTYPE_INTARRAY:()=>oa,UNIFORMTYPE_ITEXTURE2D:()=>Mv,UNIFORMTYPE_ITEXTURE2D_ARRAY:()=>Bv,UNIFORMTYPE_ITEXTURE3D:()=>Fv,UNIFORMTYPE_ITEXTURECUBE:()=>Ov,UNIFORMTYPE_IVEC2:()=>yr,UNIFORMTYPE_IVEC2ARRAY:()=>la,UNIFORMTYPE_IVEC3:()=>Ar,UNIFORMTYPE_IVEC3ARRAY:()=>ha,UNIFORMTYPE_IVEC4:()=>Pr,UNIFORMTYPE_IVEC4ARRAY:()=>Wo,UNIFORMTYPE_MAT2:()=>Xo,UNIFORMTYPE_MAT3:()=>sa,UNIFORMTYPE_MAT4:()=>pi,UNIFORMTYPE_MAT4ARRAY:()=>Mu,UNIFORMTYPE_TEXTURE2D:()=>Rv,UNIFORMTYPE_TEXTURE2D_ARRAY:()=>bv,UNIFORMTYPE_TEXTURE2D_SHADOW:()=>Iv,UNIFORMTYPE_TEXTURE3D:()=>Lv,UNIFORMTYPE_TEXTURECUBE:()=>Cv,UNIFORMTYPE_TEXTURECUBE_SHADOW:()=>wv,UNIFORMTYPE_UINT:()=>ia,UNIFORMTYPE_UINTARRAY:()=>Hn,UNIFORMTYPE_UTEXTURE2D:()=>Dv,UNIFORMTYPE_UTEXTURE2D_ARRAY:()=>Vv,UNIFORMTYPE_UTEXTURE3D:()=>Uv,UNIFORMTYPE_UTEXTURECUBE:()=>Nv,UNIFORMTYPE_UVEC2:()=>ra,UNIFORMTYPE_UVEC2ARRAY:()=>Wn,UNIFORMTYPE_UVEC3:()=>aa,UNIFORMTYPE_UVEC3ARRAY:()=>Kn,UNIFORMTYPE_UVEC4:()=>na,UNIFORMTYPE_UVEC4ARRAY:()=>hh,UNIFORMTYPE_VEC2:()=>Ki,UNIFORMTYPE_VEC2ARRAY:()=>Gn,UNIFORMTYPE_VEC3:()=>fs,UNIFORMTYPE_VEC3ARRAY:()=>zn,UNIFORMTYPE_VEC4:()=>qi,UNIFORMTYPE_VEC4ARRAY:()=>lh,UNIFORM_BUFFER_DEFAULT_SLOT_NAME:()=>jn,UNUSED_UNIFORM_NAME:()=>uh,URI:()=>jl,UniformBufferFormat:()=>Zi,UniformFormat:()=>qe,UsdzExporter:()=>aC,VIEW_CENTER:()=>kf,VIEW_LEFT:()=>ZU,VIEW_RIGHT:()=>QU,Vec2:()=>D,Vec3:()=>g,Vec4:()=>W,VertexBuffer:()=>mt,VertexFormat:()=>Tt,VertexIterator:()=>ua,ViewCube:()=>UC,WasmModule:()=>Wl,WebglGraphicsDevice:()=>Eh,WebgpuGraphicsDevice:()=>lm,WorldClusters:()=>tl,XRDEPTHSENSINGFORMAT_F32:()=>ig,XRDEPTHSENSINGFORMAT_L8A8:()=>tg,XRDEPTHSENSINGFORMAT_R16U:()=>sg,XRDEPTHSENSINGUSAGE_CPU:()=>wR,XRDEPTHSENSINGUSAGE_GPU:()=>eg,XREYE_LEFT:()=>UQ,XREYE_NONE:()=>FQ,XREYE_RIGHT:()=>BQ,XRHAND_LEFT:()=>IR,XRHAND_NONE:()=>VQ,XRHAND_RIGHT:()=>kQ,XRPAD_A:()=>Yw,XRPAD_B:()=>Kw,XRPAD_SQUEEZE:()=>Xw,XRPAD_STICK_BUTTON:()=>Ww,XRPAD_STICK_X:()=>kw,XRPAD_STICK_Y:()=>Gw,XRPAD_TOUCHPAD_BUTTON:()=>zw,XRPAD_TOUCHPAD_X:()=>Bw,XRPAD_TOUCHPAD_Y:()=>Vw,XRPAD_TRIGGER:()=>Hw,XRSPACE_BOUNDEDFLOOR:()=>bQ,XRSPACE_LOCAL:()=>wQ,XRSPACE_LOCALFLOOR:()=>LQ,XRSPACE_UNBOUNDED:()=>MQ,XRSPACE_VIEWER:()=>ZT,XRTARGETRAY_GAZE:()=>DQ,XRTARGETRAY_POINTER:()=>NQ,XRTARGETRAY_SCREEN:()=>OQ,XRTRACKABLE_MESH:()=>HQ,XRTRACKABLE_PLANE:()=>zQ,XRTRACKABLE_POINT:()=>GQ,XRTYPE_AR:()=>Ro,XRTYPE_INLINE:()=>RR,XRTYPE_VR:()=>CR,XrAnchor:()=>_g,XrAnchors:()=>gg,XrDomOverlay:()=>rg,XrFinger:()=>hg,XrHand:()=>cg,XrHitTest:()=>ng,XrHitTestSource:()=>ag,XrImageTracking:()=>lg,XrInput:()=>fg,XrInputSource:()=>Co,XrJoint:()=>Fd,XrLightEstimation:()=>ug,XrManager:()=>Eg,XrMeshDetection:()=>Sg,XrPlane:()=>mg,XrPlaneDetection:()=>pg,XrTrackedImage:()=>og,XrView:()=>Tg,XrViews:()=>Bd,ZoneComponent:()=>Rd,ZoneComponentSystem:()=>T_,ambientSrcNames:()=>Sy,app:()=>u0,basisInitialize:()=>A2,bindGroupNames:()=>Hu,blendNames:()=>xm,calculateNormals:()=>Jm,calculateTangents:()=>Ks,createBox:()=>XJ,createCapsule:()=>YJ,createCone:()=>KJ,createCylinder:()=>qJ,createGraphicsDevice:()=>kx,createMesh:()=>jJ,createPlane:()=>HJ,createScript:()=>Md,createShader:()=>sB,createShaderFromCode:()=>iB,createSphere:()=>zJ,createTorus:()=>WJ,createURI:()=>c1,cubemaProjectionNames:()=>my,ditherNames:()=>Ry,dracoInitialize:()=>JZ,drawFullscreenQuad:()=>$J,drawQuadWithShader:()=>Ot,extend:()=>Hl,fresnelNames:()=>oy,gammaNames:()=>Rm,getPixelFormatArrayType:()=>Ru,getReservedScriptNames:()=>_Q,getTouchTargetCoords:()=>Ef,guid:()=>PE,http:()=>Le,isCompressedPixelFormat:()=>Vo,isIntegerPixelFormat:()=>Xi,isSrgbPixelFormat:()=>ah,lightFalloffNames:()=>cy,lightShapeNames:()=>hy,lightTypeNames:()=>RS,math:()=>w,now:()=>Us,path:()=>ve,pixelFormatGammaToLinear:()=>Tv,pixelFormatInfo:()=>ei,pixelFormatLinearToGamma:()=>bn,platform:()=>ue,primitiveGlslToWgslTypeMap:()=>Xu,reflectionSrcNames:()=>gy,registerScript:()=>$T,reprojectTexture:()=>Ra,requiresManualGamma:()=>Ev,revision:()=>AE,script:()=>vp,semanticToLocation:()=>Be,shaderChunks:()=>eee,shadowTypeInfo:()=>gi,specularOcclusionNames:()=>_y,spriteRenderModeNames:()=>Ty,string:()=>zr,tonemapNames:()=>Ph,typedArrayIndexFormats:()=>Yo,typedArrayIndexFormatsByteSize:()=>Hv,typedArrayToType:()=>G1,typedArrayTypes:()=>Xa,typedArrayTypesByteSize:()=>$n,uniformTypeToName:()=>hS,uniformTypeToNameMapWGSL:()=>fS,uniformTypeToNameWGSL:()=>cS,uniformTypeToStorage:()=>V1,version:()=>tu,vertexTypesNames:()=>k1});var bO=m(()=>{XC();su();WC();Fs();bt();Kg();Pe();$C();ZC();RE();CE();IE();wE();ql();QC();JC();f1();me();De();ou();jg();$l();rI();Zl();Ke();Ve();Ne();Q();Ze();Vt();fu();aI();_1();Zg();dI();Ql();j();JN();mh();qt();e3();ii();Zu();vh();Rt();us();wI();LI();Th();lw();Fe();_f();t3();Tf();$i();Cr();pS();Ox();cw();pw();qw();tU();nU();Zw();jw();qx();Kx();oU();Jx();Ct();sy();tL();sL();ay();iL();J();Ea();uL();Xf();mL();yL();WS();Hy();oA();Zt();Ym();cA();dA();uA();Ws();_s();ll();eT();Km();mA();ZL();zf();OA();el();NA();Wf();nb();gf();ob();FA();hb();DA();wV();Ny();go();ib();DV();rl();$h();ln();lp();an();YA();fp();rd();eb();nn();Zh();dp();td();up();ab();aA();Dt();sT();Tb();ed();It();tb();oT();lT();KA();Pb();$A();Rb();Cb();s0();mT();Vb();JQ();Xb();Yb();Zb();$b();Jb();eM();tM();cj();sM();iM();XP();mD();rM();dM();We();Ut();Db();zp();SP();vM();UP();ci();yD();PD();mM();xM();yM();PM();MM();RM();CM();Yj();DM();OM();_D();gD();Gb();RP();UM();BM();VM();uD();zM();XM();cP();MP();OP();Bb();Ub();WM();YM();qM();vD();xD();tD();sD();yZ();JM();eD();iD();rD();aD();nD();oD();lD();hD();p2();TM();cD();fD();Zq();V0();v0();ZP();QP();U0();zb();k0();B0();gl();G0();Sc();qb();$0();Ap();rt();eJ();FT();l0();pM();mP();WD();iJ();Ob();Mb();aJ();TR();LD();ND();FD();OD();BD();VD();Nb();GD();zD();HD();XD();KD();e2();t2();s2();r2();a2();QD();CD();_t();c0();c2();n2();nJ();f2();m2();_2();g2();R2();S2();J2();i2();h2();WT();Fb();YP();y_();dT();Nd();k2();G2();C2();M2();O2();w2();I2();b2();N2();DR();D2();U2();W2();z2();B2();V2();L2();H2();X2();Eee();Cee();Iee();Kee();Jee();hC();TO();dO();gO();mO();dE();cO();fO();_O();SO();uO();Ese();bo();Fg();vse();xse();yse();Rse();Ise();Mse();Ose();Use();Yd();RO();SE();eie();aie();lie();hie()});var Uce={};var et,Fi,Ri,mie=m(()=>{bO();et=Md("orbitCamera");et.attributes.add("distanceMax",{type:"number",default:0,title:"Distance Max",description:"Setting this at 0 will give an infinite distance limit"});et.attributes.add("distanceMin",{type:"number",default:0,title:"Distance Min"});et.attributes.add("pitchAngleMax",{type:"number",default:90,title:"Pitch Angle Max (degrees)"});et.attributes.add("pitchAngleMin",{type:"number",default:-90,title:"Pitch Angle Min (degrees)"});et.attributes.add("inertiaFactor",{type:"number",default:0,title:"Inertia Factor",description:"Higher value means that the camera will continue moving after the user has stopped dragging. 0 is fully responsive."});et.attributes.add("focusEntity",{type:"entity",title:"Focus Entity",description:"Entity for the camera to focus on. If blank, then the camera will use the whole scene"});et.attributes.add("frameOnStart",{type:"boolean",default:!0,title:"Frame on Start",description:'Frames the entity or scene at the start of the application."'});Object.defineProperty(et.prototype,"distance",{get:function(){return this._targetDistance},set:function(o){this._targetDistance=this._clampDistance(o)}});Object.defineProperty(et.prototype,"orthoHeight",{get:function(){return this.entity.camera.orthoHeight},set:function(o){this.entity.camera.orthoHeight=Math.max(0,o)}});Object.defineProperty(et.prototype,"pitch",{get:function(){return this._targetPitch},set:function(o){this._targetPitch=this._clampPitchAngle(o)}});Object.defineProperty(et.prototype,"yaw",{get:function(){return this._targetYaw},set:function(o){this._targetYaw=o;var e=this._targetYaw-this._yaw,t=e%360;t>180?this._targetYaw=this._yaw-(360-t):t<-180?this._targetYaw=this._yaw+(360+t):this._targetYaw=this._yaw+t}});Object.defineProperty(et.prototype,"pivotPoint",{get:function(){return this._pivotPoint},set:function(o){this._pivotPoint.copy(o)}});et.prototype.focus=function(o){this._buildAabb(o);var e=this._modelsAabb.halfExtents,t=Math.max(e.x,Math.max(e.y,e.z));this.distance=t*1.5/Math.sin(.5*this.entity.camera.fov*w.DEG_TO_RAD),this._removeInertia(),this._pivotPoint.copy(this._modelsAabb.center)};et.distanceBetween=new g;et.prototype.resetAndLookAtPoint=function(o,e){this.pivotPoint.copy(e),this.entity.setPosition(o),this.entity.lookAt(e);var t=et.distanceBetween;t.sub2(e,o),this.distance=t.length(),this.pivotPoint.copy(e);var s=this.entity.getRotation();this.yaw=this._calcYaw(s),this.pitch=this._calcPitch(s,this.yaw),this._removeInertia(),this._updatePosition()};et.prototype.resetAndLookAtEntity=function(o,e){this._buildAabb(e),this.resetAndLookAtPoint(o,this._modelsAabb.center)};et.prototype.reset=function(o,e,t){this.pitch=e,this.yaw=o,this.distance=t,this._removeInertia()};et.prototype.initialize=function(){var o=this,e=function(){o._checkAspectRatio()};window.addEventListener("resize",e,!1),this._checkAspectRatio(),this._modelsAabb=new _e,this._buildAabb(this.focusEntity||this.app.root),this.entity.lookAt(this._modelsAabb.center),this._pivotPoint=new g,this._pivotPoint.copy(this._modelsAabb.center);var t=this.entity.getRotation();if(this._yaw=this._calcYaw(t),this._pitch=this._clampPitchAngle(this._calcPitch(t,this._yaw)),this.entity.setLocalEulerAngles(this._pitch,this._yaw,0),this._distance=0,this._targetYaw=this._yaw,this._targetPitch=this._pitch,this.frameOnStart)this.focus(this.focusEntity||this.app.root);else{var s=new g;s.sub2(this.entity.getPosition(),this._pivotPoint),this._distance=this._clampDistance(s.length())}this._targetDistance=this._distance,this.on("attr:distanceMin",function(i,r){this._distance=this._clampDistance(this._distance)}),this.on("attr:distanceMax",function(i,r){this._distance=this._clampDistance(this._distance)}),this.on("attr:pitchAngleMin",function(i,r){this._pitch=this._clampPitchAngle(this._pitch)}),this.on("attr:pitchAngleMax",function(i,r){this._pitch=this._clampPitchAngle(this._pitch)}),this.on("attr:focusEntity",function(i,r){this.frameOnStart?this.focus(i||this.app.root):this.resetAndLookAtEntity(this.entity.getPosition(),i||this.app.root)}),this.on("attr:frameOnStart",function(i,r){i&&this.focus(this.focusEntity||this.app.root)}),this.on("destroy",()=>{window.removeEventListener("resize",e,!1)})};et.prototype.update=function(o){var e=this.inertiaFactor===0?1:Math.min(o/this.inertiaFactor,1);this._distance=w.lerp(this._distance,this._targetDistance,e),this._yaw=w.lerp(this._yaw,this._targetYaw,e),this._pitch=w.lerp(this._pitch,this._targetPitch,e),this._updatePosition()};et.prototype._updatePosition=function(){this.entity.setLocalPosition(0,0,0),this.entity.setLocalEulerAngles(this._pitch,this._yaw,0);var o=this.entity.getPosition();o.copy(this.entity.forward),o.mulScalar(-this._distance),o.add(this.pivotPoint),this.entity.setPosition(o)};et.prototype._removeInertia=function(){this._yaw=this._targetYaw,this._pitch=this._targetPitch,this._distance=this._targetDistance};et.prototype._checkAspectRatio=function(){var o=this.app.graphicsDevice.height,e=this.app.graphicsDevice.width;this.entity.camera.horizontalFov=o>e};et.prototype._buildAabb=function(o){var e,t,s=[],i=o.findComponents("render");for(e=0;e<i.length;e++){var r=i[e];for(t=0;t<r.meshInstances.length;t++)s.push(r.meshInstances[t])}var a=o.findComponents("model");for(e=0;e<a.length;e++){var n=a[e];for(t=0;t<n.meshInstances.length;t++)s.push(n.meshInstances[t])}var l=o.findComponents("gsplat");for(e=0;e<l.length;e++){var h=l[e],c=h.instance;c?.meshInstance&&s.push(c.meshInstance)}for(e=0;e<s.length;e++)e===0?this._modelsAabb.copy(s[e].aabb):this._modelsAabb.add(s[e].aabb)};et.prototype._calcYaw=function(o){var e=new g;return o.transformVector(g.FORWARD,e),Math.atan2(-e.x,-e.z)*w.RAD_TO_DEG};et.prototype._clampDistance=function(o){return this.distanceMax>0?w.clamp(o,this.distanceMin,this.distanceMax):Math.max(o,this.distanceMin)};et.prototype._clampPitchAngle=function(o){return w.clamp(o,-this.pitchAngleMax,-this.pitchAngleMin)};et.quatWithoutYaw=new H;et.yawOffset=new H;et.prototype._calcPitch=function(o,e){var t=et.quatWithoutYaw,s=et.yawOffset;s.setFromEulerAngles(0,-e,0),t.mul2(s,o);var i=new g;return t.transformVector(g.FORWARD,i),Math.atan2(i.y,-i.z)*w.RAD_TO_DEG};Fi=Md("orbitCameraInputMouse");Fi.attributes.add("orbitSensitivity",{type:"number",default:.3,title:"Orbit Sensitivity",description:"How fast the camera moves around the orbit. Higher is faster"});Fi.attributes.add("distanceSensitivity",{type:"number",default:.15,title:"Distance Sensitivity",description:"How fast the camera moves in and out. Higher is faster"});Fi.prototype.initialize=function(){if(this.orbitCamera=this.entity.script.orbitCamera,this.orbitCamera){var o=this,e=function(t){o.onMouseOut(t)};this.app.mouse.on(tE,this.onMouseDown,this),this.app.mouse.on(iE,this.onMouseUp,this),this.app.mouse.on(sE,this.onMouseMove,this),this.app.mouse.on(rE,this.onMouseWheel,this),window.addEventListener("mouseout",e,!1),this.on("destroy",function(){this.app.mouse.off(tE,this.onMouseDown,this),this.app.mouse.off(iE,this.onMouseUp,this),this.app.mouse.off(sE,this.onMouseMove,this),this.app.mouse.off(rE,this.onMouseWheel,this),window.removeEventListener("mouseout",e,!1)})}this.app.mouse.disableContextMenu(),this.lookButtonDown=!1,this.panButtonDown=!1,this.lastPoint=new D};Fi.fromWorldPoint=new g;Fi.toWorldPoint=new g;Fi.worldDiff=new g;Fi.prototype.pan=function(o){var e=Fi.fromWorldPoint,t=Fi.toWorldPoint,s=Fi.worldDiff,i=this.entity.camera,r=this.orbitCamera.distance;i.screenToWorld(o.x,o.y,r,e),i.screenToWorld(this.lastPoint.x,this.lastPoint.y,r,t),s.sub2(t,e),this.orbitCamera.pivotPoint.add(s)};Fi.prototype.onMouseDown=function(o){switch(o.button){case 0:this.lookButtonDown=!0;break;case 1:case 2:this.panButtonDown=!0;break}};Fi.prototype.onMouseUp=function(o){switch(o.button){case 0:this.lookButtonDown=!1;break;case 1:case 2:this.panButtonDown=!1;break}};Fi.prototype.onMouseMove=function(o){this.lookButtonDown?(this.orbitCamera.pitch-=o.dy*this.orbitSensitivity,this.orbitCamera.yaw-=o.dx*this.orbitSensitivity):this.panButtonDown&&this.pan(o),this.lastPoint.set(o.x,o.y)};Fi.prototype.onMouseWheel=function(o){this.entity.camera.projection===Mt?this.orbitCamera.distance-=o.wheelDelta*-2*this.distanceSensitivity*(this.orbitCamera.distance*.1):this.orbitCamera.orthoHeight-=o.wheelDelta*-2*this.distanceSensitivity,o.event.preventDefault()};Fi.prototype.onMouseOut=function(o){this.lookButtonDown=!1,this.panButtonDown=!1};Ri=Md("orbitCameraInputTouch");Ri.attributes.add("orbitSensitivity",{type:"number",default:.4,title:"Orbit Sensitivity",description:"How fast the camera moves around the orbit. Higher is faster"});Ri.attributes.add("distanceSensitivity",{type:"number",default:.2,title:"Distance Sensitivity",description:"How fast the camera moves in and out. Higher is faster"});Ri.prototype.initialize=function(){this.orbitCamera=this.entity.script.orbitCamera,this.lastTouchPoint=new D,this.lastPinchMidPoint=new D,this.lastPinchDistance=0,this.orbitCamera&&this.app.touch&&(this.app.touch.on(aE,this.onTouchStartEndCancel,this),this.app.touch.on(nE,this.onTouchStartEndCancel,this),this.app.touch.on(lE,this.onTouchStartEndCancel,this),this.app.touch.on(oE,this.onTouchMove,this),this.on("destroy",function(){this.app.touch.off(aE,this.onTouchStartEndCancel,this),this.app.touch.off(nE,this.onTouchStartEndCancel,this),this.app.touch.off(lE,this.onTouchStartEndCancel,this),this.app.touch.off(oE,this.onTouchMove,this)}))};Ri.prototype.getPinchDistance=function(o,e){var t=o.x-e.x,s=o.y-e.y;return Math.sqrt(t*t+s*s)};Ri.prototype.calcMidPoint=function(o,e,t){t.set(e.x-o.x,e.y-o.y),t.mulScalar(.5),t.x+=o.x,t.y+=o.y};Ri.prototype.onTouchStartEndCancel=function(o){var e=o.touches;e.length===1?this.lastTouchPoint.set(e[0].x,e[0].y):e.length===2&&(this.lastPinchDistance=this.getPinchDistance(e[0],e[1]),this.calcMidPoint(e[0],e[1],this.lastPinchMidPoint))};Ri.fromWorldPoint=new g;Ri.toWorldPoint=new g;Ri.worldDiff=new g;Ri.prototype.pan=function(o){var e=Ri.fromWorldPoint,t=Ri.toWorldPoint,s=Ri.worldDiff,i=this.entity.camera,r=this.orbitCamera.distance;i.screenToWorld(o.x,o.y,r,e),i.screenToWorld(this.lastPinchMidPoint.x,this.lastPinchMidPoint.y,r,t),s.sub2(t,e),this.orbitCamera.pivotPoint.add(s)};Ri.pinchMidPoint=new D;Ri.prototype.onTouchMove=function(o){var e=Ri.pinchMidPoint,t=o.touches;if(t.length===1){var s=t[0];this.orbitCamera.pitch-=(s.y-this.lastTouchPoint.y)*this.orbitSensitivity,this.orbitCamera.yaw-=(s.x-this.lastTouchPoint.x)*this.orbitSensitivity,this.lastTouchPoint.set(s.x,s.y)}else if(t.length===2){var i=this.getPinchDistance(t[0],t[1]),r=i-this.lastPinchDistance;this.lastPinchDistance=i,this.orbitCamera.distance-=r*this.distanceSensitivity*.1*(this.orbitCamera.distance*.1),this.calcMidPoint(t[0],t[1],e),this.pan(e),this.lastPinchMidPoint.copy(e)}}});bO();function cie(o,e){let t=o.graphicsDevice.canvas,s=e.script.orbitCameraInputMouse;if(!s)return;o.mouse.off(pc.EVENT_MOUSEDOWN,s.onMouseDown,s),o.mouse.off(pc.EVENT_MOUSEUP,s.onMouseUp,s),o.mouse.off(pc.EVENT_MOUSEMOVE,s.onMouseMove,s);let i=!1,r=!1;t.addEventListener("pointerdown",a=>{a.button===0?i=!0:(a.button===1||a.button===2)&&(r=!0),t.setPointerCapture(a.pointerId),s.lastPoint.set(a.clientX,a.clientY)}),t.addEventListener("pointermove",a=>{i?(s.orbitCamera.pitch-=a.movementY*s.orbitSensitivity,s.orbitCamera.yaw-=a.movementX*s.orbitSensitivity):r&&s.pan(new pc.Vec2(a.clientX,a.clientY)),s.lastPoint.set(a.clientX,a.clientY)}),t.addEventListener("pointerup",a=>{a.button===0&&(i=!1),(a.button===1||a.button===2)&&(r=!1);try{t.releasePointerCapture(a.pointerId)}catch{}})}function fie(o,e){let t=e.script?.orbitCameraInputTouch;if(!t)return;let s=o.graphicsDevice.canvas,i=t.initialize;t.initialize=function(){i.call(this),this.app.touch.off(pc.EVENT_TOUCHSTART,this.onTouchStartEndCancel,this),this.app.touch.off(pc.EVENT_TOUCHEND,this.onTouchStartEndCancel,this),this.app.touch.off(pc.EVENT_TOUCHCANCEL,this.onTouchStartEndCancel,this),this.app.touch.off(pc.EVENT_TOUCHMOVE,this.onTouchMove,this);let r=!1;this._onTouchStart=a=>{if(a.touches.length>0){let n=a.touches[0],l=s.getBoundingClientRect();n.clientX>=l.left&&n.clientX<=l.right&&n.clientY>=l.top&&n.clientY<=l.bottom&&(r=!0,this.onTouchStartEndCancel(a))}},this._onTouchMove=a=>{r&&this.onTouchMove(a)},this._onTouchEnd=a=>{r&&this.onTouchStartEndCancel(a),a.touches.length===0&&(r=!1)},document.addEventListener("touchstart",this._onTouchStart,{passive:!1}),document.addEventListener("touchmove",this._onTouchMove,{passive:!1}),document.addEventListener("touchend",this._onTouchEnd,{passive:!1}),document.addEventListener("touchcancel",this._onTouchEnd,{passive:!1}),this.on("destroy",()=>{document.removeEventListener("touchstart",this._onTouchStart),document.removeEventListener("touchmove",this._onTouchMove),document.removeEventListener("touchend",this._onTouchEnd),document.removeEventListener("touchcancel",this._onTouchEnd)})}}function die(o){let e=t=>t.preventDefault();o.addEventListener("touchstart",e,{passive:!1}),o.addEventListener("touchmove",e,{passive:!1})}function uie(){let o=document.createElement("div"),e=document.createElement("div");Object.assign(o.style,{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:"60%",height:"8px",background:"rgba(0, 0, 0, 0.1)",borderRadius:"4px",zIndex:10,overflow:"hidden",pointerEvents:"none"}),Object.assign(e.style,{width:"0%",height:"100%",background:"linear-gradient(to right, #4b0082, #00008b)",transition:"width 0.2s ease-out"}),o.appendChild(e);let t=0,s=!1,i=!1;function r(){if(s||i)return;s=!0;let n=11e3,l=85,h=500,c,f=u=>1-Math.pow(1-u,6),d=u=>{if(i)return;c||(c=u);let p=u-c,_=Math.min(Math.max((p-h)/n,0),1);t=f(_)*l,e.style.width=`${t.toFixed(2)}%`,_<1&&requestAnimationFrame(d)};requestAnimationFrame(d)}function a(){i=!0,e.style.transition="width 0.2s ease-in",e.style.width="100%",setTimeout(()=>{o.remove()},200)}return{element:o,start:r,finish:a}}window.pc=BC;var pie="/static",Wg=null,gr=null,Ba=null,Ui=null;async function Bce(o,e){let t=`https://api.marvify.io/gateway/assets/${e}`,s=await fetch(t,{method:"HEAD",redirect:"follow"});if(!s.ok)throw new Error(`Failed to resolve model URL for ${e}`);let i=s.url;return console.log("Resolved asset URL:",i),new Promise((r,a)=>{let n=new re("gsplat","gsplat",{url:i});new vg([n],o.assets).load(()=>{Ui&&Ui.destroy&&Ui.destroy(),Ui=new be,Ui.addComponent("gsplat",{asset:n,castShadows:!0}),Ui.setLocalPosition(-1.5,.05,0),Ui.setLocalEulerAngles(180,90,0),Ui.setLocalScale(.7,.7,.7),Ui.gsplat.material.setParameter("alphaClip",.4),o.root.addChild(Ui);let l=o.root.findByName("Camera")?.script?.orbitCamera;l&&(l.focusEntity=Ui),r()})})}var VC=class extends HTMLElement{constructor(){super(),this._loadingBar=uie(),this._loadingBar.element.style.display="none",this.appendChild(this._loadingBar.element),this.style.display="inline-block",this.style.position="relative",this._state="idle",this._resizeObserver=null,this._resize=()=>{},this._placeholder=document.createElement("div"),Object.assign(this._placeholder.style,{width:"100%",height:"100%",background:"#eee",color:"#333",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",fontWeight:"bold",borderRadius:"8px",boxShadow:"0 0 8px rgba(0,0,0,0.1)"}),this._placeholder.textContent="Click to View in 3D",this.appendChild(this._placeholder),this._handleClick=()=>this.activateViewer()}connectedCallback(){let e=this.getAttribute("width"),t=this.getAttribute("height");e&&(this.style.width=e),t&&(this.style.height=t),!e&&!t&&(this.style.width="300px",this.style.height="300px"),this._placeholder.addEventListener("click",this._handleClick)}disconnectedCallback(){this._placeholder.removeEventListener("click",this._handleClick),Wg===this&&(Wg=null)}async activateViewer(){Wg&&Wg!==this&&Wg.resetToPlaceholder(),Wg=this,this._state="active",this._placeholder.style.display="none";let e=this.getAttribute("data-product-id");if(!e){console.error("marvify-model-viewer: no data-product-id provided");return}if(!gr){gr=document.createElement("canvas"),Object.assign(gr.style,{width:"100%",height:"100%",display:"block"});let t={glslangUrl:`${pie}/lib/glslang/glslang.js`,twgslUrl:`${pie}/lib/twgsl/twgsl.js`,antialias:!1},s=await kx(gr,t);s.maxPixelRatio=Math.min(window.devicePixelRatio,2),Ba=new js(gr);let i=new uc;i.graphicsDevice=s,i.mouse=new ma(gr),i.touch=new Sm(gr),i.componentSystems=[wc,Nc,Fc,Uc,Bc],i.resourceHandlers=[Hc,kc],Ba.init(i),Ba.setCanvasFillMode(QA),Ba.setCanvasResolution(ad),await Promise.resolve().then(()=>(mie(),Uce));let r=new be("Camera");r.addComponent("camera",{clearColor:new N(.95,.95,.95),toneMapping:py}),r.addComponent("script"),r.script.create("orbitCamera",{attributes:{inertiaFactor:.2,focusEntity:null,distanceMax:60,frameOnStart:!0}}),r.script.create("orbitCameraInputMouse"),r.script.create("orbitCameraInputTouch"),Ba.root.addChild(r),cie(Ba,r),fie(Ba,r),die(gr);let a=new be("Light");a.addComponent("light",{type:"directional",color:N.WHITE,castShadows:!0,intensity:1,shadowBias:.2,normalOffsetBias:.05,shadowDistance:10,shadowIntensity:.5,shadowResolution:2048,shadowType:Za,penumbraSize:10,penumbraFalloff:4,shadowSamples:16,shadowBlockerSamples:16}),a.setEulerAngles(55,0,20),Ba.root.addChild(a),Ba.start()}Ui&&Ui.destroy&&(Ui.destroy(),Ui=null),gr.parentElement&&gr.parentElement.removeChild(gr),this.appendChild(gr),this._resize=()=>{let t=this.clientWidth,s=this.clientHeight;gr.width=t,gr.height=s,Ba.graphicsDevice.resizeCanvas(t,s),Ba.resizeCanvas(t,s)},this._resizeObserver&&this._resizeObserver.disconnect(),this._resizeObserver=new ResizeObserver(()=>this._resize()),this._resizeObserver.observe(this),window.addEventListener("resize",this._resize),this._loadingBar.start(),setTimeout(()=>{this._state==="active"&&(this._loadingBar.element.style.display="block")},500),await Bce(Ba,e),this._loadingBar.finish(),this._resize()}resetToPlaceholder(){this._state="idle",this._placeholder.style.display="flex",this._resizeObserver&&(this._resizeObserver.disconnect(),this._resizeObserver=null),window.removeEventListener("resize",this._resize)}};customElements.define("marvify-model-viewer",VC);var Zgt=VC;export{Zgt as default};
